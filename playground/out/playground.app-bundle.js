var Ia=Object.defineProperty;var co=e=>{throw TypeError(e)};var Oa=(e,t,i)=>t in e?Ia(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var _t=(e,t,i)=>Oa(e,typeof t!="symbol"?t+"":t,i),Sn=(e,t,i)=>t.has(e)||co("Cannot "+i);var b=(e,t,i)=>(Sn(e,t,"read from private field"),i?i.call(e):t.get(e)),se=(e,t,i)=>t.has(e)?co("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i),G=(e,t,i,s)=>(Sn(e,t,"write to private field"),s?s.call(e,i):t.set(e,i),i),be=(e,t,i)=>(Sn(e,t,"access private method"),i);function fs(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}fs.prototype={resolve(e){this._resolve(e)},reject(e){this._reject(e)}};function Is(e){this.defs=e}Is.prototype={then(e,t){const i=this.defs.map(s=>{const n=new fs;return s.promise.then(e,t).then(n.resolve.bind(n),n.reject.bind(n)),n});return new Is(i)},catch(e){const t=this.defs.map(i=>{const s=new fs;return i.promise.catch(e).then(s.resolve.bind(s),s.reject.bind(s)),s});return new Is(t)},replace(e){if(e>this.defs.length)for(let t=this.defs.length;t<e;t++)this.defs.push(new fs);else e<this.defs.length&&this.defs.splice(e).forEach(t=>{})}};function Jo(){this.minTimeout=1e3,this.queue=new Map}Jo.prototype={addPromiseHandler(e,t,i=1){const s=Math.max(t,this.minTimeout),n=Array.from({length:i},()=>new fs),o=new Is(n);return this.queue.set(e,{handler:o,time:{start:Date.now(),duration:s}}),o},changePromiseHandler(e,t){const i=this.queue.get(e);i&&i.handler.replace(t)},trigger(e,t){const i=this.queue.get(e);if(!i)return console.log(e,"NOT FOUND");i.handler.defs.shift().resolve(t),i.handler.defs.length===0&&this.queue.delete(e)},checkTimeouts(e=Date.now()){for(const[t,i]of this.queue.entries()){const{start:s,duration:n}=i.time;if(s+n<=e){const o=new Error("Reply timeout",{sender:t,msec:n});i.handler.defs.forEach(r=>r.reject(o)),this.queue.delete(t)}}}};const ws=0,Ln=268435456,js=536870912,Nn=4026531840,Fa=268435455;function Xo(e,t,i=!1){this.uid=e,this.actor=null,this.pin=t,this.channel=i,this.hix=ws}const ho="->",Wa="=>",mi={stringToInput(e){const t=e.trim(),i=t.slice(0,2);return{pin:t.slice(2).trim(),channel:i!==ho}},stringToOutput(e){function t(r){return!(r[0]=="["&&r.at(-1)=="]")}let i=!1,s=e.indexOf(ho);if(s<0&&(s=e.indexOf(Wa),i=!0),s<0)return null;const n=e.slice(0,s).trim(),o=e.slice(s+2).trim();if(n.length==0||o.length==0)return null;if(t(o)){const r=mi.stringToTarget(o);return r?{output:n,channel:i,targets:[r]}:{output:n,channel:i,targets:[]}}else{const r=/"(?:\\.|[^"\\])*"/g;let a=o.match(r);const l=a?a.map(h=>h.slice(1,-1).replace(/\\"/g,'"')):[],c=[];for(const h of l){const f=mi.stringToTarget(h);f&&c.push(f)}return{output:n,channel:i,targets:c}}},stringToScope(e){let t=e.indexOf(":");if(t<0)return null;const i=e.slice(0,t).trim(),s=e.slice(t+1).trim();if(i.length==0||s.length==0)return null;const n=/"(?:\\.|[^"\\])*"/g;let o=s.match(n);const r=o?o.map(l=>l.slice(1,-1).replace(/\\"/g,'"')):[],a=[];for(const l of r){const c=mi.stringToTarget(l);c&&a.push(c)}return{selector:i,scope:a}},stringToTarget(e){const t=e.lastIndexOf("(");if(t<0)return null;const i=e.lastIndexOf(")");if(i<0||i-t<2)return null;const s=e.slice(t+1,i),n=e.indexOf("@");if(n<0)return null;const o=e.slice(0,n).trim(),r=e.slice(n+1,t).trim();return o.length==0||r.length==0?null:{pinName:o,nodeName:r,uid:s}},pinToHandler(e){return"on"+e.split(/[ .-]+/).map(s=>s.replace(/[^a-zA-Z0-9_]/g,"")).filter(Boolean).map(s=>s[0].toUpperCase()+s.slice(1)).join("")}},Go={LOGMSG:1},Mi=Go.LOGMSG;function Yo(){this.actors=[],this.timer=0,this.minDelay=0,this.maxDelay=100,this.scheduleDelay=this.minDelay,this.idleCount=0,this.idleTreshold=100,this.slow=!1,this.msgCount=0,this.startTime=null,this.qOut=[],this.qIn=[],this.qResolve=new Jo}Yo.prototype={start(){clearTimeout(this.timer),this.qOut=[],this.qIn=[],this.msgCount=0;for(const e of this.actors)e.makeCell();this.startTime=Date.now(),this.timer=setTimeout(this.receive.bind(this),this.scheduleDelay)},stop(){clearTimeout(this.timer),this.msgCount=0,this.actors.forEach(e=>e.cell=null),this.qOut=[],this.qIn=[]},halt(){clearTimeout(this.timer)},continue(){this.timer=setTimeout(this.receive.bind(this),this.scheduleDelay)},switch(){const e=this.qIn;this.qIn=this.qOut,this.qOut=e,this.qOut.length=0,this.slow&&this.goFast()},idle(){this.idleCount++;const e=Date.now();if(this.qResolve.checkTimeouts(e),this.idleCount%600==0){const t=(e-this.startTime)/6e4;console.log(`<idle> ${this.idleCount} cycles - nr of messages: ${this.msgCount} - running time:${t.toFixed(0)} min`)}!this.slow&&this.idleCount>this.idleTreshold&&this.goSlow()},goFast(){this.scheduleDelay=this.minDelay,this.idleCount=0,this.slow=!1},goSlow(){this.scheduleDelay=this.maxDelay,this.slow=!0},reject(e){return new Promise((t,i)=>{i(new Error(e))})},sendTo(e,t,i,s){if(e.length<1)return 0;t.flags&Mi&&console.log(`${t.name} -> ${i}`),++this.msgCount;for(const n of e)this.qOut.push({from:t.uid,txRef:0,dest:n.actor,rxRef:0,hix:n.hix,pin:i,param:s});return e.length},requestFrom(e,t,i,s,n){t.flags&Mi&&console.log(`${t.name} => ${i}`);const o=++this.msgCount;let r=0;for(const a of e)this.qOut.push({from:t.uid,txRef:o,dest:a.actor,rxRef:0,hix:a.hix,pin:i,param:s}),a.channel&&r++;return r==0?this.reject("No channel"):this.qResolve.addPromiseHandler(o,n,r)},reply(e,t){var i;return(i=e.msg)!=null&&i.txRef?(e.flags&Mi&&console.log(`reply to ${e.msg.pin} @ ${e.name}`),++this.msgCount,this.qOut.push({from:e.uid,txRef:0,dest:e.msg.from,rxRef:e.msg.txRef,hix:Ln,pin:e.msg.pin,param:t}),1):0},next(e,t,i){var n;if(!((n=e.msg)!=null&&n.txRef))return this.reject("No target");const s=++this.msgCount;return this.qOut.push({from:e.uid,txRef:s,dest:target.actor,rxRef:e.msg.txRef,hix:Ln,pin:e.msg.pin,param:t}),this.qResolve.addPromiseHandler(s,i)},receive(){this.qOut.length?(this.switch(),this.handleReceiveQueue()):this.idle(),this.timer=setTimeout(this.receive.bind(this),this.scheduleDelay)},handleReceiveQueue(){var e,t;for(const i of this.qIn){const s=i.dest;switch(i.hix&Nn){case ws:s.msg=i,s.flags&Mi&&console.log(`${s.name} <- ${i.pin} (run ${s.rxTable[i.hix].handler.name})`),s.rxTable[i.hix].handler.call(s.cell,i.param);break;case Ln:s.flags&Mi&&console.log(`${s.name} <= ${i.pin} (reply)`),this.qResolve.trigger(i.rxRef,i.param);break;case js:{s.flags&Mi&&console.log(`${s.name} <- ${i.pin} (filter via router)`);const n=i.dest.scopeTable[i.hix&Fa],o=((t=(e=s.cell).filter)==null?void 0:t.call(e,n.targets.keys(),i.pin,i.param))??[...n.targets.keys()];if(Array.isArray(o)&&o.length>0)this.forwardToAll(i,o,n.targets);else{const r=n.targets.get(o);r&&this.forward(i,r)}}break}}},forwardToAll(e,t,i){let s=0;for(const n of t){const o=i.get(n);o&&(this.forward(e,o),e.txRef>0&&o.channel&&s++)}s>1&&this.qResolve.changePromiseHandler(e.txRef,s)},forward(e,t){(t.hix&Nn)==ws?(t.actor.msg=e,t.actor.rxTable[t.hix].handler.call(t.actor.cell,e.param)):(t.hix&Nn)==js&&this.qOut.push({from:e.from,txRef:e.txRef,dest:t.actor,rxRef:0,hix:t.hix,pin:t.pin,param:e.param})},reschedule(e){this.qOut.push(e)}};function Ha(e,t=!1){this.pin=e,this.channel=t,this.handler=null}function $a(e,t=!1){this.pin=e,this.channel=t,this.targets=[]}function Ba(e){const t=Object.getOwnPropertyNames(this);console.warn(`Missing handler for cell: ${t} - parameters: ${e}`)}function ja(e){if(typeof e!="function"||!e.prototype)return!1;const t=Object.getOwnPropertyNames(e.prototype);return t.length!==1||t[0]!=="constructor"||e.prototype.constructor!==e}function Ko({name:e,uid:t,factory:i,inputs:s,outputs:n,sx:o,dx:r}){this.name=e,this.uid=t,this.factory=i,this.useNew=ja(i),this.rxTable=[],this.txTable=[],this.sx=o??null,this.dx=r??null,this.flags=0,this.cell=null,this.msg=null,this.setFlags(),this.initRxTxTables({inputs:s,outputs:n})}Ko.prototype={setFlags(){var e;(e=this.dx)!=null&&e.flags&&this.dx.flags.includes("LOGMSG")&&(this.flags|=Go.LOGMSG)},initRxTxTables({inputs:e,outputs:t}){for(const i of e){const s=mi.stringToInput(i);s&&this.rxTable.push(new Ha(s.pin,s.channel))}for(const i of t){const s=mi.stringToOutput(i);if(!s)continue;const n=new $a(s.output,s.channel);this.txTable.push(n);for(const o of s.targets)n.targets.push(new Xo(o.uid,o.pinName,s.channel))}},makeCell(){try{this.useNew?this.cell=new this.factory(this.getTx(),this.sx):this.cell=this.factory(this.getTx(),this.sx)}catch(e){if(e instanceof TypeError&&typeof this.factory=="function"&&/class constructor/i.test(e.message))this.useNew=!0,this.cell=new this.factory(this.getTx(),this.sx);else throw e}this.addHandlersForCell()},addHandlersForCell(){var s;if(!this.cell){((s=this.rxTable)==null?void 0:s.length)>0&&console.warn(`** NO HANDLERS ** Node ${this.name} has input pins but no implementation.`);return}const e=Object.entries(this.cell),t=Object.getPrototypeOf(this.cell),i=Object.getOwnPropertyNames(t)??[];for(const n of i)typeof t[n]=="function"&&e.push([n,t[n]]);e.forEach(([n,o])=>{if(typeof o=="function"){const r=this.getRx(n);r&&(r.handler=o)}}),this.rxTable.forEach(n=>{n.handler||(console.warn(`** NO HANDLER ** Node "${this.name}" has input pin "${n.pin}" but no handler for it.`),n.handler=Ba)})},getRx(e){if(e.startsWith("-> ")||e.startsWith("=> ")){const t=e.slice(3);return this.rxTable.find(i=>i.pin==t)}return this.rxTable.find(t=>mi.pinToHandler(t.pin)==e)},resolveUIDs(e){this.txTable.forEach(t=>{t.targets.forEach(i=>{if(i.actor=e.find(s=>s.uid==i.uid),!i.actor)return console.error(`** ERROR ** target node ${i.uid} in ${this.name} not found`);i.hix=i.actor.factory?ws|i.actor.rxTable.findIndex(s=>s.pin==i.pin):js|i.actor.scopeTable.findIndex(s=>s.selector==i.pin)})})},findTargets(e){if(!e)return[];const t=this.txTable.find(i=>i.pin==e);return t?t.targets:(console.warn(`** NO OUTPUT PIN ** Node "${this.name}" pin: "${e}"`,this.txTable),[])},getTx(){const e=this;return{get pin(){var t;return(t=e.msg)==null?void 0:t.pin},send(t,i){if(!t)return 0;const s=e.findTargets(t);return De.sendTo(s,e,t,i)},request(t,i,s=0){if(!t)return null;const n=e.txTable.find(o=>o.pin==t);return n!=null&&n.targets.length?De.requestFrom(n.targets,e,t,i,s):n?(console.warn(`** PIN IS NOT CONNECTED ** Node "${e.name}" pin: "${t}"`,e.txTable),De.reject("Not connected")):(console.warn(`** NO SUCH OUTPUT PIN ** Node "${e.name}" pin: "${t}"`,e.txTable),De.reject("No such output pin"))},reply(t){return De.reply(e,t)},next(t,i=0){return De.next(e,t,i)},reschedule(){e.msg&&De.reschedule(e.msg)},wireless(t){const i=De.actors.find(n=>n.name.toLowerCase()==t.toLowerCase());if(!i)return console.warn(`** WIRELESS SEND TO UNKNOWN NODE ** ${t}`),{send(n,o){return 0},request(n,o,r=1e3){return new Promise((a,l)=>{l(new Error("no node"))})}};function s(n){const o=i.rxTable.length;for(let r=0;r<o;r++)if(i.rxTable[r].pin==n)return{uid:i.uid,actor:i,pin:n,channel:i.rxTable[r].channel,hix:r};return null}return{send(n,o){const r=s(n);return r?De.sendTo([r],e,n,o):(console.warn(`** WIRELESS SEND TO UNKNOWN PIN ** ${t} pin: ${n}`),0)},request(n,o,r=0){const a=s(n);return a?De.requestFrom([a],e,n,o,r):(console.warn(`** WIRELESS REQUEST TO UNKNOWN PIN ** ${t} pin: ${n}`),new Promise((l,c)=>{c(new Error("no pin"))}))}}}}}};function za(e){this.selector=e,this.targets=new Map}function Zo({name:e,uid:t,filter:i,table:s}){var n;this.name=e,this.uid=t,this.filter=i,this.useNew=((n=i.prototype)==null?void 0:n.constructor)!==i,this.scopeTable=[],this.cell=null,this.msg=null,this.buildScopeTable(s)}Zo.prototype={buildScopeTable(e){for(const t of e){const i=mi.stringToScope(t),s=new za(i.selector);for(const n of i.scope){const o=new Xo(n.uid,n.pinName);s.targets.set(n.nodeName,o)}this.scopeTable.push(s)}},resolveUIDs(e){for(const t of this.scopeTable)for(const i of t.targets.values()){if(i.actor=e.find(s=>s.uid==i.uid),!i.actor)return console.error(`** ERROR ** target node ${i.uid} in ${this.name} not found`);i.actor.factory?i.actor.rxTable.find((s,n)=>s.pin!=i.pin?!1:(i.hix=ws|n,i.channel=s.channel,!0)):i.actor.filter&&i.actor.scopeTable.find((s,n)=>s.selector!=i.pin?!1:(i.hix=js|n,!0))}},makeCell(){this.cell=this.useNew?new this.filter:this.filter()}};let De=null;function Ua(e,t=[]){De=new Yo;for(const i of e){const s=new Ko(i);De.actors.push(s)}for(const i of t){const s=new Zo(i);De.actors.push(s)}return De.actors.forEach(i=>i.resolveUIDs(De.actors)),De}function Qo(e,t,i){this.message="HTTP code: "+t+": "+e,this.cause=i}const er=8e3;async function Va(e,t={}){const i=new AbortController;t.signal=i.signal;const s=setTimeout(()=>i.abort(),er);return fetch(e,t).then(n=>{if(clearTimeout(s),n.ok)return n;throw new Qo("GET failed",n.status,"")}).catch(n=>{throw clearTimeout(s),n})}async function qa(e,t,i="text/plain"){const s=new AbortController,n=setTimeout(()=>s.abort(),er);let o={method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":i},redirect:"follow",referrerPolicy:"no-referrer",body:t,signal:s.signal};const r=await fetch(e,o).catch(l=>{throw console.log("Network failure",l),l});if(clearTimeout(n),r.ok)return r;let a=await r.json();throw new Qo("POST failed",r.status,a)}const Ja={vizPath:/^((?:\.\/)?|(?:\.\.\/)*|\/|(?:[\w\s-]+\:\/?))((?:[\w\s-]+\/)*)([\w\s-\.]+)$/},Xa=6;function Ga(e){let t=e.lastIndexOf(".");return t>0&&e.length-t<=Xa}function uo(e,t){let i=e.lastIndexOf(".");return t[0]=="."||""+t,i>0?e.slice(0,i)+t:e+"."+t}function Ya(e){let t=e.lastIndexOf("."),i=e.lastIndexOf(".",t+1);return{name:i>0?e.slice(0,i):t>0?e.slice(0,t):e,ext:i>0?e.slice(i):t>0?e.slice(t):null}}function zs(e){let t=e.lastIndexOf(".");return t>0?e.slice(0,t):e}function Ka(e){return Ja.vizPath.test(e)?e:null}function Za(e){const t=e.lastIndexOf("/");return t<0?e:e.slice(t+1)}function Us(e){let t=e.lastIndexOf("/"),i=e.lastIndexOf(".");return i>t?e.slice(t+1,i):e.slice(t+1)}function Qa(e){return/^(\/|https?:\/\/|file:\/\/\/|[a-zA-Z]:\\)/.test(e)}function el(e,t){const i=e.length<t.length?e.length:t.length;for(let s=0;s<i;s++)if(e[s]!=t[s])return s}function ln(e,t){const i=el(e,t);let s=e.lastIndexOf("/",i);if(s<1)return e;let n=e.slice(s+1),o=t.slice(s+1),r="./";if(s=o.indexOf("/"),s>0)for(r="../";(s=o.indexOf("/",s+1))>-1&&(r+="../",!(r.length>100)););return r+n}function tl(e,t){let i=0,s=null;if(!t||t.length==0)return e;if(!e||e.length==0)return t;if(e.startsWith("/"))return e;if(e.startsWith("./"))return i=t.lastIndexOf("/"),s=i<0?"":t.slice(0,i),s+"/"+e.slice(2);if(e.startsWith("../")){for(i=t.lastIndexOf("/"),s=i<0?"":t.slice(0,i);e.startsWith("../");)i=s.lastIndexOf("/"),s=i<0?"":s.slice(0,i),e=e.slice(3);return s+"/"+e}else return i=t.lastIndexOf("/"),s=i<0?"":t.slice(0,i),s+"/"+e}function Qt(e){this.userPath=e,this.url=null}Qt.prototype={absolute(e){const t=e.lastIndexOf("/");return this.userPath=t>=0?"."+e.slice(t):e,this.url=new URL(e),this},toJSON(){return this.userPath},equals(e){return this.url&&e.url&&this.url.href==e.url.href},sameDir(e){if(!this.url||!e.url)return!1;const t=this.url.href.lastIndexOf("/"),i=e.url.href.lastIndexOf("/");return this.url.href.slice(0,t)===e.url.href.slice(0,i)},getPath(){return this.userPath},getExt(){let e=this.userPath.lastIndexOf(".");return e<0?"":this.userPath.slice(e+1)},getName(){const e=this.userPath.lastIndexOf("/");if(e>0)return this.userPath.slice(e+1);const t=this.userPath.indexOf(":");return t>0?this.userPath.slice(0,t):this.userPath},getFullPath(){return this.url?this.url.pathname:this.userPath},setWSReference(e){},resolve(e){if(!this.url)return console.error(`cannot resolve ${e} - missing reference`),null;const t=new Qt(e);return t.url=new URL(e,this.url),t},resolve_dbg(e){const t=this.resolve(e);return console.log(`%cresolved: ${e} using ${this.userPath} to ${t.userPath}`,"background: #ff0; color: #00f"),t},makeRelative(e){let t=this.getFullPath(),i=e.getFullPath();this.userPath=ln(t,i)},copy(){const e=new Qt(this.userPath);return e.url=this.url?new URL(this.url):null,e},validURL(){return this.url?!0:(console.error(`missing url ${this.path}`),!1)},async get(e="text"){return this.validURL()?Va(this.url).then(async t=>t.headers.get("Content-Length")=="0"?null:e=="json"?await t.json():await t.text()):null},async save(e){return this.validURL()?qa(this.url+"?action=save",e):null},async jsImport(){return this.validURL()?import(this.url):null}};function Os(e,t=null){this.userPath=e,this.handle=t,this.fullPath=null,this.fileTree=null}Os.prototype={absolute(){},toJSON(){return this.userPath},equals(e){return this.handle&&e.handle?this.handle==e.handle:this.fullPath&&e.fullPath?this.fullPath===e.fullPath:null},sameDir(e){return!1},getPath(){return this.userPath},getExt(){let e=this.userPath.lastIndexOf(".");return e<0?"":this.userPath.slice(e+1)},getName(){const e=this.userPath.lastIndexOf("/");if(e>0)return this.userPath.slice(e+1);const t=this.userPath.indexOf(":");return t>0?this.userPath.slice(0,t):this.userPath},setFileSystem(e,t){this.fileTree=e,this.fullPath=t},getFullPath(){return this.fullPath},resolve(e){var n;const t=((n=this.handle)==null?void 0:n.kind)!="directory"?this.fullPath:this.fullPath.at(-1)=="/"?this.fullPath+"x":this.fullPath+"/x",i=tl(e,t),s=new Os(e);return s.setFileSystem(this.fileTree,i),s},makeRelative(e){let t=this.getFullPath(),i=e.getFullPath();this.userPath=ln(t,i)},copy(){const e=new Os(this.userPath,this.handle);return e.fullPath=this.fullPath,e.fileTree=this.fileTree,e},validURL(){return this.handle?!0:(console.error(`missing handle for ${this.fullPath}`),!1)},async get(e="text"){let t;try{if(!this.handle){const s=await this.fileTree.findFile(this.fullPath);if(!s)return console.warn(`LALR.get(${this.fullPath}: file not found)`),null;this.handle=s.arl.handle}t=await this.handle.getFile()}catch(s){return console.error(`LALR.get(${this.fullPath}) failed: ${s}`),null}if(t.size===0)return null;const i=await t.text();return e==="json"?JSON.parse(i):i},async save(e){var o,r,a;const t=l=>{if(!l)return"";const c=l.endsWith("/")&&l!=="/"?l.slice(0,-1):l,h=c.lastIndexOf("/");return h<=0?"/":c.slice(0,h)},i=l=>{if(!l)return"";const c=l.endsWith("/")&&l!=="/"?l.slice(0,-1):l,h=c.lastIndexOf("/");return h<0?c:c.slice(h+1)},s=async(l,c)=>{if(!l)throw new Error("Missing root directory handle");const h=c.replace(/^\/*/,"/").split("/").filter(Boolean);let f=l;for(const g of h)f=await f.getDirectoryHandle(g,{create:!0});return f},n=async()=>{const l=this.fileTree.arl.handle,c=t(this.fullPath),h=i(this.fullPath);return await(await s(l,c)).getFileHandle(h,{create:!0})};try{if(!this.handle){const l=await((r=(o=this.fileTree)==null?void 0:o.findFile)==null?void 0:r.call(o,this.fullPath));(a=l==null?void 0:l.arl)!=null&&a.handle?this.handle=l.arl.handle:this.handle=await n()}try{await this.handle.getFile()}catch{this.handle=await n()}}catch(l){return console.error(`Unable to obtain/create handle for ${this.fullPath}:`,l),null}try{const l=await this.handle.createWritable();return await l.write(e),await l.close(),!0}catch(l){return console.error("Error saving local file:",l),null}},async jsImport(){return null}};function Dn(e){this.kind=e,this.root=null}Dn.prototype={collapse(){for(const e of this.root.folders)e.is.expanded=!1;this.root.is.expanded=!1},expand(){for(const e of this.root.folders)e.is.expanded=!0;this.root.is.expanded=!0}};function ps(e,t){this.name=e==null?void 0:e.getName(),this.parent=t,this.arl=e,this.files=[],this.folders=[],this.is={expanded:!1,stale:!0}}ps.prototype={toJSON(){return this.parent.parent.parent?" "+this.arl.userPath:this.is.expanded?"+"+this.arl.userPath:"-"+this.arl.userPath},async findFile(e){let t=e.lastIndexOf("/"),i=e.slice(t+1),s=t>0?e.slice(0,t):e,n=this;for(const r of s.split("/").filter(Boolean)){if(n=n.folders.find(a=>r===a.name),!n)return null;n.is.stale&&await n.update()}return n?(n.is.stale&&await n.update(),n.files.find(r=>i==r.name)):null},getRoot(){return this.parent?this.parent.getRoot():this.arl},getIcon(){return this.is.expanded?"folder_open":"folder"},getName(){return this.name},getFileSystem(){let e=this.parent;for(;e!=null&&e.parent;)e=e.parent;return e},checkName(e){return e.length<1?!1:Ka(e)?this.folders.find(t=>t.name===e)?!1:!this.files.find(t=>t.name===e):!1},getFileTreeAndPath(){let e=this;const t=[];for(;e.parent;)t.push(e.getName()),e=e.parent;const i="/"+t.reverse().join("/")+"/";return[e,i]},async update(){const e=this.getFileSystem();switch(e==null?void 0:e.kind){case"local":this.folders=[],this.files=[];for await(const t of this.arl.handle.values()){const i=this.arl.resolve(t.name);if(i.handle=t,t.kind=="directory"){const s=new ps(i,this);s.fsType=this.fsType,this.folders.push(s)}else if(t.kind=="file"){const s=new Yn(i,this);this.files.push(s)}}return;case"api":return;case"fixed":return;case"none":return}},ejectFolder(e){this.folders=this.folders.filter(t=>t!=e)},ejectFile(e){this.files=this.files.filter(t=>t!=e)}};function Yn(e,t){this.name=e==null?void 0:e.getName(),this.folder=t,this.arl=e,this.is={highLighted:!1}}Yn.prototype={getPath(){let e=this.folder.getPath();return e.at(-1)=="/"?e+this.name:e+"/"+this.name},getExt(){let e=this.name.lastIndexOf(".");return e<0?"any":this.name.slice(e+1)},getIcon(){const e=this.getExt();return e=="vmblu"||e=="nmsh"?"account_tree":e=="js"||e=="msj"?"electric_bolt":e=="json"?"data_object":e=="html"?"code":e=="css"?"tag":"description"},getFileClass(){const e=this.getExt();return e=="vmblu"?"vmblu-file":e=="nmsh"?"nmsh-file":e=="js"?"js-file":"other-file"},rename(e){e!==this.name&&this.folder.checkName(e)&&this.arl.rename(e).then(t=>{if(!t)return;const i=this.name;this.name=e,this.folder.getDrawer().update(),tx.send("file renamed",{oldName:i,newName:e})}).catch(t=>console.log(t))},confirmDelete(e){showMessage("Confirm delete file",`Delete file  ${this.name}  ?`,t=>this.remove())},remove(){var e;(e=this.arl)==null||e.remove().then(()=>{this.folder.ejectFile(this),this.folder.getDrawer().update(),tx.send("file deleted",this.arl)}).catch(t=>console.error(t))}};const il="5";var qo;typeof window<"u"&&((qo=window.__svelte??(window.__svelte={})).v??(qo.v=new Set)).add(il);let Qi=!1,sl=!1;function nl(){Qi=!0}nl();const cn=1,hn=2,tr=4,ol=8,rl=16,al=1,ll=2,cl=4,hl=8,dl=16,ul=1,fl=2,Ae=Symbol(),pl="http://www.w3.org/1999/xhtml",ir=!1;var sr=Array.isArray,gl=Array.prototype.indexOf,Kn=Array.from,nr=Object.defineProperty,vi=Object.getOwnPropertyDescriptor,or=Object.getOwnPropertyDescriptors,ml=Object.prototype,vl=Array.prototype,Zn=Object.getPrototypeOf,fo=Object.isExtensible;const $i=()=>{};function wl(e){return e()}function In(e){for(var t=0;t<e.length;t++)e[t]()}function rr(){var e,t,i=new Promise((s,n)=>{e=s,t=n});return{promise:i,resolve:e,reject:t}}const Oe=2,dn=4,un=8,Bt=16,jt=32,Ni=64,fn=128,vt=512,Le=1024,Xe=2048,Ot=4096,et=8192,ei=16384,Qn=32768,qi=65536,po=1<<17,ar=1<<18,es=1<<19,lr=1<<20,xs=32768,On=1<<21,eo=1<<22,ti=1<<23,wi=Symbol("$state"),xl=Symbol("legacy props"),yl=Symbol(""),Wi=new class extends Error{constructor(){super(...arguments);_t(this,"name","StaleReactionError");_t(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function bl(e){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function kl(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function Tl(e){throw new Error("https://svelte.dev/e/effect_in_teardown")}function _l(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function Pl(e){throw new Error("https://svelte.dev/e/effect_orphan")}function Sl(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function Ll(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function Nl(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function Cl(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function Rl(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}function El(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}let Al=!1;function cr(e){return e===this.v}function hr(e,t){return e!=e?t==t:e!==t||e!==null&&typeof e=="object"||typeof e=="function"}function dr(e){return!hr(e,this.v)}let me=null;function Ji(e){me=e}function le(e,t=!1,i){me={p:me,i:!1,c:null,e:null,s:e,x:null,l:Qi&&!t?{s:null,u:null,$:[]}:null}}function ce(e){var t=me,i=t.e;if(i!==null){t.e=null;for(var s of i)Cr(s)}return e!==void 0&&(t.x=e),t.i=!0,me=t.p,e??{}}function Cs(){return!Qi||me!==null&&me.l===null}let hi=[];function ur(){var e=hi;hi=[],In(e)}function ts(e){if(hi.length===0&&!gs){var t=hi;queueMicrotask(()=>{t===hi&&ur()})}hi.push(e)}function Ml(){for(;hi.length>0;)ur()}function fr(e){var t=ne;if(t===null)return Z.f|=ti,e;if((t.f&Qn)===0){if((t.f&fn)===0)throw e;t.b.error(e)}else Xi(e,t)}function Xi(e,t){for(;t!==null;){if((t.f&fn)!==0)try{t.b.error(e);return}catch(i){e=i}t=t.parent}throw e}const As=new Set;let he=null,Fs=null,ke=null,Rt=[],pn=null,Fn=!1,gs=!1;var ji,zi,di,ui,Ss,Ui,Vi,Ie,Wn,li,pr,gr;const on=class on{constructor(){se(this,Ie);_t(this,"committed",!1);_t(this,"current",new Map);_t(this,"previous",new Map);se(this,ji,new Set);se(this,zi,new Set);se(this,di,0);se(this,ui,0);se(this,Ss,null);se(this,Ui,[]);se(this,Vi,[]);_t(this,"skipped_effects",new Set);_t(this,"is_fork",!1)}process(t){var s;Rt=[],Fs=null,this.apply();var i={parent:null,effect:null,effects:[],render_effects:[],block_effects:[]};for(const n of t)be(this,Ie,Wn).call(this,n,i);this.is_fork||be(this,Ie,pr).call(this),b(this,ui)>0||this.is_fork?(be(this,Ie,li).call(this,i.effects),be(this,Ie,li).call(this,i.render_effects),be(this,Ie,li).call(this,i.block_effects)):(Fs=this,he=null,go(i.render_effects),go(i.effects),Fs=null,(s=b(this,Ss))==null||s.resolve()),ke=null}capture(t,i){this.previous.has(t)||this.previous.set(t,i),(t.f&ti)===0&&(this.current.set(t,t.v),ke==null||ke.set(t,t.v))}activate(){he=this,this.apply()}deactivate(){he=null,ke=null}flush(){if(this.activate(),Rt.length>0){if(mr(),he!==null&&he!==this)return}else b(this,di)===0&&this.process([]);this.deactivate()}discard(){for(const t of b(this,zi))t(this);b(this,zi).clear()}increment(t){G(this,di,b(this,di)+1),t&&G(this,ui,b(this,ui)+1)}decrement(t){G(this,di,b(this,di)-1),t&&G(this,ui,b(this,ui)-1),this.revive()}revive(){for(const t of b(this,Ui))Ne(t,Xe),ki(t);for(const t of b(this,Vi))Ne(t,Ot),ki(t);G(this,Ui,[]),G(this,Vi,[]),this.flush()}oncommit(t){b(this,ji).add(t)}ondiscard(t){b(this,zi).add(t)}settled(){return(b(this,Ss)??G(this,Ss,rr())).promise}static ensure(){if(he===null){const t=he=new on;As.add(he),gs||on.enqueue(()=>{he===t&&t.flush()})}return he}static enqueue(t){ts(t)}apply(){}};ji=new WeakMap,zi=new WeakMap,di=new WeakMap,ui=new WeakMap,Ss=new WeakMap,Ui=new WeakMap,Vi=new WeakMap,Ie=new WeakSet,Wn=function(t,i){var h;t.f^=Le;for(var s=t.first;s!==null;){var n=s.f,o=(n&(jt|Ni))!==0,r=o&&(n&Le)!==0,a=r||(n&et)!==0||this.skipped_effects.has(s);if((s.f&fn)!==0&&((h=s.b)!=null&&h.is_pending())&&(i={parent:i,effect:s,effects:[],render_effects:[],block_effects:[]}),!a&&s.fn!==null){o?s.f^=Le:(n&dn)!==0?i.effects.push(s):ss(s)&&((s.f&Bt)!==0&&i.block_effects.push(s),Yi(s));var l=s.first;if(l!==null){s=l;continue}}var c=s.parent;for(s=s.next;s===null&&c!==null;)c===i.effect&&(be(this,Ie,li).call(this,i.effects),be(this,Ie,li).call(this,i.render_effects),be(this,Ie,li).call(this,i.block_effects),i=i.parent),s=c.next,c=c.parent}},li=function(t){for(const i of t)((i.f&Xe)!==0?b(this,Ui):b(this,Vi)).push(i),Ne(i,Le)},pr=function(){if(b(this,ui)===0){for(const t of b(this,ji))t();b(this,ji).clear()}b(this,di)===0&&be(this,Ie,gr).call(this)},gr=function(){var n;if(As.size>1){this.previous.clear();var t=ke,i=!0,s={parent:null,effect:null,effects:[],render_effects:[],block_effects:[]};for(const o of As){if(o===this){i=!1;continue}const r=[];for(const[l,c]of this.current){if(o.current.has(l))if(i&&c!==o.current.get(l))o.current.set(l,c);else continue;r.push(l)}if(r.length===0)continue;const a=[...o.current.keys()].filter(l=>!this.current.has(l));if(a.length>0){const l=new Set,c=new Map;for(const h of r)vr(h,a,l,c);if(Rt.length>0){he=o,o.apply();for(const h of Rt)be(n=o,Ie,Wn).call(n,h,s);Rt=[],o.deactivate()}}}he=null,ke=t}this.committed=!0,As.delete(this)};let $t=on;function Dl(e){var t=gs;gs=!0;try{for(var i;;){if(Ml(),Rt.length===0&&(he==null||he.flush(),Rt.length===0))return pn=null,i;mr()}}finally{gs=t}}function mr(){var e=xi;Fn=!0;try{var t=0;for(wo(!0);Rt.length>0;){var i=$t.ensure();if(t++>1e3){var s,n;Il()}i.process(Rt),ii.clear()}}finally{Fn=!1,wo(e),pn=null}}function Il(){try{Sl()}catch(e){Xi(e,pn)}}let dt=null;function go(e){var t=e.length;if(t!==0){for(var i=0;i<t;){var s=e[i++];if((s.f&(ei|et))===0&&ss(s)&&(dt=new Set,Yi(s),s.deps===null&&s.first===null&&s.nodes_start===null&&(s.teardown===null&&s.ac===null?Mr(s):s.fn=null),(dt==null?void 0:dt.size)>0)){ii.clear();for(const n of dt){if((n.f&(ei|et))!==0)continue;const o=[n];let r=n.parent;for(;r!==null;)dt.has(r)&&(dt.delete(r),o.push(r)),r=r.parent;for(let a=o.length-1;a>=0;a--){const l=o[a];(l.f&(ei|et))===0&&Yi(l)}}dt.clear()}}dt=null}}function vr(e,t,i,s){if(!i.has(e)&&(i.add(e),e.reactions!==null))for(const n of e.reactions){const o=n.f;(o&Oe)!==0?vr(n,t,i,s):(o&(eo|Bt))!==0&&(o&Xe)===0&&wr(n,t,s)&&(Ne(n,Xe),ki(n))}}function wr(e,t,i){const s=i.get(e);if(s!==void 0)return s;if(e.deps!==null)for(const n of e.deps){if(t.includes(n))return!0;if((n.f&Oe)!==0&&wr(n,t,i))return i.set(n,!0),!0}return i.set(e,!1),!1}function ki(e){for(var t=pn=e;t.parent!==null;){t=t.parent;var i=t.f;if(Fn&&t===ne&&(i&Bt)!==0&&(i&ar)===0)return;if((i&(Ni|jt))!==0){if((i&Le)===0)return;t.f^=Le}}Rt.push(t)}function Ol(e){let t=0,i=Ti(0),s;return()=>{vn()&&(d(i),is(()=>(t===0&&(s=R(()=>e(()=>ms(i)))),t+=1,()=>{ts(()=>{t-=1,t===0&&(s==null||s(),s=void 0,ms(i))})})))}}var Fl=qi|es|fn;function Wl(e,t,i){new Hl(e,t,i)}var nt,ot,Gn,St,fi,Lt,rt,qe,Nt,Ht,Gt,pi,Yt,gi,Kt,rn,Se,$l,Bl,Hn,Ws,Hs,$n;class Hl{constructor(t,i,s){se(this,Se);_t(this,"parent");se(this,nt,!1);se(this,ot);se(this,Gn,null);se(this,St);se(this,fi);se(this,Lt);se(this,rt,null);se(this,qe,null);se(this,Nt,null);se(this,Ht,null);se(this,Gt,null);se(this,pi,0);se(this,Yt,0);se(this,gi,!1);se(this,Kt,null);se(this,rn,Ol(()=>(G(this,Kt,Ti(b(this,pi))),()=>{G(this,Kt,null)})));G(this,ot,t),G(this,St,i),G(this,fi,s),this.parent=ne.b,G(this,nt,!!b(this,St).pending),G(this,Lt,so(()=>{ne.b=this;{var n=be(this,Se,Hn).call(this);try{G(this,rt,ft(()=>s(n)))}catch(o){this.error(o)}b(this,Yt)>0?be(this,Se,Hs).call(this):G(this,nt,!1)}return()=>{var o;(o=b(this,Gt))==null||o.remove()}},Fl))}is_pending(){return b(this,nt)||!!this.parent&&this.parent.is_pending()}has_pending_snippet(){return!!b(this,St).pending}update_pending_count(t){be(this,Se,$n).call(this,t),G(this,pi,b(this,pi)+t),b(this,Kt)&&Gi(b(this,Kt),b(this,pi))}get_effect_pending(){return b(this,rn).call(this),d(b(this,Kt))}error(t){var i=b(this,St).onerror;let s=b(this,St).failed;if(b(this,gi)||!i&&!s)throw t;b(this,rt)&&(ze(b(this,rt)),G(this,rt,null)),b(this,qe)&&(ze(b(this,qe)),G(this,qe,null)),b(this,Nt)&&(ze(b(this,Nt)),G(this,Nt,null));var n=!1,o=!1;const r=()=>{if(n){El();return}n=!0,o&&Rl(),$t.ensure(),G(this,pi,0),b(this,Nt)!==null&&Bi(b(this,Nt),()=>{G(this,Nt,null)}),G(this,nt,this.has_pending_snippet()),G(this,rt,be(this,Se,Ws).call(this,()=>(G(this,gi,!1),ft(()=>b(this,fi).call(this,b(this,ot)))))),b(this,Yt)>0?be(this,Se,Hs).call(this):G(this,nt,!1)};var a=Z;try{Je(null),o=!0,i==null||i(t,r),o=!1}catch(l){Xi(l,b(this,Lt)&&b(this,Lt).parent)}finally{Je(a)}s&&ts(()=>{G(this,Nt,be(this,Se,Ws).call(this,()=>{$t.ensure(),G(this,gi,!0);try{return ft(()=>{s(b(this,ot),()=>t,()=>r)})}catch(l){return Xi(l,b(this,Lt).parent),null}finally{G(this,gi,!1)}}))})}}nt=new WeakMap,ot=new WeakMap,Gn=new WeakMap,St=new WeakMap,fi=new WeakMap,Lt=new WeakMap,rt=new WeakMap,qe=new WeakMap,Nt=new WeakMap,Ht=new WeakMap,Gt=new WeakMap,pi=new WeakMap,Yt=new WeakMap,gi=new WeakMap,Kt=new WeakMap,rn=new WeakMap,Se=new WeakSet,$l=function(){try{G(this,rt,ft(()=>b(this,fi).call(this,b(this,ot))))}catch(t){this.error(t)}G(this,nt,!1)},Bl=function(){const t=b(this,St).pending;t&&(G(this,qe,ft(()=>t(b(this,ot)))),$t.enqueue(()=>{var i=be(this,Se,Hn).call(this);G(this,rt,be(this,Se,Ws).call(this,()=>($t.ensure(),ft(()=>b(this,fi).call(this,i))))),b(this,Yt)>0?be(this,Se,Hs).call(this):(Bi(b(this,qe),()=>{G(this,qe,null)}),G(this,nt,!1))}))},Hn=function(){var t=b(this,ot);return b(this,nt)&&(G(this,Gt,_i()),b(this,ot).before(b(this,Gt)),t=b(this,Gt)),t},Ws=function(t){var i=ne,s=Z,n=me;At(b(this,Lt)),Je(b(this,Lt)),Ji(b(this,Lt).ctx);try{return t()}catch(o){return fr(o),null}finally{At(i),Je(s),Ji(n)}},Hs=function(){const t=b(this,St).pending;b(this,rt)!==null&&(G(this,Ht,document.createDocumentFragment()),b(this,Ht).append(b(this,Gt)),Or(b(this,rt),b(this,Ht))),b(this,qe)===null&&G(this,qe,ft(()=>t(b(this,ot))))},$n=function(t){var i;if(!this.has_pending_snippet()){this.parent&&be(i=this.parent,Se,$n).call(i,t);return}G(this,Yt,b(this,Yt)+t),b(this,Yt)===0&&(G(this,nt,!1),b(this,qe)&&Bi(b(this,qe),()=>{G(this,qe,null)}),b(this,Ht)&&(b(this,ot).before(b(this,Ht)),G(this,Ht,null)))};function jl(e,t,i,s){const n=Cs()?gn:to;if(i.length===0&&e.length===0){s(t.map(n));return}var o=he,r=ne,a=zl();function l(){Promise.all(i.map(c=>Ul(c))).then(c=>{a();try{s([...t.map(n),...c])}catch(h){(r.f&ei)===0&&Xi(h,r)}o==null||o.deactivate(),Vs()}).catch(c=>{Xi(c,r)})}e.length>0?Promise.all(e).then(()=>{a();try{return l()}finally{o==null||o.deactivate(),Vs()}}):l()}function zl(){var e=ne,t=Z,i=me,s=he;return function(o=!0){At(e),Je(t),Ji(i),o&&(s==null||s.activate())}}function Vs(){At(null),Je(null),Ji(null)}function gn(e){var t=Oe|Xe,i=Z!==null&&(Z.f&Oe)!==0?Z:null;return ne!==null&&(ne.f|=es),{ctx:me,deps:null,effects:null,equals:cr,f:t,fn:e,reactions:null,rv:0,v:Ae,wv:0,parent:i??ne,ac:null}}function Ul(e,t){let i=ne;i===null&&kl();var s=i.b,n=void 0,o=Ti(Ae),r=!Z,a=new Map;return ic(()=>{var g;var l=rr();n=l.promise;try{Promise.resolve(e()).then(l.resolve,l.reject).then(()=>{c===he&&c.committed&&c.deactivate(),Vs()})}catch(v){l.reject(v),Vs()}var c=he;if(r){var h=!s.is_pending();s.update_pending_count(1),c.increment(h),(g=a.get(c))==null||g.reject(Wi),a.delete(c),a.set(c,l)}const f=(v,w=void 0)=>{if(c.activate(),w)w!==Wi&&(o.f|=ti,Gi(o,w));else{(o.f&ti)!==0&&(o.f^=ti),Gi(o,v);for(const[x,y]of a){if(a.delete(x),x===c)break;y.reject(Wi)}}r&&(s.update_pending_count(-1),c.decrement(h))};l.promise.then(f,v=>f(null,v||"unknown"))}),wn(()=>{for(const l of a.values())l.reject(Wi)}),new Promise(l=>{function c(h){function f(){h===n?l(o):c(n)}h.then(f,f)}c(n)})}function to(e){const t=gn(e);return t.equals=dr,t}function xr(e){var t=e.effects;if(t!==null){e.effects=null;for(var i=0;i<t.length;i+=1)ze(t[i])}}function Vl(e){for(var t=e.parent;t!==null;){if((t.f&Oe)===0)return t;t=t.parent}return null}function io(e){var t,i=ne;At(Vl(e));try{e.f&=~xs,xr(e),t=$r(e)}finally{At(i)}return t}function yr(e){var t=io(e);if(e.equals(t)||(e.v=t,e.wv=Wr()),!Ci)if(ke!==null)vn()&&ke.set(e,e.v);else{var i=(e.f&vt)===0?Ot:Le;Ne(e,i)}}let Bn=new Set;const ii=new Map;let br=!1;function Ti(e,t){var i={f:0,v:e,reactions:null,equals:cr,rv:0,wv:0};return i}function Xt(e,t){const i=Ti(e);return nc(i),i}function V(e,t=!1,i=!0){var n;const s=Ti(e);return t||(s.equals=dr),Qi&&i&&me!==null&&me.l!==null&&((n=me.l).s??(n.s=[])).push(s),s}function j(e,t){return W(e,R(()=>d(e))),t}function W(e,t,i=!1){Z!==null&&(!Et||(Z.f&po)!==0)&&Cs()&&(Z.f&(Oe|Bt|eo|po))!==0&&!(Ue!=null&&Ue.includes(e))&&Cl();let s=i?Hi(t):t;return Gi(e,s)}function Gi(e,t){if(!e.equals(t)){var i=e.v;Ci?ii.set(e,t):ii.set(e,i),e.v=t;var s=$t.ensure();s.capture(e,i),(e.f&Oe)!==0&&((e.f&Xe)!==0&&io(e),Ne(e,(e.f&vt)!==0?Le:Ot)),e.wv=Wr(),kr(e,Xe),Cs()&&ne!==null&&(ne.f&Le)!==0&&(ne.f&(jt|Ni))===0&&(st===null?oc([e]):st.push(e)),!s.is_fork&&Bn.size>0&&!br&&ql()}return t}function ql(){br=!1;const e=Array.from(Bn);for(const t of e)(t.f&Le)!==0&&Ne(t,Ot),ss(t)&&Yi(t);Bn.clear()}function ms(e){W(e,e.v+1)}function kr(e,t){var i=e.reactions;if(i!==null)for(var s=Cs(),n=i.length,o=0;o<n;o++){var r=i[o],a=r.f;if(!(!s&&r===ne)){var l=(a&Xe)===0;if(l&&Ne(r,t),(a&Oe)!==0){var c=r;ke==null||ke.delete(c),(a&xs)===0&&(a&vt&&(r.f|=xs),kr(c,Ot))}else l&&((a&Bt)!==0&&dt!==null&&dt.add(r),ki(r))}}}function Hi(e){if(typeof e!="object"||e===null||wi in e)return e;const t=Zn(e);if(t!==ml&&t!==vl)return e;var i=new Map,s=sr(e),n=Xt(0),o=yi,r=a=>{if(yi===o)return a();var l=Z,c=yi;Je(null),yo(o);var h=a();return Je(l),yo(c),h};return s&&i.set("length",Xt(e.length)),new Proxy(e,{defineProperty(a,l,c){(!("value"in c)||c.configurable===!1||c.enumerable===!1||c.writable===!1)&&Ll();var h=i.get(l);return h===void 0?h=r(()=>{var f=Xt(c.value);return i.set(l,f),f}):W(h,c.value,!0),!0},deleteProperty(a,l){var c=i.get(l);if(c===void 0){if(l in a){const h=r(()=>Xt(Ae));i.set(l,h),ms(n)}}else W(c,Ae),ms(n);return!0},get(a,l,c){var v;if(l===wi)return e;var h=i.get(l),f=l in a;if(h===void 0&&(!f||(v=vi(a,l))!=null&&v.writable)&&(h=r(()=>{var w=Hi(f?a[l]:Ae),x=Xt(w);return x}),i.set(l,h)),h!==void 0){var g=d(h);return g===Ae?void 0:g}return Reflect.get(a,l,c)},getOwnPropertyDescriptor(a,l){var c=Reflect.getOwnPropertyDescriptor(a,l);if(c&&"value"in c){var h=i.get(l);h&&(c.value=d(h))}else if(c===void 0){var f=i.get(l),g=f==null?void 0:f.v;if(f!==void 0&&g!==Ae)return{enumerable:!0,configurable:!0,value:g,writable:!0}}return c},has(a,l){var g;if(l===wi)return!0;var c=i.get(l),h=c!==void 0&&c.v!==Ae||Reflect.has(a,l);if(c!==void 0||ne!==null&&(!h||(g=vi(a,l))!=null&&g.writable)){c===void 0&&(c=r(()=>{var v=h?Hi(a[l]):Ae,w=Xt(v);return w}),i.set(l,c));var f=d(c);if(f===Ae)return!1}return h},set(a,l,c,h){var D;var f=i.get(l),g=l in a;if(s&&l==="length")for(var v=c;v<f.v;v+=1){var w=i.get(v+"");w!==void 0?W(w,Ae):v in a&&(w=r(()=>Xt(Ae)),i.set(v+"",w))}if(f===void 0)(!g||(D=vi(a,l))!=null&&D.writable)&&(f=r(()=>Xt(void 0)),W(f,Hi(c)),i.set(l,f));else{g=f.v!==Ae;var x=r(()=>Hi(c));W(f,x)}var y=Reflect.getOwnPropertyDescriptor(a,l);if(y!=null&&y.set&&y.set.call(h,c),!g){if(s&&typeof l=="string"){var L=i.get("length"),T=Number(l);Number.isInteger(T)&&T>=L.v&&W(L,T+1)}ms(n)}return!0},ownKeys(a){d(n);var l=Reflect.ownKeys(a).filter(f=>{var g=i.get(f);return g===void 0||g.v!==Ae});for(var[c,h]of i)h.v!==Ae&&!(c in a)&&l.push(c);return l},setPrototypeOf(){Nl()}})}var mo,Tr,_r,Pr;function Jl(){if(mo===void 0){mo=window,Tr=/Firefox/.test(navigator.userAgent);var e=Element.prototype,t=Node.prototype,i=Text.prototype;_r=vi(t,"firstChild").get,Pr=vi(t,"nextSibling").get,fo(e)&&(e.__click=void 0,e.__className=void 0,e.__attributes=null,e.__style=void 0,e.__e=void 0),fo(i)&&(i.__t=void 0)}}function _i(e=""){return document.createTextNode(e)}function Zt(e){return _r.call(e)}function Rs(e){return Pr.call(e)}function A(e,t){return Zt(e)}function de(e,t=!1){{var i=Zt(e);return i instanceof Comment&&i.data===""?Rs(i):i}}function B(e,t=1,i=!1){let s=e;for(;t--;)s=Rs(s);return s}function Xl(e){e.textContent=""}function Sr(){return!1}let vo=!1;function Gl(){vo||(vo=!0,document.addEventListener("reset",e=>{Promise.resolve().then(()=>{var t;if(!e.defaultPrevented)for(const i of e.target.elements)(t=i.__on_r)==null||t.call(i)})},{capture:!0}))}function mn(e){var t=Z,i=ne;Je(null),At(null);try{return e()}finally{Je(t),At(i)}}function Lr(e,t,i,s=i){e.addEventListener(t,()=>mn(i));const n=e.__on_r;n?e.__on_r=()=>{n(),s(!0)}:e.__on_r=()=>s(!0),Gl()}function Nr(e){ne===null&&(Z===null&&Pl(),_l()),Ci&&Tl()}function Yl(e,t){var i=t.last;i===null?t.last=t.first=e:(i.next=e,e.prev=i,t.last=e)}function Ft(e,t,i,s=!0){var n=ne;n!==null&&(n.f&et)!==0&&(e|=et);var o={ctx:me,deps:null,nodes_start:null,nodes_end:null,f:e|Xe|vt,first:null,fn:t,last:null,next:null,parent:n,b:n&&n.b,prev:null,teardown:null,transitions:null,wv:0,ac:null};if(i)try{Yi(o),o.f|=Qn}catch(l){throw ze(o),l}else t!==null&&ki(o);if(s){var r=o;if(i&&r.deps===null&&r.teardown===null&&r.nodes_start===null&&r.first===r.last&&(r.f&es)===0&&(r=r.first,(e&Bt)!==0&&(e&qi)!==0&&r!==null&&(r.f|=qi)),r!==null&&(r.parent=n,n!==null&&Yl(r,n),Z!==null&&(Z.f&Oe)!==0&&(e&Ni)===0)){var a=Z;(a.effects??(a.effects=[])).push(r)}}return o}function vn(){return Z!==null&&!Et}function wn(e){const t=Ft(un,null,!1);return Ne(t,Le),t.teardown=e,t}function jn(e){Nr();var t=ne.f,i=!Z&&(t&jt)!==0&&(t&Qn)===0;if(i){var s=me;(s.e??(s.e=[])).push(e)}else return Cr(e)}function Cr(e){return Ft(dn|lr,e,!1)}function Kl(e){return Nr(),Ft(un|lr,e,!0)}function Zl(e){$t.ensure();const t=Ft(Ni|es,e,!0);return(i={})=>new Promise(s=>{i.outro?Bi(t,()=>{ze(t),s(void 0)}):(ze(t),s(void 0))})}function Ql(e){return Ft(dn,e,!1)}function ec(e,t){var i=me,s={effect:null,ran:!1,deps:e};i.l.$.push(s),s.effect=is(()=>{e(),!s.ran&&(s.ran=!0,R(t))})}function tc(){var e=me;is(()=>{for(var t of e.l.$){t.deps();var i=t.effect;(i.f&Le)!==0&&Ne(i,Ot),ss(i)&&Yi(i),t.ran=!1}})}function ic(e){return Ft(eo|es,e,!0)}function is(e,t=0){return Ft(un|t,e,!0)}function oe(e,t=[],i=[],s=[],n=!1){jl(s,t,i,o=>{Ft(n?dn:un,()=>e(...o.map(d)),!0)})}function so(e,t=0){var i=Ft(Bt|t,e,!0);return i}function ft(e,t=!0){return Ft(jt|es,e,!0,t)}function Rr(e){var t=e.teardown;if(t!==null){const i=Ci,s=Z;xo(!0),Je(null);try{t.call(null)}finally{xo(i),Je(s)}}}function Er(e,t=!1){var i=e.first;for(e.first=e.last=null;i!==null;){const n=i.ac;n!==null&&mn(()=>{n.abort(Wi)});var s=i.next;(i.f&Ni)!==0?i.parent=null:ze(i,t),i=s}}function sc(e){for(var t=e.first;t!==null;){var i=t.next;(t.f&jt)===0&&ze(t),t=i}}function ze(e,t=!0){var i=!1;(t||(e.f&ar)!==0)&&e.nodes_start!==null&&e.nodes_end!==null&&(Ar(e.nodes_start,e.nodes_end),i=!0),Er(e,t&&!i),qs(e,0),Ne(e,ei);var s=e.transitions;if(s!==null)for(const o of s)o.stop();Rr(e);var n=e.parent;n!==null&&n.first!==null&&Mr(e),e.next=e.prev=e.teardown=e.ctx=e.deps=e.fn=e.nodes_start=e.nodes_end=e.ac=null}function Ar(e,t){for(;e!==null;){var i=e===t?null:Rs(e);e.remove(),e=i}}function Mr(e){var t=e.parent,i=e.prev,s=e.next;i!==null&&(i.next=s),s!==null&&(s.prev=i),t!==null&&(t.first===e&&(t.first=s),t.last===e&&(t.last=i))}function Bi(e,t,i=!0){var s=[];no(e,s,!0),Dr(s,()=>{i&&ze(e),t&&t()})}function Dr(e,t){var i=e.length;if(i>0){var s=()=>--i||t();for(var n of e)n.out(s)}else t()}function no(e,t,i){if((e.f&et)===0){if(e.f^=et,e.transitions!==null)for(const r of e.transitions)(r.is_global||i)&&t.push(r);for(var s=e.first;s!==null;){var n=s.next,o=(s.f&qi)!==0||(s.f&jt)!==0&&(e.f&Bt)!==0;no(s,t,o?i:!1),s=n}}}function oo(e){Ir(e,!0)}function Ir(e,t){if((e.f&et)!==0){e.f^=et,(e.f&Le)===0&&(Ne(e,Xe),ki(e));for(var i=e.first;i!==null;){var s=i.next,n=(i.f&qi)!==0||(i.f&jt)!==0;Ir(i,n?t:!1),i=s}if(e.transitions!==null)for(const o of e.transitions)(o.is_global||t)&&o.in()}}function Or(e,t){for(var i=e.nodes_start,s=e.nodes_end;i!==null;){var n=i===s?null:Rs(i);t.append(i),i=n}}let xi=!1;function wo(e){xi=e}let Ci=!1;function xo(e){Ci=e}let Z=null,Et=!1;function Je(e){Z=e}let ne=null;function At(e){ne=e}let Ue=null;function nc(e){Z!==null&&(Ue===null?Ue=[e]:Ue.push(e))}let je=null,Ke=0,st=null;function oc(e){st=e}let Fr=1,ys=0,yi=ys;function yo(e){yi=e}function Wr(){return++Fr}function ss(e){var t=e.f;if((t&Xe)!==0)return!0;if(t&Oe&&(e.f&=~xs),(t&Ot)!==0){var i=e.deps;if(i!==null)for(var s=i.length,n=0;n<s;n++){var o=i[n];if(ss(o)&&yr(o),o.wv>e.wv)return!0}(t&vt)!==0&&ke===null&&Ne(e,Le)}return!1}function Hr(e,t,i=!0){var s=e.reactions;if(s!==null&&!(Ue!=null&&Ue.includes(e)))for(var n=0;n<s.length;n++){var o=s[n];(o.f&Oe)!==0?Hr(o,t,!1):t===o&&(i?Ne(o,Xe):(o.f&Le)!==0&&Ne(o,Ot),ki(o))}}function $r(e){var w;var t=je,i=Ke,s=st,n=Z,o=Ue,r=me,a=Et,l=yi,c=e.f;je=null,Ke=0,st=null,Z=(c&(jt|Ni))===0?e:null,Ue=null,Ji(e.ctx),Et=!1,yi=++ys,e.ac!==null&&(mn(()=>{e.ac.abort(Wi)}),e.ac=null);try{e.f|=On;var h=e.fn,f=h(),g=e.deps;if(je!==null){var v;if(qs(e,Ke),g!==null&&Ke>0)for(g.length=Ke+je.length,v=0;v<je.length;v++)g[Ke+v]=je[v];else e.deps=g=je;if(xi&&vn()&&(e.f&vt)!==0)for(v=Ke;v<g.length;v++)((w=g[v]).reactions??(w.reactions=[])).push(e)}else g!==null&&Ke<g.length&&(qs(e,Ke),g.length=Ke);if(Cs()&&st!==null&&!Et&&g!==null&&(e.f&(Oe|Ot|Xe))===0)for(v=0;v<st.length;v++)Hr(st[v],e);return n!==null&&n!==e&&(ys++,st!==null&&(s===null?s=st:s.push(...st))),(e.f&ti)!==0&&(e.f^=ti),f}catch(x){return fr(x)}finally{e.f^=On,je=t,Ke=i,st=s,Z=n,Ue=o,Ji(r),Et=a,yi=l}}function rc(e,t){let i=t.reactions;if(i!==null){var s=gl.call(i,e);if(s!==-1){var n=i.length-1;n===0?i=t.reactions=null:(i[s]=i[n],i.pop())}}i===null&&(t.f&Oe)!==0&&(je===null||!je.includes(t))&&(Ne(t,Ot),(t.f&vt)!==0&&(t.f^=vt,t.f&=~xs),xr(t),qs(t,0))}function qs(e,t){var i=e.deps;if(i!==null)for(var s=t;s<i.length;s++)rc(e,i[s])}function Yi(e){var t=e.f;if((t&ei)===0){Ne(e,Le);var i=ne,s=xi;ne=e,xi=!0;try{(t&Bt)!==0?sc(e):Er(e),Rr(e);var n=$r(e);e.teardown=typeof n=="function"?n:null,e.wv=Fr;var o;ir&&sl&&(e.f&Xe)!==0&&e.deps}finally{xi=s,ne=i}}}async function ac(){await Promise.resolve(),Dl()}function d(e){var t=e.f,i=(t&Oe)!==0;if(Z!==null&&!Et){var s=ne!==null&&(ne.f&ei)!==0;if(!s&&!(Ue!=null&&Ue.includes(e))){var n=Z.deps;if((Z.f&On)!==0)e.rv<ys&&(e.rv=ys,je===null&&n!==null&&n[Ke]===e?Ke++:je===null?je=[e]:je.includes(e)||je.push(e));else{(Z.deps??(Z.deps=[])).push(e);var o=e.reactions;o===null?e.reactions=[Z]:o.includes(Z)||o.push(Z)}}}if(Ci){if(ii.has(e))return ii.get(e);if(i){var r=e,a=r.v;return((r.f&Le)===0&&r.reactions!==null||jr(r))&&(a=io(r)),ii.set(r,a),a}}else if(i){if(r=e,ke!=null&&ke.has(r))return ke.get(r);ss(r)&&yr(r),xi&&vn()&&(r.f&vt)===0&&Br(r)}else if(ke!=null&&ke.has(e))return ke.get(e);if((e.f&ti)!==0)throw e.v;return e.v}function Br(e){if(e.deps!==null){e.f^=vt;for(const t of e.deps)(t.reactions??(t.reactions=[])).push(e),(t.f&Oe)!==0&&(t.f&vt)===0&&Br(t)}}function jr(e){if(e.v===Ae)return!0;if(e.deps===null)return!1;for(const t of e.deps)if(ii.has(t)||(t.f&Oe)!==0&&jr(t))return!0;return!1}function R(e){var t=Et;try{return Et=!0,e()}finally{Et=t}}const lc=-7169;function Ne(e,t){e.f=e.f&lc|t}function xe(e){if(!(typeof e!="object"||!e||e instanceof EventTarget)){if(wi in e)zn(e);else if(!Array.isArray(e))for(let t in e){const i=e[t];typeof i=="object"&&i&&wi in i&&zn(i)}}}function zn(e,t=new Set){if(typeof e=="object"&&e!==null&&!(e instanceof EventTarget)&&!t.has(e)){t.add(e),e instanceof Date&&e.getTime();for(let s in e)try{zn(e[s],t)}catch{}const i=Zn(e);if(i!==Object.prototype&&i!==Array.prototype&&i!==Map.prototype&&i!==Set.prototype&&i!==Date.prototype){const s=or(i);for(let n in s){const o=s[n].get;if(o)try{o.call(e)}catch{}}}}}const cc=new Set,bo=new Set;function hc(e,t,i,s={}){function n(o){if(s.capture||us.call(t,o),!o.cancelBubble)return mn(()=>i==null?void 0:i.call(this,o))}return e.startsWith("pointer")||e.startsWith("touch")||e==="wheel"?ts(()=>{t.addEventListener(e,n,s)}):t.addEventListener(e,n,s),n}function N(e,t,i,s,n){var o={capture:s,passive:n},r=hc(e,t,i,o);(t===document.body||t===window||t===document||t instanceof HTMLMediaElement)&&wn(()=>{t.removeEventListener(e,r,o)})}let ko=null;function us(e){var y;var t=this,i=t.ownerDocument,s=e.type,n=((y=e.composedPath)==null?void 0:y.call(e))||[],o=n[0]||e.target;ko=e;var r=0,a=ko===e&&e.__root;if(a){var l=n.indexOf(a);if(l!==-1&&(t===document||t===window)){e.__root=t;return}var c=n.indexOf(t);if(c===-1)return;l<=c&&(r=l)}if(o=n[r]||e.target,o!==t){nr(e,"currentTarget",{configurable:!0,get(){return o||i}});var h=Z,f=ne;Je(null),At(null);try{for(var g,v=[];o!==null;){var w=o.assignedSlot||o.parentNode||o.host||null;try{var x=o["__"+s];x!=null&&(!o.disabled||e.target===o)&&x.call(o,e)}catch(L){g?v.push(L):g=L}if(e.cancelBubble||w===t||w===null)break;o=w}if(g){for(let L of v)queueMicrotask(()=>{throw L});throw g}}finally{e.__root=t,delete e.currentTarget,Je(h),At(f)}}}function zr(e){var t=document.createElement("template");return t.innerHTML=e.replaceAll("<!>","<!---->"),t.content}function Js(e,t){var i=ne;i.nodes_start===null&&(i.nodes_start=e,i.nodes_end=t)}function z(e,t){var i=(t&ul)!==0,s=(t&fl)!==0,n,o=!e.startsWith("<!>");return()=>{n===void 0&&(n=zr(o?e:"<!>"+e),i||(n=Zt(n)));var r=s||Tr?document.importNode(n,!0):n.cloneNode(!0);if(i){var a=Zt(r),l=r.lastChild;Js(a,l)}else Js(r,r);return r}}function Qe(){var e=document.createDocumentFragment(),t=document.createComment(""),i=_i();return e.append(t,i),Js(t,i),e}function F(e,t){e!==null&&e.before(t)}const dc=["touchstart","touchmove"];function uc(e){return dc.includes(e)}function K(e,t){var i=t==null?"":typeof t=="object"?t+"":t;i!==(e.__t??(e.__t=e.nodeValue))&&(e.__t=i,e.nodeValue=i+"")}function Ur(e,t){return fc(e,t)}const Di=new Map;function fc(e,{target:t,anchor:i,props:s={},events:n,context:o,intro:r=!0}){Jl();var a=new Set,l=f=>{for(var g=0;g<f.length;g++){var v=f[g];if(!a.has(v)){a.add(v);var w=uc(v);t.addEventListener(v,us,{passive:w});var x=Di.get(v);x===void 0?(document.addEventListener(v,us,{passive:w}),Di.set(v,1)):Di.set(v,x+1)}}};l(Kn(cc)),bo.add(l);var c=void 0,h=Zl(()=>{var f=i??t.appendChild(_i());return Wl(f,{pending:()=>{}},g=>{if(o){le({});var v=me;v.c=o}n&&(s.$$events=n),c=e(g,s)||{},o&&ce()}),()=>{var w;for(var g of a){t.removeEventListener(g,us);var v=Di.get(g);--v===0?(document.removeEventListener(g,us),Di.delete(g)):Di.set(g,v)}bo.delete(l),f!==i&&((w=f.parentNode)==null||w.removeChild(f))}});return pc.set(c,h),c}let pc=new WeakMap;var ut,Ct,Ze,Ls,Ns,an;class gc{constructor(t,i=!0){_t(this,"anchor");se(this,ut,new Map);se(this,Ct,new Map);se(this,Ze,new Map);se(this,Ls,!0);se(this,Ns,()=>{var t=he;if(b(this,ut).has(t)){var i=b(this,ut).get(t),s=b(this,Ct).get(i);if(s)oo(s);else{var n=b(this,Ze).get(i);n&&(b(this,Ct).set(i,n.effect),b(this,Ze).delete(i),n.fragment.lastChild.remove(),this.anchor.before(n.fragment),s=n.effect)}for(const[o,r]of b(this,ut)){if(b(this,ut).delete(o),o===t)break;const a=b(this,Ze).get(r);a&&(ze(a.effect),b(this,Ze).delete(r))}for(const[o,r]of b(this,Ct)){if(o===i)continue;const a=()=>{if(Array.from(b(this,ut).values()).includes(o)){var c=document.createDocumentFragment();Or(r,c),c.append(_i()),b(this,Ze).set(o,{effect:r,fragment:c})}else ze(r);b(this,Ct).delete(o)};b(this,Ls)||!s?Bi(r,a,!1):a()}}});se(this,an,t=>{b(this,ut).delete(t);const i=Array.from(b(this,ut).values());for(const[s,n]of b(this,Ze))i.includes(s)||(ze(n.effect),b(this,Ze).delete(s))});this.anchor=t,G(this,Ls,i)}ensure(t,i){var s=he,n=Sr();if(i&&!b(this,Ct).has(t)&&!b(this,Ze).has(t))if(n){var o=document.createDocumentFragment(),r=_i();o.append(r),b(this,Ze).set(t,{effect:ft(()=>i(r)),fragment:o})}else b(this,Ct).set(t,ft(()=>i(this.anchor)));if(b(this,ut).set(s,t),n){for(const[a,l]of b(this,Ct))a===t?s.skipped_effects.delete(l):s.skipped_effects.add(l);for(const[a,l]of b(this,Ze))a===t?s.skipped_effects.delete(l.effect):s.skipped_effects.add(l.effect);s.oncommit(b(this,Ns)),s.ondiscard(b(this,an))}else b(this,Ns).call(this)}}ut=new WeakMap,Ct=new WeakMap,Ze=new WeakMap,Ls=new WeakMap,Ns=new WeakMap,an=new WeakMap;function pe(e){me===null&&bl(),Qi&&me.l!==null?mc(me).m.push(e):jn(()=>{const t=R(e);if(typeof t=="function")return t})}function mc(e){var t=e.l;return t.u??(t.u={a:[],b:[],m:[]})}function fe(e,t,i=!1){var s=new gc(e),n=i?qi:0;function o(r,a){s.ensure(r,a)}so(()=>{var r=!1;t((a,l=!0)=>{r=!0,o(l,a)}),r||o(!1,null)},n)}function gt(e,t){return t}function vc(e,t,i){for(var s=e.items,n=[],o=t.length,r=0;r<o;r++)no(t[r].e,n,!0);var a=o>0&&n.length===0&&i!==null;if(a){var l=i.parentNode;Xl(l),l.append(i),s.clear(),Pt(e,t[0].prev,t[o-1].next)}Dr(n,()=>{for(var c=0;c<o;c++){var h=t[c];a||(s.delete(h.k),Pt(e,h.prev,h.next)),ze(h.e,!a)}})}function mt(e,t,i,s,n,o=null){var r=e,a={flags:t,items:new Map,first:null},l=(t&tr)!==0;if(l){var c=e;r=c.appendChild(_i())}var h=null,f=!1,g=new Map,v=to(()=>{var L=i();return sr(L)?L:L==null?[]:Kn(L)}),w,x;function y(){wc(x,w,a,g,r,n,t,s,i),o!==null&&(w.length===0?h?oo(h):h=ft(()=>o(r)):h!==null&&Bi(h,()=>{h=null}))}so(()=>{x??(x=ne),w=d(v);var L=w.length;if(!(f&&L===0)){f=L===0;var T,D,E,_;if(Sr()){var I=new Set,q=he;for(D=0;D<L;D+=1){E=w[D],_=s(E,D);var ae=a.items.get(_)??g.get(_);ae?(t&(cn|hn))!==0&&Vr(ae,E,D,t):(T=qr(null,a,null,null,E,_,D,n,t,i,!0),g.set(_,T)),I.add(_)}for(const[ve,Ee]of a.items)I.has(ve)||q.skipped_effects.add(Ee.e);q.oncommit(y)}else y();d(v)}})}function wc(e,t,i,s,n,o,r,a,l){var ye,O,X,te;var c=(r&ol)!==0,h=(r&(cn|hn))!==0,f=t.length,g=i.items,v=i.first,w=v,x,y=null,L,T=[],D=[],E,_,I,q;if(c)for(q=0;q<f;q+=1)E=t[q],_=a(E,q),I=g.get(_),I!==void 0&&((ye=I.a)==null||ye.measure(),(L??(L=new Set)).add(I));for(q=0;q<f;q+=1){if(E=t[q],_=a(E,q),I=g.get(_),I===void 0){var ae=s.get(_);if(ae!==void 0){s.delete(_),g.set(_,ae);var ve=y?y.next:w;Pt(i,y,ae),Pt(i,ae,ve),Cn(ae,ve,n),y=ae}else{var Ee=w?w.e.nodes_start:n;y=qr(Ee,i,y,y===null?i.first:y.next,E,_,q,o,r,l)}g.set(_,y),T=[],D=[],w=y.next;continue}if(h&&Vr(I,E,q,r),(I.e.f&et)!==0&&(oo(I.e),c&&((O=I.a)==null||O.unfix(),(L??(L=new Set)).delete(I))),I!==w){if(x!==void 0&&x.has(I)){if(T.length<D.length){var we=D[0],ge;y=we.prev;var Ve=T[0],We=T[T.length-1];for(ge=0;ge<T.length;ge+=1)Cn(T[ge],we,n);for(ge=0;ge<D.length;ge+=1)x.delete(D[ge]);Pt(i,Ve.prev,We.next),Pt(i,y,Ve),Pt(i,We,we),w=we,y=We,q-=1,T=[],D=[]}else x.delete(I),Cn(I,w,n),Pt(i,I.prev,I.next),Pt(i,I,y===null?i.first:y.next),Pt(i,y,I),y=I;continue}for(T=[],D=[];w!==null&&w.k!==_;)(w.e.f&et)===0&&(x??(x=new Set)).add(w),D.push(w),w=w.next;if(w===null)continue;I=w}T.push(I),y=I,w=I.next}if(w!==null||x!==void 0){for(var U=x===void 0?[]:Kn(x);w!==null;)(w.e.f&et)===0&&U.push(w),w=w.next;var P=U.length;if(P>0){var Y=(r&tr)!==0&&f===0?n:null;if(c){for(q=0;q<P;q+=1)(X=U[q].a)==null||X.measure();for(q=0;q<P;q+=1)(te=U[q].a)==null||te.fix()}vc(i,U,Y)}}c&&ts(()=>{var Ge;if(L!==void 0)for(I of L)(Ge=I.a)==null||Ge.apply()}),e.first=i.first&&i.first.e,e.last=y&&y.e;for(var ee of s.values())ze(ee.e);s.clear()}function Vr(e,t,i,s){(s&cn)!==0&&Gi(e.v,t),(s&hn)!==0?Gi(e.i,i):e.i=i}function qr(e,t,i,s,n,o,r,a,l,c,h){var f=(l&cn)!==0,g=(l&rl)===0,v=f?g?V(n,!1,!1):Ti(n):n,w=(l&hn)===0?r:Ti(r),x={i:w,v,k:o,a:null,e:null,prev:i,next:s};try{if(e===null){var y=document.createDocumentFragment();y.append(e=_i())}return x.e=ft(()=>a(e,v,w,c),Al),x.e.prev=i&&i.e,x.e.next=s&&s.e,i===null?h||(t.first=x):(i.next=x,i.e.next=x.e),s!==null&&(s.prev=x,s.e.prev=x.e),x}finally{}}function Cn(e,t,i){for(var s=e.next?e.next.e.nodes_start:i,n=t?t.e.nodes_start:i,o=e.e.nodes_start;o!==null&&o!==s;){var r=Rs(o);n.before(o),o=r}}function Pt(e,t,i){t===null?e.first=i:(t.next=i,t.e.next=i&&i.e),i!==null&&(i.prev=t,i.e.prev=t&&t.e)}function To(e,t,i=!1,s=!1,n=!1){var o=e,r="";oe(()=>{var a=ne;if(r!==(r=t()??"")&&(a.nodes_start!==null&&(Ar(a.nodes_start,a.nodes_end),a.nodes_start=a.nodes_end=null),r!=="")){var l=r+"";i?l=`<svg>${l}</svg>`:s&&(l=`<math>${l}</math>`);var c=zr(l);if((i||s)&&(c=Zt(c)),Js(Zt(c),c.lastChild),i||s)for(;Zt(c);)o.before(Zt(c));else o.before(c)}})}function Jr(e,t,i,s,n){var a;var o=(a=t.$$slots)==null?void 0:a[i],r=!1;o===!0&&(o=t.children,r=!0),o===void 0||o(e,r?()=>s:s)}function Xr(e){var t,i,s="";if(typeof e=="string"||typeof e=="number")s+=e;else if(typeof e=="object")if(Array.isArray(e)){var n=e.length;for(t=0;t<n;t++)e[t]&&(i=Xr(e[t]))&&(s&&(s+=" "),s+=i)}else for(i in e)e[i]&&(s&&(s+=" "),s+=i);return s}function xc(){for(var e,t,i=0,s="",n=arguments.length;i<n;i++)(e=arguments[i])&&(t=Xr(e))&&(s&&(s+=" "),s+=t);return s}function yc(e){return typeof e=="object"?xc(e):e??""}function bc(e,t,i){var s=e==null?"":""+e;return t&&(s=s?s+" "+t:t),s===""?null:s}function kc(e,t){return e==null?null:String(e)}function bs(e,t,i,s,n,o){var r=e.__className;if(r!==i||r===void 0){var a=bc(i,s);a==null?e.removeAttribute("class"):e.className=a,e.__className=i}return o}function wt(e,t,i,s){var n=e.__style;if(n!==t){var o=kc(t);o==null?e.removeAttribute("style"):e.style.cssText=o,e.__style=t}return s}const Tc=Symbol("is custom element"),_c=Symbol("is html");function ie(e,t,i,s){var n=Pc(e);n[t]!==(n[t]=i)&&(t==="loading"&&(e[yl]=i),i==null?e.removeAttribute(t):typeof i!="string"&&Sc(e).includes(t)?e[t]=i:e.setAttribute(t,i))}function Pc(e){return e.__attributes??(e.__attributes={[Tc]:e.nodeName.includes("-"),[_c]:e.namespaceURI===pl})}var _o=new Map;function Sc(e){var t=e.getAttribute("is")||e.nodeName,i=_o.get(t);if(i)return i;_o.set(t,i=[]);for(var s,n=e,o=Element.prototype;o!==n;){s=or(n);for(var r in s)s[r].set&&i.push(r);n=Zn(n)}return i}function Es(e,t,i=t){var s=new WeakSet;Lr(e,"input",async n=>{var o=n?e.defaultValue:e.value;if(o=Rn(e)?En(o):o,i(o),he!==null&&s.add(he),await ac(),o!==(o=t())){var r=e.selectionStart,a=e.selectionEnd,l=e.value.length;if(e.value=o??"",a!==null){var c=e.value.length;r===a&&a===l&&c>l?(e.selectionStart=c,e.selectionEnd=c):(e.selectionStart=r,e.selectionEnd=Math.min(a,c))}}}),R(t)==null&&e.value&&(i(Rn(e)?En(e.value):e.value),he!==null&&s.add(he)),is(()=>{var n=t();if(e===document.activeElement){var o=Fs??he;if(s.has(o))return}Rn(e)&&n===En(e.value)||e.type==="date"&&!n&&!e.value||n!==e.value&&(e.value=n??"")})}function Lc(e,t,i=t){Lr(e,"change",s=>{var n=s?e.defaultChecked:e.checked;i(n)}),R(t)==null&&i(e.checked),is(()=>{var s=t();e.checked=!!s})}function Rn(e){var t=e.type;return t==="number"||t==="range"}function En(e){return e===""?null:+e}function Re(e,t,i){var s=vi(e,t);s&&s.set&&(e[t]=i,wn(()=>{e[t]=null}))}function Po(e,t){return e===t||(e==null?void 0:e[wi])===t}function Pe(e={},t,i,s){return Ql(()=>{var n,o;return is(()=>{n=o,o=[],R(()=>{e!==i(...o)&&(t(e,...o),n&&Po(i(...n),e)&&t(null,...n))})}),()=>{ts(()=>{o&&Po(i(...o),e)&&t(null,...o)})}}),e}function ue(e=!1){const t=me,i=t.l.u;if(!i)return;let s=()=>xe(t.s);if(e){let n=0,o={};const r=gn(()=>{let a=!1;const l=t.s;for(const c in l)l[c]!==o[c]&&(o[c]=l[c],a=!0);return a&&n++,n});s=()=>d(r)}i.b.length&&Kl(()=>{So(t,s),In(i.b)}),jn(()=>{const n=R(()=>i.m.map(wl));return()=>{for(const o of n)typeof o=="function"&&o()}}),i.a.length&&jn(()=>{So(t,s),In(i.a)})}function So(e,t){if(e.l.s)for(const i of e.l.s)d(i);t()}function Gr(e,t,i){if(e==null)return t(void 0),$i;const s=R(()=>e.subscribe(t,i));return s.unsubscribe?()=>s.unsubscribe():s}const Ii=[];function Nc(e,t=$i){let i=null;const s=new Set;function n(a){if(hr(e,a)&&(e=a,i)){const l=!Ii.length;for(const c of s)c[1](),Ii.push(c,e);if(l){for(let c=0;c<Ii.length;c+=2)Ii[c][0](Ii[c+1]);Ii.length=0}}}function o(a){n(a(e))}function r(a,l=$i){const c=[a,l];return s.add(c),s.size===1&&(i=t(n,o)||$i),a(e),()=>{s.delete(c),s.size===0&&i&&(i(),i=null)}}return{set:n,update:o,subscribe:r}}function Cc(e){let t;return Gr(e,i=>t=i)(),t}let Ms=!1,Un=Symbol();function Rc(e,t,i){const s=i[t]??(i[t]={store:null,source:V(void 0),unsubscribe:$i});if(s.store!==e&&!(Un in i))if(s.unsubscribe(),s.store=e??null,e==null)s.source.v=void 0,s.unsubscribe=$i;else{var n=!0;s.unsubscribe=Gr(e,o=>{n?s.source.v=o:W(s.source,o)}),n=!1}return e&&Un in i?Cc(e):d(s.source)}function Ec(){const e={};function t(){wn(()=>{for(var i in e)e[i].unsubscribe();nr(e,Un,{enumerable:!1,value:!0})})}return[e,t]}function Ac(e){var t=Ms;try{return Ms=!1,[e(),Ms]}finally{Ms=t}}function J(e,t,i,s){var D;var n=!Qi||(i&ll)!==0,o=(i&hl)!==0,r=(i&dl)!==0,a=s,l=!0,c=()=>(l&&(l=!1,a=r?R(s):s),a),h;if(o){var f=wi in e||xl in e;h=((D=vi(e,t))==null?void 0:D.set)??(f&&t in e?E=>e[t]=E:void 0)}var g,v=!1;o?[g,v]=Ac(()=>e[t]):g=e[t];var w;if(n?w=()=>{var E=e[t];return E===void 0?c():(l=!0,E)}:w=()=>{var E=e[t];return E!==void 0&&(a=void 0),E===void 0?a:E},n&&(i&cl)===0)return w;if(h){var x=e.$$legacy;return(function(E,_){return arguments.length>0?((!n||!_||x||v)&&h(_?w():E),E):w()})}var y=!1,L=((i&al)!==0?gn:to)(()=>(y=!1,w()));o&&d(L);var T=ne;return(function(E,_){if(arguments.length>0){const I=_?d(L):n&&o?Hi(E):E;return W(L,I),y=!0,a!==void 0&&(a=I),E}return Ci&&y||(T.f&ei)!==0?L.v:d(L)})}const pt=[];function Mc(e){return pt.length=0,pt.push({icon:"sell",text:"change name",state:"enabled",action:e.nameDialog}),pt.push({icon:"note_add",text:"new file",state:"enabled",action:t=>tx.send("name request",{label:"new file",value:"",regex:Path.regex.file,pos:{x:t.clientX,y:t.clientY},ok:i=>e.newFile(i),cancel:()=>{}})}),pt.push({icon:"create_new_folder",text:"new folder",state:"enabled",action:t=>tx.send("name request",{label:"new folder",value:"",regex:Path.regex.vizPath,pos:{x:t.clientX,y:t.clientY},ok:i=>e.newFolder(i),cancel:()=>{}})}),pt.push({icon:"folder_off",text:"remove folder",state:"enabled",action:t=>tx.send("message",{title:"Confirm removal",message:`Remove ${e.getPath()} from drawer ?`,pos:{x:t.clientX,y:t.clientY},ok:()=>e.remove(),cancel:()=>{}})}),pt.push({icon:"delete",text:"delete folder",state:"enabled",action:t=>tx.send("message",{title:"Confirm delete",message:`Delete ${e.getPath()} ?`,pos:{x:t.clientX,y:t.clientY},ok:()=>e.remove(),cancel:()=>{}})}),pt}function Dc(e){return pt.length=0,pt.push({icon:"sell",text:"change name",state:"enabled",action:t=>tx.send("name request",{label:"Name ",value:this.name,regex:/^[\w,-]+$/,pos:{x:t.clientX,y:t.clientY},ok:i=>this.rename(i),cancel:()=>{}})}),pt.push({icon:"delete",text:"delete file",state:"enabled",action:t=>tx.send("message",{title:"Confirm delete",message:`Delete ${this.getPath()} ?`,pos:{x:t.clientX,y:t.clientY},ok:()=>this.remove(),cancel:()=>{}})}),pt}var Ic=z('<i class="material-icons-outlined folder-icon svelte-cdx8zl"> </i> <span class="fldr-name svelte-cdx8zl" draggable="true"> </span> <!>',1),Oc=z('<li class="dir svelte-cdx8zl"><!></li>'),Fc=z('<li class="file svelte-cdx8zl"><i> </i> <span draggable="true"> </span></li>'),Wc=z('<div class="file-dir-list svelte-cdx8zl"><!> <!></div>');function Xs(e,t){le(t,!1);let i=J(t,"folder",12),s=J(t,"tx",8),n=V();pe(()=>{i().name!==""&&j(n,d(n).style.margin="0rem 0rem 0rem 1.2rem")});async function o(g){var x,y;let v=g.target.dataset.fldrindex??((y=(x=g.target.parentNode)==null?void 0:x.dataset)==null?void 0:y.fldrindex);if(!v)return;let w=i().folders[+v];w.is.expanded=!w.is.expanded,w.is.expanded&&w.is.stale&&(await w.update(),w.is.stale=!1),i(i())}function r(g){var x;const v=(x=g.target.parentNode.dataset)==null?void 0:x.fileindex;if(!v)return;const w=i().files[+v].arl;s().send("file selected",w)}function a(g){var y;g.preventDefault(),g.stopPropagation();const v=(y=g.target.parentNode.dataset)==null?void 0:y.fldrindex,w=i().folders[+v];if(!w)return;const x=Mc(w);s().send("folder context menu",{menu:x,event:g})}function l(g){var y;g.preventDefault(),g.stopPropagation();const v=(y=g.target.parentNode.dataset)==null?void 0:y.fileindex;if(!i().files[+v])return;const x=Dc();s().send("file context menu",{menu:x,event:g})}ue();var c=Wc(),h=A(c);mt(h,1,()=>(xe(i()),R(()=>i().folders)),gt,(g,v,w)=>{var x=Oc();ie(x,"data-fldrindex",w);var y=A(x);{var L=D=>{Xs(D,{get folder(){return d(v)},get tx(){return s()}})},T=D=>{var E=Ic(),_=de(E),I=A(_),q=B(_,2),ae=A(q),ve=B(q,2);{var Ee=we=>{Xs(we,{get folder(){return d(v)},get tx(){return s()}})};fe(ve,we=>{d(v),R(()=>d(v).is.expanded)&&we(Ee)})}oe(()=>{K(I,(d(v),R(()=>d(v).is.expanded?"folder_open":"folder"))),K(ae,(d(v),R(()=>d(v).name)))}),N("click",_,o),N("click",q,o),F(D,E)};fe(y,D=>{d(v),R(()=>d(v).parent===null)?D(L):D(T,!1)})}N("contextmenu",x,a),F(g,x)});var f=B(h,2);mt(f,1,()=>(xe(i()),R(()=>i().files)),gt,(g,v,w)=>{var x=Fc();ie(x,"data-fileindex",w);var y=A(x),L=A(y),T=B(y,2),D=A(T);oe((E,_,I)=>{bs(y,1,E,"svelte-cdx8zl"),K(L,_),bs(T,1,I,"svelte-cdx8zl"),K(D,(d(v),R(()=>d(v).name)))},[()=>(d(v),R(()=>"material-icons-outlined file-icon "+d(v).getFileClass())),()=>(d(v),R(()=>d(v).getIcon())),()=>(d(v),R(()=>"file-name "+d(v).getFileClass()))]),N("click",y,r),N("click",T,r),N("contextmenu",x,l),F(g,x)}),Pe(c,g=>W(n,g),()=>d(n)),F(e,c),ce()}var Hc=z('<p class="no-selection svelte-qhgjoh">Examples could not be mounted.</p>'),$c=z('<div class="menu-item svelte-qhgjoh"><i class="material-icons-outlined svelte-qhgjoh"> </i> <div class="tooltip svelte-qhgjoh"> </div></div>'),Bc=z('<div class="file-system svelte-qhgjoh"><!></div>'),jc=z('<div class="heading svelte-qhgjoh"><h1 class="svelte-qhgjoh">Local File System</h1> <div class="menu-item svelte-qhgjoh"><i class="material-icons-outlined svelte-qhgjoh">folder</i> <div class="tooltip svelte-qhgjoh">Open folder</div></div> <!></div> <!>',1),zc=z('<div class="workspace svelte-qhgjoh"><div class="heading svelte-qhgjoh"><h1 class="svelte-qhgjoh">Examples</h1> <div class="menu-item svelte-qhgjoh"><i class="material-icons-outlined svelte-qhgjoh"> </i> <div class="tooltip svelte-qhgjoh"> </div></div></div> <div class="file-system svelte-qhgjoh"><!></div> <!></div>');function Uc(e,t){le(t,!1);let i=J(t,"tx",8),s=V(),n=V(),o=V();const r=window.location.origin,a="/examples/file-system.json";let l=V(null),c=V(null);pe(async()=>{i().send("dom workspace div",d(s)),h(),v()});function h(){document.addEventListener("visibilitychange",U=>{U.preventDefault()})}const f={onDomAddModalDiv(U){d(s).append(U)},onFileSavedAs(U){},onFileActive(U){},onFileClosed(U){}};async function g(U){try{const P=new Dn("local"),Y=await window.showDirectoryPicker(),ee=Y.name,ye=new Os(ee,Y);P.root=new ps(ye,P),ye.setFileSystem(P.root,"/"),P.root.is.expanded=!0,await P.root.update(),W(c,P)}catch(P){console.error("Local file system selection cancelled or failed:",P),W(c,null)}}async function v(){W(l,new Dn("fixed"));const U=new Qt(a);U.url=new URL(a,r);const P=await U.get("json");if(!P)return;const Y=new Qt("");Y.url=new URL(r);const ee=Y.resolve("/"+P.name);j(l,d(l).root=new ps(ee,d(l))),w(P,d(l).root)}function w(U,P){if(U.folders)for(const Y of U.folders){const ee=P.arl.getPath()+"/"+Y.name,ye=P.arl.resolve(ee),O=new ps(ye,P);P.folders.push(O),w(Y,O)}if(U.files)for(const Y of U.files){const ee=P.arl.resolve(P.arl.getPath()+"/"+Y),ye=new Yn(ee,P);P.files.push(ye)}}function x(){d(l)&&(d(l).root.is.expanded?d(l).collapse():d(l).expand(),W(l,d(l)))}function y(){d(c)&&(d(c).root.is.expanded?d(c).collapse():d(c).expand(),W(l,d(l)))}var L={handlers:f};ue();var T=zc(),D=A(T),E=B(A(D),2),_=A(E),I=A(_),q=B(_,2),ae=A(q),ve=B(D,2),Ee=A(ve);{var we=U=>{Xs(U,{get folder(){return d(l),R(()=>d(l).root)},get tx(){return i()}})},ge=U=>{var P=Hc();F(U,P)};fe(Ee,U=>{d(l),R(()=>{var P;return(P=d(l))==null?void 0:P.root})?U(we):U(ge,!1)})}Pe(ve,U=>W(n,U),()=>d(n));var Ve=B(ve,2);{var We=U=>{var P=jc(),Y=de(P),ee=B(A(Y),2),ye=A(ee),O=B(ee,2);{var X=ct=>{var He=$c(),Ye=A(He),Wt=A(Ye),si=B(Ye,2),ni=A(si);oe(()=>{K(Wt,(d(c),R(()=>{var Tt;return(Tt=d(c).root)!=null&&Tt.is.expanded?"unfold_less":"unfold_more"}))),K(ni,(d(c),R(()=>{var Tt;return(Tt=d(c).root)!=null&&Tt.is.expanded?"collapse all":"expand all"})))}),N("click",Ye,y),F(ct,He)};fe(O,ct=>{d(c)&&ct(X)})}var te=B(Y,2);{var Ge=ct=>{var He=Bc(),Ye=A(He);Xs(Ye,{get folder(){return d(c),R(()=>d(c).root)},get tx(){return i()}}),Pe(He,Wt=>W(o,Wt),()=>d(o)),F(ct,He)};fe(te,ct=>{d(c)&&ct(Ge)})}N("click",ye,g),F(U,P)};fe(Ve,U=>{U(We)})}return Pe(T,U=>W(s,U),()=>d(s)),oe(()=>{K(I,(d(l),R(()=>{var U,P;return(P=(U=d(l))==null?void 0:U.root)!=null&&P.is.expanded?"unfold_less":"unfold_more"}))),K(ae,(d(l),R(()=>{var U,P;return(P=(U=d(l))==null?void 0:U.root)!=null&&P.is.expanded?"collapse all":"expand all"})))}),N("click",_,x),F(e,T),Re(t,"handlers",f),ce(L)}function Vc(e,t){const i=document.createElement("div");return Ur(Uc,{target:i,props:{tx:e,sx:t}}).handlers}var qc=z('<div class="main svelte-ai1hu1"><div class="tabs svelte-ai1hu1"></div> <div class="content svelte-ai1hu1"></div></div>');function Jc(e,t){le(t,!1);let i=J(t,"tx",8),s=V(),n=V(),o=V(),r=null;pe(async()=>{});const a={onContentDiv(g){d(n).replaceChildren(g),r&&d(n).append(r),i().send("div",d(s))},onMenuDiv(g){r=g,d(n).append(r)},onTabsDiv(g){d(o).replaceChildren(g)},onModalDiv(g){d(s).append(g)},onSizeChange({id:g,rect:v}){const w=Math.floor(d(n).clientWidth),x=Math.floor(d(n).clientHeight);i().send("content size change",{x:0,y:0,w,h:x})},onShow(){i().send("div",d(s))}};var l={handlers:a};ue();var c=qc(),h=A(c);Pe(h,g=>W(o,g),()=>d(o));var f=B(h,2);return Pe(f,g=>W(n,g),()=>d(n)),Pe(c,g=>W(s,g),()=>d(s)),F(e,c),Re(t,"handlers",a),ce(l)}var Xc=z('<div class="column-main-layout svelte-1496us"><div class="left-column svelte-1496us"></div> <div class="separator svelte-1496us"></div> <div class="main-area svelte-1496us"></div></div>');function Gc(e,t){le(t,!1);let i=J(t,"tx",8),s=V(),n=V(),o=V(),r=V(),a=V(0),l=!1,c=null,h;const f=.12,g=160,v=320,w=1024,x=typeof window<"u",y=P=>x&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(P):setTimeout(()=>P(Date.now()),16),L=P=>{if(P!==null){if(x&&typeof window.cancelAnimationFrame=="function"){window.cancelAnimationFrame(P);return}clearTimeout(P)}},T=()=>{c===null&&(c=y(()=>{c=null,ve()}))},D=P=>{var Ge;const Y=x?window.innerWidth:w,ee=((Ge=d(s))==null?void 0:Ge.clientWidth)??Y??P;if(!ee)return P;const ye=Math.max(ee-v,80),O=Math.min(g,ye),X=Math.max(ee-v,O),te=Math.min(Math.max(P,O),X);return Number.isFinite(te)?te:O},E=()=>{var P;l&&(l=!1,x&&(window.removeEventListener("pointermove",_),window.removeEventListener("pointerup",I)),(P=d(r))==null||P.classList.remove("dragging"),ve())},_=P=>{if(!l||!d(s))return;const{left:Y}=d(s).getBoundingClientRect(),ee=D(P.clientX-Y);ee!==d(a)&&(W(a,ee),T())},I=()=>E(),q=P=>{var Y;P.preventDefault(),l=!0,(Y=d(r))==null||Y.classList.add("dragging"),x&&(window.addEventListener("pointermove",_),window.addEventListener("pointerup",I))},ae=()=>{W(a,D(d(a))),T()},ve=()=>{if(!d(o)||!i())return;const P=d(o).getBoundingClientRect(),Y={rect:{x:0,y:0,w:Math.floor(P.width),h:Math.floor(P.height)}};i().send("size change",Y)};pe(()=>{var ee;const P=x?window.innerWidth:w,Y=((ee=d(s))==null?void 0:ee.clientWidth)??P??0;return W(a,D(Y*f||g)),x&&window.addEventListener("resize",ae),typeof ResizeObserver<"u"&&(h=new ResizeObserver(()=>T()),d(o)&&h.observe(d(o))),T(),()=>{x&&window.removeEventListener("resize",ae),E(),h==null||h.disconnect(),c!==null&&(L(c),c=null)}});const Ee={onLeftColumn(P){var Y;(Y=d(n))==null||Y.replaceChildren(P)},onMainArea(P){d(o)&&(d(o).replaceChildren(P),P.width=Math.floor(d(o).clientWidth),P.height=Math.floor(d(o).clientHeight),ve())}};var we={handlers:Ee};ue();var ge=Xc(),Ve=A(ge);Pe(Ve,P=>W(n,P),()=>d(n));var We=B(Ve,2);Pe(We,P=>W(r,P),()=>d(r));var U=B(We,2);return Pe(U,P=>W(o,P),()=>d(o)),Pe(ge,P=>W(s,P),()=>d(s)),oe(()=>wt(Ve,`width:${d(a)}px;flex-basis:${d(a)}px;`)),N("pointerdown",We,q),F(e,ge),Re(t,"handlers",Ee),ce(we)}var Yc=z('<div class="tab selected svelte-18p7ldm"> <input class="button svelte-18p7ldm" type="button"/> <div class="full-name svelte-18p7ldm"> </div></div>'),Kc=z('<div class="tab svelte-18p7ldm"> <input class="button svelte-18p7ldm" type="button"/> <div class="full-name svelte-18p7ldm"> </div></div>'),Zc=z('<div class="tab-ribbon svelte-18p7ldm"></div>');function Qc(e,t){le(t,!1);let i=J(t,"tx",8);pe(()=>{i().send("div",d(s).div)});let s=V({div:null,selected:-1,tabs:[]});const n={onTabNew(h){j(s,d(s).selected=d(s).tabs.push(h)-1),W(s,d(s))},onTabRemove(h){const f=d(s).tabs,g=f.length;for(let v=0;v<g;v++)if(f[v]==h){if(g>1)for(let w=v;w<g-1;w++)f[w]=f[w+1];f.pop();break}W(s,d(s))},onTabRename({oldName:h,newName:f}){const g=d(s).tabs,v=g.findIndex(w=>w==h);v>=0&&(g[v]=f),W(s,d(s))},onTabSelect(h){const g=d(s).tabs.findIndex(v=>v==h);g>=0&&j(s,d(s).selected=g),W(s,d(s))}};function o(h){const f=h.target.getAttribute("data-index");f<0||f>=d(s).tabs.length||i().send("tab request to select",d(s).tabs[f])}function r(h){h.stopPropagation();const f=h.target.parentNode.getAttribute("data-index");f<0||f>=d(s).tabs.length||i().send("tab request to close",d(s).tabs[f])}function a(h){}var l={handlers:n};ue();var c=Zc();return mt(c,5,()=>(d(s),R(()=>d(s).tabs)),gt,(h,f,g)=>{var v=Qe(),w=de(v);{var x=L=>{var T=Yc();ie(T,"data-index",g);var D=A(T),E=B(D),_=B(E,2),I=A(_);oe(()=>{K(D,`${d(f)??""} `),wt(_,`width: ${d(f),R(()=>d(f).length*.5)??""}rem;`),K(I,d(f))}),N("click",E,r),N("keydown",E,a),N("click",T,o),N("keydown",T,a),F(L,T)},y=L=>{var T=Kc();ie(T,"data-index",g);var D=A(T),E=B(D),_=B(E,2),I=A(_);oe(()=>{K(D,`${d(f)??""} `),wt(_,`width: ${d(f),R(()=>d(f).length*.5)??""}rem;`),K(I,d(f))}),N("click",E,r),N("keydown",E,a),N("click",T,o),N("keydown",T,a),F(L,T)};fe(w,L=>{d(s),R(()=>g==d(s).selected)?L(x):L(y,!1)})}F(h,v)}),Pe(c,h=>j(s,d(s).div=h),()=>{var h;return(h=d(s))==null?void 0:h.div}),F(e,c),Re(t,"handlers",n),ce(l)}var eh=z('<div class="menu-item svelte-sk4hi"><i class="material-icons-outlined icon svelte-sk4hi"> </i> <div class="tooltip svelte-sk4hi"> </div></div>'),th=z('<div class="menu svelte-sk4hi"></div>');function ih(e,t){le(t,!1);let i=J(t,"tx",8),s=J(t,"sx",8),n=V(),o=V(s());pe(()=>{i().send("div",d(n))});const r={"-> set menu"(f){W(o,f)}};function a(f){var v;const g=f.target.getAttribute("data-index");((v=d(o)[g].message)==null?void 0:v.length)>0&&i().send(d(o)[g].message,f)}function l(f){}var c={handlers:r};ue();var h=th();return mt(h,5,()=>d(o),gt,(f,g,v)=>{var w=eh(),x=A(w);ie(x,"data-index",v);var y=A(x),L=B(x,2),T=A(L);oe(()=>{wt(x,`color: ${d(g),R(()=>d(g).color)??""};`),K(y,(d(g),R(()=>d(g).icon))),wt(L,`width: ${d(g),R(()=>d(g).help.length*.5)??""}rem;`),K(T,(d(g),R(()=>d(g).help)))}),N("click",x,a),N("keydown",x,l),F(f,w)}),Pe(h,f=>W(n,f),()=>d(n)),F(e,h),Re(t,"handlers",r),ce(c)}function sh(){return localStorage.getItem("vmblu-theme")||"dark"}const Yr=Nc(sh());Yr.subscribe(e=>{localStorage.setItem("vmblu-theme",e)});var nh=z('<i class="material-icons-outlined open svelte-6k9ztc">description</i>'),oh=z('<i class="material-icons-outlined open svelte-6k9ztc">add_circle</i>'),rh=z('<div class="right-icons svelte-6k9ztc"><i class="material-icons-outlined trash svelte-6k9ztc">delete</i></div>'),ah=z('<div><div class="hdr svelte-6k9ztc"><div class="left-icons svelte-6k9ztc"><i class="material-icons-outlined cancel svelte-6k9ztc">cancel</i> <i class="material-icons-outlined check svelte-6k9ztc">check_circle</i> <!> <!></div> <h1 class="svelte-6k9ztc"> </h1> <!></div> <!></div>');function kt(e,t){le(t,!1);const i=()=>Rc(Yr,"$theme",s),[s,n]=Ec();let o=J(t,"box",12),r,a,l,c,h=!1;pe(()=>{o(o().show=w,!0),o(o().hide=x,!0),o(o().update=()=>o(o()),!0)});function f(O){r=O.clientX,a=O.clientY,l=o().div.offsetLeft,c=o().div.offsetTop,h=!0,document.addEventListener("mousemove",g),document.addEventListener("mouseup",v)}function g(O){if(h){const X=O.clientX-r,te=O.clientY-a;o(o().div.style.left=`${l+X}px`,!0),o(o().div.style.top=`${c+te}px`,!0)}}function v(O){h=!1,document.removeEventListener("mousemove",g),document.removeEventListener("mouseup",v)}function w(O){O||(O=o().pos),O&&(o(o().div.style.left=`${O.x}px`,!0),o(o().div.style.top=`${O.y}px`,!0)),o(o().div.style.display="block",!0),o(o())}function x(){o(o().div.style.display="none",!0)}function y(O){var X,te;x(),(te=(X=o()).cancel)==null||te.call(X,O)}function L(O){var X,te;x(),(te=(X=o()).ok)==null||te.call(X,O)}function T(O){var X,te;(te=(X=o()).open)==null||te.call(X,O)}function D(O){var X,te;(te=(X=o()).add)==null||te.call(X,O)}function E(O){var X,te;x(),(te=(X=o()).trash)==null||te.call(X,O)}function _(O){return O.stopPropagation(),O.key=="Enter"?L(O):O.key=="Escape"||O.key=="Esc"?y(O):null}ue();var I=ah(),q=A(I),ae=A(q),ve=A(ae),Ee=B(ve,2),we=B(Ee,2);{var ge=O=>{var X=nh();N("click",X,T),N("keydown",X,_),F(O,X)};fe(we,O=>{xe(o()),R(()=>o().open)&&O(ge)})}var Ve=B(we,2);{var We=O=>{var X=oh();N("click",X,D),N("keydown",X,_),F(O,X)};fe(Ve,O=>{xe(o()),R(()=>o().add)&&O(We)})}var U=B(ae,2),P=A(U),Y=B(U,2);{var ee=O=>{var X=rh(),te=A(X);N("click",te,E),N("keydown",te,_),F(O,X)};fe(Y,O=>{xe(o()),R(()=>o().trash)&&O(ee)})}var ye=B(q,2);Jr(ye,t,"default",{}),Pe(I,O=>o(o().div=O,!0),()=>{var O;return(O=o())==null?void 0:O.div}),oe(()=>{bs(I,1,`main ${i()??""}`,"svelte-6k9ztc"),K(P,(xe(o()),R(()=>o().title)))}),N("click",ve,y),N("keydown",ve,_),N("click",Ee,L),N("keydown",Ee,_),N("mousedown",q,f),N("keydown",I,_),F(e,I),ce(),n()}var lh=z('<div class="same-line svelte-1s2wqkj"><!></div>');function Lo(e,t){var i=lh(),s=A(i);Jr(s,t,"default",{}),F(e,i)}var ch=z('<label class="label svelte-1hdmeto"> </label>');function No(e,t){let i=J(t,"text",8),s=J(t,"style",8);var n=ch(),o=A(n);oe(()=>{wt(n,s()?s():""),K(o,i())}),F(e,n)}var hh=z('<input class="grow svelte-1p6z9d0" type="text" spellcheck="false"/>');function Kr(e,t){le(t,!1);let i=J(t,"text",12),s=J(t,"check",8),n=J(t,"style",8),o=V(),r=null;const a="#ff0000";pe(()=>{r=d(o).style.color});function l(h){j(o,d(o).style.width="0px"),j(o,d(o).style.width=d(o).scrollWidth>100?d(o).scrollWidth+2+"px":"100px"),s()&&j(o,d(o).style.color=s()(d(o).value)?r:a)}ue();var c=hh();Pe(c,h=>W(o,h),()=>d(o)),oe(()=>wt(c,n()?n():"")),Es(c,i),N("input",c,l),F(e,c),ce()}var dh=z('<input type="checkbox" class="svelte-ywsl3b"/>');function Co(e,t){le(t,!1);let i=J(t,"style",8),s=J(t,"on",12),n=J(t,"onToggle",8);pe(()=>{});function o(a){var l;(l=n())==null||l(s())}ue();var r=dh();oe(()=>wt(r,i()?i():"")),Lc(r,s),N("input",r,o),F(e,r),ce()}var uh=z("<!> <!>",1),fh=z("<!> <!> <!>",1),ph=z("<!> <!>",1);function gh(e,t){le(t,!1);let i=J(t,"tx",8);pe(()=>{i().send("modal div",d(s).div)});const s=V({div:null,pos:null,title:"",ok:null,cancel:null}),n=V({logMessages:!1,worker:{on:!1,path:""}}),o={"-> show"({title:l,pos:c,rx:h,ok:f,cancel:g}){j(s,d(s).title=l),j(s,d(s).pos={...c}),j(s,d(s).ok=v=>{f&&f(d(n))}),j(s,d(s).cancel=()=>{g==null||g()}),h&&(j(n,d(n).logMessages=h.logMessages),j(n,d(n).worker.on=h.worker.on),j(n,d(n).worker.path=h.worker.path)),d(s).show(d(s).pos)}};function r(l){}var a={handlers:o};return ue(),kt(e,{get box(){return d(s)},children:(l,c)=>{var h=ph(),f=de(h);Lo(f,{children:(v,w)=>{var x=uh(),y=de(x);Co(y,{get on(){return d(n),R(()=>d(n).logMessages)},onToggle:r});var L=B(y,2);No(L,{text:"log messages"}),F(v,x)},$$slots:{default:!0}});var g=B(f,2);Lo(g,{children:(v,w)=>{var x=fh(),y=de(x);Co(y,{get field(){return d(n),R(()=>d(n).worker.on)}});var L=B(y,2);No(L,{text:"use worker script:",style:"margin-right: 0.5rem;"});var T=B(L,2);Kr(T,{get field(){return d(n),R(()=>d(n).worker.path)}}),F(v,x)},$$slots:{default:!0}}),F(l,h)},$$slots:{default:!0}}),Re(t,"handlers",o),ce(a)}function mh(e,t){le(t,!1);let i=J(t,"tx",8);pe(async()=>{i().send("modal div",d(s).div)});const s=V({div:null,pos:null,title:"",ok:null,cancel:null}),n={"-> show"({title:r,message:a,pos:l,ok:c,cancel:h}){j(s,d(s).title=r),j(s,d(s).ok=c),j(s,d(s).cancel=h),d(s).show(l)}};var o={handlers:n};return ue(),kt(e,{get box(){return d(s)}}),Re(t,"handlers",n),ce(o)}var vh=z('<li><i> </i> <span class="choice-text svelte-cldbb7"> </span> <span class="choice-char svelte-cldbb7"> </span></li>'),wh=z('<div class="svelte-cldbb7"><ul class="svelte-cldbb7"></ul></div>');function xh(e,t){le(t,!1);let i=J(t,"tx",8),s=V({div:null,menu:[],show:()=>{}});pe(()=>{j(s,d(s).show=o),i().send("modal div",d(s).div)});const n={"-> context menu"({menu:w,event:x}){j(s,d(s).menu=w),d(s).show(x)}};function o(w){d(s).menu.length<=0||(r(),j(s,d(s).div.style.display="block"),j(s,d(s).div.style.left=`${w.clientX-10}px`),j(s,d(s).div.style.top=`${w.clientY-20}px`),W(s,d(s)))}function r(){let w=0;d(s).menu.forEach(x=>{const y=x.text.length+(x.char?x.char.length+5:0);y>w&&(w=y)}),d(s).div.querySelector("ul").style.width=(.5*w+1.5).toString()+"rem"}function a(w){j(s,d(s).div.style.display="none")}function l(w){w.preventDefault(),j(s,d(s).div.style.display="none")}function c(w){j(s,d(s).div.style.display="none");let x=w.target.dataset.index??w.target.parentNode.dataset.index;d(s).menu[x]&&d(s).menu[x].state=="enabled"&&d(s).menu[x].action(w)}function h(w){}var f={handlers:n};ue();var g=wh(),v=A(g);return mt(v,5,()=>(d(s),R(()=>d(s).menu)),gt,(w,x,y)=>{var L=vh();ie(L,"data-index",y);var T=A(L),D=A(T),E=B(T,2),_=A(E),I=B(E,2),q=A(I);oe(()=>{bs(L,1,yc((d(x),R(()=>d(x).state))),"svelte-cldbb7"),bs(T,1,`material-icons-outlined choice-icon ${d(x),R(()=>d(x).state)??""}`,"svelte-cldbb7"),K(D,(d(x),R(()=>d(x).icon))),K(_,(d(x),R(()=>d(x).text))),K(q,(d(x),R(()=>d(x).char??" ")))}),N("click",L,c),N("keydown",L,h),F(w,L)}),Pe(g,w=>j(s,d(s).div=w),()=>{var w;return(w=d(s))==null?void 0:w.div}),N("mouseleave",v,a),N("click",g,a),N("contextmenu",g,l),N("keydown",g,h),F(e,g),Re(t,"handlers",n),ce(f)}var yh=z('<textarea name="txt-name" spellcheck="false" class="svelte-4j1bxw"></textarea>');function Zr(e,t){le(t,!1);let i=J(t,"text",12),s=J(t,"cols",8),n=J(t,"rows",8);pe(()=>{});function o(a){a.key!="Escape"&&a.key!="Esc"&&a.stopPropagation()}ue();var r=yh();oe(()=>{ie(r,"rows",n()),ie(r,"cols",s())}),Es(r,i),N("keydown",r,o),F(e,r),ce()}function bh(e,t){le(t,!1);let i=J(t,"tx",8);pe(async()=>{i().send("modal div",d(s).div)});let s=V({div:null,pos:null,title:"",ok:null,cancel:null}),n=V("");const o={"-> json"({title:l,pos:c,json:h,ok:f}){j(s,d(s).title=l),j(s,d(s).pos={...c}),j(s,d(s).ok=()=>{const g=r();if((g==null?void 0:g.length)==0)return f?f(""):null;g?f==null||f(g):d(s).show(c)}),W(n,h?JSON.stringify(h,null,"  "):""),d(s).show(c)}};function r(){let l=d(n).indexOf("SyntaxError");if(l!=-1&&W(n,l>1?d(n).slice(0,l-2):""),d(n).length==0)return"";try{return JSON.parse(d(n))}catch(c){return W(n,d(n)+`

`+c),null}}var a={handlers:o};return ue(),kt(e,{get box(){return d(s)},children:(l,c)=>{Zr(l,{cols:"50",rows:"25",get text(){return d(n)},set text(h){W(n,h)},$$legacy:!0})},$$slots:{default:!0}}),Re(t,"handlers",o),ce(a)}function kh(e,t){le(t,!1);let i=J(t,"tx",8),s=V({div:null,pos:null,title:"",ok:null,cancel:null});pe(()=>{i().send("modal div",d(s).div)});let n=V("");const o={"-> text"({header:a,pos:l,text:c,ok:h=null,cancel:f=null}){j(s,d(s).title=a),j(s,d(s).ok=()=>{h==null||h(d(n))}),W(n,c),d(s).show(l)}};var r={handlers:o};return ue(),kt(e,{get box(){return d(s)},children:(a,l)=>{Zr(a,{cols:"50",rows:"25",get text(){return d(n)},set text(c){W(n,c)},$$legacy:!0})},$$slots:{default:!0}}),Re(t,"handlers",o),ce(r)}var Th=z('<p class="svelte-90r4b4"> </p>'),_h=z('<div class="handler svelte-90r4b4"><p class="svelte-90r4b4"><span class="clickable svelte-90r4b4"> </span> </p></div> <div class="params svelte-90r4b4"></div> <div class="prompt svelte-90r4b4"><pre class="svelte-90r4b4"> </pre></div>',1),Ph=z('<div class="profile svelte-90r4b4"><!></div>');function Ro(e,t){le(t,!1);let i=J(t,"profile",8),s=J(t,"open",8);function n(l){l.key!="Escape"&&l.key!="Esc"&&l.stopPropagation()}ue();var o=Ph(),r=A(o);{var a=l=>{var c=_h(),h=de(c),f=A(h),g=A(f),v=A(g),w=B(g),x=B(h,2);mt(x,5,()=>(xe(i()),R(()=>i().params)),gt,(D,E)=>{let _=()=>d(E).type,I=()=>d(E).name,q=()=>d(E).description;var ae=Th(),ve=A(ae);oe(()=>K(ve,`${I()??""} (${_()??""}) ${q()??""}`)),F(D,ae)});var y=B(x,2),L=A(y),T=A(L);oe(()=>{K(v,(xe(i()),R(()=>i().handler))),K(w,`  in ${xe(i()),R(()=>i().file)??""} (${xe(i()),R(()=>i().line)??""})`),K(T,(xe(i()),R(()=>i().summary)))}),N("click",g,()=>{var D;return(D=s())==null?void 0:D({file:i().file,line:i().line})}),N("keydown",g,n),F(l,c)};fe(r,l=>{i()!=null&&l(a)})}F(e,o),ce()}var Sh=z('<div class="transmit svelte-19tsd"><p class="svelte-19tsd"><span class="clickable svelte-19tsd"> </span> </p></div>'),Lh=z('<div class="profile svelte-19tsd"><!></div>');function Eo(e,t){le(t,!1);let i=J(t,"profile",8),s=J(t,"open",8);function n(l){l.key!="Escape"&&l.key!="Esc"&&l.stopPropagation()}ue();var o=Lh(),r=A(o);{var a=l=>{var c=Sh(),h=A(c),f=A(h),g=A(f),v=B(f);oe(()=>{K(g,(xe(i()),R(()=>i().pin))),K(v,` ${xe(i()),R(()=>i().file)??""} (${xe(i()),R(()=>i().line)??""})`)}),N("click",f,()=>{var w;return(w=s())==null?void 0:w({file:i().file,line:i().line})}),N("keydown",f,n),F(l,c)};fe(r,l=>{i()!=null&&l(a)})}F(e,o),ce()}var Nh=z('<div class="pin svelte-1q31bqr"><p class="svelte-1q31bqr">Handlers and parameters</p></div> <!>',1),Ch=z('<div class="pin svelte-1q31bqr"><p class="svelte-1q31bqr">Handler and parameters:</p></div> <!>',1),Rh=z('<div class="pin svelte-1q31bqr"><p class="svelte-1q31bqr">Send locactions</p></div> <!>',1);function Eh(e,t){le(t,!1);let i=J(t,"tx",8),s=V({div:null,pos:null,title:"",ok:null,cancel:null});pe(()=>{i().send("modal div",d(s).div)});let n=V(null),o=V(null),r=V(null);const a={"-> show"({pos:c,pin:h,profile:f,open:g=null}){j(s,d(s).title=h.is.left?(h.is.input?"  ":"  ")+h.name:h.name+(h.is.input?"  ":"  ")),W(o,h),W(n,f),W(r,g),d(s).show(c)}};var l={handlers:a};return ue(),kt(e,{get box(){return d(s)},children:(c,h)=>{var f=Qe(),g=de(f);{var v=x=>{var y=Qe(),L=de(y);{var T=E=>{var _=Nh(),I=B(de(_),2);mt(I,1,()=>d(n),gt,(q,ae)=>{Ro(q,{get profile(){return d(ae)},get open(){return d(r)}})}),F(E,_)},D=E=>{var _=Ch(),I=B(de(_),2);Ro(I,{get profile(){return d(n)},get open(){return d(r)}}),F(E,_)};fe(L,E=>{d(n),R(()=>Array.isArray(d(n)))?E(T):E(D,!1)})}F(x,y)},w=x=>{var y=Rh(),L=B(de(y),2);{var T=E=>{var _=Qe(),I=de(_);mt(I,1,()=>d(n),gt,(q,ae)=>{Eo(q,{get profile(){return d(ae)},get open(){return d(r)}})}),F(E,_)},D=E=>{Eo(E,{get profile(){return d(n)},get open(){return d(r)}})};fe(L,E=>{d(n),R(()=>Array.isArray(d(n)))?E(T):E(D,!1)})}F(x,y)};fe(g,x=>{d(o),R(()=>{var y;return(y=d(o))==null?void 0:y.is.input})?x(v):x(w,!1)})}F(c,f)},$$slots:{default:!0}}),Re(t,"handlers",a),ce(l)}var Ah=z('<p class="svelte-sxqikf"> </p>');function Mh(e,t){le(t,!1);let i=J(t,"tx",8),s={div:null,pos:null,title:"",ok:null,cancel:null},n=V("");pe(async()=>{i().send("modal div",s.div)});const o={"-> show"({title:a,message:l,pos:c,ok:h,cancel:f}){const g=this.popup.box;g.title=a,W(n,l),g.show(c)}};var r={handlers:o};return ue(),kt(e,{get box(){return s},children:(a,l)=>{var c=Ah(),h=A(c);oe(()=>K(h,d(n))),F(a,c)},$$slots:{default:!0}}),Re(t,"handlers",o),ce(r)}var Dh=z('<div class="input-field svelte-1c2zphc"><label class="svelte-1c2zphc"> </label> <input type="text" spellcheck="false" class="svelte-1c2zphc"/></div>');function Gs(e,t){le(t,!1);let i=J(t,"label",8),s=J(t,"input",12),n=J(t,"style",8),o=J(t,"check",8),r=V(),a="f"+Math.floor((1+Math.random())*65536).toString(16).substring(1);const l=()=>{j(r,d(r).style.width="0px"),j(r,d(r).style.width=d(r).scrollWidth+2+"px")};let c=null;const h="#ff0000";pe(()=>{c=d(r).style.color,l()});function f(y){l(),o()&&j(r,d(r).style.color=o()(y.target.value)?c:h)}ec(()=>d(r),()=>{d(r)&&l()}),tc(),ue();var g=Dh(),v=A(g),w=A(v),x=B(v,2);Pe(x,y=>W(r,y),()=>d(r)),oe(()=>{ie(v,"for",a),wt(v,n()),K(w,i()),ie(x,"id",a)}),Es(x,s),N("input",x,f),N("click",x,f),F(e,g),ce()}var Ih=z("<!> <!>",1);function Oh(e,t){le(t,!1);let i=J(t,"tx",8),s=V({div:null,pos:null,title:"",ok:null,cancel:null}),n=V(""),o=V(""),r="";function a(h){var f;return r?(f=r.test)==null?void 0:f.call(r,h):!0}pe(()=>{i().send("modal div",d(s).div)});const l={onNameAndPath({title:h,pos:f,name:g,path:v,regex:w,ok:x,cancel:y,open:L,trash:T}){j(s,d(s).title=h),j(s,d(s).pos={...f}),j(s,d(s).ok=()=>{x==null||x(d(n),d(o))}),j(s,d(s).cancel=y?()=>y():null),j(s,d(s).open=D=>{L==null||L(d(n),d(o)),d(s).hide()}),j(s,d(s).trash=T?()=>T():null),W(n,g),W(o,v),r=w,d(s).show(f)}};var c={handlers:l};return ue(),kt(e,{get box(){return d(s)},children:(h,f)=>{var g=Ih(),v=de(g);Gs(v,{label:"Name",style:"width: 3rem;",check:null,get input(){return d(n)},set input(x){W(n,x)},$$legacy:!0});var w=B(v,2);Gs(w,{label:"Path",style:"width: 3rem;",check:a,get input(){return d(o)},set input(x){W(o,x)},$$legacy:!0}),F(h,g)},$$slots:{default:!0}}),Re(t,"handlers",l),ce(c)}function Fh(e,t){le(t,!1);let i=J(t,"tx",8),s=V({div:null,pos:null,title:"",ok:null,cancel:null}),n=V();function o(l){return!0}pe(()=>{i().send("modal div",d(s).div)});const r={"-> path"({title:l,path:c,pos:h,ok:f,cancel:g}){j(s,d(s).title=l),j(s,d(s).pos={...h}),j(s,d(s).ok=f?()=>f(d(n)):null),j(s,d(s).cancel=g?()=>g():null),W(n,c),d(s).show()}};var a={handlers:r};return ue(),kt(e,{get box(){return d(s)},children:(l,c)=>{Gs(l,{label:"Path :",style:"width: 2rem;",check:o,get input(){return d(n)},set input(h){W(n,h)},$$legacy:!0})},$$slots:{default:!0}}),Re(t,"handlers",r),ce(a)}function Wh(e,t){le(t,!1);let i=J(t,"tx",8),s=V({div:null,pos:null,title:"",ok:null,cancel:null}),n=V("");pe(()=>{i().send("modal div",d(s).div)});const o={"-> show"({label:a,value:l,pos:c,ok:h,cancel:f}){j(s,d(s).title=a),j(s,d(s).pos={...c}),j(s,d(s).ok=h?()=>h(d(n)):null),j(s,d(s).cancel=f?()=>f():null),W(n,l),d(s).show(d(s).pos)}};var r={handlers:o};return ue(),kt(e,{get box(){return d(s)},children:(a,l)=>{Kr(a,{style:null,check:null,get text(){return d(n)},set text(c){W(n,c)},$$legacy:!0})},$$slots:{default:!0}}),Re(t,"handlers",o),ce(r)}var Hh=z('<div class="input-field svelte-91i3te"><label class="svelte-91i3te"> </label> <input type="text" spellcheck="false" readonly="" class="svelte-91i3te"/></div>');function Ds(e,t){le(t,!1);let i=J(t,"label",8),s=J(t,"info",12),n=J(t,"style",8),o="f"+Math.floor((1+Math.random())*65536).toString(16).substring(1);pe(()=>{}),ue();var r=Hh(),a=A(r),l=A(a),c=B(a,2);oe(()=>{ie(a,"for",o),wt(a,n()),K(l,i()),ie(c,"id",o)}),Es(c,s),F(e,r),ce()}var $h=z('<div class="color-field svelte-1uxeram"><label class="svelte-1uxeram"> </label> <input type="color" class="svelte-1uxeram"/></div>');function Bh(e,t){le(t,!1);let i=J(t,"label",8),s=J(t,"style",8),n=J(t,"color",12),o=J(t,"onColor",8),r=V(),a="f"+Math.floor((1+Math.random())*65536).toString(16).substring(1);pe(()=>{});function l(v){var w;(w=o())==null||w(n())}ue();var c=$h(),h=A(c),f=A(h),g=B(h,2);Pe(g,v=>W(r,v),()=>d(r)),oe(()=>{ie(h,"for",a),wt(h,s()),K(f,i()),ie(g,"id",a)}),Es(g,n),N("input",g,l),F(e,c),ce()}var jh=z("<!> <!> <!> <!> <!> <!>",1);function zh(e,t){le(t,!1);let i=J(t,"tx",8),s=V({div:null,pos:null,title:"",ok:null,cancel:null}),n=V(),o=V(),r=V(),a=V(),l=V(),c=V(),h=V();pe(()=>{i().send("modal div",d(s).div)});const f={"-> show"({title:v,path:w,settings:x,pos:y,ok:L,cancel:T,onColor:D}){j(s,d(s).title=v),j(s,d(s).pos={...y}),j(s,d(s).ok=L?()=>L(d(c)):null),j(s,d(s).cancel=T?()=>T():null),W(n,w),W(r,x.version),W(o,x.created),W(a,x.saved),W(c,x.runtime),W(l,x.style.rgb),W(h,D),d(s).show(y)}};var g={handlers:f};return ue(),kt(e,{get box(){return d(s)},children:(v,w)=>{var x=jh(),y=de(x);Ds(y,{label:"File:",style:"width: 6rem;",get info(){return d(n)}});var L=B(y,2);Ds(L,{label:"Vmblu Version:",style:"width: 6rem;",get info(){return d(r)}});var T=B(L,2);Ds(T,{label:"Creation Date:",style:"width: 6rem;",get info(){return d(o)}});var D=B(T,2);Ds(D,{label:"Last Saved:",style:"width: 6rem;",get info(){return d(a)}});var E=B(D,2);Gs(E,{label:"Runtime",style:"width: 6rem;",check:null,get input(){return d(c)},set input(I){W(c,I)},$$legacy:!0});var _=B(E,2);Bh(_,{label:"Node Color:",style:"width: 6rem;",get color(){return d(l)},get onColor(){return d(h)}}),F(v,x)},$$slots:{default:!0}}),Re(t,"handlers",f),ce(g)}const Oi=20;function ai(e){return e}function Qr(e){this.tx=e,this.cols=[],this.xyLocal={x:0,y:0}}Qr.prototype={init(e){this.cols=[];let t=0,i=Oi;for(const s of e.values()){if(!s.is.selectable||!s.raw)return;const n=s.raw.root.nodes?s.raw.root.nodes.length:1;n>i&&i<Oi&&(t++,i=Oi),i-=n}for(t++;t-- >0;)this.cols.push([])},fill(e){const t=this.cols;let i=0,s=Oi;for(const n of e.values()){if(!n.is.selectable||!n.raw)return;const o=n.raw.root.nodes?n.raw.root.nodes.length:1;if(o>s&&s<Oi&&(i++,s=Oi),s-=o,t[i].push({nextModel:!0,model:n,expanded:!0}),n.raw.root.nodes)for(const r of n.raw.root.nodes)t[i].push({model:n,node:r,expanded:!1});else t[i].push({model:n,node:n.raw.root,expanded:!1})}},onRemoveLib(e){var n,o,r;const t=(n=e.target.parentNode.dataset)==null?void 0:n.col,i=(o=e.target.parentNode.dataset)==null?void 0:o.node,s=(r=this.cols[t])==null?void 0:r[i];s!=null&&s.nextModel&&this.tx.send("remove file",{model:s.model})},addLib(e){const t={x:e.screenX,y:e.screenY};this.tx.send("get path",{title:"add file to node library",path:null,pos:t,ok:i=>{this.tx.send("add file",i)},cancel:null})},onSelect(e,t){var h,f,g;t.hide();const i=(h=e.target.parentNode.dataset)==null?void 0:h.col,s=(f=e.target.parentNode.dataset)==null?void 0:f.node,n=(g=e.target.parentNode.dataset)==null?void 0:g.sub,o=this.cols[i][s].model;let r="",a=this.cols[i][s].node;if(n&&(r=a.group,a=a.nodes.find((v,w)=>w==n)),!a)return;const l=a.source??a.group??a.dock,c=r.length==0?l:r+"|"+l;this.tx.send("selected node",{model:o,nodePath:c,xyLocal:this.xyLocal})},onArrowClick(e){var s,n;const t=(s=e.target.parentNode.dataset)==null?void 0:s.col,i=(n=e.target.parentNode.dataset)==null?void 0:n.node;this.cols[t][i].expanded=!this.cols[t][i].expanded}};var Uh=z('<i class="material-icons-outlined lib lib-js svelte-19avbiy">cancel</i> <p class="lib lib-js svelte-19avbiy"> </p>',1),Vh=z('<i class="material-icons-outlined lib lib-json svelte-19avbiy">cancel</i> <p class="lib lib-json svelte-19avbiy"> </p>',1),qh=z('<div class="arl svelte-19avbiy"><!></div>'),Jh=z('<p class="node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">factory</i> <span class="node-name svelte-19avbiy"> </span></p>'),Xh=z('<p class="node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">factory</i> <span class="node-name svelte-19avbiy"> </span></p>'),Gh=z('<p class="sub-node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">factory</i> <span class="node-name svelte-19avbiy"> </span></p>'),Yh=z('<p class="sub-node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">account_tree</i> <span class="node-name svelte-19avbiy"> </span></p>'),Kh=z('<p class="sub-node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">account_tree</i> <span class="node-name svelte-19avbiy"> </span></p>'),Zh=z('<p class="node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">account_tree</i> <span class="node-name svelte-19avbiy"> </span> <span class="arrow svelte-19avbiy"><!></span></p> <!>',1),Qh=z('<p class="node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">account_tree</i> <span class="node-name svelte-19avbiy"> </span> <span class="arrow svelte-19avbiy"><!></span></p>'),ed=z('<div class="column svelte-19avbiy"></div>'),td=z('<div class="content svelte-19avbiy"></div>');function id(e,t){le(t,!1);let i=J(t,"tx",8),s=V(new Qr(i()));const n="&#9656;",o="&#9662;";let r={div:null,title:"Select Node",pos:null,ok:null,cancel:null,add:v=>d(s).addLib(v)};pe(async()=>{i().send("modal div",r.div)});const a={onBuildTable(v){var w;d(s).init(v),d(s).fill(v),((w=r.div)==null?void 0:w.style.display)=="block"&&W(s,d(s))},onShow({xyScreen:v,xyLocal:w}){j(s,d(s).xyLocal.x=w.x),j(s,d(s).xyLocal.y=w.y),r.show({x:v.x+10,y:v.y+10})}};function l(v){}function c(v){d(s).onRemoveLib(v),W(s,d(s))}function h(v){d(s).onSelect(v,r),W(s,d(s))}function f(v){d(s).onArrowClick(v),W(s,d(s))}var g={handlers:a};return ue(),kt(e,{get box(){return r},children:(v,w)=>{var x=td();mt(x,5,()=>(d(s),R(()=>d(s).cols)),gt,(y,L,T)=>{var D=ed();mt(D,5,()=>d(L),gt,(E,_,I)=>{var q=Qe(),ae=de(q);{var ve=we=>{var ge=qh();ie(ge,"data-col",T),ie(ge,"data-node",I);var Ve=A(ge);{var We=P=>{var Y=Uh(),ee=de(Y),ye=B(ee,2),O=A(ye);oe(X=>K(O,X),[()=>(d(_),R(()=>d(_).model.arl.getName()))]),N("click",ee,c),N("keydown",ee,l),F(P,Y)},U=P=>{var Y=Vh(),ee=de(Y),ye=B(ee,2),O=A(ye);oe(X=>K(O,X),[()=>(d(_),R(()=>d(_).model.arl.getName()))]),N("click",ee,c),N("keydown",ee,l),F(P,Y)};fe(Ve,P=>{d(_),R(()=>{var Y;return((Y=d(_).model.arl)==null?void 0:Y.getExt())==="js"})?P(We):P(U,!1)})}F(we,ge)},Ee=we=>{var ge=Qe(),Ve=de(ge);{var We=U=>{var P=Qe(),Y=de(P);{var ee=O=>{var X=Jh();ie(X,"data-col",T),ie(X,"data-node",I);var te=A(X),Ge=B(te,2),ct=A(Ge);oe(He=>K(ct,He),[()=>(xe(ai),d(_),R(()=>d(_).node.source))]),N("click",te,h),N("keydown",te,l),N("click",Ge,h),N("keydown",Ge,l),F(O,X)},ye=O=>{var X=Qe(),te=de(X);{var Ge=He=>{var Ye=Xh();ie(Ye,"data-col",T),ie(Ye,"data-node",I);var Wt=A(Ye),si=B(Wt,2),ni=A(si);oe(Tt=>K(ni,Tt),[()=>(xe(ai),d(_),R(()=>d(_).node.dock))]),N("click",Wt,h),N("keydown",Wt,l),N("click",si,h),N("keydown",si,l),F(He,Ye)},ct=He=>{var Ye=Qe(),Wt=de(Ye);{var si=ni=>{var Tt=Qe(),Sa=de(Tt);{var La=Ri=>{var oi=Zh(),zt=de(oi);ie(zt,"data-col",T),ie(zt,"data-node",I);var Ut=A(zt),Ei=B(Ut,2),os=A(Ei),rs=B(Ei,2),yn=A(rs);To(yn,()=>o);var Ca=B(zt,2);mt(Ca,1,()=>(d(_),R(()=>d(_).node.nodes)),gt,(bn,tt,kn)=>{var lo=Qe(),Ra=de(lo);{var Ea=Ai=>{var Vt=Gh();ie(Vt,"data-col",T),ie(Vt,"data-node",I),ie(Vt,"data-sub",kn);var as=A(Vt),ls=B(as,2),Tn=A(ls);oe(qt=>K(Tn,qt),[()=>(xe(ai),d(tt),R(()=>d(tt).source))]),N("click",as,h),N("keydown",as,l),N("click",ls,h),N("keydown",ls,l),F(Ai,Vt)},Aa=Ai=>{var Vt=Qe(),as=de(Vt);{var ls=qt=>{var Jt=Yh();ie(Jt,"data-col",T),ie(Jt,"data-node",I),ie(Jt,"data-sub",kn);var cs=A(Jt),hs=B(cs,2),ds=A(hs);oe(ri=>K(ds,ri),[()=>(xe(ai),d(tt),R(()=>d(tt).group))]),N("click",cs,h),N("keydown",cs,l),N("click",hs,h),N("keydown",hs,l),F(qt,Jt)},Tn=qt=>{var Jt=Qe(),cs=de(Jt);{var hs=ds=>{var ri=Kh();ie(ri,"data-col",T),ie(ri,"data-node",I),ie(ri,"data-sub",kn);var _n=A(ri),Pn=B(_n,2),Ma=A(Pn);oe(Da=>K(Ma,Da),[()=>(xe(ai),d(tt),R(()=>d(tt).dock))]),N("click",_n,h),N("keydown",_n,l),N("click",Pn,h),N("keydown",Pn,l),F(ds,ri)};fe(cs,ds=>{d(tt),R(()=>d(tt).dock)&&ds(hs)},!0)}F(qt,Jt)};fe(as,qt=>{d(tt),R(()=>d(tt).group)?qt(ls):qt(Tn,!1)},!0)}F(Ai,Vt)};fe(Ra,Ai=>{d(tt),R(()=>d(tt).source)?Ai(Ea):Ai(Aa,!1)})}F(bn,lo)}),oe(bn=>K(os,bn),[()=>(xe(ai),d(_),R(()=>d(_).node.group))]),N("click",Ut,h),N("keydown",Ut,l),N("click",Ei,f),N("keydown",Ei,l),N("click",rs,f),N("keydown",rs,l),F(Ri,oi)},Na=Ri=>{var oi=Qh();ie(oi,"data-col",T),ie(oi,"data-node",I);var zt=A(oi),Ut=B(zt,2),Ei=A(Ut),os=B(Ut,2),rs=A(os);To(rs,()=>n),oe(yn=>K(Ei,yn),[()=>(xe(ai),d(_),R(()=>d(_).node.group))]),N("click",zt,h),N("keydown",zt,l),N("click",Ut,f),N("keydown",Ut,l),N("click",os,f),N("keydown",os,l),F(Ri,oi)};fe(Sa,Ri=>{d(_),R(()=>d(_).expanded)?Ri(La):Ri(Na,!1)})}F(ni,Tt)};fe(Wt,ni=>{d(_),R(()=>d(_).node.group)&&ni(si)},!0)}F(He,Ye)};fe(te,He=>{d(_),R(()=>d(_).node.dock)?He(Ge):He(ct,!1)},!0)}F(O,X)};fe(Y,O=>{d(_),R(()=>d(_).node.source)?O(ee):O(ye,!1)})}F(U,P)};fe(Ve,U=>{d(_),R(()=>d(_).node)&&U(We)},!0)}F(we,ge)};fe(ae,we=>{d(_),R(()=>d(_).nextModel)?we(ve):we(Ee,!1)})}F(E,q)}),F(y,D)}),F(v,x)},$$slots:{default:!0}}),Re(t,"handlers",a),ce(g)}function Fe(e,t=null){return function(i,s){return Ur(e,{target:t??document.createElement("div"),props:{tx:i,sx:s}}).handlers}}const sd=Fe(Jc),nd=Fe(Gc,document.body),od=Fe(Qc),rd=Fe(ih),ad=Fe(gh),ld=Fe(mh),Ao=Fe(xh),cd=Fe(bh),hd=Fe(kh),dd=Fe(Eh),ud=Fe(Mh),fd=Fe(Oh),Mo=Fe(Fh),pd=Fe(Wh),gd=Fe(zh),md=Fe(id),$={_roundedRect(e,t,i,s,n,o){e.moveTo(t,i+o),e.arcTo(t,i+n,t+o,i+n,o),e.arcTo(t+s,i+n,t+s,i+n-o,o),e.arcTo(t+s,i,t+s-o,i,o),e.arcTo(t,i,t,i+o,o)},rectRect(e,t,i,s,n,o,r){r&&(e.fillStyle=r,e.fillRect(t,i,s,n)),o&&(e.strokeStyle=o,e.strokeRect(t,i,s,n))},circle(e,t,i,s,n){e.beginPath(),e.strokeStyle=n,e.moveTo(t,i),e.arc(t,i,s,0,2*Math.PI),e.stroke()},diamond(e,t,i,s,n,o){e.beginPath(),e.fillStyle=o,e.moveTo(t+s/2,i),e.lineTo(t+s,i+n/2),e.lineTo(t+s/2,i+n),e.lineTo(t,i+n/2),e.lineTo(t+s/2,i),e.fill()},viewTitle(e,t,i,s,n,o){e.fillStyle=n,e.fillText(o,t+s*.5,i+s*.75)},viewRect(e,t,i,s,n,o,r,a,l){const c=Math.PI;e.beginPath(),e.lineWidth=r,e.moveTo(t,i+o),e.arc(t+o,i+o,o,c,-c/2),e.lineTo(t+s-o,i),e.arc(t+s-o,i+o,o,-c/2,0),e.lineTo(t+s,i+n-o),e.arc(t+s-o,i+n-o,o,0,c/2),e.lineTo(t+o,i+n),e.arc(t+o,i+n-o,o,c/2,c),e.lineTo(t,i+o),e.moveTo(t+s,i+n-o),e.lineTo(t+s-o,i+n),l&&(e.fillStyle=l,e.fill()),a&&(e.strokeStyle=a,e.stroke())},roundedRect(e,t,i,s,n,o,r,a,l){const c=Math.PI;e.beginPath(),e.lineWidth=r,e.moveTo(t,i+o),e.arc(t+o,i+o,o,c,-c/2),e.lineTo(t+s-o,i),e.arc(t+s-o,i+o,o,-c/2,0),e.lineTo(t+s,i+n-o),e.arc(t+s-o,i+n-o,o,0,c/2),e.lineTo(t+o,i+n),e.arc(t+o,i+n-o,o,c/2,c),e.lineTo(t,i+o),l&&(e.fillStyle=l,e.fill()),a&&(e.strokeStyle=a,e.stroke())},roundedHeader(e,t,i,s,n,o,r,a,l){const c=Math.PI;e.beginPath(),e.lineWidth=r,e.moveTo(t,i+o),e.arc(t+o,i+o,o,c,-c/2),e.lineTo(t+s-o,i),e.arc(t+s-o,i+o,o,-c/2,0),e.lineTo(t+s,i+n),e.lineTo(t,i+n),e.lineTo(t,i+o),l&&(e.fillStyle=l,e.fill()),a&&(e.strokeStyle=a,e.stroke())},grid(e,t,i,s,n,o,r,a,l){e.beginPath(),e.lineWidth=1,e.strokeStyle=a;const c=i+n;for(let f=i-i%r;f<c;f+=r)e.moveTo(t,f),e.lineTo(t+s,f);const h=t+s;for(let f=t-t%o;f<h;f+=o)e.moveTo(f,i),e.lineTo(f,i+n);e.stroke(),e.beginPath(),e.strokeStyle=l,e.moveTo(t,0),e.lineTo(t+s,0),e.moveTo(0,i),e.lineTo(0,i+n),e.stroke()},bullet(e,t,i,s,n,o){e.beginPath(),e.arc(t,i,s,0,2*Math.PI),o&&(e.fillStyle=o,e.fill()),n&&(e.lineWidth=1,e.strokeStyle=n,e.stroke())},textWidth(e,t){return e.measureText(t).width},fitText(e,t,i){if(e.measureText(t).width<=i)return t;const n="",o=e.measureText(n).width;let r=0,a=t.length,l=0;for(;r<a;){const h=Math.floor((r+a+1)/2),f=t.slice(0,h);e.measureText(f).width+o<=i?(l=h,r=h):a=h-1}return t.slice(0,l)+n},labelText(e,t,i,s,n,o,r,a){const l=e.font;e.font=i,e.fillStyle=s,e.fillText(t,n,o+.5*a),e.font=l},labelCursor(e,t,i,s,n,o,r){let a=e.measureText(t.slice(0,r)).width;return{x:i+a+1,y:s-.25*o}},leftText(e,t,i,s,n,o,r){e.fillStyle=i,e.fillText(t,s,n+.75*r)},rightText(e,t,i,s,n,o,r){e.fillStyle=i;let a=e.measureText(t).width;e.fillText(t,s+o-a,n+.75*r)},rightTextMulti(e,t,i,s,n,o,r,a){e.fillStyle=s,o+=.75*a;const l=t.indexOf("["),c=t.indexOf("]"),h=t.slice(0,l+1),f=t.slice(l+1,c),g=t.slice(c),v=e.font,w=e.measureText(h).width,x=e.measureText(g).width;e.font=i;const y=e.measureText(f).width;e.font=v,n=n+r-w-y-x,e.fillText(h,n,o),e.font=i,n+=w,e.fillText(f,n,o),e.font=v,n+=y,e.fillText(g,n,o)},leftTextMulti(e,t,i,s,n,o,r,a){e.fillStyle=s,e.fillStyle=s,o+=.75*a;const l=t.indexOf("["),c=t.indexOf("]"),h=t.slice(0,l+1),f=t.slice(l+1,c),g=t.slice(c),v=e.font,w=e.measureText(h).width;e.font=i;const x=e.measureText(f).width;e.font=v,e.fillText(h,n,o),e.font=i,n+=w,e.fillText(f,n,o),e.font=v,n+=x,e.fillText(g,n,o)},centerText(e,t,i,s,n,o,r,a){const l=e.font;e.font=i,e.fillStyle=s;let c=e.measureText(t);e.fillText(t,n+(r-c.width)/2,o+.75*a),e.font=l},centerLineText(e,t,i,s,n,o,r,a){e.beginPath(),e.fillStyle=i,e.strokeStyle=s;const l=e.measureText(t),c=5;e.moveTo(n,o+a/2),e.lineTo(n+(r-l.width)/2-c,o+a/2),e.moveTo(n+(r+l.width)/2+c,o+a/2),e.lineTo(n+r,o+a/2),e.stroke(),e.fillText(t,n+(r-l.width)/2,o+.75*a)},ifName(e,t,i,s){const{x:n,y:o,w:r,h:a}=s;e.beginPath(),e.strokeStyle=i.line,e.fillStyle=i.line;const l=e.measureText(t),c=5,h=n+(r-l.width)/2,f=o+a/2;e.moveTo(n,f),e.lineTo(h-c,f),e.moveTo(h+l.width+c,f),e.lineTo(n+r,f),e.stroke(),e.fillStyle=i.text,e.fillText(t,h,o+.75*a)},centerTextCursor(e,t,i,s){let n=t.x+t.w/2-e.measureText(i).width/2,o=e.measureText(i.slice(0,s)).width;return{x:n+o+1,y:t.y}},leftTextCursor(e,t,i,s,n,o,r){let a=e.measureText(t.slice(0,r)).width;return{x:i+a+1,y:s}},rightTextCursor(e,t,i,s,n,o,r){let a=e.measureText(t.slice(0,r)).width;return{x:i+n-e.measureText(t).width+a,y:s}},cursor(e,t,i,s,n,o){e.fillStyle=o,e.fillRect(t,i,s,n)},bulletRect(e,t,i,s,n,o,r){e.beginPath(),e.fillStyle=o,e.fillRect(t+r,i,s,n),e.arc(t+r,i+n/2,r,Math.PI/2,-Math.PI/2),e.fill()},rectBullet(e,t,i,s,n,o,r){e.beginPath(),e.fillStyle=o,e.fillRect(t,i,s-r,n),e.arc(t+s-r,i+n/2,r,-Math.PI/2,Math.PI/2),e.fill()},corner(e,t,i,s,n,o,r,a){e.beginPath(),e.fillStyle=a,i?(e.moveTo(s,n),e.lineTo(s+o,n+r),e.arc(s+o/2,n+r/2,o/2,Math.PI/2,Math.PI),e.lineTo(s,n)):(e.moveTo(s,n+r),e.lineTo(s+o,n),e.arc(s+o/2,n+r/2,o/2,0,Math.PI/2),e.lineTo(s,n+r)),e.fill()},leftTriangle(e,t,i,s,n,o){e.beginPath(),e.fillStyle=o,e.moveTo(t,i+n/2),e.lineTo(t+s,i+n),e.lineTo(t+s,i),e.lineTo(t,i+n/2),e.fill()},rightTriangle(e,t,i,s,n,o){e.beginPath(),e.fillStyle=o,e.moveTo(t,i),e.lineTo(t,i+n),e.lineTo(t+s,i+n/2),e.lineTo(t,i),e.fill()},triangleBall(e,t,i,s,n,o){const a=n/2;e.beginPath(),e.fillStyle=o,e.moveTo(t,i+a),e.lineTo(t+s,i+n),e.lineTo(t+s,i),e.lineTo(t,i+a),e.arc(t+s+3,i+a,3,0,2*Math.PI),e.fill()},ballTriangle(e,t,i,s,n,o){const a=n/2;e.beginPath(),e.fillStyle=o,e.moveTo(t,i),e.lineTo(t,i+n),e.lineTo(t+s,i+a),e.lineTo(t,i),e.arc(t-3,i+a,3,0,2*Math.PI),e.fill()},triangle(e,t,i,s,n,o,r){switch(e.beginPath(),e.fillStyle=r,o){case"up":e.moveTo(t,i+n),e.lineTo(t+s,i+n),e.lineTo(t+s/2,i),e.lineTo(t,i+n);break;case"down":e.moveTo(t,i),e.lineTo(t+s/2,i+n),e.lineTo(t+s,i),e.lineTo(t,i);break;case"left":e.moveTo(t,i+n/2),e.lineTo(t+s,i+n),e.lineTo(t+s,i),e.lineTo(t,i+n/2);break;case"right":e.moveTo(t,i),e.lineTo(t,i+n),e.lineTo(t+s,i+n/2),e.lineTo(t,i);break}e.fill()},tack(e,t,i,s,n,o,r){e.beginPath(),e.fillStyle=r;let{x:a,y:l,w:c,h}=n;const f=3;let g=a+c/2,v=l+h/2;switch(t){case"up":e.moveTo(a,l+h),e.lineTo(a+c,l+h),e.lineTo(a+(c+o)/2,l),e.lineTo(a+(c-o)/2,l),e.lineTo(a,l+h),i&&(v=s?l-f:l+h+f);break;case"down":e.moveTo(a,l),e.lineTo(a+(c-o)/2,l+h),e.lineTo(a+(c+o)/2,l+h),e.lineTo(a+c,l),e.lineTo(a,l),i&&(v=s?l+h+f:l-f);break;case"left":e.moveTo(a,l+(h-o)/2),e.lineTo(a,l+(h+o)/2),e.lineTo(a+c,l+h),e.lineTo(a+c,l),e.lineTo(a,l+(h-o)/2),i&&(g=s?a-f:a+c+f);break;case"right":e.moveTo(a,l),e.lineTo(a,l+h),e.lineTo(a+c,l+(h+o)/2),e.lineTo(a+c,l+(h-o)/2),e.lineTo(a,l),i&&(g=s?a+c+f:a-f);break}i&&e.arc(g,v,f,0,2*Math.PI),e.fill()},filterSign(e,t,i,s){let n=t.x-i/2,o=t.y-i/2;e.fillStyle=s,e.fillRect(n,o,i,i),e.fillStyle="#000000",e.fillRect(n+2,o+2,i-4,i-4)},hBusbarLabel(e,t,i,s,n,o,r,a,l){e.beginPath(),e.fillStyle=a,$._roundedRect(e,i,s,n,o,r),e.fill(),e.fillStyle=l,e.fillText(t,i+n/2-e.measureText(t).width/2,s+.75*o)},vBusbarLabel(e,t,i,s,n,o,r,a,l){e.beginPath(),e.fillStyle=a,$._roundedRect(e,i,s,n,o,r),e.fill(),e.save(),e.translate(i,s),e.rotate(-Math.PI/2),e.fillStyle=l,e.fillText(t,-o/2-e.measureText(t).width/2,.75*n),e.restore()},wirelessSymbol(e,t,i,s,n){e.beginPath(),e.strokeStyle=n;let o=t-2,r=i-2;e.moveTo(o-s-4,r),e.arc(o,r,s+4,Math.PI,-Math.PI/2),e.moveTo(o-s,r),e.arc(o,r,s,Math.PI,-Math.PI/2),e.moveTo(o-s+4,r),e.arc(o,r,s-4,Math.PI,-Math.PI/2),e.stroke()},filterSymbol(e,t,i,s,n){e.beginPath(),e.strokeStyle=n;const o=s/3,r=s/2;e.moveTo(t,i),e.lineTo(t+s,i),e.lineTo(t+s-o,i+r),e.lineTo(t+s-o,i+s),e.lineTo(t+o,i+s),e.lineTo(t+o,i+r),e.lineTo(t,i),e.stroke()},hCableLabel(e,t,i,s,n,o,r,a,l){e.beginPath(),e.fillStyle=a,$._roundedRect(e,i-2,s-2,n+4,o+4,r+2),e.fill(),e.beginPath(),e.strokeStyle=l,$._roundedRect(e,i,s,n,o,r),e.stroke(),e.fillStyle=l,e.fillText(t,i+n/2-e.measureText(t).width/2,s+.75*o)},vCableLabel(e,t,i,s,n,o,r,a,l){e.beginPath(),e.fillStyle=a,$._roundedRect(e,i-2,s-2,n+4,o+4,r+2),e.fill(),e.beginPath(),e.strokeStyle=l,$._roundedRect(e,i,s,n,o,r),e.stroke(),e.save(),e.translate(i,s),e.rotate(-Math.PI/2),e.fillStyle=l,e.fillText(t,-o/2-e.measureText(t).width/2,.75*n),e.restore()},drawBusbar(e,t,i,s){const n=e.lineWidth;if(!(t.len<2)){e.beginPath(),e.lineWidth=s,e.strokeStyle=i,e.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)e.lineTo(t[o].x,t[o].y);e.stroke(),e.lineWidth=n}},drawCable(e,t,i,s){if(t.len<2)return;const n=e.lineWidth;e.beginPath(),e.lineWidth=s,e.strokeStyle=i,e.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)e.lineTo(t[o].x,t[o].y);e.stroke(),e.lineWidth=s-4,e.strokeStyle="#000000",e.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)e.lineTo(t[o].x,t[o].y);e.stroke(),e.lineWidth=s-6,e.strokeStyle=i,e.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)e.lineTo(t[o].x,t[o].y);e.stroke(),e.lineWidth=n},drawPoints(e,t){let i=t.length;if(i<2)return;const s=7.5,n=15;e.moveTo(t[0].x,t[0].y);for(let o=0;o<i-1;o++){const r=t[o],a=t[o+1];Math.abs(r.y-a.y)>=n||Math.abs(r.x-a.x)>=n?e.arcTo(r.x,r.y,a.x,a.y,s):(e.lineTo(r.x,r.y),e.lineTo(a.x,a.y))}e.lineTo(t[i-1].x,t[i-1].y),e.stroke()},drawWire(e,t,i,s){e.beginPath(),e.lineWidth=i,e.strokeStyle=t,this.drawPoints(e,s)},twistedPair(e,t,i,s){e.beginPath(),e.strokeStyle=t,e.lineWidth=2*i,this.drawPoints(e,s)}},it={close(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=s/2;e.arc(t+r,i+r,r,0,2*Math.PI);const a=2;e.moveTo(t+a,i+a),e.lineTo(t+s-a,i+s-a),e.moveTo(t+s-a,i+a),e.lineTo(t+a,i+s-a),e.stroke()},bigView(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2,e.rect(t,i,s,n),e.stroke()},smallView(e,t,i,s,n,o){e.beginPath(),e.fillStyle=o,e.rect(t+2,i+2,s-4,n-4),e.fill()},xbigView(e,t,i,s,n,o){e.beginPath();const r=n/2,a=s/2;e.strokeStyle=o,e.lineWidth=2,e.rect(t,i,a-1,r),e.rect(t+a+1,i+r,a-1,r),e.stroke()},calibrate(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=s/2,a=1;e.arc(t+r,i+r,r-1,0,2*Math.PI),e.moveTo(t-a,i+r),e.lineTo(t+s+a,i+r),e.moveTo(t+r,i-a),e.lineTo(t+r,i+s+a),e.stroke()},grid(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=s/3;e.moveTo(t+r,i),e.lineTo(t+r,i+s),e.moveTo(t+r+r,i),e.lineTo(t+r+r,i+s),e.moveTo(t,i+r),e.lineTo(t+s,i+r),e.moveTo(t,i+r+r),e.lineTo(t+s,i+r+r),e.stroke()},link(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=Math.PI,a=s/3,l=s/2;e.moveTo(t+l+a,i+a),e.arc(t+l,i+a,a,0,r,!0),e.moveTo(t+l-a,i+n-a),e.arc(t+l,i+n-a,a,r,2*r,!0),e.moveTo(t+l,i+n-a),e.lineTo(t+l,i+a),e.stroke()},lock(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=Math.PI,a=s/3,l=s/2;e.moveTo(t+l+a,i+a),e.arc(t+l,i+a,a,0,r,!0),e.rect(t+1,i+a+1,s-2,n-a-1),e.stroke()},cog(e,t,i,s,n,o,r){e.beginPath();const a=s/2,l=n/2,c=s/3,h=Math.PI,f=1,g=2;e.strokeStyle=o,e.lineWidth=2,e.moveTo(t+a,i+f),e.lineTo(t+a,i+n-f),e.moveTo(t,i+l),e.lineTo(t+s,i+l),e.moveTo(t+f,i+g),e.lineTo(t+s-f,i+n-g),e.moveTo(t+s-f,i+g),e.lineTo(t+f,i+n-g),e.stroke(),e.beginPath(),e.fillStyle=r,e.arc(t+a,i+l,c,0,2*h),e.stroke(),e.fill()},factory(e,t,i,s,n,o){e.beginPath();const r=n/4,a=n/2,l=s/2;e.strokeStyle=o,e.lineWidth=2,e.moveTo(t+s,i),e.lineTo(t+s,i+n),e.lineTo(t,i+n),e.lineTo(t,i+r),e.lineTo(t+l,i+a),e.lineTo(t+l,i+r),e.lineTo(t+s,i+a),e.stroke()},group(e,t,i,s,n,o){e.beginPath();const r=n/2,a=s/2;e.strokeStyle=o,e.lineWidth=2,e.rect(t,i+2,a-1,r),e.rect(t+a+1,i+r,a-1,r),e.stroke()},pulse(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=i+n/2+1;e.moveTo(t,r),e.lineTo(t+2,r),e.lineTo(t+4,i),e.lineTo(t+5,i+n),e.lineTo(t+6,r),e.lineTo(t+s,r),e.stroke()},comment(e,t,i,s,n,o){e.beginPath();const r=n/6,a=n/2,l=5*r,c=s/4;e.strokeStyle=o,e.lineWidth=2,e.moveTo(t+c,i+r),e.lineTo(t+3*c,i+r),e.moveTo(t+c,i+a),e.lineTo(t+2*c,i+a),e.moveTo(t+c,i+l),e.lineTo(t+4*c,i+l),e.stroke()}},k={rectToString:e=>e?`x ${Math.round(e.x)} y ${Math.round(e.y)} w ${Math.round(e.w)} h ${Math.round(e.h)}`:"x 0 y 0 w 0 h 0",stringToRect:e=>{let t=e.indexOf("x"),i=e.indexOf("y"),s=e.indexOf("w"),n=e.indexOf("h");return{x:parseFloat(e.slice(t+1,i)),y:parseFloat(e.slice(i+1,s)),w:parseFloat(e.slice(s+1,n)),h:parseFloat(e.slice(n+1))}},relativeRect:(e,t)=>`x ${Math.round(e.x-t.x)} y ${Math.round(e.y-t.y)} w ${Math.round(e.w)} h ${Math.round(e.h)}`,transformToString:e=>`sx ${e.sx.toFixed(3)} sy ${e.sy.toFixed(3)} dx ${e.dx.toFixed(3)} dy ${e.dy.toFixed(3)}`,stringToTransform:e=>{let t=e.indexOf("sx"),i=e.indexOf("sy"),s=e.indexOf("dx"),n=e.indexOf("dy");return t<0||i<0||s<0||n<0?{sx:1,sy:1,dx:0,dy:0}:{sx:parseFloat(e.slice(t+2,i)),sy:parseFloat(e.slice(i+2,s)),dx:parseFloat(e.slice(s+2,n)),dy:parseFloat(e.slice(n+2))}},stringToPosition:e=>{const t=e.indexOf(",");if(t<0)return{rect:{x:0,y:0,w:0,h:0},left:!1};const i=k.stringToRect(e.slice(0,t)),s=e.slice(t+1).trim()==="left";return{rect:i,left:s}},stringToUidWid(e){const t=e.indexOf(".");return t<0?[e,0]:[e.slice(0,t),+e.slice(t+1)]},stringToWid(e){const t=e.indexOf(".");return t<0?0:+e.slice(t+1)},pointToString(e){return`x ${e.x} y ${e.y}`},stringToPoint(e){const t=e.match(/x\s*(-?\d+\.?\d*)\s*y\s*(-?\d+\.?\d*)/);return t?{x:parseFloat(t[1]),y:parseFloat(t[2])}:null},ifNameToString:e=>`(${e.wid})`+e.text,stringToIfName:e=>{const t=e.indexOf("("),i=e.indexOf(")");return t<0||i<0?{text:"-invalid-",id:0}:{text:e.slice(i+1).trim(),id:+e.slice(t+1,i)}},pinToString:e=>`(${e.wid}`+(e.is.left?" L)":" R)")+e.name,stringToPin:e=>{const t=e.indexOf("("),i=e.indexOf(")");return t<0||i<0?{name:"-invalid-",id:0,left:!0}:{name:e.slice(i+1).trim(),id:+e.slice(t+1,i-1),left:e[i-1]==="L"}},padToString:e=>(e.is.leftText?"L":"R")+"("+k.rectToString(e.rect)+")"+e.text,stringToPad:e=>{const t=e.indexOf("("),i=e.indexOf(")");return t<0||i<0?{text:"-invalid-",rect:{x:0,y:0,w:0,h:0},left:!0}:{text:e.slice(i+1),rect:k.stringToRect(e.slice(t+1,i)),left:e[0]==="L"}},wireToString:e=>{if(e.length<2)return"";const t=[];for(let i=1;i<e.length;i++){const s=e[i].x-e[i-1].x,n=e[i].y-e[i-1].y;Math.abs(s)>Math.abs(n)?t.push("x "+s.toFixed(1)):t.push("y "+n.toFixed(1))}return t.join(" ")},stringToWire(e,t,i){if(!i||i.length<1)return[];if(e){let{x:s,y:n}={...e},o=[{x:s,y:n}];const r=i.split(" ");for(let a=0;a<r.length;a+=2){const l=r[a],c=parseFloat(r[a+1]);l==="x"?s+=c:n+=c,o.push({x:s,y:n})}return o}if(t){let{x:s,y:n}={...t},o=[{x:s,y:n}];const r=i.split(" ").reverse();for(let a=0;a<r.length;a+=2){const l=r[a+1],c=parseFloat(r[a]);l==="x"?s-=c:n-=c,o.push({x:s,y:n})}return o.reverse()}else return[]},routeToRaw(e){let t=e.from,i=e.to;const s=l=>`(pin ${l.wid}) ${l.name} @ ${l.node.name}`,n=l=>"(bus) "+l.bus.name,o=l=>`(pad ${l.proxy.wid}) ${l.proxy.name}`,r=()=>{if(i.is.pin)return i.is.input;if(t.is.pin)return!t.is.input;if(i.is.pad)return i.proxy.is.input;if(t.is.pad)return!t.proxy.is.input},a={};return r()?(t.is.pin?a.from=s(t):t.is.pad?a.from=o(t):t.is.tack&&(a.from=n(t)),i.is.pin?a.to=s(i):i.is.pad?a.to=o(i):i.is.tack&&(a.to=n(i)),a.wire=k.wireToString(e.wire)):(i.is.pin?a.from=s(i):i.is.pad?a.from=o(i):i.is.tack&&(a.from=n(i)),t.is.pin?a.to=s(t):t.is.pad?a.to=o(t):t.is.tack&&(a.to=n(t)),a.wire=k.wireToString(e.wire.slice().reverse())),a},rawToEndPoint(e){const t=e.trim().slice(1,4);let i=0,s=0,n=0;switch(t){case"pin":return i=e.indexOf(")"),s=e.slice(4,i).trim(),n=e.indexOf("@"),{pin:e.slice(i+1,n).trim(),wid:s.length>0?+s:0,node:e.slice(n+1).trim()};case"pad":return i=e.indexOf(")"),s=e.slice(4,i).trim(),{pad:e.slice(i+1).trim(),wid:s.length>0?+s:0};case"bus":return{bus:e.slice(5).trim()};case"itf":return{itf:e.slice(5).trim()}}},cleanInput(e){return e.trim().replace(/\s+/g," ").replace(/@|->|=>/g,"")},cleanLink(e){return e.split("@").map(t=>k.cleanInput(t).trim()).filter(t=>t.length>0).join(" @ ")},splitLink(e){return e.split("@").map(t=>t.trim()).filter(t=>t.length>0).reverse()},isMulti:e=>{const t=e.indexOf("["),i=e.lastIndexOf("]");return t>-1&&i>-1&&i>t},extractMultis:e=>{const[t,i]=k.getPreMiddlePost(e);return i.split(",")},expandMultis:e=>{const[t,i,s]=k.getPreMiddlePost(e);return i.split(",").map(o=>t+o+s)},cleanMulti(e){const[t,i,s]=k.getPreMiddlePost(e);return t+"["+i+"]"+s},getPreMiddlePost(e){const t=e.indexOf("["),i=e.lastIndexOf("]");let s=e.slice(0,t).trim(),n=e.slice(t+1,i).split(",").map(l=>l.trim()).filter(Boolean).join(","),o=e.slice(i+1).trim();const r=s.at(-1);s.length>0&&r!="."&&r!="-"&&r!="_"&&(s=s+" ");const a=o[0];return o.length>0&&a!="."&&a!="-"&&a!="_"&&(o=" "+o),[s,n,o]},needsPrefix:e=>{const t=e[0];return t=="+"||t=="."||t=="-"||t=="_"||t=="/"},needsPostfix:e=>{const t=e.at(-1);return t=="+"||t=="."||t=="-"||t=="_"||t=="/"},combineWithPrefix(e,t){let i=t;const s=t[0];if(s=="+"||s=="."||s=="-"||s=="_"||s=="/"){const n=t.slice(1).trim();i=s=="+"?e+" "+n:e+s+n}return i},combineWithPostfix(e,t){let i=t;const s=t.at(-1);if(s=="+"||s=="."||s=="-"||s=="_"||s=="/"){const n=t.slice(0,-1).trim();i=s=="+"?n+" "+e:n+s+e}return i},prefixMatch(e,t){if(t.startsWith(e)){const i=t[e.length];return i=="."||i=="-"||i==" "||i=="_"||i=="/"}},postfixMatch(e,t){if(t.endsWith(e)){const i=t.at(-e.length-1);return i=="."||i=="-"||i==" "||i=="_"||i=="/"}},addNumber:(e,t)=>{const i=e.lastIndexOf("("),s=e.lastIndexOf(")");if(i!==-1&&s===e.length-1){const n=e.slice(i+1,s);if(!isNaN(n)&&n!=="")return e.slice(0,i+1)+t.toString()+")"}return e+"("+t.toString()+")"},viewToJSON:e=>{let t,i,s;return e.viewState?(t=e.viewState.visible?e.viewState.big?"big":"open":"closed",i=e.viewState.big?k.rectToString(e.viewState.rect):k.rectToString(e.rect),s=k.transformToString(e.tf)):(t=e.status,i=k.rectToString(e.rect),s=k.transformToString(e.tf)),{state:t,rect:i,transform:s}},stringToView:e=>({raw:!0,state:e.state,rect:k.stringToRect(e.rect),tf:k.stringToTransform(e.transform)}),pinToHandler(e){return"on"+e.split(/[ .-]+/).map(s=>s.replace(/[^a-zA-Z0-9_]/g,"")).filter(Boolean).map(s=>s[0].toUpperCase()+s.slice(1)).join("")},nodeToFactory:e=>{let s=e.toLowerCase().split(/[ .-]+/).map(n=>n.replace(/[^a-z0-9_]/g,"")).filter(Boolean).map(n=>n[0].toUpperCase()+n.slice(1)).join("");return/^[0-9]/.test(s)&&(s="_"+s),s},skipPrefix:e=>{let t=e.indexOf("/",1);return t<0?e:e.slice(t)},spaceToDash:e=>{if(!e.includes(" "))return e;let t="";for(let i=0;i<e.length;i++)t+=e[i]==" "?"-":e[i];return t},toBaseName:e=>{const t=e.indexOf("-model");return t>0?e.slice(0,t):e},nameToSource:e=>k.spaceToDash(e)+".js",nameToModel:e=>k.spaceToDash(e)+".json",nameToBuild:e=>k.spaceToDash(e)+".js",nameToApp:e=>k.spaceToDash(e)+".js",nameToPage:e=>k.spaceToDash(e)+".html",objectToJsLiteral(e,t=4){return JSON.stringify(e,(i,s)=>s===void 0?"__undefined__":s,t).replace(/"__undefined__"/g,"undefined").replace(/"([^"]+)":/g,"$1:").replace(/"([^"]*)"/g,(i,s)=>`'${s.replace(/'/g,"\\'")}'`)},djb2:e=>{for(var t=5381,i=0;i<e.length;i++)t=(t<<5)+t+e.charCodeAt(i);return Math.abs(t&2**32-1).toString(16).padStart(8,"0")},hexToHsl(e){let t=parseInt(e.slice(1,3),16)/255,i=parseInt(e.slice(3,5),16)/255,s=parseInt(e.slice(5,7),16)/255,n=1;e.length>7&&(n=parseInt(e.slice(7,9),16)/255);let o=Math.max(t,i,s),r=Math.min(t,i,s),a,l,c=(o+r)/2;if(o===r)a=l=0;else{let h=o-r;switch(l=c>.5?h/(2-o-r):h/(o+r),o){case t:a=(i-s)/h+(i<s?6:0);break;case i:a=(s-t)/h+2;break;case s:a=(t-i)/h+4;break}a/=6}return l*=100,c*=100,a*=360,n==1?`hsl(${a.toFixed(0)}, ${l.toFixed(0)}%, ${c.toFixed(0)}%)`:`hsl(${a.toFixed(0)}, ${l.toFixed(0)}%, ${c.toFixed(0)}%, ${n})`},hslToHex(e){let t=e.indexOf(",")>-1?",":" ",i=e.substring(4,e.lastIndexOf(")")).split(t),s=parseFloat(i[0]),n=parseFloat(i[1])/100,o=parseFloat(i[2])/100,r=parseFloat(i[3]),a=(1-Math.abs(2*o-1))*n,l=a*(1-Math.abs(s/60%2-1)),c=o-a/2,h=0,f=0,g=0,v="ff";return 0<=s&&s<60?(h=a,f=l,g=0):60<=s&&s<120?(h=l,f=a,g=0):120<=s&&s<180?(h=0,f=a,g=l):180<=s&&s<240?(h=0,f=l,g=a):240<=s&&s<300?(h=l,f=0,g=a):300<=s&&s<360&&(h=a,f=0,g=l),h=Math.round((h+c)*255).toString(16),f=Math.round((f+c)*255).toString(16),g=Math.round((g+c)*255).toString(16),v=r==1?"ff":Math.round(r*255).toString(16),h.length<2&&(h="0"+h),f.length<2&&(f="0"+f),g.length<2&&(g="0"+g),v.length<2&&(g="0"+v),v=="ff"?"#"+h+f+g:"#"+h+f+g+v}};function vd(e){return/^#[0-9A-Fa-f]{6}([0-9A-Fa-f]{2})?$/.test(e)}const M={shade1:"#fff",shade2:"#fff",shade3:"#fff",shade4:"#fff",shade5:"#fff",view1:"#222",view2:"#444",vIcon1:"#fd4d0c",vIcon2:"#3399ff",vIcon3:"#33cc33",vIcon4:"#e9bb16",grey3:"#333",grey6:"#666",greyC:"#ccc",black:"#000",white:"#fff",orange:"#ff8000",orangeT:"#ff800022",green:"#7fff00",red:"#FE2712",yellow:"#fefe33",pink:"#f9d5e5",purple:"#ff80ff",blue:"#0000ff",setShades(e){const t=k.hexToHsl(e),i=t.indexOf(",",4),s=t.indexOf(",",i+1),n=t.substring(4,i),o=t.substring(i+1,s);this.shade1=k.hslToHex(`hsl(${n},${o},40%,1)`),this.shade2=k.hslToHex(`hsl(${n},${o},30%,0.50)`),this.shade3=k.hslToHex(`hsl(${n}, 100%, 75%, 1)`),this.shade4=k.hslToHex(`hsl(${n},${o},60%,1)`),this.shade5=k.hslToHex(`hsl(${n}, 50%, 75%, 1)`)}};function $s(){this.rgb="#fff",this.std={font:"normal 12px tahoma",lineCap:"round",lineJoin:"round",lineWidth:1,cBackground:M.black,cLine:M.white,cFill:M.blue,wCursor:2,blinkRate:500,cBlinkOn:M.white,cBlinkOff:M.black},this.look={wBox:150,hTop:20,hBottom:6,wExtra:50,wMax:300,dxCopy:20,dyCopy:20,smallMove:5},this.box={rCorner:7.5,wLine:2,cLine:M.shade1,cBackground:M.shade2,cContainer:M.yellow,cSelected:M.orangeT,dxSel:10,dySel:10,wLineSel:1},this.header={font:"normal 13px tahoma",hHeader:15,hTitle:15,wLine:1,wChar:6,rCorner:7.5,cTitle:M.shade3,cBackground:M.shade1,cBad:M.red,cHighLighted:M.purple},this.icon={wIcon:8,hIcon:10,blinkRate:200,nBlinks:4,cSrc:M.shade3,cLink:M.shade3,cBadLink:M.red,cHighLighted:M.purple,cGroup:M.shade3,cCog:M.shade3,cPulse:M.shade3,cComment:M.shade3,xPadding:6,yPadding:2,xSpacing:3},this.label={font:"italic 12px tahoma",hLabel:15,cNormal:M.greyC},this.ifName={font:"normal 12px tahoma",hSep:15,cNormal:M.shade5,cBackground:M.shade1,cAdded:M.green,cBad:M.red,cSelected:M.orange,cHighLighted:M.purple},this.pin={hPin:15,wOutside:10,wMargin:21,hArrow:10,wArrow:10,wChar:6,cNormal:M.shade1,cSelected:M.orange,cHighLighted:M.purple,cConnected:M.shade4,cAdded:M.green,cBad:M.red,cText:M.shade1,cCursor:M.black,fMulti:"italic 11px tahoma"},this.pad={hPad:15,hSpace:15,rBullet:7.5,wArrow:10,hArrow:10,wExtra:30,wMargin:4,wViewLeft:10,wViewRight:100,cBackground:M.shade2,cSelected:M.orange,cHighLighted:M.purple,cConnected:M.shade4,cBad:M.red,cText:M.shade1,cArrow:M.shade1},this.route={wSelected:2,wNormal:2,split:30,tooClose:15,cNormal:M.shade4,cSelected:M.purple,cHighLighted:M.purple,cNotUsed:M.grey3,cAdded:M.green,cDeleted:M.red},this.bus={wNormal:6,wBusbar:6,wCable:8,wSelected:6,split:50,tooClose:25,wArrow:10,hArrow:10,sChar:5,hLabel:15,radius:7.5,wFilter:15,cNormal:M.shade4,cSelected:M.purple,cHighLighted:M.purple,cBad:M.red,cText:M.black},this.selection={xPadding:20,yPadding:20,cRect:M.orangeT,cPinGroup:M.orangeT,wLine:0,rCorner:7.5},this.view={wDefault:800,hDefault:500,wLine:4,rCorner:15,wExtra:200,hExtra:20,cBackground:M.black,cLine:M.view1,cHighLight:M.view2,fHeader:"normal 15px arial",hHeader:20,cTitle:M.grey6,cTitleHighLight:M.shade3,grid:{dx:30,dy:30,cLine:M.grey3,cAxis:M.grey6},wIcon:10,hIcon:10,xPadding:10,xSpacing:8,cDim:M.grey6,cClose:M.vIcon1,cFullscreen:M.vIcon2,cCalibrate:M.vIcon3,cGrid:M.vIcon4},this.placement={marginTop:30,marginLeft:30,marginLeftPads:210,nodesPerRow:5,rowStep:360,colStep:270,spacing:50,tolerance:10}}$s.prototype={switch(e){if(!e)return m;const t=m;return m=e,t},create:e=>vd(e)?new $s().adapt(e):new $s().adapt("#00aaff"),adapt(e){return this.rgb=e,M.setShades(e),this.box.cLine=this.header.cBackground=this.ifName.cBackground=this.pin.cNormal=this.pin.cText=M.shade1,this.box.cBackground=this.pad.cBackground=M.shade2,this.header.cTitle=this.icon.cSrc=this.icon.cGroup=this.icon.cCog=this.icon.cLink=this.icon.cPulse=this.icon.cComment=this.view.cTitleHighLight=M.shade3,this.pin.cConnected=this.pad.cConnected=this.route.cNormal=this.bus.cNormal=M.shade4,this.ifName.cNormal=M.shade5,this}};let m=new $s().adapt("#00aaff");function ea(){this.cursor=0,this.saved=null,this.obj=null,this.prop=null,this.keyPressed=null}ea.prototype={newEdit(e,t,i=-1){this.cursor=i<0?e[t].length:0,this.saved=e[t],this.obj=e,this.prop=t,this.keyPressed=null},clear(){this.obj[this.prop]="",this.cursor=0},handleKey(e){this.keyPressed=e.key;let t=this.cursor;const i=this.obj,s=this.prop;let n=t>0?i[s].slice(0,t):"",o=t<i[s].length-1?i[s].slice(t):"";return i[s]=n+e.key+o,this.cursor++,!1},handleSpecialKey(e){switch(this.keyPressed=e.key,e.key){case"Shift":return!1;case"Backspace":let t=this.cursor,i=this.obj[this.prop],s=t>0?i.slice(0,t-1):"",n=t<i.length?i.slice(t):"";return this.obj[this.prop]=s+n,t>0&&this.cursor--,!1;case"Enter":return!0;case"ArrowLeft":return this.cursor>0&&this.cursor--,!1;case"ArrowRight":return this.cursor<this.obj[this.prop].length&&this.cursor++,!1;case"Home":return this.cursor=0,!1;case"End":return this.cursor=this.obj[this.prop].length,!1;case"Delete":return this.obj[this.prop]="",this.cursor=0,!1;case"Escape":return this.obj[this.prop]=this.saved,!0;case"Alt":return!1;case"AltGraph":return!1;case"Control":return!1;default:return!0}}};function ta(e){this.bottom=0,this.top=0,this.next=0,this.max=e>0?e-1:1,this.ring=new Array(this.max+1),this.ring.fill(null)}ta.prototype={reset(){this.bottom=0,this.top=0,this.next=0,this.ring.fill(null)},push(e){this.top=this.next,this.ring[this.top]=e,this.next=this.next==this.max?0:this.next+1,this.next==this.bottom&&(this.bottom=this.bottom==this.max?0:this.bottom+1)},last(){return this.ring[this.top]},back(){return this.next==this.bottom?null:(this.next=this.next==0?this.max:this.next-1,this.ring[this.next])},forward(){if(this.next==this.top+1)return null;const e=this.ring[this.next];return this.next=this.next==this.max?0:this.next+1,e}};const at=(e,t)=>e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h,Vn="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",An=Vn.length;function wd(e){let t="";for(let i=0;i<e;i++){let s=Math.floor(Math.random()*An);t+=s<An?Vn[s]:Vn[An-1]}return t}function Ce(e,t){const i=e.indexOf(t);return i>=0&&e.splice(i,1),i>=0}function xd(e,t){if(e.length<2)return null;const i=[];let s=0,n=0;for(let o=0;o<e.length-1;o++)s=e[o],n=e[o+1],s.y>t.y&&s.y<t.y+t.h&&n.y>t.y&&n.y<t.y+t.h?(s.x<t.x+t.w&&n.x>t.x||n.x<t.x+t.w&&s.x>t.x)&&i.push(o+1):s.x>t.x&&s.x<t.x+t.w&&n.x>t.x&&n.x<t.x+t.w&&(s.y<t.y+t.h&&n.y>t.y||n.y<t.y+t.h&&s.y>t.y)&&i.push(o+1);return i}function Mn(e,t,i){const s=i.x,n=i.x+i.w,o=i.y,r=i.y+i.h;if(e.x<=s&&t.x<=s||e.x>=n&&t.x>=n||e.y<=o&&t.y<=o||e.y>=r&&t.y>=r)return!1;if(e.x>s&&e.x<n&&e.y>o&&e.y<r||t.x>s&&t.x<n&&t.y>o&&t.y<r)return!0;const a=c=>{if(t.x===e.x)return!1;const h=(c-e.x)/(t.x-e.x);if(h>0&&h<1){const f=e.y+h*(t.y-e.y);return f>o&&f<r}return!1},l=c=>{if(t.y===e.y)return!1;const h=(c-e.y)/(t.y-e.y);if(h>0&&h<1){const f=e.x+h*(t.x-e.x);return f>s&&f<n}return!1};return!!(a(s)||a(n)||l(o)||l(r))}function yd(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}function bd(e,t){let i=1/0,s=null,n=0,o=!1;for(let r=0;r<e.length-1;r++){let{x:a,y:l}=e[r],{x:c,y:h}=e[r+1];if(a===c)if(Math.min(l,h)<=t.y&&t.y<=Math.max(l,h)){let f=Math.abs(t.x-a);f<i&&(i=f,s={x:a,y:t.y},n=r+1,o=!1)}else{let f=(t.x-a)**2+(t.y-l)**2,g=(t.x-c)**2+(t.y-h)**2,[v,w,x]=f<g?[f,{x:a,y:l},r+1]:[g,{x:a,y:h},r+1];v<i&&(i=v,s=w,n=x,o=!0)}else if(l===h)if(Math.min(a,c)<=t.x&&t.x<=Math.max(a,c)){let f=Math.abs(t.y-l);f<i&&(i=f,s={x:t.x,y:l},n=r+1,o=!1)}else{let f=(t.x-a)**2+(t.y-l)**2,g=(t.x-c)**2+(t.y-h)**2,[v,w,x]=f<g?[f,{x:a,y:l},r+1]:[g,{x:c,y:h},r+1];v<i&&(i=v,s=w,n=x,o=!0)}}return{point:s,segment:n,endPoint:o}}function kd(e,t,i){let s=e.x,n=e.y,o=.1*(1+Math.random()),r=i[t-1],a=i[t];return(a.x<r.x||a.y<r.y)&&([r,a]=[a,r]),r.x==a.x?n=Math.abs(r.y-p.y)<Math(a.y-p.y)?r.y+o*(a.y-r.y):a.y-o*(a.y-r.y):s=Math.abs(r.x-p.x)<Math(a.x-p.x)?r.x+o*(a.x-r.x):a.x-o*(a.x-r.x),{x:s,y:n}}function ia(e){return e?JSON.parse(JSON.stringify(e)):null}function sa(e,t){if(e===null)return t;if(t===null)return JSON.parse(JSON.stringify(e));if(Array.isArray(e)&&Array.isArray(t))return t;for(let i in e)e.hasOwnProperty(i)&&(typeof e[i]=="object"&&!Array.isArray(e[i])&&e[i]!==null?t[i]=sa(e[i],t[i]||{}):t.hasOwnProperty(i)||(t[i]=e[i]));for(let i in t)t.hasOwnProperty(i)&&(e.hasOwnProperty(i)||delete t[i]);return t}const Td={prepare(e){this.canvas.focus(),e.preventDefault();const t=this.doc;if(!t)return[null,null,null];const i=t.view.localCoord({x:e.offsetX,y:e.offsetY});return t.view.whichView(i)},onContextMenu(e){const[t,i,s]=this.prepare(e);t&&(i||(t.onContextMenu(s,e),this.redraw()))},onMouseDown(e){var n;if(e.button!=0)return;const[t,i,s]=this.prepare(e);t&&(t!=((n=this.doc)==null?void 0:n.focus)&&this.switchView(t),i?this.viewMouseDown(t,i):t.onMouseDown(s,e),this.redraw())},onMouseMove(e){const[t,i,s]=this.prepare(e);t&&(this.viewMouseMove(t,i,{x:e.movementX,y:e.movementY})||t.onMouseMove(s,e)&&this.redraw())},onMouseUp(e){if(this.state.action)return this.viewMouseUp();const[t,i,s]=this.prepare(e);t&&(t.onMouseUp(s,e),this.redraw())},onWheel(e){const[t,i,s]=this.prepare(e);t&&(t.onWheel(s,e),this.redraw())},onDblClick(e){const[t,i,s]=this.prepare(e);t&&t.onDblClick(s,e)},onClick(e){},onDragOver(e){e.preventDefault()},onDrop(e){const[t,i,s]=this.prepare(e);t&&t.onDrop(s,e)},viewMouseDown(e,t){t.is.icon?e.iconClick(t,this):t.is.border?(this.state.view=e,this.state.widget=t,this.state.action=ht.viewResize):t.is.viewTitle&&(this.state.view=e,this.state.widget=t,this.state.action=ht.viewDrag)},viewWidgetHover(e,t){t.is.border&&(this.state.action=ht.hoverBorder,e.highLight())},viewMouseMove(e,t,i){switch(this.state.action){case ht.nothing:if(!(t!=null&&t.is.border))return!1;if(t.name=="top"||t.name=="bottom")this.canvas.style.cursor="ns-resize";else if(t.name=="left"||t.name=="right")this.canvas.style.cursor="ew-resize";else if(t.name=="corner")this.canvas.style.cursor="nw-resize";else return!0;this.state.action=ht.hoverBorder,this.state.view=e;break;case ht.viewDrag:this.state.view.move(i);break;case ht.viewResize:this.state.view.resize(this.state.widget,i);break;case ht.hoverBorder:(e!=this.state.view||!(t!=null&&t.is.border))&&(this.canvas.style.cursor="default",this.state.action=ht.nothing);break;default:return!1}return this.redraw(),!0},viewMouseUp(){this.state.view=this.state.widget=null,this.state.action=ht.nothing}},_d={onKeydown(e){var t,i;(i=(t=this.doc)==null?void 0:t.focus)!=null&&i.onKeydown(e)&&(e.stopPropagation(),e.preventDefault(),this.redraw())},onKeyup(e){var t,i;(i=(t=this.doc)==null?void 0:t.focus)!=null&&i.onKeyup(e)&&(e.stopPropagation(),e.preventDefault(),this.redraw())}},Pd="0.8.4",Sd={schemaVersion:Pd};function na(){const e=new Date;this.version=Sd.schemaVersion,this.created=e.toLocaleString(),this.saved=e.toLocaleString(),this.utc=e.toJSON(),this.style=m,this.runtime="@vizualmodel/vmblu-runtime"}na.prototype={toJSON(){const e=new Date;return{version:this.version,created:this.created,saved:e.toLocaleString(),utc:e.toJSON(),style:this.style.rgb,runtime:this.runtime}},bluviz(){const e=new Date;return{blu:{version:this.version,created:this.created,saved:e.toLocaleString(),utc:e.toJSON(),runtime:this.runtime},viz:{version:this.version,utc:e.toJSON(),style:this.style.rgb}}},cook(e,t){var s,n,o,r,a;const i=new Date;this.created=((s=t.created)==null?void 0:s.slice())??i.toLocaleString(),this.saved=((n=t.saved)==null?void 0:n.slice())??i.toLocaleString(),this.utc=((o=t.utc)==null?void 0:o.slice())??i.toJSON(),this.version=((r=t.version)==null?void 0:r.slice())??"no version",this.style=m.create(t.style),this.runtime=((a=t.runtime)==null?void 0:a.slice())??"@vizualmodel/vmblu-runtime"}};const Ld={async handleSourceMap(){const e=await this.readSourceMap();e&&(this.sourceMap=this.parseSourceMap(e))},async readSourceMap(){var i;const e=(i=this.arl)==null?void 0:i.getFullPath();return e?await this.arl.resolve(zs(e)+".prf.json").get("json"):null},parseSourceMap(e){if(!e.entries)return null;const t=new Map;for(const i of e.entries){const{node:s,handles:n,transmits:o}=i;t.has(s)||t.set(s,{handles:new Map,transmits:new Map});const r=t.get(s);for(const a of n){const{handler:l,...c}=a;r.handles.set(l,{handler:l,...c})}for(const a of o){const{pin:l,...c}=a,h=r.transmits.get(l);h?Array.isArray(h)?h.push({pin:l,...c}):r.transmits.set(l,[h,{pin:l,...c}]):r.transmits.set(l,{pin:l,...c})}}return t},flattenSourceMap(e){const t=[];for(const[i,s]of e.entries())for(const[n,o]of s.entries())t.push({node:i,pin:n,...o});return t},getInputPinProfile(e){var o,r;const t=(r=(o=this.sourceMap)==null?void 0:o.get(e.node.name))==null?void 0:r.handles;if(!t)return null;const i=k.pinToHandler(e.name);if(!e.is.multi)return t.get(i)??null;const s=e.expandMultis(),n=[];for(const a of s){const l=k.pinToHandler(a),c=t.get(l)??null;c&&n.push(c)}return n},getOutputPinProfile(e){var n,o;const t=(o=(n=this.sourceMap)==null?void 0:n.get(e.node.name))==null?void 0:o.transmits;if(!t)return null;if(!e.is.multi)return t.get(e.name)??null;const i=e.expandMultis(),s=[];for(const r of i){const a=t.get(r)??null;Array.isArray(a)?s.push(...a):s.push(a)}return s},makeMcpToolString(e){const t=this.generateToolSpecs();if(t.length==0)return null;const i=new Date,s=`// ------------------------------------------------------------------
// MCP tool file for model: ${e.name}
// Creation date ${i.toLocaleString()}
// ------------------------------------------------------------------

export const mcpTools = `,n=k.objectToJsLiteral(t);return s+n},generateToolSpecs(){const e=[];if(!this.sourceMap)return[];for(const[t,i]of this.sourceMap.entries())for(const[s,n]of i.entries()){if(!n.mcp)continue;const o=new Map;for(const a of n.params||[]){if(!a.name||typeof a.name!="string")continue;if(a.name.startsWith("{")&&a.name.endsWith("}")){const c=a.name.slice(1,-1).split(",").map(h=>h.trim());for(const h of c)o.set(h,{name:h,type:"string",description:""});continue}const l=a.name.split(".");if(l.length===1)o.has(a.name)||o.set(a.name,{...a});else{const[c,h]=l;let f=o.get(c);f||(f={name:c,type:"object",description:"",properties:[],required:[]},o.set(c,f)),f.properties.push({name:h,type:a.type,description:a.description||""}),f.required.includes(h)||f.required.push(h)}}const r={name:n.mcpName||`${s} @ ${t}`,description:n.mcpDescription||n.summary||`Trigger ${s} on ${t}`,parameters:Array.from(o.values()),returns:n.returns||"",node:t,pin:s,handler:n.handler,file:n.file,line:n.line};e.push(r)}return e},convertToOpenAITools(e){return e.map(t=>{const i={type:"object",properties:{},required:[]};for(const s of t.parameters){const{name:n,type:o,description:r,properties:a,required:l}=s;if(!n||!o)continue;const c={type:o,description:r||""};if(o==="object"&&a){c.properties={},c.required=l||[];for(const h of a)c.properties[h.name]={type:h.type,description:h.description||""}}i.properties[n]=c,i.required.push(n)}return{type:"function",function:{name:t.name,description:t.description,parameters:i}}})}};function Mt(e){this.is={blu:!1,lib:!1,selectable:!1,dirty:!1,main:!1,fresh:!1},this.arl=e,this.home={blu:null,viz:null,lib:null},this.key=null,this.header=new na,this.libraries=new ro,this.raw=null,this.sourceMap=null,this.analyzeArl(e)}Mt.prototype={toJSON(){return this.arl.userPath},bluviz(){return{blu:this.arl.userPath,viz:null}},analyzeArl(e){if(!e)return;const t=Ya(e.userPath);if(this.is.blu=t.ext===".vmblu"||t.ext===".blu.json",this.is.lib=t.ext===".js"||t.ext===".mjs",this.is.lib){this.home.lib=e;return}this.home.blu=t.ext===".vmblu"?e.resolve(t.name+".blu.json"):e,this.home.viz=e.resolve(t.name+".viz.json")},makeKey(){this.key=k.djb2(this.arl.getFullPath())},copy(){const e=new Mt(this.arl);return e.key=this.key?this.key.slice():null,e.header={...this.header},e.raw=this.raw,e},findRawNode(e){var n,o;const t=(n=this.raw)==null?void 0:n.root;if(!t)return null;const i=k.splitLink(e);if(i.length==1)return e==t.name?t:t.nodes?this.findRawRecursive(t.nodes,e):null;let s=t;for(const r of i)if(s=(o=s.nodes)==null?void 0:o.find(a=>r===a.name),!s)return null;return s},findRawRecursive(e,t){for(const i of e)if(t==i.name)return i;for(const i of e)if(i.kind=="group"&&i.nodes.length>0){const s=this.findRawRecursive(i.nodes,t);if(s)return s}return null},setSelectable(){this.is.selectable=!0},async fetch(){let e=null;if(this.is.lib){const t=await this.arl.get("text").catch(i=>{console.error(`${this.arl.userPath} is not a valid library file`,i)});return t?(e=this.analyzeJSLib(t),e||console.error(`Model not found in library file: ${this.arl.userPath}`),e):null}return this.is.blu?(e=await this.arl.get("json").catch(t=>{console.error(`${this.arl.getFullPath()} is not a valid model file}`,t)}),e):(console.error(`${this.arl.userPath} is not a model nor a library file`),null)},async getRaw(){var e;return this.raw=await this.fetch(),(e=this.raw)!=null&&e.header&&this.header.cook(this.arl,this.raw.header),this.is.fresh=!0,this.raw},addRawLibraries(e,t){const i=this.libraries.newModels(e,t);for(const s of i)this.libraries.add(s)},analyzeJSLib(e){let t=e.indexOf('"{\\n'),i=e.indexOf('\\n}";',t);if(t<0||i<0)return null;let s=e.slice(t+1,i+3);const n=new Array(s.length);let o=0,r=0;for(;r<s.length;){const l=s.charAt(r++);if(l!="\\")n[o++]=l;else{const c=s.charAt(r++);c=="n"?n[o++]=`
`:c=='"'&&(n[o++]='"')}}const a=n.join("");return JSON.parse(a)}};Object.assign(Mt.prototype,Ld);function ro(){this.map=new Map}ro.prototype={reset(){this.map.clear()},size(){return this.map.size},newModels(e,t){const i=[];if(t.length<1)return i;for(const s of t){const n=e.resolve(s);if(this.contains(n))continue;const o=new Mt(n);i.push(o)}return i},add(e){const t=e.arl.getFullPath();return this.map.get(t)?this:(this.map.set(t,e),this)},contains(e){return this.map.has(e.getFullPath())},get(e){return this.map.get(e)},valuesArray(){return Array.from(this.map.values())},all(e){const t=Array.from(this.map.values());return t!=null&&t.length?t.map(i=>e(i)):[]},findArl(e){var t;if(!e)return null;for(const i of this.map.values())if((t=i.arl)!=null&&t.equals(e))return i;return null},toJSON(){return[...this.map.values()]},toVIZ(){return this.map.values().map(e=>e.toVIZ())},async load(){const e=[];for(const t of this.map.values())t.is.selectable=!0,e.push(t.getRaw());await Promise.all(e)}};function Nd(e){this.pin=e}function oa(e){this.pin=e,this.targets=[]}oa.prototype={dropTarget(e){const t=this.targets;for(let i=0;i<t.length;i++)if(e.node==t[i].node&&e.name==t[i].name){for(let s=i;s<t.length-1;s++)t[s]=t[s+1];t.pop();return}}};function Cd(e){this.tack=e}function ra(e){this.tack=e,this.fanout=[]}ra.prototype={connectsTo(e){const t=this.tack.getOtherPin();return t.is.multi?t.getMatch(e)==e:t.name==e},dropTarget(e){const t=this.fanout;for(let i=0;i<t.length;i++)if(e.node==t[i].node&&e.name==t[i].name){for(let s=i;s<t.length-1;s++)t[s]=t[s+1];t.pop();return}}};const Rd={rxtxPrepareTables(){if(!this.is.group)for(const e of this.look.widgets)e.is.pin&&this.rxtxAddPin(e)},rxtxResetTables(){this.is.group||(this.txTable=[],this.rxTable=[])},rxtxAddPin(e){this.is.group||(e.is.input?this.rxTable.push(new Nd(e)):this.txTable.push(new oa(e)))},rxtxPopPin(e){this.is.group||(e.is.input?this.rxTable.pop():this.txTable.pop())},rxtxRemovePin(e){if(!this.is.group)if(e.is.input){const t=this.rxTable.find(i=>i.pin==e);Ce(this.rxTable,t)}else{const t=this.txTable.find(i=>i.pin==e);Ce(this.txTable,t)}},rxtxAddPinArea(e){if(!this.is.group)for(const t of e)t.is.pin&&this.rxtxAddPin(t)},rxtxBuildTxTable(){var e;if(this.is.group){for(const t of this.buses)t.hasFilter()&&t.rxtxBuildRxTxTable();for(const t of this.nodes)t.rxtxBuildTxTable();return}for(const t of this.look.widgets){if(!t.is.pin||t.is.input||t.routes.length==0)continue;const i=this.txTable.find(n=>n.pin.name==t.name);if(!i){console.error(`${this.name} NO TX TABLE RECORD FOR ${t.name}`);continue}i.targets=[];const s=[];for(const n of t.routes){if(!n.from||!n.to)continue;const o=n.from==t?n.to:n.from;o.is.pin?o.is.proxy?(e=o.pad)==null||e.makeConxList(s):s.push(o):o.is.tack?o.bus.hasFilter()?s.push(o):o.bus.makeConxList(t,s):o.is.pad&&o.proxy.makeConxList(s)}for(const n of s)i.targets.push(n)}},rxtxRemoveFromTxTable(e,t){var n;const i=(n=this.txTable.find(o=>o.pin.name==e.name))==null?void 0:n.targets,s=(i==null?void 0:i.length)??0;for(let o=0;o<s;o++)if(t.node==i[o].node&&t.name==i[o].name){for(let r=o;r<s-1;r++)i[r]=i[r+1];i.pop();return}}};function Ed(e){return{x:e.x-15,y:e.y+10}}const Ad={showExportForm(e){const t=this;u.tx.send("show link",{title:"Export to link",name:t.name,path:"",pos:e,ok:(i,s)=>u.doEdit("saveToLink",{node:t,newName:i,userPath:s}),cancel:()=>{}})},showLinkForm(e){var n,o;const t=this,i=t.link&&t.link.model!=((n=u.doc)==null?void 0:n.model)?(o=t.link.model)==null?void 0:o.arl.userPath:"",s=t.link?t.link.lName:t.name;u.tx.send("show link",{title:"Set link",name:s,path:i,pos:e,ok:(r,a)=>{(r!=s||a!=i)&&u.doEdit("changeLink",{node:t,lName:r,userPath:a})},open:(r,a)=>{var l,c;(r!=s||a!=i)&&u.doEdit("changeLink",{node:t,lName:r,userPath:a}),(l=t.link.model)!=null&&l.arl&&t.link.model!=((c=u.doc)==null?void 0:c.model)&&u.tx.send("open document",t.link.model.arl)},cancel:()=>{}})},iconClick(e,t,i){var o;const s=this,n=Ed(i);switch(t.type){case"link":case"lock":this.showLinkForm(n);break;case"factory":const r=s.factory.fName.length<1?k.nodeToFactory(s.name):s.factory.fName,a=s.factory.arl?s.factory.arl.userPath:"";u.tx.send("show factory",{title:"Factory for "+s.name,name:r,path:a,pos:n,ok:(c,h)=>{u.doEdit("changeFactory",{node:s,newName:c.trim(),userPath:h.trim()})},open:async(c,h)=>{(c!=r||h!=a)&&u.doEdit("changeFactory",{node:s,newName:c.trim(),userPath:h.trim()});const f=s.factory.arl??u.doc.resolve("./index.js");u.tx.send("open source file",{arl:f})},cancel:()=>{}});break;case"group":let l=null;s.savedView?(o=s.savedView.viewState)!=null&&o.visible?(l=s.savedView.parent,l&&s.savedView.closeView()):(e.restoreView(s),l=s.savedView):l=e.newSubView(s),l&&u.switchView(l);break;case"cog":u.tx.send("settings",{title:"Settings for "+s.name,pos:n,json:s.sx,ok:c=>u.doEdit("changeNodeSettings",{node:s,sx:c})});break;case"pulse":u.tx.send("runtime settings",{title:"Runtime settings for "+s.name,pos:n,dx:s.dx,ok:c=>u.doEdit("changeNodeDynamics",{node:s,dx:c})});break;case"comment":u.tx.send("node comment",{header:"Comment for "+s.name,pos:n,uid:s.uid,text:s.prompt??"",ok:c=>u.doEdit("changeNodeComment",{node:s,comment:c})});break}},iconCtrlClick(e,t,i){var n,o,r,a;const s=this;switch(t.type){case"link":case"lock":(o=(n=s.link)==null?void 0:n.model)!=null&&o.arl&&s.link.model!=((r=u.doc)==null?void 0:r.model)&&u.tx.send("open document",s.link.model.arl);break;case"factory":{if(!s.is.source)return;const l=s.factory.arl??u.doc.resolve("./index.js");l&&u.tx.send("open source file",{arl:l})}break;case"group":s.savedView?e.restoreView(s):e.newSubView(s),(a=s.savedView)==null||a.big();break}}},Md={collectFactories(e){if(!this.link&&(this.is.source&&this.factory.arl!=null&&e.add(this.factory),this.is.group))for(const t of this.nodes)t.collectFactories(e)},collectModels(e){var t;this.link?this.link.model&&!this.link.model.is.main&&e.add(this.link.model):(t=this.nodes)==null||t.forEach(i=>i.collectModels(e))},collectModelsForLib(e,t){var i;if(this.link){const s=this.link.model;s&&!s.arl.equals(t.arl)&&e.add(s)}else(i=this.nodes)==null||i.forEach(s=>s.collectModelsForLib(e,t))},collectImports(e,t=null){var o,r;if(this.is.group){(r=(o=this.link)==null?void 0:o.model)!=null&&r.is.lib&&(t=this.link.model);for(const a of this.nodes)a.collectImports(e,t);for(const a of this.buses)a.hasFilter()&&a.getFilter(e,t,this.link);return}const i=this.getSourceArl(t)??e[0].arl,s=this.factory.duplicate(e,i)?`${this.factory.fName} as ${this.factory.alias}`:this.factory.fName,n=e.find(a=>a.arl.equals(i));n?n.items.find(l=>l==s)||n.items.push(s):e.push({arl:i,items:[s]})},makeSourceLists(e,t){var i;if(this.is.source)e.push(this);else if((i=this.link)!=null&&i.is.bad)console.warn(`Group node "${this.name}" is missing. ModelBlueprint "${this.link.model.arl.userPath}" not found`);else if(!this.nodes)console.warn(`Group node "${this.name}" is empty`);else{for(const s of this.buses)s.is.cable&&s.is.filter&&t.push(s);for(const s of this.nodes)s.makeSourceLists(e,t)}},xxxduplicateFactory(e,t){const i=e.find(s=>s.arl.equals(t)?!1:s.items.find(n=>n==this.factory.fName));return i?(console.warn(`Duplicate factory name: ${this.factory.fName} is already defined in ${i.arl.userPath}`),this.factory.alias="_"+this.factory.fName,!0):(this.factory.alias=null,!1)}};function Ys(e,t){this.model=e,this.lName=t,this.is={bad:!1}}Ys.prototype={copy(){return new Ys(this.model,this.lName)},toJSON(){return{path:this.model&&!this.model.is.main?this.model.arl.userPath:"./",node:this.lName}}};const Dd={setLink(e,t){var i;this.link?(this.link.model=e,this.link.lName=t,(i=this.link.model)!=null&&i.is.lib?this.look.checkLinkIcon("lock"):this.look.checkLinkIcon("link")):(this.link=new Ys(e,t),e!=null&&e.is.lib?this.look.addIcon("lock"):this.look.addIcon("link"))},clearLink(){this.look.removeLinkIcon(),this.is.source?this.look.addIcon("factory"):this.look.addIcon("group"),this.link=null},linkIsBad(){this.link.is.bad=!0,this.look.badLinkIcon()},linkIsGood(){this.link.is.bad=!1,this.look.goodLinkIcon()},adjustPaths(e){var t;if(this.link)this.link.model.arl.makeRelative(e);else if((t=this.factory)!=null&&t.arl)this.factory.arl.makeRelative(e);else if(this.nodes)for(const i of this.nodes)i.adjustPaths(e)}},Id={getRoutes(){const e=[];for(const t of this.look.widgets)if(t.is.pin)for(const i of t.routes)e.push(i);return e},getAllRoutes(e){const t=[];for(const i of e)if(i.is.pin)for(const s of i.routes)t.push(s);return t},connect(){},disconnect(){for(const e of this.look.widgets)e.is.pin&&e.disconnect()},disconnectPinArea(e){for(const t of e)t.is.pin&&t.disconnect()},isConnected(){for(const e of this.look.widgets)if(e.is.pin&&e.routes.length>0)return!0;return!1},highLight(){this.is.highLighted=!0;for(const e of this.look.widgets)if(!(!e.is.pin||e.routes.length==0))for(const t of e.routes){const i=t.from===e?t.to:t.from;t.highLight(),i.is.tack&&i.bus.highLightRoutes(e)}},unHighLight(){this.is.highLighted=!1;for(const e of this.look.widgets)if(!(!e.is.pin||e.routes.length==0))for(const t of e.routes){const i=t.from===e?t.to:t.from;t.unHighLight(),i.is.tack&&i.bus.unHighLightRoutes(e)}}},Od={acceptChanges(){var e;this.look&&this.look.acceptChanges(),(e=this.nodes)==null||e.forEach(t=>t.acceptChanges())},sxUpdate(e){e.sx&&(this.sx=sa(e.sx,this.sx))},sameRelativePosition(e,t,i){return{x:i.is.left?e.rect.x:e.rect.x+e.rect.w,y:e.rect.y+(i.rect.y-t.rect.y)}},prefixPinPosition(e,t){const i=t.getPrefix(),s=e.findInterfaceName(i),n=s?e.getInterface(s):null;if(!n)return console.log("*** InterfaceName not found ***"+i+"  "+t.name),{x:t.is.left?e.rect.x:e.rect.x+e.rect.w,y:e.rect.y+e.rect.h};const o=n.at(-1);return{x:t.is.left?e.rect.x:e.rect.x+e.rect.w,y:o.rect.y+o.rect.h}},newInterfaceNamePosition(e,t){const i={x:e.rect.x,y:e.rect.y+e.rect.h};for(const s of e.widgets)s.is.ifName&&(s.is.added||s.rect.y>t.rect.y&&s.rect.y<i.y&&(i.y=s.rect.y));return i},widgetCompare(e){const t=this.look,i=e.look;for(const n of t.widgets)n.wid&&(n.is.added=!1,n.is.zombie=!0);const s=i.widgets.slice().sort((n,o)=>n.rect.y-o.rect.y);for(const n of s){if(!n.is.ifName)continue;let o=t.widgets.find(r=>r.is.zombie&&r.is.ifName&&n.is.ifName&&r.text==n.text);if(o){o.is.zombie=!1,o.wid=n.wid;continue}if(o=t.widgets.find(r=>r.is.zombie&&r.is.ifName&&n.is.ifName&&r.wid==n.wid),o){this.dockInterfaceNameChange(o,n),o.is.zombie=!1;continue}this.dockNewInterfaceName(n)}for(const n of s){if(!n.is.pin)continue;let o=t.widgets.find(r=>r.is.zombie&&r.is.pin&&r.name==n.name&&r.is.input==n.is.input&&r.is.channel==n.is.channel);if(o){o.is.zombie=!1,o.wid=n.wid;continue}if(o=t.widgets.find(r=>r.is.zombie&&r.is.pin&&r.wid==n.wid&&r.is.input==n.is.input),o){this.dockPinChange(o,n),o.is.zombie=!1;continue}this.dockNewPin(n,e)}},dockNewPin(e,t){const i=e.pxlen!=0?this.prefixPinPosition(this.look,e):this.sameRelativePosition(this.look,t.look,e),s=this.look.addPin(e.name,i,e.is);s.profile=e.profile,s.pxlen=e.pxlen,s.is.added=!0},dockNewInterfaceName(e){const t=this.newInterfaceNamePosition(this.look,e),i=this.look.addIfName(e.text,t);i.is.added=!0},dockPinChange(e,t){if(t.is.channel!=e.is.channel&&(e.is.channel=t.is.channel),t.name!=e.name||t.pxlen!=e.pxlen){if(t.pxlen!=0&&t.getPrefix()!=e.getPrefix()){const i=this.prefixPinPosition(this.look,t);this.look.movePin(e,i)}e.name=t.name,e.pxlen=t.pxlen,e.is.multi=t.is.multi}t.is.input&&t.profile!=e.profile&&(e.profile=t.profile),e.is.added=!0},dockInterfaceNameChange(e,t,i){t.text!=e.text&&(e.text=t.text,e.is.added=!0,this.look.interfaceChangePrefix(e))}};function Ks(e,t){this.rect={...e},this.node=t,this.is={box:!0,selected:!1}}Ks.prototype={render(e){const{x:t,y:i,w:s,h:n}=this.rect,o=m.box;if(this.is.selected){const r=this.node.look.findLabel(),a=r&&r.text.length>0?r.rect.h:0,l=o.dxSel,c=o.dySel;$.roundedRect(e,t-l,i-c-a,s+2*l,n+2*c+a,o.rCorner,o.wLineSel,o.cSelected.slice(0,7),o.cSelected)}$.roundedRect(e,t,i,s,n,o.rCorner,o.wLine,o.cLine,o.cBackground)},increaseHeight(e){this.rect.h+=e},increaseWidth(e){this.rect.w+=e},toJSON(){return{box:k.relativeRect(this.rect,this.node.look.rect)}}};function Zs(e,t){this.rect={...e},this.is={header:!0,highLighted:!1,alert:!1},this.title=t.name,this.node=t}Zs.prototype={startEdit(){return"title"},endEdit(e){this.title=k.cleanInput(this.title),this.node.look.headerChanged(this,e)},drawCursor(e,t,i){const s=$.centerTextCursor(e,this.rect,this.title,t),n=i?m.std.cBlinkOn:m.std.cBlinkOff;$.cursor(e,s.x,s.y,m.std.wCursor,this.rect.h,n)},render(e){let t=m.header,{x:i,y:s,w:n,h:o}=this.rect;$.roundedHeader(e,i,s,n,o,t.rCorner,t.wLine,t.cBackground,t.cBackground);const r=this.node.is.duplicate?t.cBad:this.is.highLighted?t.cHighLighted:t.cTitle;$.centerText(e,this.title,t.font,r,i,s,n,o),this.is.alert&&$.circle(i,s,10,"#ff0000")},hitTitle(e){const t=m.icon,i=this.rect,s=i.x+t.xPadding+2*(t.wIcon+t.xSpacing),n=i.x+i.w-t.xPadding-2*(t.wIcon+t.xSpacing);return e.x>s&&e.x<n},toJSON(){return{header:this.title}}};const Fd={startEdit(){return this.pxlen&&(this.name=this.withoutPrefix(),this.pxlen=0),this.is.multi=!1,"name"},endEdit(e){this.checkNewName()?this.nameChanged(e):this.restoreSavedName(e)},displayName(){return this.pxlen==0?this.name:this.withoutPrefix()},nameClash(e){return this.is.input!=e.is.input?!1:this.lowerCase()==e.lowerCase()?!0:this.is.input?k.pinToHandler(this.name)==k.pinToHandler(e.name):!1},lowerCase(){return this.name.toLowerCase()},checkNewName(){var e,t;if(this.name=k.cleanInput(this.name),this.name.length==0)return((e=this.routes)==null?void 0:e.length)==0;if(k.needsPrefix(this.name)||k.needsPostfix(this.name)){if(this.name.length==1)return!1;this.addIfName()}else this.pxlen=0;return this.is.multi=k.isMulti(this.name),this.is.multi&&(this.name=k.cleanMulti(this.name)),this.checkRouteUsage(),(t=this.node.look)==null||t.adjustPinWidth(this),this.node.look.setDuplicatePin(this),!0},nameChanged(e){const t=this.is.input?this.node.rxTable.find(i=>i.pin==this):this.node.txTable.find(i=>i.pin==this);if(this.name.length==0){this.is.input?Ce(this.node.rxTable,t):Ce(this.node.txTable,t),this.node.look.removePin(this);return}},restoreSavedName(e){this.name=e,(k.needsPrefix(e)||k.needsPostfix(e))&&this.addIfName()},withoutPrefix(){if(this.pxlen==0)return this.name;if(this.pxlen>0){let t=this.name.slice(this.pxlen);return t[0]!=" "?t:""+t.trim()}else if(this.pxlen<0){let t=this.name.slice(0,this.pxlen-1);return t.at(-1)!=" "?t:""+t.trim()}},getPrefix(){return this.pxlen>0?this.name.slice(0,this.pxlen):this.pxlen<0?this.name.slice(this.pxlen):null},ifNamePrefixCheck(){var i;this.pxlen=0;const e=(i=this.node.look.findIfNameAbove(this.rect.y))==null?void 0:i.text.toLowerCase();if(!e)return;const t=this.lowerCase();k.prefixMatch(e,t)?this.pxlen=e.length:k.postfixMatch(e,t)&&(this.pxlen=-e.length)},addIfName(){const e=this.node.look.findIfNameAbove(this.rect.y);k.needsPrefix(this.name)?e?(this.name=k.combineWithPrefix(e.text,this.name),this.pxlen=e.text.length):(this.name=this.name.slice(1).trimStart(),this.pxlen=0):k.needsPostfix(this.name)&&(e?(this.name=k.combineWithPostfix(e.text,this.name),this.pxlen=-e.text.length):(this.name=this.name.slice(0,-1).trimEnd(),this.pxlen=0))},checkPrefix(){if(this.pxlen==0)return;const e=this.getPrefix(),t=this.node.look.findIfNameAbove(this.rect.y);t&&e==t.text||(this.pxlen=0)},changePrefix(e){if(this.pxlen==0)return;if(e.length==0){this.pxlen=0;return}const t=this.pxlen>0?"+"+this.name.slice(this.pxlen+1):this.name.slice(0,this.pxlen-1)+"+";this.name=k.combineWithPrefix(e,t),this.pxlen=this.pxlen>0?e.length:-e.length},checkRouteUsage(){for(const e of this.routes)e.is.notUsed=!1;for(const e of this.routes){const t=e.from==this?e.to:e.from;if(e.is.twistedPair=t.is.multi||this.is.multi,t.is.pin)(t.is.multi||this.is.multi)&&!this.hasMultiOverlap(t)&&(e.is.notUsed=!0);else if(t.is.pad)(this.is.multi||t.proxy.is.multi)&&!this.hasMultiOverlap(t.proxy)&&(e.is.notUsed=!0);else if(t.is.tack){let i=!1;for(const s of t.bus.tacks){if(s==t)continue;const n=s.route.to==s?s.route.from:s.route.to;t.bus.areConnected(this,n)&&(s.route.is.notUsed=!1,i=!0)}i||(e.is.notUsed=!0)}}},extractMultis(){return k.extractMultis(this.name)},expandMultis(){return k.expandMultis(this.name)},hasFullNameMatch(e){const t=e.is.multi?k.expandMultis(e.lowerCase()):[e.lowerCase()],i=this.is.multi?k.expandMultis(this.lowerCase()):[this.lowerCase()];for(const s of t)if(i.includes(s))return!0;return!1},hasMultiOverlap(e){return e.is.multi?this.is.multi?this.checkMultiPartOnly(e):e.checkPartial(this.lowerCase()):this.is.multi?this.checkPartial(e.lowerCase()):!1},checkMultiPartOnly(e){const t=k.extractMultis(e.lowerCase()),i=k.extractMultis(this.lowerCase());for(const s of t)if(i.includes(s))return!0;return!1},checkPartial(e){const t=k.extractMultis(this.lowerCase());for(const i of t)if(e.indexOf(i)>=0)return!0;return!1},getMatch(e){if(this.is.multi){const t=k.extractMultis(this.lowerCase()),i=k.expandMultis(this.lowerCase());for(let s=0;s<t.length;s++)if(e.includes(t[s]))return i[s]}return null}};function Pi(e,t,i,s){this.rect={...e},this.node=t,this.name=i,this.pxlen=0,this.wid=0,this.is={pin:!0,proxy:!1,channel:s.channel??!1,input:s.input??!1,left:s.left??!1,multi:s.multi??!1,selected:!1,highLighted:!1,hoverOk:!1,hoverNok:!1,zombie:s.zombie??!1,added:!1,duplicate:!1},this.profile="",this.prompt="",this.routes=[]}Pi.prototype={drawCursor(e,t,i){const s=this.rect,n=m.pin.wMargin,o=e.measureText(this.name.slice(0,t)).width,r=this.is.left?s.x+n+o:s.x+s.w-n-e.measureText(this.name).width+o,a=i?m.std.cBlinkOn:m.std.cBlinkOff;$.cursor(e,r,s.y,m.std.wCursor,s.h,a)},render(e){const t=m.pin,i=this.rect,s=this.pxlen==0?this.name:this.withoutPrefix(),{cArrow:n,cText:o}=this.setColor(),r=i.y+(t.hPin-t.wArrow)/2,a=m.box.wLine/2,l=this.is.channel?$.triangleBall:$.leftTriangle,c=this.is.channel?$.ballTriangle:$.rightTriangle;if(this.is.left){const h=i.x+t.wOutside;this.is.multi?$.leftTextMulti(e,s,t.fMulti,o,i.x+m.pin.wMargin,i.y,i.w,i.h):$.leftText(e,s,o,i.x+m.pin.wMargin,i.y,i.w,i.h),this.is.input?c(e,h-a,r,t.hArrow,t.wArrow,n):l(e,h-t.hArrow+a,r,t.hArrow,t.wArrow,n)}else{const h=i.x+i.w-t.wOutside;this.is.multi?$.rightTextMulti(e,s,t.fMulti,o,i.x,i.y,i.w-m.pin.wMargin,i.h):$.rightText(e,s,o,i.x,i.y,i.w-m.pin.wMargin,i.h),this.is.input?l(e,h-t.hArrow+a,r,t.hArrow,t.wArrow,n):c(e,h-a,r,t.hArrow,t.wArrow,n)}this.is.duplicate&&$.rectRect(e,i.x,i.y,i.w,i.h,t.cBad,null)},setColor(){const e=this.is.hoverNok?m.pin.cBad:this.is.hoverOk?m.pin.cSelected:this.is.highLighted?m.pin.cHighLighted:this.is.selected?m.pin.cSelected:this.routes.length>0?m.pin.cConnected:m.pin.cNormal,t=this.is.hoverNok?m.pin.cBad:this.is.hoverOk?m.pin.cSelected:this.is.added?m.pin.cAdded:this.is.zombie?m.pin.cBad:this.is.highLighted?m.pin.cHighLighted:this.is.selected?m.pin.cSelected:this.routes.length>0?m.pin.cConnected:m.pin.cText;return{cArrow:e,cText:t}},center(){const e=m.pin.wOutside,t=this.rect;return this.is.left?{x:t.x+e,y:t.y+t.h/2}:{x:t.x+t.w-e,y:t.y+t.h/2}},canConnect(e){return!(this==e||this.is.input===e.is.input||(this.is.multi||e.is.multi)&&!this.hasMultiOverlap(e)||this.haveRoute(e))},areConnected(e){if(e.is.pin){if(e.is.input==this.is.input||(e.is.multi||this.is.multi)&&!this.hasMultiOverlap(e))return!1}else if(e.is.pad&&(e.proxy.is.input!=this.is.input||e.proxy.is.multi&&!this.hasMultiOverlap(e.proxy)))return!1;return!0},toJSON(){const e={name:this.name,kind:this.is.input?this.is.channel?"reply":"input":this.is.channel?"request":"output",editor:{id:this.wid,align:this.is.left?"left":"right"}};return this.is.proxy&&(e.editor.pad={rect:k.rectToString(this.pad.rect),align:this.pad.is.leftText?"left":"right"}),e},bluviz(){const e={name:this.name,kind:this.is.input?this.is.channel?"reply":"input":this.is.channel?"request":"output"},t=k.pinToString(this);return{blu:e,viz:t}},removeRoute(e){Ce(this.routes,e)},adjustRoutes(){for(const e of this.routes)e.adjust()},leftRightSwap(){const e=this.node.look.rect;this.rect.x=this.is.left?e.x+e.w-this.rect.w+m.pin.wOutside:e.x-m.pin.wOutside,this.is.left=!this.is.left,this.adjustRoutes()},drag(e){const t=this.node.look.rect,i=t.x+t.w/2;(this.is.left&&e.x>i||!this.is.left&&e.x<i)&&this.leftRightSwap();const s=this.node.look.findNextWidget(this,e,n=>n.is.pin||n.is.ifName);s&&([this.rect.y,s.rect.y]=[s.rect.y,this.rect.y],s.is.ifName&&this.ifNamePrefixCheck(),this.adjustRoutes(),s.is.pin&&s.adjustRoutes())},moveTo(e,t){e!=this.is.left&&this.leftRightSwap();const i=this.rect;for(const s of this.node.look.widgets){const n=s.rect;i.y>t&&n.y>=t&&n.y<i.y&&(n.y+=i.h,s.is.pin&&s.adjustRoutes()),i.y<t&&n.y<=t&&n.y>i.y&&(n.y-=i.h,s.is.pin&&s.adjustRoutes())}i.y=t,this.adjustRoutes()},disconnect(){const e=this.routes.slice();for(const t of e){const i=t.from==this?t.to:t.from;i.is.pin?t.rxtxPinPinDisconnect():i.is.pad?t.rxtxPinPadDisconnect():i.is.tack&&t.rxtxPinBusDisconnect(),t.remove()}},reconnect(e){this.routes=e;for(const t of e){const i=t.from==this?t.to:t.from;i.is.pin?(i.routes.push(t),t.rxtxPinPin()):i.is.pad?(i.routes.push(t),t.rxtxPinPad()):i.is.tack&&(i.bus.tacks.push(i),t.rxtxPinBus())}},haveRoute(e){for(const t of this.routes)if(t.from==e||t.to==e)return!0;return!1},ioSwitch(){return this.routes.length>0||this.is.proxy&&this.pad.routes.length>0?!1:(this.is.input=!this.is.input,!0)},channelOnOff(){this.is.channel=!this.is.channel;for(const e of this.routes){const t=e.from==this?e.to:e.from;t.is.tack&&(t.is.channel=this.is.channel)}return!0},doSelect(){this.is.selected=!0},unSelect(){this.is.selected=!1},highLight(){this.is.highLighted=!0},unHighLight(){this.is.highLighted=!1},highLightRoutes(){for(const e of this.routes){const t=e.from==this?e.to:e.from;if(t){if(t.is.pin){if(!this.areConnected(t))continue;e.highLight();continue}if(t.is.pad){if(!this.areConnected(t))continue;e.highLight();continue}t.is.tack&&(e.highLight(),t.bus.highLightRoutes(this))}}},unHighLightRoutes(){for(const e of this.routes){e.unHighLight();const t=e.from==this?e.to:e.from;if(t){if(t.is.pin){if(!this.areConnected(t))continue;t.is.proxy&&t.pad.unHighLightRoutes();continue}if(t.is.pad){if(!this.areConnected(t))continue;t.proxy.unHighLightRoutes();continue}t.is.tack&&t.bus.unHighLightRoutes(this)}}},makePadRect(e){const t=m.pad.wExtra+this.node.look.getTextWidth(this.name,this.is.multi);return this.is.left?{x:e.x,y:e.y-m.pad.hPad/2,w:t,h:m.pad.hPad}:{x:e.x,y:e.y-m.pad.hPad/2,w:t,h:m.pad.hPad}}};Object.assign(Pi.prototype,Fd);function ks(e,t,i,s){Pi.call(this,e,t,i,s),this.is.proxy=!0,this.pad=null}const Wd={makeConxList(e){var t;for(const i of this.routes){const s=i.from==this?i.to:i.from;this.areConnected(s)&&(s.is.pin?s.is.proxy?(t=s.pad)==null||t.makeConxList(e):e.push(s):s.is.pad?s.proxy.makeConxList(e):s.is.tack&&(s.bus.hasFilter()?e.push(s):s.bus.makeConxList(this,e)))}},nameChanged(e){var i;const t=this.node.pads.find(s=>s.proxy==this);if(!t){console.log(`** No pad was found for this pin "${this.name}" - pin was removed`),this.node.look.removePin(this);return}if(this.name.length>0){t.nameChange(this.name);return}((i=t.routes)==null?void 0:i.length)>0?this.restoreSavedName(e):(this.node.look.removePin(this),this.node.removePad(t))}};Object.assign(ks.prototype,Pi.prototype,Wd);function vs(e,t=null){this.rect={x:0,y:0,w:0,h:0},this.is={tack:!0,selected:!1,highLighted:!1,channel:!1,top:!1},this.bus=e,this.wid=t??e.generateWid(),this.segment=0,this.dir="",this.route=null}vs.prototype={render(e){const t=this.is.selected?m.bus.cSelected:this.is.highLighted?m.bus.cHighLighted:m.bus.cNormal;this.bus.is.filter&&$.filterSign(e,this.getContactPoint(),m.bus.wCable,t),$.tack(e,this.dir,this.is.channel,this.is.top,this.rect,m.route.wNormal,t)},setRoute(e){this.route=e,e.to?e.from||(e.from=this):e.to=this;const t=e.from==this?e.to:e.from;this.is.channel=t.is.pad?t.proxy.is.channel:t.is.channel,this.is.top=t.is.pad?!t.proxy.is.input:t.is.input,this.orient()},orient(){const e=h=>h.is.pin?h.is.input:!h.proxy.is.input,t=this.route.wire,i=this.bus.wire,s=this.route.to==this?this.route.from:this.route.to,n=this.route.to==this?t.at(-1):t[0],o=this.route.to==this?t.at(-2):t[1];this.segment=this.bus.hitSegment(n),this.segment==0&&(console.error("*** SEGMENT ON BUS NOT FOUND ***",s,this.bus),this.segment=1);const r=Math.floor(i[this.segment-1].y)===Math.floor(i[this.segment].y),a=this.rect,l=i[this.segment],c=m.bus.wNormal/2-1;r?(a.w=m.bus.wArrow,a.h=m.bus.hArrow,a.x=n.x-a.w/2,o.y>n.y?(a.y=l.y+c,this.dir=e(s)?"down":"up"):(a.y=l.y-a.h-c,this.dir=e(s)?"up":"down"),n.y=l.y):(a.w=m.bus.hArrow,a.h=m.bus.wArrow,a.y=n.y-a.h/2,o.x>n.x?(a.x=l.x+c,this.dir=e(s)?"right":"left"):(a.x=l.x-a.w-c,this.dir=e(s)?"left":"right"),n.x=l.x)},placeOnSegment(e,t){this.segment=t;const i=this.bus.wire[t-1],s=this.bus.wire[t];i.x==s.x?(this.dir="left",this.rect.x=i.x,this.rect.y=e.y):(this.dir="up",this.rect.x=e.x,this.rect.y=i.y)},horizontal(){return this.dir=="left"||this.dir=="right"},center(){const e=this.rect;if(this.segment==0)return null;const t=this.bus.wire[this.segment];return this.dir=="left"||this.dir=="right"?{x:t.x,y:e.y+e.h/2}:{x:e.x+e.w/2,y:t.y}},toJSON(){return k.routeToRaw(this.route)},overlap(e){const t=this.rect;return!(t.x>e.x+e.w||t.x+t.w<e.x||t.y>e.y+e.h||t.y+t.h<e.y)},remove(){this.route.remove()},removeRoute(e){this.bus.removeTack(this)},moveX(e){this.rect.x+=e;const t=this.route.from==this?this.route.wire[0]:this.route.wire.at(-1);t.x+=e,this.orient()},moveY(e){this.rect.y+=e;const t=this.route.from==this?this.route.wire[0]:this.route.wire.at(-1);t.y+=e,this.orient()},moveXY(e,t){this.rect.x+=e,this.rect.y+=t,this.route.wire.length==2&&this.route.fourPointRoute();const i=this.route.from==this?this.route.wire[0]:this.route.wire.at(-1),s=this.route.from==this?this.route.wire[1]:this.route.wire.at(-2);Math.abs(i.x-s.x)<Math.abs(i.y-s.y)?(i.x+=e,s.x+=e,i.y+=t):(i.y+=t,s.y+=t,i.x+=e),this.orient()},slide(e){let t=this.bus.wire[this.segment-1],i=this.bus.wire[this.segment];const s=this.rect,n=m.bus.wNormal;if(t.y==i.y){let o=Math.max(t.x,i.x)-s.w-n/2,r=Math.min(t.x,i.x)+n/2;s.x+=e.x,s.x=s.x>o?o:s.x<r?r:s.x}else{let o=Math.max(t.y,i.y)-s.h-n/2,r=Math.min(t.y,i.y)+n/2;s.y+=e.y,s.y=s.y>o?o:s.y<r?r:s.y}this.route.adjust()},fuseEndSegment(){if(this.route.wire.length<4)return;const e=this.route,t=e.wire,[i,s,n,o]=this==e.from?[t[0],t[1],t[2],!0]:[t.at(-1),t.at(-2),t.at(-3),!1];i.y==s.y&&Math.abs(n.y-s.y)<m.route.tooClose?(i.y=n.y,o?e.removeTwoPoints(1,t):e.removeTwoPoints(t.length-3,t),this.orient()):i.x==s.x&&Math.abs(s.x-n.x)<m.route.tooClose&&(i.x=n.x,o?e.removeTwoPoints(1,t):e.removeTwoPoints(t.length-3,t),this.orient())},restore(e){this.route=e,this.bus.tacks.push(this),this.orient()},getOther(){return this.route.from==this?this.route.to:this.route.from},getOtherPin(){const e=this.route.from==this?this.route.to:this.route.from;return e.is.pin?e:e.is.pad?e.proxy:null},getContactPoint(){return this.route.from==this?this.route.wire[0]:this.route.wire.at(-1)},incoming(){const e=this.route.from==this?this.route.to:this.route.from;return e.is.pin?!e.is.input:e.is.pad?e.proxy.is.input:!1},highLightRoutes(){},unHighLightRoutes(){}};function qn(e,t){this.rect={...e},this.is={busLabel:!0,beingEdited:!1,highLighted:!1,horizontal:!0},this.text=t.name,this.bus=t}const Hd={makeRect(e,t,i,s){const n=this.rect;this.is.horizontal=Math.abs(e.x-t.x)>0,this.is.horizontal?(n.x=e.x<t.x?e.x-i:e.x,n.y=e.y-s/2,n.h=s,n.w=i):(n.x=e.x-s/2,n.y=e.y<t.y?e.y-i:e.y,n.h=i,n.w=s,e.y==t.y&&this==this.bus.startLabel&&(n.y=e.y-i))},place(){const e=m.bus,t=this.bus.wire,i=this.text.length*e.sChar+2*e.hLabel;this==this.bus.startLabel?this.makeRect(t[0],t[1],i,e.hLabel):this.makeRect(t.at(-1),t.at(-2),i,e.hLabel)},startEdit(){return this.is.beingEdited=!0,"text"},endEdit(e){this.setText(this.text),this.is.beingEdited=!1},setText(e){const t=this==this.bus.startLabel?this.bus.endLabel:this.bus.startLabel;this.bus.name=e,this.text=e,t.text=e,this.place(),t.place()},drawCursor(e,t,i){const s=$.centerTextCursor(e,this.rect,this.text,t),n=i?m.std.cBlinkOn:m.std.cBlinkOff;this.is.horizontal?$.cursor(e,s.x,s.y,m.std.wCursor,this.rect.h,n):$.cursor(e,this.rect.x,s.y+.75*this.rect.w,this.rect.w,m.std.wCursor,n)},render(e,t){if(this.is.beingEdited){const r=this==this.bus.startLabel?this.bus.endLabel:this.bus.startLabel;r.text=this.text,this.place(),r.place()}const i=m.bus,s=this.rect,n=this.bus.is,o=n.hoverNok?i.cBad:n.selected||n.hoverOk?i.cSelected:n.highLighted?i.cHighLighted:i.cNormal;this.bus.is.filter&&$.filterSymbol(e,s.x-i.wFilter,s.y-i.wFilter,i.wFilter,o),this.bus.is.cable?this.is.horizontal?$.hCableLabel(e,this.text,s.x,s.y,s.w,s.h,i.radius,o,i.cText):$.vCableLabel(e,this.text,s.x,s.y,s.w,s.h,i.radius,o,i.cText):this.is.horizontal?$.hBusbarLabel(e,this.text,s.x,s.y,s.w,s.h,i.radius,o,i.cText):$.vBusbarLabel(e,this.text,s.x,s.y,s.w,s.h,i.radius,o,i.cText)},setSize(e){return this.rect.w=e.measureText(this.text).width+2*m.bus.hLabel,this.rect.h=m.bus.hLabel,this},move(e,t){this.rect.x+=e,this.rect.y+=t},highLight(){this.is.highLighted=!0},unHighLight(){this.is.highLighted=!1},inside(e){return at({x:this.rect.x,y:this.rect.y},e)}};Object.assign(qn.prototype,Hd);function Qs(e,t,i){this.rect={...e},this.node=i,this.is={ifName:!0,added:!1,zombie:!1,selected:!1,highLighted:!1},this.text=t??"",this.wid=0}Qs.prototype={startEdit(){return"text"},endEdit(e){this.text=k.cleanInput(this.text),this.node.look.ifNameChanged(this,e)},drawCursor(e,t,i){const s=$.centerTextCursor(e,this.rect,this.text,t),n=i?m.std.cBlinkOn:m.std.cBlinkOff;$.cursor(e,s.x,s.y,m.std.wCursor,this.rect.h,n)},render(e,t){const i=m.ifName,s=this.is.added?i.cAdded:this.is.zombie?i.cBad:this.is.highLighted?i.cHighLighted:this.is.selected?i.cSelected:i.cNormal;$.ifName(e,this.text,{line:i.cBackground,text:s},this.rect)},toJSON(){return{ifPins:this.text,id:this.wid}},bluviz(){return{blu:{interface:this.text},viz:k.ifNameToString(this)}},drag(e){this.node.look.rect;const t=this.node.look.findNextWidget(this,e,i=>i.is.pin||i.is.ifName);t&&([this.rect.y,t.rect.y]=[t.rect.y,this.rect.y],t.is.pin&&t.ifNamePrefixCheck(),t.is.pin&&t.adjustRoutes())},moveTo(e){const t=this.rect;for(const i of this.node.look.widgets){const s=i.rect;t.y>e&&s.y>=e&&s.y<t.y&&(s.y+=t.h,i.is.pin&&i.adjustRoutes()),t.y<e&&s.y<=e&&s.y>t.y&&(s.y-=t.h,i.is.pin&&i.adjustRoutes())}t.y=e},highLight(){this.is.highLighted=!0},unHighLight(){this.is.highLighted=!1},doSelect(){this.is.selected=!0},unSelect(){this.is.selected=!1}};function en(e,t,i){this.rect={...e},this.node=i,this.is={label:!0},this.text=t}en.prototype={startEdit(){return"text"},endEdit(e){},drawCursor(e,t,i){const s=this.rect,n=$.labelCursor(e,this.text,s.x,s.y,s.w,s.h,t),o=i?m.std.cBlinkOn:m.std.cBlinkOff;$.cursor(e,n.x,n.y,m.std.wCursor,s.h,o)},render(e,t){const{x:i,y:s,w:n,h:o}=this.rect;$.labelText(e,this.text,m.label.font,m.label.cNormal,i,s,n,o)},toJSON(){return this.text}};function xn(e,t){this.rect={...e},this.is={icon:!0,bad:!1,highLighted:!1},this.type=t,this.render=()=>{console.warn("Missing render function for icon ",this.type)}}xn.prototype={setRender(){this.render=this.renderFunctions[this.type]||this.renderFunctions.dummy},switchType(e){this.type=e,this.setRender()},renderFunctions:{link(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?m.icon.cHighLighted:this.is.bad?m.icon.cBadLink:m.icon.cLink;it.link(e,t,i,s,n,o)},lock(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?m.icon.cHighLighted:this.is.bad?m.icon.cBadLink:m.icon.cLink;it.lock(e,t,i,s,n,o)},factory(e){const{x:t,y:i,w:s,h:n}={...this.rect};it.factory(e,t,i,s,n,m.icon.cSrc)},group(e){const{x:t,y:i,w:s,h:n}={...this.rect};it.group(e,t,i,s,n,m.icon.cGroup)},cog(e){const{x:t,y:i,w:s,h:n}={...this.rect};it.cog(e,t,i,s,n,m.icon.cCog,m.header.cBackground)},pulse(e){const{x:t,y:i,w:s,h:n}={...this.rect};it.pulse(e,t,i,s,n,m.icon.cPulse,m.header.cBackground)},comment(e){const{x:t,y:i,w:s,h:n}={...this.rect};it.comment(e,t,i,s,n,m.icon.cComment)},close(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?m.view.cClose:m.view.cDim;it.close(e,t,i,s,n,o)},big(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?m.view.cFullscreen:m.view.cDim;it.bigView(e,t,i,s,n,o)},small(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?m.view.cFullscreen:m.view.cDim;it.smallView(e,t,i,s,n,o)},calibrate(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?m.view.cCalibrate:m.view.cDim;it.calibrate(e,t,i,s,n,o)},grid(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?m.view.cGrid:m.view.cDim;it.grid(e,t,i,s,n,o)},dummy(e){console.warn("Cannot render unknown icon type:",this)}},toJSON(){}};function aa(e,t){this.rect={...e},this.is={viewTitle:!0,highLighted:!1},this.node=t,this.text=t.name}aa.prototype={startEdit(){return"text"},endEdit(e){node.name=this.text},render(e){const t=this.rect,i=m.view,s=this.is.highLighted?i.cHighLight:i.cLine,n=this.is.highLighted?i.cTitleHighLight:i.cTitle;if($.roundedHeader(e,t.x,t.y,t.w,i.hHeader,i.rCorner,i.wLine,null,s),$.centerText(e,this.node.name,m.view.fHeader,n,t.x,t.y,t.w,t.h),this.textEdit){let o=$.centerTextCursor(e,t,this.node.name,this.textEdit.cursor);$.cursor(e,o.x,o.y,2,t.h,n)}}};function la(e){this.rect={...e},this.is={viewBox:!0,highLighted:!1}}la.prototype={render(e){const t=this.rect,i=m.view,s=this.is.highLighted?i.cHighLight:i.cLine;$.viewRect(e,t.x,t.y,t.w,t.h,i.rCorner,i.wLine,s,i.cBackground)}};const $d={addWidget(e){this.widgets.push(e),this.rect.h+=e.rect.h;const t=this.widgets.find(i=>i.is.box);t&&t.increaseHeight(e.rect.h),e.wid!=null&&(e.wid=this.generateWid())},generateWid(){return++this.widGenerator},addBox(){const e=new Ks(this.rect,this.node);this.widgets.push(e)},findLabel(){for(const e of this.widgets)if(e.is.label)return e;return null},setDuplicatePin(e){e.is.duplicate=!1;const t=[];for(const i of this.widgets)!i.is.pin||i==e||(i.is.duplicate&&t.push(i),(e.nameClash(i)||e.hasFullNameMatch(i))&&(e.is.duplicate=i.is.duplicate=!0));if(t.length!=0){for(const i of t)i.is.duplicate=!1;for(let i=0;i<t.length;i++)if(!t[i].is.duplicate)for(let s=i+1;s<t.length;s++)(t[i].nameClash(t[s])||t[i].hasFullNameMatch(t[s]))&&(t[i].is.duplicate=t[s].is.duplicate=!0)}},makePlace(e,t){let i=this.rect.y+this.rect.h-m.look.hBottom;if(!e)return i;for(const s of this.widgets)(s.is.pin||s.is.ifName)&&s.rect.y+s.rect.h/2>e.y&&(s.rect.y<i&&(i=s.rect.y),s.rect.y+=t,s.routes&&s.adjustRoutes());return i},pinRectangle(e,t,i,s=!1){const n=m.pin;let o=this.rect;const r=n.wMargin+this.getTextWidth(e,s);r>o.w&&this.wider(r-o.w);const a=this.makePlace({x:0,y:t},m.pin.hPin);return i?{x:o.x-n.wOutside,y:a,w:r,h:n.hPin}:{x:o.x+o.w-r+n.wOutside,y:a,w:r,h:n.hPin}},nextPinPosition(e){const t=this.rect;return{x:e?t.x:t.x+t.w,y:t.y+t.h-m.look.hBottom}},shiftUp(e,t){for(const i of this.widgets)if(i.is.box)i.rect.h-=t;else if(i.rect.y>e&&(i.rect.y-=t,i.routes))for(const s of i.routes)s.clampToWidget(i);this.rect.h-=t},movePin(e,t){const i=e.rect.y,s=e.rect.h;e.rect.y=this.makePlace(t,e.rect.h);for(const n of e.routes)n.clampToWidget(e);for(const n of this.widgets)if(n.rect.y>i&&(n.rect.y-=s,n.routes))for(const o of n.routes)o.clampToWidget(n)},ifNameChanged(e,t){if(this.interfaceChangePrefix(e),e.text.length>0){let i=this.getTextWidth(e.text);i>this.rect.w&&this.wider(i-this.rect.w)}else e.node.look.removeInterfaceName(e)},NEW_findPin(e,t=!0){for(const i of this.widgets)if(i.is.pin&&i.name==e)return i;return null},findPin(e,t=!0){for(const i of this.widgets)if(i.is.pin&&i.name==e&&i.is.input==t)return i;return null},findInterfaceName(e){for(const t of this.widgets)if(t.is.ifName&&t.text==e)return t;return null}},H={nothing:0,node:1,pin:2,ifName:3,icon:4,header:5,label:6,pad:7,padArrow:8,route:9,busSegment:10,busLabel:11,tack:12,selection:13},$e=0,Me=1,Be=2,Jn=4,Bd={keyMask(e){let t=$e;return t|=e.shiftKey?Me:0,t|=e.ctrlKey?Be:0,t|=e.altKey?Jn:0,t},mouseHit(e){const t=this.hit;if(this.selection.what!=C.nothing&&this.selection.what!=C.singleNode&&([t.what,t.selection,t.node]=this.selection.hitTest(e),t.what!=H.nothing)||!this.root)return;const i=this.root.nodes;for(let s=i.length-1;s>=0;s--)if([t.what,t.node,t.lookWidget]=i[s].hitTest(e),t.what!=H.nothing)return;for(const s of this.root.pads)if([t.what,t.pad]=s.hitTest(e),t.what!=H.nothing)return;for(const s of this.root.buses)if([t.what,t.bus,t.busLabel,t.tack,t.busSegment]=s.hitTest(e),t.what!=H.nothing)return;this.mouseHitRoutes(e)},mouseHitRoutes(e){const t=this.hit;for(const i of this.root.nodes)if([t.what,t.route,t.routeSegment]=i.hitRoute(e),t.what!=H.nothing)return;for(const i of this.root.pads)if([t.what,t.route,t.routeSegment]=i.hitRoute(e),t.what!=H.nothing)return;for(const i of this.root.buses)if([t.what,t.route,t.routeSegment]=i.hitRoute(e),t.what!=H.nothing)return},onDblClick(e,t){const i=this.hit;switch(i.what){case H.pin:case H.ifName:if(!i.node||i.node.cannotBeModified())return;u.doEdit("widgetTextEdit",{view:this,widget:i.lookWidget});break;case H.header:u.doEdit("widgetTextEdit",{view:this,widget:i.lookWidget});break;case H.label:u.doEdit("widgetTextEdit",{view:this,widget:i.lookWidget});break;case H.busLabel:u.doEdit("widgetTextEdit",{view:this,widget:i.busLabel});break;case H.pad:u.doEdit("widgetTextEdit",{view:this,widget:i.pad});break}},onWheel(e,t){const i=this.tf;let s=t.deltaY>0?.9:1.1;i.dx=i.dx+e.x*i.sx*(1-s),i.dy=i.dy+e.y*i.sy*(1-s),i.sx*=s,i.sy*=s}},jd={pinAreaStart(e,t){this.reset();const i=e.look.rect;this.yWidget=t.y,this.what=C.pinArea,this.activate(i.x-m.pin.wOutside,t.y,i.w+2*m.pin.wOutside,0,m.selection.cRect)},pinAreaResize(e,t){const i=e.look.rect;if(t.y>i.y&&t.y<i.y+i.h){const s=this.yWidget;t.y>s?(this.rect.y=s,this.rect.h=t.y-s):(this.rect.y=t.y,this.rect.h=s-t.y),this.widgets=[];const n=m.pin.hPin/2;for(const o of e.look.widgets)(o.is.pin||o.is.ifName)&&(o.rect.y+n>this.rect.y&&o.rect.y+n<this.rect.y+this.rect.h?(this.widgets.push(o),o.is.selected=!0):o.is.selected=!1)}},pinAreaSelect(e){if(e!=null&&e.length){this.widgets.length=0;for(const t of e)(t.is.pin||t.is.ifName)&&(this.widgets.push(t),t.doSelect());this.pinAreaRectangle(),this.what=C.pinArea}},pinAreaRectangle(){if(!this.widgets.length)return;this.widgets.sort((s,n)=>s.rect.y-n.rect.y);const e=this.widgets[0].node.look,t=this.widgets[0].rect,i=this.widgets.at(-1).rect;this.activate(e.rect.x-m.pin.wOutside,t.y,e.rect.w+2*m.pin.wOutside,i.y+i.h-t.y,m.selection.cRect)},widgetsDrag(e){if(this.widgets.length==0)return;const t=this.widgets[0].node;this.rect.y+e.y<t.look.rect.y+m.header.hHeader||this.rect.y+e.y>t.look.rect.y+t.look.rect.h||(this.rect.y+=e.y)},interfaceSelect(e,t){this.reset();const i=e.look.getInterface(t);this.pinAreaSelect(i),this.what=C.ifArea},extend(e){this.what!=C.ifArea||e.node!=this.widgets[0].node||(this.widgets.push(e),this.pinAreaRectangle())},adjustForNewWidget(e){switch(this.what){case C.singleNode:this.switchToWidget(e);break;case C.ifArea:if(e.node!=this.widgets[0].node)return;e.is.pin?(e.doSelect(),this.widgets.push(e),this.pinAreaRectangle()):e.is.ifName&&(this.reset(),e.doSelect(),this.widgets=[e],this.pinAreaRectangle());break}},adjustForRemovedWidget(e){switch(this.what){case C.singleNode:const t=this.widgetAbove(e);if(t)return this.switchToWidget(t);const i=this.widgetBelow(e);if(i)return this.switchToWidget(i);break;case C.ifArea:if(e.node!=this.widgets[0].node)return;if(e.is.pin){const s=this.widgets.findIndex(n=>n===e);s!=-1&&this.widgets.splice(s,1),this.pinAreaRectangle()}break}},behind(){if(this.what!==C.singleNode&&this.what!==C.ifArea)return null;const e=this.widgets.at(-1);return e?{x:e.rect.x,y:e.rect.y+e.rect.h}:this.nodes[0]?{x:0,y:this.nodes[0].look.makePlace(null,0)}:null},whereToAdd(){var e;switch(this.what){case C.singleNode:{const t=this.getSingleNode(),i=this.getSelectedWidget(),s=i?{x:i.is.left?i.rect.x:i.rect.x+i.rect.w,y:i.rect.y+i.rect.h}:{x:0,y:t.look.makePlace(null,0)};return[t,s]}case C.ifArea:{const t=(e=this.getSelectedWidget())==null?void 0:e.node,i=this.behind();return[t,i]}}}},C={nothing:0,freeRect:1,pinArea:2,ifArea:3,singleNode:4,multiNode:5};function Ts(e=null){this.rect={x:0,y:0,w:0,h:0},this.yWidget=0,this.color=m.selection.cRect,this.what=C.nothing,this.viewPath=e?e.getNamePath():"",this.nodes=[],this.pads=[],this.buses=[],this.tacks=[],this.widgets=[]}Ts.prototype={render(e){if(this.what===C.freeRect||this.what===C.pinArea||this.what===C.ifArea){const t=this.rect;$.roundedRect(e,t.x,t.y,t.w,t.h,m.selection.rCorner,1,this.color.slice(0,7),this.color)}},reset(){this.what=C.nothing,this.yWidget=0;for(const e of this.widgets)e.unSelect();for(const e of this.nodes)e.unSelect();this.nodes.length=0,this.pads.length=0,this.buses.length=0,this.widgets.length=0,this.tacks.length=0},shallowCopy(){var t,i,s,n,o;const e=new Ts;return e.rect={...this.rect},e.yWidget=this.yWidget,e.color=this.color,e.what=this.what,e.viewPath=this.viewPath,e.nodes=(t=this.nodes)==null?void 0:t.slice(),e.pads=(i=this.pads)==null?void 0:i.slice(),e.buses=(s=this.buses)==null?void 0:s.slice(),e.tacks=(n=this.tacks)==null?void 0:n.slice(),e.widgets=(o=this.widgets)==null?void 0:o.slice(),e},canCancel(e){return e.what==H.selection?!1:this.what===C.freeRect||this.what===C.pinArea||this.what===C.ifArea},setRect(e,t,i,s){const n=this.rect;n.x=e,n.y=t,n.w=i,n.h=s},activate(e,t,i,s,n){this.setRect(e,t,i,s),n&&(this.color=n)},freeStart(e){this.reset(),this.what=C.freeRect,this.setRect(e.x,e.y,0,0)},singleNode(e){this.reset(),this.nodes=[e],this.what=C.singleNode,e.doSelect()},singleNodeAndWidget(e,t){this.reset(),this.singleNode(e),this.widgets=[t],t.doSelect()},extend(e){if(this.nodes.length<1){this.singleNode(e);return}if(this.nodes.includes(e)){Ce(this.nodes,e),e.unSelect();return}this.nodes.push(e),e.doSelect(),this.what=C.multiNode},getSingleNode(){return this.what==C.singleNode?this.nodes[0]:null},getSelectedWidget(){return this.what==C.singleNode?this.widgets[0]:this.what===C.ifArea?this.widgets[0]:null},getPinAreaNode(){return(this.what===C.pinArea||this.what===C.ifArea)&&this.widgets[0]?this.widgets[0].node:null},switchToWidget(e){var t;e&&((t=this.widgets[0])==null||t.unSelect(),e.doSelect(),this.widgets[0]=e)},widgetBelow(e){let t=null;for(const i of e.node.look.widgets)(i.is.pin||i.is.ifName)&&i.rect.y>e.rect.y&&(!t||i.rect.y<t.rect.y)&&(t=i);return t},widgetAbove(e){let t=null;for(const i of e.node.look.widgets)(i.is.pin||i.is.ifName)&&i.rect.y<e.rect.y&&(!t||i.rect.y>t.rect.y)&&(t=i);return t},hitTest(e){if((this.what==C.freeRect||this.what==C.pinArea||this.what==C.ifArea)&&at(e,this.rect))return[H.selection,this,null];for(let t=this.nodes.length-1;t>=0;t--)if(at(e,this.nodes[t].look.rect))return[H.selection,this,this.nodes[t]];return[H.nothing,null,null]},widgetHit(e){var t;if(!((t=this.widgets)!=null&&t.length))return null;for(const i of this.widgets)if(e.y>i.rect.y&&e.y<i.rect.y+i.rect.h)return i;return null},setColor(e){this.color=e},resize(e,t){this.rect.w+=e,this.rect.h+=t},move(e){this.rect.x+=e.x,this.rect.y+=e.y},drag(e){for(const t of this.nodes)t.look.moveDelta(e.x,e.y);for(const t of this.pads)t.move(e);if(this.nodes.length>0)for(const t of this.buses)t.move(e.x,e.y);else for(const t of this.tacks)t.slide(e);for(const t of this.nodes)t.look.adjustRoutes();for(const t of this.pads)t.adjustRoutes();for(const t of this.buses)t.adjustRoutes();this.rect.x+=e.x,this.rect.y+=e.y},topLeftNode(){if(this.nodes.length==0)return null;let e=this.nodes[0];for(const t of this.nodes)t.look.rect.y<e.look.rect.y&&t.look.rect.x<e.look.rect.x&&(e=t);return e},makeViewRect(){const e=this.rect;return{x:e.x-m.view.wExtra,y:e.y-m.view.hExtra,w:e.w+2*m.view.wExtra,h:e.h+2*m.view.hExtra}},makeLookRect(){const e=this.topLeftNode(),t=this.rect,i=e?e.look.rect.x:t.x,s=e?e.look.rect.y:t.y;return{x:i,y:s,w:0,h:0}},adjustPaths(e){if(this.nodes)for(const t of this.nodes)t.adjustPaths(e)}};Object.assign(Ts.prototype,jd);const zd={onMouseMove(e,t){let i={x:t.movementX/this.tf.sx,y:t.movementY/this.tf.sy};const s=this.state;switch(s.action){case S.nothing:return this.idleMove(e),!1;case S.panning:return this.tf.dx+=t.movementX,this.tf.dy+=t.movementY,!0;case S.nodeDrag:return s.node.move(i),!0;case S.routeDraw:return this.drawRoute(s.route,e),!0;case S.routeDrag:return s.route.moveSegment(s.routeSegment,i),!0;case S.selection:return this.selection.resize(i.x,i.y),!0;case S.selectionDrag:return this.selection.drag(i),!0;case S.pinAreaSelect:return this.selection.pinAreaResize(s.node,e),!0;case S.padDrag:return s.pad.drag(e,i),!0;case S.busDraw:return s.bus.drawXY(e),!0;case S.busRedraw:return s.bus.resumeDrawXY(s.busLabel,e,i),!0;case S.busSegmentDrag:return s.bus.moveSegment(s.busSegment,i),!0;case S.busDrag:return s.bus.drag(i),!0;case S.tackDrag:return s.tack.slide(i),!0;case S.pinDrag:return s.lookWidget.drag(e),!0;case S.pinAreaDrag:return!0;case S.interfaceNameDrag:return s.lookWidget.drag(e),!0;case S.interfaceDrag:return this.selection.widgetsDrag(i),this.selection.widgets[0].node.look.swapInterface(e,this.selection.widgets),!0;case S.pinClicked:switch(this.keyMask(t)){case $e:return at(e,s.lookWidget.node.look.rect)?!1:(this.stateSwitch(S.routeDraw),s.route=new bt(s.lookWidget,null),s.route.select(),s.lookWidget.is.multi&&s.route.setTwistedPair(),s.lookWidget.routes.push(s.route),!0);case Me:return s.lookWidget.unHighLightRoutes(),this.stateSwitch(S.pinAreaSelect),this.selection.pinAreaStart(s.node,e),!0;case Be:{const n=s.lookWidget;return n.is.selected=!0,this.stateSwitch(S.pinDrag),u.doEdit("pinDrag",{pin:n}),!0}case Be|Me:{if(at(e,s.lookWidget.node.look.rect))return!1;if(s.lookWidget.unHighLightRoutes(),u.doEdit("extrudePad",{view:this,pos:e}),this.state.pad){this.stateSwitch(S.padDrag);for(const n of this.state.pad.routes)n.highLight()}return!0}}return!1;case S.interfaceNameClicked:return!at(e,this.selection.widgets[0].rect);case S.padArrowClicked:return at(e,s.pad.rect)||(this.stateSwitch(S.routeDraw),s.route=new bt(s.pad,null),s.pad.proxy.is.multi&&s.route.setTwistedPair(),s.route.select(),s.pad.routes.push(s.route)),!0;default:return!1}},idleMove(e){return this.hitTimer,!1},drawRoute(e,t){this.mouseHit(t);const i=this.hit,s=i.what==H.pin?i.lookWidget:i.what==H.pad?i.pad:i.what==H.busSegment?i.bus:null;this.hover(s,s?e.checkConxType(e.from,s):!1),s&&(s.is.pin||s.is.pad)?e.endpoint(s):e.drawXY(t)},hover(e,t){this.hit;const i=this.state;i.hoverOver!=e&&(e?(e.is.hoverOk=t,e.is.hoverNok=!t,i.hoverOver&&(this.state.hoverOver.is.hoverOk=this.state.hoverOver.is.hoverNok=!1),i.hoverOver=e):i.hoverOver&&(this.state.hoverOver.is.hoverOk=this.state.hoverOver.is.hoverNok=!1,this.state.hoverOver=null))},stopHover(){this.state.hoverOver&&(this.state.hoverOver.is.hoverOk=this.state.hoverOver.is.hoverNok=!1,this.state.hoverOver=null)}},Ud={saveHitSpot(e,t){const i=this.hit;i.xyLocal.x=e.x,i.xyLocal.y=e.y,i.xyScreen.x=t.x,i.xyScreen.y=t.y},onMouseDown(e,t){const i=this.state,s=this.hit;this.saveHitSpot(e,t);const n=this.keyMask(t);switch(n===(Be|Jn)?this.mouseHitRoutes(e):this.mouseHit(e),this.selection.canCancel(s)&&this.selection.reset(),s.what){case H.pin:switch(n){case $e:case Be|Me:i.lookWidget=s.lookWidget,i.node=s.node,s.lookWidget.highLightRoutes(),this.stateSwitch(S.pinClicked),this.selection.singleNodeAndWidget(s.node,s.lookWidget);break;case Me:i.node=s.node,this.stateSwitch(S.pinAreaSelect),this.selection.pinAreaStart(s.node,e);break;case Be:{const o=s.lookWidget;i.lookWidget=o,this.selection.singleNodeAndWidget(s.node,s.lookWidget),this.stateSwitch(S.pinDrag),u.doEdit("pinDrag",{pin:o})}break}break;case H.ifName:switch(n){case $e:this.selection.interfaceSelect(s.node,s.lookWidget),this.selection.widgets=s.node.look.highLightInterface(s.lookWidget),this.stateSwitch(S.interfaceNameClicked);break;case Me:i.node=s.node,this.stateSwitch(S.pinAreaSelect),this.selection.pinAreaStart(s.node,e);break;case Be:{this.selection.singleNodeAndWidget(s.node,s.lookWidget),this.selection.widgets=s.node.look.highLightInterface(s.lookWidget),this.selection.pinAreaRectangle();const o=this.selection.widgets;u.doEdit("interfaceDrag",{group:o.slice(),oldY:o[0].rect.y,newY:o[0].rect.y}),this.stateSwitch(S.interfaceDrag)}break;case Be|Me:u.doEdit("interfaceNameDrag",{ifName:s.lookWidget}),this.state.lookWidget=s.lookWidget,this.selection.singleNodeAndWidget(s.node,s.lookWidget),this.stateSwitch(S.interfaceNameDrag);break}break;case H.icon:switch(n){case $e:case Me:this.selection.singleNode(s.node),s.node.iconClick(this,s.lookWidget,{x:t.clientX,y:t.clientY});break;case Be:this.selection.singleNode(s.node),s.node.iconCtrlClick(this,s.lookWidget,{x:t.clientX,y:t.clientY},u);break}break;case H.header:switch(n){case $e:case Me:this.selection.singleNode(s.node),this.stateSwitch(S.nodeDrag),i.node=s.node,u.doEdit("nodeDrag",{view:this,node:s.node});break;case Be:this.selection.extend(s.node),this.stateSwitch(S.selectionDrag),u.doEdit("selectionDrag",{view:this});break}break;case H.node:switch(n){case $e:this.selection.singleNode(s.node),this.stateSwitch(S.nodeDrag),i.node=s.node,u.doEdit("nodeDrag",{view:this,node:s.node});break;case Me:i.node=s.node,this.stateSwitch(S.pinAreaSelect),this.selection.pinAreaStart(s.node,e);break;case Be:this.selection.extend(s.node),this.stateSwitch(S.selectionDrag),u.doEdit("selectionDrag",{view:this});break}break;case H.route:switch(n){case $e:case Be|Jn:u.doEdit("routeDrag",{route:s.route}),s.route.select(),this.stateSwitch(S.routeDrag),i.route=s.route,i.routeSegment=s.routeSegment;break;case Me:u.doEdit("deleteRoute",{route:s.route}),s.route.resumeDrawing(s.routeSegment,e),s.route.select(),this.stateSwitch(S.routeDraw),i.route=s.route;break}break;case H.pad:switch(n){case $e:i.pad=s.pad,s.pad.checkRoutesDirection(),s.pad.highLightRoutes(),this.stateSwitch(S.padDrag),u.doEdit("padDrag",{pad:s.pad});break}break;case H.padArrow:switch(n){case $e:{i.pad=s.pad;for(const o of s.pad.routes)o.highLight();this.stateSwitch(S.padArrowClicked)}break}break;case H.selection:switch(n){case $e:if(this.selection.what==C.freeRect)u.doEdit("selectionDrag",{view:this}),this.stateSwitch(S.selectionDrag);else if(this.selection.what===C.ifArea){const o=this.selection.widgetHit(e);if(!o)return;o.is.ifName?(this.selection.widgets=o.node.look.highLightInterface(o),this.stateSwitch(S.interfaceNameClicked)):(i.lookWidget=o,i.node=o.node,o.highLightRoutes(),this.stateSwitch(S.pinClicked),this.selection.singleNodeAndWidget(o.node,o))}break;case Me:s.node?(i.node=s.node,this.selection.pinAreaStart(s.node,e),this.stateSwitch(S.pinAreaSelect)):this.selection.what===C.pinArea||this.selection.what===C.ifArea?(this.selection.pinAreaStart(this.selection.getPinAreaNode(),e),this.stateSwitch(S.pinAreaSelect)):(this.selection.freeStart(e),this.stateSwitch(S.selection));break;case Be:switch(this.selection.what){case C.singleNode:case C.multiNode:s.node&&this.selection.extend(s.node);break;case C.ifArea:this.stateSwitch(S.interfaceDrag);const o=this.selection.widgets;u.doEdit("interfaceDrag",{group:o.slice(),oldY:o[0].rect.y,newY:o[0].rect.y});break}break;case Be|Me:if(this.selection.what==C.ifArea){const o=this.selection.widgetHit(e);if(!o)return;o.is.ifName&&(u.doEdit("interfaceNameDrag",{ifName:o}),this.state.lookWidget=s.lookWidget,this.selection.singleNodeAndWidget(o.node,o),this.stateSwitch(S.interfaceNameDrag))}break}break;case H.busLabel:switch(n){case $e:this.stateSwitch(S.busRedraw),i.bus=s.bus,i.busLabel=s.busLabel,i.bus.is.selected=!0,i.bus.highLight(),u.doEdit("busDraw",{bus:s.bus});break}break;case H.busSegment:switch(n){case $e:i.bus=s.bus,i.busSegment=s.busSegment,i.bus.is.selected=!0,s.bus.highLight(),s.bus.singleSegment()?(this.stateSwitch(S.busDrag),u.doEdit("busDrag",{bus:s.bus})):(this.stateSwitch(S.busSegmentDrag),u.doEdit("busSegmentDrag",{bus:s.bus}));break;case Me:break;case Be:i.bus=s.bus,i.bus.is.selected=!0,this.stateSwitch(S.busDrag),u.doEdit("busDrag",{bus:s.bus});break}break;case H.tack:switch(n){case $e:this.stateSwitch(S.tackDrag),i.tack=s.tack,i.tack.route.select(),u.doEdit("tackDrag",{tack:s.tack});break;case Me:{const o=s.tack.route;this.stateSwitch(S.routeDraw),i.route=o,u.doEdit("deleteRoute",{route:o}),o.resumeDrawing(o.wire.length-1,e),o.select()}break}break;case H.nothing:switch(n){case $e:this.stateSwitch(S.panning),u.doEdit("panning",{view:this});break;case Me:this.stateSwitch(S.selection),this.selection.freeStart(e);break}break}}},Vd={onMouseUp(e,t){this.mouseHit(e);let i=null;switch(this.state.action){case S.routeDraw:const s=this.state.route;s.unSelect(),s.from.unHighLightRoutes(),this.stopHover();const n=this.hit.lookWidget??this.hit.bus??this.hit.pad??null;s.connect(n)?u.doEdit("routeDraw",{route:s}):s.popFromRoute();break;case S.routeDrag:this.state.route.endDrag(this.state.routeSegment),this.state.route.unSelect(),u.getParam().newWire=this.state.route.copyWire();break;case S.selection:this.selection.rect&&this.getSelected(this.selection.rect);break;case S.selectionDrag:u.getParam().newPos={x:this.selection.rect.x,y:this.selection.rect.y};break;case S.pinAreaSelect:break;case S.nodeDrag:const o=this.state.node;o.look.snapRoutes();const r=u.getParam();r.newPos={x:o.look.rect.x,y:o.look.rect.y},yd(r.oldPos,r.newPos)<m.look.smallMove&&(o.move({x:r.oldPos.x-r.newPos.x,y:0}),u.dropLastEdit());break;case S.busDraw:case S.busRedraw:this.state.bus.is.selected=!1,this.state.bus.unHighLight(),u.getParam().newWire=this.state.bus.copyWire();break;case S.busSegmentDrag:this.state.bus.fuseSegment(this.state.busSegment),this.state.bus.is.selected=!1,this.state.bus.unHighLight(),i=u.getParam(),i.newWire=this.state.bus.copyWire(),i.newTackWires=this.state.bus.copyTackWires();break;case S.busDrag:this.state.bus.is.selected=!1,this.state.bus.unHighLight(),i=u.getParam(),i.newWire=this.state.bus.copyWire(),i.newTackWires=this.state.bus.copyTackWires();break;case S.padDrag:const a=this.state.pad;if(a.endDrag(),a.unHighLightRoutes(),u.getVerb()=="extrudePad")break;i=u.getParam(),i.newPos={x:a.rect.x,y:a.rect.y},i.newWires=a.copyWires();break;case S.tackDrag:const l=this.state.tack;l.fuseEndSegment(),l.route.unSelect(),u.getParam().newWire=l.route.copyWire();break;case S.pinDrag:const c=this.state.lookWidget;this.state.lookWidget.unHighLightRoutes(),u.getParam().newPos={left:c.is.left,y:c.rect.y};break;case S.pinAreaDrag:break;case S.interfaceNameDrag:{const h=this.state.lookWidget;u.getParam().newY=h.rect.y}break;case S.interfaceDrag:{const h=this.selection.widgets[0];h==null||h.node.look.unhighLightInterface(this.selection.widgets),u.getParam().newY=h.rect.y,this.selection.singleNodeAndWidget(h.node,h)}break;case S.interfaceNameClicked:{const h=this.selection.widgets[0];h==null||h.node.look.unhighLightInterface(this.selection.widgets)}break;case S.pinClicked:this.state.lookWidget.unHighLight(),this.state.lookWidget.unHighLightRoutes();break;case S.padArrowClicked:this.state.pad.unHighLight();for(const h of this.state.pad.routes)h.unHighLight();break}this.stateSwitch(S.nothing)}},Te={choices:[{text:"new group node",icon:"account_tree",char:"ctrl g",state:"enabled",action:qd},{text:"new source node",icon:"factory",char:"ctrl s",state:"enabled",action:Jd},{text:"new busbar",icon:"swap_horiz",char:"ctrl b",state:"enabled",action:Xd},{text:"new cable",icon:"cable",char:"ctrl k",state:"enabled",action:Gd},{text:"new input pad",icon:"new_label",char:"ctrl i",state:"enabled",action:Yd},{text:"new output pad",icon:"new_label",char:"ctrl o",state:"enabled",action:Kd},{text:"select node",icon:"play_arrow",char:"ctrl n",state:"enabled",action:Zd},{text:"paste as link",icon:"link",char:"ctrl l",state:"enabled",action:Qd},{text:"paste",icon:"content_copy",char:"ctrl v",state:"enabled",action:eu}],view:null,xyLocal:null,xyScreen:null,prepare(e){this.view=e,this.xyLocal=e.hit.xyLocal,this.xyScreen=e.hit.xyScreen}};function qd(){u.doEdit("newGroupNode",{view:Te.view,pos:Te.xyLocal})}function Jd(){u.doEdit("newSourceNode",{view:Te.view,pos:Te.xyLocal})}function Xd(){u.doEdit("busCreate",{view:Te.view,pos:Te.xyLocal,cable:!1})}function Gd(){u.doEdit("busCreate",{view:Te.view,pos:Te.xyLocal,cable:!0})}function Yd(){u.doEdit("padCreate",{view:Te.view,pos:Te.xyLocal,input:!0})}function Kd(){u.doEdit("padCreate",{view:Te.view,pos:Te.xyLocal,input:!1})}function Zd(){u.tx.send("select node",{xyScreen:Te.xyScreen,xyLocal:Te.xyLocal})}function Qd(){u.tx.request("clipboard get",u.doc).then(e=>{e.selection.what==C.nothing||e.selection.what==C.pinArea||u.doEdit("linkFromClipboard",{view:Te.view,pos:Te.xyLocal,clipboard:e})})}function eu(){u.tx.request("clipboard get",u.doc).then(e=>{e.selection.what==C.nothing||e.selection.what==C.pinArea||u.doEdit("pasteFromClipboard",{view:Te.view,pos:Te.xyLocal,clipboard:e})})}const _e={choices:[{text:"",char:"h",state:"enabled",action:Do,icon:"highlight"},{text:"add label",char:"a",state:"enabled",action:tu,icon:"sell"},{text:"wider",char:"ctrl +",state:"enabled",action:iu,icon:"open_in_full"},{text:"smaller",char:"ctrl -",state:"enabled",action:su,icon:"close_fullscreen"},{text:"copy",char:"ctrl c",state:"enabled",action:nu,icon:"content_copy"},{text:"source to clipboard",state:"enabled",action:Oo,icon:"content_paste"},{text:"make a test node",state:"enabled",action:ou,icon:"done_all"},{text:"",state:"enabled",action:Io,icon:"sync"},{text:"cut link",state:"enabled",action:Fo,icon:"link_off"},{text:"get from link",state:"enabled",action:Wo,icon:"link"},{text:"save to link",state:"enabled",action:Ho,icon:"add_link"},{text:"ungroup",state:"enabled",action:$o,icon:"schema"},{text:"disconnect",char:"clear",state:"enabled",action:ru,icon:"power_off"},{text:"delete",char:"del",state:"enabled",action:au,icon:"delete"}],view:null,node:null,xyLocal:null,prepare(e){this.view=e,this.xyLocal=e.hit.xyLocal,this.node=e.hit.node;let t=this.choices.find(i=>i.action==Oo);t.state=this.node.is.source?"enabled":"disabled",t=this.choices.find(i=>i.action==Io),t.state=this.node.link?"disabled":"enabled",t.text=this.node.is.group?"convert to source node":"convert to group node",t=this.choices.find(i=>i.action==Do),t.text=this.node.is.highLighted?"remove highlight":"highlight routes",t=this.choices.find(i=>i.action==Fo),t.state=this.node.link?"enabled":"disabled",t=this.choices.find(i=>i.action==Ho),t.state=this.node.link?"disabled":"enabled",t=this.choices.find(i=>i.action==Wo),t.state=this.node.link?"disabled":"enabled",t=this.choices.find(i=>i.action==$o),t.state=this.node.is.group?"enabled":"disabled"}};function tu(){u.doEdit("addLabel",{node:_e.node})}function iu(){u.doEdit("wider",{node:_e.node})}function su(){u.doEdit("smaller",{node:_e.node})}function Do(){u.doEdit("nodeHighLight",{node:_e.node})}function nu(){u.doEdit("nodeToClipboard",{view:_e.view,node:_e.node})}function Io(){u.doEdit("convertNode",{node:_e.node})}function ou(){}function Oo(){u.doEdit("sourceToClipboard",{node:_e.node})}function ru(){u.doEdit("disconnectNode",{node:_e.node})}function au(){u.doEdit("deleteNode",{node:_e.node})}function Fo(){u.doEdit("cutLink",{node:_e.node})}function Wo(){_e.node.showLinkForm(_e.xyLocal)}function Ho(){_e.node.showExportForm(_e.xyLocal)}function $o(){u.doEdit("unGroup",{view:_e.view,node:_e.node})}const lu=[{text:"new output",char:"o",icon:"logout",state:"enabled",action:du},{text:"new input",char:"i",icon:"login",state:"enabled",action:hu},{text:"new interface",char:"p",icon:"drag_handle",state:"enabled",action:pu},{text:"new request",char:"q",icon:"switch_left",state:"enabled",action:uu},{text:"new reply",char:"r",icon:"switch_right",state:"enabled",action:fu},{text:"in/out switch",icon:"cached",state:"disabled",action:ca},{text:"add channel",icon:"adjust",state:"disabled",action:ha},{text:"paste pins",char:"ctrl v",icon:"content_copy",state:"enabled",action:mu},{text:"profile",icon:"info",state:"disabled",action:sn},{text:"all pins swap left right",icon:"swap_horiz",state:"enabled",action:ua},{text:"all pins left",icon:"arrow_back",state:"enabled",action:fa},{text:"all pins right",icon:"arrow_forward",state:"enabled",action:pa},{text:"disconnect",icon:"power_off",state:"disabled",action:tn},{text:"delete",icon:"delete",state:"enabled",action:da}],cu=[{text:"profile",icon:"info",state:"disabled",action:sn},{text:"all pins swap left right",icon:"swap_horiz",state:"enabled",action:ua},{text:"all pins left",icon:"arrow_back",state:"enabled",action:fa},{text:"all pins right",icon:"arrow_forward",state:"enabled",action:pa},{text:"disconnect",icon:"power_off",state:"disabled",action:tn}],Q={choices:null,view:null,node:null,widget:null,xyLocal:null,xyScreen:null,prepare(e){var s,n,o,r,a,l,c,h;if(this.view=e,this.node=e.hit.node,this.widget=e.hit.lookWidget,this.xyLocal=e.hit.xyLocal,this.xyScreen=e.hit.xyScreen,this.node.link){this.choices=cu;let f=this.choices.find(g=>g.action==tn);f.state=(s=this.widget)!=null&&s.is.pin?"enabled":"disabled",f=this.choices.find(g=>g.action==sn),f.state=(n=this.widget)!=null&&n.is.pin?"enabled":"disabled";return}this.choices=lu;let t=this.choices.find(f=>f.action==tn);t.state=(o=this.widget)!=null&&o.is.pin?"enabled":"disabled",t=this.choices.find(f=>f.action==ca);let i=((r=this.widget)==null?void 0:r.is.pin)&&this.widget.routes.length==0;t.state=i?"enabled":"disabled",t.text=i&&this.widget.is.input?"change to output":"change to input",t=this.choices.find(f=>f.action==ha),i=(a=this.widget)==null?void 0:a.is.pin,t.state=i?"enabled":"disabled",t.text=i&&this.widget.is.channel?"remove channel":"add channel",t=this.choices.find(f=>f.action==sn),t.state=(l=this.widget)!=null&&l.is.pin?"enabled":"disabled",t=this.choices.find(f=>f.text=="delete"),t.action=(c=this.widget)!=null&&c.is.pin?da:(h=this.widget)!=null&&h.is.ifName?gu:()=>{},t=this.choices.find(f=>f.text=="paste pins")}};function hu(){const e={channel:!1,input:!0,proxy:Q.node.is.group};u.doEdit("newPin",{view:Q.view,node:Q.node,pos:Q.xyLocal,is:e})}function du(){const e={channel:!1,input:!1,proxy:Q.node.is.group};u.doEdit("newPin",{view:Q.view,node:Q.node,pos:Q.xyLocal,is:e})}function uu(){const e={channel:!0,input:!1,proxy:Q.node.is.group};u.doEdit("newPin",{view:Q.view,node:Q.node,pos:Q.xyLocal,is:e})}function fu(){const e={channel:!0,input:!0,proxy:Q.node.is.group};u.doEdit("newPin",{view:Q.view,node:Q.node,pos:Q.xyLocal,is:e})}function ca(){u.doEdit("ioSwitch",{pin:Q.widget})}function ha(){u.doEdit("channelOnOff",{pin:Q.widget})}function tn(){u.doEdit("disconnectPin",{pin:Q.widget})}function da(){u.doEdit("deletePin",{view:Q.view,pin:Q.widget})}function pu(){u.doEdit("newInterfaceName",{view:Q.view,node:Q.node,pos:Q.xyLocal})}function gu(){u.doEdit("deleteInterfaceName",{view:Q.view,ifName:Q.widget})}function sn(e){u.doEdit("showProfile",{pin:Q.widget,pos:{x:Q.xyScreen.x,y:Q.xyScreen.y+10}})}function ua(){u.doEdit("swapPins",{node:Q.node,left:!0,right:!0})}function fa(){u.doEdit("swapPins",{node:Q.node,left:!0,right:!1})}function pa(){u.doEdit("swapPins",{node:Q.node,left:!1,right:!0})}function mu(){u.tx.request("clipboard get",u.doc).then(e=>{u.doEdit("pasteWidgetsFromClipboard",{view:Q.view,clipboard:e})})}const vu=[{text:"left/right swap",icon:"swap_horiz",state:"enabled",action:ma},{text:"all pins left",icon:"arrow_back",state:"enabled",action:va},{text:"all pins right",icon:"arrow_forward",state:"enabled",action:wa},{text:"copy interface",char:"ctrl c",icon:"content_copy",state:"enabled",action:xa},{text:"disconnect",icon:"power_off",state:"enabled",action:ga}],wu=[{text:"new output",char:"o",icon:"logout",state:"enabled",action:yu},{text:"new input",char:"i",icon:"login",state:"enabled",action:xu},{text:"new interface",char:"p",icon:"drag_handle",state:"enabled",action:Tu},{text:"new request",char:"q",icon:"switch_left",state:"enabled",action:bu},{text:"new reply",char:"r",icon:"switch_right",state:"enabled",action:ku},{text:"left/right swap",icon:"swap_horiz",state:"enabled",action:ma},{text:"all pins left",icon:"arrow_back",state:"enabled",action:va},{text:"all pins right",icon:"arrow_forward",state:"enabled",action:wa},{text:"i/o swicth",icon:"cached",state:"enabled",action:_u},{text:"copy interface",char:"ctrl c",icon:"content_copy",state:"enabled",action:xa},{text:"paste pins",char:"ctrl v",icon:"content_copy",state:"enabled",action:Su},{text:"disconnect",icon:"power_off",state:"enabled",action:ga},{text:"delete",icon:"delete",state:"enabled",action:Pu}],re={choices:null,view:null,node:null,ifWidget:null,xyLocal:null,xyScreen:null,prepare(e){if(this.view=e,e.selection.what==C.ifArea){const i=e.selection.widgets[0];if(!(i!=null&&i.is.ifName))return;this.node=i.node,this.ifWidget=i,this.xyLocal=e.hit.xyLocal,this.xyScreen=e.hit.xyScreen}else this.node=e.hit.node,this.ifWidget=e.hit.lookWidget,this.xyLocal=e.hit.xyLocal,this.xyScreen=e.hit.xyScreen;this.choices=this.node.link?vu:wu;const t=this.choices.find(i=>i.text=="paste pins");t&&(t.state="disabled",u.tx.request("clipboard get",u.doc).then(i=>{t.state=i.selection.what===C.ifArea||i.selection.what===C.pinArea?"enabled":"disabled"}).catch(i=>{}))}};function xu(){const e={channel:!1,input:!0,proxy:re.node.is.group};u.doEdit("newPin",{view:re.view,node:re.node,pos:re.xyLocal,is:e})}function yu(){const e={channel:!1,input:!1,proxy:re.node.is.group};u.doEdit("newPin",{view:re.view,node:re.node,pos:re.xyLocal,is:e})}function bu(){const e={channel:!0,input:!1,proxy:re.node.is.group};u.doEdit("newPin",{view:re.view,node:re.node,pos:re.xyLocal,is:e})}function ku(){const e={channel:!0,input:!0,proxy:re.node.is.group};u.doEdit("newPin",{view:re.view,node:re.node,pos:re.xyLocal,is:e})}function Tu(){u.doEdit("newInterfaceName",{view:re.view,node:re.node,pos:re.xyLocal})}function _u(){u.doEdit("ioSwitchPinArea",{view:re.view})}function ga(){u.doEdit("disconnectPinArea",{})}function Pu(){u.doEdit("deletePinArea",{view:re.view})}function ma(){u.doEdit("swapPinArea",{view:re.view,left:!0,right:!0})}function va(){u.doEdit("swapPinArea",{view:re.view,left:!0,right:!1})}function wa(){u.doEdit("swapPinArea",{view:re.view,left:!1,right:!0})}function xa(){u.doEdit("selectionToClipboard",{view:re.view})}function Su(){u.tx.request("clipboard get",u.doc).then(e=>{u.doEdit("pasteWidgetsFromClipboard",{view:re.view,clipboard:e})}).catch(e=>console.log("paste: clipboard get error -> "+e))}const Dt={choices:[{text:"align left",icon:"align_horizontal_left",state:"enabled",action:()=>Bo(!0)},{text:"align right",icon:"align_horizontal_right",state:"enabled",action:()=>Bo(!1)},{text:"align top",icon:"align_vertical_top",state:"enabled",action:()=>Lu(!0)},{text:"distribute vertically",icon:"vertical_distribute",state:"enabled",action:Nu},{text:"distribute horizontally",icon:"horizontal_distribute",state:"enabled",action:Cu},{text:"copy",icon:"content_copy",state:"enabled",action:Au},{text:"group",icon:"developer_board",state:"enabled",action:Mu},{text:"disconnect",icon:"power_off",state:"enabled",action:Ru},{text:"delete",icon:"delete",state:"enabled",action:Eu}],view:null,xyLocal:null,prepare(e){this.view=e,this.xyLocal=e.hit.local}};function Bo(e){u.doEdit("alignVertical",{view:Dt.view,left:e})}function Lu(e){u.doEdit("alignHorizontal",{view:Dt.view,top:e})}function Nu(){u.doEdit("spaceVertical",{view:Dt.view})}function Cu(){u.doEdit("spaceHorizontal",{view:Dt.view})}function Ru(){u.doEdit("disconnectSelection",{selection:Dt.view.selection})}function Eu(){u.doEdit("deleteSelection",{view:Dt.view})}function Au(){u.doEdit("selectionToClipboard",{view:Dt.view})}function Mu(){u.doEdit("selectionToGroup",{view:Dt.view})}const lt={choices:[{text:"copy",icon:"content_copy",state:"enabled",action:Du},{text:"disconnect",icon:"power_off",state:"enabled",action:Iu},{text:"delete",icon:"delete",state:"enabled",action:Ou},{text:"all pins swap left right",icon:"swap_horiz",state:"enabled",action:Fu},{text:"all pins left",icon:"arrow_back",state:"enabled",action:Wu},{text:"all pins right",icon:"arrow_forward",state:"enabled",action:Hu},{text:"in/out switch",icon:"cached",state:"disabled",action:$u}],view:null,node:null,widgets:null,xyLocal:null,xyScreen:null,prepare(e){this.view=e,this.node=e.state.node,this.widgets=e.selection.widgets,this.xyLocal=e.hit.xyLocal,this.xyScreen=e.hit.xyScreen}};function Du(){u.doEdit("selectionToClipboard",{view:lt.view})}function Iu(){u.doEdit("disconnectPinArea",{view:lt.view,node:lt.node,widgets:lt.widgets})}function Ou(){u.doEdit("deletePinArea",{view:lt.view,node:lt.node,widgets:lt.widgets})}function Fu(){u.doEdit("swapPinArea",{view:lt.view,left:!0,right:!0})}function Wu(){u.doEdit("swapPinArea",{view:lt.view,left:!0,right:!1})}function Hu(){u.doEdit("swapPinArea",{view:lt.view,left:!1,right:!0})}function $u(){u.doEdit("ioSwitchPinArea",{view})}const xt={choices:[{icon:"highlight",text:"",state:"enabled",action:jo},{icon:"sell",text:"change name",state:"enabled",action:Bu},{icon:"sell",text:"",state:"enabled",action:zo},{icon:"rss_feed",text:"",state:"enabled",action:Uo},{icon:"timeline",text:"straight connections",state:"enabled",action:ju},{icon:"power_off",text:"disconnect",state:"enabled",action:zu},{icon:"delete",text:"delete",state:"enabled",action:Uu}],view:null,bus:null,label:null,xyLocal:null,prepare(e){this.view=e,this.bus=e.hit.bus,this.label=e.hit.busLabel,this.xyLocal=e.hit.xyScreen;let t=this.choices.find(i=>i.action==jo);t.text=this.bus.is.highLighted?"remove highlight":"highlight routes",t=this.choices.find(i=>i.action==zo),t.text=this.bus.is.cable?"change to busbar":"change to cable",t=this.choices.find(i=>i.action==Uo),t.state=this.bus.is.cable?"enabled":"disabled",t.text=this.bus.is.cable&&this.bus.is.filter?"change filter":"add filter"}};function jo(){u.doEdit("busHighlight",{bus:xt.bus})}function Bu(){u.doEdit("busChangeName",{bus:xt.bus,label:xt.busLabel})}function zo(){u.doEdit("busChangeType",{bus:xt.bus})}function Uo(){var s;const e=xt.bus,t=!e.filter||e.filter.fName.length<1?k.nodeToFactory(e.name):e.filter.fName,i=(s=e.filter)!=null&&s.arl?e.filter.arl.userPath:"";u.tx.send("show filter",{title:"Filter for "+e.name,name:t,path:i,pos:xt.xyLocal,ok:(n,o)=>{u.doEdit("busChangeFilter",{bus:e,newName:n.trim(),userPath:o.trim()})},open:async(n,o)=>{if((n!=t||o!=i)&&u.doEdit("busChangeFilter",{bus:e,newName:n.trim(),userPath:o.trim()}),n.length<1)return;const r=e.filter.arl??u.doc.resolve("./index.js");tx.send("open source file",{arl:r})},trash:()=>{u.doEdit("busDeleteFilter",{bus:e})},cancel:()=>{}})}function ju(){u.doEdit("busStraightConnections",{bus:xt.bus})}function zu(){u.doEdit("busDisconnect",{bus:xt.bus})}function Uu(){u.doEdit("busDelete",{bus:xt.bus})}const Ki={choices:[{icon:"sell",text:"change name",state:"enabled",action:Vu},{icon:"power_off",text:"disconnect",state:"enabled",action:qu},{icon:"delete",text:"delete",state:"enabled",action:Ju}],view:null,pad:null,prepare(e){this.view=e,this.pad=e.hit.pad}};function Vu(){u.doEdit("changeNamePad",{view:Ki.view,pad:Ki.pad})}function qu(){u.doEdit("disconnectPad",{pad:Ki.pad})}function Ju(){u.doEdit("deletePad",{pad:Ki.pad})}const Xu={onContextMenu(e,t){switch(this.saveHitSpot(e,t),this.mouseHit(e),this.hit.what){case H.header:case H.icon:_e.prepare(this),u.tx.send("show context menu",{menu:_e.choices,event:t});break;case H.node:case H.pin:Q.prepare(this),u.tx.send("show context menu",{menu:Q.choices,event:t});break;case H.ifName:this.selection.interfaceSelect(this.hit.node,this.hit.lookWidget),re.prepare(this),u.tx.send("show context menu",{menu:re.choices,event:t});break;case H.busSegment:case H.busLabel:xt.prepare(this),u.tx.send("show context menu",{menu:xt.choices,event:t});break;case H.pad:case H.padArrow:Ki.prepare(this),u.tx.send("show context menu",{menu:Ki.choices,event:t});break;case H.selection:switch(this.selection.what){case C.freeRect:case C.multiNode:Dt.prepare(this),u.tx.send("show context menu",{menu:Dt.choices,event:t});break;case C.ifArea:re.prepare(this),u.tx.send("show context menu",{menu:re.choices,event:t});break;case C.pinArea:lt.prepare(this),u.tx.send("show context menu",{menu:lt.choices,event:t});break}break;case H.nothing:Te.prepare(this),u.tx.send("show context menu",{menu:Te.choices,event:t});break}}},Gu={syncRoot(e){var t;e.rxtxBuildTxTable(),e.is.placed||e.placeRoot(),this.root=this.getContainer(e),(t=this.root.savedView)!=null&&t.tf&&this.setTransform(this.root.savedView.tf),this.restoreSubViews()},getContainer(e){if(e.isContainer())return e;const t=this.initRoot("");return t.nodes.push(e),t},newEmptyNode(e,t){const i=new yt({x:e.x,y:e.y,w:0,h:0}),s=t?new bi(i,""):new It(i,"");u.doc.UID.generate(s),this.root.addNode(s),this.selection.singleNode(s);const n=s.look.widgets.find(o=>o.is.header);return this.beginTextEdit(n),this.hit.xyLocal.y=e.y+n.rect.h,s}},Yu={getSelected(e){const t=this.selection;for(const i of this.root.nodes)i.overlap(e)&&t.nodes.push(i);for(const i of this.root.pads)i.overlap(e)&&t.pads.push(i);for(const i of this.root.buses)if(i.overlap(e)){t.buses.push(i);for(const s of i.tacks)s.overlap(e)&&t.tacks.push(s)}},externalWidgets(e){let t=[];return e.forEach(i=>{i.look.widgets.forEach(s=>{var n;(n=s.routes)==null||n.forEach(o=>{(!e.includes(o.to.node)||!e.includes(o.from.node))&&t.push(s)})})}),t},deltaForPaste(e,t){if(!e)return null;t.copyCount++;const i=t.selection,s=i.what==C.freeRect?i.rect:i.what==C.multiNode?i.nodes[0].look.rect:{x:0,y:0};return s.x==e.x&&s.y==e.y?{x:t.copyCount*m.look.dxCopy,y:t.copyCount*m.look.dyCopy}:{x:e.x-s.x+(t.copyCount-1)*m.look.dxCopy,y:e.y-s.y+(t.copyCount-1)*m.look.dyCopy}},selectionToClipboard(){u.tx.send("clipboard set",{model:u.doc.model,selection:this.selection})},clipboardToSelection(e,t){var r;const i=this.deltaForPaste(e,t),[s,n]=this.selection.whereToAdd();this.selection.reset();const o=t.selection;switch(this.selection.what=o.what,o.what){case C.freeRect:case C.multiNode:for(const a of o.nodes){let l=a.copy();l.look.moveDelta(i.x,i.y),this.root.addNode(l),this.selection.nodes.push(l)}if(this.root.uidChangeAll(u.doc.UID),o.what==C.multiNode)return;for(const a of o.buses){let l=a.copy();l==null||l.move(i.x,i.y),this.selection.buses.push(l)}for(const a of o.pads);if(o.rect){const a=o.rect;this.selection.activate(a.x+i.x,a.y+i.y,a.w,a.h,m.selection.cRect)}break;case C.singleNode:{let a=(r=o.nodes[0])==null?void 0:r.copy();a.uidChangeAll(u.doc.UID),a.look.moveTo(i.x,i.y),this.root.addNode(a),this.selection.nodes.push(a),a.doSelect()}break;case C.ifArea:case C.pinArea:{if(!s||!n)return;const a=s.look.copyPinArea(o.widgets,n);s.is.source?s.rxtxAddPinArea(a):s.addPads(a),this.selection.pinAreaSelect(a),this.selection.what=o.what}break}},linkToClipboardNodes(e,t){for(const i of this.selection.nodes)i.setLink(e,i.name+t)},checkPastedNames(e){for(const t of this.selection.nodes){let i=e;for(;this.root.hasDuplicate(t)&&i<999;){const s=k.addNumber(t.name,i++);t.updateName(s)}}},xxlinkToClipboardNodes(e,t){const i=e.selection.nodes.length;if(i==this.selection.nodes.length)for(let s=0;s<i;s++)this.selection.nodes[s].setLink(t,e.selection.nodes[s].name)},removeSelection(e){this.selection.reset();for(const t of e.nodes)this.root.removeNode(t);for(const t of e.buses)this.root.removeBus(t);for(const t of e.pads)this.root.removePad(t)},restoreSelection(e){for(const s of e.nodes)this.root.restoreNode(s);for(const s of e.buses)this.root.restoreBus(s);for(const s of e.pads)this.root.restorePad(s);const t=this.selection;t.reset();for(const s of e.nodes)t.nodes.push(s);for(const s of e.buses)t.buses.push(s);for(const s of e.pads)t.pads.push(s);const i=e.rect;t.activate(i.x,i.y,i.w,i.h,e.color)},xxxselectedNodeAndPosition(){const e=this.selection.getSingleNode();if(!e)return[null,null];const t=this.selection.getSelectedWidget(),i=t?{x:t.is.left?t.rect.x:t.rect.x+t.rect.w,y:t.rect.y+t.rect.h}:this.hit.xyLocal;return[e,i]}},Ku={singleSourceToGroup(){},selectionToGroup(e){const t=new yt(this.selection.makeLookRect()),i=new It(t,"new group",null);e.generate(i),this.root.addNode(i);const s=i.savedView=this.newSubView(i,this.selection.makeViewRect());s.translate(-s.rect.x,-s.rect.y);for(const o of this.selection.nodes)i.addNode(o),this.root.removeNode(o);const n=this.busTransfer(i);i.addProxies(this.selection);for(const o of n)this.busInterconnect(o.outside,i,o.inside);return i},busTransfer(e){const t=[];for(const i of this.selection.buses){const s=this.selection.nodes,n=[];for(const o of i.tacks){const r=o.route.from==o?o.route.to:o.route.from;r.is.pin&&!s.includes(r.node)&&n.push(o)}if(n.length==0)e.buses.push(i),this.root.removeBus(i);else{const o=i.copy();e.buses.push(o),i.splitTacks(o,e),t.push({outside:i,inside:o})}}return t},busInterconnect(e,t,i){function s(r){const a=r.route.to==r?r.route.from:r.route.to;return a.is.pad?a.proxy:a}function n(r,a){const l=s(r),c=s(a);return l.name!=c.name?!1:l.is.proxy==c.is.proxy?l.is.input!=c.is.input:l.is.input==c.is.input}const o=i.tacks.reduce((r,a)=>{const l=e.tacks.find(c=>n(a,c));if(l){const c=s(l),h=c.name+(c.is.input?">":"<");r[h]||(r[h]=a)}return r},{});for(const r of Object.values(o)){const a=s(r),l=t.copyPinAsProxy(a);t.addPad(l),e.makeRoute(l),i.makeRoute(l.pad)}},undoSelectionToGroup(e,t,i,s){t.disconnect(),t.savedView.closeView(),this.root.removeNode(t),this.restoreSelection(e);for(const n of t.buses)n.transferTacks(e.buses);for(const n of e.nodes)n.disconnect();for(const n of s)for(const o of n)o.reconnect()},transferToSelection(e,t){this.selection.reset();const i=this.calcRect(e),s=t.dx,n=t.dy;this.selection.activate(i.x+s,i.y+n,i.w,i.h);for(const o of e.pads)o.disconnect();for(const o of e.nodes)o.look.moveDelta(s,n),o.look.moveRoutes(s,n),this.root.nodes.push(o),this.selection.nodes.push(o);for(const o of e.buses)o.move(s,n),o.moveRoutes(s,n),this.root.buses.push(o),this.selection.buses.push(o);this.root.removeNode(e)},undoTransferToSelection(e,t,i){const s=-t.dx,n=-t.dy;for(const o of e.nodes)o.look.moveDelta(s,n),o.look.moveRoutes(s,n),view.root.removeNode(o);for(const o of e.buses)o.move(s,n),o.moveRoutes(s,n),e.removeBus(o);for(const o of i)o.reconnect();view.root.restoreNode(e)}},Zu={calcRow(e){e.sort((c,h)=>c.look.rect.x-h.look.rect.x);const t=m.selection.xPadding;let{x:i,y:s}={...e[0].look.rect},n=e.length-1,o=e[n].look.rect.x+e[n].look.rect.w-e[0].look.rect.x,r=0,a=0;e.forEach(c=>{r=Math.max(r,c.look.rect.h),a+=c.look.rect.w});let l=(o-a)/n;return l<t&&(l=t,o=a+n*t),{x:i,y:s,w:o,h:r,space:l}},calcColumn(e){e.sort((c,h)=>c.look.rect.y-h.look.rect.y);const t=m.selection.yPadding;let{x:i,y:s}={...e[0].look.rect},n=e.length-1,o=0,r=e[n].look.rect.y+e[n].look.rect.h-e[0].look.rect.y,a=0;e.forEach(c=>{o=Math.max(o,c.look.rect.w),a+=c.look.rect.h});let l=(r-a)/n;return l<t&&(l=t,r=a+n*t),{x:i,y:s,w:o,h:r,space:l}},calcRect(e){const t=e.nodes.length>0?e.nodes[0].look.rect:e.pads[0].rect,i={x:t.x,y:t.y},s={x:t.x+t.w,y:t.y+t.h};let n=null;return e.nodes.forEach(o=>{n=o.look.rect,i.x=Math.min(i.x,n.x),i.y=Math.min(i.y,n.y),s.x=Math.max(s.x,n.x+n.w),s.y=Math.max(s.y,n.y+n.h)}),e.pads.forEach(o=>{n=o.rect,i.x=Math.min(i.x,n.x),i.y=Math.min(i.y,n.y),s.x=Math.max(s.x,n.x+n.w),s.y=Math.max(s.y,n.y+n.h)}),{x:i.x,y:i.y,w:s.x-i.x,h:s.y-i.y}},nodesAlignHD(e,t=!0){const i=[],s=this.calcColumn(e);for(const n of e){const o=n.look.rect,r=t?s.x-o.x:s.x+s.w-o.x-o.w;i.push({x:r,y:0})}return i},nodesAlignVD(e){const t=[],i=this.calcRow(e);for(const s of e)t.push({x:0,y:i.y-s.look.rect.y});return t},nodesSpaceVD(e){const t=[],i=this.calcColumn(e);let s=i.y;for(const n of e){const o=n.look.rect;t.push({x:0,y:s-o.y}),s=s+o.h+i.space}return t},nodesSpaceHD(e){const t=[],i=this.calcRow(e);let s=i.x;for(const n of e){const o=n.look.rect;t.push({x:s-o.x,y:0}),s=s+o.w+i.space}return t},padsAlignHD(e,t=!0){const i=[];e.sort((n,o)=>n.rect.y-o.rect.y);const s=e[0].rect;for(const n of e){const o=n.rect,r=t?s.x-o.x:s.x+s.w-o.x-o.w;i.push({x:r,y:0})}return i},padsSpaceVD(e){const t=[];e.sort((o,r)=>o.rect.y-r.rect.y);const i=e[0].rect.y;let s=(e.at(-1).rect.y-e[0].rect.y)/(e.length-1),n=0;for(const o of e)t.push({x:0,y:i+n++*s-o.rect.y});return t},moveNodesAndRoutes(e,t,i=!1){const s=e.length;let n=0,o=0;for(let r=0;r<s;r++)n=i?-t[r].x:t[r].x,o=i?-t[r].y:t[r].y,e[r].look.moveDelta(n,o),e[r].look.moveRoutes(n,o);for(let r=0;r<s;r++)e[r].look.adjustRoutes()},movePadsAndRoutes(e,t,i=!1){const s=e.length;let n=0,o=0;for(let r=0;r<s;r++)n=i?-t[r].x:t[r].x,o=i?-t[r].y:t[r].y,e[r].rect.x+=n,e[r].rect.y+=o,e[r].adjustRoutes()}};function Fi(e){let[t,i]=e.selection.whereToAdd();return i||(i=e.hit.xyLocal),!t||!i?[!1,null,null]:t.cannotBeModified()?[!1,null,null]:[!0,t,i]}const Qu={i:e=>{const[t,i,s]=Fi(e);if(!t)return;const n={channel:!1,input:!0,proxy:i.is.group};u.doEdit("newPin",{view:e,node:i,pos:s,is:n})},o:e=>{const[t,i,s]=Fi(e);if(!t)return;const n={channel:!1,input:!1,proxy:i.is.group};u.doEdit("newPin",{view:e,node:i,pos:s,is:n})},q:e=>{const[t,i,s]=Fi(e);if(!t)return;const n={channel:!0,input:!1,proxy:i.is.group};u.doEdit("newPin",{view:e,node:i,pos:s,is:n})},r:e=>{const[t,i,s]=Fi(e);if(!t)return;const n={channel:!0,input:!0,proxy:i.is.group};u.doEdit("newPin",{view:e,node:i,pos:s,is:n})},p:e=>{const[t,i,s]=Fi(e);t&&u.doEdit("newInterfaceName",{view:e,node:i,pos:s})},a:e=>{const t=e.selection.getSingleNode();if(!t)return;const i=t.look.findLabel();i?u.doEdit("widgetTextEdit",{view:e,widget:i}):u.doEdit("addLabel",{node:t})},h:e=>{const t=e.selection.getSingleNode();t&&u.doEdit("nodeHighLight",{node:t})},"+":e=>{const t=e.selection.getSelectedWidget();!t||!t.node||t.node.cannotBeModified()||u.doEdit("widgetTextEdit",{view:e,widget:t,cursor:-1})},"-":e=>{const t=e.selection.getSelectedWidget();!t||!t.node||t.node.cannotBeModified()||u.doEdit("widgetTextEdit",{view:e,widget:t,cursor:0,clear:!0})},Clear:e=>{const t=e.selection.what==C.singleNode?e.selection.getSingleNode():null;t?u.doEdit("disconnectNode",{node:t}):u.doEdit("disconnectSelection",{view:e})},Delete:e=>{switch(e.selection.what){case C.nothing:break;case C.freeRect:u.doEdit("deleteSelection",{view:e});break;case C.pinArea:const[t,i,s]=Fi(e);if(!t)return;u.doEdit("deletePinArea",{view:e,node:e.selection.getSingleNode(),widgets:e.selection.widgets});break;case C.singleNode:const n=e.selection.getSelectedWidget();if(!n){const o=e.selection.getSingleNode();o&&u.doEdit("deleteNode",{node:o});return}if(n.node.cannotBeModified())return;n.is.pin?u.doEdit("deletePin",{view:e,pin:n}):n.is.ifName&&u.doEdit("deleteInterfaceName",{view:e,ifName:n});break;case C.multiNode:u.doEdit("deleteSelection",{view:e});break}},Enter:e=>{const t=e.selection.getSelectedWidget();if(t){if(t.node.cannotBeModified())return;u.doEdit("widgetTextEdit",{view:e,widget:t})}},ArrowDown:e=>{const t=e.selection.widgetBelow();t&&e.selection.switchToWidget(t)},ArrowUp:e=>{const t=e.selection.widgetAbove();t&&e.selection.switchToWidget(t)},Undo:e=>u.undoLastEdit(),Redo:e=>u.redoLastEdit(),Escape:e=>{e.selection.reset()}},ef={s:e=>{u.doEdit("newSourceNode",{view:e,pos:e.hit.xyLocal})},g:e=>{u.doEdit("newGroupNode",{view:e,pos:e.hit.xyLocal})},b:e=>{u.doEdit("busCreate",{view:e,pos:e.hit.xyLocal,cable:!1})},k:e=>{u.doEdit("busCreate",{view:e,pos:e.hit.xyLocal,cable:!0})},c:e=>{u.doEdit("selectionToClipboard",{view:e})},i:e=>{u.doEdit("padCreate",{view:e,pos:e.hit.xyLocal,input:!0})},o:e=>{u.doEdit("padCreate",{view:e,pos:e.hit.xyLocal,input:!1})},l:e=>{u.tx.request("clipboard get",u.doc).then(t=>{const i=t.selection.what;i!=C.nothing&&i!=C.pinArea&&u.doEdit("linkFromClipboard",{view:e,pos:e.hit.xyLocal,clipboard:t})}).catch(t=>console.log("ctrl-l : clipboard get error -> "+t))},v:e=>{u.tx.request("clipboard get",u.doc).then(t=>{const i=t.selection.what;if(i!=C.nothing){if(i==C.pinArea){u.doEdit("pasteWidgetsFromClipboard",{view:e,clipboard:t});return}u.doEdit("pasteFromClipboard",{view:e,pos:e.hit.xyLocal,clipboard:t})}}).catch(t=>console.log("ctrl-v : clipboard get error -> "+t))},z:e=>u.undoLastEdit(),Z:e=>u.redoLastEdit(),"+":e=>{const t=e.selection.getSingleNode();t&&u.doEdit("wider",{node:t})},"-":e=>{const t=e.selection.getSingleNode();t&&u.doEdit("smaller",{node:t})}},tf={_logKey(e){let t="Key = ";e.ctrlKey&&(t+="ctrl "),e.shiftKey&&(t+="shift "),t+="<"+e.key+">",console.log(t)},onKeydown(e){var t,i,s,n;if(this.state.action==S.nothing){const o=e.ctrlKey?ef[e.key]:Qu[e.key];return o?(o(this),!0):!1}else return this.state.action==S.editTextField?((e.key.length>1||e.ctrlKey?(i=(t=this.textField).handleSpecialKey)==null?void 0:i.call(t,e):(n=(s=this.textField).handleKey)==null?void 0:n.call(s,e))&&this.stateSwitch(S.nothing),!0):!1},onKeyup(e){return!1},beginTextEdit(e,t=-1,i=!1){var n;const s=(n=e.startEdit)==null?void 0:n.call(e);s&&(this.textField.newEdit(e,s,t),i&&this.textField.clear(),this.stateSwitch(S.editTextField),u.switchView(this),this.startBlinking())},endTextEdit(){var i,s;const e=this.state,t=this.textField;clearInterval(e.cursorInterval),t&&((s=(i=t.obj).endEdit)==null||s.call(i,t.saved))},startBlinking(){let e=0,t=!0,i=!0;const s=n=>{n-e>=m.std.blinkRate&&(i=u.doc.view.recursiveBlink(u.ctx,t),t=!t,e=n),i&&requestAnimationFrame(s)};requestAnimationFrame(s)},recursiveBlink(e,t){e.save();const i=this.tf;e.transform(i.sx,0,0,i.sy,i.dx,i.dy);let s=!1;if(this.state.action==S.editTextField){s=!0;const n=this.textField;n.obj.drawCursor(e,n.cursor,t)}for(const n of this.views)s=n.recursiveBlink(e,t)||s;return e.restore(),s}},sf={localCoord(e){const t=this.tf;return{x:(e.x-t.dx)/t.sx,y:(e.y-t.dy)/t.sy}},inverse(e){const t=this.tf;return{x:e.x*t.sx+t.dx,y:e.y*t.sy+t.dy}},newSubView(e,t=null,i=null){t=t??this.makeViewRect(e);let s=new _s(t,e,this);return i&&s.setTransform(i),s.addViewWidgets(),s.placeWidgets(),this.views.push(s),e.savedView=s,s},restoreView(e){if(e.savedView.raw&&(e.savedView=this.newSubView(e,e.savedView.rect,e.savedView.tf)),this.views.find(t=>t==e.savedView)){console.error("View already in views in restore view !");return}if(this==e.savedView){console.error("Circular reference in views");return}e.savedView.viewState.visible=!0,this.views.push(e.savedView),e.savedView.parent=this},closeView(){this.parent&&(this.viewState.visible=!1,this.parent.views&&Ce(this.parent.views,this))},restoreSubViews(){var e;if(this.views.length=0,!!((e=this.root)!=null&&e.nodes))for(let t of this.root.nodes)!t.savedView||t.savedView.state=="closed"||(t.savedView=this.newSubView(t,t.savedView.rect,t.savedView.tf),t.savedView.restoreSubViews())},move(e){var t;this.tf.dx+=e.x,this.tf.dy+=e.y,this.rect.x+=e.x,this.rect.y+=e.y,(t=this.widgets)==null||t.forEach(i=>{i.rect.x+=e.x,i.rect.y+=e.y})},resize(e,t){const i=this.rect;switch(e.name){case"corner":i.h+t.y>m.view.hHeader&&(i.h+=t.y),i.w+t.x>m.look.wBox&&(i.w+=t.x);break;case"top":if(i.h-t.y<m.view.hHeader)return;i.y+=t.y,i.h-=t.y;break;case"bottom":if(i.h+t.y<m.view.hHeader)return;i.h+=t.y;break;case"right":if(i.w+t.x<m.look.wBox)return;i.w+=t.x;break;case"left":if(i.w-t.x<m.look.wBox)return;i.x+=t.x,i.w-=t.x;break}this.placeWidgets()},whichView(e){const t=m.view.hHeader,i=m.view.wLine;for(let s=this.views.length-1;s>=0;s--){const n=this.views[s],o=n.rect;if(e.x>=o.x+i&&e.x<=o.x+o.w-i&&e.y>=o.y+t&&e.y<=o.y+o.h-i)return e=n.localCoord(e),n.whichView(e);const r=4;if(e.x<o.x-r||e.x>o.x+o.w+r||e.y<o.y-r||e.y>o.y+o.h+r)continue;let a=null;for(const l of n.widgets)at(e,l.rect)&&!l.is.viewBox&&(a=l);if(a)return[n,a,e];if(e.x<o.x+i)return[n,{is:{border:!0},name:"left"},e];if(e.x>o.x+o.w-i)return e.y>o.y+o.h-20?[n,{is:{border:!0},name:"corner"},e]:[n,{is:{border:!0},name:"right"},e];if(e.y<o.y+i)return[n,{is:{border:!0},name:"top"},e];if(e.y>o.y+o.h-i)return e.x>o.x+o.w-20?[n,{is:{border:!0},name:"corner"},e]:[n,{is:{border:!0},name:"bottom"},e]}return[this,null,e]},iconClick(e,t){switch(e.type){case"close":this.viewState.visible=!1,this.viewState.big&&this.small(),t.switchView(this.parent),this.closeView();break;case"big":{const i=this.parentViewsReverse();for(const s of i)s.big();this.big()}break;case"small":{this.small();for(const i of this.views)i.viewState.big&&i.small()}break;case"calibrate":this.toggleTransform();break;case"grid":this.state.grid=!this.state.grid;break}},viewToFront(e){const t=this.views,i=t.length;let s=t.indexOf(e),n=t[s];for(let o=s;o<i-1;o++)t[o]=t[o+1];t[i-1]=n},cloneForTab(){let e=new _s({x:0,y:0,w:0,h:0},this.root,this.parent);return e.tf.dx=this.tf.dx,e.tf.dy=this.tf.dy,e.tf.sx=this.tf.sx,e.tf.sy=this.tf.sy,e.views=this.views,e},addViewWidgets(){const e=this.rect,t=m.view;this.widgets.push(new la(this.rect)),this.root&&this.widgets.push(new aa({x:0,y:0,w:e.w,h:m.view.hHeader},this.root));for(const i of["close","big","calibrate","grid"]){const s=new xn({x:0,y:0,w:t.wIcon,h:t.hIcon},i);s.setRender(),s.is.highLighted=!1,this.widgets.push(s)}},placeWidgets(){const e=this.rect,t=m.view;let i=e.x+t.xPadding;for(const s of this.widgets)s.is.icon?(s.rect.y=e.y+(m.view.hHeader-t.hIcon)/2,s.rect.x=i,i+=t.wIcon+t.xSpacing):s.is.viewBox?(s.rect.x=e.x,s.rect.y=e.y,s.rect.w=e.w,s.rect.h=e.h):s.is.viewTitle&&(s.rect.x=e.x,s.rect.y=e.y,s.rect.w=e.w)},toggleTransform(){const e=this.tf,t=this.viewState.tf;e.sx!=1?(this.saveTransform(this.tf),this.setTransform({sx:1,sy:1,dx:e.dx,dy:e.dy}),this.redoBigRecursive()):t.sx!=1&&(this.setTransform(t),this.redoBigRecursive())},parentViewsReverse(){const e=[];let t=this;for(;t.parent;)e.push(t.parent),t=t.parent;return e.reverse()},toggleBig(){if(this.viewState.big){this.small();for(const e of this.views)e.viewState.big&&e.toggleBig()}else{const e=this.parentViewsReverse();for(const t of e)t.big();this.big()}},small(){var e;Object.assign(this.rect,this.viewState.rect),(e=this.widgets.find(t=>t.type=="small"))==null||e.switchType("big"),this.placeWidgets(),this.viewState.big=!1},big(e=!0){var o;if(!this.parent)return;const t=this.parent.rect,i=this.parent.tf,s=m.view;e&&Object.assign(this.viewState.rect,this.rect);const n=this.parent.parent?s.hHeader:0;this.rect.x=(t.x-i.dx)/i.sx,this.rect.y=(t.y+n-i.dy)/i.sy,this.rect.w=t.w/i.sx,this.rect.h=(t.h-n)/i.sy,(o=this.widgets.find(r=>r.type=="big"))==null||o.switchType("small"),this.placeWidgets(),this.viewState.big=!0},redoBigRecursive(){this.viewState.big&&this.big(!1);for(const e of this.views)e.redoBigRecursive()}},Vo="drawer/file",nf={async onDrop(e,t){t.preventDefault();let i=this.localCoord(e);if(this.mouseHit(i),this.hit.view)return this.hit.view.onDrop(i,t);const s=this.analyseDrop(t);if(!s)return;const n=new Qt(s.path),o=new Mt(n),a=await new Li(u.doc.UID).getRoot(o);if(!a)return null;if(a.is.group&&a.isContainer()){const l=this.makeViewRect(a);l.x=i.x,l.y=i.y,this.newSubView(a,l)}return a.look.moveTo(i.x,i.y),a.uidChangeAll(u.doc.UID),a.link=new Ys(o,this.name),this.root.nodes.push(a),u.redraw(),a},analyseDrop(e){e.dataTransfer.items&&[...e.dataTransfer.items];const t=e.dataTransfer.files?[...e.dataTransfer.files]:null,i=e.dataTransfer.types?[...e.dataTransfer.types]:null;return(t==null?void 0:t.length)>0&&t.forEach((s,n)=>{}),(i==null?void 0:i.length)>0&&i.includes(Vo)?JSON.parse(e.dataTransfer.getData(Vo)):null}},S={nothing:0,nodeDrag:1,routeDrag:2,panning:3,routeDraw:4,editTextField:5,selection:6,selectionDrag:7,pinAreaSelect:8,pinAreaDrag:9,padDrag:10,padArrowClicked:11,busDraw:12,busRedraw:13,busSegmentDrag:14,busDrag:15,tackDrag:16,pinClicked:17,pinDrag:18,interfaceDrag:19,interfaceNameDrag:20,interfaceNameClicked:21};function _s(e,t=null,i=null){this.tf={sx:1,sy:1,dx:e.x,dy:e.y+m.view.hHeader},this.rect=e,this.widgets=[],this.root=t,this.parent=i,this.views=[],this.hitTimer=0,this.state={action:0,pad:null,node:null,route:null,routeSegment:0,cursorInterval:null,bus:null,busSegment:0,busLabel:null,tack:null,lookWidget:null,hoverOver:null,highLighted:!1,grid:!1},this.textField=new ea,this.hit={what:0,selection:null,xyLocal:{x:0,y:0},xyScreen:{x:0,y:0},pad:null,padArrow:!1,node:null,lookWidget:null,route:null,routeSegment:0,bus:null,busSegment:0,busLabel:null,tack:null},this.selection=new Ts(this),this.viewState={visible:!0,big:!1,tf:{sx:1,sy:1,dx:e.x,dy:e.y},rect:{...e}}}_s.prototype={toJSON(){},stateSwitch(e){this.state.action==S.editTextField&&this.endTextEdit(),this.state.action=e},reset(){const e=this.state;e.action=S.nothing,e.node=null,e.view=null,e.route=null,this.selection.reset(),this.views.forEach(t=>t.reset())},makeViewRect(e){let t={x:0,y:0,w:0,h:0};const i=.1;return(e.nodes.length>0||e.pads.length>0)&&(t=this.calcRect(e),t.w=t.w+Math.floor(i*t.w),t.h=t.h+Math.floor(i*t.h)),t.w<m.view.wDefault&&(t.w=m.view.wDefault),t.h<m.view.hDefault&&(t.h=m.view.hDefault),t.x=e.look.rect.x,t.y=e.look.rect.y+m.view.hHeader+m.header.hHeader,t},noRect(){return this.rect.w==0||this.rect.h==0},setRect(e,t,i,s){this.rect.x=e,this.rect.y=t,this.rect.w=i,this.rect.h=s},shiftContent(e,t){this.root.nodes.forEach(i=>{i.look.moveDelta(e,t),i.look.moveRoutes(e,t)}),this.root.buses.forEach(i=>i.move(e,t))},translate(e,t){this.tf.dx+=e,this.tf.dy+=t},resetTransform(){this.tf.dx=this.rect.x,this.tf.dy=this.rect.y,this.tf.sx=1,this.tf.sy=1},setTransform(e){this.tf.dx=e.dx,this.tf.dy=e.dy,this.tf.sx=e.sx,this.tf.sy=e.sy},saveTransform(e){Object.assign(this.viewState.tf,e)},middle(){const e=this.tf,t=this.rect;return{x:(t.x+t.w/2-e.dx)/e.sx,y:(t.y+t.h/2-e.dy)/e.sy}},initRoot(e){const t=new yt({x:this.rect.x+this.rect.w/2,y:this.rect.y,w:0,h:0});return this.root=new It(t,e),this.root},render(e){var o,r,a,l;const t=m.switch((l=(a=(r=(o=this.root)==null?void 0:o.link)==null?void 0:r.model)==null?void 0:a.header)==null?void 0:l.style);e.save();const i=this.rect,s=m.view;if(this.parent){for(const c of this.widgets)c.render(e);e.rect(i.x+s.wLine/2,i.y+s.hHeader,i.w-s.wLine,i.h-s.hHeader),e.clip()}const n=this.tf;e.transform(n.sx,0,0,n.sy,n.dx,n.dy),this.state.grid&&this.drawGrid(e),this.root&&this.renderContent(e);for(const c of this.views)c.render(e);e.restore(),m.switch(t)},renderContent(e){var i;const t=this.root;this.selection.render(e);for(const s of t.nodes)for(const n of s.look.widgets)if(n.routes)for(const o of n.routes)o.from==n&&o.render(e);for(const s of t.pads)for(const n of s.routes)n.from==s&&n.render(e);for(const s of t.buses)for(const n of s.tacks)((i=n.route)==null?void 0:i.from)==n&&n.route.render(e);for(const s of t.nodes)s.render(e);for(const s of t.pads)s.render(e);for(const s of t.buses)s.render(e)},highLight(){this.state.highLighted=!0;for(const e of this.widgets)(e.is.viewTitle||e.is.viewBox||e.is.icon)&&(e.is.highLighted=!0)},unHighLight(){this.state.highLighted=!1;for(const e of this.widgets)(e.is.viewTitle||e.is.viewBox||e.is.icon)&&(e.is.highLighted=!1)},topView(){let e=this;for(;e.parent;)e=parent;return e},drawGrid(e){const t=this.rect,i=this.tf,s=m.view.grid,n={x:(t.x-i.dx)/i.sx,y:(t.y-i.dy)/i.sy,w:t.w/i.sx,h:t.h/i.sy};$.grid(e,n.x,n.y,n.w,n.h,s.dx,s.dy,s.cLine,s.cAxis)},getNamePath(){if(!this.parent)return"";let e=this,t="";for(;e.parent;)t+=" @ "+e.root.name,e=e.parent;return t}};Object.assign(_s.prototype,Bd,Ud,zd,Vd,Gu,Xu,Yu,Ku,Zu,tf,sf,nf);const of={newGroupNode:{doit({view:e,pos:t}){const i=e.newEmptyNode(t,!1);u.saveEdit("newGroupNode",{view:e,node:i})},undo({view:e,node:t}){e.root.removeNode(t)},redo({view:e,node:t}){e.root.addNode(t)}},newSourceNode:{doit({view:e,pos:t}){const i=e.newEmptyNode(t,!0);u.saveEdit("newSourceNode",{view:e,node:i})},undo({view:e,node:t}){e.root.removeNode(t)},redo({view:e,node:t}){e.root.addNode(t)}},wider:{doit({node:e}){e.look.wider(),u.saveEdit("wider",{node:e})},undo({node:e}){e.look.smaller()},redo({node:e}){e.look.wider()}},smaller:{doit({node:e}){e.look.smaller(),u.saveEdit("smaller",{node:e})},undo({node:e}){e.look.wider()},redo({node:e}){e.look.smaller()}},nodeHighLight:{doit({node:e}){e.is.highLighted?e.unHighLight():e.highLight()},undo({node:e}){},redo({node:e}){}},convertNode:{doit({node:e}){var s;const t=u.doc.focus;if(e.link)return;const i=e.switchNodeType();t.root.swap(e,i),(s=t.root)==null||s.rxtxBuildTxTable(),u.saveEdit("convertNode",{view:t,node:e,convertedNode:i})},undo({view:e,node:t,convertedNode:i}){var s;e.root.swap(i,t)&&i.look.transferRoutes(t.look),(s=e.root)==null||s.rxtxBuildTxTable()},redo({view:e,node:t,convertedNode:i}){var s;e.root.swap(t,i)&&t.look.transferRoutes(i.look),(s=e.root)==null||s.rxtxBuildTxTable()}},nodeToClipboard:{doit({view:e,node:t}){e.selection.singleNode(t),u.tx.send("clipboard set",{model:u.doc.model,selection:e.selection})},undo(){},redo(){}},sourceToClipboard:{doit({node:e}){if(!e.is.source)return;const t=e.makeSourceBody();u.textToExternalClipboard(t)},undo(){},redo(){}},swapPins:{doit({node:e,left:t,right:i}){const s=[];for(let n of e.look.widgets)n.is.pin&&t&&!n.is.left&&s.push(n),n.is.pin&&i&&n.is.left&&s.push(n);for(const n of s)n.leftRightSwap();u.saveEdit("swapPins",{swapped:s})},undo({swapped:e}){for(const t of e)t.leftRightSwap()},redo({swapped:e}){for(const t of e)t.leftRightSwap()}},disconnectNode:{doit({node:e}){const t=e.getRoutes();e.disconnect(),u.saveEdit("disconnectNode",{node:e,allRoutes:t})},undo({node:e,allRoutes:t}){for(const i of t)i.reconnect()},redo({node:e,allRoutes:t}){e.disconnect()}},deleteNode:{doit({node:e}){const t=e.getRoutes();e.disconnect(),u.doc.focus.root.removeNode(e),e.saveView&&e.savedView.closeView(),u.saveEdit("deleteNode",{view:u.doc.focus,node:e,allRoutes:t})},undo({view:e,node:t,allRoutes:i}){e.root.addNode(t);for(const s of i)s.reconnect()},redo({view:e,node:t,allRoutes:i}){t.disconnect(),e.root.removeNode(t)}},nodeFromNodeLib:{doit({view:e,node:t}){e.root.addNode(t),e.state.node=t,e.selection.singleNode(t),u.saveEdit("nodeFromNodeLib",{view:e,node:t})},undo({view:e,node:t}){e.root.removeNode(t)},redo({view:e,node:t}){e.root.addNode(t)}},nodeDrag:{doit({view:e,node:t}){u.saveEdit("nodeDrag",{node:t,view:e,oldPos:{x:t.look.rect.x,y:t.look.rect.y},newPos:null})},undo({node:e,view:t,oldPos:i,newPos:s}){const n={x:i.x-s.x,y:i.y-s.y};e.move(n),t.selection.move(n)},redo({node:e,view:t,oldPos:i,newPos:s}){const n={x:s.x-i.x,y:s.y-i.y};e.move(n),t.selection.move(n)}},updateProfiles:{doit({node:e}){e.is.group||e.factory.arl&&e.factory.arl.jsImport().then(t=>{e.analyzeFactory(t)})},undo({}){},redo({}){}},changeNodeSettings:{doit({node:e,sx:t}){JSON.stringify(t)!==JSON.stringify(e.sx)&&(e.sx=t),u.signalEdit("changeNodeSettings")},undo({}){},redo({}){}},changeNodeDynamics:{doit({node:e,dx:t}){e.dx,JSON.stringify(t)!==JSON.stringify(e.dx)&&(e.dx=t),u.signalEdit("changeNodeDynamics")},undo({}){},redo({}){}},changeNodeComment:{doit({node:e,comment:t}){!t||t.length==0?e.prompt=null:t!==e.prompt&&(e.prompt=t),u.signalEdit("changeNodeComment")},undo({}){},redo({}){}}},rf={cutLink:{doit({node:e}){e.link&&(u.saveEdit("cutLink",{node:e,lName:e.link.lName,userPath:e.link.model.arl.userPath}),e.clearLink(),e.adjustUserPaths(u.doc.model.arl))},undo({node:e,lName:t,userPath:i}){t.length?i.length?u.doc.importFromModel(e,t,i):u.doc.makeLocalLink(e,t):e.clearLink()},redo({node:e,lName:t,userPath:i}){e.clearLink()}},changeLink:{async doit({node:e,lName:t,userPath:i}){i=i.trim(),t=k.cleanLink(t);const s=e.copy();u.saveEdit("changeLink",{node:e,previous:s,lName:t,userPath:i}),t.length?i.length>0?(await u.doc.importFromModel(e,t,i),u.redraw()):u.doc.makeLocalLink(e,t):e.clearLink()},undo({node:e,previous:t,lName:i,userPath:s}){t.link||(t.is.source?e.look.addIcon("factory"):e.look.addIcon("group")),e.fuse(t)},redo({node:e,previous:t,lName:i,userPath:s}){i.length?s.length?u.doc.importFromModel(e,i,s):u.doc.makeLocalLink(e,i):e.clearLink()}},saveToLink:{doit({node:e,newName:t,userPath:i}){!i.length>0||u.doc.exportToModel(e,t,new Mt(u.doc.model.arl.resolve(i)))},undo({}){},redo({}){}},changeFactory:{doit({node:e,newName:t,userPath:i}){var n;const s=e.factory.clone();(n=e.factory)==null||n.resolve(t,i,u.doc.model.arl,e.name),u.saveEdit("changeFactory",{node:e,oldFactory:s,newFactory:e.factory})},undo({node:e,oldFactory:t,newFactory:i}){e.factory=t},redo({node:e,oldFactory:t,newFactory:i}){e.factory=i}}},af={newPin:{doit({view:e,node:t,pos:i,is:s}){i=e.selection.behind()??i;const n=t.look.addPin("",i,s);n.is.proxy?t.addPad(n):t.rxtxAddPin(n),e.selection.adjustForNewWidget(n),e.beginTextEdit(n),u.saveEdit("newPin",{view:e,pin:n})},undo({view:e,pin:t}){if(!t||!t.node.look.widgets.includes(t))return;const i=t.node;e.selection.adjustForRemovedWidget(t),i.look.removePin(t),t.is.proxy?i.pads.pop():i.rxtxPopPin(t)},redo({view:e,pin:t}){if(!t||!t.node.look.widgets.includes(t))return;const i=t.node;i.look.restorePin(t),t.is.proxy?i.addPad(t):i.rxtxAddPin(t),e.selection.adjustForNewWidget(t)}},disconnectPin:{doit({pin:e}){const t=e.routes.slice();e.disconnect(),u.saveEdit("disconnectPin",{pin:e,routes:t})},undo({pin:e,routes:t}){e.reconnect(t)},redo({pin:e,routes:t}){e.disconnect()}},deletePin:{doit({view:e,pin:t}){const i=t.routes.slice(),s=t.is.proxy?t.pad.routes.slice():null;u.saveEdit("deletePin",{view:e,pin:t,pinRoutes:i,padRoutes:s}),e.selection.adjustForRemovedWidget(t),t.disconnect(),t.node.look.removePin(t),t.is.proxy?(t.pad.disconnect(),t.node.removePad(t.pad)):t.node.rxtxRemovePin(t)},undo({view:e,pin:t,pinRoutes:i,padRoutes:s}){const n=i.slice();t.node.look.restorePin(t),e.selection.adjustForNewWidget(t),t.reconnect(n),t.is.proxy&&t.pad.reconnect(s)},redo({view:e,pin:t,pinRoutes:i,padRoutes:s}){t.disconnect(),e.selection.adjustForRemovedWidget(t),t.node.look.removePin(t)}},ioSwitch:{doit({pin:e}){e.ioSwitch()&&u.saveEdit("ioSwitch",e)},undo({pin:e}){e.ioSwitch()},redo({pin:e}){e.ioSwitch()}},channelOnOff:{doit({pin:e}){e.channelOnOff()&&u.saveEdit("channelOnOff",e)},undo({pin:e}){e.channelOnOff()},redo({pin:e}){e.channelOnOff()}},pinDrag:{doit({pin:e}){u.saveEdit("pinDrag",{pin:e,oldPos:{left:e.is.left,y:e.rect.y},newPos:null})},undo({pin:e,oldPos:t,newPos:i}){e.moveTo(t.left,t.y)},redo({pin:e,oldPos:t,newPos:i}){e.moveTo(i.left,i.y)}},showProfile:{doit({pin:e,pos:t}){var s;if(!((s=u.doc)!=null&&s.model))return;const i=e.is.input?u.doc.model.getInputPinProfile(e):u.doc.model.getOutputPinProfile(e);if(!i){console.log(`NO PROFILE ${e.name}`);return}u.tx.send("pin profile",{pos:t,pin:e,profile:i,open(n){const o=u.doc.model.arl.resolve(n.file);u.tx.send("open source file",{arl:o,line:n.line})}})},undo(){},redo(){}},addLabel:{doit({node:e}){var i,s;let t=e.look.widgets.find(n=>n.is.label)??e.look.addLabel("");(s=(i=u.doc)==null?void 0:i.focus)==null||s.beginTextEdit(t),u.saveEdit("addLabel",{node:e,label:t})},undo({node:e,label:t}){e.look.removeLabel()},redo({node:e,label:t}){e.look.restoreLabel(t)}},widgetTextEdit:{doit({view:e,widget:t,cursor:i,clear:s}){var o;const n=(o=t.startEdit)==null?void 0:o.call(t);n&&(u.saveEdit("widgetTextEdit",{widget:t,prop:n,oldText:t[n],newText:""}),e.beginTextEdit(t,i,s??!1))},undo({widget:e,prop:t,oldText:i,newText:s}){s=e[t],u.getParam().newText=s,e[t]=i,e.endEdit(s)},redo({widget:e,prop:t,oldText:i,newText:s}){e[t]=s,e.endEdit(i)}}},lf={newInterfaceName:{doit({view:e,node:t,pos:i}){i=e.selection.behind()??i;let s=t.look.addIfName("",i);e.beginTextEdit(s),e.selection.adjustForNewWidget(s),u.saveEdit("newInterfaceName",{ifName:s})},undo({ifName:e}){e.node.look.removeInterfaceName(e)},redo({ifName:e}){e.node.look.restoreInterfaceName(e)}},deleteInterfaceName:{doit({view:e,ifName:t}){e.selection.adjustForRemovedWidget(t);const i=t.node.look.showPrefixes(t);t.node.look.removeInterfaceName(t),u.saveEdit("deleteInterfaceName",{view:e,ifName:t,pxlenArray:i})},undo({view:e,ifName:t,pxlenArray:i}){t.node.look.restoreInterfaceName(t),t.node.look.hidePrefixes(t,i),e.selection.switchToWidget(t)},redo({view:e,ifName:t,pxlenArray:i}){e.selection.switchToWidget(),t.node.look.showPrefixes(t),t.node.look.removeInterfaceName(t)}},interfaceDrag:{doit({group:e,oldY:t,newY:i}){u.saveEdit("interfaceDrag",{group:e,oldY:t,newY:i})},undo({group:e,oldY:t,newY:i}){const s=t-i;e[0].node.look.groupMove(e,s)},redo({group:e,oldY:t,newY:i}){const s=i-t;e[0].node.look.groupMove(e,s)}},interfaceNameDrag:{doit({ifName:e}){u.saveEdit("interfaceNameDrag",{ifName:e,oldY:e.rect.y,newY:e.rect.y})},undo({ifName:e,oldY:t,newY:i}){e.moveTo(t)},redo({ifName:e,oldY:t,newY:i}){e.moveTo(i)}}},cf={routeDrag:{doit({route:e}){u.saveEdit("routeDrag",{route:e,oldWire:e.copyWire(),newWire:null})},undo({route:e,oldWire:t,newWire:i}){e.restoreWire(t)},redo({route:e,oldWire:t,newWire:i}){e.restoreWire(i)}},routeDraw:{doit({route:e}){u.saveEdit("routeDraw",{route:e,newRoute:e.clone()}),e.checkTwistedPair()},undo({route:e,newRoute:t}){e.disconnect()},redo({route:e,newRoute:t}){t&&e.connectFromClone(t)}},deleteRoute:{doit({route:e}){u.saveEdit("deleteRoute",{route:e,oldRoute:e.clone()}),e.disconnect(),e.remove()},undo({route:e,oldRoute:t}){t&&e.connectFromClone(t)},redo({route:e,oldRoute:t}){e.disconnect(),e.remove()}}},hf={busHighlight:{doit({bus:e}){e.is.highLighted?e.unHighLight():e.highLight(),u.saveEdit("busHighLight",{bus:e})},undo({bus:e}){e.is.highLighted?e.unHighLight():e.highLight()},redo({bus:e}){e.is.highLighted?e.unHighLight():e.highLight()}},busCreate:{doit({view:e,pos:t,cable:i}){e.state.bus=e.root.addBus("",t),u.saveEdit("busCreate",{node:e.root,bus:e.state.bus}),i&&(e.state.bus.is.cable=!0)},undo({node:e,bus:t}){e.removeBus(t)},redo({node:e,bus:t}){e.restoreBus(t)}},busChangeName:{doit({bus:e,label:t}){u.doc.focus.state.bus=e,e.selected=!0,t||(t=e.startLabel),u.doc.focus.beginTextEdit(t),u.saveEdit("busChangeName",{label:t,oldName:t.text,newName:null})},undo({label:e,oldName:t,newName:i}){u.getParam().newName=e.text,e.setText(t)},redo({label:e,oldName:t,newName:i}){e.setText(i)}},busChangeType:{doit({bus:e}){const t=e.tacks.slice();u.saveEdit("busChangeType",{bus:e,tacks:t}),e.disconnect(),e.is.cable=!e.is.cable,e.reconnect(t)},undo({bus:e,tacks:t}){const i=t.slice();e.disconnect(),e.is.cable=!e.is.cable,e.reconnect(i)},redo({bus:e,tacks:t}){const i=t.slice();e.disconnect(),e.is.cable=!e.is.cable,e.reconnect(i)}},busDeleteRouter:{doit({bus:e}){u.saveEdit("busDeleteRouter",{bus:e}),e.is.filter=!1},undo({bus:e}){e.is.filter=!0},redo({bus:e}){e.is.filter=!1}},busChangeRouter:{doit({bus:e,newName:t,userPath:i}){const s=e.filter?e.filter.clone():null;e.filter||(e.filter=new Zi),e.filter.resolve(t,i,u.doc.model.arl,e.name),e.is.filter=!0,u.saveEdit("busChangeRouter",{bus:e,oldRouter:s,newRouter:e.filter})},undo({bus:e,oldRouter:t,newRouter:i}){e.filter=t},redo({bus:e,oldRouter:t,newRouter:i}){e.filter=i}},busStraightConnections:{doit({bus:e}){const t=[];for(const i of e.tacks)t.push({tack:i,oldPos:{x:i.rect.x,y:i.rect.y},wire:i.route.copyWire()});u.saveEdit("busStraightConnections",{bus:e,wireArray:t}),e.straightConnections()},undo({bus:e,wireArray:t}){for(const i of t){const s=i.tack;s.pos.x=i.oldPos.x,s.pos.y=i.oldPos.y,s.route.restoreWire(i.wire)}},redo({bus:e,wireArray:t}){e.straightConnections()}},busDisconnect:{doit({bus:e}){u.saveEdit("busDisconnect",{bus:e,tacks:e.tacks.slice()}),e.disconnect()},undo({bus:e,tacks:t}){e.reconnect(t.slice())},redo({bus:e,tacks:t}){e.disconnect()}},busDelete:{doit({bus:e}){u.saveEdit("busDelete",{node:u.doc.focus.root,bus:e,tacks:e.tacks.slice()}),u.doc.focus.root.deleteBus(e)},undo({node:e,bus:t,tacks:i}){e.restoreBus(t),t.reconnect(i.slice())},redo({node:e,bus:t,tacks:i}){t.disconnect(),e.removeBus(t)}},busDraw:{doit({bus:e}){u.saveEdit("busDraw",{bus:e,oldWire:e.copyWire(),newWire:null})},undo({bus:e,oldWire:t,newWire:i}){e.restoreWire(t),e.startLabel.place(),e.endLabel.place()},redo({bus:e,oldWire:t,newWire:i}){e.restoreWire(i),e.startLabel.place(),e.endLabel.place()}},busSegmentDrag:{doit({bus:e}){u.saveEdit("busSegmentDrag",{bus:e,oldWire:e.copyWire(),newWire:null,oldTackWires:e.copyTackWires(),newTackWires:null})},undo({bus:e,oldWire:t,newWire:i,oldTackWires:s,newTackWires:n}){e.restoreWire(t),e.restoreTackWires(s),e.startLabel.place(),e.endLabel.place(),e.placeTacks()},redo({bus:e,oldWire:t,newWire:i,oldTackWires:s,newTackWires:n}){e.restoreWire(i),e.restoreTackWires(n),e.startLabel.place(),e.endLabel.place(),e.placeTacks()}},busDrag:{doit({bus:e}){u.saveEdit("busDrag",{bus:e,oldWire:e.copyWire(),newWire:null,oldTackWires:e.copyTackWires(),newTackWires:null})},undo({bus:e,oldWire:t,newWire:i,oldTackWires:s,newTackWires:n}){e.restoreWire(t),e.restoreTackWires(s),e.startLabel.place(),e.endLabel.place(),e.placeTacks()},redo({bus:e,oldWire:t,newWire:i,oldTackWires:s,newTackWires:n}){e.restoreWire(i),e.restoreTackWires(n),e.startLabel.place(),e.endLabel.place(),e.placeTacks()}},tackDrag:{doit({tack:e}){u.saveEdit("tackDrag",{tack:e,oldWire:e.route.copyWire(),newWire:null})},undo({tack:e,oldWire:t,newWire:i}){e.route.restoreWire(t),e.orient()},redo({tack:e,oldWire:t,newWire:i}){e.route.restoreWire(i),e.orient()}}},df={padCreate:{doit({view:e,pos:t,input:i}){if(!e.root)return;const s={input:i,left:t.x<e.middle().x};let n=e.root.look.addPin("",t,s);const o=n.makePadRect({x:t.x,y:t.y-style.pad.hPad/2}),r=new Si(o,n);s.left&&(r.rect.x-=r.rect.w),e.root.pads.push(r),u.doc.UID.generate(r),e.beginTextEdit(r),u.saveEdit("padCreate",{view:e,pad:r})},undo({view:e,pad:t}){e.root.pads.includes(t)&&(t.disconnect(),e.root.removePad(t),t.proxy.disconnect(),e.root.look.removePin(t.proxy))},redo({view:e,pad:t}){e.root.pads.includes(t)&&(e.root.restorePad(t),e.root.look.restorePin(t.proxy))}},changeNamePad:{doit({view:e,pad:t}){t!=null&&t.proxy&&(u.saveEdit("changeNamePad",{pad:t,oldName:t.text,newName:null}),e.beginTextEdit(t))},undo({pad:e,oldName:t,newName:i}){u.getParam().newName=e.text;const s=e.proxy.node;e.text.length==0&&(s.restorePad(e),s.look.restorePin(e.proxy)),e.proxy.name=t,e.nameChange(t)},redo({pad:e,oldName:t,newName:i}){const s=e.proxy.node;if(!i||i.length==0){s.removePad(e),s.look.removePin(e.proxy);return}e.proxy.name=i,e.nameChange(i)}},disconnectPad:{doit({pad:e}){u.saveEdit("disconnectPad",{pad:e,routes:e.routes.slice()}),e.disconnect()},undo({pad:e,routes:t}){e.reconnect(t.slice())},redo({pad:e,routes:t}){e.disconnect()}},deletePad:{doit({pad:e}){u.saveEdit("deletePad",{pad:e,routes:e.routes.slice()});const t=u.doc.focus.root;e.disconnect(),t.removePad(e),e.proxy.disconnect(),t.look.removePin(e.proxy)},undo({pad:e,routes:t}){const i=e.proxy.node;i.restorePad(e),i.look.restorePin(e.proxy),e.reconnect(t.slice())},redo({pad:e,routes:t}){e.disconnect(),e.proxy.node.removePad(e),e.proxy.disconnect(),e.proxy.node.look.removePin(e.proxy)}},extrudePad:{doit({view:e,pos:t}){const i=e.hit.lookWidget;if(!i.is.pin)return;const s={...i.is};s.proxy=!0;const n=e.root.look.addPin(i.name,t,s),o=i.makePadRect(t),r=new Si(o,n);u.doc.UID.generate(r),r.place(),r.shortConnection(i),u.saveEdit("extrudePad",{pad:r,routes:r.routes.slice()}),e.root.pads.push(r),e.state.pad=r},undo({pad:e,routes:t}){e.disconnect(),e.proxy.node.removePad(e)},redo({pad:e,routes:t}){const i=e.proxy.node;i.restorePad(e),i.look.restorePin(e.proxy),e.reconnect(t.slice())}},padDrag:{doit({pad:e}){u.saveEdit("padDrag",{pad:e,oldPos:{x:e.rect.x,y:e.rect.y},oldWires:e.copyWires(),newPos:null,newWires:null})},undo({pad:e,oldPos:t,oldWires:i,newPos:s,newWires:n}){const o={x:t.x-s.x,y:t.y-s.y};e.move(o),e.restoreWires(i)},redo({pad:e,oldPos:t,oldWires:i,newPos:s,newWires:n}){const o={x:s.x-t.x,y:s.y-t.y};e.move(o),e.restoreWires(n)}}},uf={alignVertical:{doit({view:e,left:t}){const i=e.selection.nodes,s=e.selection.pads;let n=[],o=[];i.length>1&&(n=e.nodesAlignHD(i,t),e.moveNodesAndRoutes(i,n)),s.length>1&&(o=e.padsAlignHD(s,t),e.movePadsAndRoutes(s,o)),u.saveEdit("alignVertical",{view:e,nodes:i,deltaNodes:n,pads:s,deltaPads:o})},undo({view:e,nodes:t,deltaNodes:i,pads:s,deltaPads:n}){i.length>0&&e.moveNodesAndRoutes(t,i,!0),n.length>0&&e.movePadsAndRoutes(s,n,!0)},redo({view:e,nodes:t,deltaNodes:i,pads:s,deltaPads:n}){i.length>0&&e.moveNodesAndRoutes(t,i,!1),n.length>0&&e.movePadsAndRoutes(s,n,!1)}},spaceVertical:{doit({view:e}){const t=e.selection.nodes,i=e.selection.pads;let s=[],n=[];t.length>1&&(s=e.nodesSpaceVD(t),e.moveNodesAndRoutes(t,s)),i.length>1&&(n=e.padsSpaceVD(i),e.movePadsAndRoutes(i,n)),u.saveEdit("spaceVertical",{view:e,nodes:t,deltaNodes:s,pads:i,deltaPads:n})},undo({view:e,nodes:t,deltaNodes:i,pads:s,deltaPads:n}){i.length>0&&e.moveNodesAndRoutes(t,i,!0),n.length>0&&e.movePadsAndRoutes(s,n,!0)},redo({view:e,nodes:t,deltaNodes:i,pads:s,deltaPads:n}){i.length>0&&e.moveNodesAndRoutes(t,i,!1),n.length>0&&e.movePadsAndRoutes(s,n,!1)}},alignHorizontal:{doit({view:e,top:t}){const i=e.selection.nodes;if(i.length<2)return;const s=e.nodesAlignVD(i);e.moveNodesAndRoutes(i,s),u.saveEdit("alignHorizontal",{view:e,nodes:i,deltaNodes:s})},undo({view:e,nodes:t,deltaNodes:i}){i.length>0&&e.moveNodesAndRoutes(t,i,!0)},redo({view:e,nodes:t,deltaNodes:i}){i.length>0&&e.moveNodesAndRoutes(t,i,!1)}},spaceHorizontal:{doit({view:e}){const t=e.selection.nodes;if(t.length<2)return;const i=e.nodesSpaceHD(t,left);e.moveNodesAndRoutes(t,i),u.saveEdit("spaceHorizontal",{view:e,nodes:t,deltaNodes:i})},undo({view:e,nodes:t,deltaNodes:i}){i.length>0&&e.moveNodesAndRoutes(t,i,!0)},redo({view:e,nodes:t,deltaNodes:i}){i.length>0&&e.moveNodesAndRoutes(t,i,!1)}},selectionDrag:{doit({view:e}){const t=e.selection.shallowCopy(),i={x:t.rect.x,y:t.rect.y};u.saveEdit("selectionDrag",{view:e,selection:t,oldPos:i,newPos:null})},undo({view:e,selection:t,oldPos:i,newPos:s}){t.drag({x:i.x-s.x,y:i.y-s.y}),e.selection.setRect(i.x,i.y,t.rect.w,t.rect.h)},redo({view:e,selection:t,oldPos:i,newPos:s}){t.drag({x:s.x-i.x,y:s.y-i.y}),e.selection.setRect(s.x,s.y,t.rect.w,t.rect.h)}},disconnectSelection:{doit({selection:e}){const t=[];for(const i of e.nodes)t.push(i.getRoutes()),i.disconnect();u.saveEdit("disconnectSelection",{selection:e.shallowCopy(),allRoutes:t})},undo({selection:e,allRoutes:t}){for(const i of t)for(const s of i)s.reconnect()},redo({selection:e,allRoutes:t}){for(const i of e.nodes)i.disconnect()}},deleteSelection:{doit({view:e}){const t=[],i=e.selection;for(const s of i.nodes)t.push(s.getRoutes()),s.disconnect(),e.root.removeNode(s);for(const s of i.pads)s.disconnect(),e.root.removePad(s),s.proxy.disconnect(),e.root.look.removePin(s.proxy);for(const s of i.buses)s.tacks.length==0&&e.root.removeBus(s);u.saveEdit("deleteSelection",{view:e,selection:i.shallowCopy(),allRoutes:t}),i.reset(),e.stateSwitch(S.nothing)},undo({view:e,selection:t,allRoutes:i}){for(const s of t.nodes)e.root.addNode(s);for(const s of t.pads){const n=s.proxy.node;n.restorePad(s),n.look.restorePin(s.proxy)}for(const s of t.buses)s.tacks.length==0&&e.root.restoreBus(s);for(const s of i)for(const n of s)n.reconnect()},redo({view:e,selection:t,allRoutes:i}){for(const s of t.nodes)s.disconnect(),e.root.removeNode(s);for(const s of t.pads)s.disconnect(),e.root.removePad(s),s.proxy.disconnect(),e.root.look.removePin(s.proxy);for(const s of t.buses)s.tacks.length==0&&e.root.removeBus(s)}},selectionToClipboard:{doit({view:e}){e.selectionToClipboard()},undo(){},redo(){}},pasteFromClipboard:{doit({view:e,pos:t,clipboard:i}){e.clipboardToSelection(t,i),u.doc.model.arl.sameDir(i.origin.arl)||i.selection.adjustPaths(u.doc.model.arl),e.checkPastedNames(i.copyCount),u.saveEdit("pasteFromClipboard",{view:e,selection:e.selection.shallowCopy()})},undo({view:e,selection:t}){e.removeSelection(t)},redo({view:e,selection:t}){e.restoreSelection(t)}},linkFromClipboard:{doit({view:e,pos:t,clipboard:i}){i.origin.arl.makeRelative(u.doc.model.arl),e.clipboardToSelection(t,i),e.linkToClipboardNodes(i.origin,i.selection.viewPath),e.checkPastedNames(i.copyCount),u.saveEdit("linkFromClipboard",{view:e,selection:e.selection.shallowCopy()})},undo({view:e,selection:t}){e.removeSelection(t)},redo({view:e,selection:t}){e.restoreSelection(t)}},selectionToGroup:{doit({view:e}){const t=e.selection;if(t.nodes.length==0)return;const i=[];for(const o of t.nodes)i.push(o.getRoutes());const s=e.selectionToGroup(u.doc.UID),n={dx:s.savedView.rect.x,dy:s.savedView.rect.y};u.saveEdit("selectionToGroup",{view:e,selection:t.shallowCopy(),newGroup:s,shift:n,allRoutes:i}),t.reset(),e.stateSwitch(S.nothing)},undo({view:e,selection:t,newGroup:i,shift:s,allRoutes:n}){e.undoSelectionToGroup(t,i,s,n)},redo({view:e,selection:t,newGroup:i,allRoutes:s}){}},unGroup:{doit({view:e,node:t}){if(!t.is.group||t.isConnected())return;const i=[];for(const n of t.pads)for(const o of n.routes)i.push(o);const s={dx:e.rect.x,dy:e.rect.y};u.saveEdit("unGroup",{view:e,node:t,shift:s,padRoutes:i}),e.transferToSelection(t,s)},undo({view:e,node:t,shift:i,padRoutes:s}){e.undoTransferToSelection(t,i,s)},redo({view:e,node:t,shift:i,padRoutes:s}){}}},ff={disconnectPinArea:{doit({view:e,node:t,widgets:i}){const s=t.getAllRoutes(i);t.disconnectPinArea(i),u.saveEdit("disconnectPinArea",{node:t,widgets:i.slice(),allRoutes:s})},undo({node:e,widgets:t,allRoutes:i}){for(const s of i)s.reconnect()},redo({node:e,widgets:t,allRoutes:i}){e.disconnectPinArea(t)}},deletePinArea:{doit({view:e,node:t,widgets:i}){const s=t.getAllRoutes(i);u.saveEdit("deletePinArea",{view:e,node:t,widgets:i.slice(),allRoutes:s}),t.disconnectPinArea(i),t.look.deletePinArea(i)},undo({view:e,node:t,widgets:i,allRoutes:s}){const n=i[0],o={x:n.rect.x,y:n.rect.y};t.look.copyPinArea(i,o),t.is.source?t.rxtxAddPinArea(i):t.addPads(i);for(const r of s)r.reconnect()},redo({view:e,node:t,widgets:i,allRoutes:s}){t.disconnectPinArea(i),t.look.deletePinArea(i)}},swapPinArea:{doit({view:e,left:t,right:i}){var n;if(!((n=e.selection.widgets)!=null&&n.length))return;const s=[];for(let o of e.selection.widgets)o.is.pin&&t&&!o.is.left&&s.push(o),o.is.pin&&i&&o.is.left&&s.push(o);for(const o of s)o.leftRightSwap();u.saveEdit("swapPinArea",{swapped:s})},undo({swapped:e}){for(const t of e)t.leftRightSwap()},redo({swapped:e}){for(const t of e)t.leftRightSwap()}},pasteWidgetsFromClipboard:{doit({view:e,clipboard:t}){if(t.selection.what!=C.pinArea&&t.selection.what!=C.ifArea)return;const[i,s]=e.selection.whereToAdd();!i||i.cannotBeModified()||(e.clipboardToSelection(s,t),u.saveEdit("pasteWidgetsFromClipboard",{view:e,node:i,widgets:e.selection.widgets.slice(),pos:s}))},undo({view:e,node:t,widgets:i,pos:s}){i&&t.look.deletePinArea(i),e.selection.reset()},redo({view:e,node:t,widgets:i,pos:s}){const n=t.look.copyPinArea(i,s);t.is.source?t.rxtxAddPinArea(i):t.addPads(i),e.selection.pinAreaSelect(n),i.splice(0,i.length,...n)}},pinAreaToMulti:{doit({view:e,widgets:t}){u.saveEdit("pinAreaToMulti",{view:e,widgets:t})},undo({view:e,widgets:t}){},redo(){}},multiToPinArea:{doit({view:e,pin:t}){u.saveEdit("multiToPinArea",{view:e,pin:t})},undo({view:e,pin:t}){},redo(){}},ioSwitchPinArea:{doit({view:e}){if(!e.selection.widgets.length)return;const t=[];for(const i of e.selection.widgets)i.is.pin&&i.ioSwitch()&&t.push(i);t.length&&u.saveEdit("ioSwitchPinArea",{view:e,switched:t})},undo({view:e,switched:t}){for(const i of t)i.ioSwitch()},redo(){}}},pf={panning:{doit({view:e}){},undo({}){},redo({}){}},xxpanning:{doit({view:e}){u.saveEdit("panning",{view:e,oldTf:{...e.tf},newTf:{...e.tf}})},undo({view:e,oldTf:t,newTf:i}){i.dx=e.tf.dx,i.dy=e.tf.dy,e.tf.dx=t.dx,e.tf.dy=t.dy},redo({view:e,oldTf:t,newTf:i}){e.tf.dx=i.dx,e.tf.dy=i.dy}},zooming:{doit({view:e}){},undo({}){},redo({}){}}},Bs={};Object.assign(Bs,of,rf,af,lf,cf,hf,df,uf,ff,pf);const gf={adjustRoutes(){for(const e of this.routes)e.adjust()},routeToPin(e){let t=new bt(e,this);t.fourPointRoute(),this.routes.push(t),e.routes.push(t)},shortConnection(e){let t=new bt(e,this);t.twoPointRoute(),this.routes.push(t),e.routes.push(t)},canConnect(e){return!(e.is.pin&&(this.proxy.is.input!=e.is.input||e.is.channel&&!this.proxy.is.channel||(e.is.multi||this.proxy.is.multi)&&!e.hasMultiOverlap(this.proxy))||this.routes.find(t=>t.from==e||t.to==e))},disconnect(){const e=this.routes.slice();for(const t of e)(t.from==this?t.to:t.from).is.pin?t.rxtxPinPadDisconnect():t.rxtxPadBusDisconnect(),t.remove()},reconnect(e){this.routes=e;for(const t of e){const i=t.from==this?t.to:t.from;i.is.pin?i.routes.push(t):i.bus.push(i)}},checkRoutesDirection(){this.routes.forEach(e=>{e.from==this&&e.reverse()})},drag(e,t){if(this.routes.length>0){const i=this.routes[0].wire,[s,n]=this.routes[0].from==this?[i[0],i[1]]:[i.at(-1),i.at(-2)],o=s.y==n.y?{x:s.x+t.x,y:e.y}:{x:e.x,y:s.y+t.y};for(const a of this.routes)a.drawXY(o);s.y==n.y&&(this.is.leftText=s.x<n.x);const r=this.rect;r.y=s.y-r.h/2,r.x=this.is.leftText?s.x-r.w:s.x}else this.rect.x+=t.x,this.rect.y+=t.y},xdrag(e,t){if(this.routes.length>0){const i=this.routes[0].wire;if(i.length>0){const s=i.at(-1);e=i.at(-2).y==s.y?{x:s.x+t.x,y:e.y}:{x:e.x,y:s.y+t.y}}for(const s of this.routes)s.drawXY(e);this.place()}else this.rect.x+=t.x,this.rect.y+=t.y},endDrag(){this.routes.forEach(e=>e.endpoint(this))},slide(e){this.routes.forEach(t=>{const i=t.wire;i.length==2&&t.fourPointRoute();const[s,n]=this==t.from?[i[0],i[1]]:[i.at(-1),i.at(-2)];s.y+=e.y,n.y+=e.y}),this.rect.y+=e.y},fuseEndSegment(){let e=null,t=0;for(const i of this.routes){if(i.wire.length<4)continue;const s=i.wire,[n,o,r,a]=this==i.from?[s[0],s[1],s[2],!0]:[s.at(-1),s.at(-2),s.at(-3),!1];if(Math.abs(r.y-o.y)<m.route.tooClose){t=r.y-n.y,n.y=r.y,a?i.removeTwoPoints(1,s):i.removeTwoPoints(s.length-3,s),e=i;break}}if(e){for(const i of this.routes){if(i==e)continue;const s=i.wire,[n,o]=this==i.from?[s[0],s[1]]:[s.at(-1),s.at(-2)];n.y+=t,o.y+=t}this.rect.y+=t}},copyPadPinRoutes(e,t){for(const i of e.routes){const s=i.from==e?i.to:i.from;if(!s.is.pin)continue;const n=i.clone();n.to==e?n.to=this:n.from=this,this.routes.push(n);const r=t.nodes.find(a=>a.uid==s.node.uid).look.findPin(s.name,s.is.input);n.from==this?n.to=r:n.from=r,r.routes.push(n)}},removeRoute(e){Ce(this.routes,e)},copyWires(){const e=[];for(const t of this.routes)e.push(t.copyWire());return e},restoreWires(e){const t=this.routes.length;for(let i=0;i<t;i++)this.routes[i].restoreWire(e[i])},highLightRoutes(){for(const e of this.routes){const t=e.from==this?e.to:e.from;if(t){if(t.is.pin){if(!this.areConnected(t))continue;e.highLight()}t.is.tack&&(e.highLight(),t.bus.highLightRoutes(this))}}},unHighLightRoutes(){for(const e of this.routes){e.unHighLight();const t=e.from==this?e.to:e.from;t&&t!=null&&t.is.tack&&t.bus.unHighLightRoutes(this)}},checkRouteUsage(){for(const t of this.routes)t.is.notUsed=!1;const e=this.proxy;for(const t of this.routes){const i=t.from==this?t.to:t.from;if(i.is.pin)(i.is.multi||e.is.multi)&&!e.hasMultiOverlap(i)&&(t.is.notUsed=!0);else if(i.is.tack){let s=!1;for(const n of i.bus.tacks){if(n==i)continue;const o=n.route.to==n?n.route.from:n.route.to;i.bus.areConnected(this,o)&&(n.route.is.notUsed=!1,s=!0)}s||(t.is.notUsed=!0)}}}};function Si(e,t,i=null){this.uid=i,this.rect={...e},this.is={pad:!0,selected:!1,highLighted:!1,leftText:t.is.left,hoverOk:!1,hoverNok:!1,beingEdited:!1},this.text=t.name,this.proxy=t,this.routes=[]}Si.prototype={copy(){return new Si(this.rect,this.proxy,this.uid)},render(e,t){var c;let i=m.pad;const s=this.rect,n=this.proxy,o=this.is.hoverNok?i.cBad:i.cBackground;let r=this.is.highLighted?i.cHighLighted:this.is.selected||this.is.hoverOk?i.cSelected:((c=this.routes)==null?void 0:c.length)>0?i.cConnected:i.cText;const a=r;let l=s.y+(i.hPad-i.wArrow)/2;if(this.is.beingEdited&&(s.w=m.pad.wExtra+e.measureText(this.text).width,this.place()),this.is.leftText){const h=s.x+s.w-i.rBullet/2-i.hArrow;$.rectBullet(e,s.x,s.y,s.w,s.h,o,i.rBullet),n.is.channel?n.is.input?$.ballTriangle(e,h,l,i.hArrow,i.wArrow,a):$.triangleBall(e,h,l,i.hArrow,i.wArrow,a):n.is.input?$.rightTriangle(e,h,l,i.hArrow,i.wArrow,a):$.leftTriangle(e,h,l,i.hArrow,i.wArrow,a),n.is.multi?$.leftTextMulti(e,this.text,m.pin.fMulti,r,s.x+m.pad.wMargin,s.y,s.w,s.h):$.leftText(e,this.text,r,s.x+m.pad.wMargin,s.y,s.w,s.h)}else{const h=s.x+i.rBullet/2;$.bulletRect(e,s.x,s.y,s.w,s.h,o,i.rBullet),n.is.channel?n.is.input?$.triangleBall(e,h,l,i.hArrow,i.wArrow,a):$.ballTriangle(e,h,l,i.hArrow,i.wArrow,a):n.is.input?$.leftTriangle(e,h,l,i.hArrow,i.wArrow,a):$.rightTriangle(e,h,l,i.hArrow,i.wArrow,a),n.is.multi?$.rightTextMulti(e,this.text,m.pin.fMulti,r,s.x,s.y,s.w,s.h):$.rightText(e,this.text,r,s.x,s.y,s.w,s.h)}},drawCursor(e,t,i){const s=this.rect,n=e.measureText(this.text.slice(0,t)).width,o=this.is.leftText?s.x+n+m.pad.wMargin:s.x+s.w-e.measureText(this.text).width+n,r=i?m.std.cBlinkOn:m.std.cBlinkOff;$.cursor(e,o,s.y,m.std.wCursor,s.h,r)},center(){const e=this.rect;return this.is.leftText?{x:e.x+e.w,y:e.y+e.h/2}:{x:e.x,y:e.y+e.h/2}},place(){const e=this.routes[0];if(!(e!=null&&e.wire.length))return;const[t,i]=e.from==this?[e.wire[0],e.wire[1]]:[e.wire.at(-1),e.wire.at(-2)];this.is.leftText=t.x<i.x;const s=this.rect;s.y=t.y-s.h/2,s.x=this.is.leftText?t.x-s.w:t.x},startEdit(){return this.is.beingEdited=!0,"text"},getWidth(){const e=this.proxy;return m.pad.wExtra+e.node.look.getTextWidth(this.text,e.is.multi)},endEdit(e){const t=this.proxy;if(this.is.beingEdited=!1,this.text.length>0){if(t.name=this.text,!t.checkNewName()){t.name=this.text=e;return}this.text=t.name,this.checkRouteUsage(),this.rect.w=this.getWidth();return}if(t.routes.length==0){t.node.look.removePin(t),t.node.removePad(this);return}this.text=e},nameChange(e){this.text=e,this.rect.w=this.getWidth()},overlap(e){const t=this.rect;return!(t.x>e.x+e.w||t.x+t.w<e.x||t.y>e.y+e.h||t.y+t.h<e.y)},bluviz(){return{blu:null,viz:k.padToString(this)}},moveTo(e,t){this.rect.x=e,this.rect.y=t,this.adjustRoutes()},move(e){this.rect.x+=e.x,this.rect.y+=e.y},areConnected(e){return!(e.is.pin&&this.proxy.is.multi&&!e.hasMultiOverlap(this.proxy))},makeConxList(e){var t;for(const i of this.routes){const s=i.from==this?i.to:i.from;this.areConnected(s)&&(s.is.pin?s.is.proxy?(t=s.pad)==null||t.makeConxList(e):e.push(s):s.is.tack&&(s.bus.hasFilter()?e.push(s):s.bus.makeConxList(this,e)))}},highLight(){this.is.highLighted=!0},unHighLight(){this.is.highLighted=!1},hitTest(e){return at(e,this.rect)?this.is.leftText?e.x>this.rect.x+this.rect.w-2*m.pad.rBullet?[H.padArrow,this]:[H.pad,this]:e.x<this.rect.x+2*m.pad.rBullet?[H.padArrow,this]:[H.pad,this]:[H.nothing,null]},hitRoute(e){let t=0;for(const i of this.routes)if(i.from==this&&(t=i.hitSegment(e)))return[H.route,i,t];return[H.nothing,null,0]}};Object.assign(Si.prototype,gf);const mf={addHeader(){const e=2*(m.icon.xPadding+2*m.icon.wIcon+m.icon.xSpacing),t=this.getTextWidth(this.node.name)+e,i=this.rect;t>i.w&&this.wider(t-i.w);const s={x:i.x,y:i.y,w:i.w,h:m.header.hTitle},n=new Zs(s,this.node);return this.widgets.push(n),n},addLabel(e){const t=this.rect;this.getTextWidth(e);const i={x:t.x,y:t.y-m.label.hLabel,w:t.w,h:m.label.hLabel},s=new en(i,e,this.node);return this.widgets.push(s),t.y-=m.label.hLabel,t.h+=m.label.hLabel,s},removeLabel(){const e=this.findLabel();e&&(Ce(this.widgets,e),this.rect.y+=m.label.hLabel,this.rect.h-=m.label.hLabel)},restoreLabel(e){this.widgets.push(e),this.rect.y-=m.label.hLabel,this.rect.h+=m.label.hLabel},addPin(e,t,i){const s=i.left??t.x<this.rect.x+this.rect.w/2,n=this.displayName(e,t.y),o=this.pinRectangle(n,t.y,s,i.multi),r=i.proxy?new ks(o,this.node,e,i):new Pi(o,this.node,e,i);return r.is.left=s,this.addWidget(r),r},removePin(e){e.is.pin&&Ce(this.widgets,e)&&this.shiftUp(e.rect.y,e.rect.h)},restorePin(e){const t=e.rect;this.makePlace({x:t.x,y:t.y},t.h),this.addWidget(e)},addIfName(e,t){const i=this.makePlace(t,m.ifName.hSep),s={x:this.rect.x,y:i,w:this.rect.w,h:m.ifName.hSep},n=new Qs(s,e,this.node);return this.addWidget(n),n},removeInterfaceName(e){e.is.ifName&&Ce(this.widgets,e)&&this.shiftUp(e.rect.y,e.rect.h)},restoreInterfaceName(e){const t=e.rect;this.makePlace({x:t.x,y:t.y},t.h),this.addWidget(e)},copyPinArea(e,t){if(!e||e.length==0)return null;e.sort((n,o)=>n.rect.y-o.rect.y);const i={...t},s=[];for(const n of e)if(n.is.pin){if(this.findPin(n.name,n.is.input))continue;const o=this.addPin(n.name,i,n.is);n.pxlen&&(o.pxlen=n.pxlen,o.checkPrefix()),i.y=o.rect.y+o.rect.h,s.push(o)}else if(n.is.ifName){if(this.findInterfaceName(n.text))continue;const o=this.addIfName(n.text,i);i.y=o.rect.y+o.rect.h,s.push(o)}return s},deletePinArea(e){if(!(!e||e.length==0))for(const t of e)t.is.pin?(t.disconnect(),this.removePin(t),t.is.proxy?(t.pad.disconnect(),t.node.removePad(t.pad)):t.node.rxtxRemovePin(t)):t.is.ifName&&this.removeInterfaceName(t)}},vf={getInterface(e){const t=[];t.push(e);let i=this.rect.y+this.rect.h;for(const s of this.widgets)s.is.ifName&&s.rect.y>e.rect.y&&s.rect.y<i&&(i=s.rect.y);for(const s of this.widgets)s.is.pin&&s.rect.y>=e.rect.y&&s.rect.y<i&&t.push(s);return t.sort((s,n)=>s.rect.y-n.rect.y),t},shiftWidgetsBelow(e,t){for(const i of this.widgets){if(i.is.box){i.rect.h+=t,this.rect.h+=t;continue}if(i.rect.y>e&&(i.rect.y+=t,i.routes))for(const s of i.routes)s.clampToWidget(i)}},swapInterface(e,t){const i=this.findNextWidget(t[0],e,f=>f.is.ifName);if(!i||e.y<i.rect.y||e.y>i.rect.y+i.rect.h)return;const s=e.y>t[0].rect.y,n=this.getInterface(i),o=t[0],r=t.at(-1);let a=r.rect.y-o.rect.y+r.rect.h;s&&(a=-a);const l=n[0],c=n.at(-1);let h=c.rect.y-l.rect.y+c.rect.h;s||(h=-h);for(const f of n)f.rect.y+=a,f.is.pin&&f.adjustRoutes();for(const f of t)f.rect.y+=h,f.is.pin&&f.adjustRoutes()},interfaceChangePrefix(e){const t=this.getInterface(e);for(const i of t)if(i.is.pin&&i.pxlen!=0){const s=i.name;i.changePrefix(e.text),i.nameChanged(s)}},showPrefixes(e){const t=e.node.look.getInterface(e),i=[];for(const s of t)s.is.pin&&s.pxlen!=0&&(i.push(s.pxlen),s.pxlen=0);return i},hidePrefixes(e,t){const i=e.node.look.getInterface(e);for(let s=1;s<t.length;s++)i[s].pxlen=t[s]},highLightInterface(e){const t=this.getInterface(e);for(const i of t)i.highLight(),i.is.pin&&i.highLightRoutes();return t},unhighLightInterface(e){if(e)for(const t of e)t.unHighLight(),t.is.pin&&t.unHighLightRoutes()},findIfNameAbove(e){let t=null;for(const i of this.widgets)i.is.ifName&&i.rect.y<e&&(t==null||t.rect.y<i.rect.y)&&(t=i);return t},getPrefixLength(e,t){const i=this.findIfNameAbove(t);if(!i)return 0;const s=e.indexOf(".");if(s>0&&e.slice(0,s)===i.text)return i.text.length;const n=e.lastIndexOf(".");return n>0&&e.slice(n+1)===i.text?-i.text.length:0},displayName(e,t){return this.getPrefixLength(e,t)>0?"+ "+e.slice(this.pxlen+1):e.slice(0,this.pxlen-1)+" +"},dragPinArea(e,t){const i=e[0];if(t.y<i.rect.y){const n=this.findNextWidget(i,{x:0,y:t.y},o=>o.is.pin||o.is.ifName);if(!n)return;t.y<n.rect.y+n.rect.h/2&&(this.groupMove(e,n.rect.y-i.rect.y),this.interfaceCheck());return}const s=e.at(-1);if(t.y+t.h>s.rect.y+s.rect.h){const n=this.findNextWidget(s,{x:0,y:t.y+t.h},o=>o.is.pin||o.is.ifName);if(!n)return;t.y+t.h>n.rect.y+n.rect.h+n.rect.h/2&&(this.groupMove(e,n.rect.y-s.rect.y),this.interfaceCheck());return}},interfaceCheck(){for(const e of this.widgets)e.is.pin&&(e.pxlen=0);for(const e of this.widgets){if(!e.is.ifName)continue;const t=this.getInterface(e);for(const i of t){if(!i.is.pin)continue;const s=e.text.toLowerCase(),n=i.lowerCase();n.startsWith(s)?i.pxlen=s.length:n.endsWith(s)&&(i.pxlen=-s.length)}}}},wf={headerChanged(e,t){if(e.title.length==0){e.title=e.node.name;return}const i=2*(m.icon.xPadding+2*(m.icon.wIcon+m.icon.xSpacing));let s=this.getTextWidth(e.title)+i;s>this.rect.w&&this.wider(s-this.rect.w),e.node.name=e.title,e.node.is.source&&e.node.factory.fName.length<1&&(e.node.factory.fName=k.nodeToFactory(e.node.name)),u.doc.focus.root.checkDuplicates(e.node)},iconRect(e,t){let i=e.x;const s=m.icon;switch(t){case"L1":i=e.x+s.xPadding;break;case"L2":i=e.x+s.xPadding+s.wIcon+s.xSpacing;break;case"R1":i=e.x+e.w-s.xPadding-s.wIcon;break;case"R2":i=e.x+e.w-s.xPadding-s.wIcon-s.xSpacing-s.wIcon;break}return{x:i,y:e.y+s.yPadding,w:s.wIcon,h:s.hIcon}},addIcon(e){const t=this.widgets.find(r=>r.is.header);if(!t)return;const i={group:"L1",factory:"L1",link:"L1",lock:"L1",cog:"L2",comment:"R1",pulse:"R2"},s=this.iconRect(t.rect,i[e]),n=this.widgets.find(r=>r.is.icon&&r.rect.x==s.x);n&&Ce(this.widgets,n);const o=new xn(s,e);o.setRender(),this.widgets.push(o)},badLinkIcon(){const e=this.widgets.find(t=>t.is.icon&&(t.type=="link"||t.type=="lock"));e&&(e.is.bad=!0)},goodLinkIcon(){const e=this.widgets.find(t=>t.is.icon&&(t.type=="link"||t.type=="lock"));e&&(e.is.bad=!1)},checkLinkIcon(e){const t=this.widgets.find(i=>i.is.icon&&(i.type=="link"||i.type=="lock"));(t==null?void 0:t.type)!=e&&this.addIcon(e)},removeLinkIcon(){const e=this.widgets.find(t=>t.is.icon&&t.type=="link");e&&Ce(this.widgets,e)},blinkToWarn(){const e=a=>{a-r>=n&&(t.is.highLighted=!t.is.highLighted,i.is.highLighted=!i.is.highLighted,u.redraw(),r=a,o++),o<s?requestAnimationFrame(e):(t.is.highLighted=!1,i.is.highLighted=!1,u.redraw())},t=this.widgets.find(a=>a.is.icon&&(a.type=="link"||a.type=="lock")),i=this.widgets.find(a=>a.is.header);if(!t||!i)return;const s=m.icon.nBlinks*2,n=m.icon.blinkRate;let o=0,r=0;requestAnimationFrame(e)},xxxblinkToWarn(){const e=a=>{a-r>=n&&(t.is.highLighted=!t.is.highLighted,i.is.highLighted=!i.is.highLighted,u.redraw(),r=a,o++),o<s?requestAnimationFrame(e):(t.is.highLighted=!1,i.is.highLighted=!1,u.redraw())},t=this.widgets.find(a=>a.is.icon&&(a.type=="link"||a.type=="lock")),i=this.widgets.find(a=>a.is.header);if(!t||!i)return;const s=m.icon.nBlinks*2,n=m.icon.blinkRate;let o=0,r=0;requestAnimationFrame(e)}},xf={moveDelta(e,t){this.rect.x+=e,this.rect.y+=t,this.widgets.forEach(i=>{i.rect.x+=e,i.rect.y+=t})},moveTo(e,t){this.moveDelta(e-this.rect.x,t-this.rect.y)},adjustRoutes(){for(const e of this.widgets)e.routes&&e.adjustRoutes()},moveRoutes(e,t){for(const i of this.widgets)if(i.routes)for(const s of i.routes)s.from==i&&s.moveAllPoints(e,t)},groupMove(e,t){const i=(r,a)=>{r.rect.y+=a,r.is.pin&&r.adjustRoutes()},s=e[0].rect.y,n=e.at(-1).rect.y,o=n-s+e.at(-1).rect.h;for(const r of this.widgets){const a=r.rect.y;a<=n&&a>=s?i(r,t):t>0&&a>n&&a<=n+t?i(r,-o):t<0&&a<s&&a>=s+t&&i(r,o)}},findNextWidget(e,t,i){let s=e.rect.y;if(t.y>=s&&t.y<=s+e.rect.h)return null;let n=null;if(t.y<s)for(const o of this.widgets)!i(o)||o==e||o.rect.y<s&&(n==null||n.rect.y<o.rect.y)&&(n=o);else if(t.y>s+e.rect.h)for(const o of this.widgets)!i(o)||o==e||o.rect.y>s&&(n==null||n.rect.y>o.rect.y)&&(n=o);return n},snapRoutes(){for(const e of this.widgets)if(e.is.pin)for(const t of e.routes){const i=t.wire;if(i.length<3)continue;const[s,n]=e==t.from?[i[0],i[2]]:[i.at(-1),i.at(-3)],o=n.y-s.y;if(Math.abs(o)<m.route.tooClose){this.moveDelta(0,o),this.adjustRoutes();return}}}},yf={copy(e){e.look.widGenerator=this.widGenerator,this.widgets.forEach(t=>{let i=null;t.is.pin?(i=t.is.proxy?new ks(t.rect,e,t.name,t.is):new Pi(t.rect,e,t.name,t.is),i.profile=t.profile,i.pxlen=t.pxlen):t.is.ifName?i=new Qs(t.rect,t.text,e):t.is.header?i=new Zs(t.rect,e):t.is.icon?(i=new xn(t.rect,t.type),i.setRender()):t.is.box?i=new Ks(t.rect,e):t.is.label&&(i=new en(t.rect,t.text,e)),t.wid&&(i.wid=t.wid),i&&e.look.widgets.push(i)})},copyConvert(e){e.look.widGenerator=this.widGenerator,this.widgets.forEach(t=>{let i=null;if(t.is.pin)i=t.is.proxy?new Pi(t.rect,e,t.name,t.is):new ks(t.rect,e,t.name,t.is),i.profile=t.profile,i.pxlen=t.pxlen;else if(t.is.ifName)i=new Qs(t.rect,t.text,e);else if(t.is.header)i=new Zs(t.rect,e);else if(t.is.icon){const s=t.type=="group"?"factory":t.type=="factory"?"group":t.type;e.look.addIcon(s)}else t.is.box?i=new Ks(t.rect,e):t.is.label&&(i=new en(t.rect,t.text,e));t.wid&&(i.wid=t.wid),i&&e.look.widgets.push(i)})},copyPinPinRoutes(e){const t=e.widgets.length;let i=null,s=null;for(let n=0;n<t;n++)if(i=e.widgets[n],s=this.widgets[n],i.is.pin&&i.is.input)for(const o of i.routes){if(!o.to.is.pin||!o.from.is.pin)continue;const r=o.clone();r.from==i?r.from=s:r.to=s,s.routes.push(r)}},correctPinPinRoutes(e){for(const t of this.widgets)if(t.is.input)for(const i of t.routes){const s=i.from==t?i.to:i.from;if(!s.is.pin)continue;const o=e.nodes.find(r=>r.uid==s.node.uid).look.findPin(s.name,!1);i.from==t?i.to=o:i.from=o,o.routes.push(i)}},transferRoutes(e){var t;for(let i=0;i<e.widgets.length;i++){const s=this.widgets[i],n=e.widgets[i];if(((t=s.routes)==null?void 0:t.length)>0)for(const o of s.routes)o.from==s&&(o.from=n),o.to==s&&(o.to=n),n.routes.push(o)}}},bf={getItemsToSave(){const e=[],t={rect:{...this.rect},label:null,interfaces:[]};for(const n of this.widgets)if(!(n.is.icon||n.is.box||n.is.header)){if(n.is.label){t.rect.y+=n.rect.h,t.rect.h-=n.rect.h,t.label=n;continue}(n.is.ifName||n.is.pin)&&e.push(n)}if(e.length==0)return t;e.sort((n,o)=>n.rect.y-o.rect.y);let i=-1,s=null;e[0].is.pin&&(i++,t.interfaces[i]={name:"",pins:[],editor:{id:0}},s=t.interfaces[i].pins);for(const n of e)n.is.pin?s.push(n):n.is.ifName&&(i++,t.interfaces[i]={name:n.text,pins:[],editor:{id:n.wid}},s=t.interfaces[i].pins);return t},bluviz(){const e=[],t={label:null,interfaces:[]},i={rect:{...this.rect},interfaces:[]};for(const r of this.widgets)if(!(r.is.icon||r.is.box||r.is.header)){if(r.is.label){i.rect.y+=r.rect.h,i.rect.h-=r.rect.h,t.label=r;continue}(r.is.pin||r.is.ifName)&&e.push(r)}if(e.length==0)return{blu:t,viz:i};e.sort((r,a)=>r.rect.y-a.rect.y);let s=0,n=null,o=null;e[0].is.pin&&(t.interfaces[s]={interface:"",pins:[]},i.interfaces[s]={interface:"(0)",pins:[]},n=i.interfaces[0].pins,o=t.interfaces[0].pins,s++);for(const r of e){if(r.is.pin){const{blu:a,viz:l}=r.bluviz();o.push(a),n.push(l)}if(r.is.ifName){const a=r.bluviz();t.interfaces[s]={interface:a.blu.interface,pins:[]},i.interfaces[s]={interface:a.viz,pins:[]},o=t.interfaces[s].pins,n=i.interfaces[s].pins,s++}}return{blu:t,viz:i}},acceptChanges(){var t;const e=[];for(const i of this.widgets){if(i.is.pin){const s=(t=i.routes)==null?void 0:t.slice();if(i.is.zombie){for(const n of s)n.disconnect();e.push(i)}else for(const n of s)n.is.newConx?n.is.newConx=!1:n.is.noConx&&n.disconnect()}i.is.ifName&&i.is.zombie&&(i.node.look.showPrefixes(i),e.push(i)),i.is.added&&(i.is.added=!1)}for(const i of e)i.is.pin?i.node.look.removePin(i):i.is.ifName&&i.node.look.removeInterfaceName(i)},cook(e){var t;if(e.label&&this.addLabel(e.label),!!e.interfaces){for(const i of e.interfaces){this.cookInterface(i);for(const s of i.pins){const n=this.cookPin(s);this.node.is.group&&((t=s.editor)!=null&&t.pad?this.node.cookPad(n,s.editor.pad):this.node.addPad(n))}}for(const i of this.widgets)i.wid&&i.wid>this.widGenerator&&(this.widGenerator=i.wid);for(const i of this.widgets)i.wid==0&&(i.wid=this.generateWid())}},cookPin(e){e.editor||(e.editor={id:0,align:"left"});const t={input:!1,left:!1,channel:!1,multi:!1,zombie:!1};t.input=e.kind=="input"||e.kind=="reply",t.left=e.editor.align=="left",t.channel=e.kind=="request"||e.kind=="reply",t.multi=k.isMulti(e.name),t.proxy=this.node.is.group;const i=this.addPin(e.name,0,t);return i.wid=e.editor.id,i.ifNamePrefixCheck(),this.adjustPinWidth(i),i},cookInterface(e){var i;if(e.name.length==0)return null;const t=this.addIfName(e.name,null);return t.wid=((i=e.editor)==null?void 0:i.id)||0,t}};function yt(e){this.rect={...e},this.rect.w=e.w>0?e.w:m.look.wBox,this.rect.h=e.h>0?e.h:m.look.hTop+m.look.hBottom,this.node=null,this.widGenerator=0,this.widgets=[]}yt.prototype={render(e){var t;(t=this.widgets)==null||t.forEach(i=>i.render(e,this))},remove(){},getMinWidth(){let e=m.look.wBox;for(const t of this.widgets)t.is.pin&&t.rect.w>e&&(e=t.rect.w);return e},changeWidth(e){this.rect.w+=e,this.widgets.forEach(t=>{t.is.pin&&!t.is.left?(t.rect.x+=e,t.adjustRoutes()):t.is.header||t.is.ifName||t.is.box?t.rect.w+=e:t.is.icon&&t.rect.x>this.rect.x+(this.rect.w-e)/2&&(t.rect.x+=e)})},adjustPinWidth(e){const t=m.pin.wMargin+this.getTextWidth(e.withoutPrefix(),e.is.multi);e.is.left||(e.rect.x+=e.rect.w-t),e.rect.w=t,e.rect.w>this.rect.w&&this.wider(e.rect.w-this.rect.w)},getTextWidth(e,t=!1){const i=u.getCanvasContext();if(!t)return i.measureText(e).width;const[s,n,o]=k.getPreMiddlePost(e);let r=i.measureText(s+"[").width+i.measureText("]"+o).width;const a=i.font;return i.font=m.pin.fMulti,r+=i.measureText(n).width,i.font=a,r},wider(e=0){this.rect.w>=m.look.wMax||(e=e>0?Math.ceil(e/m.look.wExtra)*m.look.wExtra:m.look.wExtra,this.rect.w+e>m.look.wMax&&(e=m.look.wMax-this.rect.w),this.changeWidth(e))},smaller(e=0){const t=this.getMinWidth();this.rect.w<=t||(e=e>0?(1+Math.floor(e/m.look.wExtra))*m.look.wExtra:m.look.wExtra,this.rect.w-e<t&&(e=this.rect.w-t),this.changeWidth(-e))},decorate(e){this.node=e,this.addBox(),this.addHeader(),this.addIcon("cog"),e.is.source?this.addIcon("factory"):this.addIcon("group"),this.addIcon("pulse"),this.addIcon("comment")}};Object.assign(yt.prototype,$d,mf,vf,wf,xf,yf,bf);function ns(e=null,t=null,i=null){this.uid=i,this.name=t,this.is={group:!1,source:!1,highLighted:!1,placed:!0,duplicate:!1},this.link=null,this.look=e,this.sx=null,this.dx=null,this.prompt=null}ns.prototype={render(e){var i,s;const t=(i=this.link)!=null&&i.model?m.switch(this.link.model.header.style):null;(s=this.look)==null||s.render(e),t&&m.switch(t)},findByName(e){if(this.name==e)return this;if(this.nodes){let t=null;for(const i of this.nodes)if(t=i.findByName(e))return t}return null},findByName(e){if(this.name==e)return this;if(this.nodes){let t=null;for(const i of this.nodes)if(t=i.findByName(e))return t}return null},findParent(e){let t=this;if(this.nodes){for(const i of this.nodes)if(i==e)return t;for(const i of this.nodes)if(i.is.group&&(t=i.findParent(e)))return t}return null},updateName(e){if(!(!e||e===this.name)){this.name=e;for(const t of this.look.widgets)if(t.is.header){t.title=e;break}}},hitTest(e){const{x:t,y:i,w:s,h:n}=this.look.rect,o=m.pin.wOutside;if(e.x<t-o||e.x>t+s+o||e.y<i||e.y>i+n)return[H.nothing,null,null];for(const r of this.look.widgets){const a=r.rect;if(r.is.box||e.y<a.y||e.y>a.y+a.h||e.x<a.x||e.x>a.x+a.w||r.is.header&&!r.hitTitle(e))continue;return[r==null?H.node:r.is.pin?H.pin:r.is.ifName?H.ifName:r.is.icon?H.icon:r.is.header?H.header:r.is.label?H.label:H.node,this,r]}return[H.node,this,null]},hitRoute(e){let t=0;for(const i of this.look.widgets)if(i.is.pin&&i.routes.length>0){for(const s of i.routes)if(s.from==i&&(t=s.hitSegment(e)))return[H.route,s,t]}return[H.nothing,null,0]},overlap(e){const t=this.look.rect;return!(t.x>e.x+e.w||t.x+t.w<e.x||t.y>e.y+e.h||t.y+t.h<e.y)},isContainer(){return this.is.group&&this.pads.length==0},compatible(e){return e.is.group&&this.is.group||e.is.source&&this.is.source},cookCommon(e){e.editor||(e.editor={rect:null});const t=e.editor.rect?k.stringToRect(e.editor.rect):{x:0,y:0,w:0,h:0};this.is.placed=!!e.editor.rect,this.look=new yt(t),this.look.rect.h=m.look.hTop+m.look.hBottom,this.look.decorate(this),this.look.cook(e),t.w>0&&this.look.rect.w>t.w&&this.look.smaller(this.look.rect.w-t.w),e.prompt&&(this.prompt=e.prompt),e.sx&&(this.sx=e.sx),e.dx&&(this.dx=e.dx)},uidChangeAll(e){if(e.generate(this),!this.is.source){for(const t of this.pads)e.generate(t);for(const t of this.buses)e.generate(t);for(const t of this.nodes)t.uidChangeAll(e)}},uidChangeImported(e){for(const t of this.pads)e.generate(t);for(const t of this.buses)e.generate(t);for(const t of this.nodes)t.link||(e.generate(t),t.is.group&&t.uidChangeImported(e))},setUIDS(e){if(e.generate(this),!this.is.source){for(const t of this.pads)e.generate(t);for(const t of this.buses)e.generate(t)}},usesFactory(e,t){var i;this.is.group?this.nodes.forEach(s=>s.usesFactory(e,t)):((i=this.factory)==null?void 0:i.name)==e&&t.push(this)},move(e){this.look.moveDelta(e.x,e.y),this.look.adjustRoutes()},doSelect(){for(const e of this.look.widgets)if(e.is.box){e.is.selected=!0;return}},unSelect(){for(const e of this.look.widgets)if(e.is.box){e.is.selected=!1;return}},samePosition(e){return this.look.rect.x==e.look.rect.x&&this.look.rect.y==e.look.rect.y},cannotBeModified(){return this.link==null?!1:(this.look.blinkToWarn(),!0)},switchNodeType(){const e=this.is.group?this.copyAsSourceNode():this.copyAsGroupNode();return this.look.transferRoutes(e.look),e}};Object.assign(ns.prototype,Md,Dd,Id,Od,Rd,Ad);const kf={toJSON(){if(this.link)return this.dockToJSON();const{rect:e,label:t,interfaces:i}=this.look?this.look.getItemsToSave():{rect:null,label:null,interfaces:[]},s={kind:"group",name:this.name};t&&(s.label=t),i.length&&(s.interfaces=i),this.sx&&(s.sx=this.sx),this.dx&&(s.dx=this.dx),this.prompt&&(s.prompt=this.prompt),this.nodes.length&&(s.nodes=this.nodes);const[n,o]=this.getRoutesAndConnections();return o.length&&(s.connections=o),s.editor={rect:k.rectToString(e)},this.savedView&&(s.editor.view=k.viewToJSON(this.savedView)),this.buses.length&&(s.editor.buses=this.buses),n.length&&(s.editor.routes=n),s},bluviz(){var a;if(this.link)return this.bluvizDock();const{blu:e,viz:t}=this.look?this.look.bluviz():{blu:{label:null,interfaces:[]},viz:{rect:null,interfaces:[]}},i={kind:"group",name:this.name};e.label&&(i.label=e.label),this.prompt&&(i.prompt=this.prompt),e.interfaces.length&&(i.interfaces=e.interfaces),this.sx&&(i.sx=this.sx),this.dx&&(i.dx=this.dx);const s=(a=this.nodes)==null?void 0:a.map(l=>l.bluviz());s.length&&(i.nodes=s.map(l=>l.blu));const[n,o]=this.getRoutesAndConnections();o.length&&(i.connections=o);const r={kind:"group",name:this.name,rect:k.rectToString(t.rect)};return this.savedView&&(r.view=k.viewToJSON(this.savedView)),t.interfaces.length&&(r.interfaces=t.interfaces),this.pads.length&&(r.pads=this.pads.map(l=>l.bluviz().viz)),s.length&&(r.nodes=s.map(l=>l.viz)),this.buses.length&&(r.buses=this.buses.map(l=>l.bluviz().viz)),n.length&&(r.routes=n),{blu:i,viz:r}},dockToJSON(){const{rect:e,label:t,interfaces:i}=this.look?this.look.getItemsToSave():{rect:null,label:null,interfaces:[]},s={kind:"dock",name:this.name,link:this.link};return t&&(s.label=t),this.prompt&&(s.prompt=this.prompt),i.length&&(s.interfaces=i),this.sx&&(s.sx=this.sx),this.dx&&(s.dx=this.dx),s.editor={rect:k.rectToString(e)},s},bluvizDock(){const{blu:e,viz:t}=this.look?this.look.bluviz():{blu:{label:null,interfaces:[]},viz:{rect:null,interfaces:[]}};this.name,this.link.bluviz().blu,e.label&&e.label,this.prompt&&this.prompt,e.interfaces.length&&e.interfaces,this.sx&&this.sx,this.dx&&this.dx,this.name,k.rectToString(t.rect),t.interfaces.length&&t.interfaces},zip(e,t){},cook(e,t){if(this.cookCommon(e),e.editor.view&&(this.savedView=k.stringToView(e.editor.view)),e.nodes)for(const n of e.nodes){const o=n.link?t.linkedNode(n):t.localNode(n);o&&this.nodes.push(o),o.is.placed||this.placeNode(o)}const i=e.connections?this.cookConx(e.connections):[];if(e.editor.buses)for(const n of e.editor.buses){const o=new Ps(n.name,{x:0,y:0});o.cook(n,t),this.buses.push(o)}const s=[];if(e.editor.routes)for(const n of e.editor.routes){const o=this.cookRoute(n);o&&s.push(o)}if(i){for(const n of s)this.findRouteInConx(n,i);this.createRoutes(i)}},placeRoot(){const e=m.placement;this.look.moveTo(e.marginLeft,e.marginTop),this.is.placed=!0},placeNode(e){const t=m.placement,i=this.pads.length?t.marginLeftPads:t.marginLeft,s=t.spacing,n=t.tolerance,o=this.nodes.filter(v=>v!==e&&v.look&&v.is.placed),a=(this.nodes.indexOf(e)>=0?this.nodes.indexOf(e):this.nodes.length-1)%t.nodesPerRow,l=i+a*t.colStep;let c=t.marginTop;for(const v of o){const w=v.look.rect.x;if(Math.abs(w-l)<=n){const x=v.look.rect.y+v.look.rect.h;x+s>c&&(c=x+s)}}const h=v=>({x:v.x-s,y:v.y-s,w:v.w+2*s,h:v.h+2*s}),f=(v,w)=>!(v.x+v.w<=w.x||v.x>=w.x+w.w||v.y+v.h<=w.y||v.y>=w.y+w.h);let g={x:l,y:c,w:e.look.rect.w,h:e.look.rect.h};for(;o.some(v=>f(h(g),h(v.look.rect)));)g.y+=s;e.look.moveTo(g.x,g.y),e.is.placed=!0},cookPad(e,t){let i=t.rect?k.stringToRect(t.rect):{x:10,y:10,w:0,h:0};i.w==0&&(i=e.makePadRect({x:i.x,y:i.y}));const s=new Si(i,e,null);s.is.leftText=t.align=="left",e.pad=s,this.pads.push(s)},cookRoute(e){const t=k.rawToEndPoint(e.from),i=k.rawToEndPoint(e.to);if(!t||!i)return null;let[s,n]=this.getEndPoints(t,i);if(!s||!n)return s||console.error(`invalid route *FROM* ${e.from} to ${e.to}`),n||console.error(`invalid route from ${e.from} *TO* ${e.to}`),null;s.is.bus&&(s=s.newTack()),n.is.bus&&(n=n.newTack());const o=new bt(s,n);return o.wire=k.stringToWire(s.center(),n.center(),e.wire),o.wire.length<2&&o.autoRoute(this.nodes),s.is.tack?s.setRoute(o):s.routes.push(o),n.is.tack?n.setRoute(o):n.routes.push(o),o.checkTwistedPair(),o.adjust(),o},getEndPoints(e,t){const i=(a,l)=>{for(const c of this.nodes){if(c.name!=a.node)continue;let h=c.look.widgets.find(f=>f.is.pin&&f.is.input==l&&f.name===a.pin);return h||c.look.widgets.find(f=>f.is.pin&&f.is.input==l&&f.wid===a.wid),h}},s=(a,l)=>{let c=this.pads.find(h=>h.proxy.is.input==l&&h.proxy.name===a.pad);return c||this.pads.find(h=>h.proxy.is.input==l&&h.proxy.wid===a.wid),c},n=a=>this.buses.find(l=>l.name===a.bus);let o=null,r=null;return e.pin?(o=i(e,!1),r=t.pin?i(t,!0):t.pad?s(t,!1):t.bus?n(t):null):e.pad?(o=t.pin?s(e,!0):t.bus?s(e,!1):null,r=t.pin?i(t,!0):t.bus?n(t):null):e.bus&&(o=n(e),r=t.pin?i(t,!0):t.pad?s(t,!0):null),[o,r]},fuse(e){this.widgetCompare(e),this.sxUpdate(e),this.nodes=e.nodes,this.buses=e.buses,this.pads=e.pads,this.reConnectPads()},reConnectPads(){this.pads.forEach(e=>{const t=this.look.findPin(e.proxy.name,e.proxy.is.input);if(!t)return console.log(`*** ERROR *** node ${this.name} has no proxy for pad  ${e.proxy.name}`);e.proxy=t,t.pad=e})}},Tf={addProxies(e){var i;const t=[];(i=e.nodes)==null||i.forEach(s=>{var n;(n=s.look.widgets)==null||n.forEach(o=>{var l;if(!((l=o.routes)!=null&&l.length)>0)return;const r=[];o.routes.slice().forEach(c=>{const h=c.from==o?c.to:c.from;h.is.pin&&e.nodes.includes(h.node)||h.is.tack&&e.tacks.includes(h)||(r.push(h),c.from.removeRoute(c),c.to.removeRoute(c))}),r.length>0&&t.push({widget:o,destinations:r})})}),t.sort((s,n)=>s.widget.rect.y>n.widget.rect.y?1:s.widget.rect.y<n.widget.rect.y?-1:0),t.forEach(s=>{const n=s.widget,o=this.copyPinAsProxy(n);this.addPad(o),o.pad.moveTo(o.pad.rect.x,n.rect.y),o.pad.routeToPin(n);let r=null;s.destinations.forEach(a=>{r=new bt(o,a),r.builder(),o.routes.push(r),a.is.pin?a.routes.push(r):a.is.tack&&a.restore(r)})})},copyPinAsProxy(e){const t=this.look;let i=null;if(e.pxlen!=0){const o=e.getPrefix();let r=t.findInterfaceName(o);r||(r=this.look.addIfName(o,t.nextPinPosition(!1)));const a=t.getInterface(r).at(-1).rect;i={x:e.is.left?a.x:a.x+a.w,y:a.y+a.h}}else i=t.nextPinPosition(e.is.left);const s=t.pinRectangle(e.displayName(),i.y,e.is.left),n=new ks(s,this,e.name.slice(),e.is);return n.pxlen=e.pxlen,t.addWidget(n),n},addPad(e){var r;const t=m.placement.marginTop+this.pads.length*(m.pad.hPad+m.pad.hSpace),i=this.savedView?this.savedView.rect.w:m.view.wDefault,s=this.savedView?this.savedView.rect.x:0,n=e.is.left?e.makePadRect({x:m.pad.wViewLeft+s,y:t}):e.makePadRect({x:i-m.pad.wViewRight+s,y:t}),o=new Si(n,e);(r=u.doc)==null||r.UID.generate(o),this.pads.push(o),e.pad=o},removePad(e){Ce(this.pads,e)},restorePad(e){this.pads.push(e)},addPads(e){for(const t of e)t.is.proxy&&this.addPad(t)},addBus(e,t,i=null){const s=new Ps(e??"",t,i);return this.buses.push(s),s},deleteBus(e){e.disconnect(),this.removeBus(e)},removeBus(e){Ce(this.buses,e)},restoreBus(e){this.buses.find(t=>t.uid==e.uid)||this.buses.push(e)}},_f={addConnection(e,t,i){const s=r=>r.is.pin?{pin:r.name,node:r.node.name}:r.is.pad?{pin:r.proxy.name}:{pin:"?",node:"?"};if(!t.is.tack){i.push({src:s(e),dst:s(t)});return}const n=t.bus,o=[];for(const r of n.tacks){if(r==t)continue;const a=r.route.from==r?r.route.to:r.route.from;n.areConnected(e,a)&&o.push(a)}for(const r of o)i.push({src:s(e),dst:s(r)})},getRoutesAndConnections(){const e=[],t=[];for(const i of this.nodes)for(const s of i.look.widgets)if(!(!s.is.pin||s.is.input))for(const n of s.routes){e.push(k.routeToRaw(n));const o=n.from==s?n.to:n.from;this.addConnection(s,o,t)}for(const i of this.pads)if(i.proxy.is.input)for(const s of i.routes){e.push(k.routeToRaw(s));const n=s.from==i?s.to:s.from;this.addConnection(i,n,t)}for(const i of this.buses)for(const s of i.tacks){const n=s.getOther();n.is.pin&&n.is.input&&e.push(k.routeToRaw(s.route)),n.is.pad&&!n.proxy.is.input&&e.push(k.routeToRaw(s.route))}return[e,t]},cookConx(e){const t=(c,h)=>{for(const f of this.nodes)if(f.name==c.node)return f.look.widgets.find(g=>g.is.pin&&g.name===c.pin&&g.is.input===h)},i=(c,h)=>this.pads.find(f=>f.proxy.name===c.pin&&f.proxy.is.input===h),s=(c,h)=>{var v,w,x,y,L,T;const f=`${(v=h.from)==null?void 0:v.pin} ${(w=h.from)!=null&&w.node?" @ "+((x=h.from)==null?void 0:x.node):"(pad)"}`,g=`${(y=h.to)==null?void 0:y.pin} ${(L=h.to)!=null&&L.node?" @ "+((T=h.to)==null?void 0:T.node):"(pad)"}`;console.error(c+f+" -> "+g)},n=(c,h)=>c.is.pin&&h.is.pin?c.is.input==h.is.input:c.is.pin&&h.is.pad?c.is.input!=h.proxy.is.input:c.is.pad&&h.is.pin?c.proxy.is.input!=h.is.input:(c.is.pad&&h.is.pad,!0),o=(c,h)=>{const f=c.is.pin?c:c.proxy,g=h.is.pin?h:h.proxy;if(f.is.input&&f.is.channel||g.is.input&&g.is.channel)return f.is.channel!=g.is.channel},r=[];let a=null,l=null;for(const c of e){const h=c.from??c.src,f=c.to??c.dst;if(!(!h||!f)&&(a=h.node?t(h,!1):i(h,!0),a||s("Connection <src> not found: ",c),l=f.node?t(f,!0):i(f,!1),l||s("Connection <dst> not found: ",c),!(!a||!l))){if(n(a,l)){s("Input/output mismatch: ",c);continue}if(o(a,l)){s("request/reply mismatch: ",c);continue}r.push({src:a,dst:l,is:{new:!0}})}}return r},findRouteInConx(e,t){const i=(r,a)=>t.find(l=>r==l.src&&a==l.dst||r==l.dst&&a==l.src),s=(r,a,l)=>{for(const c of r.tacks){if(c==l)continue;const h=c.getOther();if(r.areConnected(a,h)){const f=i(a,h);f?f.is.new=!1:c.route.is.noConx=!0}}},[n,o]=e.messageFlow();if(t.length==0){e.is.noConx=!o.is.tack;return}if(n.is.tack)e.is.noConx=!1;else if(o.is.tack)s(o.bus,n,o);else{const r=i(n,o);r?r.is.new=!1:e.is.noConx=!0}},createRoutes(e){if(e!=null&&e.length)for(const t of e){if(!t.is.new)continue;const i=new bt(t.src,t.dst);i.autoRoute(this.nodes),i.is.newConx=!0,i.from.routes.push(i),i.to.routes.push(i)}}},Pf="group";function It(e=null,t=Pf,i=null){ns.call(this,e,t,i),this.is.group=!0,this.nodes=[],this.buses=[],this.pads=[],this.savedView=null,e&&e.decorate(this)}const Sf={addNode(e){this.nodes.push(e)},removeNode(e){Ce(this.nodes,e)},restoreNode(e){this.nodes.push(e)},findNode(e){var s;const t=k.splitLink(e);if(t.length==1)return this.findRecursive(e);let i=this;for(const n of t)if(i=((s=i.nodes)==null?void 0:s.find(o=>n===o.name))||null,!i)return null;return i},findRecursive(e){for(const i of this.nodes)if(i.name==e)return i;let t=null;for(const i of this.nodes)if(i.is.group&&(t=i.findRecursive(e)))return t;return null},hasDuplicate(e){for(const t of this.nodes)if(t!=e&&t.name===e.name)return!0;return!1},checkDuplicates(e){e.is.duplicate=!1;for(const t of this.nodes)t!=e&&(t.is.duplicate&&(t.is.duplicate=this.hasDuplicate(t)),t.name===e.name&&(e.is.duplicate=t.is.duplicate=!0))},swap(e,t){for(let i=0;i<this.nodes.length;i++)if(this.nodes[i]==e)return this.nodes[i]=t,!0;for(const i of this.nodes)if(i.is.group&&i.swap(e,t))return!0;return!1},copy(){var t,i,s,n;const e=new It(null,this.name,this.uid);return e.link=this.link?this.link.copy():null,e.look=new yt(this.look.rect),this.look.copy(e),e.prompt=this.prompt?this.prompt.slice():null,e.sx=this.sx?ia(this.sx):null,(t=this.nodes)==null||t.forEach(o=>{const r=o.copy();r.look.copyPinPinRoutes(o.look),e.addNode(r)}),(i=e.nodes)==null||i.forEach(o=>{o.look.correctPinPinRoutes(e)}),(s=this.pads)==null||s.forEach(o=>{const r=o.copy();r.copyPadPinRoutes(o,e);const a=e.look.widgets.find(l=>l.is.proxy&&l.name==o.proxy.name&&l.is.input==o.proxy.is.input);r.proxy=a,a.pad=r,e.pads.push(r)}),(n=this.buses)==null||n.forEach(o=>{const r=o.copy();o.copyTacks(r,e),e.buses.push(r)}),e.rxtxBuildTxTable(),e},copyAsSourceNode(e=null){let t=new bi(null,e??this.name,this.uid);return t.look=new yt(this.look.rect),this.look.copyConvert(t),t.rxtxPrepareTables(),t}};Object.assign(It.prototype,ns.prototype,Sf,Tf,kf,_f);const Lf={toJSON(){const{rect:e,label:t,interfaces:i}=this.look.getItemsToSave(),s=this.link?{kind:"dock",name:this.name,link:this.link}:{kind:"source",name:this.name,factory:this.factory};return t&&(s.label=t),this.prompt&&(s.prompt=this.prompt),i.length&&(s.interfaces=i),this.sx&&(s.sx=this.sx),this.dx&&(s.dx=this.dx),s.editor={rect:k.rectToString(e)},s},bluviz(){const{blu:e,viz:t}=this.look?this.look.bluviz():{blu:{label:null,interfaces:[]},viz:{rect:null,interfaces:[]}},i=this.link?{kind:"dock",name:this.name,link:this.link}:{kind:"source",name:this.name,factory:this.factory};e.label&&(i.label=e.label),this.prompt&&(i.prompt=this.prompt),e.interfaces.length&&(i.interfaces=e.interfaces),this.sx&&(i.sx=this.sx),this.dx&&(i.dx=this.dx);const s=this.link?{kind:"dock",name:this.name,rect:k.rectToString(t.rect)}:{kind:"source",name:this.name,rect:k.rectToString(t.rect)};return this.savedView&&(s.view=k.viewToJSON(this.savedView)),t.interfaces.length&&(s.interfaces=t.interfaces),{blu:i,viz:s}},fuse(e){this.widgetCompare(e),this.factory.fName=e.factory.fName,this.factory.arl=e.factory.arl?e.factory.arl.copy():null,this.sxUpdate(e),this.rxtxResetTables(),this.rxtxPrepareTables()},cook(e,t){if(this.cookCommon(e),e.factory){const i=t.getMainModel(),s=t.getCurrentModel();e.factory.path&&(this.factory.arl=s.arl.resolve(e.factory.path),i!=s&&this.factory.arl.makeRelative(i.arl)),this.factory.fName=e.factory.function}this.rxtxPrepareTables()},analyzeFactory(e){var r;const i=Object.entries(e).find(a=>a[0]==this.factory.fName);if(!i)return;const s={out(){}},n=i[1];let o=((r=n.prototype)==null?void 0:r.constructor)===n?n(s,null):new n(s,null);for(const a in o)if(a.startsWith("-> ")&&typeof o[a]=="function"){const l=a.slice(3),c=o[a].toString(),h=c.indexOf("("),f=c.indexOf(")"),g=c.slice(h+1,f);for(const v of this.look.widgets)v.is.pin&&v.name==l&&(v.profile=g)}}};function bi(e=null,t=null,i=null){t=t??"new",ns.call(this,e,t,i),this.is.source=!0,this.factory=new Zi(t?k.nodeToFactory(t):""),this.rxTable=[],this.txTable=[],e&&e.decorate(this)}const Nf={copy(e){const t=new bi(null,this.name,this.uid);return t.factory.copy(this.factory),t.look=new yt(this.look.rect),this.look.copy(t),t.prompt=this.prompt?this.prompt.slice():null,t.sx=this.sx?ia(this.sx):null,t.link=this.link?this.link.copy():null,t.rxtxPrepareTables(),t},getSourceArl(e){var t,i,s;return(i=(t=this.link)==null?void 0:t.model)!=null&&i.is.lib?this.link.model.arl:e?e.arl:this.factory.arl?this.factory.arl:(s=this.link)!=null&&s.model?this.link.model.arl.resolve("index.js"):null},copyAsGroupNode(e=null){const t=new It(null,e??this.name,this.uid);t.look=new yt(this.look.rect),this.look.copyConvert(t);for(const i of t.look.widgets)i.is.proxy&&t.addPad(i);return t},makeSourceBody(){var l,c;function e(h){const f="___________________________________________________________________",g=h.length;return`
	//`+f.slice(0,-g)+h.toUpperCase()}const t=k.nodeToFactory(this.name);let s=`// ------------------------------------------------------------------
// Source node: ${t}
// Creation date ${new Date().toLocaleString()}
// ------------------------------------------------------------------`,n=((l=this.prompt)==null?void 0:l.length)>0?`

/*
`+this.prompt+`
*/`:"",o=`

//Constructor for ${this.name}
export function ${t}(tx, sx) {
}`;this.look.widgets.sort((h,f)=>h.rect.y-f.rect.y);let r="[";for(const h of this.look.widgets){if(h.is.ifName&&(r+=e(h.text)),!h.is.pin||h.is.input)continue;((c=h.profile)==null?void 0:c.length)>0&&(r+=`

	// `+h.profile);const f=h.is.channel?"=>":"->";if(h.is.multi){const g=k.expandMultis(h.name);for(const v of g)r+=`
	"${v} ${f}",`}else r+=`
	"${h.name} ${f}",`}r+=`
	],`;let a=`

${t}.prototype = {

	// Output pins of the node

	sends: ${r}

	// Input pins of the node
	// For each input pin "a_message" there is a handler "-> a_message" or "=> a_message" (with channel)`;return this.look.widgets.forEach(h=>{var g;if(h.is.ifName&&(a+=e(h.text)),!h.is.pin||!h.is.input)return;a+=((g=h.profile)==null?void 0:g.length)>0?`
	// `+h.profile:`
`;const f=h.is.channel?"=>":"->";if(h.is.multi){const v=k.expandMultis(h.name);for(const w of v)a+=`
	"${f} ${w}"({}) {
	},`}else a+=`
	"${f} ${h.name}"({}) {
	},`}),a+=`

} // ${this.name}.prototype`,s+n+o+a}};Object.assign(bi.prototype,ns.prototype,Nf,Lf);function Zi(e=null){this.fName=e??"",this.arl=null,this.alias=null}Zi.prototype={toJSON(){var e;return{path:((e=this.arl)==null?void 0:e.userPath)??"./index.js",function:this.fName}},bluviz(){var e;return{blu:{path:((e=this.arl)==null?void 0:e.userPath)??"./index.js",function:this.fName},viz:null}},copy(e){this.fName=e.fName,this.alias=e.alias,this.arl=e.arl?e.arl.copy():null},clone(){const e=new Zi;return e.copy(this),e},resolve(e,t,i,s=null){var n;if(!e||e.length==0){if(!s||s.length==0)return;e=s}if(e!==this.fName&&(this.fName=e),!(this.arl==null&&(!t||t.length==0))&&((n=this.arl)==null?void 0:n.userPath)!==t){if(!t||t.length==0){this.arl=null;return}t.at(-1)==="/"?t=t+"index.js":t.lastIndexOf(".js")<0&&(t=t+".js"),this.arl=i.resolve(t)}},duplicate(e,t){const i=e.find(s=>s.arl.equals(t)?!1:s.items.find(n=>n==this.fName));return i?(console.warn(`Duplicate factory name: ${this.fName} is already defined in ${i.arl.userPath}`),this.alias="_"+this.fName,!0):(this.alias=null,!1)}};const Cf={drawXY(e){const t=this.wire;let i=t.length;if(i==0){let o=this.from.center();t.push({x:o.x,y:o.y}),t.push({x:e.x,y:o.y});return}let s=t[i-2],n=t[i-1];n.y==s.y?Math.abs(e.y-n.y)>m.route.split?t.push({x:n.x,y:e.y}):(n.x=e.x,i>2&&Math.abs(n.x-s.x)<m.route.tooClose&&t.pop()):Math.abs(e.x-n.x)>m.route.split?t.push({x:e.x,y:n.y}):(n.y=e.y,i>2&&Math.abs(n.y-s.y)<m.route.tooClose&&t.pop())},builder(){switch(this.typeString()){case"PIN-PIN":this.fourPointRoute();break;case"PIN-PAD":this.fourPointRoute();break;case"PAD-PIN":this.fourPointRoute();break;case"PIN-BUS":this.to.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"BUS-PIN":this.from.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"PAD-BUS":this.to.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"BUS-PAD":this.from.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break}},sixPointRoute(e=[]){this.wire.length>0&&(this.wire.length=0);const t=this.wire,i=this.from,s=this.to,n=i.center(),o=s.center(),r=m.look.dxCopy;let a=i.is.left?n.x-r:n.x+r,l=s.is.left?o.x-r:o.x+r;const c=i.node.look.rect,h=s.node.look.rect;let f=n.y+(c.h/4+h.h/4);const g=e.filter(T=>{var D;return T&&((D=T.look)==null?void 0:D.rect)&&T!==i.node&&T!==s.node}),v=(T,D,E)=>Mn(T,D,E),w=Math.max(m.route.split,10),x=T=>{t.length=0,t.push(n),t.push({x:a,y:n.y}),t.push({x:a,y:T}),t.push({x:l,y:T}),t.push({x:l,y:o.y}),t.push(o)},y=()=>{for(let T=0;T<t.length-1;T++){const D=t[T],E=t[T+1];if(g.some(_=>v(D,E,_.look.rect)))return!0}return!1};let L=0;for(x(f);y()&&L<30;)f+=w,x(f),L++;return!0},fourPointRoute(e=[]){this.wire.length>0&&(this.wire.length=0);const t=this.wire,i=this.from,s=this.to,n=i.center(),o=s.center();let r=0;const a=m.look.dxCopy,l=e.filter(v=>{var w;return v&&((w=v.look)==null?void 0:w.rect)&&v!==i.node&&v!==s.node}),c=(v,w,x)=>Mn(v,w,x);if(i.is.pin&&s.is.pin&&i.is.left==s.is.left)i.is.left?r=i.rect.x<s.rect.x?i.rect.x-a:s.rect.x-a:r=i.rect.x+i.rect.w>s.rect.x+s.rect.w?i.rect.x+i.rect.w+a:s.rect.x+s.rect.w+a;else{const v=Math.abs(n.x-o.x)*.25;r=n.x<o.x?n.x+v:n.x-v}const h=.02,f=i.rect.y-i.node.look.rect.y;r=i.is.left?r-f*h:r+f*h;const g=v=>{const w={x:v,y:n.y},x={x:v,y:o.y};return l.some(y=>c(w,x,y.look.rect))};if(g(r)){const v=[a,-a,a*2,-a*2],w=r;for(const x of v)if(!g(w+x)){r=w+x;break}}t.push(n),t.push({x:r,y:n.y}),t.push({x:r,y:o.y}),t.push(o);for(let v=0;v<t.length-1;v++){const w=t[v],x=t[v+1];if(l.some(y=>c(w,x,y.look.rect)))return!1}return!0},threePointRoute(e){this.wire.length>0&&(this.wire.length=0);const t=this.wire,i=this.from.center(),s=this.to.center();t.push(i),e?t.push({x:s.x,y:i.y}):t.push({x:i.x,y:s.y}),t.push(s)},twoPointRoute(){this.wire.length>0&&(this.wire.length=0);const e=this.wire,t=this.from.center(),i=this.to.center();e.push(t),e.push({x:i.x,y:t.y})},endpoint(e){let t=this.wire,i=t.length;if(i<2)return;let{x:s,y:n}=e.center();if(i==2){t[0].y!=n?(t[1].x=(t[0].x+s)/2,t[1].y=t[0].y,t.push({x:t[1].x,y:n}),t.push({x:s,y:n})):t[1].x=s;return}t[i-1].x==t[i-2].x?(t[i-1].y=n,t.push({x:s,y:n})):(t[i-1].x=s,t[i-1].y=n,t[i-2].x==t[i-3].x?t[i-2].y=t[i-1].y:t[i-2].x=t[i-1].x)},resumeDrawing(e,t){let i=this.from.center(),s=this.to.center();const n=Math.hypot(i.x-t.x,i.y-t.y),o=Math.hypot(s.x-t.x,s.y-t.y);n<o&&(this.reverse(),e=this.wire.length-e),this.wire.length=e>1?e:0,this.from.is.pin||this.from.is.pad?this.from.routes.push(this):this.from.is.tack&&(this.from.route=this,this.from.bus.tacks.push(this.from)),this.to=null,this.drawXY(t)},lineOfSight(e){const t=this.from.center(),i=this.to.center();for(const s of e)if(!(s==this.from.node||s==this.to.node)&&Mn(t,i,s.look.rect))return!1;return!0},autoRoute(e){switch(this.typeString()){case"PIN-PIN":this.checkLeftRight(),this.fourPointRoute(e)||this.sixPointRoute(e);break;case"PIN-PAD":this.fourPointRoute(e);break;case"PAD-PIN":this.fourPointRoute(e);break;case"PIN-BUS":this.to.horizontal()?this.fourPointRoute(e)||this.sixPointRoute(e):this.threePointRoute(!0);break;case"BUS-PIN":this.from.horizontal()?this.fourPointRoute(e)||this.sixPointRoute(e):this.threePointRoute(!0);break;case"PAD-BUS":this.to.horizontal()?this.fourPointRoute(e)||this.sixPointRoute(e):this.threePointRoute(!0);break;case"BUS-PAD":this.from.horizontal()?this.fourPointRoute(e)||this.sixPointRoute(e):this.threePointRoute(!0);break}},checkLeftRight(){const e=this.from.center(),t=this.to.center();this.from.routes.length==0&&(this.from.is.left&&e.x<t.x||!this.from.is.left&&e.x>t.x)&&this.from.leftRightSwap(),this.to.routes.length==0&&(this.to.is.left&&t.x<e.x||!this.to.is.left&&t.x>e.x)&&this.to.leftRightSwap()},healWire(){if(this.wire.length==3){const e=this.wire[0],t=this.wire[1],i=this.wire[2];this.wire.length=0,this.wire.push({x:e.x,y:e.y},{x:t.x,y:e.y},{x:t.x,y:i.y},{x:i.x,y:i.y})}}},Rf={moveSegment(e,t){const i=this.from,s=this.to;let n=this.wire[e-1],o=this.wire[e];if(this.wire.length==2&&(i.is.tack||s.is.tack||i.is.pad||s.is.pad)&&this.makeThreeSegments(n,o),e==1)return i.is.tack||i.is.pad?i.slide(t):null;if(e==this.wire.length-1)return s.is.tack||s.is.pad?s.slide(t):null;n.x==o.x?(n.x+=t.x,o.x+=t.x):(n.y+=t.y,o.y+=t.y)},moveAllPoints(e,t){this.wire.forEach(i=>{i.x+=e,i.y+=t})},removeOnePoint(e,t){let i=t.length-1;for(let s=e;s<i;s++)t[s]=t[s+1];t.length=i},removeTwoPoints(e,t){let i=t.length-2;for(let s=e;s<i;s++)t[s]=t[s+2];t.length=i},endDrag(e){const t=this.wire.length;e==1?(this.from.is.tack||this.from.is.pad)&&this.from.fuseEndSegment():e==2?this.from.is.pin?this.fuseSegmentAfter(e):this.fuseSegmentBefore(e)||this.fuseSegmentAfter(e):e==t-1?(this.to.is.tack||this.to.is.pad)&&this.to.fuseEndSegment():e==t-2?this.to.is.pin?this.fuseSegmentBefore(e):this.fuseSegmentBefore(e)||this.fuseSegmentAfter(e):this.fuseSegmentBefore(e)||this.fuseSegmentAfter(e)},fuseSegmentBefore(e){const t=this.wire;if(e-2<0)return!1;const[i,s,n]=[t[e-2],t[e-1],t[e]],o=m.route.tooClose;if(s.y==n.y){if(Math.abs(i.y-s.y)<o)return n.y=i.y,this.removeTwoPoints(e-2,t),!0}else if(s.x==n.x&&Math.abs(i.x-s.x)<o)return n.x=i.x,this.removeTwoPoints(e-2,t),!0;return!1},fuseSegmentAfter(e){const t=this.wire;if(e+1>t.length-1)return!1;const[i,s,n]=[t[e-1],t[e],t[e+1]],o=m.route.tooClose;if(i.y==s.y){if(Math.abs(n.y-s.y)<o)return i.y=n.y,this.removeTwoPoints(e,t),!0}else if(i.x==s.x&&Math.abs(n.x-s.x)<o)return i.x=n.x,this.removeTwoPoints(e,t),!0;return!1},clampToWidget(e){const t=this.wire,i=this.wire.length,s=e.center();if(i<3)return this.fourPointRoute();this.from==e?(t[0].x=s.x,t[0].y=s.y,t[1].y=s.y):this.to==e&&(t[i-1].x=s.x,t[i-1].y=s.y,t[i-2].y=s.y)},adjust(){const e=this.from,t=this.to;if(!(t!=null&&t.center)||!(e!=null&&e.center))return;const i=e.center(),s=t.center(),n=this.wire[0],o=this.wire.at(-1);if(!n||!o||!s||!i){console.error("*** MISSING ENDPOINTS FOR ROUTE ***",this);return}const r={x:i.x-n.x,y:i.y-n.y},a={x:s.x-o.x,y:s.y-o.y};if(r.x==a.x&&r.y==a.y)return this.moveAllPoints(r.x,r.y);t.is.tack?t.dir=="up"||t.dir=="down"?this.adjustHV(i,s):this.adjustHH(i,s):e.is.tack?e.dir=="up"||e.dir=="down"?this.adjustVH(i,s):this.adjustHH(i,s):this.adjustHH(i,s)},adjustHH(e,t){let i=this.wire;if(i.length<4)return this.makeThreeSegments(e,t);let s=i.length-1;const n=i.length-1,o=m.route.tooClose+5;if(i[0].x!=e.x||i[0].y!=e.y){i[0].x=e.x,i[0].y=e.y,i[1].y=e.y;for(let r=1;r<n;r+=2){const a=i[r].x-i[r-1].x;Math.abs(a)<o&&(i[r].x=a>0?i[r-1].x+o:i[r-1].x-o,i[r+1].x=i[r].x)}}if(i[s].x!=t.x||i[s].y!=t.y){i[s].x=t.x,i[s].y=t.y,i[s-1].y=t.y;for(let r=n;r>1;r-=2){const a=i[r].x-i[r-1].x;Math.abs(a)<o&&(i[r-1].x=a>0?i[r].x-o:i[r].x+o,i[r-2].x=i[r-1].x)}}},adjustHV(e,t){if(this.wire.length==2)return this.makeTwoSegments(e,t);const i=this.wire,s=i.length-1;i[0].x=e.x,i[0].y=e.y,i[1].y=e.y,i[s].x=t.x,i[s].y=t.y,i[s-1].x=t.x,i[s-1].y=i[s-2].y},adjustVH(e,t){if(this.wire.length==2)return this.makeTwoSegments(e,t);const i=this.wire,s=i.length-1;i[0].x=e.x,i[0].y=e.y,i[1].x=e.x,i[s].x=t.x,i[s].y=t.y,i[s-1].x=i[s-2].x,i[s-1].y=t.y},adjustFourPointRoute(e,t){const i=m.route.tooClose,[s,n,o,r]=this.wire;let a=n.x;if(n.x>s.x&&n.x>r.x)n.x-e.x<i?a=e.x+i:n.x-t.x<i&&(a=t.x+i);else if(n.x<s.x&&n.x<r.x)e.x-n.x<i?a=e.x-i:t.x-n.x<i&&(a=t.x-i);else{const l=r.x-s.x,c=t.x-e.x;a=c==0?e.x:l==0?(e.x+t.x)/2:e.x+(n.x-s.x)*c/l}s.x=e.x,s.y=e.y,n.y=e.y,n.x=a,o.x=a,o.y=t.y,r.x=t.x,r.y=t.y},makeTwoSegments(e,t){const i=this.wire;i.length=0,i.push({x:e.x,y:e.y}),i.push({x:t.x,y:e.y}),i.push({x:t.x,y:t.y})},makeThreeSegments(e,t){const i=this.wire;i.length=0,i.push({x:e.x,y:e.y}),i.push({x:(e.x+t.x)/2,y:e.y}),i.push({x:(e.x+t.x)/2,y:t.y}),i.push({x:t.x,y:t.y})}},Ef={conxString(e,t){let i=e.is.pin?"PIN":e.is.tack||e.is.bus?"BUS":e.is.pad?"PAD":"";return t&&(i+=t.is.pin?"-PIN":t.is.tack||t.is.bus?"-BUS":t.is.pad?"-PAD":""),i},checkConxType(e,t){switch(this.conxString(e,t)){case"PIN-PIN":return e===t?this.wire.length<3:e.canConnect(t);case"PIN-BUS":return!t.findTack(e);case"BUS-PIN":return!e.bus.findTack(t);case"PIN-PAD":return t.canConnect(e);case"PAD-PIN":return e.canConnect(t);case"BUS-PAD":return!1;case"PAD-BUS":return!t.findTack(e);case"BUS-BUS":return!1;case"PAD-PAD":return!1;default:return!1}},connect(e){if(!this.checkConxType(this.from,e))return!1;switch(this.conxString(this.from,e)){case"PIN-PIN":return this.to=e,e.routes.push(this),this.rxtxPinPin(),!0;case"PIN-PAD":return this.to=e,e.routes.push(this),this.rxtxPinPad(),!0;case"PAD-PIN":return this.to=e,e.routes.push(this),this.rxtxPinPad(),!0;case"PIN-BUS":return e.addTack(this),this.rxtxPinBus(),!0;case"BUS-PIN":return this.to=e,e.routes.push(this),this.rxtxPinBus(),!0;case"BUS-PAD":return this.to=e,e.routes.push(this),this.rxtxPadBus(),!0;case"PAD-BUS":return e.addTack(this),this.rxtxPadBus(),!0;case"PAD-PAD":return!1;case"BUS-BUS":return!1;default:return!1}},disconnect(){let e=this.conxString(this.from,this.to);switch(e){case"PIN-PIN":this.rxtxPinPinDisconnect();break;case"PIN-PAD":case"PAD-PIN":this.rxtxPinPadDisconnect();break;case"PIN-BUS":case"BUS-PIN":this.rxtxPinBusDisconnect();break;case"PAD-BUS":case"BUS-PAD":this.rxtxPadBusDisconnect();break;default:console.error("Impossible combination in route.disconnect:",e);break}this.remove()},reconnect(){if(this.from.is.pin){if(this.from.routes.includes(this))return;this.from.routes.push(this)}else if(this.from.is.pad){if(this.from.routes.includes(this))return;this.from.routes.push(this)}else if(this.from.is.tack){if(this.from.bus.tacks.includes(this.from))return;this.from.bus.tacks.push(this.from)}const e=this.to.is.tack?this.to.bus:this.to;this.to=null,this.connect(e)},connectFromClone(e){this.wire=e.wire,this.from=e.from,this.from.routes.push(this);const t=e.to.is.tack?e.to.bus:e.to;this.connect(t)}},Af={arrow(e,t){if(t.is.pin)return{right:t.is.input,left:!t.is.input};if(t.is.pad)return{right:!t.proxy.is.input,left:t.proxy.is.input};if(t.is.bus)return e.is.pin?{right:!e.is.input,left:e.is.input}:{right:e.proxy.is.input,left:!e.proxy.is.input}},rxtxPinPin(){var o,r;const e=[],t=[],i=this.arrow(this.from,this.to),s=i.right?this.from:this.to,n=i.right?this.to:this.from;n.is.proxy||s.is.proxy?(s.is.proxy?(o=s.pad)==null||o.makeConxList(e):e.push(s),n.is.proxy?(r=n.pad)==null||r.makeConxList(t):t.push(n),this.fullConnect(e,t)):this.singleConnect(s,n)},rxtxPinPad(){var o,r;const e=[],t=[],[i,s]=this.from.is.pin?[this.from,this.to]:[this.to,this.from];i.is.channel&&(s.proxy.is.channel=!0);const n=this.arrow(i,s);n.right&&(i.is.proxy?(o=i.pad)==null||o.makeConxList(e):e.push(i),s.proxy.makeConxList(t),this.fullConnect(e,t)),n.left&&(s.proxy.makeConxList(e),i.is.proxy?(r=i.pad)==null||r.makeConxList(t):t.push(i),this.fullConnect(e,t))},rxtxPinBus(){var o,r;const e=[],t=[],[i,s]=this.from.is.pin?[this.from,this.to]:[this.to,this.from],n=this.arrow(i,s.bus);n.right&&(i.is.proxy?(o=i.pad)==null||o.makeConxList(t):t.push(i),s.bus.hasFilter()?(s.bus.rxtxAddRxTack(s),this.fullConnect(t,[s])):(s.bus.makeConxList(i,e),this.fullConnect(t,e))),n.left&&(i.is.proxy?(r=i.pad)==null||r.makeConxList(e):e.push(i),s.bus.hasFilter()?s.bus.rxtxAddTxTack(s,e):(s.bus.makeConxList(i,t),this.fullConnect(t,e)))},rxtxPadBus(){const e=[],t=[],[i,s]=this.from.is.pad?[this.from,this.to]:[this.to,this.from],n=this.arrow(i,s.bus);n.right&&(i.proxy.makeConxList(t),s.bus.hasFilter()?(s.bus.rxtxAddRxTack(s),this.fullConnect(t,[s])):(s.bus.makeConxList(i,e),this.fullConnect(t,e))),n.left&&(i.proxy.makeConxList(e),s.bus.hasFilter()?s.bus.rxtxAddTxTack(s,e):(s.bus.makeConxList(i,t),this.fullConnect(t,e)))},rxtxPinPinDisconnect(){var o,r;const e=[],t=[],i=this.arrow(this.from,this.to),s=i.right?this.from:this.to,n=i.right?this.to:this.from;s.is.proxy||n.is.proxy?(s.is.proxy?(o=s.pad)==null||o.makeConxList(e):e.push(s),n.is.proxy?(r=n.pad)==null||r.makeConxList(t):t.push(n),this.fullDisconnect(e,t)):s.node.rxtxRemoveFromTxTable(s,n)},rxtxPinPadDisconnect(){var o,r;const e=[],t=[],[i,s]=this.from.is.pin?[this.from,this.to]:[this.to,this.from];if(s.proxy.is.channel){const a=s.routes.find(l=>{if(l!=this){const c=l.from==s?l.to:l.from;if(c.is.pin&&c.is.channel||c.is.pad&&c.proxy.is.channel)return!0}});s.proxy.is.channel=!!a}const n=this.arrow(i,s);n.right&&(i.is.proxy?(o=i.pad)==null||o.makeConxList(e):e.push(i),s.proxy.makeConxList(t),this.fullDisconnect(e,t)),n.left&&(s.proxy.makeConxList(e),i.is.proxy?(r=i.pad)==null||r.makeConxList(t):t.push(i),this.fullDisconnect(e,t))},rxtxPinBusDisconnect(){var o,r;const e=[],t=[],[i,s]=this.from.is.pin?[this.from,this.to]:[this.to,this.from],n=this.arrow(i,s.bus);n.right&&(i.is.proxy?(o=i.pad)==null||o.makeConxList(t):t.push(i),s.bus.hasFilter()?(s.bus.rxtxRemoveRxTack(s),this.fullDisconnect(t,[s])):(s.bus.makeConxList(i,e),this.fullDisconnect(t,e))),n.left&&(s.bus.hasFilter()?s.bus.rxtxRemoveTxTack(s):(s.bus.makeConxList(i,t),i.is.proxy?(r=i.pad)==null||r.makeConxList(e):e.push(i),this.fullDisconnect(t,e)))},rxtxPadBusDisconnect(){const e=[],t=[],[i,s]=this.from.is.pad?[this.from,this.to]:[this.to,this.from],n=this.arrow(i,s.bus);n.right&&(i.proxy.makeConxList(t),s.bus.hasFilter()?(s.bus.rxtxRemoveRxTack(s),this.fullDisconnect(t,[s])):(bus.makeConxList(i,e),this.fullDisconnect(t,e))),n.left&&(s.bus.hasFilter()?s.bus.rxtxRemoveTxTack(s):(s.bus.makeConxList(i,t),i.proxy.makeConxList(e),this.fullDisconnect(t,e)))},singleConnect(e,t){let i=e.node.txTable.find(s=>s.pin.name==e.name);i&&((e.is.multi||t.is.multi)&&!t.hasMultiOverlap(e)||i.targets.push(t))},fullConnect(e,t){for(const i of e)if(i.is.pin){const s=i.node.txTable.find(n=>n.pin.name==i.name);if(!s){console.warn("*** SHOULD NOT HAPPEN *** Could not find txRecord in fullConnect",i.name,i.node.name);continue}for(const n of t)(!(i.is.multi||n.is.multi)||n.hasMultiOverlap(i))&&s.targets.push(n)}else if(i.is.tack){const s=i.bus.txTable.find(n=>n.tack==i);if(!s){console.warn("*** SHOULD NOT HAPPEN *** Could not find txTack in fullConnect",i.bus.name);continue}for(const n of t)s.fanout.push(n)}},fullDisconnect(e,t){for(const i of e)if(i.is.pin){const s=i.node.txTable.find(n=>n.pin.name==i.name);if(!s){console.warning("*** SHOULD NOT HAPPEN *** Could not find txRecord in fullDisconnect",i.name,i.node.name);continue}for(const n of t)s.dropTarget(n)}else if(i.is.tack){const s=i.bus.txTable.find(n=>n.tack==i);if(!s){console.warning("*** SHOULD NOT HAPPEN *** Could not find txTack in fullDisconnect",i.bus.name);continue}for(const n of t)s.dropTarget(n)}}};function bt(e,t){this.from=e,this.to=t,this.is={selected:!1,highLighted:!1,twistedPair:!1,notUsed:!1,newConx:!1,noConx:!1},this.wire=[]}bt.prototype={render(e){if(this.wire.length<2)return;const t=this.is.selected?m.route.cSelected:this.is.highLighted?m.route.cHighLighted:this.is.newConx?m.route.cAdded:this.is.noConx?m.route.cDeleted:this.is.notUsed?m.route.cNotUsed:m.route.cNormal,i=this.is.selected?m.route.wSelected:m.route.wNormal;this.is.twistedPair?$.twistedPair(e,t,i,this.wire):$.drawWire(e,t,i,this.wire)},reverse(){[this.from,this.to]=[this.to,this.from];let e=this.wire,t=e.length;for(let i=0;i<t/2;i++)[e[i],e[t-i-1]]=[e[t-i-1],e[i]]},select(){this.is.selected=!0,this.from&&(this.from.is.selected=!0),this.to&&(this.to.is.selected=!0)},unSelect(){this.is.selected=!1,this.from&&(this.from.is.selected=!1),this.to&&(this.to.is.selected=!1)},highLight(){this.is.highLighted=!0,this.from&&(this.from.is.highLighted=!0),this.to&&(this.to.is.highLighted=!0)},unHighLight(){var e,t,i,s;((t=(e=this.from)==null?void 0:e.node)!=null&&t.is.highLighted||(s=(i=this.to)==null?void 0:i.node)!=null&&s.is.highLighted)&&this.from.node!=this.to.node||(this.is.highLighted=!1,this.from&&(this.from.is.highLighted=!1),this.to&&(this.to.is.highLighted=!1))},setTwistedPair(){this.is.twistedPair=!0},checkTwistedPair(){var t;const e=this.from.is.input?this.to:this.from;e&&(e.is.pin&&e.is.multi?this.is.twistedPair=!0:e.is.pad&&((t=e.proxy)!=null&&t.is.multi)&&(this.is.twistedPair=!0))},typeString(){const e=this.from.is,t=this.to.is;let i=e.pin?"PIN":e.tack?"BUS":e.pad?"PAD":"";return i+=t.pin?"-PIN":t.tack?"-BUS":t.pad?"-PAD":"",i},hitSegment(e){const t=this.wire.length-1,i=e.x,s=e.y,n=5;for(let o=0;o<t;o++){const r=this.wire[o],a=this.wire[o+1];if(r.y==a.y){if(s<r.y+n&&s>r.y-n&&(r.x-i)*(a.x-i)<=0)return o+1}else if(i<r.x+n&&i>r.x-n&&(r.y-s)*(a.y-s)<=0)return o+1}return 0},remove(){this.from.removeRoute(this),this.to.removeRoute(this)},popFromRoute(){this.from.is.tack?this.from.bus.tacks.pop():this.from.routes.pop()},clone(){let e=new bt(this.from,this.to);for(const t of this.wire)e.wire.push({...t});return e},restore(){},copyWire(){const e=[];for(const t of this.wire)e.push({...t});return e},restoreWire(e){this.wire=[];for(const t of e)this.wire.push({...t})},messageFlow(){const e=this.from,t=this.to;return e.is.pin?e.is.input?[t,e]:[e,t]:t.is.pin?t.is.input?[e,t]:[t,e]:e.is.pad?e.proxy.is.input?[e,t]:[t,e]:t.is.pad?t.proxy.is.input?[t,e]:[e,t]:[t,e]}};Object.assign(bt.prototype,Cf,Rf,Ef,Af);const Mf={pinNameCheck(e,t){if(this.is.cable){if(e.is.multi||t.is.multi){if(!e.hasFullNameMatch(t))return!1}else if(e.name!=t.name)return!1}else if((e.is.multi||t.is.multi)&&!e.hasMultiOverlap(t))return!1;return!0},areConnected(e,t){if(e.is.pin){if(t.is.pin)return e.is.input==t.is.input||e.node==t.node?!1:this.pinNameCheck(e,t);if(t.is.pad)return e.is.input!=t.proxy.is.input?!1:this.pinNameCheck(e,t.proxy)}else if(e.is.pad){if(t.is.pin)return e.proxy.is.input!=t.is.input?!1:this.pinNameCheck(e.proxy,t);if(t.is.pad)return e.proxy.is.input==t.proxy.is.input?!1:this.pinNameCheck(e.proxy,t.proxy)}return console.log(e,t),!1},disconnect(){const e=this.tacks.slice();for(const t of e)(t.route.from==t?t.route.to:t.route.from).is.pin?t.route.rxtxPinBusDisconnect():t.route.rxtxPadBusDisconnect(),t.route.remove()},reconnect(e){for(const t of e){this.tacks.push(t),t.orient();const i=t.route.to==t?t.route.from:t.route.to;i.routes.push(t.route),i.is.pin?t.route.rxtxPinBus():t.route.rxtxPadBus()}},makeConxList(e,t){var i,s;for(const n of this.tacks){if(!((i=n.route)!=null&&i.from)||!((s=n.route)!=null&&s.to))continue;const o=n.route.from==n?n.route.to:n.route.from;this.areConnected(e,o)&&(o.is.pin?o.is.proxy?o.pad.makeConxList(t):t.push(o):o.is.pad&&o.proxy.makeConxList(t))}},splitTacks(e,t){this.tacks.forEach((i,s)=>{i.route.from.is.pin&&t.nodes.includes(i.route.from.node)&&(e.tacks.push(i),this.tacks[s]=null,i.bus=e)}),this.tacks=this.tacks.filter(i=>i!=null)},transferTacks(e){for(const t of this.tacks)for(const i of e)if(this.uid==i.uid){t.bus=i;break}},makeRoute(e){const t=bd(this.wire,e.center()),i=t.endPoint?kd(t.point,t.segment,this.wire):t.point,s=new vs(this);s.placeOnSegment(i,t.segment);const n=new bt(e,s);n.builder(),e.routes.push(n),s.restore(n)},rxtxPrepareTables(){},rxtxResetTables(){this.txTable=[],this.rxTable=[]},rxtxBuildRxTxTable(){for(const e of this.tacks)if(e.incoming())this.rxtxAddRxTack(e);else{const t=[],i=e.getOther();i.is.proxy?i.pad.makeConxList(t):i.is.pad?i.proxy.makeConxList(t):t.push(i),this.rxtxAddTxTack(e,t)}},rxtxAddTxTack(e,t){const i=new ra(e);i.fanout=t.slice(),this.txTable.push(i)},rxtxRemoveTxTack(e){const t=this.txTable.findIndex(i=>i.tack==e);t>-1&&this.txTable.splice(t,1)},rxtxAddRxTack(e){this.rxTable.push(new Cd(e))},rxtxRemoveRxTack(e){const t=this.rxTable.findIndex(i=>i.tack==e);t>-1&&this.rxTable.splice(t,1)}},Df={toJSON(){const e=this.is.cable?{kind:"cable",name:this.name}:{kind:"busbar",name:this.name};return this.is.filter&&this.filter&&(e.filter=this.filter),e.start=k.pointToString(this.wire[0]),e.wire=k.wireToString(this.wire),e},bluviz(){const t=this.is.cable?{kind:"cable",name:this.name}:{kind:"busbar",name:this.name};return this.is.filter&&this.filter&&(t.filter=this.filter),t.start=k.pointToString(this.wire[0]),t.wire=k.wireToString(this.wire),{blu:null,viz:t}},cook(e,t){if(this.is.cable=e.kind=="cable",this.name=e.name,e.filter){const i=t.getMainModel(),s=t.getCurrentModel();this.filter=new Zi(e.filter.function),this.is.filter=!0,e.filter.path&&(this.filter.arl=s.arl.resolve(e.filter.path),i!=s&&this.filter.arl.makeRelative(i.arl))}this.wire=k.stringToWire(k.stringToPoint(e.start),null,e.wire),this.wire.length==1&&this.wire.push(this.wire[0]),this.startLabel.place(),this.endLabel.place()}},If={drawXY(e){const t=this.wire.length,i=this.wire[t-2],s=this.wire[t-1],n=this.is.cable?m.bus.wCable:m.bus.wBusbar,o=this.endLabel.rect.h;let r=null;const a=s.x==i.x,l=s.y==i.y;a&&l?Math.abs(e.x-i.x)<Math.abs(e.y-i.y)?s.y=e.y:s.x=e.x:l?Math.abs(e.y-s.y)>m.bus.split?this.wire.push({x:s.x,y:e.y}):(this.tacks.length&&(r=this.getLimit(t-1))&&(i.x<s.x&&e.x<r.r+n/2&&(e.x=r.r+n/2),i.x>s.x&&e.x>r.l-n/2&&(e.x=r.l-n/2)),s.x=e.x,t>2&&Math.abs(s.x-i.x)<m.bus.tooClose&&this.wire.pop()):a&&(Math.abs(e.x-s.x)>m.bus.split?this.wire.push({x:e.x,y:s.y}):(this.tacks.length&&(r=this.getLimit(t-1))&&(i.y<s.y&&e.y<r.b&&(e.y=r.b),i.y>s.y&&e.y>r.t-o/2&&(e.y=r.t-o/2)),s.y=e.y,t>2&&Math.abs(s.y-i.y)<m.bus.tooClose&&this.wire.pop())),this.startLabel.place(),this.endLabel.place()},resumeDrawXY(e,t,i){e==this.startLabel&&this.reverse();const s=this.wire,n=s[s.length-2],o=s[s.length-1];let r=n.x==o.x&&Math.abs(t.x-n.x)>m.bus.split?t.x:o.x+i.x,a=n.y==o.y&&Math.abs(t.y-n.y)>m.bus.split?t.y:o.y+i.y;this.drawXY({x:r,y:a})},reverse(){[this.startLabel,this.endLabel]=[this.endLabel,this.startLabel];const e=this.wire,t=e.length;for(let i=0;i<t/2;i++)[e[i],e[t-i-1]]=[e[t-i-1],e[i]];this.tacks.forEach(i=>i.segment=t-i.segment)},getLimit(e){let t=null;return this.tacks.forEach(i=>{if(i.segment==e){const s=i.rect;t?(s.x<t.l&&(t.l=s.x),s.x+s.w>t.r&&(t.r=s.x+s.w),s.y<t.t&&(t.t=s.y),s.y+s.h>t.b&&(t.b=s.y+s.h)):t={l:s.x,r:s.x+s.w,t:s.y,b:s.y+s.h}}}),t},move(e,t){for(const i of this.wire)i.x+=e,i.y+=t;this.startLabel.move(e,t),this.endLabel.move(e,t);for(const i of this.tacks)i.rect.x+=e,i.rect.y+=t},drag(e){for(const t of this.wire)t.x+=e.x,t.y+=e.y;this.startLabel.move(e.x,e.y),this.endLabel.move(e.x,e.y);for(const t of this.tacks)t.moveXY(e.x,e.y)},moveRoutes(e,t){this.tacks.forEach(i=>{i.is.tack&&i.route.from==i&&i.route.moveAllPoints(e,t)})},getCombinedLimit(e,t){let i=this.getLimit(e),s=this.getLimit(t);return i&&s&&(s.l<i.l&&(i.l=s.l),s.r>i.r&&(i.r=s.r),s.t<i.t&&(i.t=s.t),s.b>i.b&&(i.b=s.b)),i||s},moveSegment(e,t){let i=this.wire;const s=t.x,n=t.y;let o=this.getCombinedLimit(e-1,e+1),r=i[e-1],a=i[e];if(r.y==a.y){if(o==null||r.y>o.b&&r.y+n>o.b||r.y<o.t&&r.y+n<o.t){r.y+=n,a.y+=n;for(const l of this.tacks)l.segment==e&&l.moveY(n)}}else if(r.x==a.x&&(o==null||r.x>o.r&&r.x+s>o.r||r.x<o.l&&r.x+s<o.l)){r.x+=s,a.x+=s;for(const l of this.tacks)l.segment==e&&l.moveX(s)}e==1&&this.startLabel.place(),e==i.length-1&&this.endLabel.place()},placeTacks(e,t,i){for(const s of this.tacks)s.orient()},removeTwoPoints(e){const t=this.wire,i=t.length;for(let s=e;s<i-2;s++)t[s]=t[s+2];t.pop(),t.pop(),this.tacks.forEach(s=>{s.segment>e&&(s.segment-=2)})},fuseSegment(e){let t=this.wire;if(t.length<3)return;const i=m.bus.tooClose;t[e-1].y==t[e].y?e<t.length-2&&Math.abs(t[e+1].y-t[e].y)<i?(t[e-1].y=t[e+1].y,this.removeTwoPoints(e)):e>1&&Math.abs(t[e-2].y-t[e-1].y)<i&&(t[e].y=t[e-2].y,this.removeTwoPoints(e-2)):t[e-1].x==t[e].x&&(e<t.length-2&&Math.abs(t[e+1].x-t[e].x)<i?(t[e-1].x=t[e+1].x,this.removeTwoPoints(e)):e>1&&Math.abs(t[e-2].x-t[e-1].x)<i&&(t[e].x=t[e-2].x,this.removeTwoPoints(e-2))),this.startLabel.place(),this.endLabel.place()},adjustRoutes(){for(const e of this.tacks)e.route.adjust()},closestTack(e){},straightConnections(){for(const e of this.tacks){const t=e.route,i=t.to==e?t.from:t.to;let s=this.wire[e.segment-1],n=this.wire[e.segment];if(s.x==n.x&&([s,n]=s.y>n.y?[n,s]:[s,n],i.rect.y>s.y&&i.rect.y<n.y)){e.rect.y=i.rect.y+i.rect.h/2-e.rect.h/2;for(const o of t.wire)o.y=i.rect.y+i.rect.h/2}}}};function Ps(e,t,i=null){this.uid=i,this.name=e??"",this.widGenerator=0,this.is={bus:!0,selected:!1,hoverOk:!1,hoverNok:!1,highLighted:!1,cable:!1,filter:!1},this.filter=null,this.rxTable=[],this.txTable=[],this.wire=[],this.wire.push({x:t.x,y:t.y}),this.wire.push({x:t.x,y:t.y});const s=m.bus.hLabel,n=0;this.startLabel=new qn({x:0,y:0,w:n,h:s},this),this.endLabel=new qn({x:0,y:0,w:n,h:s},this),this.startLabel.place(),this.endLabel.place(),this.tacks=[]}Ps.prototype={render(e){if(this.wire.length<2)return;const t=m.bus,i=this.is.hoverNok?t.cBad:this.is.selected||this.is.hoverOk?t.cSelected:this.is.highLighted?t.cHighLighted:t.cNormal;this.is.cable?$.drawCable(e,this.wire,i,t.wCable):$.drawBusbar(e,this.wire,i,t.wBusbar),this.startLabel.render(e),this.endLabel.render(e),this.tacks.forEach(s=>s.render(e))},generateWid(){return++this.widGenerator},highLight(){this.is.highLighted=!0,this.startLabel.highLight(),this.endLabel.highLight();for(const e of this.tacks)e.route.highLight()},unHighLight(){this.is.highLighted=!1,this.startLabel.unHighLight(),this.endLabel.unHighLight();for(const e of this.tacks)e.route.unHighLight()},highLightRoutes(e){this.is.highLighted=!0;for(const t of this.tacks){const i=t.route.from==t?t.route.to:t.route.from;i!==e&&this.areConnected(e,i)&&t.route.highLight()}},unHighLightRoutes(e){this.is.highLighted=!1;for(const t of this.tacks){const i=t.route.from==t?t.route.to:t.route.from;i!==e&&this.areConnected(e,i)&&t.route.unHighLight()}},hitTest(e){let t=at(e,this.startLabel.rect)?this.startLabel:at(e,this.endLabel.rect)?this.endLabel:null;if(t)return[H.busLabel,this,t,null,0];let i=this.hitSegment(e);if(i)return[H.busSegment,this,null,null,i];for(const s of this.tacks)if(at(e,s.rect))return[H.tack,this,null,s,0];return[H.nothing,null,null,null,0]},hitSegment(e){const t=this.wire.length,i=e.x,s=e.y;for(let n=0;n<t-1;n++){const o=this.wire[n],r=this.wire[n+1],a=5;if(o.y==r.y){if(s>o.y-a&&s<o.y+a&&(i>=o.x&&i<=r.x||i>=r.x&&i<=o.x))return n+1}else if(i>o.x-a&&i<o.x+a&&(s>=o.y&&s<=r.y||s>=r.y&&s<=o.y))return n+1}return 0},singleSegment(){return this.wire.length===2},hitRoute(e){let t=0;for(const i of this.tacks)if(i.route.from==i&&(t=i.route.hitSegment(e)))return[H.route,i.route,t];return[H.nothing,null,0]},overlap(e){var t;return((t=xd(this.wire,e))==null?void 0:t.length)>0},findTack(e){return this.tacks.find(t=>t.route.from==e||t.route.to==e)},removeTack(e){Ce(this.tacks,e)},addTack(e){const t=e.to==null?e.from:e.to;if(this.findTack(t))return null;const i=new vs(this);return i.setRoute(e),this.tacks.push(i),i},newTack(){const e=new vs(this);return this.tacks.push(e),e},copy(){const e=new Ps(this.name,this.wire[0],this.uid);return e.is.cable=this.is.cable,e.wire=this.copyWire(),e.startLabel.place(),e.endLabel.place(),e},copyTacks(e,t){for(const i of this.tacks){const s=i.route.clone(),n=new vs(e);s.to.is.tack?s.to=n:s.from=n,n.setRoute(s);const o=s.to.is.tack?s.from:s.to;if(o.is.pin){const a=t.nodes.find(l=>l.uid==o.node.uid).look.findPin(o.name,o.is.input);s.to.is.tack?s.from=a:s.to=a,a.routes.push(s)}else if(o.is.pad){const r=t.pads.find(a=>a.proxy.name==o.proxy.name);s.to.is.tack?s.from=r:s.to=r,r.routes.push(s)}e.tacks.push(n)}},copyWire(){const e=[];for(const t of this.wire)e.push({...t});return e},restoreWire(e){this.wire=[];for(const t of e)this.wire.push({...t})},copyTackWires(){const e=[];for(const t of this.tacks){const i=t.route.copyWire();e.push({segment:t.segment,track:i})}return e},restoreTackWires(e){const t=this.tacks,i=t.length;for(let s=0;s<i;s++)t[s].segment=e[s].segment,t[s].route.restoreWire(e[s].track)},hasFilter(){return this.is.filter},getFilterArl(e,t,i){var s;return(s=t==null?void 0:t.model)!=null&&s.is.lib?t.model.arl:e?e.arl:this.filter.arl?this.filter.arl:t!=null&&t.model?t.model.arl.resolve("index.js"):i},getFilter(e,t,i){const s=this.getFilterArl(t,i,e[0].arl),n=this.filter.duplicate(e,s)?`${this.filter.fName} as ${this.filter.alias}`:this.filter.fName,o=e.find(r=>r.arl.equals(s));o?o.items.find(a=>a==n)||o.items.push(n):e.push({arl:s,items:[n]})}};Object.assign(Ps.prototype,Mf,Df,If);function ya(){this.map=new Map}ya.prototype={reset(){this.map.clear()},size(){return this.map.size},addRawFactories(e){for(const t of e.raw.factories){const i=e.arl.resolve(t),s=i.getFullPath();if(this.map.has(s))continue;const n=new Zi;n.arl=i,this.map.set(s,n)}},add(e){const t=e.arl.getFullPath();if(!this.map.get(t))return this.map.set(t,e),this},toJSON(){const e=[];for(const t of this.map.values())e.push(t.arl.userPath);return e},all(e){const t=Array.from(this.map.values());return t!=null&&t.length?t.map(i=>e(i)):[]}};const Of={async getRoot(e){return await this.getFactoriesAndModels(e),this.compileNode(e,null)},encode(e,t){var n,o,r;if(!e)return null;e.collectFactories(this.factories),e.collectModels(this.models);const i={header:t.header};return((n=this.models)==null?void 0:n.size())>0&&(i.imports=this.models),((o=this.factories)==null?void 0:o.size())>0&&(i.factories=this.factories),((r=t.libraries)==null?void 0:r.size())>0&&(i.libraries=t.libraries),i.root=e,JSON.stringify(i,null,4)},encode_SF(e,t){var h,f,g;if(!e)return null;e.collectFactories(this.factories),e.collectModels(this.models);const{blu:i,viz:s}=t.header.bluviz(),n={header:i},o={header:s};((h=this.models)==null?void 0:h.size())>0&&(n.imports=this.models.all(v=>v.bluviz().blu)),((f=this.factories)==null?void 0:f.size())>0&&(n.factories=this.factories.all(v=>v.bluviz().blu)),(g=t.libraries)!=null&&g.size()&&(o.libraries=t.libraries.all(v=>v.bluviz().blu));const{blu:r,viz:a}=e.bluviz();n.root=r,o.root=a;const l=JSON.stringify(n,null,4),c=JSON.stringify(o,null,4);return{blu:l,viz:c}},compileNode(e,t){var n;if(!e)return console.log(`No model for node '${t}' `),null;const i=t?e.findRawNode(t):(n=e.raw)==null?void 0:n.root;if(!i)return console.log(`Node '${t}' not found in model ${e.arl.userPath}`),null;if(!this.pushCurrentNode(e,i))return console.log(`infinite loop for  '${t}' in model ${e.arl.userPath} `),null;const s=i.kind=="dock"?this.linkedNode(i):this.localNode(i);return this.popCurrentNode(),s},localNode(e){const t=e.kind=="source"?new bi(null,e.name):new It(null,e.name);return t.cook(e,this),t.setUIDS(this.UID),t},linkedNode(e){const[t,i]=[e.link.path,e.link.node],s=this.getCurrentModel(),n=t==null||t==="./"?s:this.models.get(s.arl.resolve(t).getFullPath()),o=this.compileNode(n,i),r=o?this.goodLink(e,i,n,o):this.badLink(e,i,n);return r.setUIDS(this.UID),r},goodLink(e,t,i,s){const n=s.is.source?new bi(null,e.name):new It(null,e.name);return n.cook(e,this),n.setLink(i,t),n.fuse(s),n},badLink(e,t,i){const s=new bi(null,e.name);return s.cook(e,this),s.setLink(i,t),s.linkIsBad(),s},updateNode(e){if(!(e.link&&e.link.is.bad)){if(e.link&&e.link.model.is.fresh){const t=this.compileNode(e.link.model,e.link.lName);if(!t){e.linkIsBad();return}if(!e.compatible(t)){const i=e.switchNodeType();this.view.root.swap(e,i),e=i}e.fuse(t),e.rxtxBuildTxTable();return}if(e.nodes)for(const t of e.nodes)this.updateNode(t)}}};function Li(e){this.models=new ro,this.factories=new ya,this.stack=[],this.UID=e}Li.prototype={reset(){this.factories.reset(),this.models.reset(),this.stack.length=0},resetFresh(){for(const e of this.models.map.values())e.is.fresh=!1},pushCurrentNode(e,t){const i=t.source??t.group??t.dock,s=this.stack.length;if(s>1){for(let n=0;n<s-1;n++)if(this.stack[n].nodeName===i&&this.stack[n].model===e)return console.log(i,e.arl.userPath),!1}return this.stack.push({model:e,nodeName:i}),!0},popCurrentNode(){this.stack.pop()},getCurrentModel(){return this.stack.at(-1).model},getMainModel(){return this.stack[0].model},async getFactoriesAndModels(e){var i,s;if(this.models.contains(e.arl)||(this.models.add(e),!e.raw&&!await e.getRaw())||!e.is.blu||(((i=e.raw.factories)==null?void 0:i.length)>0&&this.factories.addRawFactories(e),e.is.main&&e.raw.libraries&&e.addRawLibraries(e.arl,e.raw.libraries),!(((s=e.raw.imports)==null?void 0:s.length)>0)))return;const t=this.models.newModels(e.arl,e.raw.imports);if(t.length>0){const n=[];for(const o of t)n.push(this.getFactoriesAndModels(o));await Promise.all(n)}},async xgetFactoriesAndModels(e){var t,i;if(!this.models.contains(e.arl)&&(this.models.add(e),!(!e.raw&&!await e.getRaw())&&e.is.blu)){if(((t=e.raw.factories)==null?void 0:t.length)>0&&this.factories.addRawFactories(e),e.is.main&&e.raw.libraries&&e.addRawLibraries(e.arl,e.raw.libraries),!(((i=e.raw.imports)==null?void 0:i.length)>0))return;const s=this.models.newModels(e.arl,e.raw.imports);if(s.length>0){const n=[];for(const o of s)n.push(this.getFactoriesAndModels(o));await Promise.all(n)}}},async findOrAddModel(e){let t=this.models.findArl(e);return t||(t=new Mt(e),t.makeKey(),await this.getFactoriesAndModels(t),t)},async updateFactoriesAndModels(){const e=this.models.valuesArray();this.models.reset();const t=[];for(const i of e){if(i.is.main||this.models.contains(i.arl))continue;const s=i.header.utc;await i.getRaw(),i.raw&&(s!==i.header.utc?(console.log(`-SYNC- newer version of '${i.arl.userPath}'`),t.push(this.getFactoriesAndModels(i))):(this.models.add(i),i.is.fresh=!1))}await Promise.all(t)}};Object.assign(Li.prototype,Of);function ba(e,t){this.tx=e,this.ref=null,this.libraries=null}ba.prototype={onSwitchLibrary({ref:e,libraries:t}){!t||!e||(this.ref=e,this.libraries=t,this.tx.send("build table",this.libraries.map))},async onAddFile(e){if(!this.ref)return;const t=this.ref.resolve(e);if(!t)return console.log(`Could not resolve "${e}" to arl`);let i=this.libraries.findArl(t);i||(i=new Mt(t),await i.getRaw(),this.libraries.add(i)),i.setSelectable(),this.tx.send("build table",this.libraries.map)},onRemoveFile({model:e}){e&&(e.is.selectable=!1,this.tx.send("build table",this.libraries.map))}};function ka(e,t){this.tx=e,this.local=!1,this.origin=null,this.selection=null,this.copyCount=0}ka.prototype={resetContent(){this.local=!1,this.origin=null,this.selection=null,this.copyCount=0},sends:["switch","remote","local"],onSet({model:e,selection:t}){!e||!t||(this.resetContent(),this.local=!0,this.origin=e.copy(),this.selection=t.shallowCopy(),this.tx.send("switch"))},onGet(e){if(this.local){this.tx.reply(this);return}this.tx.request("remote").then(async({json:t})=>{const i=JSON.parse(t);i&&(await this.cook(i,e.savecom),this.tx.reply(this))}).catch(t=>console.log(`Clipboard manager -> remote : ${t}`))},onSwitched(){this.local=!1},onLocal(e){if(!this.local){console.log("Warning: clipboard is not local !");return}const t={origin:this.origin.arl.getFullPath(),header:this.origin.header,what:this.selection.what,rect:this.selection.rect?k.rectToString(this.selection.rect):null,viewPath:this.selection.viewPath,imports:null,factories:null,root:null,widgets:null};switch(this.selection.what){case C.pinArea:t.widgets=this.selection.widgets;break;case C.freeRect:case C.multiNode:case C.singleNode:{const s=e.savecom;s.reset(),t.root=new It(null,"clipboard",null),t.root.nodes=this.selection.nodes.slice(),t.root.buses=this.selection.buses.slice(),t.root.pads=this.selection.pads.slice(),t.root.collectFactories(s.factories),t.factories=s.factories,t.root.collectModels(s.models),t.imports=s.models}break;default:console.log(`unrecognized ${this.what} in clipboard.js`);break}const i=JSON.stringify(t,null,4);this.tx.reply({json:i})},async cook(e,t){var s,n,o;if(!e.origin)return!1;this.resetContent();const i=new Qt().absolute(e.origin);switch(this.origin=new Mt(i),this.origin.raw=e,e.header&&this.origin.header.cook(i,e.header),this.selection=new Ts,this.selection.viewPath=e.viewPath,e.rect&&(this.selection.rect=k.stringToRect(e.rect)),this.selection.what=+e.what,this.selection.what){case C.freeRect:case C.multiNode:case C.singleNode:{t.reset();const r=await t.getRoot(this.origin);if(!r)return!1;this.selection.nodes=(s=r.nodes)==null?void 0:s.slice(),this.selection.pads=(n=r.pads)==null?void 0:n.slice(),this.selection.buses=(o=r.buses)==null?void 0:o.slice()}return!0;case C.ifArea:case C.pinArea:{const r=new yt({x:0,y:0,w:0,h:0}),a=new It(r);for(const l of e.widgets){const c=r.cookWidget(a,l);c&&this.selection.widgets.push(c)}}return!0;default:return!1}}};const Ff={onSetDocument(e){if(!e){this.doc=null,this.redraw();return}e.view.noRect()&&e.view.setRect(0,0,this.canvas.width,this.canvas.height),this.doc=e,this.tx.send("change library",{ref:e.model.arl,libraries:e.model.libraries}),this.setStyle(),this.redraw()},onGetDocument(){this.tx.send("reply document",this.doc)},onShowSettings(){var s,n;if(!((s=this.doc)!=null&&s.model))return;const e=this.doc.model.header,t=()=>this.redraw(),i=e.style.rgb;this.tx.send("document settings",{title:"Document Settings",path:((n=this.doc.model.arl)==null?void 0:n.getFullPath())??"- unspecified -",settings:e,pos:{x:25,y:25},onColor(o){e.style.adapt(o),t()},ok(o){e.runtime=o},cancel(){e.style.adapt(i),t()}})},onSyncModel(){var e;(e=this.doc)==null||e.update().then(()=>{this.redraw()})},onRecalibrate(){var e;(e=this.doc)==null||e.view.toggleTransform(),this.redraw()},onGridOnOff(){var t,i;const e=(i=(t=this.doc)==null?void 0:t.view)==null?void 0:i.state;e&&(e.grid=!e.grid),this.redraw()},onAcceptChanges(){this.doc&&(this.doc.view.root.acceptChanges(),this.redraw())},onSizeChange(e){var t,i;e&&(this.canvas.width=e.w,this.canvas.height=e.h,this.canvas.style.width=e.w+"px",this.canvas.style.height=e.h+"px",this.ctx=this.canvas.getContext("2d"),this.setStyle(),this.doc&&((t=this.doc.view)==null||t.setRect(0,0,e.w,e.h),(i=this.doc.view)==null||i.redoBigRecursive()),this.redraw())},onMakeLib(e){var n,o;const t=this.doc;if(!((n=t==null?void 0:t.view)!=null&&n.root))return;const i={x:e.screenX,y:e.screenY},s=((o=t.target.library)==null?void 0:o.userPath)??zs(t.model.arl.userPath)+"-lib.js";this.tx.send("show lib path",{title:"Make library build file...",entry:s,pos:i,ok:r=>t.toJavascriptLib(r),cancel:()=>{}})},onMakeApp(e){var n,o;const t=this.doc;if(!((n=t==null?void 0:t.view)!=null&&n.root))return;const i={x:e.screenX,y:e.screenY},s=((o=t.target.library)==null?void 0:o.userPath)??zs(t.model.arl.userPath)+".app.js";this.tx.send("show app path",{title:"Make application...",path:s,pos:i,ok:r=>t.toJavascriptApp(r),cancel:()=>{}})},onRunApp(){const e=this.doc.toJavascriptApp(null);this.tx.send("run",{mode:"page",js:e.srcArl,html:e.htmlArl})},onRunAppInIframe(){const e=this.doc.toJavascriptApp(null);this.tx.send("run",{mode:"iframe",js:e.srcArl,html:e.htmlArl}),this.iframe||(this.iframe=document.createElement("iframe"),this.tx.send("iframe",this.iframe)),this.iframe.src=e.htmlArl.url},onPinProfile({}){},async onSelectedNode({model:e,nodePath:t,xyLocal:i}){const s=await this.doc.nodeFromLibrary(e,t);s&&(s.look.moveTo(i.x,i.y),this.doEdit("nodeFromNodeLib",{view:this.doc.focus,node:s}))},onSavePointSet({}){var t;if(!((t=this.doc)!=null&&t.model))return;const e=this.doc;this.tx.send("save point confirm",{title:"Confirm to set a new save point",message:"",pos:{x:500,y:100},ok:()=>{const i=e.getNodeToSave();if(!i)return;const s=new Li(e.UID);e.model.raw=JSON.parse(s.encode(i,e.model))},cancel:()=>{}})},onSavePointBack({}){var i;if(!((i=this.doc)!=null&&i.model))return;const e=this,t=this.doc;this.tx.send("save point confirm",{title:"Confirm to go back to the previous save point",message:"",pos:{x:500,y:100},ok:async()=>{t.reCompile(),t.undoStack.reset(),e.redraw();try{const s=JSON.stringify(t.model.raw,null,4);s&&t.model.arl.save(s)}catch(s){console.log(`JSON stringify error: ${s}
in 'on save point back'`)}},cancel:()=>{}})}},Wf={doEdit(e,t){Bs[e].doit(t),this.redraw()},saveEdit(e,t){this.doc.undoStack.push({verb:e,param:t}),this.tx.send("new edit",{verb:e}),this.doc.model.is.dirty=!0},signalEdit(e){this.tx.send("new edit",{verb:e})},send(e,t){this.tx.send(e,t)},getParam(){var e;return((e=this.doc.undoStack.last())==null?void 0:e.param)??{}},getVerb(){var e;return(e=this.doc.undoStack.last())==null?void 0:e.verb},undoLastEdit(){const e=this.doc.undoStack.back();console.log("undo ",e?e.verb:"-nothing-"),e&&Bs[e.verb].undo(e.param)},redoLastEdit(){const e=this.doc.undoStack.forward();console.log("redo ",e?e.verb:"-nothing-"),e&&Bs[e.verb].redo(e.param)},dropLastEdit(){this.doc.undoStack.back()}};let u;function Hf(e,t){return u=new ao,u.tx=e,u.sx=t,u.setup(),e.send("canvas",u.canvas),u}const ht={nothing:0,viewResize:1,viewDrag:2,hoverBorder:3};function ao(){this.canvas=null,this.ctx=null,this.doc=null,this.state={view:null,widget:null,action:ht.nothing},this.tx=null,this.sx=null,this.waitingForFrame=!1}ao.prototype={setup(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("tabindex","0"),this.canvas.style.outline="none",this.ctx=this.canvas.getContext("2d"),this.setStyle(),this.addEventHandlers(),this.clear()},getCanvasContext(){return this.ctx},addEventHandlers(){document.addEventListener("keydown",e=>this.onKeydown(e)),document.addEventListener("keyup",e=>this.onKeyup(e)),this.canvas.addEventListener("mousedown",e=>this.onMouseDown(e)),this.canvas.addEventListener("mouseup",e=>this.onMouseUp(e)),this.canvas.addEventListener("mousemove",e=>this.onMouseMove(e)),this.canvas.addEventListener("mousewheel",e=>this.onWheel(e)),this.canvas.addEventListener("contextmenu",e=>this.onContextMenu(e)),this.canvas.addEventListener("click",e=>this.onClick(e)),this.canvas.addEventListener("dblclick",e=>this.onDblClick(e)),this.canvas.addEventListener("dragover",e=>this.onDragOver(e)),this.canvas.addEventListener("drop",e=>this.onDrop(e))},clear(){this.ctx.fillStyle=m.std.cBackground,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},switchView(e){var i;if(!e)return;const t=this.doc;e!=t.focus&&(t.focus.unHighLight(),t.focus=e,t.focus.highLight(),(i=t.focus.parent)==null||i.viewToFront(t.focus))},setStyle(){var i;this.doc&&m.switch((i=this.doc.model.header)==null?void 0:i.style);const e=this.ctx,t=m.std;e.font=t.font,e.strokeStyle=t.cLine,e.fillStyle=t.cFill,e.lineCap=t.lineCap,e.lineJoin=t.lineJoin,e.lineWidth=t.lineWidth},redraw(){this.waitingForFrame||(this.waitingForFrame=!0,window.requestAnimationFrame(()=>{var e;this.clear(),(e=this.doc)==null||e.view.render(this.ctx),this.waitingForFrame=!1}))},changeCursor(e){u.canvas.style.cursor=e},xxdeltaForPaste(e,t){var n,o;const i=t.selection,s=i.rect?i.rect:((n=i.nodes)==null?void 0:n.length)>0?i.nodes[0].look.rect:((o=i.pads)==null?void 0:o.length)>0?i.pads[0].rect:{x:0,y:0};return t.copyCount++,s.x==e.x&&s.y==e.y?{x:t.copyCount*m.look.dxCopy,y:t.copyCount*m.look.dyCopy}:{x:e.x-s.x+(t.copyCount-1)*m.look.dxCopy,y:e.y-s.y+(t.copyCount-1)*m.look.dyCopy}},xxxdeltaForPaste(e,t){const i=t.rect?t.rect:t.root.nodes.length>0?t.root.nodes[0].look.rect:t.root.pads.length>0?t.root.pads[0].rect:{x:0,y:0};return t.copyCount++,i.x==e.x&&i.y==e.y?{x:t.copyCount*m.look.dxCopy,y:t.copyCount*m.look.dyCopy}:{x:e.x-i.x+(t.copyCount-1)*m.look.dxCopy,y:e.y-i.y+(t.copyCount-1)*m.look.dyCopy}},textToExternalClipboard(e){const t=new Blob([e],{type:"text/plain"}),i=[new ClipboardItem({"text/plain":t})];navigator.clipboard.write(i)}};Object.assign(ao.prototype,Td,_d,Ff,Wf);function Xn(e,t){this.variant=e,this.pin=t,this.actualTargets=[]}Xn.prototype={};function ci(e,t){this.variant=e,this.target=t}ci.prototype={toString(){return this.target.is.pin?`${this.variant} @ ${this.target.node.name} (${this.target.node.uid})`:this.target.is.pad?`${this.variant} @ ${this.target.proxy.node.name} (${this.target.proxy.node.uid})`:this.target.is.tack?`${this.variant} @ ${this.target.bus.name} (${this.target.bus.uid})`:"- unknown -"}};const $f={toJavascriptApp(e){var a;if(!e)return;((a=this.target.application)==null?void 0:a.userPath)!==e&&(this.target.application=this.resolve(e));const t=this.target.application,i=this.resolve("index.js"),s=this.model.header.runtime??"@vizualmodel/vmblu-runtime",n=this.makeJSApp(this.view.root,t,i,s);t.save(n);const o=this.model.makeMcpToolString(this.view.root);o&&t.resolve(zs(this.model.arl.userPath)+"-mcp.js").save(o);const r=this.resolve(uo(e,"html"));return{srcArl:t,htmlArl:r}},makeJSApp(e,t,i,s){var v;const n=[];n.push({arl:i,items:[]}),e.collectImports(n);const o=new Date;let r=`// ------------------------------------------------------------------
// Model: ${e.name}
// Path: ${((v=t.url)==null?void 0:v.pathname)||t.userPath}
// Creation date ${o.toLocaleString()}
// ------------------------------------------------------------------
`,a=`
//Imports`+this.JSImportExportString(n,`
import `,t);const l=[],c=[];e.makeSourceLists(l,c);let h=`//The runtime nodes
const nodeList = [`;for(const w of l)h+=this.JSSourceNode(w);h+=`
]`;let f=`//The filters
const filterList = [`;for(const w of c)f+=this.JSFilter(w);f+=`
]`;const g=`
// import the runtime code
import * as VMBLU from "${s}"

${a}

${h}

${f}

// prepare the runtime
const runtime = VMBLU.scaffold(nodeList, filterList)

// and start the app
runtime.start()
`;return r+g},JSImportExportString(e,t,i){let s="";const n=`,
		 `;return e.forEach(o=>{o.items.length<1||(s+=t+"{ ",o.items.length>0&&(o.items.forEach(r=>{s+=r+n}),s=s.slice(0,-n.length)),s+=` } from '${ln(o.arl.getFullPath(),i.getFullPath())}'`)}),s},JSSourceNode(e){const t=l=>{const h=l.is.input?l.is.channel?"=>":"->":l.is.channel?"<=":"<-";if(l.is.multi){let f="";for(const g of l.expandMultis())f+=`
		"${h} ${g}",`;return f}else return`
		"${h} ${l.name}",`},i=(l,c)=>{const h=JSON.stringify(l,null,4);return(h==null?void 0:h.length)>0?`,
	`+c+":	"+h.replaceAll(`
`,`
		`):""};let o=`${`
	//____________________________________________________________`.slice(0,-e.name.length)+e.name.toUpperCase()}
	{
	name: "${e.name}", 
	uid: "${e.uid}", 
	factory: ${e.factory.alias??e.factory.fName},`;o+=`
	inputs: [`;let r="";for(const l of e.rxTable)r+=t(l.pin);r.length>0&&(r=r.slice(0,-1)),o+=r.length>0?r+`
		],`:"],",o+=`
	outputs: [`;let a="";for(const l of e.txTable){const c=this.makeOutputTable(l);a+=this.stringifyOutputTable(c)}return a.length>0&&(a=a.slice(0,-1)),o+=a.length>0?a+`
		]`:"]",e.sx&&(o+=i(e.sx,"sx")),e.dx&&(o+=i(e.dx,"dx")),o+`
	},`},makeOutputTable(e){const t=[],i=e.pin.is.multi?k.expandMultis(e.pin.name):[e.pin.name];for(const s of i){const n=new Xn(s,e.pin);for(const o of e.targets){const r=this.getActualTarget(e.pin,s,o);r&&n.actualTargets.push(r)}t.push(n)}return t},stringifyOutputTable(e){let t="";for(const i of e){const n=i.pin.is.channel?"=>":"->";if(i.actualTargets.length==0)t+=`
		"${i.variant} ${n} ()",`;else if(i.actualTargets.length==1)t+=`
		"${i.variant} ${n} ${i.actualTargets[0].toString()}",`;else{let o=`
		\`${i.variant} ${n} [ `;for(const r of i.actualTargets)o+=`
			"${r.toString()}",`;o=o.slice(0,-1)+" ]`,",t+=o}}return t},JSFilter(e){let s=`${`
	//_____________________________________________________`.slice(0,-e.name.length)+e.name.toUpperCase()+" FILTER"}
	{
	name: "${e.name}", 
	uid: "${e.uid}", 
	filter: ${e.filter.alias??e.filter.fName},`;s+=`
	table: [`;const n=this.makeFilterTable(e),o=`
		`;for(const r of n){s+="\n		`"+r.variant+" : [";let a="";for(const l of r.actualTargets)a+=o+'	"'+l.toString()+'",';s+=a.slice(0,-1)+" ]`,"}return s+`]
	},`},makeFilterTable(e){const t=[];for(const i of e.rxTable){const s=i.tack.getOtherPin(),n=s.is.multi?k.expandMultis(s.name):[s.name];for(const o of n){if(t.find(a=>a.variant==o))continue;const r=new Xn(o,null);for(const a of e.txTable)if(a.connectsTo(o))for(const l of a.fanout){const c=this.getActualTarget(s,o,l);c&&r.actualTargets.push(c)}r.actualTargets.length>0&&t.push(r)}}return t},getActualTarget(e,t,i){if(i.is.pin)if(i.is.multi){const s=i.getMatch(t);return s?new ci(s,i):null}else return e.is.multi?e.getMatch(i.name)==t?new ci(i.name,i):null:new ci(i.name,i);else if(i.is.tack){const s=i.getOtherPin();if(s.is.multi){const n=s.getMatch(t);return n?new ci(n,i):null}else return e.is.multi?e.getMatch(s.name)==t?new ci(s.name,i):null:new ci(s.name,i)}},saveHtmlPage(e,t,i){const s=t.url.pathname,n=uo(s,"css"),o=`<!doctype html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width'>
    <title>${e.name}</title>
    <link rel='icon' type='image/png' href='/page/shared/favicon.ico'>
    <link rel='stylesheet' href='${n}'> 
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script type='module' src='${s}'><\/script>
</head>
<body style="overflow:hidden;"></body>
</html>`;i.save(o)},NOT_OK_makeAppScript(e,t){let i=[];return i.push({arl:t,items:[]}),e.collectImports(i),this.makeAppPage(e,i)}},Bf={toJavascriptLib(e){var n;if(!e)return;((n=this.target.library)==null?void 0:n.userPath)!==e&&(this.target.library=this.resolve(e));const t=this.target.library,i=this.resolve("index.js"),s=this.makeJSLib(this.view.root,this.model.arl,t,i);t.save(s)},makeJSLib(e,t,i,s){let n=[];n.push({arl:s,items:[]}),e.collectImports(n);const o=k.nodeToFactory(Us(i.userPath)),r=new Date,a=`// ------------------------------------------------------------------
// Lib: ${o}
// Model File: ${t.userPath}
// Lib   File: ${i.userPath}
// Creation date ${r.toLocaleString()}
// ------------------------------------------------------------------`,l=`

//Export`+this.JSImportExportString(n,`
export `,i),c="./"+Za(t.userPath),h=`

// The model
import ${o} from '${c}'
export {${o}}`;return a+l+h}},jf={async importFromModel(e,t,i){if(t.length==0||i.length==0)return;const s=this.model.arl.resolve(i),n=await this.modcom.findOrAddModel(s);if(e.setLink(n,t),!n){console.log(`importFromModel failed. Model not found - check the file (${i}) of the node to link to`);return}const o=this.modcom.compileNode(n,t);if(o)e.linkIsGood();else{console.log(`importFromModel failed. Could not compile '${t}' from file '${i}' (check if there is such a node in the model)`),e.linkIsBad();return}if(!e.compatible(o)){const r=e.switchNodeType();this.view.root.swap(e,r),e=r}e.fuse(o)},xxxencode(e,t){var n,o,r;if(!e)return null;e.collectFactories(this.factories),e.collectModels(this.models);const i={header:t.header};return((n=this.models)==null?void 0:n.size())>0&&(i.imports=this.models),((o=this.factories)==null?void 0:o.size())>0&&(i.factories=this.factories),((r=t.libraries)==null?void 0:r.size())>0&&(i.libraries=t.libraries),i.root=e,JSON.stringify(i,null,4)},async exportToModel(e,t,i){var a,l;if(e.link)return;const s=new Li(this.UID),n=e.copy();if(n.name=t,n.nodes)for(const c of n.nodes)c.adjustUserPaths(i.arl);n.collectFactories(s.factories),n.collectModels(s.models);const o={header:i.header};((a=s.models)==null?void 0:a.size())>0&&(o.imports=s.models),((l=s.factories)==null?void 0:l.size())>0&&(o.factories=s.factories),o.root=n;const r=JSON.stringify(o,null,4);await this.model.arl.save(r),e.setLink(i,t),e.is.group&&e.savedView&&e.savedView.closeView()},async nodeFromLibrary(e,t){if(t.length==0||!e)return null;const i=await this.modcom.findOrAddModel(e.arl);if(!i)return null;const s=this.modcom.compileNode(i,t);return s?(s.setLink(i,t),s):null},makeLocalLink(e,t){if(t.length==0)return;const i=this.view.root.findNode(t);if(!i){e.setLink(null,t),console.log(`Local link failed. Check the name (${t}) of the node to link to`),e.linkIsBad();return}const s=i.copy();if(s.uidChangeAll(this.UID),e.setLink(this.model,t),e.linkIsGood(),!e.compatible(s)){const n=e.switchNodeType();this.view.root.swap(e,n),e=n}e.fuse(s)}};function Ta(){this.uidmap=new Map,this.uidLength=4}Ta.prototype={reset(){this.uidmap.clear()},_freshUID(){let e=0;for(;e<10;){let t=wd(this.uidLength);if(!this.uidmap.has(t))return t;e++,console.log("*** THERE WAS A DUPLICATE *** (can happen, nothing to worry about)"),e>4&&this.uidLength++}return console.eror("*** FAILED TO MAKE A UNIQUE UID ***"),"????"},generate(e){e.uid=this._freshUID(),this.uidmap.set(e.uid,e)}};function nn(e=null){this.view=new _s({x:0,y:0,h:0,w:0}),this.focus=this.view,this.model=e?new Mt(e):null,this.model.is.main=!0,this.UID=new Ta,this.modcom=new Li(this.UID),this.savecom=new Li(this.UID),this.target={application:null,library:null},this.undoStack=new ta(31)}nn.prototype={resolve(e){var t,i;return(i=(t=this.model)==null?void 0:t.arl)==null?void 0:i.resolve(e)},async load(){var t;if(!this.model)return;this.modcom.reset(),this.UID.reset();const e=await this.modcom.getRoot(this.model);e?this.view.syncRoot(e):(this.view.initRoot(Us(this.model.arl.userPath)),console.warn(`Empty root for ${this.model.arl.userPath} -  ok for empty file`)),(t=this.model.libraries)==null||t.load()},reCompile(){this.UID.reset();const e=this.modcom.compileNode(this.model,null);e?this.view.syncRoot(e):(this.view.initRoot(Us(this.model.arl.userPath)),console.warn(`Empty root for ${this.model.arl.userPath} -  ok for empty file`))},async save(){if(!this.model)return null;this.savecom.reset();const e=this.getNodeToSave();if(!e)return;const{blu:t,viz:i}=this.savecom.encode_SF(e,this.model);this.model.home.blu.save(t),this.model.home.viz.save(i)},async xsave(){if(!this.model)return null;this.savecom.reset();const e=this.getNodeToSave();if(!e)return;const t=this.savecom.encode(e,this.model);return this.model.raw=JSON.parse(t),this.model.is.dirty=!1,this.model.arl.save(t)},async saveAs(e){if(Ga(e)||(e+=".vmblu"),Qa(e)){const t=ln(e,this.model.arl.url);console.log(`${t} ${e} ${this.model.arl.url}`),this.model.arl.url=e,this.model.arl.userPath=t}else{const t=this.model.arl.resolve(e);if(!t)return console.log(`Invalid path: "${e}" in Document.saveAs`),null;this.model.arl=t}return this.save()},async update(){var e;!this.model||!((e=this.view)!=null&&e.root)||(this.model.is.dirty&&(this.model.raw=JSON.parse(this.modcom.encode(this.view.root,this.model)),this.model.is.fresh=!0),await this.modcom.updateFactoriesAndModels(),this.modcom.updateNode(this.view.root),this.modcom.resetFresh())},getNodeToSave(){const e=this.view.root;if(!e||e.is.source)return null;const t=e.isContainer()&&e.nodes.length==1?e.nodes[0]:e;return t==e&&(t.savedView=this.view),t}};Object.assign(nn.prototype,$f,Bf,jf);function _a(e,t){this.tx=e,this.active=null,this.documents=[],this.checkForQueryParameters()}_a.prototype={haveDocument(e){return this.documents.find(t=>{var i;return(i=t.model.arl)==null?void 0:i.equals(e)})},openDocument(e){const t=new nn(e);this.documents.push(t),t.load().then(()=>{t.model.handleSourceMap()}).then(()=>{this.tx.send("tab new",e.getName()),this.tx.send("doc set active",t),this.active=t})},toForeground(e){e&&(this.tx.send("tab select",e.model.arl.getName()),this.tx.send("doc set active",e),this.active=e)},onDocSelected(e){const t=this.haveDocument(e);t?this.toForeground(t):this.openDocument(e)},onDocOpen(e){const t=this.haveDocument(e);t?this.toForeground(t):this.openDocument(e)},onDocGet(){},onDocNew(e){const t=new nn(e);this.documents.push(t),t.view.initRoot(Us(e.userPath)),this.tx.send("tab new",e.getName()),this.tx.send("doc set active",t),this.active=t},onDocRenamed({oldName:e,newName:t}){console.log("old-new",e,t)},onDocDeleted(e){},onSaveAs(e){if(!this.active)return;const t=e?{x:e.screenX,y:e.screenY}:{x:25,y:25},i=this.active,s=i.model.arl.getName();this.tx.send("save as filename",{title:"Save as...",entry:i.model.arl.userPath,pos:t,ok:n=>{i.saveAs(n)&&this.tx.send("tab rename",{oldName:s,newName:i.model.arl.getName()})},cancel:()=>{}})},onSave(){var e;(e=this.active)==null||e.save()},onSaveAll(){var e;(e=this.documents)==null||e.forEach(t=>t.model.arl&&t.save())},onGetOpenModels(){const e=[];this.documents.forEach(t=>{t.model.arl&&e.push(t.model.arl)}),this.tx.send("open models",e)},onTabRequestToClose(e){const t=this.documents.length;for(let i=0;i<t;i++)if(e==this.documents[i].model.arl.getName()){for(let s=i;s<t-1;s++)this.documents[s]=this.documents[s+1];this.documents.pop(),this.tx.send("tab remove",e),e==this.active.model.arl.getName()&&(i+1<t-1?(this.active=this.documents[i+1],this.tx.send("tab select",this.active.model.arl.getName())):i>0?(this.active=this.documents[i-1],this.tx.send("tab select",this.active.model.arl.getName())):this.active=null,this.tx.send("doc set active",this.active));return}},onTabRequestToSelect(e){const t=this.documents.find(i=>i.model.arl.getName()==e);t&&(this.active.model.is.dirty&&this.active.save(),this.tx.send("doc set active",t),this.tx.send("tab select",e),this.active=t)},checkForQueryParameters(){const{searchParams:e,origin:t}=new URL(window.location.href);if(!e)return;const i=e.get("model");if(!i)return;const s=new Qt(i);s.url=new URL(i,t),this.openDocument(s)}};function Pa(e,t){this.windowProxy=null,this.iframe=null,this.tx=e}Pa.prototype={sends:["iframe"],"-> run application"({mode:e,js:t,html:i}){i.url&&(e=="page"?this.windowProxy=window.open(i.url,"cell-runtime"):e=="iframe"&&(this.iframe||(this.iframe=document.createElement("iframe")),this.iframe.src=i.url,this.tx.send("iframe",this.iframe)))},"-> size change"({id:e,rect:t}){!this.iframe||!t||t.h<0||t.w<0||(this.iframe.height=t.h,this.iframe.width=t.w)},"-> show"(){}};const zf=[{name:"workspace",uid:"CyUX",factory:Vc,inputs:["-> dom add modal div","-> file savedAs","-> file active","-> file closed"],outputs:["dom workspace div -> left column @ column-main layout (hCIa)","file selected -> doc selected @ document manager (boaB)","file new -> doc new @ document manager (boaB)","file get name -> ()","file context menu -> ()","file renamed -> doc renamed @ document manager (boaB)","file deleted -> doc deleted @ document manager (boaB)","files get list => ()","files selected -> ()","files deleted -> ()","folder context menu -> context menu @ context menu (SlxZ)","folder renamed -> ()","folder deleted -> ()","drawer get location -> ()"],sx:{name:"examples",files:[],folders:[{name:"tutorial",files:[{name:"chat-client.vmblu"},{name:"chat-server.vmblu"}]}]}},{name:"single text field",uid:"TOwd",factory:pd,inputs:["-> show"],outputs:["modal div -> dom add modal div @ workspace (CyUX)"]},{name:"context menu",uid:"SlxZ",factory:Ao,inputs:["-> context menu"],outputs:["modal div -> dom add modal div @ workspace (CyUX)"]},{name:"message box",uid:"VXFB",factory:ud,inputs:["-> show"],outputs:["modal div -> dom add modal div @ workspace (CyUX)"]},{name:"tab ribbon",uid:"pZkU",factory:od,inputs:["-> tab new","-> tab rename","-> tab select","-> tab remove"],outputs:["tab request to close -> tab request to close @ document manager (boaB)","tab request to select -> tab request to select @ document manager (boaB)","div -> tabs div @ vertical menu tabs content (WcXX)"],sx:{a:7,b:8,c:"dit is een filename",d:{e:"nee",dxdy:254}}},{name:"editor",uid:"JUfI",factory:Hf,inputs:["-> sync model","-> grid on-off","-> accept changes","-> recalibrate","-> show settings","-> make lib","-> make app","-> run app","-> run app in iframe","-> set document","-> save point set","-> save point back","-> selected node","-> size change"],outputs:["show lib path -> path @ path request (eUAC)","show app path -> path @ path request (eUAC)","run -> ()","runtime settings -> show @ runtime settings (vsOX)","open document -> doc open @ document manager (boaB)","document settings -> show @ doc settings (fIor)","save point confirm -> show @ confirm box (Vimv)","show context menu -> context menu @ context menu (whob)","settings -> json @ node settings (zQNk)","show link -> name and path @ name and path (qCkB)","show filter -> name and path @ name and path (qCkB)","show factory -> name and path @ name and path (qCkB)","open source file -> ()","pin profile -> show @ pin profile (LfmT)","node comment -> text @ text block (Hpef)","select node -> show @ node selector (gvGa)","change library -> switch library @ node library (DZCu)","add lib file -> ()","canvas -> content div @ vertical menu tabs content (WcXX)","new edit -> ()","clipboard get => get @ clipboard (DdNx)","clipboard set -> set @ clipboard (DdNx)"],sx:{a:7,b:8,c:9}},{name:"context menu",uid:"whob",factory:Ao,inputs:["-> context menu"],outputs:["modal div -> modal div @ vertical menu tabs content (WcXX)"]},{name:"path request",uid:"eUAC",factory:Mo,inputs:["-> path"],outputs:["modal div -> modal div @ vertical menu tabs content (WcXX)"]},{name:"node settings",uid:"zQNk",factory:cd,inputs:["-> json"],outputs:["modal div -> modal div @ vertical menu tabs content (WcXX)"]},{name:"name and path",uid:"qCkB",factory:fd,inputs:["-> name and path"],outputs:["modal div -> modal div @ vertical menu tabs content (WcXX)"]},{name:"pin profile",uid:"LfmT",factory:dd,inputs:["-> show"],outputs:["modal div -> modal div @ vertical menu tabs content (WcXX)"]},{name:"text block",uid:"Hpef",factory:hd,inputs:["-> text"],outputs:["modal div -> modal div @ vertical menu tabs content (WcXX)"]},{name:"vertical menu tabs content",uid:"WcXX",factory:sd,inputs:["-> menu div","-> tabs div","-> content div","-> modal div","-> show","-> size change"],outputs:["content size change -> size change @ editor (JUfI)","div -> main area @ column-main layout (hCIa)"]},{name:"document manager",uid:"boaB",factory:_a,inputs:["-> doc selected","-> doc new","-> doc renamed","-> doc deleted","-> doc get","-> doc open","-> save","-> save as","-> save all","-> get open models","-> tab request to close","-> tab request to select"],outputs:["doc set active -> set document @ editor (JUfI)","save as filename -> path @ path request (eUAC)","open models -> ()","tab new -> tab new @ tab ribbon (pZkU)","tab rename -> tab rename @ tab ribbon (pZkU)","tab select -> tab select @ tab ribbon (pZkU)","tab remove -> tab remove @ tab ribbon (pZkU)"],dx:{logMessages:!1,worker:{on:!1,path:""}}},{name:"node selector",uid:"gvGa",factory:md,inputs:["-> show","-> build table"],outputs:["selected node -> selected node @ editor (JUfI)","remove file -> remove file @ node library (DZCu)","add file -> add file @ node library (DZCu)","get path -> path @ path request (xqVh)","modal div -> modal div @ vertical menu tabs content (WcXX)"]},{name:"node library",uid:"DZCu",factory:ba,inputs:["-> switch library","-> remove file","-> add file"],outputs:["build table -> build table @ node selector (gvGa)"]},{name:"path request",uid:"xqVh",factory:Mo,inputs:["-> path"],outputs:["modal div -> modal div @ vertical menu tabs content (WcXX)"]},{name:"doc settings",uid:"fIor",factory:gd,inputs:["-> show"],outputs:["modal div -> modal div @ vertical menu tabs content (WcXX)"]},{name:"clipboard",uid:"DdNx",factory:ka,inputs:["-> switched","=> local","=> get","-> set"],outputs:["switch -> ()","remote => ()"]},{name:"confirm box",uid:"Vimv",factory:ld,inputs:["-> show"],outputs:["modal div -> modal div @ vertical menu tabs content (WcXX)"]},{name:"runtime settings",uid:"vsOX",factory:ad,inputs:["-> show"],outputs:["modal div -> modal div @ vertical menu tabs content (WcXX)"]},{name:"side menu",uid:"Xnvn",factory:rd,inputs:[],outputs:["div -> menu div @ vertical menu tabs content (WcXX)","sync -> sync model @ editor (JUfI)","grid on-off -> grid on-off @ editor (JUfI)","accept changes -> accept changes @ editor (JUfI)","recalibrate -> recalibrate @ editor (JUfI)","show settings -> show settings @ editor (JUfI)","make lib -> make lib @ editor (JUfI)","make app -> make app @ editor (JUfI)","set save point -> save point set @ editor (JUfI)","back to save point -> save point back @ editor (JUfI)","save -> save @ document manager (boaB)","save as -> save as @ document manager (boaB)"],sx:[{icon:"flare",color:"#0fb2e4",message:"recalibrate",help:"Recalibrate"},{icon:"grid_view",color:"#0fb2e4",message:"grid on-off",help:"Grid on/off"},{icon:"check_box",color:"#0fb2e4",message:"accept changes",help:"Accept changes"},{icon:"bolt",color:"#0fb2e4",message:"sync",help:"sync model"},{icon:"push_pin",color:"#0fb2e4",message:"set save point",help:"set save point"},{icon:"reply",color:"#0fb2e4",message:"back to save point",help:"back to save point"},{icon:"build",color:"#0fb2e4",message:"make lib",help:"Make lib"},{icon:"handyman",color:"#0fb2e4",message:"make app",help:"Make app"},{icon:"settings",color:"#0fb2e4",message:"show settings",help:"Settings"},{icon:"save",color:"#0fb2e4",message:"save",help:"save"},{icon:"save_as",color:"#0fb2e4",message:"save as",help:"save as ..."}]},{name:"application launcher",uid:"DbDQ",factory:Pa,inputs:["-> run application","-> size change","-> show"],outputs:["iframe -> ()"]},{name:"column-main layout",uid:"hCIa",factory:nd,inputs:["-> left column","-> main area"],outputs:["size change -> size change @ vertical menu tabs content (WcXX)"]}],Uf=[],Vf=Ua(zf,Uf);Vf.start();
//# sourceMappingURL=playground.app-bundle.js.map
