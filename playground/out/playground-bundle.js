var Ca=Object.defineProperty;var ao=e=>{throw TypeError(e)};var Ra=(e,t,i)=>t in e?Ca(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var _t=(e,t,i)=>Ra(e,typeof t!="symbol"?t+"":t,i),Pn=(e,t,i)=>t.has(e)||ao("Cannot "+i);var x=(e,t,i)=>(Pn(e,t,"read from private field"),i?i.call(e):t.get(e)),se=(e,t,i)=>t.has(e)?ao("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i),Y=(e,t,i,s)=>(Pn(e,t,"write to private field"),s?s.call(e,i):t.set(e,i),i),xe=(e,t,i)=>(Pn(e,t,"access private method"),i);function us(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}us.prototype={resolve(e){this._resolve(e)},reject(e){this._reject(e)}};function Os(e){this.defs=e}Os.prototype={then(e,t){const i=this.defs.map(s=>{const n=new us;return s.promise.then(e,t).then(n.resolve.bind(n),n.reject.bind(n)),n});return new Os(i)},catch(e){const t=this.defs.map(i=>{const s=new us;return i.promise.catch(e).then(s.resolve.bind(s),s.reject.bind(s)),s});return new Os(t)},replace(e){if(e>this.defs.length)for(let t=this.defs.length;t<e;t++)this.defs.push(new us);else e<this.defs.length&&this.defs.splice(e).forEach(t=>{})}};function zo(){this.minTimeout=1e3,this.queue=new Map}zo.prototype={addPromiseHandler(e,t,i=1){const s=Math.max(t,this.minTimeout),n=Array.from({length:i},()=>new us),o=new Os(n);return this.queue.set(e,{handler:o,time:{start:Date.now(),duration:s}}),o},changePromiseHandler(e,t){const i=this.queue.get(e);i&&i.handler.replace(t)},trigger(e,t){const i=this.queue.get(e);if(!i)return console.log(e,"NOT FOUND");i.handler.defs.shift().resolve(t),i.handler.defs.length===0&&this.queue.delete(e)},checkTimeouts(e=Date.now()){for(const[t,i]of this.queue.entries()){const{start:s,duration:n}=i.time;if(s+n<=e){const o=new Error("Reply timeout",{sender:t,msec:n});i.handler.defs.forEach(r=>r.reject(o)),this.queue.delete(t)}}}};const ws=0,Sn=268435456,js=536870912,Ln=4026531840,Ea=268435455;function qo(e,t,i=!1){this.uid=e,this.actor=null,this.pin=t,this.channel=i,this.hix=ws}const lo="->",Ma="=>",gi={stringToInput(e){const t=e.trim(),i=t.slice(0,2);return{pin:t.slice(2).trim(),channel:i!==lo}},stringToOutput(e){function t(r){return!(r[0]=="["&&r.at(-1)=="]")}let i=!1,s=e.indexOf(lo);if(s<0&&(s=e.indexOf(Ma),i=!0),s<0)return null;const n=e.slice(0,s).trim(),o=e.slice(s+2).trim();if(n.length==0||o.length==0)return null;if(t(o)){const r=gi.stringToTarget(o);return r?{output:n,channel:i,targets:[r]}:{output:n,channel:i,targets:[]}}else{const r=/"(?:\\.|[^"\\])*"/g;let a=o.match(r);const l=a?a.map(h=>h.slice(1,-1).replace(/\\"/g,'"')):[],c=[];for(const h of l){const u=gi.stringToTarget(h);u&&c.push(u)}return{output:n,channel:i,targets:c}}},stringToScope(e){let t=e.indexOf(":");if(t<0)return null;const i=e.slice(0,t).trim(),s=e.slice(t+1).trim();if(i.length==0||s.length==0)return null;const n=/"(?:\\.|[^"\\])*"/g;let o=s.match(n);const r=o?o.map(l=>l.slice(1,-1).replace(/\\"/g,'"')):[],a=[];for(const l of r){const c=gi.stringToTarget(l);c&&a.push(c)}return{selector:i,scope:a}},stringToTarget(e){const t=e.lastIndexOf("(");if(t<0)return null;const i=e.lastIndexOf(")");if(i<0||i-t<2)return null;const s=e.slice(t+1,i),n=e.indexOf("@");if(n<0)return null;const o=e.slice(0,n).trim(),r=e.slice(n+1,t).trim();return o.length==0||r.length==0?null:{pinName:o,nodeName:r,uid:s}},pinToHandler(e){return"on"+e.split(/[ .-]+/).map(s=>s.replace(/[^a-zA-Z0-9_]/g,"")).filter(Boolean).map(s=>s[0].toUpperCase()+s.slice(1)).join("")}},Jo={LOGMSG:1},Mi=Jo.LOGMSG;function Go(){this.actors=[],this.timer=0,this.minDelay=0,this.maxDelay=100,this.scheduleDelay=this.minDelay,this.idleCount=0,this.idleTreshold=100,this.slow=!1,this.msgCount=0,this.startTime=null,this.qOut=[],this.qIn=[],this.qResolve=new zo}Go.prototype={start(){clearTimeout(this.timer),this.qOut=[],this.qIn=[],this.msgCount=0;for(const e of this.actors)e.makeCell();this.startTime=Date.now(),this.timer=setTimeout(this.receive.bind(this),this.scheduleDelay)},stop(){clearTimeout(this.timer),this.msgCount=0,this.actors.forEach(e=>e.cell=null),this.qOut=[],this.qIn=[]},halt(){clearTimeout(this.timer)},continue(){this.timer=setTimeout(this.receive.bind(this),this.scheduleDelay)},switch(){const e=this.qIn;this.qIn=this.qOut,this.qOut=e,this.qOut.length=0,this.slow&&this.goFast()},idle(){this.idleCount++;const e=Date.now();if(this.qResolve.checkTimeouts(e),this.idleCount%600==0){const t=(e-this.startTime)/6e4;console.log(`<idle> ${this.idleCount} cycles - nr of messages: ${this.msgCount} - running time:${t.toFixed(0)} min`)}!this.slow&&this.idleCount>this.idleTreshold&&this.goSlow()},goFast(){this.scheduleDelay=this.minDelay,this.idleCount=0,this.slow=!1},goSlow(){this.scheduleDelay=this.maxDelay,this.slow=!0},reject(e){return new Promise((t,i)=>{i(new Error(e))})},sendTo(e,t,i,s){if(e.length<1)return 0;t.flags&Mi&&console.log(`${t.name} -> ${i}`),++this.msgCount;for(const n of e)this.qOut.push({from:t.uid,txRef:0,dest:n.actor,rxRef:0,hix:n.hix,pin:i,param:s});return e.length},requestFrom(e,t,i,s,n){t.flags&Mi&&console.log(`${t.name} => ${i}`);const o=++this.msgCount;let r=0;for(const a of e)this.qOut.push({from:t.uid,txRef:o,dest:a.actor,rxRef:0,hix:a.hix,pin:i,param:s}),a.channel&&r++;return r==0?this.reject("No channel"):this.qResolve.addPromiseHandler(o,n,r)},reply(e,t){var i;return(i=e.msg)!=null&&i.txRef?(e.flags&Mi&&console.log(`reply to ${e.msg.pin} @ ${e.name}`),++this.msgCount,this.qOut.push({from:e.uid,txRef:0,dest:e.msg.from,rxRef:e.msg.txRef,hix:Sn,pin:e.msg.pin,param:t}),1):0},next(e,t,i){var n;if(!((n=e.msg)!=null&&n.txRef))return this.reject("No target");const s=++this.msgCount;return this.qOut.push({from:e.uid,txRef:s,dest:target.actor,rxRef:e.msg.txRef,hix:Sn,pin:e.msg.pin,param:t}),this.qResolve.addPromiseHandler(s,i)},receive(){this.qOut.length?(this.switch(),this.handleReceiveQueue()):this.idle(),this.timer=setTimeout(this.receive.bind(this),this.scheduleDelay)},handleReceiveQueue(){var e,t;for(const i of this.qIn){const s=i.dest;switch(i.hix&Ln){case ws:s.msg=i,s.flags&Mi&&console.log(`${s.name} <- ${i.pin} (run ${s.rxTable[i.hix].handler.name})`),s.rxTable[i.hix].handler.call(s.cell,i.param);break;case Sn:s.flags&Mi&&console.log(`${s.name} <= ${i.pin} (reply)`),this.qResolve.trigger(i.rxRef,i.param);break;case js:{s.flags&Mi&&console.log(`${s.name} <- ${i.pin} (filter via router)`);const n=i.dest.scopeTable[i.hix&Ea],o=((t=(e=s.cell).filter)==null?void 0:t.call(e,n.targets.keys(),i.pin,i.param))??[...n.targets.keys()];if(Array.isArray(o)&&o.length>0)this.forwardToAll(i,o,n.targets);else{const r=n.targets.get(o);r&&this.forward(i,r)}}break}}},forwardToAll(e,t,i){let s=0;for(const n of t){const o=i.get(n);o&&(this.forward(e,o),e.txRef>0&&o.channel&&s++)}s>1&&this.qResolve.changePromiseHandler(e.txRef,s)},forward(e,t){(t.hix&Ln)==ws?(t.actor.msg=e,t.actor.rxTable[t.hix].handler.call(t.actor.cell,e.param)):(t.hix&Ln)==js&&this.qOut.push({from:e.from,txRef:e.txRef,dest:t.actor,rxRef:0,hix:t.hix,pin:t.pin,param:e.param})},reschedule(e){this.qOut.push(e)}};function Aa(e,t=!1){this.pin=e,this.channel=t,this.handler=null}function Da(e,t=!1){this.pin=e,this.channel=t,this.targets=[]}function Oa(e){const t=Object.getOwnPropertyNames(this);console.warn(`Missing handler for cell: ${t} - parameters: ${e}`)}function Ia(e){if(typeof e!="function"||!e.prototype)return!1;const t=Object.getOwnPropertyNames(e.prototype);return t.length!==1||t[0]!=="constructor"||e.prototype.constructor!==e}function Yo({name:e,uid:t,factory:i,inputs:s,outputs:n,sx:o,dx:r}){this.name=e,this.uid=t,this.factory=i,this.useNew=Ia(i),this.rxTable=[],this.txTable=[],this.sx=o??null,this.dx=r??null,this.flags=0,this.cell=null,this.msg=null,this.setFlags(),this.initRxTxTables({inputs:s,outputs:n})}Yo.prototype={setFlags(){var e;(e=this.dx)!=null&&e.flags&&this.dx.flags.includes("LOGMSG")&&(this.flags|=Jo.LOGMSG)},initRxTxTables({inputs:e,outputs:t}){for(const i of e){const s=gi.stringToInput(i);s&&this.rxTable.push(new Aa(s.pin,s.channel))}for(const i of t){const s=gi.stringToOutput(i);if(!s)continue;const n=new Da(s.output,s.channel);this.txTable.push(n);for(const o of s.targets)n.targets.push(new qo(o.uid,o.pinName,s.channel))}},makeCell(){try{this.useNew?this.cell=new this.factory(this.getTx(),this.sx):this.cell=this.factory(this.getTx(),this.sx)}catch(e){if(e instanceof TypeError&&typeof this.factory=="function"&&/class constructor/i.test(e.message))this.useNew=!0,this.cell=new this.factory(this.getTx(),this.sx);else throw e}this.addHandlersForCell()},addHandlersForCell(){var s;if(!this.cell){((s=this.rxTable)==null?void 0:s.length)>0&&console.warn(`** NO HANDLERS ** Node ${this.name} has input pins but no implementation.`);return}const e=Object.entries(this.cell),t=Object.getPrototypeOf(this.cell),i=Object.getOwnPropertyNames(t)??[];for(const n of i)typeof t[n]=="function"&&e.push([n,t[n]]);e.forEach(([n,o])=>{if(typeof o=="function"){const r=this.getRx(n);r&&(r.handler=o)}}),this.rxTable.forEach(n=>{n.handler||(console.warn(`** NO HANDLER ** Node "${this.name}" has input pin "${n.pin}" but no handler for it.`),n.handler=Oa)})},getRx(e){if(e.startsWith("-> ")||e.startsWith("=> ")){const t=e.slice(3);return this.rxTable.find(i=>i.pin==t)}return this.rxTable.find(t=>gi.pinToHandler(t.pin)==e)},resolveUIDs(e){this.txTable.forEach(t=>{t.targets.forEach(i=>{if(i.actor=e.find(s=>s.uid==i.uid),!i.actor)return console.error(`** ERROR ** target node ${i.uid} in ${this.name} not found`);i.hix=i.actor.factory?ws|i.actor.rxTable.findIndex(s=>s.pin==i.pin):js|i.actor.scopeTable.findIndex(s=>s.selector==i.pin)})})},findTargets(e){if(!e)return[];const t=this.txTable.find(i=>i.pin==e);return t?t.targets:(console.warn(`** NO OUTPUT PIN ** Node "${this.name}" pin: "${e}"`,this.txTable),[])},getTx(){const e=this;return{get pin(){var t;return(t=e.msg)==null?void 0:t.pin},send(t,i){if(!t)return 0;const s=e.findTargets(t);return He.sendTo(s,e,t,i)},request(t,i,s=0){if(!t)return null;const n=e.txTable.find(o=>o.pin==t);return n!=null&&n.targets.length?He.requestFrom(n.targets,e,t,i,s):(console.warn(`** NO OUTPUT PIN ** Node "${this.name}" pin: "${t}"`,this.txTable),He.reject("Not connected"))},reply(t){return He.reply(e,t)},next(t,i=0){return He.next(e,t,i)},reschedule(){e.msg&&He.reschedule(e.msg)},wireless(t){const i=He.actors.find(n=>n.name.toLowerCase()==t.toLowerCase());if(!i)return console.warn(`** WIRELESS SEND TO UNKNOWN NODE ** ${t}`),{send(n,o){return 0},request(n,o,r=1e3){return new Promise((a,l)=>{l(new Error("no node"))})}};function s(n){const o=i.rxTable.length;for(let r=0;r<o;r++)if(i.rxTable[r].pin==n)return{uid:i.uid,actor:i,pin:n,channel:i.rxTable[r].channel,hix:r};return null}return{send(n,o){const r=s(n);return r?He.sendTo([r],e,n,o):(console.warn(`** WIRELESS SEND TO UNKNOWN PIN ** ${t} pin: ${n}`),0)},request(n,o,r=0){const a=s(n);return a?He.requestFrom([a],e,n,o,r):(console.warn(`** WIRELESS REQUEST TO UNKNOWN PIN ** ${t} pin: ${n}`),new Promise((l,c)=>{c(new Error("no pin"))}))}}}}}};function Fa(e){this.selector=e,this.targets=new Map}function Xo({name:e,uid:t,filter:i,table:s}){var n;this.name=e,this.uid=t,this.filter=i,this.useNew=((n=i.prototype)==null?void 0:n.constructor)!==i,this.scopeTable=[],this.cell=null,this.msg=null,this.buildScopeTable(s)}Xo.prototype={buildScopeTable(e){for(const t of e){const i=gi.stringToScope(t),s=new Fa(i.selector);for(const n of i.scope){const o=new qo(n.uid,n.pinName);s.targets.set(n.nodeName,o)}this.scopeTable.push(s)}},resolveUIDs(e){for(const t of this.scopeTable)for(const i of t.targets.values()){if(i.actor=e.find(s=>s.uid==i.uid),!i.actor)return console.error(`** ERROR ** target node ${i.uid} in ${this.name} not found`);i.actor.factory?i.actor.rxTable.find((s,n)=>s.pin!=i.pin?!1:(i.hix=ws|n,i.channel=s.channel,!0)):i.actor.filter&&i.actor.scopeTable.find((s,n)=>s.selector!=i.pin?!1:(i.hix=js|n,!0))}},makeCell(){this.cell=this.useNew?new this.filter:this.filter()}};let He=null;function Wa(e,t=[]){He=new Go;for(const i of e){const s=new Yo(i);He.actors.push(s)}for(const i of t){const s=new Xo(i);He.actors.push(s)}return He.actors.forEach(i=>i.resolveUIDs(He.actors)),He}function Ko(e,t,i){this.message="HTTP code: "+t+": "+e,this.cause=i}const Qo=8e3;async function Ha(e,t={}){const i=new AbortController;t.signal=i.signal;const s=setTimeout(()=>i.abort(),Qo);return fetch(e,t).then(n=>{if(clearTimeout(s),n.ok)return n;throw new Ko("GET failed",n.status,"")}).catch(n=>{throw clearTimeout(s),n})}async function Ba(e,t,i="text/plain"){const s=new AbortController,n=setTimeout(()=>s.abort(),Qo);let o={method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":i},redirect:"follow",referrerPolicy:"no-referrer",body:t,signal:s.signal};const r=await fetch(e,o).catch(l=>{throw console.log("Network failure",l),l});if(clearTimeout(n),r.ok)return r;let a=await r.json();throw new Ko("POST failed",r.status,a)}const $a={vizPath:/^((?:\.\/)?|(?:\.\.\/)*|\/|(?:[\w\s-]+\:\/?))((?:[\w\s-]+\/)*)([\w\s-\.]+)$/},ja=6;function Va(e){let t=e.lastIndexOf(".");return t>0&&e.length-t<=ja}function Zo(e){let t=e.lastIndexOf(".");return t<0?"":e.slice(t+1)}function co(e,t){let i=e.lastIndexOf(".");return i>0?e.slice(0,i+1)+t:e+"."+t}function Vs(e){let t=e.lastIndexOf(".");return t>0?e.slice(0,t):e}function Ua(e){return $a.vizPath.test(e)?e:null}function za(e){const t=e.lastIndexOf("/");return t<0?e:e.slice(t+1)}function Us(e){let t=e.lastIndexOf("/"),i=e.lastIndexOf(".");return i>t?e.slice(t+1,i):e.slice(t+1)}function qa(e){return/^(\/|https?:\/\/|file:\/\/\/|[a-zA-Z]:\\)/.test(e)}function Ja(e,t){const i=e.length<t.length?e.length:t.length;for(let s=0;s<i;s++)if(e[s]!=t[s])return s}function an(e,t){const i=Ja(e,t);let s=e.lastIndexOf("/",i);if(s<1)return e;let n=e.slice(s+1),o=t.slice(s+1),r="./";if(s=o.indexOf("/"),s>0)for(r="../";(s=o.indexOf("/",s+1))>-1&&(r+="../",!(r.length>100)););return r+n}function Ga(e,t){let i=0,s=null;if(!t||t.length==0)return e;if(!e||e.length==0)return t;if(e.startsWith("/"))return e;if(e.startsWith("./"))return i=t.lastIndexOf("/"),s=i<0?"":t.slice(0,i),s+"/"+e.slice(2);if(e.startsWith("../")){for(i=t.lastIndexOf("/"),s=i<0?"":t.slice(0,i);e.startsWith("../");)i=s.lastIndexOf("/"),s=i<0?"":s.slice(0,i),e=e.slice(3);return s+"/"+e}else return i=t.lastIndexOf("/"),s=i<0?"":t.slice(0,i),s+"/"+e}function Qt(e){this.userPath=e,this.url=null}Qt.prototype={absolute(e){const t=e.lastIndexOf("/");return this.userPath=t>=0?"."+e.slice(t):e,this.url=new URL(e),this},toJSON(){return this.userPath},equals(e){return this.url&&e.url&&this.url.href==e.url.href},sameDir(e){if(!this.url||!e.url)return!1;const t=this.url.href.lastIndexOf("/"),i=e.url.href.lastIndexOf("/");return this.url.href.slice(0,t)===e.url.href.slice(0,i)},getPath(){return this.userPath},getExt(){let e=this.userPath.lastIndexOf(".");return e<0?"":this.userPath.slice(e+1)},getName(){const e=this.userPath.lastIndexOf("/");if(e>0)return this.userPath.slice(e+1);const t=this.userPath.indexOf(":");return t>0?this.userPath.slice(0,t):this.userPath},getFullPath(){return this.url?this.url.pathname:this.userPath},setWSReference(e){},resolve(e){if(!this.url)return console.error(`cannot resolve ${e} - missing reference`),null;const t=new Qt(e);return t.url=new URL(e,this.url),t},resolve_dbg(e){const t=this.resolve(e);return console.log(`%cresolved: ${e} using ${this.userPath} to ${t.userPath}`,"background: #ff0; color: #00f"),t},makeRelative(e){let t=this.getFullPath(),i=e.getFullPath();this.userPath=an(t,i)},copy(){const e=new Qt(this.userPath);return e.url=this.url?new URL(this.url):null,e},validURL(){return this.url?!0:(console.error(`missing url ${this.path}`),!1)},async get(e="text"){return this.validURL()?Ha(this.url).then(async t=>t.headers.get("Content-Length")=="0"?null:e=="json"?await t.json():await t.text()):null},async save(e){return this.validURL()?Ba(this.url+"?action=save",e):null},async jsImport(){return this.validURL()?import(this.url):null}};function Is(e,t=null){this.userPath=e,this.handle=t,this.fullPath=null,this.fileTree=null}Is.prototype={absolute(){},toJSON(){return this.userPath},equals(e){return this.handle&&e.handle?this.handle==e.handle:this.fullPath&&e.fullPath?this.fullPath===e.fullPath:null},sameDir(e){return!1},getPath(){return this.userPath},getExt(){let e=this.userPath.lastIndexOf(".");return e<0?"":this.userPath.slice(e+1)},getName(){const e=this.userPath.lastIndexOf("/");if(e>0)return this.userPath.slice(e+1);const t=this.userPath.indexOf(":");return t>0?this.userPath.slice(0,t):this.userPath},setFileSystem(e,t){this.fileTree=e,this.fullPath=t},getFullPath(){return this.fullPath},resolve(e){var n;const t=((n=this.handle)==null?void 0:n.kind)!="directory"?this.fullPath:this.fullPath.at(-1)=="/"?this.fullPath+"x":this.fullPath+"/x",i=Ga(e,t),s=new Is(e);return s.setFileSystem(this.fileTree,i),s},makeRelative(e){let t=this.getFullPath(),i=e.getFullPath();this.userPath=an(t,i)},copy(){const e=new Is(this.userPath,this.handle);return e.fullPath=this.fullPath,e.fileTree=this.fileTree,e},validURL(){return this.handle?!0:(console.error(`missing handle for ${this.fullPath}`),!1)},async get(e="text"){let t;try{if(!this.handle){const s=await this.fileTree.findFile(this.fullPath);if(!s)return console.warn(`LALR.get(${this.fullPath}: file not found)`),null;this.handle=s.arl.handle}t=await this.handle.getFile()}catch(s){return console.error(`LALR.get(${this.fullPath}) failed: ${s}`),null}if(t.size===0)return null;const i=await t.text();return e==="json"?JSON.parse(i):i},async save(e){var n,o,r;const t=a=>{if(!a)return"";const l=a.endsWith("/")&&a!=="/"?a.slice(0,-1):a,c=l.lastIndexOf("/");return c<=0?"/":l.slice(0,c)},i=a=>{if(!a)return"";const l=a.endsWith("/")&&a!=="/"?a.slice(0,-1):a,c=l.lastIndexOf("/");return c<0?l:l.slice(c+1)},s=async(a,l)=>{if(!a)throw new Error("Missing root directory handle");const c=l.replace(/^\/*/,"/").split("/").filter(Boolean);let h=a;for(const u of c)h=await h.getDirectoryHandle(u,{create:!0});return h};try{if(!this.handle){const a=await((o=(n=this.fileTree)==null?void 0:n.findFile)==null?void 0:o.call(n,this.fullPath));if((r=a==null?void 0:a.arl)!=null&&r.handle)this.handle=a.arl.handle;else{const l=this.fileTree.getRoot().handle,c=t(this.fullPath),h=i(this.fullPath),u=await s(l,c);this.handle=await u.getFileHandle(h,{create:!0})}}try{await this.handle.getFile()}catch{const a=this.fileTree.getRoot().handle,l=t(this.fullPath),c=i(this.fullPath),h=await s(a,l);this.handle=await h.getFileHandle(c,{create:!0})}}catch(a){return console.error(`Unable to obtain/create handle for ${this.fullPath}:`,a),null}try{const a=await this.handle.createWritable();return await a.write(e),await a.close(),!0}catch(a){return console.error("Error saving local file:",a),null}},async jsImport(){return null}};function Mn(e){this.kind=e,this.root=null}Mn.prototype={collapse(){for(const e of this.root.folders)e.is.expanded=!1;this.root.is.expanded=!1},expand(){for(const e of this.root.folders)e.is.expanded=!0;this.root.is.expanded=!0}};function fs(e,t){this.name=e==null?void 0:e.getName(),this.parent=t,this.arl=e,this.files=[],this.folders=[],this.is={expanded:!1,stale:!0}}fs.prototype={toJSON(){return this.parent.parent.parent?" "+this.arl.userPath:this.is.expanded?"+"+this.arl.userPath:"-"+this.arl.userPath},async findFile(e){let t=e.lastIndexOf("/"),i=e.slice(t+1),s=t>0?e.slice(0,t):e,n=this;for(const r of s.split("/").filter(Boolean)){if(n=n.folders.find(a=>r===a.name),!n)return null;n.is.stale&&await n.update()}return n?(n.is.stale&&await n.update(),n.files.find(r=>i==r.name)):null},getRoot(){return this.parent?this.parent.getRoot():this.arl},getIcon(){return this.is.expanded?"folder_open":"folder"},getName(){return this.name},getFileSystem(){let e=this.parent;for(;e!=null&&e.parent;)e=e.parent;return e},checkName(e){return e.length<1?!1:Ua(e)?this.folders.find(t=>t.name===e)?!1:!this.files.find(t=>t.name===e):!1},getFileTreeAndPath(){let e=this;const t=[];for(;e.parent;)t.push(e.getName()),e=e.parent;const i="/"+t.reverse().join("/")+"/";return[e,i]},async update(){const e=this.getFileSystem();switch(e==null?void 0:e.kind){case"local":this.folders=[],this.files=[];for await(const t of this.arl.handle.values()){const i=this.arl.resolve(t.name);if(i.handle=t,t.kind=="directory"){const s=new fs(i,this);s.fsType=this.fsType,this.folders.push(s)}else if(t.kind=="file"){const s=new Gn(i,this);this.files.push(s)}}return;case"api":return;case"fixed":return;case"none":return}},ejectFolder(e){this.folders=this.folders.filter(t=>t!=e)},ejectFile(e){this.files=this.files.filter(t=>t!=e)}};function Gn(e,t){this.name=e==null?void 0:e.getName(),this.folder=t,this.arl=e,this.is={highLighted:!1}}Gn.prototype={getPath(){let e=this.folder.getPath();return e.at(-1)=="/"?e+this.name:e+"/"+this.name},getExt(){let e=this.name.lastIndexOf(".");return e<0?"any":this.name.slice(e+1)},getIcon(){const e=this.getExt();return e=="vmblu"||e=="nmsh"?"account_tree":e=="js"||e=="msj"?"electric_bolt":e=="json"?"data_object":e=="html"?"code":e=="css"?"tag":"description"},getFileClass(){const e=this.getExt();return e=="vmblu"?"vmblu-file":e=="nmsh"?"nmsh-file":e=="js"?"js-file":"other-file"},rename(e){e!==this.name&&this.folder.checkName(e)&&this.arl.rename(e).then(t=>{if(!t)return;const i=this.name;this.name=e,this.folder.getDrawer().update(),tx.send("file renamed",{oldName:i,newName:e})}).catch(t=>console.log(t))},confirmDelete(e){showMessage("Confirm delete file",`Delete file  ${this.name}  ?`,t=>this.remove())},remove(){var e;(e=this.arl)==null||e.remove().then(()=>{this.folder.ejectFile(this),this.folder.getDrawer().update(),tx.send("file deleted",this.arl)}).catch(t=>console.error(t))}};const Ya="5";var Uo;typeof window<"u"&&((Uo=window.__svelte??(window.__svelte={})).v??(Uo.v=new Set)).add(Ya);let Qi=!1,Xa=!1;function Ka(){Qi=!0}Ka();const ln=1,cn=2,er=4,Qa=8,Za=16,el=1,tl=2,il=4,sl=8,nl=16,ol=1,rl=2,Ee=Symbol(),al="http://www.w3.org/1999/xhtml",tr=!1;var ir=Array.isArray,ll=Array.prototype.indexOf,Yn=Array.from,sr=Object.defineProperty,mi=Object.getOwnPropertyDescriptor,nr=Object.getOwnPropertyDescriptors,cl=Object.prototype,hl=Array.prototype,Xn=Object.getPrototypeOf,ho=Object.isExtensible;const Hi=()=>{};function dl(e){return e()}function An(e){for(var t=0;t<e.length;t++)e[t]()}function or(){var e,t,i=new Promise((s,n)=>{e=s,t=n});return{promise:i,resolve:e,reject:t}}const Ae=2,hn=4,dn=8,Bt=16,$t=32,Li=64,un=128,mt=512,Se=1024,Je=2048,Ot=4096,Ze=8192,Zt=16384,Kn=32768,zi=65536,uo=1<<17,rr=1<<18,Zi=1<<19,ar=1<<20,ys=32768,Dn=1<<21,Qn=1<<22,ei=1<<23,vi=Symbol("$state"),ul=Symbol("legacy props"),fl=Symbol(""),Fi=new class extends Error{constructor(){super(...arguments);_t(this,"name","StaleReactionError");_t(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function pl(e){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function gl(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function ml(e){throw new Error("https://svelte.dev/e/effect_in_teardown")}function vl(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function wl(e){throw new Error("https://svelte.dev/e/effect_orphan")}function yl(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function xl(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function bl(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function kl(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function _l(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}function Tl(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}let Pl=!1;function lr(e){return e===this.v}function cr(e,t){return e!=e?t==t:e!==t||e!==null&&typeof e=="object"||typeof e=="function"}function hr(e){return!cr(e,this.v)}let ge=null;function qi(e){ge=e}function ae(e,t=!1,i){ge={p:ge,i:!1,c:null,e:null,s:e,x:null,l:Qi&&!t?{s:null,u:null,$:[]}:null}}function le(e){var t=ge,i=t.e;if(i!==null){t.e=null;for(var s of i)Nr(s)}return e!==void 0&&(t.x=e),t.i=!0,ge=t.p,e??{}}function Cs(){return!Qi||ge!==null&&ge.l===null}let ci=[];function dr(){var e=ci;ci=[],An(e)}function es(e){if(ci.length===0&&!ps){var t=ci;queueMicrotask(()=>{t===ci&&dr()})}ci.push(e)}function Sl(){for(;ci.length>0;)dr()}function ur(e){var t=ne;if(t===null)return Z.f|=ei,e;if((t.f&Kn)===0){if((t.f&un)===0)throw e;t.b.error(e)}else Ji(e,t)}function Ji(e,t){for(;t!==null;){if((t.f&un)!==0)try{t.b.error(e);return}catch(i){e=i}t=t.parent}throw e}const Ms=new Set;let ce=null,Fs=null,be=null,Ct=[],fn=null,On=!1,ps=!1;var $i,ji,hi,di,Ss,Vi,Ui,Me,In,ai,fr,pr;const nn=class nn{constructor(){se(this,Me);_t(this,"committed",!1);_t(this,"current",new Map);_t(this,"previous",new Map);se(this,$i,new Set);se(this,ji,new Set);se(this,hi,0);se(this,di,0);se(this,Ss,null);se(this,Vi,[]);se(this,Ui,[]);_t(this,"skipped_effects",new Set);_t(this,"is_fork",!1)}process(t){var s;Ct=[],Fs=null,this.apply();var i={parent:null,effect:null,effects:[],render_effects:[],block_effects:[]};for(const n of t)xe(this,Me,In).call(this,n,i);this.is_fork||xe(this,Me,fr).call(this),x(this,di)>0||this.is_fork?(xe(this,Me,ai).call(this,i.effects),xe(this,Me,ai).call(this,i.render_effects),xe(this,Me,ai).call(this,i.block_effects)):(Fs=this,ce=null,fo(i.render_effects),fo(i.effects),Fs=null,(s=x(this,Ss))==null||s.resolve()),be=null}capture(t,i){this.previous.has(t)||this.previous.set(t,i),(t.f&ei)===0&&(this.current.set(t,t.v),be==null||be.set(t,t.v))}activate(){ce=this,this.apply()}deactivate(){ce=null,be=null}flush(){if(this.activate(),Ct.length>0){if(gr(),ce!==null&&ce!==this)return}else x(this,hi)===0&&this.process([]);this.deactivate()}discard(){for(const t of x(this,ji))t(this);x(this,ji).clear()}increment(t){Y(this,hi,x(this,hi)+1),t&&Y(this,di,x(this,di)+1)}decrement(t){Y(this,hi,x(this,hi)-1),t&&Y(this,di,x(this,di)-1),this.revive()}revive(){for(const t of x(this,Vi))Le(t,Je),bi(t);for(const t of x(this,Ui))Le(t,Ot),bi(t);Y(this,Vi,[]),Y(this,Ui,[]),this.flush()}oncommit(t){x(this,$i).add(t)}ondiscard(t){x(this,ji).add(t)}settled(){return(x(this,Ss)??Y(this,Ss,or())).promise}static ensure(){if(ce===null){const t=ce=new nn;Ms.add(ce),ps||nn.enqueue(()=>{ce===t&&t.flush()})}return ce}static enqueue(t){es(t)}apply(){}};$i=new WeakMap,ji=new WeakMap,hi=new WeakMap,di=new WeakMap,Ss=new WeakMap,Vi=new WeakMap,Ui=new WeakMap,Me=new WeakSet,In=function(t,i){var h;t.f^=Se;for(var s=t.first;s!==null;){var n=s.f,o=(n&($t|Li))!==0,r=o&&(n&Se)!==0,a=r||(n&Ze)!==0||this.skipped_effects.has(s);if((s.f&un)!==0&&((h=s.b)!=null&&h.is_pending())&&(i={parent:i,effect:s,effects:[],render_effects:[],block_effects:[]}),!a&&s.fn!==null){o?s.f^=Se:(n&hn)!==0?i.effects.push(s):is(s)&&((s.f&Bt)!==0&&i.block_effects.push(s),Yi(s));var l=s.first;if(l!==null){s=l;continue}}var c=s.parent;for(s=s.next;s===null&&c!==null;)c===i.effect&&(xe(this,Me,ai).call(this,i.effects),xe(this,Me,ai).call(this,i.render_effects),xe(this,Me,ai).call(this,i.block_effects),i=i.parent),s=c.next,c=c.parent}},ai=function(t){for(const i of t)((i.f&Je)!==0?x(this,Vi):x(this,Ui)).push(i),Le(i,Se)},fr=function(){if(x(this,di)===0){for(const t of x(this,$i))t();x(this,$i).clear()}x(this,hi)===0&&xe(this,Me,pr).call(this)},pr=function(){var n;if(Ms.size>1){this.previous.clear();var t=be,i=!0,s={parent:null,effect:null,effects:[],render_effects:[],block_effects:[]};for(const o of Ms){if(o===this){i=!1;continue}const r=[];for(const[l,c]of this.current){if(o.current.has(l))if(i&&c!==o.current.get(l))o.current.set(l,c);else continue;r.push(l)}if(r.length===0)continue;const a=[...o.current.keys()].filter(l=>!this.current.has(l));if(a.length>0){const l=new Set,c=new Map;for(const h of r)mr(h,a,l,c);if(Ct.length>0){ce=o,o.apply();for(const h of Ct)xe(n=o,Me,In).call(n,h,s);Ct=[],o.deactivate()}}}ce=null,be=t}this.committed=!0,Ms.delete(this)};let Ht=nn;function Ll(e){var t=ps;ps=!0;try{for(var i;;){if(Sl(),Ct.length===0&&(ce==null||ce.flush(),Ct.length===0))return fn=null,i;gr()}}finally{ps=t}}function gr(){var e=wi;On=!0;try{var t=0;for(mo(!0);Ct.length>0;){var i=Ht.ensure();if(t++>1e3){var s,n;Nl()}i.process(Ct),ti.clear()}}finally{On=!1,mo(e),fn=null}}function Nl(){try{yl()}catch(e){Ji(e,fn)}}let ht=null;function fo(e){var t=e.length;if(t!==0){for(var i=0;i<t;){var s=e[i++];if((s.f&(Zt|Ze))===0&&is(s)&&(ht=new Set,Yi(s),s.deps===null&&s.first===null&&s.nodes_start===null&&(s.teardown===null&&s.ac===null?Mr(s):s.fn=null),(ht==null?void 0:ht.size)>0)){ti.clear();for(const n of ht){if((n.f&(Zt|Ze))!==0)continue;const o=[n];let r=n.parent;for(;r!==null;)ht.has(r)&&(ht.delete(r),o.push(r)),r=r.parent;for(let a=o.length-1;a>=0;a--){const l=o[a];(l.f&(Zt|Ze))===0&&Yi(l)}}ht.clear()}}ht=null}}function mr(e,t,i,s){if(!i.has(e)&&(i.add(e),e.reactions!==null))for(const n of e.reactions){const o=n.f;(o&Ae)!==0?mr(n,t,i,s):(o&(Qn|Bt))!==0&&(o&Je)===0&&vr(n,t,s)&&(Le(n,Je),bi(n))}}function vr(e,t,i){const s=i.get(e);if(s!==void 0)return s;if(e.deps!==null)for(const n of e.deps){if(t.includes(n))return!0;if((n.f&Ae)!==0&&vr(n,t,i))return i.set(n,!0),!0}return i.set(e,!1),!1}function bi(e){for(var t=fn=e;t.parent!==null;){t=t.parent;var i=t.f;if(On&&t===ne&&(i&Bt)!==0&&(i&rr)===0)return;if((i&(Li|$t))!==0){if((i&Se)===0)return;t.f^=Se}}Ct.push(t)}function Cl(e){let t=0,i=ki(0),s;return()=>{mn()&&(d(i),ts(()=>(t===0&&(s=C(()=>e(()=>gs(i)))),t+=1,()=>{es(()=>{t-=1,t===0&&(s==null||s(),s=void 0,gs(i))})})))}}var Rl=zi|Zi|un;function El(e,t,i){new Ml(e,t,i)}var st,nt,Jn,Pt,ui,St,ot,ze,Lt,Wt,Gt,fi,Yt,pi,Xt,on,Pe,Al,Dl,Fn,Ws,Hs,Wn;class Ml{constructor(t,i,s){se(this,Pe);_t(this,"parent");se(this,st,!1);se(this,nt);se(this,Jn,null);se(this,Pt);se(this,ui);se(this,St);se(this,ot,null);se(this,ze,null);se(this,Lt,null);se(this,Wt,null);se(this,Gt,null);se(this,fi,0);se(this,Yt,0);se(this,pi,!1);se(this,Xt,null);se(this,on,Cl(()=>(Y(this,Xt,ki(x(this,fi))),()=>{Y(this,Xt,null)})));Y(this,nt,t),Y(this,Pt,i),Y(this,ui,s),this.parent=ne.b,Y(this,st,!!x(this,Pt).pending),Y(this,St,to(()=>{ne.b=this;{var n=xe(this,Pe,Fn).call(this);try{Y(this,ot,ut(()=>s(n)))}catch(o){this.error(o)}x(this,Yt)>0?xe(this,Pe,Hs).call(this):Y(this,st,!1)}return()=>{var o;(o=x(this,Gt))==null||o.remove()}},Rl))}is_pending(){return x(this,st)||!!this.parent&&this.parent.is_pending()}has_pending_snippet(){return!!x(this,Pt).pending}update_pending_count(t){xe(this,Pe,Wn).call(this,t),Y(this,fi,x(this,fi)+t),x(this,Xt)&&Gi(x(this,Xt),x(this,fi))}get_effect_pending(){return x(this,on).call(this),d(x(this,Xt))}error(t){var i=x(this,Pt).onerror;let s=x(this,Pt).failed;if(x(this,pi)||!i&&!s)throw t;x(this,ot)&&($e(x(this,ot)),Y(this,ot,null)),x(this,ze)&&($e(x(this,ze)),Y(this,ze,null)),x(this,Lt)&&($e(x(this,Lt)),Y(this,Lt,null));var n=!1,o=!1;const r=()=>{if(n){Tl();return}n=!0,o&&_l(),Ht.ensure(),Y(this,fi,0),x(this,Lt)!==null&&Bi(x(this,Lt),()=>{Y(this,Lt,null)}),Y(this,st,this.has_pending_snippet()),Y(this,ot,xe(this,Pe,Ws).call(this,()=>(Y(this,pi,!1),ut(()=>x(this,ui).call(this,x(this,nt)))))),x(this,Yt)>0?xe(this,Pe,Hs).call(this):Y(this,st,!1)};var a=Z;try{qe(null),o=!0,i==null||i(t,r),o=!1}catch(l){Ji(l,x(this,St)&&x(this,St).parent)}finally{qe(a)}s&&es(()=>{Y(this,Lt,xe(this,Pe,Ws).call(this,()=>{Ht.ensure(),Y(this,pi,!0);try{return ut(()=>{s(x(this,nt),()=>t,()=>r)})}catch(l){return Ji(l,x(this,St).parent),null}finally{Y(this,pi,!1)}}))})}}st=new WeakMap,nt=new WeakMap,Jn=new WeakMap,Pt=new WeakMap,ui=new WeakMap,St=new WeakMap,ot=new WeakMap,ze=new WeakMap,Lt=new WeakMap,Wt=new WeakMap,Gt=new WeakMap,fi=new WeakMap,Yt=new WeakMap,pi=new WeakMap,Xt=new WeakMap,on=new WeakMap,Pe=new WeakSet,Al=function(){try{Y(this,ot,ut(()=>x(this,ui).call(this,x(this,nt))))}catch(t){this.error(t)}Y(this,st,!1)},Dl=function(){const t=x(this,Pt).pending;t&&(Y(this,ze,ut(()=>t(x(this,nt)))),Ht.enqueue(()=>{var i=xe(this,Pe,Fn).call(this);Y(this,ot,xe(this,Pe,Ws).call(this,()=>(Ht.ensure(),ut(()=>x(this,ui).call(this,i))))),x(this,Yt)>0?xe(this,Pe,Hs).call(this):(Bi(x(this,ze),()=>{Y(this,ze,null)}),Y(this,st,!1))}))},Fn=function(){var t=x(this,nt);return x(this,st)&&(Y(this,Gt,_i()),x(this,nt).before(x(this,Gt)),t=x(this,Gt)),t},Ws=function(t){var i=ne,s=Z,n=ge;Et(x(this,St)),qe(x(this,St)),qi(x(this,St).ctx);try{return t()}catch(o){return ur(o),null}finally{Et(i),qe(s),qi(n)}},Hs=function(){const t=x(this,Pt).pending;x(this,ot)!==null&&(Y(this,Wt,document.createDocumentFragment()),x(this,Wt).append(x(this,Gt)),Or(x(this,ot),x(this,Wt))),x(this,ze)===null&&Y(this,ze,ut(()=>t(x(this,nt))))},Wn=function(t){var i;if(!this.has_pending_snippet()){this.parent&&xe(i=this.parent,Pe,Wn).call(i,t);return}Y(this,Yt,x(this,Yt)+t),x(this,Yt)===0&&(Y(this,st,!1),x(this,ze)&&Bi(x(this,ze),()=>{Y(this,ze,null)}),x(this,Wt)&&(x(this,nt).before(x(this,Wt)),Y(this,Wt,null)))};function Ol(e,t,i,s){const n=Cs()?pn:Zn;if(i.length===0&&e.length===0){s(t.map(n));return}var o=ce,r=ne,a=Il();function l(){Promise.all(i.map(c=>Fl(c))).then(c=>{a();try{s([...t.map(n),...c])}catch(h){(r.f&Zt)===0&&Ji(h,r)}o==null||o.deactivate(),zs()}).catch(c=>{Ji(c,r)})}e.length>0?Promise.all(e).then(()=>{a();try{return l()}finally{o==null||o.deactivate(),zs()}}):l()}function Il(){var e=ne,t=Z,i=ge,s=ce;return function(o=!0){Et(e),qe(t),qi(i),o&&(s==null||s.activate())}}function zs(){Et(null),qe(null),qi(null)}function pn(e){var t=Ae|Je,i=Z!==null&&(Z.f&Ae)!==0?Z:null;return ne!==null&&(ne.f|=Zi),{ctx:ge,deps:null,effects:null,equals:lr,f:t,fn:e,reactions:null,rv:0,v:Ee,wv:0,parent:i??ne,ac:null}}function Fl(e,t){let i=ne;i===null&&gl();var s=i.b,n=void 0,o=ki(Ee),r=!Z,a=new Map;return Yl(()=>{var m;var l=or();n=l.promise;try{Promise.resolve(e()).then(l.resolve,l.reject).then(()=>{c===ce&&c.committed&&c.deactivate(),zs()})}catch(v){l.reject(v),zs()}var c=ce;if(r){var h=!s.is_pending();s.update_pending_count(1),c.increment(h),(m=a.get(c))==null||m.reject(Fi),a.delete(c),a.set(c,l)}const u=(v,w=void 0)=>{if(c.activate(),w)w!==Fi&&(o.f|=ei,Gi(o,w));else{(o.f&ei)!==0&&(o.f^=ei),Gi(o,v);for(const[y,b]of a){if(a.delete(y),y===c)break;b.reject(Fi)}}r&&(s.update_pending_count(-1),c.decrement(h))};l.promise.then(u,v=>u(null,v||"unknown"))}),vn(()=>{for(const l of a.values())l.reject(Fi)}),new Promise(l=>{function c(h){function u(){h===n?l(o):c(n)}h.then(u,u)}c(n)})}function Zn(e){const t=pn(e);return t.equals=hr,t}function wr(e){var t=e.effects;if(t!==null){e.effects=null;for(var i=0;i<t.length;i+=1)$e(t[i])}}function Wl(e){for(var t=e.parent;t!==null;){if((t.f&Ae)===0)return t;t=t.parent}return null}function eo(e){var t,i=ne;Et(Wl(e));try{e.f&=~ys,wr(e),t=Hr(e)}finally{Et(i)}return t}function yr(e){var t=eo(e);if(e.equals(t)||(e.v=t,e.wv=Fr()),!Ni)if(be!==null)mn()&&be.set(e,e.v);else{var i=(e.f&mt)===0?Ot:Se;Le(e,i)}}let Hn=new Set;const ti=new Map;let xr=!1;function ki(e,t){var i={f:0,v:e,reactions:null,equals:lr,rv:0,wv:0};return i}function Jt(e,t){const i=ki(e);return Kl(i),i}function z(e,t=!1,i=!0){var n;const s=ki(e);return t||(s.equals=hr),Qi&&i&&ge!==null&&ge.l!==null&&((n=ge.l).s??(n.s=[])).push(s),s}function j(e,t){return I(e,C(()=>d(e))),t}function I(e,t,i=!1){Z!==null&&(!Rt||(Z.f&uo)!==0)&&Cs()&&(Z.f&(Ae|Bt|Qn|uo))!==0&&!(je!=null&&je.includes(e))&&kl();let s=i?Wi(t):t;return Gi(e,s)}function Gi(e,t){if(!e.equals(t)){var i=e.v;Ni?ti.set(e,t):ti.set(e,i),e.v=t;var s=Ht.ensure();s.capture(e,i),(e.f&Ae)!==0&&((e.f&Je)!==0&&eo(e),Le(e,(e.f&mt)!==0?Se:Ot)),e.wv=Fr(),br(e,Je),Cs()&&ne!==null&&(ne.f&Se)!==0&&(ne.f&($t|Li))===0&&(it===null?Ql([e]):it.push(e)),!s.is_fork&&Hn.size>0&&!xr&&Hl()}return t}function Hl(){xr=!1;const e=Array.from(Hn);for(const t of e)(t.f&Se)!==0&&Le(t,Ot),is(t)&&Yi(t);Hn.clear()}function gs(e){I(e,e.v+1)}function br(e,t){var i=e.reactions;if(i!==null)for(var s=Cs(),n=i.length,o=0;o<n;o++){var r=i[o],a=r.f;if(!(!s&&r===ne)){var l=(a&Je)===0;if(l&&Le(r,t),(a&Ae)!==0){var c=r;be==null||be.delete(c),(a&ys)===0&&(a&mt&&(r.f|=ys),br(c,Ot))}else l&&((a&Bt)!==0&&ht!==null&&ht.add(r),bi(r))}}}function Wi(e){if(typeof e!="object"||e===null||vi in e)return e;const t=Xn(e);if(t!==cl&&t!==hl)return e;var i=new Map,s=ir(e),n=Jt(0),o=yi,r=a=>{if(yi===o)return a();var l=Z,c=yi;qe(null),wo(o);var h=a();return qe(l),wo(c),h};return s&&i.set("length",Jt(e.length)),new Proxy(e,{defineProperty(a,l,c){(!("value"in c)||c.configurable===!1||c.enumerable===!1||c.writable===!1)&&xl();var h=i.get(l);return h===void 0?h=r(()=>{var u=Jt(c.value);return i.set(l,u),u}):I(h,c.value,!0),!0},deleteProperty(a,l){var c=i.get(l);if(c===void 0){if(l in a){const h=r(()=>Jt(Ee));i.set(l,h),gs(n)}}else I(c,Ee),gs(n);return!0},get(a,l,c){var v;if(l===vi)return e;var h=i.get(l),u=l in a;if(h===void 0&&(!u||(v=mi(a,l))!=null&&v.writable)&&(h=r(()=>{var w=Wi(u?a[l]:Ee),y=Jt(w);return y}),i.set(l,h)),h!==void 0){var m=d(h);return m===Ee?void 0:m}return Reflect.get(a,l,c)},getOwnPropertyDescriptor(a,l){var c=Reflect.getOwnPropertyDescriptor(a,l);if(c&&"value"in c){var h=i.get(l);h&&(c.value=d(h))}else if(c===void 0){var u=i.get(l),m=u==null?void 0:u.v;if(u!==void 0&&m!==Ee)return{enumerable:!0,configurable:!0,value:m,writable:!0}}return c},has(a,l){var m;if(l===vi)return!0;var c=i.get(l),h=c!==void 0&&c.v!==Ee||Reflect.has(a,l);if(c!==void 0||ne!==null&&(!h||(m=mi(a,l))!=null&&m.writable)){c===void 0&&(c=r(()=>{var v=h?Wi(a[l]):Ee,w=Jt(v);return w}),i.set(l,c));var u=d(c);if(u===Ee)return!1}return h},set(a,l,c,h){var W;var u=i.get(l),m=l in a;if(s&&l==="length")for(var v=c;v<u.v;v+=1){var w=i.get(v+"");w!==void 0?I(w,Ee):v in a&&(w=r(()=>Jt(Ee)),i.set(v+"",w))}if(u===void 0)(!m||(W=mi(a,l))!=null&&W.writable)&&(u=r(()=>Jt(void 0)),I(u,Wi(c)),i.set(l,u));else{m=u.v!==Ee;var y=r(()=>Wi(c));I(u,y)}var b=Reflect.getOwnPropertyDescriptor(a,l);if(b!=null&&b.set&&b.set.call(h,c),!m){if(s&&typeof l=="string"){var N=i.get("length"),L=Number(l);Number.isInteger(L)&&L>=N.v&&I(N,L+1)}gs(n)}return!0},ownKeys(a){d(n);var l=Reflect.ownKeys(a).filter(u=>{var m=i.get(u);return m===void 0||m.v!==Ee});for(var[c,h]of i)h.v!==Ee&&!(c in a)&&l.push(c);return l},setPrototypeOf(){bl()}})}var po,kr,_r,Tr;function Bl(){if(po===void 0){po=window,kr=/Firefox/.test(navigator.userAgent);var e=Element.prototype,t=Node.prototype,i=Text.prototype;_r=mi(t,"firstChild").get,Tr=mi(t,"nextSibling").get,ho(e)&&(e.__click=void 0,e.__className=void 0,e.__attributes=null,e.__style=void 0,e.__e=void 0),ho(i)&&(i.__t=void 0)}}function _i(e=""){return document.createTextNode(e)}function Kt(e){return _r.call(e)}function Rs(e){return Tr.call(e)}function R(e,t){return Kt(e)}function he(e,t=!1){{var i=Kt(e);return i instanceof Comment&&i.data===""?Rs(i):i}}function B(e,t=1,i=!1){let s=e;for(;t--;)s=Rs(s);return s}function $l(e){e.textContent=""}function Pr(){return!1}let go=!1;function jl(){go||(go=!0,document.addEventListener("reset",e=>{Promise.resolve().then(()=>{var t;if(!e.defaultPrevented)for(const i of e.target.elements)(t=i.__on_r)==null||t.call(i)})},{capture:!0}))}function gn(e){var t=Z,i=ne;qe(null),Et(null);try{return e()}finally{qe(t),Et(i)}}function Sr(e,t,i,s=i){e.addEventListener(t,()=>gn(i));const n=e.__on_r;n?e.__on_r=()=>{n(),s(!0)}:e.__on_r=()=>s(!0),jl()}function Lr(e){ne===null&&(Z===null&&wl(),vl()),Ni&&ml()}function Vl(e,t){var i=t.last;i===null?t.last=t.first=e:(i.next=e,e.prev=i,t.last=e)}function It(e,t,i,s=!0){var n=ne;n!==null&&(n.f&Ze)!==0&&(e|=Ze);var o={ctx:ge,deps:null,nodes_start:null,nodes_end:null,f:e|Je|mt,first:null,fn:t,last:null,next:null,parent:n,b:n&&n.b,prev:null,teardown:null,transitions:null,wv:0,ac:null};if(i)try{Yi(o),o.f|=Kn}catch(l){throw $e(o),l}else t!==null&&bi(o);if(s){var r=o;if(i&&r.deps===null&&r.teardown===null&&r.nodes_start===null&&r.first===r.last&&(r.f&Zi)===0&&(r=r.first,(e&Bt)!==0&&(e&zi)!==0&&r!==null&&(r.f|=zi)),r!==null&&(r.parent=n,n!==null&&Vl(r,n),Z!==null&&(Z.f&Ae)!==0&&(e&Li)===0)){var a=Z;(a.effects??(a.effects=[])).push(r)}}return o}function mn(){return Z!==null&&!Rt}function vn(e){const t=It(dn,null,!1);return Le(t,Se),t.teardown=e,t}function Bn(e){Lr();var t=ne.f,i=!Z&&(t&$t)!==0&&(t&Kn)===0;if(i){var s=ge;(s.e??(s.e=[])).push(e)}else return Nr(e)}function Nr(e){return It(hn|ar,e,!1)}function Ul(e){return Lr(),It(dn|ar,e,!0)}function zl(e){Ht.ensure();const t=It(Li|Zi,e,!0);return(i={})=>new Promise(s=>{i.outro?Bi(t,()=>{$e(t),s(void 0)}):($e(t),s(void 0))})}function ql(e){return It(hn,e,!1)}function Jl(e,t){var i=ge,s={effect:null,ran:!1,deps:e};i.l.$.push(s),s.effect=ts(()=>{e(),!s.ran&&(s.ran=!0,C(t))})}function Gl(){var e=ge;ts(()=>{for(var t of e.l.$){t.deps();var i=t.effect;(i.f&Se)!==0&&Le(i,Ot),is(i)&&Yi(i),t.ran=!1}})}function Yl(e){return It(Qn|Zi,e,!0)}function ts(e,t=0){return It(dn|t,e,!0)}function oe(e,t=[],i=[],s=[],n=!1){Ol(s,t,i,o=>{It(n?hn:dn,()=>e(...o.map(d)),!0)})}function to(e,t=0){var i=It(Bt|t,e,!0);return i}function ut(e,t=!0){return It($t|Zi,e,!0,t)}function Cr(e){var t=e.teardown;if(t!==null){const i=Ni,s=Z;vo(!0),qe(null);try{t.call(null)}finally{vo(i),qe(s)}}}function Rr(e,t=!1){var i=e.first;for(e.first=e.last=null;i!==null;){const n=i.ac;n!==null&&gn(()=>{n.abort(Fi)});var s=i.next;(i.f&Li)!==0?i.parent=null:$e(i,t),i=s}}function Xl(e){for(var t=e.first;t!==null;){var i=t.next;(t.f&$t)===0&&$e(t),t=i}}function $e(e,t=!0){var i=!1;(t||(e.f&rr)!==0)&&e.nodes_start!==null&&e.nodes_end!==null&&(Er(e.nodes_start,e.nodes_end),i=!0),Rr(e,t&&!i),qs(e,0),Le(e,Zt);var s=e.transitions;if(s!==null)for(const o of s)o.stop();Cr(e);var n=e.parent;n!==null&&n.first!==null&&Mr(e),e.next=e.prev=e.teardown=e.ctx=e.deps=e.fn=e.nodes_start=e.nodes_end=e.ac=null}function Er(e,t){for(;e!==null;){var i=e===t?null:Rs(e);e.remove(),e=i}}function Mr(e){var t=e.parent,i=e.prev,s=e.next;i!==null&&(i.next=s),s!==null&&(s.prev=i),t!==null&&(t.first===e&&(t.first=s),t.last===e&&(t.last=i))}function Bi(e,t,i=!0){var s=[];io(e,s,!0),Ar(s,()=>{i&&$e(e),t&&t()})}function Ar(e,t){var i=e.length;if(i>0){var s=()=>--i||t();for(var n of e)n.out(s)}else t()}function io(e,t,i){if((e.f&Ze)===0){if(e.f^=Ze,e.transitions!==null)for(const r of e.transitions)(r.is_global||i)&&t.push(r);for(var s=e.first;s!==null;){var n=s.next,o=(s.f&zi)!==0||(s.f&$t)!==0&&(e.f&Bt)!==0;io(s,t,o?i:!1),s=n}}}function so(e){Dr(e,!0)}function Dr(e,t){if((e.f&Ze)!==0){e.f^=Ze,(e.f&Se)===0&&(Le(e,Je),bi(e));for(var i=e.first;i!==null;){var s=i.next,n=(i.f&zi)!==0||(i.f&$t)!==0;Dr(i,n?t:!1),i=s}if(e.transitions!==null)for(const o of e.transitions)(o.is_global||t)&&o.in()}}function Or(e,t){for(var i=e.nodes_start,s=e.nodes_end;i!==null;){var n=i===s?null:Rs(i);t.append(i),i=n}}let wi=!1;function mo(e){wi=e}let Ni=!1;function vo(e){Ni=e}let Z=null,Rt=!1;function qe(e){Z=e}let ne=null;function Et(e){ne=e}let je=null;function Kl(e){Z!==null&&(je===null?je=[e]:je.push(e))}let Be=null,Xe=0,it=null;function Ql(e){it=e}let Ir=1,xs=0,yi=xs;function wo(e){yi=e}function Fr(){return++Ir}function is(e){var t=e.f;if((t&Je)!==0)return!0;if(t&Ae&&(e.f&=~ys),(t&Ot)!==0){var i=e.deps;if(i!==null)for(var s=i.length,n=0;n<s;n++){var o=i[n];if(is(o)&&yr(o),o.wv>e.wv)return!0}(t&mt)!==0&&be===null&&Le(e,Se)}return!1}function Wr(e,t,i=!0){var s=e.reactions;if(s!==null&&!(je!=null&&je.includes(e)))for(var n=0;n<s.length;n++){var o=s[n];(o.f&Ae)!==0?Wr(o,t,!1):t===o&&(i?Le(o,Je):(o.f&Se)!==0&&Le(o,Ot),bi(o))}}function Hr(e){var w;var t=Be,i=Xe,s=it,n=Z,o=je,r=ge,a=Rt,l=yi,c=e.f;Be=null,Xe=0,it=null,Z=(c&($t|Li))===0?e:null,je=null,qi(e.ctx),Rt=!1,yi=++xs,e.ac!==null&&(gn(()=>{e.ac.abort(Fi)}),e.ac=null);try{e.f|=Dn;var h=e.fn,u=h(),m=e.deps;if(Be!==null){var v;if(qs(e,Xe),m!==null&&Xe>0)for(m.length=Xe+Be.length,v=0;v<Be.length;v++)m[Xe+v]=Be[v];else e.deps=m=Be;if(wi&&mn()&&(e.f&mt)!==0)for(v=Xe;v<m.length;v++)((w=m[v]).reactions??(w.reactions=[])).push(e)}else m!==null&&Xe<m.length&&(qs(e,Xe),m.length=Xe);if(Cs()&&it!==null&&!Rt&&m!==null&&(e.f&(Ae|Ot|Je))===0)for(v=0;v<it.length;v++)Wr(it[v],e);return n!==null&&n!==e&&(xs++,it!==null&&(s===null?s=it:s.push(...it))),(e.f&ei)!==0&&(e.f^=ei),u}catch(y){return ur(y)}finally{e.f^=Dn,Be=t,Xe=i,it=s,Z=n,je=o,qi(r),Rt=a,yi=l}}function Zl(e,t){let i=t.reactions;if(i!==null){var s=ll.call(i,e);if(s!==-1){var n=i.length-1;n===0?i=t.reactions=null:(i[s]=i[n],i.pop())}}i===null&&(t.f&Ae)!==0&&(Be===null||!Be.includes(t))&&(Le(t,Ot),(t.f&mt)!==0&&(t.f^=mt,t.f&=~ys),wr(t),qs(t,0))}function qs(e,t){var i=e.deps;if(i!==null)for(var s=t;s<i.length;s++)Zl(e,i[s])}function Yi(e){var t=e.f;if((t&Zt)===0){Le(e,Se);var i=ne,s=wi;ne=e,wi=!0;try{(t&Bt)!==0?Xl(e):Rr(e),Cr(e);var n=Hr(e);e.teardown=typeof n=="function"?n:null,e.wv=Ir;var o;tr&&Xa&&(e.f&Je)!==0&&e.deps}finally{wi=s,ne=i}}}async function ec(){await Promise.resolve(),Ll()}function d(e){var t=e.f,i=(t&Ae)!==0;if(Z!==null&&!Rt){var s=ne!==null&&(ne.f&Zt)!==0;if(!s&&!(je!=null&&je.includes(e))){var n=Z.deps;if((Z.f&Dn)!==0)e.rv<xs&&(e.rv=xs,Be===null&&n!==null&&n[Xe]===e?Xe++:Be===null?Be=[e]:Be.includes(e)||Be.push(e));else{(Z.deps??(Z.deps=[])).push(e);var o=e.reactions;o===null?e.reactions=[Z]:o.includes(Z)||o.push(Z)}}}if(Ni){if(ti.has(e))return ti.get(e);if(i){var r=e,a=r.v;return((r.f&Se)===0&&r.reactions!==null||$r(r))&&(a=eo(r)),ti.set(r,a),a}}else if(i){if(r=e,be!=null&&be.has(r))return be.get(r);is(r)&&yr(r),wi&&mn()&&(r.f&mt)===0&&Br(r)}else if(be!=null&&be.has(e))return be.get(e);if((e.f&ei)!==0)throw e.v;return e.v}function Br(e){if(e.deps!==null){e.f^=mt;for(const t of e.deps)(t.reactions??(t.reactions=[])).push(e),(t.f&Ae)!==0&&(t.f&mt)===0&&Br(t)}}function $r(e){if(e.v===Ee)return!0;if(e.deps===null)return!1;for(const t of e.deps)if(ti.has(t)||(t.f&Ae)!==0&&$r(t))return!0;return!1}function C(e){var t=Rt;try{return Rt=!0,e()}finally{Rt=t}}const tc=-7169;function Le(e,t){e.f=e.f&tc|t}function we(e){if(!(typeof e!="object"||!e||e instanceof EventTarget)){if(vi in e)$n(e);else if(!Array.isArray(e))for(let t in e){const i=e[t];typeof i=="object"&&i&&vi in i&&$n(i)}}}function $n(e,t=new Set){if(typeof e=="object"&&e!==null&&!(e instanceof EventTarget)&&!t.has(e)){t.add(e),e instanceof Date&&e.getTime();for(let s in e)try{$n(e[s],t)}catch{}const i=Xn(e);if(i!==Object.prototype&&i!==Array.prototype&&i!==Map.prototype&&i!==Set.prototype&&i!==Date.prototype){const s=nr(i);for(let n in s){const o=s[n].get;if(o)try{o.call(e)}catch{}}}}}const ic=new Set,yo=new Set;function sc(e,t,i,s={}){function n(o){if(s.capture||ds.call(t,o),!o.cancelBubble)return gn(()=>i==null?void 0:i.call(this,o))}return e.startsWith("pointer")||e.startsWith("touch")||e==="wheel"?es(()=>{t.addEventListener(e,n,s)}):t.addEventListener(e,n,s),n}function P(e,t,i,s,n){var o={capture:s,passive:n},r=sc(e,t,i,o);(t===document.body||t===window||t===document||t instanceof HTMLMediaElement)&&vn(()=>{t.removeEventListener(e,r,o)})}let xo=null;function ds(e){var b;var t=this,i=t.ownerDocument,s=e.type,n=((b=e.composedPath)==null?void 0:b.call(e))||[],o=n[0]||e.target;xo=e;var r=0,a=xo===e&&e.__root;if(a){var l=n.indexOf(a);if(l!==-1&&(t===document||t===window)){e.__root=t;return}var c=n.indexOf(t);if(c===-1)return;l<=c&&(r=l)}if(o=n[r]||e.target,o!==t){sr(e,"currentTarget",{configurable:!0,get(){return o||i}});var h=Z,u=ne;qe(null),Et(null);try{for(var m,v=[];o!==null;){var w=o.assignedSlot||o.parentNode||o.host||null;try{var y=o["__"+s];y!=null&&(!o.disabled||e.target===o)&&y.call(o,e)}catch(N){m?v.push(N):m=N}if(e.cancelBubble||w===t||w===null)break;o=w}if(m){for(let N of v)queueMicrotask(()=>{throw N});throw m}}finally{e.__root=t,delete e.currentTarget,qe(h),Et(u)}}}function jr(e){var t=document.createElement("template");return t.innerHTML=e.replaceAll("<!>","<!---->"),t.content}function Js(e,t){var i=ne;i.nodes_start===null&&(i.nodes_start=e,i.nodes_end=t)}function V(e,t){var i=(t&ol)!==0,s=(t&rl)!==0,n,o=!e.startsWith("<!>");return()=>{n===void 0&&(n=jr(o?e:"<!>"+e),i||(n=Kt(n)));var r=s||kr?document.importNode(n,!0):n.cloneNode(!0);if(i){var a=Kt(r),l=r.lastChild;Js(a,l)}else Js(r,r);return r}}function Qe(){var e=document.createDocumentFragment(),t=document.createComment(""),i=_i();return e.append(t,i),Js(t,i),e}function O(e,t){e!==null&&e.before(t)}const nc=["touchstart","touchmove"];function oc(e){return nc.includes(e)}function K(e,t){var i=t==null?"":typeof t=="object"?t+"":t;i!==(e.__t??(e.__t=e.nodeValue))&&(e.__t=i,e.nodeValue=i+"")}function Vr(e,t){return rc(e,t)}const Ai=new Map;function rc(e,{target:t,anchor:i,props:s={},events:n,context:o,intro:r=!0}){Bl();var a=new Set,l=u=>{for(var m=0;m<u.length;m++){var v=u[m];if(!a.has(v)){a.add(v);var w=oc(v);t.addEventListener(v,ds,{passive:w});var y=Ai.get(v);y===void 0?(document.addEventListener(v,ds,{passive:w}),Ai.set(v,1)):Ai.set(v,y+1)}}};l(Yn(ic)),yo.add(l);var c=void 0,h=zl(()=>{var u=i??t.appendChild(_i());return El(u,{pending:()=>{}},m=>{if(o){ae({});var v=ge;v.c=o}n&&(s.$$events=n),c=e(m,s)||{},o&&le()}),()=>{var w;for(var m of a){t.removeEventListener(m,ds);var v=Ai.get(m);--v===0?(document.removeEventListener(m,ds),Ai.delete(m)):Ai.set(m,v)}yo.delete(l),u!==i&&((w=u.parentNode)==null||w.removeChild(u))}});return ac.set(c,h),c}let ac=new WeakMap;var dt,Nt,Ke,Ls,Ns,rn;class lc{constructor(t,i=!0){_t(this,"anchor");se(this,dt,new Map);se(this,Nt,new Map);se(this,Ke,new Map);se(this,Ls,!0);se(this,Ns,()=>{var t=ce;if(x(this,dt).has(t)){var i=x(this,dt).get(t),s=x(this,Nt).get(i);if(s)so(s);else{var n=x(this,Ke).get(i);n&&(x(this,Nt).set(i,n.effect),x(this,Ke).delete(i),n.fragment.lastChild.remove(),this.anchor.before(n.fragment),s=n.effect)}for(const[o,r]of x(this,dt)){if(x(this,dt).delete(o),o===t)break;const a=x(this,Ke).get(r);a&&($e(a.effect),x(this,Ke).delete(r))}for(const[o,r]of x(this,Nt)){if(o===i)continue;const a=()=>{if(Array.from(x(this,dt).values()).includes(o)){var c=document.createDocumentFragment();Or(r,c),c.append(_i()),x(this,Ke).set(o,{effect:r,fragment:c})}else $e(r);x(this,Nt).delete(o)};x(this,Ls)||!s?Bi(r,a,!1):a()}}});se(this,rn,t=>{x(this,dt).delete(t);const i=Array.from(x(this,dt).values());for(const[s,n]of x(this,Ke))i.includes(s)||($e(n.effect),x(this,Ke).delete(s))});this.anchor=t,Y(this,Ls,i)}ensure(t,i){var s=ce,n=Pr();if(i&&!x(this,Nt).has(t)&&!x(this,Ke).has(t))if(n){var o=document.createDocumentFragment(),r=_i();o.append(r),x(this,Ke).set(t,{effect:ut(()=>i(r)),fragment:o})}else x(this,Nt).set(t,ut(()=>i(this.anchor)));if(x(this,dt).set(s,t),n){for(const[a,l]of x(this,Nt))a===t?s.skipped_effects.delete(l):s.skipped_effects.add(l);for(const[a,l]of x(this,Ke))a===t?s.skipped_effects.delete(l.effect):s.skipped_effects.add(l.effect);s.oncommit(x(this,Ns)),s.ondiscard(x(this,rn))}else x(this,Ns).call(this)}}dt=new WeakMap,Nt=new WeakMap,Ke=new WeakMap,Ls=new WeakMap,Ns=new WeakMap,rn=new WeakMap;function fe(e){ge===null&&pl(),Qi&&ge.l!==null?cc(ge).m.push(e):Bn(()=>{const t=C(e);if(typeof t=="function")return t})}function cc(e){var t=e.l;return t.u??(t.u={a:[],b:[],m:[]})}function ue(e,t,i=!1){var s=new lc(e),n=i?zi:0;function o(r,a){s.ensure(r,a)}to(()=>{var r=!1;t((a,l=!0)=>{r=!0,o(l,a)}),r||o(!1,null)},n)}function pt(e,t){return t}function hc(e,t,i){for(var s=e.items,n=[],o=t.length,r=0;r<o;r++)io(t[r].e,n,!0);var a=o>0&&n.length===0&&i!==null;if(a){var l=i.parentNode;$l(l),l.append(i),s.clear(),Tt(e,t[0].prev,t[o-1].next)}Ar(n,()=>{for(var c=0;c<o;c++){var h=t[c];a||(s.delete(h.k),Tt(e,h.prev,h.next)),$e(h.e,!a)}})}function gt(e,t,i,s,n,o=null){var r=e,a={flags:t,items:new Map,first:null},l=(t&er)!==0;if(l){var c=e;r=c.appendChild(_i())}var h=null,u=!1,m=new Map,v=Zn(()=>{var N=i();return ir(N)?N:N==null?[]:Yn(N)}),w,y;function b(){dc(y,w,a,m,r,n,t,s,i),o!==null&&(w.length===0?h?so(h):h=ut(()=>o(r)):h!==null&&Bi(h,()=>{h=null}))}to(()=>{y??(y=ne),w=d(v);var N=w.length;if(!(u&&N===0)){u=N===0;var L,W,M,_;if(Pr()){var A=new Set,q=ce;for(W=0;W<N;W+=1){M=w[W],_=s(M,W);var re=a.items.get(_)??m.get(_);re?(t&(ln|cn))!==0&&Ur(re,M,W,t):(L=zr(null,a,null,null,M,_,W,n,t,i,!0),m.set(_,L)),A.add(_)}for(const[me,Re]of a.items)A.has(me)||q.skipped_effects.add(Re.e);q.oncommit(b)}else b();d(v)}})}function dc(e,t,i,s,n,o,r,a,l){var ye,D,G,te;var c=(r&Qa)!==0,h=(r&(ln|cn))!==0,u=t.length,m=i.items,v=i.first,w=v,y,b=null,N,L=[],W=[],M,_,A,q;if(c)for(q=0;q<u;q+=1)M=t[q],_=a(M,q),A=m.get(_),A!==void 0&&((ye=A.a)==null||ye.measure(),(N??(N=new Set)).add(A));for(q=0;q<u;q+=1){if(M=t[q],_=a(M,q),A=m.get(_),A===void 0){var re=s.get(_);if(re!==void 0){s.delete(_),m.set(_,re);var me=b?b.next:w;Tt(i,b,re),Tt(i,re,me),Nn(re,me,n),b=re}else{var Re=w?w.e.nodes_start:n;b=zr(Re,i,b,b===null?i.first:b.next,M,_,q,o,r,l)}m.set(_,b),L=[],W=[],w=b.next;continue}if(h&&Ur(A,M,q,r),(A.e.f&Ze)!==0&&(so(A.e),c&&((D=A.a)==null||D.unfix(),(N??(N=new Set)).delete(A))),A!==w){if(y!==void 0&&y.has(A)){if(L.length<W.length){var ve=W[0],pe;b=ve.prev;var Ve=L[0],Oe=L[L.length-1];for(pe=0;pe<L.length;pe+=1)Nn(L[pe],ve,n);for(pe=0;pe<W.length;pe+=1)y.delete(W[pe]);Tt(i,Ve.prev,Oe.next),Tt(i,b,Ve),Tt(i,Oe,ve),w=ve,b=Oe,q-=1,L=[],W=[]}else y.delete(A),Nn(A,w,n),Tt(i,A.prev,A.next),Tt(i,A,b===null?i.first:b.next),Tt(i,b,A),b=A;continue}for(L=[],W=[];w!==null&&w.k!==_;)(w.e.f&Ze)===0&&(y??(y=new Set)).add(w),W.push(w),w=w.next;if(w===null)continue;A=w}L.push(A),b=A,w=A.next}if(w!==null||y!==void 0){for(var U=y===void 0?[]:Yn(y);w!==null;)(w.e.f&Ze)===0&&U.push(w),w=w.next;var T=U.length;if(T>0){var X=(r&er)!==0&&u===0?n:null;if(c){for(q=0;q<T;q+=1)(G=U[q].a)==null||G.measure();for(q=0;q<T;q+=1)(te=U[q].a)==null||te.fix()}hc(i,U,X)}}c&&es(()=>{var Ge;if(N!==void 0)for(A of N)(Ge=A.a)==null||Ge.apply()}),e.first=i.first&&i.first.e,e.last=b&&b.e;for(var ee of s.values())$e(ee.e);s.clear()}function Ur(e,t,i,s){(s&ln)!==0&&Gi(e.v,t),(s&cn)!==0?Gi(e.i,i):e.i=i}function zr(e,t,i,s,n,o,r,a,l,c,h){var u=(l&ln)!==0,m=(l&Za)===0,v=u?m?z(n,!1,!1):ki(n):n,w=(l&cn)===0?r:ki(r),y={i:w,v,k:o,a:null,e:null,prev:i,next:s};try{if(e===null){var b=document.createDocumentFragment();b.append(e=_i())}return y.e=ut(()=>a(e,v,w,c),Pl),y.e.prev=i&&i.e,y.e.next=s&&s.e,i===null?h||(t.first=y):(i.next=y,i.e.next=y.e),s!==null&&(s.prev=y,s.e.prev=y.e),y}finally{}}function Nn(e,t,i){for(var s=e.next?e.next.e.nodes_start:i,n=t?t.e.nodes_start:i,o=e.e.nodes_start;o!==null&&o!==s;){var r=Rs(o);n.before(o),o=r}}function Tt(e,t,i){t===null?e.first=i:(t.next=i,t.e.next=i&&i.e),i!==null&&(i.prev=t,i.e.prev=t&&t.e)}function bo(e,t,i=!1,s=!1,n=!1){var o=e,r="";oe(()=>{var a=ne;if(r!==(r=t()??"")&&(a.nodes_start!==null&&(Er(a.nodes_start,a.nodes_end),a.nodes_start=a.nodes_end=null),r!=="")){var l=r+"";i?l=`<svg>${l}</svg>`:s&&(l=`<math>${l}</math>`);var c=jr(l);if((i||s)&&(c=Kt(c)),Js(Kt(c),c.lastChild),i||s)for(;Kt(c);)o.before(Kt(c));else o.before(c)}})}function qr(e,t,i,s,n){var a;var o=(a=t.$$slots)==null?void 0:a[i],r=!1;o===!0&&(o=t.children,r=!0),o===void 0||o(e,r?()=>s:s)}function Jr(e){var t,i,s="";if(typeof e=="string"||typeof e=="number")s+=e;else if(typeof e=="object")if(Array.isArray(e)){var n=e.length;for(t=0;t<n;t++)e[t]&&(i=Jr(e[t]))&&(s&&(s+=" "),s+=i)}else for(i in e)e[i]&&(s&&(s+=" "),s+=i);return s}function uc(){for(var e,t,i=0,s="",n=arguments.length;i<n;i++)(e=arguments[i])&&(t=Jr(e))&&(s&&(s+=" "),s+=t);return s}function fc(e){return typeof e=="object"?uc(e):e??""}function pc(e,t,i){var s=e==null?"":""+e;return t&&(s=s?s+" "+t:t),s===""?null:s}function gc(e,t){return e==null?null:String(e)}function bs(e,t,i,s,n,o){var r=e.__className;if(r!==i||r===void 0){var a=pc(i,s);a==null?e.removeAttribute("class"):e.className=a,e.__className=i}return o}function vt(e,t,i,s){var n=e.__style;if(n!==t){var o=gc(t);o==null?e.removeAttribute("style"):e.style.cssText=o,e.__style=t}return s}const mc=Symbol("is custom element"),vc=Symbol("is html");function ie(e,t,i,s){var n=wc(e);n[t]!==(n[t]=i)&&(t==="loading"&&(e[fl]=i),i==null?e.removeAttribute(t):typeof i!="string"&&yc(e).includes(t)?e[t]=i:e.setAttribute(t,i))}function wc(e){return e.__attributes??(e.__attributes={[mc]:e.nodeName.includes("-"),[vc]:e.namespaceURI===al})}var ko=new Map;function yc(e){var t=e.getAttribute("is")||e.nodeName,i=ko.get(t);if(i)return i;ko.set(t,i=[]);for(var s,n=e,o=Element.prototype;o!==n;){s=nr(n);for(var r in s)s[r].set&&i.push(r);n=Xn(n)}return i}function Es(e,t,i=t){var s=new WeakSet;Sr(e,"input",async n=>{var o=n?e.defaultValue:e.value;if(o=Cn(e)?Rn(o):o,i(o),ce!==null&&s.add(ce),await ec(),o!==(o=t())){var r=e.selectionStart,a=e.selectionEnd,l=e.value.length;if(e.value=o??"",a!==null){var c=e.value.length;r===a&&a===l&&c>l?(e.selectionStart=c,e.selectionEnd=c):(e.selectionStart=r,e.selectionEnd=Math.min(a,c))}}}),C(t)==null&&e.value&&(i(Cn(e)?Rn(e.value):e.value),ce!==null&&s.add(ce)),ts(()=>{var n=t();if(e===document.activeElement){var o=Fs??ce;if(s.has(o))return}Cn(e)&&n===Rn(e.value)||e.type==="date"&&!n&&!e.value||n!==e.value&&(e.value=n??"")})}function xc(e,t,i=t){Sr(e,"change",s=>{var n=s?e.defaultChecked:e.checked;i(n)}),C(t)==null&&i(e.checked),ts(()=>{var s=t();e.checked=!!s})}function Cn(e){var t=e.type;return t==="number"||t==="range"}function Rn(e){return e===""?null:+e}function Ce(e,t,i){var s=mi(e,t);s&&s.set&&(e[t]=i,vn(()=>{e[t]=null}))}function _o(e,t){return e===t||(e==null?void 0:e[vi])===t}function Te(e={},t,i,s){return ql(()=>{var n,o;return ts(()=>{n=o,o=[],C(()=>{e!==i(...o)&&(t(e,...o),n&&_o(i(...n),e)&&t(null,...n))})}),()=>{es(()=>{o&&_o(i(...o),e)&&t(null,...o)})}}),e}function de(e=!1){const t=ge,i=t.l.u;if(!i)return;let s=()=>we(t.s);if(e){let n=0,o={};const r=pn(()=>{let a=!1;const l=t.s;for(const c in l)l[c]!==o[c]&&(o[c]=l[c],a=!0);return a&&n++,n});s=()=>d(r)}i.b.length&&Ul(()=>{To(t,s),An(i.b)}),Bn(()=>{const n=C(()=>i.m.map(dl));return()=>{for(const o of n)typeof o=="function"&&o()}}),i.a.length&&Bn(()=>{To(t,s),An(i.a)})}function To(e,t){if(e.l.s)for(const i of e.l.s)d(i);t()}function Gr(e,t,i){if(e==null)return t(void 0),Hi;const s=C(()=>e.subscribe(t,i));return s.unsubscribe?()=>s.unsubscribe():s}const Di=[];function bc(e,t=Hi){let i=null;const s=new Set;function n(a){if(cr(e,a)&&(e=a,i)){const l=!Di.length;for(const c of s)c[1](),Di.push(c,e);if(l){for(let c=0;c<Di.length;c+=2)Di[c][0](Di[c+1]);Di.length=0}}}function o(a){n(a(e))}function r(a,l=Hi){const c=[a,l];return s.add(c),s.size===1&&(i=t(n,o)||Hi),a(e),()=>{s.delete(c),s.size===0&&i&&(i(),i=null)}}return{set:n,update:o,subscribe:r}}function kc(e){let t;return Gr(e,i=>t=i)(),t}let As=!1,jn=Symbol();function _c(e,t,i){const s=i[t]??(i[t]={store:null,source:z(void 0),unsubscribe:Hi});if(s.store!==e&&!(jn in i))if(s.unsubscribe(),s.store=e??null,e==null)s.source.v=void 0,s.unsubscribe=Hi;else{var n=!0;s.unsubscribe=Gr(e,o=>{n?s.source.v=o:I(s.source,o)}),n=!1}return e&&jn in i?kc(e):d(s.source)}function Tc(){const e={};function t(){vn(()=>{for(var i in e)e[i].unsubscribe();sr(e,jn,{enumerable:!1,value:!0})})}return[e,t]}function Pc(e){var t=As;try{return As=!1,[e(),As]}finally{As=t}}function J(e,t,i,s){var W;var n=!Qi||(i&tl)!==0,o=(i&sl)!==0,r=(i&nl)!==0,a=s,l=!0,c=()=>(l&&(l=!1,a=r?C(s):s),a),h;if(o){var u=vi in e||ul in e;h=((W=mi(e,t))==null?void 0:W.set)??(u&&t in e?M=>e[t]=M:void 0)}var m,v=!1;o?[m,v]=Pc(()=>e[t]):m=e[t];var w;if(n?w=()=>{var M=e[t];return M===void 0?c():(l=!0,M)}:w=()=>{var M=e[t];return M!==void 0&&(a=void 0),M===void 0?a:M},n&&(i&il)===0)return w;if(h){var y=e.$$legacy;return(function(M,_){return arguments.length>0?((!n||!_||y||v)&&h(_?w():M),M):w()})}var b=!1,N=((i&el)!==0?pn:Zn)(()=>(b=!1,w()));o&&d(N);var L=ne;return(function(M,_){if(arguments.length>0){const A=_?d(N):n&&o?Wi(M):M;return I(N,A),b=!0,a!==void 0&&(a=A),M}return Ni&&b||(L.f&Zt)!==0?N.v:d(N)})}const ft=[];function Sc(e){return ft.length=0,ft.push({icon:"sell",text:"change name",state:"enabled",action:e.nameDialog}),ft.push({icon:"note_add",text:"new file",state:"enabled",action:t=>tx.send("name request",{label:"new file",value:"",regex:Path.regex.file,pos:{x:t.clientX,y:t.clientY},ok:i=>e.newFile(i),cancel:()=>{}})}),ft.push({icon:"create_new_folder",text:"new folder",state:"enabled",action:t=>tx.send("name request",{label:"new folder",value:"",regex:Path.regex.vizPath,pos:{x:t.clientX,y:t.clientY},ok:i=>e.newFolder(i),cancel:()=>{}})}),ft.push({icon:"folder_off",text:"remove folder",state:"enabled",action:t=>tx.send("message",{title:"Confirm removal",message:`Remove ${e.getPath()} from drawer ?`,pos:{x:t.clientX,y:t.clientY},ok:()=>e.remove(),cancel:()=>{}})}),ft.push({icon:"delete",text:"delete folder",state:"enabled",action:t=>tx.send("message",{title:"Confirm delete",message:`Delete ${e.getPath()} ?`,pos:{x:t.clientX,y:t.clientY},ok:()=>e.remove(),cancel:()=>{}})}),ft}function Lc(e){return ft.length=0,ft.push({icon:"sell",text:"change name",state:"enabled",action:t=>tx.send("name request",{label:"Name ",value:this.name,regex:/^[\w,-]+$/,pos:{x:t.clientX,y:t.clientY},ok:i=>this.rename(i),cancel:()=>{}})}),ft.push({icon:"delete",text:"delete file",state:"enabled",action:t=>tx.send("message",{title:"Confirm delete",message:`Delete ${this.getPath()} ?`,pos:{x:t.clientX,y:t.clientY},ok:()=>this.remove(),cancel:()=>{}})}),ft}var Nc=V('<i class="material-icons-outlined folder-icon svelte-cdx8zl"> </i> <span class="fldr-name svelte-cdx8zl" draggable="true"> </span> <!>',1),Cc=V('<li class="dir svelte-cdx8zl"><!></li>'),Rc=V('<li class="file svelte-cdx8zl"><i> </i> <span draggable="true"> </span></li>'),Ec=V('<div class="file-dir-list svelte-cdx8zl"><!> <!></div>');function Gs(e,t){ae(t,!1);let i=J(t,"folder",12),s=J(t,"tx",8),n=z();fe(()=>{i().name!==""&&j(n,d(n).style.margin="0rem 0rem 0rem 1.2rem")});async function o(m){var y,b;let v=m.target.dataset.fldrindex??((b=(y=m.target.parentNode)==null?void 0:y.dataset)==null?void 0:b.fldrindex);if(!v)return;let w=i().folders[+v];w.is.expanded=!w.is.expanded,w.is.expanded&&w.is.stale&&(await w.update(),w.is.stale=!1),i(i())}function r(m){var y;const v=(y=m.target.parentNode.dataset)==null?void 0:y.fileindex;if(!v)return;const w=i().files[+v].arl;s().send("file selected",w)}function a(m){var b;m.preventDefault(),m.stopPropagation();const v=(b=m.target.parentNode.dataset)==null?void 0:b.fldrindex,w=i().folders[+v];if(!w)return;const y=Sc(w);s().send("folder context menu",{menu:y,event:m})}function l(m){var b;m.preventDefault(),m.stopPropagation();const v=(b=m.target.parentNode.dataset)==null?void 0:b.fileindex;if(!i().files[+v])return;const y=Lc();s().send("file context menu",{menu:y,event:m})}de();var c=Ec(),h=R(c);gt(h,1,()=>(we(i()),C(()=>i().folders)),pt,(m,v,w)=>{var y=Cc();ie(y,"data-fldrindex",w);var b=R(y);{var N=W=>{Gs(W,{get folder(){return d(v)},get tx(){return s()}})},L=W=>{var M=Nc(),_=he(M),A=R(_),q=B(_,2),re=R(q),me=B(q,2);{var Re=ve=>{Gs(ve,{get folder(){return d(v)},get tx(){return s()}})};ue(me,ve=>{d(v),C(()=>d(v).is.expanded)&&ve(Re)})}oe(()=>{K(A,(d(v),C(()=>d(v).is.expanded?"folder_open":"folder"))),K(re,(d(v),C(()=>d(v).name)))}),P("click",_,o),P("click",q,o),O(W,M)};ue(b,W=>{d(v),C(()=>d(v).parent===null)?W(N):W(L,!1)})}P("contextmenu",y,a),O(m,y)});var u=B(h,2);gt(u,1,()=>(we(i()),C(()=>i().files)),pt,(m,v,w)=>{var y=Rc();ie(y,"data-fileindex",w);var b=R(y),N=R(b),L=B(b,2),W=R(L);oe((M,_,A)=>{bs(b,1,M,"svelte-cdx8zl"),K(N,_),bs(L,1,A,"svelte-cdx8zl"),K(W,(d(v),C(()=>d(v).name)))},[()=>(d(v),C(()=>"material-icons-outlined file-icon "+d(v).getFileClass())),()=>(d(v),C(()=>d(v).getIcon())),()=>(d(v),C(()=>"file-name "+d(v).getFileClass()))]),P("click",b,r),P("click",L,r),P("contextmenu",y,l),O(m,y)}),Te(c,m=>I(n,m),()=>d(n)),O(e,c),le()}var Mc=V('<p class="no-selection svelte-qhgjoh">Examples could not be mounted.</p>'),Ac=V('<div class="menu-item svelte-qhgjoh"><i class="material-icons-outlined svelte-qhgjoh"> </i> <div class="tooltip svelte-qhgjoh"> </div></div>'),Dc=V('<div class="file-system svelte-qhgjoh"><!></div>'),Oc=V('<div class="heading svelte-qhgjoh"><h1 class="svelte-qhgjoh">Local File System</h1> <div class="menu-item svelte-qhgjoh"><i class="material-icons-outlined svelte-qhgjoh">folder</i> <div class="tooltip svelte-qhgjoh">Open folder</div></div> <!></div> <!>',1),Ic=V('<div class="workspace svelte-qhgjoh"><div class="heading svelte-qhgjoh"><h1 class="svelte-qhgjoh">Examples</h1> <div class="menu-item svelte-qhgjoh"><i class="material-icons-outlined svelte-qhgjoh"> </i> <div class="tooltip svelte-qhgjoh"> </div></div></div> <div class="file-system svelte-qhgjoh"><!></div> <!></div>');function Fc(e,t){ae(t,!1);let i=J(t,"tx",8),s=z(),n=z(),o=z();const r=window.location.origin,a="/examples/file-system.json";let l=z(null),c=z(null);fe(async()=>{i().send("dom workspace div",d(s)),h(),v()});function h(){document.addEventListener("visibilitychange",U=>{U.preventDefault()})}const u={onDomAddModalDiv(U){d(s).append(U)},onFileSavedAs(U){},onFileActive(U){},onFileClosed(U){}};async function m(U){try{const T=new Mn("local"),X=await window.showDirectoryPicker(),ee=X.name,ye=new Is(ee,X);T.root=new fs(ye,T),ye.setFileSystem(T.root,"/"),T.root.is.expanded=!0,await T.root.update(),I(c,T)}catch(T){console.error("Local file system selection cancelled or failed:",T),I(c,null)}}async function v(){I(l,new Mn("fixed"));const U=new Qt(a);U.url=new URL(a,r);const T=await U.get("json");if(!T)return;const X=new Qt("");X.url=new URL(r);const ee=X.resolve("/"+T.name);j(l,d(l).root=new fs(ee,d(l))),w(T,d(l).root)}function w(U,T){if(U.folders)for(const X of U.folders){const ee=T.arl.getPath()+"/"+X.name,ye=T.arl.resolve(ee),D=new fs(ye,T);T.folders.push(D),w(X,D)}if(U.files)for(const X of U.files){const ee=T.arl.resolve(T.arl.getPath()+"/"+X),ye=new Gn(ee,T);T.files.push(ye)}}function y(){d(l)&&(d(l).root.is.expanded?d(l).collapse():d(l).expand(),I(l,d(l)))}function b(){d(c)&&(d(c).root.is.expanded?d(c).collapse():d(c).expand(),I(l,d(l)))}var N={handlers:u};de();var L=Ic(),W=R(L),M=B(R(W),2),_=R(M),A=R(_),q=B(_,2),re=R(q),me=B(W,2),Re=R(me);{var ve=U=>{Gs(U,{get folder(){return d(l),C(()=>d(l).root)},get tx(){return i()}})},pe=U=>{var T=Mc();O(U,T)};ue(Re,U=>{d(l),C(()=>{var T;return(T=d(l))==null?void 0:T.root})?U(ve):U(pe,!1)})}Te(me,U=>I(n,U),()=>d(n));var Ve=B(me,2);{var Oe=U=>{var T=Oc(),X=he(T),ee=B(R(X),2),ye=R(ee),D=B(ee,2);{var G=lt=>{var Ie=Ac(),Ye=R(Ie),Ft=R(Ye),ii=B(Ye,2),si=R(ii);oe(()=>{K(Ft,(d(c),C(()=>{var kt;return(kt=d(c).root)!=null&&kt.is.expanded?"unfold_less":"unfold_more"}))),K(si,(d(c),C(()=>{var kt;return(kt=d(c).root)!=null&&kt.is.expanded?"collapse all":"expand all"})))}),P("click",Ye,b),O(lt,Ie)};ue(D,lt=>{d(c)&&lt(G)})}var te=B(X,2);{var Ge=lt=>{var Ie=Dc(),Ye=R(Ie);Gs(Ye,{get folder(){return d(c),C(()=>d(c).root)},get tx(){return i()}}),Te(Ie,Ft=>I(o,Ft),()=>d(o)),O(lt,Ie)};ue(te,lt=>{d(c)&&lt(Ge)})}P("click",ye,m),O(U,T)};ue(Ve,U=>{U(Oe)})}return Te(L,U=>I(s,U),()=>d(s)),oe(()=>{K(A,(d(l),C(()=>{var U,T;return(T=(U=d(l))==null?void 0:U.root)!=null&&T.is.expanded?"unfold_less":"unfold_more"}))),K(re,(d(l),C(()=>{var U,T;return(T=(U=d(l))==null?void 0:U.root)!=null&&T.is.expanded?"collapse all":"expand all"})))}),P("click",_,y),O(e,L),Ce(t,"handlers",u),le(N)}function Wc(e,t){const i=document.createElement("div");return Vr(Fc,{target:i,props:{tx:e,sx:t}}).handlers}var Hc=V('<div class="main svelte-ai1hu1"><div class="tabs svelte-ai1hu1"></div> <div class="content svelte-ai1hu1"></div></div>');function Bc(e,t){ae(t,!1);let i=J(t,"tx",8),s=z(),n=z(),o=z(),r=null;fe(async()=>{});const a={onContentDiv(m){d(n).replaceChildren(m),r&&d(n).append(r),i().send("div",d(s))},onMenuDiv(m){r=m,d(n).append(r)},onTabsDiv(m){d(o).replaceChildren(m)},onModalDiv(m){d(s).append(m)},onSizeChange({id:m,rect:v}){const w=Math.floor(d(n).clientWidth),y=Math.floor(d(n).clientHeight);i().send("content size change",{x:0,y:0,w,h:y})},onShow(){i().send("div",d(s))}};var l={handlers:a};de();var c=Hc(),h=R(c);Te(h,m=>I(o,m),()=>d(o));var u=B(h,2);return Te(u,m=>I(n,m),()=>d(n)),Te(c,m=>I(s,m),()=>d(s)),O(e,c),Ce(t,"handlers",a),le(l)}var $c=V('<div class="column-main-layout svelte-1496us"><div class="left-column svelte-1496us"></div> <div class="separator svelte-1496us"></div> <div class="main-area svelte-1496us"></div></div>');function jc(e,t){ae(t,!1);let i=J(t,"tx",8),s=z(),n=z(),o=z(),r=z(),a=z(0),l=!1,c=null,h;const u=.12,m=160,v=320,w=1024,y=typeof window<"u",b=T=>y&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(T):setTimeout(()=>T(Date.now()),16),N=T=>{if(T!==null){if(y&&typeof window.cancelAnimationFrame=="function"){window.cancelAnimationFrame(T);return}clearTimeout(T)}},L=()=>{c===null&&(c=b(()=>{c=null,me()}))},W=T=>{var Ge;const X=y?window.innerWidth:w,ee=((Ge=d(s))==null?void 0:Ge.clientWidth)??X??T;if(!ee)return T;const ye=Math.max(ee-v,80),D=Math.min(m,ye),G=Math.max(ee-v,D),te=Math.min(Math.max(T,D),G);return Number.isFinite(te)?te:D},M=()=>{var T;l&&(l=!1,y&&(window.removeEventListener("pointermove",_),window.removeEventListener("pointerup",A)),(T=d(r))==null||T.classList.remove("dragging"),me())},_=T=>{if(!l||!d(s))return;const{left:X}=d(s).getBoundingClientRect(),ee=W(T.clientX-X);ee!==d(a)&&(I(a,ee),L())},A=()=>M(),q=T=>{var X;T.preventDefault(),l=!0,(X=d(r))==null||X.classList.add("dragging"),y&&(window.addEventListener("pointermove",_),window.addEventListener("pointerup",A))},re=()=>{I(a,W(d(a))),L()},me=()=>{if(!d(o)||!i())return;const T=d(o).getBoundingClientRect(),X={rect:{x:0,y:0,w:Math.floor(T.width),h:Math.floor(T.height)}};i().send("size change",X)};fe(()=>{var ee;const T=y?window.innerWidth:w,X=((ee=d(s))==null?void 0:ee.clientWidth)??T??0;return I(a,W(X*u||m)),y&&window.addEventListener("resize",re),typeof ResizeObserver<"u"&&(h=new ResizeObserver(()=>L()),d(o)&&h.observe(d(o))),L(),()=>{y&&window.removeEventListener("resize",re),M(),h==null||h.disconnect(),c!==null&&(N(c),c=null)}});const Re={onLeftColumn(T){var X;(X=d(n))==null||X.replaceChildren(T)},onMainArea(T){d(o)&&(d(o).replaceChildren(T),T.width=Math.floor(d(o).clientWidth),T.height=Math.floor(d(o).clientHeight),me())}};var ve={handlers:Re};de();var pe=$c(),Ve=R(pe);Te(Ve,T=>I(n,T),()=>d(n));var Oe=B(Ve,2);Te(Oe,T=>I(r,T),()=>d(r));var U=B(Oe,2);return Te(U,T=>I(o,T),()=>d(o)),Te(pe,T=>I(s,T),()=>d(s)),oe(()=>vt(Ve,`width:${d(a)}px;flex-basis:${d(a)}px;`)),P("pointerdown",Oe,q),O(e,pe),Ce(t,"handlers",Re),le(ve)}var Vc=V('<div class="tab selected svelte-18p7ldm"> <input class="button svelte-18p7ldm" type="button"/> <div class="full-name svelte-18p7ldm"> </div></div>'),Uc=V('<div class="tab svelte-18p7ldm"> <input class="button svelte-18p7ldm" type="button"/> <div class="full-name svelte-18p7ldm"> </div></div>'),zc=V('<div class="tab-ribbon svelte-18p7ldm"></div>');function qc(e,t){ae(t,!1);let i=J(t,"tx",8);fe(()=>{i().send("div",d(s).div)});let s=z({div:null,selected:-1,tabs:[]});const n={onTabNew(h){j(s,d(s).selected=d(s).tabs.push(h)-1),I(s,d(s))},onTabRemove(h){const u=d(s).tabs,m=u.length;for(let v=0;v<m;v++)if(u[v]==h){if(m>1)for(let w=v;w<m-1;w++)u[w]=u[w+1];u.pop();break}I(s,d(s))},onTabRename({oldName:h,newName:u}){const m=d(s).tabs,v=m.findIndex(w=>w==h);v>=0&&(m[v]=u),I(s,d(s))},onTabSelect(h){const m=d(s).tabs.findIndex(v=>v==h);m>=0&&j(s,d(s).selected=m),I(s,d(s))}};function o(h){const u=h.target.getAttribute("data-index");u<0||u>=d(s).tabs.length||i().send("tab request to select",d(s).tabs[u])}function r(h){h.stopPropagation();const u=h.target.parentNode.getAttribute("data-index");u<0||u>=d(s).tabs.length||i().send("tab request to close",d(s).tabs[u])}function a(h){}var l={handlers:n};de();var c=zc();return gt(c,5,()=>(d(s),C(()=>d(s).tabs)),pt,(h,u,m)=>{var v=Qe(),w=he(v);{var y=N=>{var L=Vc();ie(L,"data-index",m);var W=R(L),M=B(W),_=B(M,2),A=R(_);oe(()=>{K(W,`${d(u)??""} `),vt(_,`width: ${d(u),C(()=>d(u).length*.5)??""}rem;`),K(A,d(u))}),P("click",M,r),P("keydown",M,a),P("click",L,o),P("keydown",L,a),O(N,L)},b=N=>{var L=Uc();ie(L,"data-index",m);var W=R(L),M=B(W),_=B(M,2),A=R(_);oe(()=>{K(W,`${d(u)??""} `),vt(_,`width: ${d(u),C(()=>d(u).length*.5)??""}rem;`),K(A,d(u))}),P("click",M,r),P("keydown",M,a),P("click",L,o),P("keydown",L,a),O(N,L)};ue(w,N=>{d(s),C(()=>m==d(s).selected)?N(y):N(b,!1)})}O(h,v)}),Te(c,h=>j(s,d(s).div=h),()=>{var h;return(h=d(s))==null?void 0:h.div}),O(e,c),Ce(t,"handlers",n),le(l)}var Jc=V('<div class="menu-item svelte-sk4hi"><i class="material-icons-outlined icon svelte-sk4hi"> </i> <div class="tooltip svelte-sk4hi"> </div></div>'),Gc=V('<div class="menu svelte-sk4hi"></div>');function Yc(e,t){ae(t,!1);let i=J(t,"tx",8),s=J(t,"sx",8),n=z(),o=z(s());fe(()=>{i().send("div",d(n))});const r={"-> set menu"(u){I(o,u)}};function a(u){var v;const m=u.target.getAttribute("data-index");((v=d(o)[m].message)==null?void 0:v.length)>0&&i().send(d(o)[m].message,u)}function l(u){}var c={handlers:r};de();var h=Gc();return gt(h,5,()=>d(o),pt,(u,m,v)=>{var w=Jc(),y=R(w);ie(y,"data-index",v);var b=R(y),N=B(y,2),L=R(N);oe(()=>{vt(y,`color: ${d(m),C(()=>d(m).color)??""};`),K(b,(d(m),C(()=>d(m).icon))),vt(N,`width: ${d(m),C(()=>d(m).help.length*.5)??""}rem;`),K(L,(d(m),C(()=>d(m).help)))}),P("click",y,a),P("keydown",y,l),O(u,w)}),Te(h,u=>I(n,u),()=>d(n)),O(e,h),Ce(t,"handlers",r),le(c)}function Xc(){return localStorage.getItem("vmblu-theme")||"dark"}const Yr=bc(Xc());Yr.subscribe(e=>{localStorage.setItem("vmblu-theme",e)});var Kc=V('<i class="material-icons-outlined open svelte-6k9ztc">description</i>'),Qc=V('<i class="material-icons-outlined open svelte-6k9ztc">add_circle</i>'),Zc=V('<div class="right-icons svelte-6k9ztc"><i class="material-icons-outlined trash svelte-6k9ztc">delete</i></div>'),eh=V('<div><div class="hdr svelte-6k9ztc"><div class="left-icons svelte-6k9ztc"><i class="material-icons-outlined cancel svelte-6k9ztc">cancel</i> <i class="material-icons-outlined check svelte-6k9ztc">check_circle</i> <!> <!></div> <h1 class="svelte-6k9ztc"> </h1> <!></div> <!></div>');function bt(e,t){ae(t,!1);const i=()=>_c(Yr,"$theme",s),[s,n]=Tc();let o=J(t,"box",12),r,a,l,c,h=!1;fe(()=>{o(o().show=w,!0),o(o().hide=y,!0),o(o().update=()=>o(o()),!0)});function u(D){r=D.clientX,a=D.clientY,l=o().div.offsetLeft,c=o().div.offsetTop,h=!0,document.addEventListener("mousemove",m),document.addEventListener("mouseup",v)}function m(D){if(h){const G=D.clientX-r,te=D.clientY-a;o(o().div.style.left=`${l+G}px`,!0),o(o().div.style.top=`${c+te}px`,!0)}}function v(D){h=!1,document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",v)}function w(D){D||(D=o().pos),D&&(o(o().div.style.left=`${D.x}px`,!0),o(o().div.style.top=`${D.y}px`,!0)),o(o().div.style.display="block",!0),o(o())}function y(){o(o().div.style.display="none",!0)}function b(D){var G,te;y(),(te=(G=o()).cancel)==null||te.call(G,D)}function N(D){var G,te;y(),(te=(G=o()).ok)==null||te.call(G,D)}function L(D){var G,te;(te=(G=o()).open)==null||te.call(G,D)}function W(D){var G,te;(te=(G=o()).add)==null||te.call(G,D)}function M(D){var G,te;y(),(te=(G=o()).trash)==null||te.call(G,D)}function _(D){return D.stopPropagation(),D.key=="Enter"?N(D):D.key=="Escape"||D.key=="Esc"?b(D):null}de();var A=eh(),q=R(A),re=R(q),me=R(re),Re=B(me,2),ve=B(Re,2);{var pe=D=>{var G=Kc();P("click",G,L),P("keydown",G,_),O(D,G)};ue(ve,D=>{we(o()),C(()=>o().open)&&D(pe)})}var Ve=B(ve,2);{var Oe=D=>{var G=Qc();P("click",G,W),P("keydown",G,_),O(D,G)};ue(Ve,D=>{we(o()),C(()=>o().add)&&D(Oe)})}var U=B(re,2),T=R(U),X=B(U,2);{var ee=D=>{var G=Zc(),te=R(G);P("click",te,M),P("keydown",te,_),O(D,G)};ue(X,D=>{we(o()),C(()=>o().trash)&&D(ee)})}var ye=B(q,2);qr(ye,t,"default",{}),Te(A,D=>o(o().div=D,!0),()=>{var D;return(D=o())==null?void 0:D.div}),oe(()=>{bs(A,1,`main ${i()??""}`,"svelte-6k9ztc"),K(T,(we(o()),C(()=>o().title)))}),P("click",me,b),P("keydown",me,_),P("click",Re,N),P("keydown",Re,_),P("mousedown",q,u),P("keydown",A,_),O(e,A),le(),n()}var th=V('<div class="same-line svelte-1s2wqkj"><!></div>');function Po(e,t){var i=th(),s=R(i);qr(s,t,"default",{}),O(e,i)}var ih=V('<label class="label svelte-1hdmeto"> </label>');function So(e,t){let i=J(t,"text",8),s=J(t,"style",8);var n=ih(),o=R(n);oe(()=>{vt(n,s()?s():""),K(o,i())}),O(e,n)}var sh=V('<input class="grow svelte-1p6z9d0" type="text" spellcheck="false"/>');function Xr(e,t){ae(t,!1);let i=J(t,"text",12),s=J(t,"check",8),n=J(t,"style",8),o=z(),r=null;const a="#ff0000";fe(()=>{r=d(o).style.color});function l(h){j(o,d(o).style.width="0px"),j(o,d(o).style.width=d(o).scrollWidth>100?d(o).scrollWidth+2+"px":"100px"),s()&&j(o,d(o).style.color=s()(d(o).value)?r:a)}de();var c=sh();Te(c,h=>I(o,h),()=>d(o)),oe(()=>vt(c,n()?n():"")),Es(c,i),P("input",c,l),O(e,c),le()}var nh=V('<input type="checkbox" class="svelte-ywsl3b"/>');function Lo(e,t){ae(t,!1);let i=J(t,"style",8),s=J(t,"on",12),n=J(t,"onToggle",8);fe(()=>{});function o(a){var l;(l=n())==null||l(s())}de();var r=nh();oe(()=>vt(r,i()?i():"")),xc(r,s),P("input",r,o),O(e,r),le()}var oh=V("<!> <!>",1),rh=V("<!> <!> <!>",1),ah=V("<!> <!>",1);function lh(e,t){ae(t,!1);let i=J(t,"tx",8);fe(()=>{i().send("modal div",d(s).div)});const s=z({div:null,pos:null,title:"",ok:null,cancel:null}),n=z({logMessages:!1,worker:{on:!1,path:""}}),o={"-> show"({title:l,pos:c,rx:h,ok:u,cancel:m}){j(s,d(s).title=l),j(s,d(s).pos={...c}),j(s,d(s).ok=v=>{u&&u(d(n))}),j(s,d(s).cancel=()=>{m==null||m()}),h&&(j(n,d(n).logMessages=h.logMessages),j(n,d(n).worker.on=h.worker.on),j(n,d(n).worker.path=h.worker.path)),d(s).show(d(s).pos)}};function r(l){}var a={handlers:o};return de(),bt(e,{get box(){return d(s)},children:(l,c)=>{var h=ah(),u=he(h);Po(u,{children:(v,w)=>{var y=oh(),b=he(y);Lo(b,{get on(){return d(n),C(()=>d(n).logMessages)},onToggle:r});var N=B(b,2);So(N,{text:"log messages"}),O(v,y)},$$slots:{default:!0}});var m=B(u,2);Po(m,{children:(v,w)=>{var y=rh(),b=he(y);Lo(b,{get field(){return d(n),C(()=>d(n).worker.on)}});var N=B(b,2);So(N,{text:"use worker script:",style:"margin-right: 0.5rem;"});var L=B(N,2);Xr(L,{get field(){return d(n),C(()=>d(n).worker.path)}}),O(v,y)},$$slots:{default:!0}}),O(l,h)},$$slots:{default:!0}}),Ce(t,"handlers",o),le(a)}function ch(e,t){ae(t,!1);let i=J(t,"tx",8);fe(async()=>{i().send("modal div",d(s).div)});const s=z({div:null,pos:null,title:"",ok:null,cancel:null}),n={"-> show"({title:r,message:a,pos:l,ok:c,cancel:h}){j(s,d(s).title=r),j(s,d(s).ok=c),j(s,d(s).cancel=h),d(s).show(l)}};var o={handlers:n};return de(),bt(e,{get box(){return d(s)}}),Ce(t,"handlers",n),le(o)}var hh=V('<li><i> </i> <span class="choice-text svelte-cldbb7"> </span> <span class="choice-char svelte-cldbb7"> </span></li>'),dh=V('<div class="svelte-cldbb7"><ul class="svelte-cldbb7"></ul></div>');function uh(e,t){ae(t,!1);let i=J(t,"tx",8),s=z({div:null,menu:[],show:()=>{}});fe(()=>{j(s,d(s).show=o),i().send("modal div",d(s).div)});const n={"-> context menu"({menu:w,event:y}){j(s,d(s).menu=w),d(s).show(y)}};function o(w){d(s).menu.length<=0||(r(),j(s,d(s).div.style.display="block"),j(s,d(s).div.style.left=`${w.clientX-10}px`),j(s,d(s).div.style.top=`${w.clientY-20}px`),I(s,d(s)))}function r(){let w=0;d(s).menu.forEach(y=>{const b=y.text.length+(y.char?y.char.length+5:0);b>w&&(w=b)}),d(s).div.querySelector("ul").style.width=(.5*w+1.5).toString()+"rem"}function a(w){j(s,d(s).div.style.display="none")}function l(w){w.preventDefault(),j(s,d(s).div.style.display="none")}function c(w){j(s,d(s).div.style.display="none");let y=w.target.dataset.index??w.target.parentNode.dataset.index;d(s).menu[y]&&d(s).menu[y].state=="enabled"&&d(s).menu[y].action(w)}function h(w){}var u={handlers:n};de();var m=dh(),v=R(m);return gt(v,5,()=>(d(s),C(()=>d(s).menu)),pt,(w,y,b)=>{var N=hh();ie(N,"data-index",b);var L=R(N),W=R(L),M=B(L,2),_=R(M),A=B(M,2),q=R(A);oe(()=>{bs(N,1,fc((d(y),C(()=>d(y).state))),"svelte-cldbb7"),bs(L,1,`material-icons-outlined choice-icon ${d(y),C(()=>d(y).state)??""}`,"svelte-cldbb7"),K(W,(d(y),C(()=>d(y).icon))),K(_,(d(y),C(()=>d(y).text))),K(q,(d(y),C(()=>d(y).char??" ")))}),P("click",N,c),P("keydown",N,h),O(w,N)}),Te(m,w=>j(s,d(s).div=w),()=>{var w;return(w=d(s))==null?void 0:w.div}),P("mouseleave",v,a),P("click",m,a),P("contextmenu",m,l),P("keydown",m,h),O(e,m),Ce(t,"handlers",n),le(u)}var fh=V('<textarea name="txt-name" spellcheck="false" class="svelte-4j1bxw"></textarea>');function Kr(e,t){ae(t,!1);let i=J(t,"text",12),s=J(t,"cols",8),n=J(t,"rows",8);fe(()=>{});function o(a){a.key!="Escape"&&a.key!="Esc"&&a.stopPropagation()}de();var r=fh();oe(()=>{ie(r,"rows",n()),ie(r,"cols",s())}),Es(r,i),P("keydown",r,o),O(e,r),le()}function ph(e,t){ae(t,!1);let i=J(t,"tx",8);fe(async()=>{i().send("modal div",d(s).div)});let s=z({div:null,pos:null,title:"",ok:null,cancel:null}),n=z("");const o={"-> json"({title:l,pos:c,json:h,ok:u}){j(s,d(s).title=l),j(s,d(s).pos={...c}),j(s,d(s).ok=()=>{const m=r();if((m==null?void 0:m.length)==0)return u?u(""):null;m?u==null||u(m):d(s).show(c)}),I(n,h?JSON.stringify(h,null,"  "):""),d(s).show(c)}};function r(){let l=d(n).indexOf("SyntaxError");if(l!=-1&&I(n,l>1?d(n).slice(0,l-2):""),d(n).length==0)return"";try{return JSON.parse(d(n))}catch(c){return I(n,d(n)+`

`+c),null}}var a={handlers:o};return de(),bt(e,{get box(){return d(s)},children:(l,c)=>{Kr(l,{cols:"50",rows:"25",get text(){return d(n)},set text(h){I(n,h)},$$legacy:!0})},$$slots:{default:!0}}),Ce(t,"handlers",o),le(a)}function gh(e,t){ae(t,!1);let i=J(t,"tx",8),s=z({div:null,pos:null,title:"",ok:null,cancel:null});fe(()=>{i().send("modal div",d(s).div)});let n=z("");const o={"-> text"({header:a,pos:l,text:c,ok:h=null,cancel:u=null}){j(s,d(s).title=a),j(s,d(s).ok=()=>{h==null||h(d(n))}),I(n,c),d(s).show(l)}};var r={handlers:o};return de(),bt(e,{get box(){return d(s)},children:(a,l)=>{Kr(a,{cols:"50",rows:"25",get text(){return d(n)},set text(c){I(n,c)},$$legacy:!0})},$$slots:{default:!0}}),Ce(t,"handlers",o),le(r)}var mh=V('<p class="svelte-90r4b4"> </p>'),vh=V('<div class="handler svelte-90r4b4"><p class="svelte-90r4b4"><span class="clickable svelte-90r4b4"> </span> </p></div> <div class="params svelte-90r4b4"></div> <div class="prompt svelte-90r4b4"><pre class="svelte-90r4b4"> </pre></div>',1),wh=V('<div class="profile svelte-90r4b4"><!></div>');function No(e,t){ae(t,!1);let i=J(t,"profile",8),s=J(t,"open",8);function n(l){l.key!="Escape"&&l.key!="Esc"&&l.stopPropagation()}de();var o=wh(),r=R(o);{var a=l=>{var c=vh(),h=he(c),u=R(h),m=R(u),v=R(m),w=B(m),y=B(h,2);gt(y,5,()=>(we(i()),C(()=>i().params)),pt,(W,M)=>{let _=()=>d(M).type,A=()=>d(M).name,q=()=>d(M).description;var re=mh(),me=R(re);oe(()=>K(me,`${A()??""} (${_()??""}) ${q()??""}`)),O(W,re)});var b=B(y,2),N=R(b),L=R(N);oe(()=>{K(v,(we(i()),C(()=>i().handler))),K(w,`  in ${we(i()),C(()=>i().file)??""} (${we(i()),C(()=>i().line)??""})`),K(L,(we(i()),C(()=>i().summary)))}),P("click",m,()=>{var W;return(W=s())==null?void 0:W({file:i().file,line:i().line})}),P("keydown",m,n),O(l,c)};ue(r,l=>{i()!=null&&l(a)})}O(e,o),le()}var yh=V('<div class="transmit svelte-19tsd"><p class="svelte-19tsd"><span class="clickable svelte-19tsd"> </span> </p></div>'),xh=V('<div class="profile svelte-19tsd"><!></div>');function Co(e,t){ae(t,!1);let i=J(t,"profile",8),s=J(t,"open",8);function n(l){l.key!="Escape"&&l.key!="Esc"&&l.stopPropagation()}de();var o=xh(),r=R(o);{var a=l=>{var c=yh(),h=R(c),u=R(h),m=R(u),v=B(u);oe(()=>{K(m,(we(i()),C(()=>i().pin))),K(v,` ${we(i()),C(()=>i().file)??""} (${we(i()),C(()=>i().line)??""})`)}),P("click",u,()=>{var w;return(w=s())==null?void 0:w({file:i().file,line:i().line})}),P("keydown",u,n),O(l,c)};ue(r,l=>{i()!=null&&l(a)})}O(e,o),le()}var bh=V('<div class="pin svelte-1q31bqr"><p class="svelte-1q31bqr">Handlers and parameters</p></div> <!>',1),kh=V('<div class="pin svelte-1q31bqr"><p class="svelte-1q31bqr">Handler and parameters:</p></div> <!>',1),_h=V('<div class="pin svelte-1q31bqr"><p class="svelte-1q31bqr">Send locactions</p></div> <!>',1);function Th(e,t){ae(t,!1);let i=J(t,"tx",8),s=z({div:null,pos:null,title:"",ok:null,cancel:null});fe(()=>{i().send("modal div",d(s).div)});let n=z(null),o=z(null),r=z(null);const a={"-> show"({pos:c,pin:h,profile:u,open:m=null}){j(s,d(s).title=h.is.left?(h.is.input?"  ":"  ")+h.name:h.name+(h.is.input?"  ":"  ")),I(o,h),I(n,u),I(r,m),d(s).show(c)}};var l={handlers:a};return de(),bt(e,{get box(){return d(s)},children:(c,h)=>{var u=Qe(),m=he(u);{var v=y=>{var b=Qe(),N=he(b);{var L=M=>{var _=bh(),A=B(he(_),2);gt(A,1,()=>d(n),pt,(q,re)=>{No(q,{get profile(){return d(re)},get open(){return d(r)}})}),O(M,_)},W=M=>{var _=kh(),A=B(he(_),2);No(A,{get profile(){return d(n)},get open(){return d(r)}}),O(M,_)};ue(N,M=>{d(n),C(()=>Array.isArray(d(n)))?M(L):M(W,!1)})}O(y,b)},w=y=>{var b=_h(),N=B(he(b),2);{var L=M=>{var _=Qe(),A=he(_);gt(A,1,()=>d(n),pt,(q,re)=>{Co(q,{get profile(){return d(re)},get open(){return d(r)}})}),O(M,_)},W=M=>{Co(M,{get profile(){return d(n)},get open(){return d(r)}})};ue(N,M=>{d(n),C(()=>Array.isArray(d(n)))?M(L):M(W,!1)})}O(y,b)};ue(m,y=>{d(o),C(()=>{var b;return(b=d(o))==null?void 0:b.is.input})?y(v):y(w,!1)})}O(c,u)},$$slots:{default:!0}}),Ce(t,"handlers",a),le(l)}var Ph=V('<p class="svelte-sxqikf"> </p>');function Sh(e,t){ae(t,!1);let i=J(t,"tx",8),s={div:null,pos:null,title:"",ok:null,cancel:null},n=z("");fe(async()=>{i().send("modal div",s.div)});const o={"-> show"({title:a,message:l,pos:c,ok:h,cancel:u}){const m=this.popup.box;m.title=a,I(n,l),m.show(c)}};var r={handlers:o};return de(),bt(e,{get box(){return s},children:(a,l)=>{var c=Ph(),h=R(c);oe(()=>K(h,d(n))),O(a,c)},$$slots:{default:!0}}),Ce(t,"handlers",o),le(r)}var Lh=V('<div class="input-field svelte-1c2zphc"><label class="svelte-1c2zphc"> </label> <input type="text" spellcheck="false" class="svelte-1c2zphc"/></div>');function Ys(e,t){ae(t,!1);let i=J(t,"label",8),s=J(t,"input",12),n=J(t,"style",8),o=J(t,"check",8),r=z(),a="f"+Math.floor((1+Math.random())*65536).toString(16).substring(1);const l=()=>{j(r,d(r).style.width="0px"),j(r,d(r).style.width=d(r).scrollWidth+2+"px")};let c=null;const h="#ff0000";fe(()=>{c=d(r).style.color,l()});function u(b){l(),o()&&j(r,d(r).style.color=o()(b.target.value)?c:h)}Jl(()=>d(r),()=>{d(r)&&l()}),Gl(),de();var m=Lh(),v=R(m),w=R(v),y=B(v,2);Te(y,b=>I(r,b),()=>d(r)),oe(()=>{ie(v,"for",a),vt(v,n()),K(w,i()),ie(y,"id",a)}),Es(y,s),P("input",y,u),P("click",y,u),O(e,m),le()}var Nh=V("<!> <!>",1);function Ch(e,t){ae(t,!1);let i=J(t,"tx",8),s=z({div:null,pos:null,title:"",ok:null,cancel:null}),n=z(""),o=z(""),r="";function a(h){var u;return r?(u=r.test)==null?void 0:u.call(r,h):!0}fe(()=>{i().send("modal div",d(s).div)});const l={onNameAndPath({title:h,pos:u,name:m,path:v,regex:w,ok:y,cancel:b,open:N,trash:L}){j(s,d(s).title=h),j(s,d(s).pos={...u}),j(s,d(s).ok=()=>{y==null||y(d(n),d(o))}),j(s,d(s).cancel=b?()=>b():null),j(s,d(s).open=W=>{N==null||N(d(n),d(o)),d(s).hide()}),j(s,d(s).trash=L?()=>L():null),I(n,m),I(o,v),r=w,d(s).show(u)}};var c={handlers:l};return de(),bt(e,{get box(){return d(s)},children:(h,u)=>{var m=Nh(),v=he(m);Ys(v,{label:"Name",style:"width: 3rem;",check:null,get input(){return d(n)},set input(y){I(n,y)},$$legacy:!0});var w=B(v,2);Ys(w,{label:"Path",style:"width: 3rem;",check:a,get input(){return d(o)},set input(y){I(o,y)},$$legacy:!0}),O(h,m)},$$slots:{default:!0}}),Ce(t,"handlers",l),le(c)}function Rh(e,t){ae(t,!1);let i=J(t,"tx",8),s=z({div:null,pos:null,title:"",ok:null,cancel:null}),n=z();function o(l){return!0}fe(()=>{i().send("modal div",d(s).div)});const r={"-> path"({title:l,path:c,pos:h,ok:u,cancel:m}){j(s,d(s).title=l),j(s,d(s).pos={...h}),j(s,d(s).ok=u?()=>u(d(n)):null),j(s,d(s).cancel=m?()=>m():null),I(n,c),d(s).show()}};var a={handlers:r};return de(),bt(e,{get box(){return d(s)},children:(l,c)=>{Ys(l,{label:"Path :",style:"width: 2rem;",check:o,get input(){return d(n)},set input(h){I(n,h)},$$legacy:!0})},$$slots:{default:!0}}),Ce(t,"handlers",r),le(a)}function Eh(e,t){ae(t,!1);let i=J(t,"tx",8),s=z({div:null,pos:null,title:"",ok:null,cancel:null}),n=z("");fe(()=>{i().send("modal div",d(s).div)});const o={"-> show"({label:a,value:l,pos:c,ok:h,cancel:u}){j(s,d(s).title=a),j(s,d(s).pos={...c}),j(s,d(s).ok=h?()=>h(d(n)):null),j(s,d(s).cancel=u?()=>u():null),I(n,l),d(s).show(d(s).pos)}};var r={handlers:o};return de(),bt(e,{get box(){return d(s)},children:(a,l)=>{Xr(a,{style:null,check:null,get text(){return d(n)},set text(c){I(n,c)},$$legacy:!0})},$$slots:{default:!0}}),Ce(t,"handlers",o),le(r)}var Mh=V('<div class="input-field svelte-91i3te"><label class="svelte-91i3te"> </label> <input type="text" spellcheck="false" readonly="" class="svelte-91i3te"/></div>');function Ds(e,t){ae(t,!1);let i=J(t,"label",8),s=J(t,"info",12),n=J(t,"style",8),o="f"+Math.floor((1+Math.random())*65536).toString(16).substring(1);fe(()=>{}),de();var r=Mh(),a=R(r),l=R(a),c=B(a,2);oe(()=>{ie(a,"for",o),vt(a,n()),K(l,i()),ie(c,"id",o)}),Es(c,s),O(e,r),le()}var Ah=V('<div class="color-field svelte-1uxeram"><label class="svelte-1uxeram"> </label> <input type="color" class="svelte-1uxeram"/></div>');function Dh(e,t){ae(t,!1);let i=J(t,"label",8),s=J(t,"style",8),n=J(t,"color",12),o=J(t,"onColor",8),r=z(),a="f"+Math.floor((1+Math.random())*65536).toString(16).substring(1);fe(()=>{});function l(v){var w;(w=o())==null||w(n())}de();var c=Ah(),h=R(c),u=R(h),m=B(h,2);Te(m,v=>I(r,v),()=>d(r)),oe(()=>{ie(h,"for",a),vt(h,s()),K(u,i()),ie(m,"id",a)}),Es(m,n),P("input",m,l),O(e,c),le()}var Oh=V("<!> <!> <!> <!> <!> <!>",1);function Ih(e,t){ae(t,!1);let i=J(t,"tx",8),s=z({div:null,pos:null,title:"",ok:null,cancel:null}),n=z(),o=z(),r=z(),a=z(),l=z(),c=z(),h=z();fe(()=>{i().send("modal div",d(s).div)});const u={"-> show"({title:v,path:w,settings:y,pos:b,ok:N,cancel:L,onColor:W}){j(s,d(s).title=v),j(s,d(s).pos={...b}),j(s,d(s).ok=N?()=>N(d(c)):null),j(s,d(s).cancel=L?()=>L():null),I(n,w),I(r,y.version),I(o,y.created),I(a,y.saved),I(c,y.runtime),I(l,y.style.rgb),I(h,W),d(s).show(b)}};var m={handlers:u};return de(),bt(e,{get box(){return d(s)},children:(v,w)=>{var y=Oh(),b=he(y);Ds(b,{label:"File:",style:"width: 6rem;",get info(){return d(n)}});var N=B(b,2);Ds(N,{label:"Vmblu Version:",style:"width: 6rem;",get info(){return d(r)}});var L=B(N,2);Ds(L,{label:"Creation Date:",style:"width: 6rem;",get info(){return d(o)}});var W=B(L,2);Ds(W,{label:"Last Saved:",style:"width: 6rem;",get info(){return d(a)}});var M=B(W,2);Ys(M,{label:"Runtime",style:"width: 6rem;",check:null,get input(){return d(c)},set input(A){I(c,A)},$$legacy:!0});var _=B(M,2);Dh(_,{label:"Node Color:",style:"width: 6rem;",get color(){return d(l)},get onColor(){return d(h)}}),O(v,y)},$$slots:{default:!0}}),Ce(t,"handlers",u),le(m)}const Oi=20;function ri(e){return e}function Qr(e){this.tx=e,this.cols=[],this.xyLocal={x:0,y:0}}Qr.prototype={init(e){this.cols=[];let t=0,i=Oi;for(const s of e.values()){if(!s.is.selectable||!s.raw)return;const n=s.raw.root.nodes?s.raw.root.nodes.length:1;n>i&&i<Oi&&(t++,i=Oi),i-=n}for(t++;t-- >0;)this.cols.push([])},fill(e){const t=this.cols;let i=0,s=Oi;for(const n of e.values()){if(!n.is.selectable||!n.raw)return;const o=n.raw.root.nodes?n.raw.root.nodes.length:1;if(o>s&&s<Oi&&(i++,s=Oi),s-=o,t[i].push({nextModel:!0,model:n,expanded:!0}),n.raw.root.nodes)for(const r of n.raw.root.nodes)t[i].push({model:n,node:r,expanded:!1});else t[i].push({model:n,node:n.raw.root,expanded:!1})}},onRemoveLib(e){var n,o,r;const t=(n=e.target.parentNode.dataset)==null?void 0:n.col,i=(o=e.target.parentNode.dataset)==null?void 0:o.node,s=(r=this.cols[t])==null?void 0:r[i];s!=null&&s.nextModel&&this.tx.send("remove file",{model:s.model})},addLib(e){const t={x:e.screenX,y:e.screenY};this.tx.send("get path",{title:"add file to node library",path:null,pos:t,ok:i=>{this.tx.send("add file",i)},cancel:null})},onSelect(e,t){var h,u,m;t.hide();const i=(h=e.target.parentNode.dataset)==null?void 0:h.col,s=(u=e.target.parentNode.dataset)==null?void 0:u.node,n=(m=e.target.parentNode.dataset)==null?void 0:m.sub,o=this.cols[i][s].model;let r="",a=this.cols[i][s].node;if(n&&(r=a.group,a=a.nodes.find((v,w)=>w==n)),!a)return;const l=a.source??a.group??a.dock,c=r.length==0?l:r+"|"+l;this.tx.send("selected node",{model:o,nodePath:c,xyLocal:this.xyLocal})},onArrowClick(e){var s,n;const t=(s=e.target.parentNode.dataset)==null?void 0:s.col,i=(n=e.target.parentNode.dataset)==null?void 0:n.node;this.cols[t][i].expanded=!this.cols[t][i].expanded}};var Fh=V('<i class="material-icons-outlined lib lib-js svelte-19avbiy">cancel</i> <p class="lib lib-js svelte-19avbiy"> </p>',1),Wh=V('<i class="material-icons-outlined lib lib-json svelte-19avbiy">cancel</i> <p class="lib lib-json svelte-19avbiy"> </p>',1),Hh=V('<div class="arl svelte-19avbiy"><!></div>'),Bh=V('<p class="node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">factory</i> <span class="node-name svelte-19avbiy"> </span></p>'),$h=V('<p class="node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">factory</i> <span class="node-name svelte-19avbiy"> </span></p>'),jh=V('<p class="sub-node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">factory</i> <span class="node-name svelte-19avbiy"> </span></p>'),Vh=V('<p class="sub-node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">account_tree</i> <span class="node-name svelte-19avbiy"> </span></p>'),Uh=V('<p class="sub-node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">account_tree</i> <span class="node-name svelte-19avbiy"> </span></p>'),zh=V('<p class="node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">account_tree</i> <span class="node-name svelte-19avbiy"> </span> <span class="arrow svelte-19avbiy"><!></span></p> <!>',1),qh=V('<p class="node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">account_tree</i> <span class="node-name svelte-19avbiy"> </span> <span class="arrow svelte-19avbiy"><!></span></p>'),Jh=V('<div class="column svelte-19avbiy"></div>'),Gh=V('<div class="content svelte-19avbiy"></div>');function Yh(e,t){ae(t,!1);let i=J(t,"tx",8),s=z(new Qr(i()));const n="&#9656;",o="&#9662;";let r={div:null,title:"Select Node",pos:null,ok:null,cancel:null,add:v=>d(s).addLib(v)};fe(async()=>{i().send("modal div",r.div)});const a={onBuildTable(v){var w;d(s).init(v),d(s).fill(v),((w=r.div)==null?void 0:w.style.display)=="block"&&I(s,d(s))},onShow({xyScreen:v,xyLocal:w}){j(s,d(s).xyLocal.x=w.x),j(s,d(s).xyLocal.y=w.y),r.show({x:v.x+10,y:v.y+10})}};function l(v){}function c(v){d(s).onRemoveLib(v),I(s,d(s))}function h(v){d(s).onSelect(v,r),I(s,d(s))}function u(v){d(s).onArrowClick(v),I(s,d(s))}var m={handlers:a};return de(),bt(e,{get box(){return r},children:(v,w)=>{var y=Gh();gt(y,5,()=>(d(s),C(()=>d(s).cols)),pt,(b,N,L)=>{var W=Jh();gt(W,5,()=>d(N),pt,(M,_,A)=>{var q=Qe(),re=he(q);{var me=ve=>{var pe=Hh();ie(pe,"data-col",L),ie(pe,"data-node",A);var Ve=R(pe);{var Oe=T=>{var X=Fh(),ee=he(X),ye=B(ee,2),D=R(ye);oe(G=>K(D,G),[()=>(d(_),C(()=>d(_).model.arl.getName()))]),P("click",ee,c),P("keydown",ee,l),O(T,X)},U=T=>{var X=Wh(),ee=he(X),ye=B(ee,2),D=R(ye);oe(G=>K(D,G),[()=>(d(_),C(()=>d(_).model.arl.getName()))]),P("click",ee,c),P("keydown",ee,l),O(T,X)};ue(Ve,T=>{d(_),C(()=>{var X;return((X=d(_).model.arl)==null?void 0:X.getExt())==="js"})?T(Oe):T(U,!1)})}O(ve,pe)},Re=ve=>{var pe=Qe(),Ve=he(pe);{var Oe=U=>{var T=Qe(),X=he(T);{var ee=D=>{var G=Bh();ie(G,"data-col",L),ie(G,"data-node",A);var te=R(G),Ge=B(te,2),lt=R(Ge);oe(Ie=>K(lt,Ie),[()=>(we(ri),d(_),C(()=>d(_).node.source))]),P("click",te,h),P("keydown",te,l),P("click",Ge,h),P("keydown",Ge,l),O(D,G)},ye=D=>{var G=Qe(),te=he(G);{var Ge=Ie=>{var Ye=$h();ie(Ye,"data-col",L),ie(Ye,"data-node",A);var Ft=R(Ye),ii=B(Ft,2),si=R(ii);oe(kt=>K(si,kt),[()=>(we(ri),d(_),C(()=>d(_).node.dock))]),P("click",Ft,h),P("keydown",Ft,l),P("click",ii,h),P("keydown",ii,l),O(Ie,Ye)},lt=Ie=>{var Ye=Qe(),Ft=he(Ye);{var ii=si=>{var kt=Qe(),xa=he(kt);{var ba=Ci=>{var ni=zh(),jt=he(ni);ie(jt,"data-col",L),ie(jt,"data-node",A);var Vt=R(jt),Ri=B(Vt,2),ns=R(Ri),os=B(Ri,2),yn=R(os);bo(yn,()=>o);var _a=B(jt,2);gt(_a,1,()=>(d(_),C(()=>d(_).node.nodes)),pt,(xn,et,bn)=>{var ro=Qe(),Ta=he(ro);{var Pa=Ei=>{var Ut=jh();ie(Ut,"data-col",L),ie(Ut,"data-node",A),ie(Ut,"data-sub",bn);var rs=R(Ut),as=B(rs,2),kn=R(as);oe(zt=>K(kn,zt),[()=>(we(ri),d(et),C(()=>d(et).source))]),P("click",rs,h),P("keydown",rs,l),P("click",as,h),P("keydown",as,l),O(Ei,Ut)},Sa=Ei=>{var Ut=Qe(),rs=he(Ut);{var as=zt=>{var qt=Vh();ie(qt,"data-col",L),ie(qt,"data-node",A),ie(qt,"data-sub",bn);var ls=R(qt),cs=B(ls,2),hs=R(cs);oe(oi=>K(hs,oi),[()=>(we(ri),d(et),C(()=>d(et).group))]),P("click",ls,h),P("keydown",ls,l),P("click",cs,h),P("keydown",cs,l),O(zt,qt)},kn=zt=>{var qt=Qe(),ls=he(qt);{var cs=hs=>{var oi=Uh();ie(oi,"data-col",L),ie(oi,"data-node",A),ie(oi,"data-sub",bn);var _n=R(oi),Tn=B(_n,2),La=R(Tn);oe(Na=>K(La,Na),[()=>(we(ri),d(et),C(()=>d(et).dock))]),P("click",_n,h),P("keydown",_n,l),P("click",Tn,h),P("keydown",Tn,l),O(hs,oi)};ue(ls,hs=>{d(et),C(()=>d(et).dock)&&hs(cs)},!0)}O(zt,qt)};ue(rs,zt=>{d(et),C(()=>d(et).group)?zt(as):zt(kn,!1)},!0)}O(Ei,Ut)};ue(Ta,Ei=>{d(et),C(()=>d(et).source)?Ei(Pa):Ei(Sa,!1)})}O(xn,ro)}),oe(xn=>K(ns,xn),[()=>(we(ri),d(_),C(()=>d(_).node.group))]),P("click",Vt,h),P("keydown",Vt,l),P("click",Ri,u),P("keydown",Ri,l),P("click",os,u),P("keydown",os,l),O(Ci,ni)},ka=Ci=>{var ni=qh();ie(ni,"data-col",L),ie(ni,"data-node",A);var jt=R(ni),Vt=B(jt,2),Ri=R(Vt),ns=B(Vt,2),os=R(ns);bo(os,()=>n),oe(yn=>K(Ri,yn),[()=>(we(ri),d(_),C(()=>d(_).node.group))]),P("click",jt,h),P("keydown",jt,l),P("click",Vt,u),P("keydown",Vt,l),P("click",ns,u),P("keydown",ns,l),O(Ci,ni)};ue(xa,Ci=>{d(_),C(()=>d(_).expanded)?Ci(ba):Ci(ka,!1)})}O(si,kt)};ue(Ft,si=>{d(_),C(()=>d(_).node.group)&&si(ii)},!0)}O(Ie,Ye)};ue(te,Ie=>{d(_),C(()=>d(_).node.dock)?Ie(Ge):Ie(lt,!1)},!0)}O(D,G)};ue(X,D=>{d(_),C(()=>d(_).node.source)?D(ee):D(ye,!1)})}O(U,T)};ue(Ve,U=>{d(_),C(()=>d(_).node)&&U(Oe)},!0)}O(ve,pe)};ue(re,ve=>{d(_),C(()=>d(_).nextModel)?ve(me):ve(Re,!1)})}O(M,q)}),O(b,W)}),O(v,y)},$$slots:{default:!0}}),Ce(t,"handlers",a),le(m)}function De(e,t=null){return function(i,s){return Vr(e,{target:t??document.createElement("div"),props:{tx:i,sx:s}}).handlers}}const Xh=De(Bc),Kh=De(jc,document.body),Qh=De(qc),Zh=De(Yc),ed=De(lh),td=De(ch),Ro=De(uh),id=De(ph),sd=De(gh),nd=De(Th),od=De(Sh),rd=De(Ch),Eo=De(Rh),ad=De(Eh),ld=De(Ih),cd=De(Yh),H={_roundedRect(e,t,i,s,n,o){e.moveTo(t,i+o),e.arcTo(t,i+n,t+o,i+n,o),e.arcTo(t+s,i+n,t+s,i+n-o,o),e.arcTo(t+s,i,t+s-o,i,o),e.arcTo(t,i,t,i+o,o)},rectRect(e,t,i,s,n,o,r){r&&(e.fillStyle=r,e.fillRect(t,i,s,n)),o&&(e.strokeStyle=o,e.strokeRect(t,i,s,n))},diamond(e,t,i,s,n,o){e.beginPath(),e.fillStyle=o,e.moveTo(t+s/2,i),e.lineTo(t+s,i+n/2),e.lineTo(t+s/2,i+n),e.lineTo(t,i+n/2),e.lineTo(t+s/2,i),e.fill()},viewTitle(e,t,i,s,n,o){e.fillStyle=n,e.fillText(o,t+s*.5,i+s*.75)},viewRect(e,t,i,s,n,o,r,a,l){const c=Math.PI;e.beginPath(),e.lineWidth=r,e.moveTo(t,i+o),e.arc(t+o,i+o,o,c,-c/2),e.lineTo(t+s-o,i),e.arc(t+s-o,i+o,o,-c/2,0),e.lineTo(t+s,i+n-o),e.arc(t+s-o,i+n-o,o,0,c/2),e.lineTo(t+o,i+n),e.arc(t+o,i+n-o,o,c/2,c),e.lineTo(t,i+o),e.moveTo(t+s,i+n-o),e.lineTo(t+s-o,i+n),l&&(e.fillStyle=l,e.fill()),a&&(e.strokeStyle=a,e.stroke())},roundedRect(e,t,i,s,n,o,r,a,l){const c=Math.PI;e.beginPath(),e.lineWidth=r,e.moveTo(t,i+o),e.arc(t+o,i+o,o,c,-c/2),e.lineTo(t+s-o,i),e.arc(t+s-o,i+o,o,-c/2,0),e.lineTo(t+s,i+n-o),e.arc(t+s-o,i+n-o,o,0,c/2),e.lineTo(t+o,i+n),e.arc(t+o,i+n-o,o,c/2,c),e.lineTo(t,i+o),l&&(e.fillStyle=l,e.fill()),a&&(e.strokeStyle=a,e.stroke())},roundedHeader(e,t,i,s,n,o,r,a,l){const c=Math.PI;e.beginPath(),e.lineWidth=r,e.moveTo(t,i+o),e.arc(t+o,i+o,o,c,-c/2),e.lineTo(t+s-o,i),e.arc(t+s-o,i+o,o,-c/2,0),e.lineTo(t+s,i+n),e.lineTo(t,i+n),e.lineTo(t,i+o),l&&(e.fillStyle=l,e.fill()),a&&(e.strokeStyle=a,e.stroke())},grid(e,t,i,s,n,o,r,a,l){e.beginPath(),e.lineWidth=1,e.strokeStyle=a;const c=i+n;for(let u=i-i%r;u<c;u+=r)e.moveTo(t,u),e.lineTo(t+s,u);const h=t+s;for(let u=t-t%o;u<h;u+=o)e.moveTo(u,i),e.lineTo(u,i+n);e.stroke(),e.beginPath(),e.strokeStyle=l,e.moveTo(t,0),e.lineTo(t+s,0),e.moveTo(0,i),e.lineTo(0,i+n),e.stroke()},bullet(e,t,i,s,n,o){e.beginPath(),e.arc(t,i,s,0,2*Math.PI),o&&(e.fillStyle=o,e.fill()),n&&(e.lineWidth=1,e.strokeStyle=n,e.stroke())},textWidth(e,t){return e.measureText(t).width},fitText(e,t,i){if(e.measureText(t).width<=i)return t;const n="",o=e.measureText(n).width;let r=0,a=t.length,l=0;for(;r<a;){const h=Math.floor((r+a+1)/2),u=t.slice(0,h);e.measureText(u).width+o<=i?(l=h,r=h):a=h-1}return t.slice(0,l)+n},labelText(e,t,i,s,n,o,r,a){const l=e.font;e.font=i,e.fillStyle=s,e.fillText(t,n,o+.5*a),e.font=l},labelCursor(e,t,i,s,n,o,r){let a=e.measureText(t.slice(0,r)).width;return{x:i+a+1,y:s-.25*o}},leftText(e,t,i,s,n,o,r){e.fillStyle=i,e.fillText(t,s,n+.75*r)},rightText(e,t,i,s,n,o,r){e.fillStyle=i;let a=e.measureText(t).width;e.fillText(t,s+o-a,n+.75*r)},rightTextMulti(e,t,i,s,n,o,r,a){e.fillStyle=s,o+=.75*a;const l=t.indexOf("["),c=t.indexOf("]"),h=t.slice(0,l+1),u=t.slice(l+1,c),m=t.slice(c),v=e.font,w=e.measureText(h).width,y=e.measureText(m).width;e.font=i;const b=e.measureText(u).width;e.font=v,n=n+r-w-b-y,e.fillText(h,n,o),e.font=i,n+=w,e.fillText(u,n,o),e.font=v,n+=b,e.fillText(m,n,o)},leftTextMulti(e,t,i,s,n,o,r,a){e.fillStyle=s,e.fillStyle=s,o+=.75*a;const l=t.indexOf("["),c=t.indexOf("]"),h=t.slice(0,l+1),u=t.slice(l+1,c),m=t.slice(c),v=e.font,w=e.measureText(h).width;e.font=i;const y=e.measureText(u).width;e.font=v,e.fillText(h,n,o),e.font=i,n+=w,e.fillText(u,n,o),e.font=v,n+=y,e.fillText(m,n,o)},centerText(e,t,i,s,n,o,r,a){const l=e.font;e.font=i,e.fillStyle=s;let c=e.measureText(t);e.fillText(t,n+(r-c.width)/2,o+.75*a),e.font=l},centerLineText(e,t,i,s,n,o,r,a){e.beginPath(),e.fillStyle=i,e.strokeStyle=s;const l=e.measureText(t),c=5;e.moveTo(n,o+a/2),e.lineTo(n+(r-l.width)/2-c,o+a/2),e.moveTo(n+(r+l.width)/2+c,o+a/2),e.lineTo(n+r,o+a/2),e.stroke(),e.fillText(t,n+(r-l.width)/2,o+.75*a)},interfaceText(e,t,i,s,n,o,r,a,l){e.beginPath();const c=e.font;e.font=i,e.strokeStyle=n;const h=e.measureText(t),u=5;e.moveTo(o,r+l/2),e.lineTo(o+(a-h.width)/2-u,r+l/2),e.moveTo(o+(a+h.width)/2+u,r+l/2),e.lineTo(o+a,r+l/2),e.stroke(),e.fillStyle=s,e.fillText(t,o+(a-h.width)/2,r+.75*l),e.font=c},centerTextCursor(e,t,i,s){let n=t.x+t.w/2-e.measureText(i).width/2,o=e.measureText(i.slice(0,s)).width;return{x:n+o+1,y:t.y}},leftTextCursor(e,t,i,s,n,o,r){let a=e.measureText(t.slice(0,r)).width;return{x:i+a+1,y:s}},rightTextCursor(e,t,i,s,n,o,r){let a=e.measureText(t.slice(0,r)).width;return{x:i+n-e.measureText(t).width+a,y:s}},cursor(e,t,i,s,n,o){e.fillStyle=o,e.fillRect(t,i,s,n)},bulletRect(e,t,i,s,n,o,r){e.beginPath(),e.fillStyle=o,e.fillRect(t+r,i,s,n),e.arc(t+r,i+n/2,r,Math.PI/2,-Math.PI/2),e.fill()},rectBullet(e,t,i,s,n,o,r){e.beginPath(),e.fillStyle=o,e.fillRect(t,i,s-r,n),e.arc(t+s-r,i+n/2,r,-Math.PI/2,Math.PI/2),e.fill()},corner(e,t,i,s,n,o,r,a){e.beginPath(),e.fillStyle=a,i?(e.moveTo(s,n),e.lineTo(s+o,n+r),e.arc(s+o/2,n+r/2,o/2,Math.PI/2,Math.PI),e.lineTo(s,n)):(e.moveTo(s,n+r),e.lineTo(s+o,n),e.arc(s+o/2,n+r/2,o/2,0,Math.PI/2),e.lineTo(s,n+r)),e.fill()},leftTriangle(e,t,i,s,n,o){e.beginPath(),e.fillStyle=o,e.moveTo(t,i+n/2),e.lineTo(t+s,i+n),e.lineTo(t+s,i),e.lineTo(t,i+n/2),e.fill()},rightTriangle(e,t,i,s,n,o){e.beginPath(),e.fillStyle=o,e.moveTo(t,i),e.lineTo(t,i+n),e.lineTo(t+s,i+n/2),e.lineTo(t,i),e.fill()},triangleBall(e,t,i,s,n,o){const a=n/2;e.beginPath(),e.fillStyle=o,e.moveTo(t,i+a),e.lineTo(t+s,i+n),e.lineTo(t+s,i),e.lineTo(t,i+a),e.arc(t+s+3,i+a,3,0,2*Math.PI),e.fill()},ballTriangle(e,t,i,s,n,o){const a=n/2;e.beginPath(),e.fillStyle=o,e.moveTo(t,i),e.lineTo(t,i+n),e.lineTo(t+s,i+a),e.lineTo(t,i),e.arc(t-3,i+a,3,0,2*Math.PI),e.fill()},triangle(e,t,i,s,n,o,r){switch(e.beginPath(),e.fillStyle=r,o){case"up":e.moveTo(t,i+n),e.lineTo(t+s,i+n),e.lineTo(t+s/2,i),e.lineTo(t,i+n);break;case"down":e.moveTo(t,i),e.lineTo(t+s/2,i+n),e.lineTo(t+s,i),e.lineTo(t,i);break;case"left":e.moveTo(t,i+n/2),e.lineTo(t+s,i+n),e.lineTo(t+s,i),e.lineTo(t,i+n/2);break;case"right":e.moveTo(t,i),e.lineTo(t,i+n),e.lineTo(t+s,i+n/2),e.lineTo(t,i);break}e.fill()},tack(e,t,i,s,n,o,r){e.beginPath(),e.fillStyle=r;let{x:a,y:l,w:c,h}=n;const u=3;let m=a+c/2,v=l+h/2;switch(t){case"up":e.moveTo(a,l+h),e.lineTo(a+c,l+h),e.lineTo(a+(c+o)/2,l),e.lineTo(a+(c-o)/2,l),e.lineTo(a,l+h),i&&(v=s?l-u:l+h+u);break;case"down":e.moveTo(a,l),e.lineTo(a+(c-o)/2,l+h),e.lineTo(a+(c+o)/2,l+h),e.lineTo(a+c,l),e.lineTo(a,l),i&&(v=s?l+h+u:l-u);break;case"left":e.moveTo(a,l+(h-o)/2),e.lineTo(a,l+(h+o)/2),e.lineTo(a+c,l+h),e.lineTo(a+c,l),e.lineTo(a,l+(h-o)/2),i&&(m=s?a-u:a+c+u);break;case"right":e.moveTo(a,l),e.lineTo(a,l+h),e.lineTo(a+c,l+(h+o)/2),e.lineTo(a+c,l+(h-o)/2),e.lineTo(a,l),i&&(m=s?a+c+u:a-u);break}i&&e.arc(m,v,u,0,2*Math.PI),e.fill()},filterSign(e,t,i,s){let n=t.x-i/2,o=t.y-i/2;e.fillStyle=s,e.fillRect(n,o,i,i),e.fillStyle="#000000",e.fillRect(n+2,o+2,i-4,i-4)},hBusbarLabel(e,t,i,s,n,o,r,a,l){e.beginPath(),e.fillStyle=a,H._roundedRect(e,i,s,n,o,r),e.fill(),e.fillStyle=l,e.fillText(t,i+n/2-e.measureText(t).width/2,s+.75*o)},vBusbarLabel(e,t,i,s,n,o,r,a,l){e.beginPath(),e.fillStyle=a,H._roundedRect(e,i,s,n,o,r),e.fill(),e.save(),e.translate(i,s),e.rotate(-Math.PI/2),e.fillStyle=l,e.fillText(t,-o/2-e.measureText(t).width/2,.75*n),e.restore()},wirelessSymbol(e,t,i,s,n){e.beginPath(),e.strokeStyle=n;let o=t-2,r=i-2;e.moveTo(o-s-4,r),e.arc(o,r,s+4,Math.PI,-Math.PI/2),e.moveTo(o-s,r),e.arc(o,r,s,Math.PI,-Math.PI/2),e.moveTo(o-s+4,r),e.arc(o,r,s-4,Math.PI,-Math.PI/2),e.stroke()},filterSymbol(e,t,i,s,n){e.beginPath(),e.strokeStyle=n;const o=s/3,r=s/2;e.moveTo(t,i),e.lineTo(t+s,i),e.lineTo(t+s-o,i+r),e.lineTo(t+s-o,i+s),e.lineTo(t+o,i+s),e.lineTo(t+o,i+r),e.lineTo(t,i),e.stroke()},hCableLabel(e,t,i,s,n,o,r,a,l){e.beginPath(),e.fillStyle=a,H._roundedRect(e,i-2,s-2,n+4,o+4,r+2),e.fill(),e.beginPath(),e.strokeStyle=l,H._roundedRect(e,i,s,n,o,r),e.stroke(),e.fillStyle=l,e.fillText(t,i+n/2-e.measureText(t).width/2,s+.75*o)},vCableLabel(e,t,i,s,n,o,r,a,l){e.beginPath(),e.fillStyle=a,H._roundedRect(e,i-2,s-2,n+4,o+4,r+2),e.fill(),e.beginPath(),e.strokeStyle=l,H._roundedRect(e,i,s,n,o,r),e.stroke(),e.save(),e.translate(i,s),e.rotate(-Math.PI/2),e.fillStyle=l,e.fillText(t,-o/2-e.measureText(t).width/2,.75*n),e.restore()},drawBusbar(e,t,i,s){const n=e.lineWidth;if(!(t.len<2)){e.beginPath(),e.lineWidth=s,e.strokeStyle=i,e.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)e.lineTo(t[o].x,t[o].y);e.stroke(),e.lineWidth=n}},drawCable(e,t,i,s){if(t.len<2)return;const n=e.lineWidth;e.beginPath(),e.lineWidth=s,e.strokeStyle=i,e.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)e.lineTo(t[o].x,t[o].y);e.stroke(),e.lineWidth=s-4,e.strokeStyle="#000000",e.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)e.lineTo(t[o].x,t[o].y);e.stroke(),e.lineWidth=s-6,e.strokeStyle=i,e.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)e.lineTo(t[o].x,t[o].y);e.stroke(),e.lineWidth=n},drawPoints(e,t){let i=t.length;if(i<2)return;const s=7.5,n=15;e.moveTo(t[0].x,t[0].y);for(let o=0;o<i-1;o++){const r=t[o],a=t[o+1];Math.abs(r.y-a.y)>=n||Math.abs(r.x-a.x)>=n?e.arcTo(r.x,r.y,a.x,a.y,s):(e.lineTo(r.x,r.y),e.lineTo(a.x,a.y))}e.lineTo(t[i-1].x,t[i-1].y),e.stroke()},drawWire(e,t,i,s){e.beginPath(),e.lineWidth=i,e.strokeStyle=t,this.drawPoints(e,s)},twistedPair(e,t,i,s){e.beginPath(),e.strokeStyle=t,e.lineWidth=2*i,this.drawPoints(e,s)}},tt={close(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=s/2;e.arc(t+r,i+r,r,0,2*Math.PI);const a=2;e.moveTo(t+a,i+a),e.lineTo(t+s-a,i+s-a),e.moveTo(t+s-a,i+a),e.lineTo(t+a,i+s-a),e.stroke()},bigView(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2,e.rect(t,i,s,n),e.stroke()},smallView(e,t,i,s,n,o){e.beginPath(),e.fillStyle=o,e.rect(t+2,i+2,s-4,n-4),e.fill()},xbigView(e,t,i,s,n,o){e.beginPath();const r=n/2,a=s/2;e.strokeStyle=o,e.lineWidth=2,e.rect(t,i,a-1,r),e.rect(t+a+1,i+r,a-1,r),e.stroke()},calibrate(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=s/2,a=1;e.arc(t+r,i+r,r-1,0,2*Math.PI),e.moveTo(t-a,i+r),e.lineTo(t+s+a,i+r),e.moveTo(t+r,i-a),e.lineTo(t+r,i+s+a),e.stroke()},grid(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=s/3;e.moveTo(t+r,i),e.lineTo(t+r,i+s),e.moveTo(t+r+r,i),e.lineTo(t+r+r,i+s),e.moveTo(t,i+r),e.lineTo(t+s,i+r),e.moveTo(t,i+r+r),e.lineTo(t+s,i+r+r),e.stroke()},link(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=Math.PI,a=s/3,l=s/2;e.moveTo(t+l+a,i+a),e.arc(t+l,i+a,a,0,r,!0),e.moveTo(t+l-a,i+n-a),e.arc(t+l,i+n-a,a,r,2*r,!0),e.moveTo(t+l,i+n-a),e.lineTo(t+l,i+a),e.stroke()},lock(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=Math.PI,a=s/3,l=s/2;e.moveTo(t+l+a,i+a),e.arc(t+l,i+a,a,0,r,!0),e.rect(t+1,i+a+1,s-2,n-a-1),e.stroke()},cog(e,t,i,s,n,o,r){e.beginPath();const a=s/2,l=n/2,c=s/3,h=Math.PI,u=1,m=2;e.strokeStyle=o,e.lineWidth=2,e.moveTo(t+a,i+u),e.lineTo(t+a,i+n-u),e.moveTo(t,i+l),e.lineTo(t+s,i+l),e.moveTo(t+u,i+m),e.lineTo(t+s-u,i+n-m),e.moveTo(t+s-u,i+m),e.lineTo(t+u,i+n-m),e.stroke(),e.beginPath(),e.fillStyle=r,e.arc(t+a,i+l,c,0,2*h),e.stroke(),e.fill()},factory(e,t,i,s,n,o){e.beginPath();const r=n/4,a=n/2,l=s/2;e.strokeStyle=o,e.lineWidth=2,e.moveTo(t+s,i),e.lineTo(t+s,i+n),e.lineTo(t,i+n),e.lineTo(t,i+r),e.lineTo(t+l,i+a),e.lineTo(t+l,i+r),e.lineTo(t+s,i+a),e.stroke()},group(e,t,i,s,n,o){e.beginPath();const r=n/2,a=s/2;e.strokeStyle=o,e.lineWidth=2,e.rect(t,i+2,a-1,r),e.rect(t+a+1,i+r,a-1,r),e.stroke()},pulse(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=i+n/2+1;e.moveTo(t,r),e.lineTo(t+2,r),e.lineTo(t+4,i),e.lineTo(t+5,i+n),e.lineTo(t+6,r),e.lineTo(t+s,r),e.stroke()},comment(e,t,i,s,n,o){e.beginPath();const r=n/6,a=n/2,l=5*r,c=s/4;e.strokeStyle=o,e.lineWidth=2,e.moveTo(t+c,i+r),e.lineTo(t+3*c,i+r),e.moveTo(t+c,i+a),e.lineTo(t+2*c,i+a),e.moveTo(t+c,i+l),e.lineTo(t+4*c,i+l),e.stroke()}},hd="|",k={rectToString:e=>e?`x ${Math.round(e.x)} y ${Math.round(e.y)} w ${Math.round(e.w)} h ${Math.round(e.h)}`:"x 0 y 0 w 0 h 0",stringToRect:e=>{let t=e.indexOf("x"),i=e.indexOf("y"),s=e.indexOf("w"),n=e.indexOf("h");return{x:parseFloat(e.slice(t+1,i)),y:parseFloat(e.slice(i+1,s)),w:parseFloat(e.slice(s+1,n)),h:parseFloat(e.slice(n+1))}},relativeRect:(e,t)=>`x ${Math.round(e.x-t.x)} y ${Math.round(e.y-t.y)} w ${Math.round(e.w)} h ${Math.round(e.h)}`,transformToString:e=>`sx ${e.sx.toFixed(3)} sy ${e.sy.toFixed(3)} dx ${e.dx.toFixed(3)} dy ${e.dy.toFixed(3)}`,stringToTransform:e=>{let t=e.indexOf("sx"),i=e.indexOf("sy"),s=e.indexOf("dx"),n=e.indexOf("dy");return t<0||i<0||s<0||n<0?{sx:1,sy:1,dx:0,dy:0}:{sx:parseFloat(e.slice(t+2,i)),sy:parseFloat(e.slice(i+2,s)),dx:parseFloat(e.slice(s+2,n)),dy:parseFloat(e.slice(n+2))}},stringToPosition:e=>{const t=e.indexOf(",");if(t<0)return{rect:{x:0,y:0,w:0,h:0},left:!1};const i=k.stringToRect(e.slice(0,t)),s=e.slice(t+1).trim()==="left";return{rect:i,left:s}},stringToUidWid(e){const t=e.indexOf(".");return t<0?[e,0]:[e.slice(0,t),+e.slice(t+1)]},stringToWid(e){const t=e.indexOf(".");return t<0?0:+e.slice(t+1)},stringToId(e){const t=e.indexOf(hd);return{uid:e.slice(0,t),name:e.slice(t+1)}},pointToString(e){return`x ${e.x} y ${e.y}`},stringToPoint(e){const t=e.match(/x\s*(-?\d+\.?\d*)\s*y\s*(-?\d+\.?\d*)/);return t?{x:parseFloat(t[1]),y:parseFloat(t[2])}:null},wireToString:e=>{if(e.length<2)return"";const t=[];for(let i=1;i<e.length;i++){const s=e[i].x-e[i-1].x,n=e[i].y-e[i-1].y;Math.abs(s)>Math.abs(n)?t.push("x "+s.toFixed(1)):t.push("y "+n.toFixed(1))}return t.join(" ")},stringToWire(e,t,i){if(!i||i.length<1)return[];if(e){let{x:s,y:n}={...e},o=[{x:s,y:n}];const r=i.split(" ");for(let a=0;a<r.length;a+=2){const l=r[a],c=parseFloat(r[a+1]);l==="x"?s+=c:n+=c,o.push({x:s,y:n})}return o}if(t){let{x:s,y:n}={...t},o=[{x:s,y:n}];const r=i.split(" ").reverse();for(let a=0;a<r.length;a+=2){const l=r[a+1],c=parseFloat(r[a]);l==="x"?s-=c:n-=c,o.push({x:s,y:n})}return o.reverse()}else return[]},routeToString(e){let t=e.from,i=e.to;const s=l=>`(pin ${l.wid}) ${l.name} @ ${l.node.name}`,n=l=>"(bus) "+l.bus.name,o=l=>`(pad ${l.proxy.wid}) ${l.proxy.name}`,r=()=>{if(i.is.pin)return i.is.input;if(t.is.pin)return!t.is.input;if(i.is.pad)return i.proxy.is.input;if(t.is.pad)return!t.proxy.is.input},a={};return r()?(t.is.pin?a.from=s(t):t.is.pad?a.from=o(t):t.is.tack&&(a.from=n(t)),i.is.pin?a.to=s(i):i.is.pad?a.to=o(i):i.is.tack&&(a.to=n(i)),a.wire=k.wireToString(e.wire)):(i.is.pin?a.from=s(i):i.is.pad?a.from=o(i):i.is.tack&&(a.from=n(i)),t.is.pin?a.to=s(t):t.is.pad?a.to=o(t):t.is.tack&&(a.to=n(t)),a.wire=k.wireToString(e.wire.slice().reverse())),a},rawToEndPoint(e){const t=e.trim().slice(1,4);let i=0,s=0,n=0;switch(t){case"pin":return i=e.indexOf(")"),s=e.slice(4,i).trim(),n=e.indexOf("@"),{pin:e.slice(i+1,n).trim(),wid:s.length>0?+s:0,node:e.slice(n+1).trim()};case"pad":return i=e.indexOf(")"),s=e.slice(4,i).trim(),{pad:e.slice(i+1).trim(),wid:s.length>0?+s:0};case"bus":return{bus:e.slice(5).trim()};case"itf":return{itf:e.slice(5).trim()}}},cleanInput(e){return e.trim().replace(/\s+/g," ").replace(/@|->|=>/g,"")},cleanLink(e){return e.split("@").map(t=>k.cleanInput(t).trim()).filter(t=>t.length>0).join(" @ ")},splitLink(e){return e.split("@").map(t=>t.trim()).filter(t=>t.length>0).reverse()},isMulti:e=>{const t=e.indexOf("["),i=e.lastIndexOf("]");return t>-1&&i>-1&&i>t},extractMultis:e=>{const[t,i]=k.getPreMiddlePost(e);return i.split(",")},expandMultis:e=>{const[t,i,s]=k.getPreMiddlePost(e);return i.split(",").map(o=>t+o+s)},cleanMulti(e){const[t,i,s]=k.getPreMiddlePost(e);return t+"["+i+"]"+s},getPreMiddlePost(e){const t=e.indexOf("["),i=e.lastIndexOf("]");let s=e.slice(0,t).trim(),n=e.slice(t+1,i).split(",").map(l=>l.trim()).filter(Boolean).join(","),o=e.slice(i+1).trim();const r=s.at(-1);s.length>0&&r!="."&&r!="-"&&r!="_"&&(s=s+" ");const a=o[0];return o.length>0&&a!="."&&a!="-"&&a!="_"&&(o=" "+o),[s,n,o]},needsPrefix:e=>{const t=e[0];return t=="+"||t=="."||t=="-"||t=="_"},needsPostfix:e=>{const t=e.at(-1);return t=="+"||t=="."||t=="-"||t=="_"},combineWithPrefix(e,t){let i=t;const s=t[0];if(s=="."||s=="-"||s=="_"){const n=t.slice(1).trim();i=e+s+n}else if(s=="+"){const n=t.slice(1).trim();i=e+" "+n}return i},combineWithPostfix(e,t){let i=t;const s=t.at(-1);return s=="."||s=="-"||s=="_"?i=t.slice(0,-1).trim()+s+e:s=="+"&&(i=t.slice(0,-1).trim()+" "+e),i},prefixMatch(e,t){if(t.startsWith(e)){const i=t[e.length];return i=="."||i=="-"||i==" "||i=="_"}},postfixMatch(e,t){if(t.endsWith(e)){const i=t.at(-e.length-1);return i=="."||i=="-"||i==" "||i=="_"}},xxcombineWithPrefix(e,t){let i=t;if(t[0]=="+"){const s=t.slice(1).trim();s[0]=="."||s[0]=="-"||e.at(-1)=="."||e.at(-1)=="-"?i=e+s:i=e+" "+s}else if(t.at(-1)=="+"){const s=t.slice(0,-1).trim();s.at(-1)=="."||s.at(-1)=="-"||e[0]=="."||e[0]=="-"?i=s+e:i=s+" "+e}return i},addNumber:(e,t)=>{const i=e.lastIndexOf("("),s=e.lastIndexOf(")");if(i!==-1&&s===e.length-1){const n=e.slice(i+1,s);if(!isNaN(n)&&n!=="")return e.slice(0,i+1)+t.toString()+")"}return e+"("+t.toString()+")"},viewToJSON:e=>{let t,i,s;return e.viewState?(t=e.viewState.visible?e.viewState.big?"big":"open":"closed",i=e.viewState.big?k.rectToString(e.viewState.rect):k.rectToString(e.rect),s=k.transformToString(e.tf)):(t=e.status,i=k.rectToString(e.rect),s=k.transformToString(e.tf)),{state:t,rect:i,transform:s}},stringToView:e=>({raw:!0,state:e.state,rect:k.stringToRect(e.rect),tf:k.stringToTransform(e.transform)}),pinToHandler(e){return"on"+e.split(/[ .-]+/).map(s=>s.replace(/[^a-zA-Z0-9_]/g,"")).filter(Boolean).map(s=>s[0].toUpperCase()+s.slice(1)).join("")},nodeToFactory:e=>{let s=e.toLowerCase().split(/[ .-]+/).map(n=>n.replace(/[^a-z0-9_]/g,"")).filter(Boolean).map(n=>n[0].toUpperCase()+n.slice(1)).join("");return/^[0-9]/.test(s)&&(s="_"+s),s},skipPrefix:e=>{let t=e.indexOf("/",1);return t<0?e:e.slice(t)},spaceToDash:e=>{if(!e.includes(" "))return e;let t="";for(let i=0;i<e.length;i++)t+=e[i]==" "?"-":e[i];return t},toBaseName:e=>{const t=e.indexOf("-model");return t>0?e.slice(0,t):e},nameToSource:e=>k.spaceToDash(e)+".js",nameToModel:e=>k.spaceToDash(e)+".json",nameToBuild:e=>k.spaceToDash(e)+".js",nameToApp:e=>k.spaceToDash(e)+".js",nameToPage:e=>k.spaceToDash(e)+".html",objectToJsLiteral(e,t=4){return JSON.stringify(e,(i,s)=>s===void 0?"__undefined__":s,t).replace(/"__undefined__"/g,"undefined").replace(/"([^"]+)":/g,"$1:").replace(/"([^"]*)"/g,(i,s)=>`'${s.replace(/'/g,"\\'")}'`)},djb2:e=>{for(var t=5381,i=0;i<e.length;i++)t=(t<<5)+t+e.charCodeAt(i);return Math.abs(t&2**32-1).toString(16).padStart(8,"0")},hexToHsl(e){let t=parseInt(e.slice(1,3),16)/255,i=parseInt(e.slice(3,5),16)/255,s=parseInt(e.slice(5,7),16)/255,n=1;e.length>7&&(n=parseInt(e.slice(7,9),16)/255);let o=Math.max(t,i,s),r=Math.min(t,i,s),a,l,c=(o+r)/2;if(o===r)a=l=0;else{let h=o-r;switch(l=c>.5?h/(2-o-r):h/(o+r),o){case t:a=(i-s)/h+(i<s?6:0);break;case i:a=(s-t)/h+2;break;case s:a=(t-i)/h+4;break}a/=6}return l*=100,c*=100,a*=360,n==1?`hsl(${a.toFixed(0)}, ${l.toFixed(0)}%, ${c.toFixed(0)}%)`:`hsl(${a.toFixed(0)}, ${l.toFixed(0)}%, ${c.toFixed(0)}%, ${n})`},hslToHex(e){let t=e.indexOf(",")>-1?",":" ",i=e.substring(4,e.lastIndexOf(")")).split(t),s=parseFloat(i[0]),n=parseFloat(i[1])/100,o=parseFloat(i[2])/100,r=parseFloat(i[3]),a=(1-Math.abs(2*o-1))*n,l=a*(1-Math.abs(s/60%2-1)),c=o-a/2,h=0,u=0,m=0,v="ff";return 0<=s&&s<60?(h=a,u=l,m=0):60<=s&&s<120?(h=l,u=a,m=0):120<=s&&s<180?(h=0,u=a,m=l):180<=s&&s<240?(h=0,u=l,m=a):240<=s&&s<300?(h=l,u=0,m=a):300<=s&&s<360&&(h=a,u=0,m=l),h=Math.round((h+c)*255).toString(16),u=Math.round((u+c)*255).toString(16),m=Math.round((m+c)*255).toString(16),v=r==1?"ff":Math.round(r*255).toString(16),h.length<2&&(h="0"+h),u.length<2&&(u="0"+u),m.length<2&&(m="0"+m),v.length<2&&(m="0"+v),v=="ff"?"#"+h+u+m:"#"+h+u+m+v}};function dd(e){return/^#[0-9A-Fa-f]{6}([0-9A-Fa-f]{2})?$/.test(e)}const E={shade1:"#fff",shade2:"#fff",shade3:"#fff",shade4:"#fff",shade5:"#fff",view1:"#222",view2:"#444",vIcon1:"#fd4d0c",vIcon2:"#3399ff",vIcon3:"#33cc33",vIcon4:"#e9bb16",grey3:"#333",grey6:"#666",greyC:"#ccc",black:"#000",white:"#fff",orange:"#ff8000",orangeT:"#ff800022",green:"#7fff00",red:"#FE2712",yellow:"#fefe33",pink:"#f9d5e5",purple:"#ff80ff",blue:"#0000ff",setShades(e){const t=k.hexToHsl(e),i=t.indexOf(",",4),s=t.indexOf(",",i+1),n=t.substring(4,i),o=t.substring(i+1,s);this.shade1=k.hslToHex(`hsl(${n},${o},40%,1)`),this.shade2=k.hslToHex(`hsl(${n},${o},30%,0.50)`),this.shade3=k.hslToHex(`hsl(${n}, 100%, 75%, 1)`),this.shade4=k.hslToHex(`hsl(${n},${o},60%,1)`),this.shade5=k.hslToHex(`hsl(${n}, 50%, 75%, 1)`)}};function Bs(){this.rgb="#fff",this.std={font:"normal 12px tahoma",lineCap:"round",lineJoin:"round",lineWidth:1,cBackground:E.black,cLine:E.white,cFill:E.blue,wCursor:2,blinkRate:500,cBlinkOn:E.white,cBlinkOff:E.black},this.look={wBox:150,hTop:20,hBottom:6,wExtra:50,wMax:300,dxCopy:20,dyCopy:20,smallMove:5},this.box={rCorner:7.5,wLine:2,cLine:E.shade1,cBackground:E.shade2,cContainer:E.yellow,cSelected:E.orangeT,dxSel:10,dySel:10,wLineSel:1},this.header={font:"normal 13px tahoma",hHeader:15,hTitle:15,wLine:1,wChar:6,rCorner:7.5,cTitle:E.shade3,cBackground:E.shade1,cBad:E.red,cHighLighted:E.purple},this.icon={wIcon:8,hIcon:10,blinkRate:200,nBlinks:4,cSrc:E.shade3,cLink:E.shade3,cBadLink:E.red,cHighLighted:E.purple,cGroup:E.shade3,cCog:E.shade3,cPulse:E.shade3,cComment:E.shade3,xPadding:6,yPadding:2,xSpacing:3},this.label={font:"italic 12px tahoma",hLabel:15,cNormal:E.greyC},this.ifName={font:"normal 12px tahoma",hSep:15,cNormal:E.shade5,cBackground:E.shade1,cAdded:E.green,cBad:E.red,cSelected:E.orange,cHighLighted:E.purple},this.pin={hPin:15,wOutside:10,wMargin:21,hArrow:10,wArrow:10,wChar:6,cNormal:E.shade1,cSelected:E.orange,cHighLighted:E.purple,cConnected:E.shade4,cAdded:E.green,cBad:E.red,cText:E.shade1,cCursor:E.black,fMulti:"italic 11px tahoma"},this.pad={hPad:15,hSpace:15,rBullet:7.5,wArrow:10,hArrow:10,wExtra:30,wMargin:4,wViewLeft:10,wViewRight:100,cBackground:E.shade2,cSelected:E.orange,cHighLighted:E.purple,cConnected:E.shade4,cBad:E.red,cText:E.shade1,cArrow:E.shade1},this.route={wSelected:2,wNormal:2,split:30,tooClose:15,cNormal:E.shade4,cSelected:E.purple,cHighLighted:E.purple,cNotUsed:E.grey3,cAdded:E.green,cDeleted:E.red},this.bus={wNormal:6,wBusbar:6,wCable:8,wSelected:6,split:50,tooClose:25,wArrow:10,hArrow:10,sChar:5,hLabel:15,radius:7.5,wFilter:15,cNormal:E.shade4,cSelected:E.purple,cHighLighted:E.purple,cBad:E.red,cText:E.black},this.selection={xPadding:20,yPadding:20,cRect:E.orangeT,cPinGroup:E.orangeT,wLine:0,rCorner:7.5},this.view={wDefault:800,hDefault:500,wLine:4,rCorner:15,wExtra:200,hExtra:20,cBackground:E.black,cLine:E.view1,cHighLight:E.view2,fHeader:"normal 15px arial",hHeader:20,cTitle:E.grey6,cTitleHighLight:E.shade3,grid:{dx:30,dy:30,cLine:E.grey3,cAxis:E.grey6},wIcon:10,hIcon:10,xPadding:10,xSpacing:8,cDim:E.grey6,cClose:E.vIcon1,cFullscreen:E.vIcon2,cCalibrate:E.vIcon3,cGrid:E.vIcon4},this.placement={marginTop:30,marginLeft:30,marginLeftPads:210,nodesPerRow:5,rowStep:360,colStep:270}}Bs.prototype={switch(e){if(!e)return g;const t=g;return g=e,t},create:e=>dd(e)?new Bs().adapt(e):new Bs().adapt("#00aaff"),adapt(e){return this.rgb=e,E.setShades(e),this.box.cLine=this.header.cBackground=this.ifName.cBackground=this.pin.cNormal=this.pin.cText=E.shade1,this.box.cBackground=this.pad.cBackground=E.shade2,this.header.cTitle=this.icon.cSrc=this.icon.cGroup=this.icon.cCog=this.icon.cLink=this.icon.cPulse=this.icon.cComment=this.view.cTitleHighLight=E.shade3,this.pin.cConnected=this.pad.cConnected=this.route.cNormal=this.bus.cNormal=E.shade4,this.ifName.cNormal=E.shade5,this}};let g=new Bs().adapt("#00aaff");function Zr(){this.cursor=0,this.saved=null,this.obj=null,this.prop=null,this.keyPressed=null}Zr.prototype={newEdit(e,t,i=-1){this.cursor=i<0?e[t].length:0,this.saved=e[t],this.obj=e,this.prop=t,this.keyPressed=null},clear(){this.obj[this.prop]="",this.cursor=0},handleKey(e){this.keyPressed=e.key;let t=this.cursor;const i=this.obj,s=this.prop;let n=t>0?i[s].slice(0,t):"",o=t<i[s].length-1?i[s].slice(t):"";return i[s]=n+e.key+o,this.cursor++,!1},handleSpecialKey(e){switch(this.keyPressed=e.key,e.key){case"Shift":return!1;case"Backspace":let t=this.cursor,i=this.obj[this.prop],s=t>0?i.slice(0,t-1):"",n=t<i.length?i.slice(t):"";return this.obj[this.prop]=s+n,t>0&&this.cursor--,!1;case"Enter":return!0;case"ArrowLeft":return this.cursor>0&&this.cursor--,!1;case"ArrowRight":return this.cursor<this.obj[this.prop].length&&this.cursor++,!1;case"Home":return this.cursor=0,!1;case"End":return this.cursor=this.obj[this.prop].length,!1;case"Delete":return this.obj[this.prop]="",this.cursor=0,!1;case"Escape":return this.obj[this.prop]=this.saved,!0;case"Alt":return!1;case"AltGraph":return!1;case"Control":return!1;default:return!0}}};function ea(e){this.bottom=0,this.top=0,this.next=0,this.max=e>0?e-1:1,this.ring=new Array(this.max+1),this.ring.fill(null)}ea.prototype={reset(){this.bottom=0,this.top=0,this.next=0,this.ring.fill(null)},push(e){this.top=this.next,this.ring[this.top]=e,this.next=this.next==this.max?0:this.next+1,this.next==this.bottom&&(this.bottom=this.bottom==this.max?0:this.bottom+1)},last(){return this.ring[this.top]},back(){return this.next==this.bottom?null:(this.next=this.next==0?this.max:this.next-1,this.ring[this.next])},forward(){if(this.next==this.top+1)return null;const e=this.ring[this.next];return this.next=this.next==this.max?0:this.next+1,e}};const rt=(e,t)=>e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h,Vn="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",En=Vn.length;function ud(e){let t="";for(let i=0;i<e;i++){let s=Math.floor(Math.random()*En);t+=s<En?Vn[s]:Vn[En-1]}return t}function Ne(e,t){const i=e.indexOf(t);return i>=0&&e.splice(i,1),i>=0}function fd(e,t){if(e.length<2)return null;const i=[];let s=0,n=0;for(let o=0;o<e.length-1;o++)s=e[o],n=e[o+1],s.y>t.y&&s.y<t.y+t.h&&n.y>t.y&&n.y<t.y+t.h?(s.x<t.x+t.w&&n.x>t.x||n.x<t.x+t.w&&s.x>t.x)&&i.push(o+1):s.x>t.x&&s.x<t.x+t.w&&n.x>t.x&&n.x<t.x+t.w&&(s.y<t.y+t.h&&n.y>t.y||n.y<t.y+t.h&&s.y>t.y)&&i.push(o+1);return i}function pd(e,t,i){const s=i.x,n=i.x+i.w,o=i.y,r=i.y+i.h;if(e.x<=s&&t.x<=s||e.x>=n&&t.x>=n||e.y<=o&&t.y<=o||e.y>=r&&t.y>=r)return!1;if(e.x>s&&e.x<n&&e.y>o&&e.y<r||t.x>s&&t.x<n&&t.y>o&&t.y<r)return!0;const a=c=>{if(t.x===e.x)return!1;const h=(c-e.x)/(t.x-e.x);if(h>0&&h<1){const u=e.y+h*(t.y-e.y);return u>o&&u<r}return!1},l=c=>{if(t.y===e.y)return!1;const h=(c-e.y)/(t.y-e.y);if(h>0&&h<1){const u=e.x+h*(t.x-e.x);return u>s&&u<n}return!1};return!!(a(s)||a(n)||l(o)||l(r))}function gd(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}function md(e,t){let i=1/0,s=null,n=0,o=!1;for(let r=0;r<e.length-1;r++){let{x:a,y:l}=e[r],{x:c,y:h}=e[r+1];if(a===c)if(Math.min(l,h)<=t.y&&t.y<=Math.max(l,h)){let u=Math.abs(t.x-a);u<i&&(i=u,s={x:a,y:t.y},n=r+1,o=!1)}else{let u=(t.x-a)**2+(t.y-l)**2,m=(t.x-c)**2+(t.y-h)**2,[v,w,y]=u<m?[u,{x:a,y:l},r+1]:[m,{x:a,y:h},r+1];v<i&&(i=v,s=w,n=y,o=!0)}else if(l===h)if(Math.min(a,c)<=t.x&&t.x<=Math.max(a,c)){let u=Math.abs(t.y-l);u<i&&(i=u,s={x:t.x,y:l},n=r+1,o=!1)}else{let u=(t.x-a)**2+(t.y-l)**2,m=(t.x-c)**2+(t.y-h)**2,[v,w,y]=u<m?[u,{x:a,y:l},r+1]:[m,{x:c,y:h},r+1];v<i&&(i=v,s=w,n=y,o=!0)}}return{point:s,segment:n,endPoint:o}}function vd(e,t,i){let s=e.x,n=e.y,o=.1*(1+Math.random()),r=i[t-1],a=i[t];return(a.x<r.x||a.y<r.y)&&([r,a]=[a,r]),r.x==a.x?n=Math.abs(r.y-p.y)<Math(a.y-p.y)?r.y+o*(a.y-r.y):a.y-o*(a.y-r.y):s=Math.abs(r.x-p.x)<Math(a.x-p.x)?r.x+o*(a.x-r.x):a.x-o*(a.x-r.x),{x:s,y:n}}function ta(e){return e?JSON.parse(JSON.stringify(e)):null}function ia(e,t){if(e===null)return t;if(t===null)return JSON.parse(JSON.stringify(e));for(let i in e)e.hasOwnProperty(i)&&(typeof e[i]=="object"&&!Array.isArray(e[i])&&e[i]!==null?t[i]=ia(e[i],t[i]||{}):t.hasOwnProperty(i)||(t[i]=e[i]));for(let i in t)t.hasOwnProperty(i)&&(e.hasOwnProperty(i)||delete t[i]);return t}const wd={prepare(e){this.canvas.focus(),e.preventDefault();const t=this.doc;if(!t)return[null,null,null];const i=t.view.localCoord({x:e.offsetX,y:e.offsetY});return t.view.whichView(i)},onContextMenu(e){const[t,i,s]=this.prepare(e);t&&(i||(t.onContextMenu(s,e),this.redraw()))},onMouseDown(e){var n;if(e.button!=0)return;const[t,i,s]=this.prepare(e);t&&(t!=((n=this.doc)==null?void 0:n.focus)&&this.switchView(t),i?this.viewMouseDown(t,i):t.onMouseDown(s,e),this.redraw())},onMouseMove(e){const[t,i,s]=this.prepare(e);t&&(this.viewMouseMove(t,i,{x:e.movementX,y:e.movementY})||t.onMouseMove(s,e)&&this.redraw())},onMouseUp(e){if(this.state.action)return this.viewMouseUp();const[t,i,s]=this.prepare(e);t&&(t.onMouseUp(s,e),this.redraw())},onWheel(e){const[t,i,s]=this.prepare(e);t&&(t.onWheel(s,e),this.redraw())},onDblClick(e){const[t,i,s]=this.prepare(e);t&&t.onDblClick(s,e)},onClick(e){},onDragOver(e){e.preventDefault()},onDrop(e){const[t,i,s]=this.prepare(e);t&&t.onDrop(s,e)},viewMouseDown(e,t){t.is.icon?e.iconClick(t,this):t.is.border?(this.state.view=e,this.state.widget=t,this.state.action=ct.viewResize):t.is.viewTitle&&(this.state.view=e,this.state.widget=t,this.state.action=ct.viewDrag)},viewWidgetHover(e,t){t.is.border&&(this.state.action=ct.hoverBorder,e.highLight())},viewMouseMove(e,t,i){switch(this.state.action){case ct.nothing:if(!(t!=null&&t.is.border))return!1;if(t.name=="top"||t.name=="bottom")this.canvas.style.cursor="ns-resize";else if(t.name=="left"||t.name=="right")this.canvas.style.cursor="ew-resize";else if(t.name=="corner")this.canvas.style.cursor="nw-resize";else return!0;this.state.action=ct.hoverBorder,this.state.view=e;break;case ct.viewDrag:this.state.view.move(i);break;case ct.viewResize:this.state.view.resize(this.state.widget,i);break;case ct.hoverBorder:(e!=this.state.view||!(t!=null&&t.is.border))&&(this.canvas.style.cursor="default",this.state.action=ct.nothing);break;default:return!1}return this.redraw(),!0},viewMouseUp(){this.state.view=this.state.widget=null,this.state.action=ct.nothing}},yd={onKeydown(e){var t,i;(i=(t=this.doc)==null?void 0:t.focus)!=null&&i.onKeydown(e)&&(e.stopPropagation(),e.preventDefault(),this.redraw())},onKeyup(e){var t,i;(i=(t=this.doc)==null?void 0:t.focus)!=null&&i.onKeyup(e)&&(e.stopPropagation(),e.preventDefault(),this.redraw())}},xd="0.8.3",bd={schemaVersion:xd};function sa(){const e=new Date;this.version=bd.schemaVersion,this.created=e.toLocaleString(),this.saved=e.toLocaleString(),this.utc=e.toJSON(),this.style=g,this.runtime="@vizualmodel/vmblu-runtime"}sa.prototype={toJSON(){const e=new Date;return{version:this.version,created:this.created,saved:e.toLocaleString(),utc:e.toJSON(),style:this.style.rgb,runtime:this.runtime}},cook(e,t){var s,n,o,r,a;const i=new Date;this.created=((s=t.created)==null?void 0:s.slice())??i.toLocaleString(),this.saved=((n=t.saved)==null?void 0:n.slice())??i.toLocaleString(),this.utc=((o=t.utc)==null?void 0:o.slice())??i.toJSON(),this.version=((r=t.version)==null?void 0:r.slice())??"no version",this.style=g.create(t.style),this.runtime=((a=t.runtime)==null?void 0:a.slice())??"@vizualmodel/vmblu-runtime"}};const kd={async handleSourceMap(){const e=await this.readSourceMap();e&&(this.sourceMap=this.parseSourceMap(e))},async readSourceMap(){var i;const e=(i=this.arl)==null?void 0:i.getFullPath();return e?await this.arl.resolve(Vs(e)+".prf.json").get("json"):null},parseSourceMap(e){if(!e.entries)return null;const t=new Map;for(const i of e.entries){const{node:s,handles:n,transmits:o}=i;t.has(s)||t.set(s,{handles:new Map,transmits:new Map});const r=t.get(s);for(const a of n){const{handler:l,...c}=a;r.handles.set(l,{handler:l,...c})}for(const a of o){const{pin:l,...c}=a,h=r.transmits.get(l);h?Array.isArray(h)?h.push({pin:l,...c}):r.transmits.set(l,[h,{pin:l,...c}]):r.transmits.set(l,{pin:l,...c})}}return t},flattenSourceMap(e){const t=[];for(const[i,s]of e.entries())for(const[n,o]of s.entries())t.push({node:i,pin:n,...o});return t},getInputPinProfile(e){var o,r;const t=(r=(o=this.sourceMap)==null?void 0:o.get(e.node.name))==null?void 0:r.handles;if(!t)return null;const i=k.pinToHandler(e.name);if(!e.is.multi)return t.get(i)??null;const s=e.expandMultis(),n=[];for(const a of s){const l=k.pinToHandler(a),c=t.get(l)??null;c&&n.push(c)}return n},getOutputPinProfile(e){var n,o;const t=(o=(n=this.sourceMap)==null?void 0:n.get(e.node.name))==null?void 0:o.transmits;if(!t)return null;if(!e.is.multi)return t.get(e.name)??null;const i=e.expandMultis(),s=[];for(const r of i){const a=t.get(r)??null;Array.isArray(a)?s.push(...a):s.push(a)}return s},makeMcpToolString(e){const t=this.generateToolSpecs();if(t.length==0)return null;const i=new Date,s=`// ------------------------------------------------------------------
// MCP tool file for model: ${e.name}
// Creation date ${i.toLocaleString()}
// ------------------------------------------------------------------

export const mcpTools = `,n=k.objectToJsLiteral(t);return s+n},generateToolSpecs(){const e=[];if(!this.sourceMap)return[];for(const[t,i]of this.sourceMap.entries())for(const[s,n]of i.entries()){if(!n.mcp)continue;const o=new Map;for(const a of n.params||[]){if(!a.name||typeof a.name!="string")continue;if(a.name.startsWith("{")&&a.name.endsWith("}")){const c=a.name.slice(1,-1).split(",").map(h=>h.trim());for(const h of c)o.set(h,{name:h,type:"string",description:""});continue}const l=a.name.split(".");if(l.length===1)o.has(a.name)||o.set(a.name,{...a});else{const[c,h]=l;let u=o.get(c);u||(u={name:c,type:"object",description:"",properties:[],required:[]},o.set(c,u)),u.properties.push({name:h,type:a.type,description:a.description||""}),u.required.includes(h)||u.required.push(h)}}const r={name:n.mcpName||`${t}_${s}`,description:n.mcpDescription||n.summary||`Trigger ${s} on ${t}`,parameters:Array.from(o.values()),returns:n.returns||"",node:t,pin:s,handler:n.handler,file:n.file,line:n.line};e.push(r)}return e},convertToOpenAITools(e){return e.map(t=>{const i={type:"object",properties:{},required:[]};for(const s of t.parameters){const{name:n,type:o,description:r,properties:a,required:l}=s;if(!n||!o)continue;const c={type:o,description:r||""};if(o==="object"&&a){c.properties={},c.required=l||[];for(const h of a)c.properties[h.name]={type:h.type,description:h.description||""}}i.properties[n]=c,i.required.push(n)}return{type:"function",function:{name:t.name,description:t.description,parameters:i}}})}};function Mt(e){const t=Zo(e.userPath);this.is={blu:t=="vmblu"||t=="json",lib:t=="js"||t=="mjs",selectable:!1,dirty:!1,main:!1,fresh:!1},this.arl=e,this.key=null,this.header=new sa,this.libraries=new no,this.raw=null,this.sourceMap=null}Mt.prototype={toJSON(){return this.arl.userPath},makeKey(){this.key=k.djb2(this.arl.getFullPath())},checkType(){const e=Zo(this.arl.userPath);this.is={blu:e=="vmblu"||e=="json",lib:e=="js"||e=="mjs"}},copy(){const e=new Mt(this.arl);return e.key=this.key?this.key.slice():null,e.header={...this.header},e.raw=this.raw,e},findRawNode(e){var n,o;const t=(n=this.raw)==null?void 0:n.root;if(!t)return null;const i=k.splitLink(e);if(i.length==1)return e==t.name?t:t.nodes?this.findRawRecursive(t.nodes,e):null;let s=t;for(const r of i)if(s=(o=s.nodes)==null?void 0:o.find(a=>r===a.name),!s)return null;return s},findRawRecursive(e,t){for(const i of e)if(t==i.name)return i;for(const i of e)if(i.kind=="group"&&i.nodes.length>0){const s=this.findRawRecursive(i.nodes,t);if(s)return s}return null},setSelectable(){this.is.selectable=!0},async fetch(){let e=null;if(this.is.lib){const t=await this.arl.get("text").catch(i=>{console.error(`${this.arl.userPath} is not a valid library file`,i)});return t?(e=this.analyzeJSLib(t),e||console.error(`Model not found in library file: ${this.arl.userPath}`),e):null}return this.is.blu?(e=await this.arl.get("json").catch(t=>{console.error(`${this.arl.getFullPath()} is not a valid model file}`,t)}),e):(console.error(`${this.arl.userPath} is not a model nor a library file`),null)},async getRaw(){var e;return this.raw=await this.fetch(),(e=this.raw)!=null&&e.header&&this.header.cook(this.arl,this.raw.header),this.is.fresh=!0,this.raw},addRawLibraries(e,t){const i=this.libraries.newModels(e,t);for(const s of i)this.libraries.add(s)},analyzeJSLib(e){let t=e.indexOf('"{\\n'),i=e.indexOf('\\n}";',t);if(t<0||i<0)return null;let s=e.slice(t+1,i+3);const n=new Array(s.length);let o=0,r=0;for(;r<s.length;){const l=s.charAt(r++);if(l!="\\")n[o++]=l;else{const c=s.charAt(r++);c=="n"?n[o++]=`
`:c=='"'&&(n[o++]='"')}}const a=n.join("");return JSON.parse(a)}};Object.assign(Mt.prototype,kd);function no(){this.map=new Map}no.prototype={reset(){this.map.clear()},size(){return this.map.size},newModels(e,t){const i=[];if(t.length<1)return i;for(const s of t){const n=e.resolve(s);if(this.contains(n))continue;const o=new Mt(n);i.push(o)}return i},add(e){const t=e.arl.getFullPath();return this.map.get(t)?this:(this.map.set(t,e),this)},contains(e){return this.map.has(e.getFullPath())},get(e){return this.map.get(e)},valuesArray(){return Array.from(this.map.values())},findArl(e){var t;if(!e)return null;for(const i of this.map.values())if((t=i.arl)!=null&&t.equals(e))return i;return null},toJSON(){return[...this.map.values()]},async load(){const e=[];for(const t of this.map.values())t.is.selectable=!0,e.push(t.getRaw());await Promise.all(e)}};function _d(e){this.pin=e}function na(e){this.pin=e,this.targets=[]}na.prototype={dropTarget(e){const t=this.targets;for(let i=0;i<t.length;i++)if(e.node==t[i].node&&e.name==t[i].name){for(let s=i;s<t.length-1;s++)t[s]=t[s+1];t.pop();return}}};function Td(e){this.tack=e}function oa(e){this.tack=e,this.fanout=[]}oa.prototype={connectsTo(e){const t=this.tack.getOtherPin();return t.is.multi?t.getMatch(e)==e:t.name==e},dropTarget(e){const t=this.fanout;for(let i=0;i<t.length;i++)if(e.node==t[i].node&&e.name==t[i].name){for(let s=i;s<t.length-1;s++)t[s]=t[s+1];t.pop();return}}};const Pd={rxtxPrepareTables(){if(!this.is.group)for(const e of this.look.widgets)e.is.pin&&this.rxtxAddPin(e)},rxtxResetTables(){this.is.group||(this.txTable=[],this.rxTable=[])},rxtxAddPin(e){this.is.group||(e.is.input?this.rxTable.push(new _d(e)):this.txTable.push(new na(e)))},rxtxPopPin(e){this.is.group||(e.is.input?this.rxTable.pop():this.txTable.pop())},rxtxRemovePin(e){if(!this.is.group)if(e.is.input){const t=this.rxTable.find(i=>i.pin==e);Ne(this.rxTable,t)}else{const t=this.txTable.find(i=>i.pin==e);Ne(this.txTable,t)}},rxtxAddPinArea(e){if(!this.is.group)for(const t of e)t.is.pin&&this.rxtxAddPin(t)},rxtxBuildTxTable(){var e;if(this.is.group){for(const t of this.buses)t.hasFilter()&&t.rxtxBuildRxTxTable();for(const t of this.nodes)t.rxtxBuildTxTable();return}for(const t of this.look.widgets){if(!t.is.pin||t.is.input||t.routes.length==0)continue;const i=this.txTable.find(n=>n.pin.name==t.name);if(!i){console.error(`${this.name} NO TX TABLE RECORD FOR ${t.name}`);continue}i.targets=[];const s=[];for(const n of t.routes){if(!n.from||!n.to)continue;const o=n.from==t?n.to:n.from;o.is.pin?o.is.proxy?(e=o.pad)==null||e.makeConxList(s):s.push(o):o.is.tack?o.bus.hasFilter()?s.push(o):o.bus.makeConxList(t,s):o.is.pad&&o.proxy.makeConxList(s)}for(const n of s)i.targets.push(n)}},rxtxRemoveFromTxTable(e,t){var n;const i=(n=this.txTable.find(o=>o.pin.name==e.name))==null?void 0:n.targets,s=(i==null?void 0:i.length)??0;for(let o=0;o<s;o++)if(t.node==i[o].node&&t.name==i[o].name){for(let r=o;r<s-1;r++)i[r]=i[r+1];i.pop();return}}};function Sd(e){return{x:e.x-15,y:e.y+10}}const Ld={showExportForm(e){const t=this;f.tx.send("show link",{title:"Export to link",name:t.name,path:"",pos:e,ok:(i,s)=>f.doEdit("saveToLink",{node:t,newName:i,userPath:s}),cancel:()=>{}})},showLinkForm(e){var n,o;const t=this,i=t.link&&t.link.model!=((n=f.doc)==null?void 0:n.model)?(o=t.link.model)==null?void 0:o.arl.userPath:"",s=t.link?t.link.lName:t.name;f.tx.send("show link",{title:"Set link",name:s,path:i,pos:e,ok:(r,a)=>{(r!=s||a!=i)&&f.doEdit("changeLink",{node:t,lName:r,userPath:a})},open:(r,a)=>{var l,c;(r!=s||a!=i)&&f.doEdit("changeLink",{node:t,lName:r,userPath:a}),(l=t.link.model)!=null&&l.arl&&t.link.model!=((c=f.doc)==null?void 0:c.model)&&f.tx.send("open document",t.link.model.arl)},cancel:()=>{}})},iconClick(e,t,i){var o;const s=this,n=Sd(i);switch(t.type){case"link":case"lock":this.showLinkForm(n);break;case"factory":const r=s.factory.fName.length<1?k.nodeToFactory(s.name):s.factory.fName,a=s.factory.arl?s.factory.arl.userPath:"";f.tx.send("show factory",{title:"Factory for "+s.name,name:r,path:a,pos:n,ok:(c,h)=>{f.doEdit("changeFactory",{node:s,newName:c.trim(),userPath:h.trim()})},open:async(c,h)=>{(c!=r||h!=a)&&f.doEdit("changeFactory",{node:s,newName:c.trim(),userPath:h.trim()});const u=s.factory.arl??f.doc.resolve("./index.js");f.tx.send("open source file",{arl:u})},cancel:()=>{}});break;case"group":let l=null;s.savedView?(o=s.savedView.viewState)!=null&&o.visible?(l=s.savedView.parent,l&&s.savedView.closeView()):(e.restoreView(s),l=s.savedView):l=e.newSubView(s),l&&f.switchView(l);break;case"cog":f.tx.send("settings",{title:"Settings for "+s.name,pos:n,json:s.sx,ok:c=>f.doEdit("changeNodeSettings",{node:s,sx:c})});break;case"pulse":f.tx.send("runtime settings",{title:"Runtime settings for "+s.name,pos:n,dx:s.dx,ok:c=>f.doEdit("changeNodeDynamics",{node:s,dx:c})});break;case"comment":f.tx.send("node comment",{header:"Comment for "+s.name,pos:n,uid:s.uid,text:s.prompt??"",ok:c=>f.doEdit("changeNodeComment",{node:s,comment:c})});break}},iconCtrlClick(e,t,i){var n,o,r,a;const s=this;switch(t.type){case"link":case"lock":(o=(n=s.link)==null?void 0:n.model)!=null&&o.arl&&s.link.model!=((r=f.doc)==null?void 0:r.model)&&f.tx.send("open document",s.link.model.arl);break;case"factory":{if(!s.is.source)return;const l=s.factory.arl??f.doc.resolve("./index.js");l&&f.tx.send("open source file",{arl:l})}break;case"group":s.savedView?e.restoreView(s):e.newSubView(s),(a=s.savedView)==null||a.big();break}}},Nd={collectFactories(e){if(!this.link&&(this.is.source&&this.factory.arl!=null&&e.add(this.factory),this.is.group))for(const t of this.nodes)t.collectFactories(e)},collectModels(e){var t;this.link?this.link.model&&!this.link.model.is.main&&e.add(this.link.model):(t=this.nodes)==null||t.forEach(i=>i.collectModels(e))},collectModelsForLib(e,t){var i;if(this.link){const s=this.link.model;s&&!s.arl.equals(t.arl)&&e.add(s)}else(i=this.nodes)==null||i.forEach(s=>s.collectModelsForLib(e,t))},collectImports(e,t=null){var o,r;if(this.is.group){(r=(o=this.link)==null?void 0:o.model)!=null&&r.is.lib&&(t=this.link.model);for(const a of this.nodes)a.collectImports(e,t);for(const a of this.buses)a.hasFilter()&&a.getFilter(e,t,this.link);return}const i=this.getSourceArl(t)??e[0].arl,s=this.factory.duplicate(e,i)?`${this.factory.fName} as ${this.factory.alias}`:this.factory.fName,n=e.find(a=>a.arl.equals(i));n?n.items.find(l=>l==s)||n.items.push(s):e.push({arl:i,items:[s]})},makeSourceLists(e,t){var i;if(this.is.source)e.push(this);else if((i=this.link)!=null&&i.is.bad)console.warn(`Group node "${this.name}" is missing. ModelBlueprint "${this.link.model.arl.userPath}" not found`);else if(!this.nodes)console.warn(`Group node "${this.name}" is empty`);else{for(const s of this.buses)s.is.cable&&s.is.filter&&t.push(s);for(const s of this.nodes)s.makeSourceLists(e,t)}},xxxduplicateFactory(e,t){const i=e.find(s=>s.arl.equals(t)?!1:s.items.find(n=>n==this.factory.fName));return i?(console.warn(`Duplicate factory name: ${this.factory.fName} is already defined in ${i.arl.userPath}`),this.factory.alias="_"+this.factory.fName,!0):(this.factory.alias=null,!1)}};function Xs(e,t){this.model=e,this.lName=t,this.is={bad:!1}}Xs.prototype={copy(){return new Xs(this.model,this.lName)},toJSON(){return{path:this.model&&!this.model.is.main?this.model.arl.userPath:"./",node:this.lName}}};const Cd={setLink(e,t){var i;this.link?(this.link.model=e,this.link.lName=t,(i=this.link.model)!=null&&i.is.lib?this.look.checkLinkIcon("lock"):this.look.checkLinkIcon("link")):(this.link=new Xs(e,t),e!=null&&e.is.lib?this.look.addIcon("lock"):this.look.addIcon("link"))},clearLink(){this.look.removeLinkIcon(),this.is.source?this.look.addIcon("factory"):this.look.addIcon("group"),this.link=null},linkIsBad(){this.link.is.bad=!0,this.look.badLinkIcon()},linkIsGood(){this.link.is.bad=!1,this.look.goodLinkIcon()},adjustPaths(e){var t;if(this.link)this.link.model.arl.makeRelative(e);else if((t=this.factory)!=null&&t.arl)this.factory.arl.makeRelative(e);else if(this.nodes)for(const i of this.nodes)i.adjustPaths(e)}},Rd={getRoutes(){const e=[];for(const t of this.look.widgets)if(t.is.pin)for(const i of t.routes)e.push(i);return e},getAllRoutes(e){const t=[];for(const i of e)if(i.is.pin)for(const s of i.routes)t.push(s);return t},connect(){},disconnect(){for(const e of this.look.widgets)e.is.pin&&e.disconnect()},disconnectPinArea(e){for(const t of e)t.is.pin&&t.disconnect()},isConnected(){for(const e of this.look.widgets)if(e.is.pin&&e.routes.length>0)return!0;return!1},highLight(){this.is.highLighted=!0;for(const e of this.look.widgets)if(!(!e.is.pin||e.routes.length==0))for(const t of e.routes){const i=t.from===e?t.to:t.from;t.highLight(),i.is.tack&&i.bus.highLightRoutes(e)}},unHighLight(){this.is.highLighted=!1;for(const e of this.look.widgets)if(!(!e.is.pin||e.routes.length==0))for(const t of e.routes){const i=t.from===e?t.to:t.from;t.unHighLight(),i.is.tack&&i.bus.unHighLightRoutes(e)}}},Ed={acceptChanges(){var e;this.look&&this.look.acceptChanges(),(e=this.nodes)==null||e.forEach(t=>t.acceptChanges())},sxUpdate(e){e.sx&&(this.sx=ia(e.sx,this.sx))},sameRelativePosition(e,t,i){return{x:i.is.left?e.rect.x:e.rect.x+e.rect.w,y:e.rect.y+(i.rect.y-t.rect.y)}},prefixPinPosition(e,t){const i=t.getPrefix(),s=e.findInterfaceName(i),n=s?e.getInterface(s):null;if(!n)return console.log("*** InterfaceName not found ***"+i+"  "+t.name),{x:t.is.left?e.rect.x:e.rect.x+e.rect.w,y:e.rect.y+e.rect.h};const o=n.at(-1);return{x:t.is.left?e.rect.x:e.rect.x+e.rect.w,y:o.rect.y+o.rect.h}},newInterfaceNamePosition(e,t){const i={x:e.rect.x,y:e.rect.y+e.rect.h};for(const s of e.widgets)s.is.ifName&&(s.is.added||s.rect.y>t.rect.y&&s.rect.y<i.y&&(i.y=s.rect.y));return i},widgetCompare(e){const t=this.look,i=e.look;for(const n of t.widgets)n.wid&&(n.is.added=!1,n.is.zombie=!0);const s=i.widgets.slice().sort((n,o)=>n.rect.y-o.rect.y);for(const n of s){if(!n.is.ifName)continue;let o=t.widgets.find(r=>r.is.zombie&&r.is.ifName&&n.is.ifName&&r.text==n.text);if(o){o.is.zombie=!1,o.wid=n.wid;continue}if(o=t.widgets.find(r=>r.is.zombie&&r.is.ifName&&n.is.ifName&&r.wid==n.wid),o){this.dockInterfaceNameChange(o,n),o.is.zombie=!1;continue}this.dockNewInterfaceName(n)}for(const n of s){if(!n.is.pin)continue;let o=t.widgets.find(r=>r.is.zombie&&r.is.pin&&r.name==n.name&&r.is.input==n.is.input&&r.is.channel==n.is.channel);if(o){o.is.zombie=!1,o.wid=n.wid;continue}if(o=t.widgets.find(r=>r.is.zombie&&r.is.pin&&r.wid==n.wid&&r.is.input==n.is.input),o){this.dockPinChange(o,n),o.is.zombie=!1;continue}this.dockNewPin(n,e)}},dockNewPin(e,t){const i=e.pxlen!=0?this.prefixPinPosition(this.look,e):this.sameRelativePosition(this.look,t.look,e),s=this.look.addPin(e.name,i,e.is);s.profile=e.profile,s.pxlen=e.pxlen,s.is.added=!0},dockNewInterfaceName(e){const t=this.newInterfaceNamePosition(this.look,e),i=this.look.addIfName(e.text,t);i.is.added=!0},dockPinChange(e,t){if(t.is.channel!=e.is.channel&&(e.is.channel=t.is.channel),t.name!=e.name||t.pxlen!=e.pxlen){if(t.pxlen!=0&&t.getPrefix()!=e.getPrefix()){const i=this.prefixPinPosition(this.look,t);this.look.movePin(e,i)}e.name=t.name,e.pxlen=t.pxlen,e.is.multi=t.is.multi}t.is.input&&t.profile!=e.profile&&(e.profile=t.profile),e.is.added=!0},dockInterfaceNameChange(e,t,i){t.text!=e.text&&(e.text=t.text,e.is.added=!0,this.look.interfaceChangePrefix(e))}};function Ks(e,t){this.rect={...e},this.node=t,this.is={box:!0,selected:!1}}Ks.prototype={render(e){const{x:t,y:i,w:s,h:n}=this.rect,o=g.box;if(this.is.selected){const r=this.node.look.findLabel(),a=r&&r.text.length>0?r.rect.h:0,l=o.dxSel,c=o.dySel;H.roundedRect(e,t-l,i-c-a,s+2*l,n+2*c+a,o.rCorner,o.wLineSel,o.cSelected.slice(0,7),o.cSelected)}H.roundedRect(e,t,i,s,n,o.rCorner,o.wLine,o.cLine,o.cBackground)},increaseHeight(e){this.rect.h+=e},increaseWidth(e){this.rect.w+=e},toJSON(){return{box:k.relativeRect(this.rect,this.node.look.rect)}}};function Qs(e,t){this.rect={...e},this.is={header:!0,highLighted:!1},this.title=t.name,this.node=t}Qs.prototype={startEdit(){return"title"},endEdit(e){this.title=k.cleanInput(this.title),this.node.look.headerChanged(this,e)},drawCursor(e,t,i){const s=H.centerTextCursor(e,this.rect,this.title,t),n=i?g.std.cBlinkOn:g.std.cBlinkOff;H.cursor(e,s.x,s.y,g.std.wCursor,this.rect.h,n)},render(e){let t=g.header,{x:i,y:s,w:n,h:o}=this.rect;H.roundedHeader(e,i,s,n,o,t.rCorner,t.wLine,t.cBackground,t.cBackground);const r=this.node.is.duplicate?t.cBad:this.is.highLighted?t.cHighLighted:t.cTitle;H.centerText(e,this.title,t.font,r,i,s,n,o)},hitTitle(e){const t=g.icon,i=this.rect,s=i.x+t.xPadding+2*(t.wIcon+t.xSpacing),n=i.x+i.w-t.xPadding-2*(t.wIcon+t.xSpacing);return e.x>s&&e.x<n},toJSON(){return{header:this.title}}};const Md={startEdit(){return this.pxlen&&(this.name=this.withoutPrefix(),this.pxlen=0),this.is.multi=!1,"name"},endEdit(e){this.checkNewName()?this.nameChanged(e):this.restoreSavedName(e)},displayName(){return this.pxlen==0?this.name:this.withoutPrefix()},nameClash(e){return this.is.input!=e.is.input?!1:this.lowerCase()==e.lowerCase()?!0:this.is.input?k.pinToHandler(this.name)==k.pinToHandler(e.name):!1},lowerCase(){return this.name.toLowerCase()},checkNewName(){var e,t;if(this.name=k.cleanInput(this.name),this.name.length==0)return((e=this.routes)==null?void 0:e.length)==0;if(k.needsPrefix(this.name)||k.needsPostfix(this.name)){if(this.name.length==1)return!1;this.addIfName()}else this.pxlen=0;return this.is.multi=k.isMulti(this.name),this.is.multi&&(this.name=k.cleanMulti(this.name)),this.checkRouteUsage(),(t=this.node.look)==null||t.adjustPinWidth(this),this.node.look.setDuplicatePin(this),!0},nameChanged(e){const t=this.is.input?this.node.rxTable.find(i=>i.pin==this):this.node.txTable.find(i=>i.pin==this);if(this.name.length==0){this.is.input?Ne(this.node.rxTable,t):Ne(this.node.txTable,t),this.node.look.removePin(this);return}},restoreSavedName(e){this.name=e,(k.needsPrefix(e)||k.needsPostfix(e))&&this.addIfName()},withoutPrefix(){if(this.pxlen==0)return this.name;if(this.pxlen>0){let t=this.name.slice(this.pxlen);return t[0]!=" "?t:"+ "+t.trim()}else if(this.pxlen<0){let t=this.name.slice(0,this.pxlen-1);return t.at(-1)!=" "?t:"+ "+t.trim()}},getPrefix(){return this.pxlen>0?this.name.slice(0,this.pxlen):this.pxlen<0?this.name.slice(this.pxlen):null},ifNamePrefixCheck(){var i;this.pxlen=0;const e=(i=this.node.look.findIfNameAbove(this.rect.y))==null?void 0:i.text.toLowerCase();if(!e)return;const t=this.lowerCase();k.prefixMatch(e,t)?this.pxlen=e.length:k.postfixMatch(e,t)&&(this.pxlen=-e.length)},addIfName(){const e=this.node.look.findIfNameAbove(this.rect.y);k.needsPrefix(this.name)?e?(this.name=k.combineWithPrefix(e.text,this.name),this.pxlen=e.text.length):(this.name=this.name.slice(1).trimStart(),this.pxlen=0):k.needsPostfix(this.name)&&(e?(this.name=k.combineWithPostfix(e.text,this.name),this.pxlen=-e.text.length):(this.name=this.name.slice(0,-1).trimEnd(),this.pxlen=0))},checkPrefix(){if(this.pxlen==0)return;const e=this.getPrefix(),t=this.node.look.findIfNameAbove(this.rect.y);t&&e==t.text||(this.pxlen=0)},changePrefix(e){if(this.pxlen==0)return;if(e.length==0){this.pxlen=0;return}const t=this.pxlen>0?"+"+this.name.slice(this.pxlen+1):this.name.slice(0,this.pxlen-1)+"+";this.name=k.combineWithPrefix(e,t),this.pxlen=this.pxlen>0?e.length:-e.length},checkRouteUsage(){for(const e of this.routes)e.is.notUsed=!1;for(const e of this.routes){const t=e.from==this?e.to:e.from;if(e.is.twistedPair=t.is.multi||this.is.multi,t.is.pin)(t.is.multi||this.is.multi)&&!this.hasMultiOverlap(t)&&(e.is.notUsed=!0);else if(t.is.pad)(this.is.multi||t.proxy.is.multi)&&!this.hasMultiOverlap(t.proxy)&&(e.is.notUsed=!0);else if(t.is.tack){let i=!1;for(const s of t.bus.tacks){if(s==t)continue;const n=s.route.to==s?s.route.from:s.route.to;t.bus.areConnected(this,n)&&(s.route.is.notUsed=!1,i=!0)}i||(e.is.notUsed=!0)}}},extractMultis(){return k.extractMultis(this.name)},expandMultis(){return k.expandMultis(this.name)},hasFullNameMatch(e){const t=e.is.multi?k.expandMultis(e.lowerCase()):[e.lowerCase()],i=this.is.multi?k.expandMultis(this.lowerCase()):[this.lowerCase()];for(const s of t)if(i.includes(s))return!0;return!1},hasMultiOverlap(e){return e.is.multi?this.is.multi?this.checkMultiPartOnly(e):e.checkPartial(this.lowerCase()):this.is.multi?this.checkPartial(e.lowerCase()):!1},checkMultiPartOnly(e){const t=k.extractMultis(e.lowerCase()),i=k.extractMultis(this.lowerCase());for(const s of t)if(i.includes(s))return!0;return!1},checkPartial(e){const t=k.extractMultis(this.lowerCase());for(const i of t)if(e.indexOf(i)>=0)return!0;return!1},getMatch(e){if(this.is.multi){const t=k.extractMultis(this.lowerCase()),i=k.expandMultis(this.lowerCase());for(let s=0;s<t.length;s++)if(e.includes(t[s]))return i[s]}return null}};function Ti(e,t,i,s){this.rect={...e},this.node=t,this.name=i,this.pxlen=0,this.wid=0,this.is={pin:!0,proxy:!1,channel:s.channel??!1,input:s.input??!1,left:s.left??!1,multi:s.multi??!1,selected:!1,highLighted:!1,hoverOk:!1,hoverNok:!1,zombie:s.zombie??!1,added:!1,duplicate:!1},this.profile="",this.prompt="",this.routes=[]}Ti.prototype={drawCursor(e,t,i){const s=this.rect,n=g.pin.wMargin,o=e.measureText(this.name.slice(0,t)).width,r=this.is.left?s.x+n+o:s.x+s.w-n-e.measureText(this.name).width+o,a=i?g.std.cBlinkOn:g.std.cBlinkOff;H.cursor(e,r,s.y,g.std.wCursor,s.h,a)},render(e){const t=g.pin,i=this.rect,s=this.pxlen==0?this.name:this.withoutPrefix(),{cArrow:n,cText:o}=this.setColor(),r=i.y+(t.hPin-t.wArrow)/2,a=g.box.wLine/2,l=this.is.channel?H.triangleBall:H.leftTriangle,c=this.is.channel?H.ballTriangle:H.rightTriangle;if(this.is.left){const h=i.x+t.wOutside;this.is.multi?H.leftTextMulti(e,s,t.fMulti,o,i.x+g.pin.wMargin,i.y,i.w,i.h):H.leftText(e,s,o,i.x+g.pin.wMargin,i.y,i.w,i.h),this.is.input?c(e,h-a,r,t.hArrow,t.wArrow,n):l(e,h-t.hArrow+a,r,t.hArrow,t.wArrow,n)}else{const h=i.x+i.w-t.wOutside;this.is.multi?H.rightTextMulti(e,s,t.fMulti,o,i.x,i.y,i.w-g.pin.wMargin,i.h):H.rightText(e,s,o,i.x,i.y,i.w-g.pin.wMargin,i.h),this.is.input?l(e,h-t.hArrow+a,r,t.hArrow,t.wArrow,n):c(e,h-a,r,t.hArrow,t.wArrow,n)}this.is.duplicate&&H.rectRect(e,i.x,i.y,i.w,i.h,t.cBad,null)},setColor(){const e=this.is.hoverNok?g.pin.cBad:this.is.hoverOk?g.pin.cSelected:this.is.highLighted?g.pin.cHighLighted:this.is.selected?g.pin.cSelected:this.routes.length>0?g.pin.cConnected:g.pin.cNormal,t=this.is.hoverNok?g.pin.cBad:this.is.hoverOk?g.pin.cSelected:this.is.added?g.pin.cAdded:this.is.zombie?g.pin.cBad:this.is.highLighted?g.pin.cHighLighted:this.is.selected?g.pin.cSelected:this.routes.length>0?g.pin.cConnected:g.pin.cText;return{cArrow:e,cText:t}},center(){const e=g.pin.wOutside,t=this.rect;return this.is.left?{x:t.x+e,y:t.y+t.h/2}:{x:t.x+t.w-e,y:t.y+t.h/2}},canConnect(e){return!(this==e||this.is.input===e.is.input||(this.is.multi||e.is.multi)&&!this.hasMultiOverlap(e)||this.haveRoute(e))},areConnected(e){if(e.is.pin){if(e.is.input==this.is.input||(e.is.multi||this.is.multi)&&!this.hasMultiOverlap(e))return!1}else if(e.is.pad&&(e.proxy.is.input!=this.is.input||e.proxy.is.multi&&!this.hasMultiOverlap(e.proxy)))return!1;return!0},toJSON(){this.is.input?this.is.channel:this.is.channel;const e={name:this.name,kind:this.is.input?this.is.channel?"reply":"input":this.is.channel?"request":"output",editor:{id:this.wid,align:this.is.left?"left":"right"}};return this.is.proxy&&(e.editor.pad={rect:k.rectToString(this.pad.rect),align:this.pad.is.leftText?"left":"right"}),e},removeRoute(e){Ne(this.routes,e)},adjustRoutes(){for(const e of this.routes)e.adjust()},leftRightSwap(){const e=this.node.look.rect;this.rect.x=this.is.left?e.x+e.w-this.rect.w+g.pin.wOutside:e.x-g.pin.wOutside,this.is.left=!this.is.left,this.adjustRoutes()},drag(e){const t=this.node.look.rect,i=t.x+t.w/2;(this.is.left&&e.x>i||!this.is.left&&e.x<i)&&this.leftRightSwap();const s=this.node.look.findNextWidget(this,e,n=>n.is.pin||n.is.ifName);s&&([this.rect.y,s.rect.y]=[s.rect.y,this.rect.y],s.is.ifName&&this.ifNamePrefixCheck(),this.adjustRoutes(),s.is.pin&&s.adjustRoutes())},moveTo(e,t){e!=this.is.left&&this.leftRightSwap();const i=this.rect;for(const s of this.node.look.widgets){const n=s.rect;i.y>t&&n.y>=t&&n.y<i.y&&(n.y+=i.h,s.is.pin&&s.adjustRoutes()),i.y<t&&n.y<=t&&n.y>i.y&&(n.y-=i.h,s.is.pin&&s.adjustRoutes())}i.y=t,this.adjustRoutes()},disconnect(){const e=this.routes.slice();for(const t of e){const i=t.from==this?t.to:t.from;i.is.pin?t.rxtxPinPinDisconnect():i.is.pad?t.rxtxPinPadDisconnect():i.is.tack&&t.rxtxPinBusDisconnect(),t.remove()}},reconnect(e){this.routes=e;for(const t of e){const i=t.from==this?t.to:t.from;i.is.pin?(i.routes.push(t),t.rxtxPinPin()):i.is.pad?(i.routes.push(t),t.rxtxPinPad()):i.is.tack&&(i.bus.tacks.push(i),t.rxtxPinBus())}},haveRoute(e){for(const t of this.routes)if(t.from==e||t.to==e)return!0;return!1},ioSwap(){return this.routes.length>0||this.is.proxy&&this.pad.routes.length>0?!1:(this.is.input=!this.is.input,!0)},channelOnOff(){this.is.channel=!this.is.channel;for(const e of this.routes){const t=e.from==this?e.to:e.from;t.is.tack&&(t.is.channel=this.is.channel)}return!0},doSelect(){this.is.selected=!0},unSelect(){this.is.selected=!1},highLight(){this.is.highLighted=!0},unHighLight(){this.is.highLighted=!1},highLightRoutes(){for(const e of this.routes){const t=e.from==this?e.to:e.from;if(t){if(t.is.pin){if(!this.areConnected(t))continue;e.highLight();continue}if(t.is.pad){if(!this.areConnected(t))continue;e.highLight();continue}t.is.tack&&(e.highLight(),t.bus.highLightRoutes(this))}}},unHighLightRoutes(){for(const e of this.routes){e.unHighLight();const t=e.from==this?e.to:e.from;if(t){if(t.is.pin){if(!this.areConnected(t))continue;t.is.proxy&&t.pad.unHighLightRoutes();continue}if(t.is.pad){if(!this.areConnected(t))continue;t.proxy.unHighLightRoutes();continue}t.is.tack&&t.bus.unHighLightRoutes(this)}}},makePadRect(e){const t=g.pad.wExtra+this.node.look.getTextWidth(this.name,this.is.multi);return this.is.left?{x:e.x,y:e.y-g.pad.hPad/2,w:t,h:g.pad.hPad}:{x:e.x,y:e.y-g.pad.hPad/2,w:t,h:g.pad.hPad}}};Object.assign(Ti.prototype,Md);function ks(e,t,i,s){Ti.call(this,e,t,i,s),this.is.proxy=!0,this.pad=null}const Ad={makeConxList(e){var t;for(const i of this.routes){const s=i.from==this?i.to:i.from;this.areConnected(s)&&(s.is.pin?s.is.proxy?(t=s.pad)==null||t.makeConxList(e):e.push(s):s.is.pad?s.proxy.makeConxList(e):s.is.tack&&(s.bus.hasFilter()?e.push(s):s.bus.makeConxList(this,e)))}},nameChanged(e){var i;const t=this.node.pads.find(s=>s.proxy==this);if(!t){console.log(`** No pad was found for this pin "${this.name}" - pin was removed`),this.node.look.removePin(this);return}if(this.name.length>0){t.nameChange(this.name);return}((i=t.routes)==null?void 0:i.length)>0?this.restoreSavedName(e):(this.node.look.removePin(this),this.node.removePad(t))}};Object.assign(ks.prototype,Ti.prototype,Ad);function ms(e,t=null){this.rect={x:0,y:0,w:0,h:0},this.is={tack:!0,selected:!1,highLighted:!1,channel:!1,top:!1},this.bus=e,this.wid=t??e.generateWid(),this.segment=0,this.dir="",this.route=null}ms.prototype={render(e){const t=this.is.selected?g.bus.cSelected:this.is.highLighted?g.bus.cHighLighted:g.bus.cNormal;this.bus.is.filter&&H.filterSign(e,this.getContactPoint(),g.bus.wCable,t),H.tack(e,this.dir,this.is.channel,this.is.top,this.rect,g.route.wNormal,t)},setRoute(e){this.route=e,e.to?e.from||(e.from=this):e.to=this;const t=e.from==this?e.to:e.from;this.is.channel=t.is.pad?t.proxy.is.channel:t.is.channel,this.is.top=t.is.pad?!t.proxy.is.input:t.is.input,this.orient()},orient(){const e=h=>h.is.pin?h.is.input:!h.proxy.is.input,t=this.route.wire,i=this.bus.wire,s=this.route.to==this?this.route.from:this.route.to,n=this.route.to==this?t.at(-1):t[0],o=this.route.to==this?t.at(-2):t[1];this.segment=this.bus.hitSegment(n),this.segment==0&&(console.error("*** SEGMENT ON BUS NOT FOUND ***",s,this.bus),this.segment=1);const r=Math.floor(i[this.segment-1].y)===Math.floor(i[this.segment].y),a=this.rect,l=i[this.segment],c=g.bus.wNormal/2-1;r?(a.w=g.bus.wArrow,a.h=g.bus.hArrow,a.x=n.x-a.w/2,o.y>n.y?(a.y=l.y+c,this.dir=e(s)?"down":"up"):(a.y=l.y-a.h-c,this.dir=e(s)?"up":"down"),n.y=l.y):(a.w=g.bus.hArrow,a.h=g.bus.wArrow,a.y=n.y-a.h/2,o.x>n.x?(a.x=l.x+c,this.dir=e(s)?"right":"left"):(a.x=l.x-a.w-c,this.dir=e(s)?"left":"right"),n.x=l.x)},placeOnSegment(e,t){this.segment=t;const i=this.bus.wire[t-1],s=this.bus.wire[t];i.x==s.x?(this.dir="left",this.rect.x=i.x,this.rect.y=e.y):(this.dir="up",this.rect.x=e.x,this.rect.y=i.y)},horizontal(){return this.dir=="left"||this.dir=="right"},center(){const e=this.rect;if(this.segment==0)return null;const t=this.bus.wire[this.segment];return this.dir=="left"||this.dir=="right"?{x:t.x,y:e.y+e.h/2}:{x:e.x+e.w/2,y:t.y}},toJSON(){return k.routeToString(this.route)},overlap(e){const t=this.rect;return!(t.x>e.x+e.w||t.x+t.w<e.x||t.y>e.y+e.h||t.y+t.h<e.y)},remove(){this.route.remove()},removeRoute(e){this.bus.removeTack(this)},moveX(e){this.rect.x+=e;const t=this.route.from==this?this.route.wire[0]:this.route.wire.at(-1);t.x+=e,this.orient()},moveY(e){this.rect.y+=e;const t=this.route.from==this?this.route.wire[0]:this.route.wire.at(-1);t.y+=e,this.orient()},moveXY(e,t){this.rect.x+=e,this.rect.y+=t,this.route.wire.length==2&&this.route.addTwoSegments(this.route.wire[0],this.route.wire[1]);const i=this.route.from==this?this.route.wire[0]:this.route.wire.at(-1),s=this.route.from==this?this.route.wire[1]:this.route.wire.at(-2);Math.abs(i.x-s.x)<Math.abs(i.y-s.y)?(i.x+=e,s.x+=e,i.y+=t):(i.y+=t,s.y+=t,i.x+=e),this.orient()},slide(e){let t=this.bus.wire[this.segment-1],i=this.bus.wire[this.segment];const s=this.rect,n=g.bus.wNormal;if(t.y==i.y){let o=Math.max(t.x,i.x)-s.w-n/2,r=Math.min(t.x,i.x)+n/2;s.x+=e.x,s.x=s.x>o?o:s.x<r?r:s.x}else{let o=Math.max(t.y,i.y)-s.h-n/2,r=Math.min(t.y,i.y)+n/2;s.y+=e.y,s.y=s.y>o?o:s.y<r?r:s.y}this.route.adjust()},fuseEndSegment(){if(this.route.wire.length<4)return;const e=this.route,t=e.wire,[i,s,n,o]=this==e.from?[t[0],t[1],t[2],!0]:[t.at(-1),t.at(-2),t.at(-3),!1];i.y==s.y&&Math.abs(n.y-s.y)<g.route.tooClose?(i.y=n.y,o?e.removeTwoPoints(1,t):e.removeTwoPoints(t.length-3,t),this.orient()):i.x==s.x&&Math.abs(s.x-n.x)<g.route.tooClose&&(i.x=n.x,o?e.removeTwoPoints(1,t):e.removeTwoPoints(t.length-3,t),this.orient())},restore(e){this.route=e,this.bus.tacks.push(this),this.orient()},getOther(){return this.route.from==this?this.route.to:this.route.from},getOtherPin(){const e=this.route.from==this?this.route.to:this.route.from;return e.is.pin?e:e.is.pad?e.proxy:null},getContactPoint(){return this.route.from==this?this.route.wire[0]:this.route.wire.at(-1)},incoming(){const e=this.route.from==this?this.route.to:this.route.from;return e.is.pin?!e.is.input:e.is.pad?e.proxy.is.input:!1},highLightRoutes(){},unHighLightRoutes(){}};function Un(e,t){this.rect={...e},this.is={busLabel:!0,beingEdited:!1,highLighted:!1,horizontal:!0},this.text=t.name,this.bus=t}const Dd={makeRect(e,t,i,s){const n=this.rect;this.is.horizontal=Math.abs(e.x-t.x)>0,this.is.horizontal?(n.x=e.x<t.x?e.x-i:e.x,n.y=e.y-s/2,n.h=s,n.w=i):(n.x=e.x-s/2,n.y=e.y<t.y?e.y-i:e.y,n.h=i,n.w=s,e.y==t.y&&this==this.bus.startLabel&&(n.y=e.y-i))},place(){const e=g.bus,t=this.bus.wire,i=this.text.length*e.sChar+2*e.hLabel;this==this.bus.startLabel?this.makeRect(t[0],t[1],i,e.hLabel):this.makeRect(t.at(-1),t.at(-2),i,e.hLabel)},startEdit(){return this.is.beingEdited=!0,"text"},endEdit(e){this.setText(this.text),this.is.beingEdited=!1},setText(e){const t=this==this.bus.startLabel?this.bus.endLabel:this.bus.startLabel;this.bus.name=e,this.text=e,t.text=e,this.place(),t.place()},drawCursor(e,t,i){const s=H.centerTextCursor(e,this.rect,this.text,t),n=i?g.std.cBlinkOn:g.std.cBlinkOff;this.is.horizontal?H.cursor(e,s.x,s.y,g.std.wCursor,this.rect.h,n):H.cursor(e,this.rect.x,s.y+.75*this.rect.w,this.rect.w,g.std.wCursor,n)},render(e,t){if(this.is.beingEdited){const r=this==this.bus.startLabel?this.bus.endLabel:this.bus.startLabel;r.text=this.text,this.place(),r.place()}const i=g.bus,s=this.rect,n=this.bus.is,o=n.hoverNok?i.cBad:n.selected||n.hoverOk?i.cSelected:n.highLighted?i.cHighLighted:i.cNormal;this.bus.is.filter&&H.filterSymbol(e,s.x-i.wFilter,s.y-i.wFilter,i.wFilter,o),this.bus.is.cable?this.is.horizontal?H.hCableLabel(e,this.text,s.x,s.y,s.w,s.h,i.radius,o,i.cText):H.vCableLabel(e,this.text,s.x,s.y,s.w,s.h,i.radius,o,i.cText):this.is.horizontal?H.hBusbarLabel(e,this.text,s.x,s.y,s.w,s.h,i.radius,o,i.cText):H.vBusbarLabel(e,this.text,s.x,s.y,s.w,s.h,i.radius,o,i.cText)},setSize(e){return this.rect.w=e.measureText(this.text).width+2*g.bus.hLabel,this.rect.h=g.bus.hLabel,this},move(e,t){this.rect.x+=e,this.rect.y+=t},highLight(){this.is.highLighted=!0},unHighLight(){this.is.highLighted=!1},inside(e){return rt({x:this.rect.x,y:this.rect.y},e)}};Object.assign(Un.prototype,Dd);function Zs(e,t,i){this.rect={...e},this.node=i,this.is={ifName:!0,added:!1,zombie:!1,selected:!1,highLighted:!1},this.text=t??"",this.wid=0}Zs.prototype={startEdit(){return"text"},endEdit(e){this.text=k.cleanInput(this.text),this.node.look.ifNameChanged(this,e)},drawCursor(e,t,i){const s=H.centerTextCursor(e,this.rect,this.text,t),n=i?g.std.cBlinkOn:g.std.cBlinkOff;H.cursor(e,s.x,s.y,g.std.wCursor,this.rect.h,n)},render(e,t){const{x:i,y:s,w:n,h:o}=this.rect,r=g.ifName,a=this.is.added?r.cAdded:this.is.zombie?r.cBad:this.is.highLighted?r.cHighLighted:this.is.selected?r.cSelected:r.cNormal;H.interfaceText(e,this.text,r.font,a,r.cBackground,i,s,n,o)},toJSON(){return{ifPins:this.text,id:this.wid}},drag(e){this.node.look.rect;const t=this.node.look.findNextWidget(this,e,i=>i.is.pin||i.is.ifName);t&&([this.rect.y,t.rect.y]=[t.rect.y,this.rect.y],t.is.pin&&t.ifNamePrefixCheck(),t.is.pin&&t.adjustRoutes())},moveTo(e){const t=this.rect;for(const i of this.node.look.widgets){const s=i.rect;t.y>e&&s.y>=e&&s.y<t.y&&(s.y+=t.h,i.is.pin&&i.adjustRoutes()),t.y<e&&s.y<=e&&s.y>t.y&&(s.y-=t.h,i.is.pin&&i.adjustRoutes())}t.y=e},highLight(){this.is.highLighted=!0},unHighLight(){this.is.highLighted=!1},doSelect(){this.is.selected=!0},unSelect(){this.is.selected=!1}};function en(e,t,i){this.rect={...e},this.node=i,this.is={label:!0},this.text=t}en.prototype={startEdit(){return"text"},endEdit(e){},drawCursor(e,t,i){const s=this.rect,n=H.labelCursor(e,this.text,s.x,s.y,s.w,s.h,t),o=i?g.std.cBlinkOn:g.std.cBlinkOff;H.cursor(e,n.x,n.y,g.std.wCursor,s.h,o)},render(e,t){const{x:i,y:s,w:n,h:o}=this.rect;H.labelText(e,this.text,g.label.font,g.label.cNormal,i,s,n,o)},toJSON(){return this.text}};function wn(e,t){this.rect={...e},this.is={icon:!0,bad:!1,highLighted:!1},this.type=t,this.render=()=>{console.warn("Missing render function for icon ",this.type)}}wn.prototype={setRender(){this.render=this.renderFunctions[this.type]||this.renderFunctions.dummy},switchType(e){this.type=e,this.setRender()},renderFunctions:{link(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?g.icon.cHighLighted:this.is.bad?g.icon.cBadLink:g.icon.cLink;tt.link(e,t,i,s,n,o)},lock(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?g.icon.cHighLighted:this.is.bad?g.icon.cBadLink:g.icon.cLink;tt.lock(e,t,i,s,n,o)},factory(e){const{x:t,y:i,w:s,h:n}={...this.rect};tt.factory(e,t,i,s,n,g.icon.cSrc)},group(e){const{x:t,y:i,w:s,h:n}={...this.rect};tt.group(e,t,i,s,n,g.icon.cGroup)},cog(e){const{x:t,y:i,w:s,h:n}={...this.rect};tt.cog(e,t,i,s,n,g.icon.cCog,g.header.cBackground)},pulse(e){const{x:t,y:i,w:s,h:n}={...this.rect};tt.pulse(e,t,i,s,n,g.icon.cPulse,g.header.cBackground)},comment(e){const{x:t,y:i,w:s,h:n}={...this.rect};tt.comment(e,t,i,s,n,g.icon.cComment)},close(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?g.view.cClose:g.view.cDim;tt.close(e,t,i,s,n,o)},big(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?g.view.cFullscreen:g.view.cDim;tt.bigView(e,t,i,s,n,o)},small(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?g.view.cFullscreen:g.view.cDim;tt.smallView(e,t,i,s,n,o)},calibrate(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?g.view.cCalibrate:g.view.cDim;tt.calibrate(e,t,i,s,n,o)},grid(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?g.view.cGrid:g.view.cDim;tt.grid(e,t,i,s,n,o)},dummy(e){console.warn("Cannot render unknown icon type:",this)}},toJSON(){}};function ra(e,t){this.rect={...e},this.is={viewTitle:!0,highLighted:!1},this.node=t,this.text=t.name}ra.prototype={startEdit(){return"text"},endEdit(e){node.name=this.text},render(e){const t=this.rect,i=g.view,s=this.is.highLighted?i.cHighLight:i.cLine,n=this.is.highLighted?i.cTitleHighLight:i.cTitle;if(H.roundedHeader(e,t.x,t.y,t.w,i.hHeader,i.rCorner,i.wLine,null,s),H.centerText(e,this.node.name,g.view.fHeader,n,t.x,t.y,t.w,t.h),this.textEdit){let o=H.centerTextCursor(e,t,this.node.name,this.textEdit.cursor);H.cursor(e,o.x,o.y,2,t.h,n)}}};function aa(e){this.rect={...e},this.is={viewBox:!0,highLighted:!1}}aa.prototype={render(e){const t=this.rect,i=g.view,s=this.is.highLighted?i.cHighLight:i.cLine;H.viewRect(e,t.x,t.y,t.w,t.h,i.rCorner,i.wLine,s,i.cBackground)}};const Od={addWidget(e){this.widgets.push(e),this.rect.h+=e.rect.h;const t=this.widgets.find(i=>i.is.box);t&&t.increaseHeight(e.rect.h),e.wid!=null&&(e.wid=this.generateWid())},generateWid(){return++this.widGenerator},addBox(){const e=new Ks(this.rect,this.node);this.widgets.push(e)},findLabel(){for(const e of this.widgets)if(e.is.label)return e;return null},setDuplicatePin(e){e.is.duplicate=!1;const t=[];for(const i of this.widgets)!i.is.pin||i==e||(i.is.duplicate&&t.push(i),(e.nameClash(i)||e.hasFullNameMatch(i))&&(e.is.duplicate=i.is.duplicate=!0));if(t.length!=0){for(const i of t)i.is.duplicate=!1;for(let i=0;i<t.length;i++)if(!t[i].is.duplicate)for(let s=i+1;s<t.length;s++)(t[i].nameClash(t[s])||t[i].hasFullNameMatch(t[s]))&&(t[i].is.duplicate=t[s].is.duplicate=!0)}},makePlace(e,t){let i=this.rect.y+this.rect.h-g.look.hBottom;if(!e)return i;for(const s of this.widgets)(s.is.pin||s.is.ifName)&&s.rect.y+s.rect.h/2>e.y&&(s.rect.y<i&&(i=s.rect.y),s.rect.y+=t,s.routes&&s.adjustRoutes());return i},pinRectangle(e,t,i,s=!1){const n=g.pin;let o=this.rect;const r=n.wMargin+this.getTextWidth(e,s);r>o.w&&this.wider(r-o.w);const a=this.makePlace({x:0,y:t},g.pin.hPin);return i?{x:o.x-n.wOutside,y:a,w:r,h:n.hPin}:{x:o.x+o.w-r+n.wOutside,y:a,w:r,h:n.hPin}},nextPinPosition(e){const t=this.rect;return{x:e?t.x:t.x+t.w,y:t.y+t.h-g.look.hBottom}},shiftUp(e,t){for(const i of this.widgets)if(i.is.box)i.rect.h-=t;else if(i.rect.y>e&&(i.rect.y-=t,i.routes))for(const s of i.routes)s.clampToWidget(i);this.rect.h-=t},movePin(e,t){const i=e.rect.y,s=e.rect.h;e.rect.y=this.makePlace(t,e.rect.h);for(const n of e.routes)n.clampToWidget(e);for(const n of this.widgets)if(n.rect.y>i&&(n.rect.y-=s,n.routes))for(const o of n.routes)o.clampToWidget(n)},ifNameChanged(e,t){if(this.interfaceChangePrefix(e),e.text.length>0){let i=this.getTextWidth(e.text);i>this.rect.w&&this.wider(i-this.rect.w)}else e.node.look.removeInterfaceName(e)},NEW_findPin(e,t=!0){for(const i of this.widgets)if(i.is.pin&&i.name==e)return i;return null},findPin(e,t=!0){for(const i of this.widgets)if(i.is.pin&&i.name==e&&i.is.input==t)return i;return null},findInterfaceName(e){for(const t of this.widgets)if(t.is.ifName&&t.text==e)return t;return null}},F={nothing:0,node:1,pin:2,ifName:3,icon:4,header:5,label:6,pad:7,padArrow:8,route:9,busSegment:10,busLabel:11,tack:12,selection:13},Fe=0,We=1,Ue=2,zn=4,Id={keyMask(e){let t=Fe;return t|=e.shiftKey?We:0,t|=e.ctrlKey?Ue:0,t|=e.altKey?zn:0,t},mouseHit(e){const t=this.hit;if(this.selection.what!=$.nothing&&this.selection.what!=$.singleNode&&([t.what,t.selection,t.node]=this.selection.hitTest(e),t.what!=F.nothing)||!this.root)return;const i=this.root.nodes;for(let s=i.length-1;s>=0;s--)if([t.what,t.node,t.lookWidget]=i[s].hitTest(e),t.what!=F.nothing)return;for(const s of this.root.pads)if([t.what,t.pad]=s.hitTest(e),t.what!=F.nothing)return;for(const s of this.root.buses)if([t.what,t.bus,t.busLabel,t.tack,t.busSegment]=s.hitTest(e),t.what!=F.nothing)return;this.mouseHitRoutes(e)},mouseHitRoutes(e){const t=this.hit;for(const i of this.root.nodes)if([t.what,t.route,t.routeSegment]=i.hitRoute(e),t.what!=F.nothing)return;for(const i of this.root.pads)if([t.what,t.route,t.routeSegment]=i.hitRoute(e),t.what!=F.nothing)return;for(const i of this.root.buses)if([t.what,t.route,t.routeSegment]=i.hitRoute(e),t.what!=F.nothing)return},onDblClick(e,t){const i=this.hit;switch(i.what){case F.pin:case F.ifName:if(!i.node||i.node.cannotBeModified())return;f.doEdit("widgetTextEdit",{view:this,widget:i.lookWidget});break;case F.header:f.doEdit("widgetTextEdit",{view:this,widget:i.lookWidget});break;case F.label:f.doEdit("widgetTextEdit",{view:this,widget:i.lookWidget});break;case F.busLabel:f.doEdit("widgetTextEdit",{view:this,widget:i.busLabel});break;case F.pad:f.doEdit("widgetTextEdit",{view:this,widget:i.pad});break}},onWheel(e,t){const i=this.tf;let s=t.deltaY>0?.9:1.1;i.dx=i.dx+e.x*i.sx*(1-s),i.dy=i.dy+e.y*i.sy*(1-s),i.sx*=s,i.sy*=s}},Fd={pinAreaStart(e,t){this.reset();const i=e.look.rect;this.yWidget=t.y,this.what=$.pinArea,this.activate(i.x-g.pin.wOutside,t.y,i.w+2*g.pin.wOutside,0,g.selection.cRect)},pinAreaResize(e,t){const i=e.look.rect;if(t.y>i.y&&t.y<i.y+i.h){const s=this.yWidget;t.y>s?(this.rect.y=s,this.rect.h=t.y-s):(this.rect.y=t.y,this.rect.h=s-t.y),this.widgets=[];const n=g.pin.hPin/2;for(const o of e.look.widgets)(o.is.pin||o.is.ifName)&&(o.rect.y+n>this.rect.y&&o.rect.y+n<this.rect.y+this.rect.h?(this.widgets.push(o),o.is.selected=!0):o.is.selected=!1)}},pinAreaSelect(e){if(e.length!=0){this.widgets.length=0;for(const t of e)(t.is.pin||t.is.ifName)&&(this.widgets.push(t),t.is.selected=!0);this.pinAreaRectangle()}},pinAreaRectangle(){if(this.widgets.length==0)return;this.widgets.sort((s,n)=>s.rect.y-n.rect.y);const e=this.widgets[0].node.look,t=this.widgets[0].rect,i=this.widgets.at(-1).rect;this.activate(e.rect.x-g.pin.wOutside,t.y,e.rect.w+2*g.pin.wOutside,i.y+i.h-t.y,g.selection.cRect),this.what=$.pinArea},pinAreaDrag(e){if(this.widgets.length==0)return;const t=this.widgets[0].node;this.rect.y+e.y<t.look.rect.y+g.header.hHeader||this.rect.y+e.y>t.look.rect.y+t.look.rect.h||(this.rect.y+=e.y)}},$={nothing:0,freeRect:1,pinArea:2,singleNode:4,multiNode:5};function _s(e=null){this.rect={x:0,y:0,w:0,h:0},this.yWidget=0,this.color=g.selection.cRect,this.what=$.nothing,this.viewPath=e?e.getNamePath():"",this.nodes=[],this.pads=[],this.buses=[],this.tacks=[],this.widgets=[]}_s.prototype={render(e){if(this.what===$.freeRect||this.what===$.pinArea){const t=this.rect;H.roundedRect(e,t.x,t.y,t.w,t.h,g.selection.rCorner,1,this.color.slice(0,7),this.color)}},reset(){this.what=$.nothing,this.yWidget=0;for(const e of this.widgets)e.unSelect();for(const e of this.nodes)e.unSelect();this.nodes.length=0,this.pads.length=0,this.buses.length=0,this.widgets.length=0,this.tacks.length=0},shallowCopy(){var t,i,s,n,o;const e=new _s;return e.rect={...this.rect},e.yWidget=this.yWidget,e.color=this.color,e.what=this.what,e.viewPath=this.viewPath,e.nodes=(t=this.nodes)==null?void 0:t.slice(),e.pads=(i=this.pads)==null?void 0:i.slice(),e.buses=(s=this.buses)==null?void 0:s.slice(),e.tacks=(n=this.tacks)==null?void 0:n.slice(),e.widgets=(o=this.widgets)==null?void 0:o.slice(),e},canCancel(e){return e.what==F.selection?!1:this.what===$.freeRect||this.what===$.pinArea},setRect(e,t,i,s){const n=this.rect;n.x=e,n.y=t,n.w=i,n.h=s},activate(e,t,i,s,n){this.setRect(e,t,i,s),n&&(this.color=n)},freeStart(e){this.reset(),this.what=$.freeRect,this.setRect(e.x,e.y,0,0)},singleNode(e){this.reset(),this.nodes=[e],this.what=$.singleNode,e.doSelect()},singleNodeAndWidget(e,t){this.reset(),this.singleNode(e),this.widgets=[t],t.doSelect()},extend(e){if(this.nodes.length<1){this.singleNode(e);return}if(this.nodes.includes(e)){Ne(this.nodes,e),e.unSelect();return}this.nodes.push(e),e.doSelect(),this.what=$.multiNode},getSingleNode(){return this.what==$.singleNode?this.nodes[0]:null},getSelectedWidget(){return this.what==$.singleNode?this.widgets[0]:null},getPinAreaNode(){return this.what==$.pinArea&&this.widgets[0]?this.widgets[0].node:null},switchWidget(e){var s;if(e){(s=this.widgets[0])==null||s.unSelect(),e.doSelect(),this.widgets[0]=e;return}const t=this.widgetBelow();if(t)return this.switchWidget(t);const i=this.widgetAbove();if(i)return this.switchWidget(i)},widgetBelow(){const[e,t]=this.what!=$.singleNode?[null,null]:[this.nodes[0],this.widgets[0]];if(!t||!e)return null;let i=null;for(const s of e.look.widgets)(s.is.pin||s.is.ifName)&&s.rect.y>t.rect.y&&(!i||s.rect.y<i.rect.y)&&(i=s);return i},widgetAbove(){const[e,t]=this.what!=$.singleNode?[null,null]:[this.nodes[0],this.widgets[0]];if(!t||!e)return null;let i=null;for(const s of e.look.widgets)(s.is.pin||s.is.ifName)&&s.rect.y<t.rect.y&&(!i||s.rect.y>i.rect.y)&&(i=s);return i},hitTest(e){if((this.what==$.freeRect||this.what==$.pinArea)&&rt(e,this.rect))return[F.selection,this,null];for(let t=this.nodes.length-1;t>=0;t--)if(rt(e,this.nodes[t].look.rect))return[F.selection,this,this.nodes[t]];return[F.nothing,null,null]},setColor(e){this.color=e},resize(e,t){this.rect.w+=e,this.rect.h+=t},move(e){this.rect.x+=e.x,this.rect.y+=e.y},drag(e){for(const t of this.nodes)t.look.moveDelta(e.x,e.y);for(const t of this.pads)t.move(e);if(this.nodes.length>0)for(const t of this.buses)t.move(e.x,e.y);else for(const t of this.tacks)t.slide(e);for(const t of this.nodes)t.look.adjustRoutes();for(const t of this.pads)t.adjustRoutes();for(const t of this.buses)t.adjustRoutes();this.rect.x+=e.x,this.rect.y+=e.y},topLeftNode(){if(this.nodes.length==0)return null;let e=this.nodes[0];for(const t of this.nodes)t.look.rect.y<e.look.rect.y&&t.look.rect.x<e.look.rect.x&&(e=t);return e},makeViewRect(){const e=this.rect;return{x:e.x-g.view.wExtra,y:e.y-g.view.hExtra,w:e.w+2*g.view.wExtra,h:e.h+2*g.view.hExtra}},makeLookRect(){const e=this.topLeftNode(),t=this.rect,i=e?e.look.rect.x:t.x,s=e?e.look.rect.y:t.y;return{x:i,y:s,w:0,h:0}},adjustPaths(e){if(this.nodes)for(const t of this.nodes)t.adjustPaths(e)}};Object.assign(_s.prototype,Fd);const Wd={onMouseMove(e,t){let i={x:t.movementX/this.tf.sx,y:t.movementY/this.tf.sy};const s=this.state;switch(s.action){case S.nothing:return this.idleMove(e),!1;case S.panning:return this.tf.dx+=t.movementX,this.tf.dy+=t.movementY,!0;case S.nodeDrag:return s.node.move(i),!0;case S.routeDraw:return this.drawRoute(s.route,e),!0;case S.routeDrag:return s.route.moveSegment(s.routeSegment,i),!0;case S.selection:return this.selection.resize(i.x,i.y),!0;case S.selectionDrag:return this.selection.drag(i),!0;case S.pinAreaSelect:return this.selection.pinAreaResize(s.node,e),!0;case S.padDrag:return s.pad.drag(e,i),!0;case S.busDraw:return s.bus.drawXY(e),!0;case S.busRedraw:return s.bus.resumeDrawXY(s.busLabel,e,i),!0;case S.busSegmentDrag:return s.bus.moveSegment(s.busSegment,i),!0;case S.busDrag:return s.bus.drag(i),!0;case S.tackDrag:return s.tack.slide(i),!0;case S.pinDrag:return s.lookWidget.drag(e),!0;case S.pinAreaDrag:return this.selection.pinAreaDrag(i),this.selection.getPinAreaNode().look.dragPinArea(this.selection.widgets,this.selection.rect),!0;case S.interfaceNameDrag:return s.lookWidget.drag(e),!0;case S.interfaceDrag:return this.selection.pinAreaDrag(i),this.selection.widgets[0].node.look.swapInterface(e,this.selection.widgets),!0;case S.pinClicked:switch(this.keyMask(t)){case Fe:return rt(e,s.lookWidget.node.look.rect)?!1:(this.stateSwitch(S.routeDraw),s.route=new xt(s.lookWidget,null),s.route.select(),s.lookWidget.is.multi&&s.route.setTwistedPair(),s.lookWidget.routes.push(s.route),!0);case We:return s.lookWidget.unHighLightRoutes(),this.stateSwitch(S.pinAreaSelect),this.selection.pinAreaStart(s.node,e),!0;case Ue:{const n=s.lookWidget;return n.is.selected=!0,this.stateSwitch(S.pinDrag),f.doEdit("pinDrag",{pin:n}),!0}case Ue|We:{if(rt(e,s.lookWidget.node.look.rect))return!1;if(s.lookWidget.unHighLightRoutes(),f.doEdit("extrudePad",{view:this,pos:e}),this.state.pad){this.stateSwitch(S.padDrag);for(const n of this.state.pad.routes)n.highLight()}return!0}}return!1;case S.interfaceNameClicked:return rt(e,this.selection.widgets[0].rect)?!1:(this.selection.nodes[0].unSelect(),!0);case S.padArrowClicked:return rt(e,s.pad.rect)||(this.stateSwitch(S.routeDraw),s.route=new xt(s.pad,null),s.pad.proxy.is.multi&&s.route.setTwistedPair(),s.route.select(),s.pad.routes.push(s.route)),!0;default:return!1}},idleMove(e){return this.hitTimer,!1},drawRoute(e,t){this.mouseHit(t);const i=this.hit,s=i.what==F.pin?i.lookWidget:i.what==F.pad?i.pad:i.what==F.busSegment?i.bus:null;this.hover(s,s?e.checkConxType(e.from,s):!1),s&&(s.is.pin||s.is.pad)?e.endpoint(s):e.drawXY(t)},hover(e,t){this.hit;const i=this.state;i.hoverOver!=e&&(e?(e.is.hoverOk=t,e.is.hoverNok=!t,i.hoverOver&&(this.state.hoverOver.is.hoverOk=this.state.hoverOver.is.hoverNok=!1),i.hoverOver=e):i.hoverOver&&(this.state.hoverOver.is.hoverOk=this.state.hoverOver.is.hoverNok=!1,this.state.hoverOver=null))},stopHover(){this.state.hoverOver&&(this.state.hoverOver.is.hoverOk=this.state.hoverOver.is.hoverNok=!1,this.state.hoverOver=null)}},Hd={saveHitSpot(e,t){const i=this.hit;i.xyLocal.x=e.x,i.xyLocal.y=e.y,i.xyScreen.x=t.x,i.xyScreen.y=t.y},onMouseDown(e,t){const i=this.state,s=this.hit;this.saveHitSpot(e,t);const n=this.keyMask(t);switch(n===(Ue|zn)?this.mouseHitRoutes(e):this.mouseHit(e),this.selection.canCancel(s)&&this.selection.reset(),s.what){case F.pin:switch(n){case Fe:case Ue|We:i.lookWidget=s.lookWidget,i.node=s.node,s.lookWidget.highLightRoutes(),this.stateSwitch(S.pinClicked),this.selection.singleNodeAndWidget(s.node,s.lookWidget);break;case We:i.node=s.node,this.stateSwitch(S.pinAreaSelect),this.selection.pinAreaStart(s.node,e);break;case Ue:{const o=s.lookWidget;i.lookWidget=o,this.selection.singleNodeAndWidget(s.node,s.lookWidget),this.stateSwitch(S.pinDrag),f.doEdit("pinDrag",{pin:o})}break}break;case F.ifName:switch(n){case Fe:this.selection.singleNodeAndWidget(s.node,s.lookWidget),this.selection.widgets=s.node.look.highLightInterface(s.lookWidget),this.stateSwitch(S.interfaceNameClicked);break;case We:i.node=s.node,this.stateSwitch(S.pinAreaSelect),this.selection.pinAreaStart(s.node,e);break;case Ue:{this.selection.singleNodeAndWidget(s.node,s.lookWidget),this.selection.widgets=s.node.look.highLightInterface(s.lookWidget),this.selection.pinAreaRectangle();const o=this.selection.widgets;f.doEdit("interfaceDrag",{group:o.slice(),oldY:o[0].rect.y,newY:o[0].rect.y}),this.stateSwitch(S.interfaceDrag)}break;case Ue|We:f.doEdit("interfaceNameDrag",{ifName:s.lookWidget}),this.state.lookWidget=s.lookWidget,this.selection.singleNodeAndWidget(s.node,s.lookWidget),this.stateSwitch(S.interfaceNameDrag);break}break;case F.icon:switch(n){case Fe:case We:this.selection.singleNode(s.node),s.node.iconClick(this,s.lookWidget,{x:t.clientX,y:t.clientY});break;case Ue:this.selection.singleNode(s.node),s.node.iconCtrlClick(this,s.lookWidget,{x:t.clientX,y:t.clientY},f);break}break;case F.header:switch(n){case Fe:case We:this.selection.singleNode(s.node),this.stateSwitch(S.nodeDrag),i.node=s.node,f.doEdit("nodeDrag",{view:this,node:s.node});break;case Ue:this.selection.extend(s.node),this.stateSwitch(S.selectionDrag),f.doEdit("selectionDrag",{view:this});break}break;case F.node:switch(n){case Fe:this.selection.singleNode(s.node),this.stateSwitch(S.nodeDrag),i.node=s.node,f.doEdit("nodeDrag",{view:this,node:s.node});break;case We:i.node=s.node,this.stateSwitch(S.pinAreaSelect),this.selection.pinAreaStart(s.node,e);break;case Ue:this.selection.extend(s.node),this.stateSwitch(S.selectionDrag),f.doEdit("selectionDrag",{view:this});break}break;case F.route:switch(n){case Fe:case Ue|zn:f.doEdit("routeDrag",{route:s.route}),s.route.select(),this.stateSwitch(S.routeDrag),i.route=s.route,i.routeSegment=s.routeSegment;break;case We:f.doEdit("deleteRoute",{route:s.route}),s.route.resumeDrawing(s.routeSegment,e),s.route.select(),this.stateSwitch(S.routeDraw),i.route=s.route;break}break;case F.pad:switch(n){case Fe:i.pad=s.pad,s.pad.checkRoutesDirection(),s.pad.highLightRoutes(),this.stateSwitch(S.padDrag),f.doEdit("padDrag",{pad:s.pad});break}break;case F.padArrow:switch(n){case Fe:{i.pad=s.pad;for(const o of s.pad.routes)o.highLight();this.stateSwitch(S.padArrowClicked)}break}break;case F.selection:switch(n){case Fe:this.selection.what==$.freeRect&&(f.doEdit("selectionDrag",{view:this}),this.stateSwitch(S.selectionDrag));break;case We:s.node?(i.node=s.node,this.selection.pinAreaStart(s.node,e),this.stateSwitch(S.pinAreaSelect)):this.selection.what==$.pinArea?(this.selection.pinAreaStart(this.selection.getPinAreaNode(),e),this.stateSwitch(S.pinAreaSelect)):(this.selection.freeStart(e),this.stateSwitch(S.selection));break;case Ue:switch(this.selection.what){case $.singleNode:case $.multiNode:s.node&&this.selection.extend(s.node);break;case $.pinArea:this.stateSwitch(S.pinAreaDrag),f.doEdit("pinAreaDrag",this);break}break}break;case F.busLabel:switch(n){case Fe:this.stateSwitch(S.busRedraw),i.bus=s.bus,i.busLabel=s.busLabel,i.bus.is.selected=!0,i.bus.highLight(),f.doEdit("busDraw",{bus:s.bus});break}break;case F.busSegment:switch(n){case Fe:i.bus=s.bus,i.busSegment=s.busSegment,i.bus.is.selected=!0,s.bus.highLight(),s.bus.singleSegment()?(this.stateSwitch(S.busDrag),f.doEdit("busDrag",{bus:s.bus})):(this.stateSwitch(S.busSegmentDrag),f.doEdit("busSegmentDrag",{bus:s.bus}));break;case We:break;case Ue:i.bus=s.bus,i.bus.is.selected=!0,this.stateSwitch(S.busDrag),f.doEdit("busDrag",{bus:s.bus});break}break;case F.tack:switch(n){case Fe:this.stateSwitch(S.tackDrag),i.tack=s.tack,i.tack.route.select(),f.doEdit("tackDrag",{tack:s.tack});break;case We:{const o=s.tack.route;this.stateSwitch(S.routeDraw),i.route=o,f.doEdit("deleteRoute",{route:o}),o.resumeDrawing(o.wire.length-1,e),o.select()}break}break;case F.nothing:switch(n){case Fe:this.stateSwitch(S.panning),f.doEdit("panning",{view:this});break;case We:this.stateSwitch(S.selection),this.selection.freeStart(e);break}break}}},Bd={onMouseUp(e,t){this.mouseHit(e);let i=null;switch(this.state.action){case S.routeDraw:const s=this.state.route;s.unSelect(),s.from.unHighLightRoutes(),this.stopHover();const n=this.hit.lookWidget??this.hit.bus??this.hit.pad??null;s.connect(n)?f.doEdit("routeDraw",{route:s}):s.popFromRoute();break;case S.routeDrag:this.state.route.endDrag(this.state.routeSegment),this.state.route.unSelect(),f.getParam().newWire=this.state.route.copyWire();break;case S.selection:this.selection.rect&&this.getSelected(this.selection.rect);break;case S.selectionDrag:f.getParam().newPos={x:this.selection.rect.x,y:this.selection.rect.y};break;case S.pinAreaSelect:break;case S.nodeDrag:const o=this.state.node;o.look.snapRoutes();const r=f.getParam();r.newPos={x:o.look.rect.x,y:o.look.rect.y},gd(r.oldPos,r.newPos)<g.look.smallMove&&(o.move({x:r.oldPos.x-r.newPos.x,y:0}),f.dropLastEdit());break;case S.busDraw:case S.busRedraw:this.state.bus.is.selected=!1,this.state.bus.unHighLight(),f.getParam().newWire=this.state.bus.copyWire();break;case S.busSegmentDrag:this.state.bus.fuseSegment(this.state.busSegment),this.state.bus.is.selected=!1,this.state.bus.unHighLight(),i=f.getParam(),i.newWire=this.state.bus.copyWire(),i.newTackWires=this.state.bus.copyTackWires();break;case S.busDrag:this.state.bus.is.selected=!1,i=f.getParam(),i.newWire=this.state.bus.copyWire(),i.newTackWires=this.state.bus.copyTackWires();break;case S.padDrag:const a=this.state.pad;if(a.endDrag(),a.unHighLightRoutes(),f.getVerb()=="extrudePad")break;i=f.getParam(),i.newPos={x:a.rect.x,y:a.rect.y},i.newWires=a.copyWires();break;case S.tackDrag:const l=this.state.tack;l.fuseEndSegment(),l.route.unSelect(),f.getParam().newWire=l.route.copyWire();break;case S.pinDrag:const c=this.state.lookWidget;this.state.lookWidget.unHighLightRoutes(),f.getParam().newPos={left:c.is.left,y:c.rect.y};break;case S.pinAreaDrag:f.getParam().newY=this.selection.widgets[0].rect.y;break;case S.interfaceNameDrag:{const h=this.state.lookWidget;f.getParam().newY=h.rect.y}break;case S.interfaceDrag:{const h=this.selection.widgets[0];h==null||h.node.look.unhighLightInterface(this.selection.widgets),f.getParam().newY=h.rect.y,this.selection.singleNodeAndWidget(h.node,h)}break;case S.interfaceNameClicked:{const h=this.selection.widgets[0];h==null||h.node.look.unhighLightInterface(this.selection.widgets)}break;case S.pinClicked:this.state.lookWidget.unHighLight(),this.state.lookWidget.unHighLightRoutes();break;case S.padArrowClicked:this.state.pad.unHighLight();for(const h of this.state.pad.routes)h.unHighLight();break}this.stateSwitch(S.nothing)}},ke={choices:[{text:"new group node",icon:"account_tree",char:"ctrl g",state:"enabled",action:$d},{text:"new source node",icon:"factory",char:"ctrl s",state:"enabled",action:jd},{text:"new busbar",icon:"swap_horiz",char:"ctrl b",state:"enabled",action:Vd},{text:"new cable",icon:"cable",char:"ctrl k",state:"enabled",action:Ud},{text:"new input pad",icon:"new_label",char:"ctrl i",state:"enabled",action:zd},{text:"new output pad",icon:"new_label",char:"ctrl o",state:"enabled",action:qd},{text:"select node",icon:"play_arrow",char:"ctrl n",state:"enabled",action:Jd},{text:"paste as link",icon:"link",char:"ctrl l",state:"enabled",action:Gd},{text:"paste",icon:"content_copy",char:"ctrl v",state:"enabled",action:Yd}],view:null,xyLocal:null,xyScreen:null,prepare(e){this.view=e,this.xyLocal=e.hit.xyLocal,this.xyScreen=e.hit.xyScreen}};function $d(){f.doEdit("newGroupNode",{view:ke.view,pos:ke.xyLocal})}function jd(){f.doEdit("newSourceNode",{view:ke.view,pos:ke.xyLocal})}function Vd(){f.doEdit("busCreate",{view:ke.view,pos:ke.xyLocal,cable:!1})}function Ud(){f.doEdit("busCreate",{view:ke.view,pos:ke.xyLocal,cable:!0})}function zd(){f.doEdit("padCreate",{view:ke.view,pos:ke.xyLocal,input:!0})}function qd(){f.doEdit("padCreate",{view:ke.view,pos:ke.xyLocal,input:!1})}function Jd(){f.tx.send("select node",{xyScreen:ke.xyScreen,xyLocal:ke.xyLocal})}function Gd(){f.tx.request("clipboard get",f.doc).then(e=>{e.selection.what==$.nothing||e.selection.what==$.pinArea||f.doEdit("linkFromClipboard",{view:ke.view,pos:ke.xyLocal,clipboard:e})})}function Yd(){f.tx.request("clipboard get",f.doc).then(e=>{e.selection.what==$.nothing||e.selection.what==$.pinArea||f.doEdit("pasteFromClipboard",{view:ke.view,pos:ke.xyLocal,clipboard:e})})}const _e={choices:[{text:"",char:"h",state:"enabled",action:Mo,icon:"highlight"},{text:"add label",char:"a",state:"enabled",action:Xd,icon:"sell"},{text:"wider",char:"ctrl +",state:"enabled",action:Kd,icon:"open_in_full"},{text:"smaller",char:"ctrl -",state:"enabled",action:Qd,icon:"close_fullscreen"},{text:"copy",char:"ctrl c",state:"enabled",action:Zd,icon:"content_copy"},{text:"source to clipboard",state:"enabled",action:Do,icon:"content_paste"},{text:"make a test node",state:"enabled",action:eu,icon:"done_all"},{text:"",state:"enabled",action:Ao,icon:"sync"},{text:"cut link",state:"enabled",action:Oo,icon:"link_off"},{text:"get from link",state:"enabled",action:Io,icon:"link"},{text:"save to link",state:"enabled",action:Fo,icon:"add_link"},{text:"ungroup",state:"enabled",action:Wo,icon:"schema"},{text:"disconnect",char:"clear",state:"enabled",action:tu,icon:"power_off"},{text:"delete",char:"del",state:"enabled",action:iu,icon:"delete"}],view:null,node:null,xyLocal:null,prepare(e){this.view=e,this.xyLocal=e.hit.xyLocal,this.node=e.hit.node;let t=this.choices.find(i=>i.action==Do);t.state=this.node.is.source?"enabled":"disabled",t=this.choices.find(i=>i.action==Ao),t.state=this.node.link?"disabled":"enabled",t.text=this.node.is.group?"convert to source node":"convert to group node",t=this.choices.find(i=>i.action==Mo),t.text=this.node.is.highLighted?"remove highlight":"highlight routes",t=this.choices.find(i=>i.action==Oo),t.state=this.node.link?"enabled":"disabled",t=this.choices.find(i=>i.action==Fo),t.state=this.node.link?"disabled":"enabled",t=this.choices.find(i=>i.action==Io),t.state=this.node.link?"disabled":"enabled",t=this.choices.find(i=>i.action==Wo),t.state=this.node.is.group?"enabled":"disabled"}};function Xd(){f.doEdit("addLabel",{node:_e.node})}function Kd(){f.doEdit("wider",{node:_e.node})}function Qd(){f.doEdit("smaller",{node:_e.node})}function Mo(){f.doEdit("nodeHighLight",{node:_e.node})}function Zd(){f.doEdit("nodeToClipboard",{view:_e.view,node:_e.node})}function Ao(){f.doEdit("convertNode",{node:_e.node})}function eu(){}function Do(){f.doEdit("sourceToClipboard",{node:_e.node})}function tu(){f.doEdit("disconnectNode",{node:_e.node})}function iu(){f.doEdit("deleteNode",{node:_e.node})}function Oo(){f.doEdit("cutLink",{node:_e.node})}function Io(){_e.node.showLinkForm(_e.xyLocal)}function Fo(){_e.node.showExportForm(_e.xyLocal)}function Wo(){f.doEdit("unGroup",{view:_e.view,node:_e.node})}const su=[{text:"new output",char:"o",icon:"logout",state:"enabled",action:ru},{text:"new input",char:"i",icon:"login",state:"enabled",action:ou},{text:"new ifName",char:"p",icon:"drag_handle",state:"enabled",action:cu},{text:"new request",char:"q",icon:"switch_left",state:"enabled",action:au},{text:"new reply",char:"r",icon:"switch_right",state:"enabled",action:lu},{text:"change to output",icon:"cached",state:"disabled",action:la},{text:"add channel",icon:"adjust",state:"disabled",action:ca},{text:"paste pins",char:"ctrl v",icon:"content_copy",state:"enabled",action:du},{text:"profile",icon:"info",state:"disabled",action:sn},{text:"all pins swap left right",icon:"swap_horiz",state:"enabled",action:da},{text:"all pins left",icon:"arrow_back",state:"enabled",action:ua},{text:"all pins right",icon:"arrow_forward",state:"enabled",action:fa},{text:"disconnect",icon:"power_off",state:"disabled",action:tn},{text:"delete",icon:"delete",state:"enabled",action:ha}],nu=[{text:"profile",icon:"info",state:"disabled",action:sn},{text:"all pins swap left right",icon:"swap_horiz",state:"enabled",action:da},{text:"all pins left",icon:"arrow_back",state:"enabled",action:ua},{text:"all pins right",icon:"arrow_forward",state:"enabled",action:fa},{text:"disconnect",icon:"power_off",state:"disabled",action:tn}],Q={choices:null,view:null,node:null,widget:null,xyLocal:null,xyScreen:null,prepare(e){var s,n,o,r,a,l,c,h;if(this.view=e,this.node=e.hit.node,this.widget=e.hit.lookWidget,this.xyLocal=e.hit.xyLocal,this.xyScreen=e.hit.xyScreen,this.node.link){this.choices=nu;let u=this.choices.find(m=>m.action==tn);u.state=(s=this.widget)!=null&&s.is.pin?"enabled":"disabled",u=this.choices.find(m=>m.action==sn),u.state=(n=this.widget)!=null&&n.is.pin?"enabled":"disabled";return}this.choices=su;let t=this.choices.find(u=>u.action==tn);t.state=(o=this.widget)!=null&&o.is.pin?"enabled":"disabled",t=this.choices.find(u=>u.action==la);let i=((r=this.widget)==null?void 0:r.is.pin)&&this.widget.routes.length==0;t.state=i?"enabled":"disabled",t.text=i&&this.widget.is.input?"change to output":"change to input",t=this.choices.find(u=>u.action==ca),i=(a=this.widget)==null?void 0:a.is.pin,t.state=i?"enabled":"disabled",t.text=i&&this.widget.is.channel?"remove channel":"add channel",t=this.choices.find(u=>u.action==sn),t.state=(l=this.widget)!=null&&l.is.pin?"enabled":"disabled",t=this.choices.find(u=>u.text=="delete"),t.action=(c=this.widget)!=null&&c.is.pin?ha:(h=this.widget)!=null&&h.is.ifName?hu:()=>{},t=this.choices.find(u=>u.text=="paste pins")}};function ou(){var t;(t=Q.node)==null||t.cannotBeModified();const e={channel:!1,input:!0,proxy:Q.node.is.group};f.doEdit("newPin",{view:Q.view,node:Q.node,pos:Q.xyLocal,is:e})}function ru(){const e={channel:!1,input:!1,proxy:Q.node.is.group};f.doEdit("newPin",{view:Q.view,node:Q.node,pos:Q.xyLocal,is:e})}function au(){const e={channel:!0,input:!1,proxy:Q.node.is.group};f.doEdit("newPin",{view:Q.view,node:Q.node,pos:Q.xyLocal,is:e})}function lu(){const e={channel:!0,input:!0,proxy:Q.node.is.group};f.doEdit("newPin",{view:Q.view,node:Q.node,pos:Q.xyLocal,is:e})}function la(){f.doEdit("ioSwap",{pin:Q.widget})}function ca(){f.doEdit("channelOnOff",{pin:Q.widget})}function tn(){f.doEdit("disconnectPin",{pin:Q.widget})}function ha(){f.doEdit("deletePin",{view:Q.view,pin:Q.widget})}function cu(){f.doEdit("newInterfaceName",{view:Q.view,node:Q.node,pos:Q.xyLocal})}function hu(){f.doEdit("deleteInterfaceName",{view:Q.view,ifName:Q.widget})}function sn(e){f.doEdit("showProfile",{pin:Q.widget,pos:{x:Q.xyScreen.x,y:Q.xyScreen.y+10}})}function da(){f.doEdit("swapPins",{node:Q.node,left:!0,right:!0})}function ua(){f.doEdit("swapPins",{node:Q.node,left:!0,right:!1})}function fa(){f.doEdit("swapPins",{node:Q.node,left:!1,right:!0})}function du(){f.tx.request("clipboard get",f.doc).then(e=>{f.doEdit("pasteWidgetsFromClipboard",{view:Q.view,clipboard:e})})}const At={choices:[{text:"align left",icon:"align_horizontal_left",state:"enabled",action:()=>Ho(!0)},{text:"align right",icon:"align_horizontal_right",state:"enabled",action:()=>Ho(!1)},{text:"align top",icon:"align_vertical_top",state:"enabled",action:()=>uu(!0)},{text:"distribute vertically",icon:"vertical_distribute",state:"enabled",action:fu},{text:"distribute horizontally",icon:"horizontal_distribute",state:"enabled",action:pu},{text:"copy",icon:"content_copy",state:"enabled",action:vu},{text:"group",icon:"developer_board",state:"enabled",action:wu},{text:"disconnect",icon:"power_off",state:"enabled",action:gu},{text:"delete",icon:"delete",state:"enabled",action:mu}],view:null,xyLocal:null,prepare(e){this.view=e,this.xyLocal=e.hit.local}};function Ho(e){f.doEdit("alignVertical",{view:At.view,left:e})}function uu(e){f.doEdit("alignHorizontal",{view:At.view,top:e})}function fu(){f.doEdit("spaceVertical",{view:At.view})}function pu(){f.doEdit("spaceHorizontal",{view:At.view})}function gu(){f.doEdit("disconnectSelection",{selection:At.view.selection})}function mu(){f.doEdit("deleteSelection",{view:At.view})}function vu(){f.doEdit("selectionToClipboard",{view:At.view})}function wu(){f.doEdit("selectionToGroup",{view:At.view})}const at={choices:[{text:"copy",icon:"content_copy",state:"enabled",action:yu},{text:"disconnect",icon:"power_off",state:"enabled",action:xu},{text:"delete",icon:"delete",state:"enabled",action:bu},{text:"all pins swap left right",icon:"swap_horiz",state:"enabled",action:ku},{text:"all pins left",icon:"arrow_back",state:"enabled",action:_u},{text:"all pins right",icon:"arrow_forward",state:"enabled",action:Tu}],view:null,node:null,widgets:null,xyLocal:null,xyScreen:null,prepare(e){this.view=e,this.node=e.state.node,this.widgets=e.selection.widgets,this.xyLocal=e.hit.xyLocal,this.xyScreen=e.hit.xyScreen}};function yu(){f.doEdit("selectionToClipboard",{view:at.view})}function xu(){f.doEdit("disconnectPinArea",{view:at.view,node:at.node,widgets:at.widgets})}function bu(){f.doEdit("deletePinArea",{view:at.view,node:at.node,widgets:at.widgets})}function ku(){f.doEdit("swapPinArea",{view:at.view,left:!0,right:!0})}function _u(){f.doEdit("swapPinArea",{view:at.view,left:!0,right:!1})}function Tu(){f.doEdit("swapPinArea",{view:at.view,left:!1,right:!0})}const wt={choices:[{icon:"highlight",text:"",state:"enabled",action:Bo},{icon:"sell",text:"change name",state:"enabled",action:Pu},{icon:"sell",text:"",state:"enabled",action:$o},{icon:"rss_feed",text:"",state:"enabled",action:jo},{icon:"timeline",text:"straight connections",state:"enabled",action:Su},{icon:"power_off",text:"disconnect",state:"enabled",action:Lu},{icon:"delete",text:"delete",state:"enabled",action:Nu}],view:null,bus:null,label:null,xyLocal:null,prepare(e){this.view=e,this.bus=e.hit.bus,this.label=e.hit.busLabel,this.xyLocal=e.hit.xyScreen;let t=this.choices.find(i=>i.action==Bo);t.text=this.bus.is.highLighted?"remove highlight":"highlight routes",t=this.choices.find(i=>i.action==$o),t.text=this.bus.is.cable?"change to busbar":"change to cable",t=this.choices.find(i=>i.action==jo),t.state=this.bus.is.cable?"enabled":"disabled",t.text=this.bus.is.cable&&this.bus.is.filter?"change filter":"add filter"}};function Bo(){f.doEdit("busHighlight",{bus:wt.bus})}function Pu(){f.doEdit("busChangeName",{bus:wt.bus,label:wt.busLabel})}function $o(){f.doEdit("busChangeType",{bus:wt.bus})}function jo(){var s;const e=wt.bus,t=!e.filter||e.filter.fName.length<1?k.nodeToFactory(e.name):e.filter.fName,i=(s=e.filter)!=null&&s.arl?e.filter.arl.userPath:"";f.tx.send("show filter",{title:"Filter for "+e.name,name:t,path:i,pos:wt.xyLocal,ok:(n,o)=>{f.doEdit("busChangeFilter",{bus:e,newName:n.trim(),userPath:o.trim()})},open:async(n,o)=>{if((n!=t||o!=i)&&f.doEdit("busChangeFilter",{bus:e,newName:n.trim(),userPath:o.trim()}),n.length<1)return;const r=e.filter.arl??f.doc.resolve("./index.js");tx.send("open source file",{arl:r})},trash:()=>{f.doEdit("busDeleteFilter",{bus:e})},cancel:()=>{}})}function Su(){f.doEdit("busStraightConnections",{bus:wt.bus})}function Lu(){f.doEdit("busDisconnect",{bus:wt.bus})}function Nu(){f.doEdit("busDelete",{bus:wt.bus})}const Xi={choices:[{icon:"sell",text:"change name",state:"enabled",action:Cu},{icon:"power_off",text:"disconnect",state:"enabled",action:Ru},{icon:"delete",text:"delete",state:"enabled",action:Eu}],view:null,pad:null,prepare(e){this.view=e,this.pad=e.hit.pad}};function Cu(){f.doEdit("changeNamePad",{view:Xi.view,pad:Xi.pad})}function Ru(){f.doEdit("disconnectPad",{pad:Xi.pad})}function Eu(){f.doEdit("deletePad",{pad:Xi.pad})}const Mu={onContextMenu(e,t){switch(this.saveHitSpot(e,t),this.mouseHit(e),this.hit.what){case F.header:case F.icon:_e.prepare(this),f.tx.send("show context menu",{menu:_e.choices,event:t});break;case F.node:case F.pin:case F.ifName:Q.prepare(this),f.tx.send("show context menu",{menu:Q.choices,event:t});break;case F.busSegment:case F.busLabel:wt.prepare(this),f.tx.send("show context menu",{menu:wt.choices,event:t});break;case F.pad:case F.padArrow:Xi.prepare(this),f.tx.send("show context menu",{menu:Xi.choices,event:t});break;case F.selection:switch(this.selection.what){case $.freeRect:case $.multiNode:At.prepare(this),f.tx.send("show context menu",{menu:At.choices,event:t});break;case $.pinArea:at.prepare(this),f.tx.send("show context menu",{menu:at.choices,event:t});break}break;case F.nothing:ke.prepare(this),f.tx.send("show context menu",{menu:ke.choices,event:t});break}}},Au={syncRoot(e){var t;e.rxtxBuildTxTable(),e.is.placed||e.placeRoot(),this.root=this.getContainer(e),(t=this.root.savedView)!=null&&t.tf&&this.setTransform(this.root.savedView.tf),this.restoreSubViews()},getContainer(e){if(e.isContainer())return e;const t=this.initRoot("");return t.nodes.push(e),t},newEmptyNode(e,t){const i=new yt({x:e.x,y:e.y,w:0,h:0}),s=t?new xi(i,""):new Dt(i,"");f.doc.UID.generate(s),this.root.addNode(s),this.selection.singleNode(s);const n=s.look.widgets.find(o=>o.is.header);return this.beginTextEdit(n),this.hit.xyLocal.y=e.y+n.rect.h,s}},Du={getSelected(e){const t=this.selection;for(const i of this.root.nodes)i.overlap(e)&&t.nodes.push(i);for(const i of this.root.pads)i.overlap(e)&&t.pads.push(i);for(const i of this.root.buses)if(i.overlap(e)){t.buses.push(i);for(const s of i.tacks)s.overlap(e)&&t.tacks.push(s)}},externalWidgets(e){let t=[];return e.forEach(i=>{i.look.widgets.forEach(s=>{var n;(n=s.routes)==null||n.forEach(o=>{(!e.includes(o.to.node)||!e.includes(o.from.node))&&t.push(s)})})}),t},deltaForPaste(e,t){t.copyCount++;const i=t.selection,s=i.what==$.freeRect?i.rect:i.what==$.multiNode?i.nodes[0].look.rect:{x:0,y:0};return s.x==e.x&&s.y==e.y?{x:t.copyCount*g.look.dxCopy,y:t.copyCount*g.look.dyCopy}:{x:e.x-s.x+(t.copyCount-1)*g.look.dxCopy,y:e.y-s.y+(t.copyCount-1)*g.look.dyCopy}},selectionToClipboard(){f.tx.send("clipboard set",{model:f.doc.model,selection:this.selection})},clipboardToSelection(e,t){var r;const i=this.deltaForPaste(e,t),[s,n]=this.selectedNodeAndPosition();this.selection.reset();const o=t.selection;switch(this.selection.what=o.what,o.what){case $.freeRect:case $.multiNode:for(const a of o.nodes){let l=a.copy();l.look.moveDelta(i.x,i.y),this.root.addNode(l),this.selection.nodes.push(l)}if(this.root.uidChangeAll(f.doc.UID),o.what==$.multiNode)return;for(const a of o.buses){let l=a.copy();l==null||l.move(i.x,i.y),this.selection.buses.push(l)}for(const a of o.pads);if(o.rect){const a=o.rect;this.selection.activate(a.x+i.x,a.y+i.y,a.w,a.h,g.selection.cRect)}break;case $.singleNode:{let a=(r=o.nodes[0])==null?void 0:r.copy();a.uidChangeAll(f.doc.UID),a.look.moveTo(i.x,i.y),this.root.addNode(a),this.selection.nodes.push(a),a.doSelect()}break;case $.pinArea:{if(!s||!n)return;const a=s.look.copyPinArea(o.widgets,n);s.is.source?s.rxtxAddPinArea(a):s.addPads(a),this.selection.pinAreaSelect(a)}break}},linkToClipboardNodes(e,t){for(const i of this.selection.nodes)i.setLink(e,i.name+t)},checkPastedNames(e){for(const t of this.selection.nodes){let i=e;for(;this.root.hasDuplicate(t)&&i<999;){const s=k.addNumber(t.name,i++);t.updateName(s)}}},xxlinkToClipboardNodes(e,t){const i=e.selection.nodes.length;if(i==this.selection.nodes.length)for(let s=0;s<i;s++)this.selection.nodes[s].setLink(t,e.selection.nodes[s].name)},removeSelection(e){this.selection.reset();for(const t of e.nodes)this.root.removeNode(t);for(const t of e.buses)this.root.removeBus(t);for(const t of e.pads)this.root.removePad(t)},restoreSelection(e){for(const s of e.nodes)this.root.restoreNode(s);for(const s of e.buses)this.root.restoreBus(s);for(const s of e.pads)this.root.restorePad(s);const t=this.selection;t.reset();for(const s of e.nodes)t.nodes.push(s);for(const s of e.buses)t.buses.push(s);for(const s of e.pads)t.pads.push(s);const i=e.rect;t.activate(i.x,i.y,i.w,i.h,e.color)},selectedNodeAndPosition(){const e=this.selection.getSingleNode();if(!e)return[null,null];const t=this.selection.getSelectedWidget(),i=t?{x:t.is.left?t.rect.x:t.rect.x+t.rect.w,y:t.rect.y+t.rect.h}:this.hit.xyLocal;return[e,i]}},Ou={singleSourceToGroup(){},selectionToGroup(e){const t=new yt(this.selection.makeLookRect()),i=new Dt(t,"new group",null);e.generate(i),this.root.addNode(i);const s=i.savedView=this.newSubView(i,this.selection.makeViewRect());s.translate(-s.rect.x,-s.rect.y);for(const o of this.selection.nodes)i.addNode(o),this.root.removeNode(o);const n=this.busTransfer(i);i.addProxies(this.selection);for(const o of n)this.busInterconnect(o.outside,i,o.inside);return i},busTransfer(e){const t=[];for(const i of this.selection.buses){const s=this.selection.nodes,n=[];for(const o of i.tacks){const r=o.route.from==o?o.route.to:o.route.from;r.is.pin&&!s.includes(r.node)&&n.push(o)}if(n.length==0)e.buses.push(i),this.root.removeBus(i);else{const o=i.copy();e.buses.push(o),i.splitTacks(o,e),t.push({outside:i,inside:o})}}return t},busInterconnect(e,t,i){function s(r){const a=r.route.to==r?r.route.from:r.route.to;return a.is.pad?a.proxy:a}function n(r,a){const l=s(r),c=s(a);return l.name!=c.name?!1:l.is.proxy==c.is.proxy?l.is.input!=c.is.input:l.is.input==c.is.input}const o=i.tacks.reduce((r,a)=>{const l=e.tacks.find(c=>n(a,c));if(l){const c=s(l),h=c.name+(c.is.input?">":"<");r[h]||(r[h]=a)}return r},{});for(const r of Object.values(o)){const a=s(r),l=t.copyPinAsProxy(a);t.addPad(l),e.makeRoute(l),i.makeRoute(l.pad)}},undoSelectionToGroup(e,t,i,s){t.disconnect(),t.savedView.closeView(),this.root.removeNode(t),this.restoreSelection(e);for(const n of t.buses)n.transferTacks(e.buses);for(const n of e.nodes)n.disconnect();for(const n of s)for(const o of n)o.reconnect()},transferToSelection(e,t){this.selection.reset();const i=this.calcRect(e),s=t.dx,n=t.dy;this.selection.activate(i.x+s,i.y+n,i.w,i.h);for(const o of e.pads)o.disconnect();for(const o of e.nodes)o.look.moveDelta(s,n),o.look.moveRoutes(s,n),this.root.nodes.push(o),this.selection.nodes.push(o);for(const o of e.buses)o.move(s,n),o.moveRoutes(s,n),this.root.buses.push(o),this.selection.buses.push(o);this.root.removeNode(e)},undoTransferToSelection(e,t,i){const s=-t.dx,n=-t.dy;for(const o of e.nodes)o.look.moveDelta(s,n),o.look.moveRoutes(s,n),view.root.removeNode(o);for(const o of e.buses)o.move(s,n),o.moveRoutes(s,n),e.removeBus(o);for(const o of i)o.reconnect();view.root.restoreNode(e)}},Iu={calcRow(e){e.sort((c,h)=>c.look.rect.x-h.look.rect.x);const t=g.selection.xPadding;let{x:i,y:s}={...e[0].look.rect},n=e.length-1,o=e[n].look.rect.x+e[n].look.rect.w-e[0].look.rect.x,r=0,a=0;e.forEach(c=>{r=Math.max(r,c.look.rect.h),a+=c.look.rect.w});let l=(o-a)/n;return l<t&&(l=t,o=a+n*t),{x:i,y:s,w:o,h:r,space:l}},calcColumn(e){e.sort((c,h)=>c.look.rect.y-h.look.rect.y);const t=g.selection.yPadding;let{x:i,y:s}={...e[0].look.rect},n=e.length-1,o=0,r=e[n].look.rect.y+e[n].look.rect.h-e[0].look.rect.y,a=0;e.forEach(c=>{o=Math.max(o,c.look.rect.w),a+=c.look.rect.h});let l=(r-a)/n;return l<t&&(l=t,r=a+n*t),{x:i,y:s,w:o,h:r,space:l}},calcRect(e){const t=e.nodes.length>0?e.nodes[0].look.rect:e.pads[0].rect,i={x:t.x,y:t.y},s={x:t.x+t.w,y:t.y+t.h};let n=null;return e.nodes.forEach(o=>{n=o.look.rect,i.x=Math.min(i.x,n.x),i.y=Math.min(i.y,n.y),s.x=Math.max(s.x,n.x+n.w),s.y=Math.max(s.y,n.y+n.h)}),e.pads.forEach(o=>{n=o.rect,i.x=Math.min(i.x,n.x),i.y=Math.min(i.y,n.y),s.x=Math.max(s.x,n.x+n.w),s.y=Math.max(s.y,n.y+n.h)}),{x:i.x,y:i.y,w:s.x-i.x,h:s.y-i.y}},nodesAlignHD(e,t=!0){const i=[],s=this.calcColumn(e);for(const n of e){const o=n.look.rect,r=t?s.x-o.x:s.x+s.w-o.x-o.w;i.push({x:r,y:0})}return i},nodesAlignVD(e){const t=[],i=this.calcRow(e);for(const s of e)t.push({x:0,y:i.y-s.look.rect.y});return t},nodesSpaceVD(e){const t=[],i=this.calcColumn(e);let s=i.y;for(const n of e){const o=n.look.rect;t.push({x:0,y:s-o.y}),s=s+o.h+i.space}return t},nodesSpaceHD(e){const t=[],i=this.calcRow(e);let s=i.x;for(const n of e){const o=n.look.rect;t.push({x:s-o.x,y:0}),s=s+o.w+i.space}return t},padsAlignHD(e,t=!0){const i=[];e.sort((n,o)=>n.rect.y-o.rect.y);const s=e[0].rect;for(const n of e){const o=n.rect,r=t?s.x-o.x:s.x+s.w-o.x-o.w;i.push({x:r,y:0})}return i},padsSpaceVD(e){const t=[];e.sort((o,r)=>o.rect.y-r.rect.y);const i=e[0].rect.y;let s=(e.at(-1).rect.y-e[0].rect.y)/(e.length-1),n=0;for(const o of e)t.push({x:0,y:i+n++*s-o.rect.y});return t},moveNodesAndRoutes(e,t,i=!1){const s=e.length;let n=0,o=0;for(let r=0;r<s;r++)n=i?-t[r].x:t[r].x,o=i?-t[r].y:t[r].y,e[r].look.moveDelta(n,o),e[r].look.moveRoutes(n,o);for(let r=0;r<s;r++)e[r].look.adjustRoutes()},movePadsAndRoutes(e,t,i=!1){const s=e.length;let n=0,o=0;for(let r=0;r<s;r++)n=i?-t[r].x:t[r].x,o=i?-t[r].y:t[r].y,e[r].rect.x+=n,e[r].rect.y+=o,e[r].adjustRoutes()}};function Ii(e){const[t,i]=e.selectedNodeAndPosition();return!t||!i?[!1,null,null]:t.cannotBeModified()?[!1,null,null]:[!0,t,i]}const Fu={i:e=>{const[t,i,s]=Ii(e);if(!t)return;const n={channel:!1,input:!0,proxy:i.is.group};f.doEdit("newPin",{view:e,node:i,pos:s,is:n})},o:e=>{const[t,i,s]=Ii(e);if(!t)return;const n={channel:!1,input:!1,proxy:i.is.group};f.doEdit("newPin",{view:e,node:i,pos:s,is:n})},q:e=>{const[t,i,s]=Ii(e);if(!t)return;const n={channel:!0,input:!1,proxy:i.is.group};f.doEdit("newPin",{view:e,node:i,pos:s,is:n})},r:e=>{const[t,i,s]=Ii(e);if(!t)return;const n={channel:!0,input:!0,proxy:i.is.group};f.doEdit("newPin",{view:e,node:i,pos:s,is:n})},p:e=>{const[t,i,s]=Ii(e);t&&f.doEdit("newInterfaceName",{view:e,node:i,pos:s})},a:e=>{const t=e.selection.getSingleNode();if(!t)return;const i=t.look.findLabel();i?f.doEdit("widgetTextEdit",{view:e,widget:i}):f.doEdit("addLabel",{node:t})},h:e=>{const t=e.selection.getSingleNode();t&&f.doEdit("nodeHighLight",{node:t})},"+":e=>{const t=e.selection.getSelectedWidget();!t||!t.node||t.node.cannotBeModified()||f.doEdit("widgetTextEdit",{view:e,widget:t,cursor:-1})},"-":e=>{const t=e.selection.getSelectedWidget();!t||!t.node||t.node.cannotBeModified()||f.doEdit("widgetTextEdit",{view:e,widget:t,cursor:0,clear:!0})},Clear:e=>{const t=e.selection.what==$.singleNode?e.selection.getSingleNode():null;t?f.doEdit("disconnectNode",{node:t}):f.doEdit("disconnectSelection",{view:e})},Delete:e=>{switch(e.selection.what){case $.nothing:break;case $.freeRect:f.doEdit("deleteSelection",{view:e});break;case $.pinArea:const[t,i,s]=Ii(e);if(!t)return;f.doEdit("deletePinArea",{view:e,node:e.selection.getSingleNode(),widgets:e.selection.widgets});break;case $.singleNode:const n=e.selection.getSelectedWidget();if(!n){const o=e.selection.getSingleNode();o&&f.doEdit("deleteNode",{node:o});return}if(n.node.cannotBeModified())return;n.is.pin?f.doEdit("deletePin",{view:e,pin:n}):n.is.ifName&&f.doEdit("deleteInterfaceName",{view:e,ifName:n});break;case $.multiNode:f.doEdit("deleteSelection",{view:e});break}},Enter:e=>{const t=e.selection.getSelectedWidget();if(t){if(t.node.cannotBeModified())return;f.doEdit("widgetTextEdit",{view:e,widget:t})}},ArrowDown:e=>{const t=e.selection.widgetBelow();t&&e.selection.switchWidget(t)},ArrowUp:e=>{const t=e.selection.widgetAbove();t&&e.selection.switchWidget(t)},Undo:e=>f.undoLastEdit(),Redo:e=>f.redoLastEdit(),Escape:e=>{e.selection.reset()}},Wu={s:e=>{f.doEdit("newSourceNode",{view:e,pos:e.hit.xyLocal})},g:e=>{f.doEdit("newGroupNode",{view:e,pos:e.hit.xyLocal})},b:e=>{f.doEdit("busCreate",{view:e,pos:e.hit.xyLocal,cable:!1})},k:e=>{f.doEdit("busCreate",{view:e,pos:e.hit.xyLocal,cable:!0})},c:e=>{f.doEdit("selectionToClipboard",{view:e})},i:e=>{f.doEdit("padCreate",{view:e,pos:e.hit.xyLocal,input:!0})},o:e=>{f.doEdit("padCreate",{view:e,pos:e.hit.xyLocal,input:!1})},l:e=>{f.tx.request("clipboard get",f.doc).then(t=>{const i=t.selection.what;i!=$.nothing&&i!=$.pinArea&&f.doEdit("linkFromClipboard",{view:e,pos:e.hit.xyLocal,clipboard:t})}).catch(t=>console.log("ctrl-l : clipboard get error -> "+t))},v:e=>{f.tx.request("clipboard get",f.doc).then(t=>{const i=t.selection.what;if(i!=$.nothing){if(i==$.pinArea){f.doEdit("pasteWidgetsFromClipboard",{view:e,clipboard:t});return}f.doEdit("pasteFromClipboard",{view:e,pos:e.hit.xyLocal,clipboard:t})}}).catch(t=>console.log("ctrl-v : clipboard get error -> "+t))},z:e=>f.undoLastEdit(),Z:e=>f.redoLastEdit(),"+":e=>{const t=e.selection.getSingleNode();t&&f.doEdit("wider",{node:t})},"-":e=>{const t=e.selection.getSingleNode();t&&f.doEdit("smaller",{node:t})}},Hu={_logKey(e){let t="Key = ";e.ctrlKey&&(t+="ctrl "),e.shiftKey&&(t+="shift "),t+="<"+e.key+">",console.log(t)},onKeydown(e){var t,i,s,n;if(this.state.action==S.nothing){const o=e.ctrlKey?Wu[e.key]:Fu[e.key];return o?(o(this),!0):!1}else return this.state.action==S.editTextField?((e.key.length>1||e.ctrlKey?(i=(t=this.textField).handleSpecialKey)==null?void 0:i.call(t,e):(n=(s=this.textField).handleKey)==null?void 0:n.call(s,e))&&this.stateSwitch(S.nothing),!0):!1},onKeyup(e){return!1},beginTextEdit(e,t=-1,i=!1){var n;const s=(n=e.startEdit)==null?void 0:n.call(e);s&&(this.textField.newEdit(e,s,t),i&&this.textField.clear(),this.stateSwitch(S.editTextField),f.switchView(this),this.startBlinking())},endTextEdit(){var i,s;const e=this.state,t=this.textField;clearInterval(e.cursorInterval),t&&((s=(i=t.obj).endEdit)==null||s.call(i,t.saved))},startBlinking(){let e=0,t=!0,i=!0;const s=n=>{n-e>=g.std.blinkRate&&(i=f.doc.view.recursiveBlink(f.ctx,t),t=!t,e=n),i&&requestAnimationFrame(s)};requestAnimationFrame(s)},recursiveBlink(e,t){e.save();const i=this.tf;e.transform(i.sx,0,0,i.sy,i.dx,i.dy);let s=!1;if(this.state.action==S.editTextField){s=!0;const n=this.textField;n.obj.drawCursor(e,n.cursor,t)}for(const n of this.views)s=n.recursiveBlink(e,t)||s;return e.restore(),s}},Bu={localCoord(e){const t=this.tf;return{x:(e.x-t.dx)/t.sx,y:(e.y-t.dy)/t.sy}},inverse(e){const t=this.tf;return{x:e.x*t.sx+t.dx,y:e.y*t.sy+t.dy}},newSubView(e,t=null,i=null){t=t??this.makeViewRect(e);let s=new Ts(t,e,this);return i&&s.setTransform(i),s.addViewWidgets(),s.placeWidgets(),this.views.push(s),e.savedView=s,s},restoreView(e){if(e.savedView.raw&&(e.savedView=this.newSubView(e,e.savedView.rect,e.savedView.tf)),this.views.find(t=>t==e.savedView)){console.error("View already in views in restore view !");return}if(this==e.savedView){console.error("Circular reference in views");return}e.savedView.viewState.visible=!0,this.views.push(e.savedView),e.savedView.parent=this},closeView(){this.parent&&(this.viewState.visible=!1,this.parent.views&&Ne(this.parent.views,this))},restoreSubViews(){var e;if(this.views.length=0,!!((e=this.root)!=null&&e.nodes))for(let t of this.root.nodes)!t.savedView||t.savedView.state=="closed"||(t.savedView=this.newSubView(t,t.savedView.rect,t.savedView.tf),t.savedView.restoreSubViews())},move(e){var t;this.tf.dx+=e.x,this.tf.dy+=e.y,this.rect.x+=e.x,this.rect.y+=e.y,(t=this.widgets)==null||t.forEach(i=>{i.rect.x+=e.x,i.rect.y+=e.y})},resize(e,t){const i=this.rect;switch(e.name){case"corner":i.h+t.y>g.view.hHeader&&(i.h+=t.y),i.w+t.x>g.look.wBox&&(i.w+=t.x);break;case"top":if(i.h-t.y<g.view.hHeader)return;i.y+=t.y,i.h-=t.y;break;case"bottom":if(i.h+t.y<g.view.hHeader)return;i.h+=t.y;break;case"right":if(i.w+t.x<g.look.wBox)return;i.w+=t.x;break;case"left":if(i.w-t.x<g.look.wBox)return;i.x+=t.x,i.w-=t.x;break}this.placeWidgets()},whichView(e){const t=g.view.hHeader,i=g.view.wLine;for(let s=this.views.length-1;s>=0;s--){const n=this.views[s],o=n.rect;if(e.x>=o.x+i&&e.x<=o.x+o.w-i&&e.y>=o.y+t&&e.y<=o.y+o.h-i)return e=n.localCoord(e),n.whichView(e);const r=4;if(e.x<o.x-r||e.x>o.x+o.w+r||e.y<o.y-r||e.y>o.y+o.h+r)continue;let a=null;for(const l of n.widgets)rt(e,l.rect)&&!l.is.viewBox&&(a=l);if(a)return[n,a,e];if(e.x<o.x+i)return[n,{is:{border:!0},name:"left"},e];if(e.x>o.x+o.w-i)return e.y>o.y+o.h-20?[n,{is:{border:!0},name:"corner"},e]:[n,{is:{border:!0},name:"right"},e];if(e.y<o.y+i)return[n,{is:{border:!0},name:"top"},e];if(e.y>o.y+o.h-i)return e.x>o.x+o.w-20?[n,{is:{border:!0},name:"corner"},e]:[n,{is:{border:!0},name:"bottom"},e]}return[this,null,e]},iconClick(e,t){switch(e.type){case"close":this.viewState.visible=!1,this.viewState.big&&this.small(),t.switchView(this.parent),this.closeView();break;case"big":{const i=this.parentViewsReverse();for(const s of i)s.big();this.big()}break;case"small":{this.small();for(const i of this.views)i.viewState.big&&i.small()}break;case"calibrate":this.toggleTransform();break;case"grid":this.state.grid=!this.state.grid;break}},viewToFront(e){const t=this.views,i=t.length;let s=t.indexOf(e),n=t[s];for(let o=s;o<i-1;o++)t[o]=t[o+1];t[i-1]=n},cloneForTab(){let e=new Ts({x:0,y:0,w:0,h:0},this.root,this.parent);return e.tf.dx=this.tf.dx,e.tf.dy=this.tf.dy,e.tf.sx=this.tf.sx,e.tf.sy=this.tf.sy,e.views=this.views,e},addViewWidgets(){const e=this.rect,t=g.view;this.widgets.push(new aa(this.rect)),this.root&&this.widgets.push(new ra({x:0,y:0,w:e.w,h:g.view.hHeader},this.root));for(const i of["close","big","calibrate","grid"]){const s=new wn({x:0,y:0,w:t.wIcon,h:t.hIcon},i);s.setRender(),s.is.highLighted=!1,this.widgets.push(s)}},placeWidgets(){const e=this.rect,t=g.view;let i=e.x+t.xPadding;for(const s of this.widgets)s.is.icon?(s.rect.y=e.y+(g.view.hHeader-t.hIcon)/2,s.rect.x=i,i+=t.wIcon+t.xSpacing):s.is.viewBox?(s.rect.x=e.x,s.rect.y=e.y,s.rect.w=e.w,s.rect.h=e.h):s.is.viewTitle&&(s.rect.x=e.x,s.rect.y=e.y,s.rect.w=e.w)},toggleTransform(){const e=this.tf,t=this.viewState.tf;e.sx!=1?(this.saveTransform(this.tf),this.setTransform({sx:1,sy:1,dx:e.dx,dy:e.dy}),this.redoBigRecursive()):t.sx!=1&&(this.setTransform(t),this.redoBigRecursive())},parentViewsReverse(){const e=[];let t=this;for(;t.parent;)e.push(t.parent),t=t.parent;return e.reverse()},toggleBig(){if(this.viewState.big){this.small();for(const e of this.views)e.viewState.big&&e.toggleBig()}else{const e=this.parentViewsReverse();for(const t of e)t.big();this.big()}},small(){var e;Object.assign(this.rect,this.viewState.rect),(e=this.widgets.find(t=>t.type=="small"))==null||e.switchType("big"),this.placeWidgets(),this.viewState.big=!1},big(e=!0){var o;if(!this.parent)return;const t=this.parent.rect,i=this.parent.tf,s=g.view;e&&Object.assign(this.viewState.rect,this.rect);const n=this.parent.parent?s.hHeader:0;this.rect.x=(t.x-i.dx)/i.sx,this.rect.y=(t.y+n-i.dy)/i.sy,this.rect.w=t.w/i.sx,this.rect.h=(t.h-n)/i.sy,(o=this.widgets.find(r=>r.type=="big"))==null||o.switchType("small"),this.placeWidgets(),this.viewState.big=!0},redoBigRecursive(){this.viewState.big&&this.big(!1);for(const e of this.views)e.redoBigRecursive()}},Vo="drawer/file",$u={async onDrop(e,t){t.preventDefault();let i=this.localCoord(e);if(this.mouseHit(i),this.hit.view)return this.hit.view.onDrop(i,t);const s=this.analyseDrop(t);if(!s)return;const n=new Qt(s.path),o=new Mt(n),a=await new Si(f.doc.UID).getRoot(o);if(!a)return null;if(a.is.group&&a.isContainer()){const l=this.makeViewRect(a);l.x=i.x,l.y=i.y,this.newSubView(a,l)}return a.look.moveTo(i.x,i.y),a.uidChangeAll(f.doc.UID),a.link=new Xs(o,this.name),this.root.nodes.push(a),f.redraw(),a},analyseDrop(e){e.dataTransfer.items&&[...e.dataTransfer.items];const t=e.dataTransfer.files?[...e.dataTransfer.files]:null,i=e.dataTransfer.types?[...e.dataTransfer.types]:null;return(t==null?void 0:t.length)>0&&t.forEach((s,n)=>{}),(i==null?void 0:i.length)>0&&i.includes(Vo)?JSON.parse(e.dataTransfer.getData(Vo)):null}},S={nothing:0,nodeDrag:1,routeDrag:2,panning:3,routeDraw:4,editTextField:5,selection:6,selectionDrag:7,pinAreaSelect:8,pinAreaDrag:9,padDrag:10,padArrowClicked:11,busDraw:12,busRedraw:13,busSegmentDrag:14,busDrag:15,tackDrag:16,pinClicked:17,pinDrag:18,interfaceDrag:19,interfaceNameDrag:20,interfaceNameClicked:21};function Ts(e,t=null,i=null){this.tf={sx:1,sy:1,dx:e.x,dy:e.y+g.view.hHeader},this.rect=e,this.widgets=[],this.root=t,this.parent=i,this.views=[],this.hitTimer=0,this.state={action:0,pad:null,node:null,route:null,routeSegment:0,cursorInterval:null,bus:null,busSegment:0,busLabel:null,tack:null,lookWidget:null,hoverOver:null,highLighted:!1,grid:!1},this.textField=new Zr,this.hit={what:0,selection:null,xyLocal:{x:0,y:0},xyScreen:{x:0,y:0},pad:null,padArrow:!1,node:null,lookWidget:null,route:null,routeSegment:0,bus:null,busSegment:0,busLabel:null,tack:null},this.selection=new _s(this),this.viewState={visible:!0,big:!1,tf:{sx:1,sy:1,dx:e.x,dy:e.y},rect:{...e}}}Ts.prototype={toJSON(){},stateSwitch(e){this.state.action==S.editTextField&&this.endTextEdit(),this.state.action=e},reset(){const e=this.state;e.action=S.nothing,e.node=null,e.view=null,e.route=null,this.selection.reset(),this.views.forEach(t=>t.reset())},makeViewRect(e){let t={x:0,y:0,w:0,h:0};const i=.1;return(e.nodes.length>0||e.pads.length>0)&&(t=this.calcRect(e),t.w=t.w+Math.floor(i*t.w),t.h=t.h+Math.floor(i*t.h)),t.w<g.view.wDefault&&(t.w=g.view.wDefault),t.h<g.view.hDefault&&(t.h=g.view.hDefault),t.x=e.look.rect.x,t.y=e.look.rect.y+g.view.hHeader+g.header.hHeader,t},noRect(){return this.rect.w==0||this.rect.h==0},setRect(e,t,i,s){this.rect.x=e,this.rect.y=t,this.rect.w=i,this.rect.h=s},shiftContent(e,t){this.root.nodes.forEach(i=>{i.look.moveDelta(e,t),i.look.moveRoutes(e,t)}),this.root.buses.forEach(i=>i.move(e,t))},translate(e,t){this.tf.dx+=e,this.tf.dy+=t},resetTransform(){this.tf.dx=this.rect.x,this.tf.dy=this.rect.y,this.tf.sx=1,this.tf.sy=1},setTransform(e){this.tf.dx=e.dx,this.tf.dy=e.dy,this.tf.sx=e.sx,this.tf.sy=e.sy},saveTransform(e){Object.assign(this.viewState.tf,e)},middle(){const e=this.tf,t=this.rect;return{x:(t.x+t.w/2-e.dx)/e.sx,y:(t.y+t.h/2-e.dy)/e.sy}},initRoot(e){const t=new yt({x:this.rect.x+this.rect.w/2,y:this.rect.y,w:0,h:0});return this.root=new Dt(t,e),this.root},render(e){var o,r,a,l;const t=g.switch((l=(a=(r=(o=this.root)==null?void 0:o.link)==null?void 0:r.model)==null?void 0:a.header)==null?void 0:l.style);e.save();const i=this.rect,s=g.view;if(this.parent){for(const c of this.widgets)c.render(e);e.rect(i.x+s.wLine/2,i.y+s.hHeader,i.w-s.wLine,i.h-s.hHeader),e.clip()}const n=this.tf;e.transform(n.sx,0,0,n.sy,n.dx,n.dy),this.state.grid&&this.drawGrid(e),this.root&&this.renderContent(e);for(const c of this.views)c.render(e);e.restore(),g.switch(t)},renderContent(e){var i;const t=this.root;this.selection.render(e);for(const s of t.nodes)for(const n of s.look.widgets)if(n.routes)for(const o of n.routes)o.from==n&&o.render(e);for(const s of t.pads)for(const n of s.routes)n.from==s&&n.render(e);for(const s of t.buses)for(const n of s.tacks)((i=n.route)==null?void 0:i.from)==n&&n.route.render(e);for(const s of t.nodes)s.render(e);for(const s of t.pads)s.render(e);for(const s of t.buses)s.render(e)},highLight(){this.state.highLighted=!0;for(const e of this.widgets)(e.is.viewTitle||e.is.viewBox||e.is.icon)&&(e.is.highLighted=!0)},unHighLight(){this.state.highLighted=!1;for(const e of this.widgets)(e.is.viewTitle||e.is.viewBox||e.is.icon)&&(e.is.highLighted=!1)},topView(){let e=this;for(;e.parent;)e=parent;return e},drawGrid(e){const t=this.rect,i=this.tf,s=g.view.grid,n={x:(t.x-i.dx)/i.sx,y:(t.y-i.dy)/i.sy,w:t.w/i.sx,h:t.h/i.sy};H.grid(e,n.x,n.y,n.w,n.h,s.dx,s.dy,s.cLine,s.cAxis)},getNamePath(){if(!this.parent)return"";let e=this,t="";for(;e.parent;)t+=" @ "+e.root.name,e=e.parent;return t}};Object.assign(Ts.prototype,Id,Hd,Wd,Bd,Au,Mu,Du,Ou,Iu,Hu,Bu,$u);const ju={newGroupNode:{doit({view:e,pos:t}){const i=e.newEmptyNode(t,!1);f.saveEdit("newGroupNode",{view:e,node:i})},undo({view:e,node:t}){e.root.removeNode(t)},redo({view:e,node:t}){e.root.addNode(t)}},newSourceNode:{doit({view:e,pos:t}){const i=e.newEmptyNode(t,!0);f.saveEdit("newSourceNode",{view:e,node:i})},undo({view:e,node:t}){e.root.removeNode(t)},redo({view:e,node:t}){e.root.addNode(t)}},wider:{doit({node:e}){e.look.wider(),f.saveEdit("wider",{node:e})},undo({node:e}){e.look.smaller()},redo({node:e}){e.look.wider()}},smaller:{doit({node:e}){e.look.smaller(),f.saveEdit("smaller",{node:e})},undo({node:e}){e.look.wider()},redo({node:e}){e.look.smaller()}},nodeHighLight:{doit({node:e}){e.is.highLighted?e.unHighLight():e.highLight()},undo({node:e}){},redo({node:e}){}},convertNode:{doit({node:e}){var s;const t=f.doc.focus;if(e.link)return;const i=e.switchNodeType();t.root.swap(e,i),(s=t.root)==null||s.rxtxBuildTxTable(),f.saveEdit("convertNode",{view:t,node:e,convertedNode:i})},undo({view:e,node:t,convertedNode:i}){var s;e.root.swap(i,t)&&i.look.transferRoutes(t.look),(s=e.root)==null||s.rxtxBuildTxTable()},redo({view:e,node:t,convertedNode:i}){var s;e.root.swap(t,i)&&t.look.transferRoutes(i.look),(s=e.root)==null||s.rxtxBuildTxTable()}},nodeToClipboard:{doit({view:e,node:t}){e.selection.singleNode(t),f.tx.send("clipboard set",{model:f.doc.model,selection:e.selection})},undo(){},redo(){}},sourceToClipboard:{doit({node:e}){if(!e.is.source)return;const t=e.makeSourceBody();f.textToExternalClipboard(t)},undo(){},redo(){}},swapPins:{doit({node:e,left:t,right:i}){const s=[];for(let n of e.look.widgets)n.is.pin&&t&&!n.is.left&&s.push(n),n.is.pin&&i&&n.is.left&&s.push(n);for(const n of s)n.leftRightSwap();f.saveEdit("swapPins",{swapped:s})},undo({swapped:e}){for(const t of e)t.leftRightSwap()},redo({swapped:e}){for(const t of e)t.leftRightSwap()}},disconnectNode:{doit({node:e}){const t=e.getRoutes();e.disconnect(),f.saveEdit("disconnectNode",{node:e,allRoutes:t})},undo({node:e,allRoutes:t}){for(const i of t)i.reconnect()},redo({node:e,allRoutes:t}){e.disconnect()}},deleteNode:{doit({node:e}){const t=e.getRoutes();e.disconnect(),f.doc.focus.root.removeNode(e),e.saveView&&e.savedView.closeView(),f.saveEdit("deleteNode",{view:f.doc.focus,node:e,allRoutes:t})},undo({view:e,node:t,allRoutes:i}){e.root.addNode(t);for(const s of i)s.reconnect()},redo({view:e,node:t,allRoutes:i}){t.disconnect(),e.root.removeNode(t)}},nodeFromNodeLib:{doit({view:e,node:t}){e.root.addNode(t),e.state.node=t,e.selection.singleNode(t),f.saveEdit("nodeFromNodeLib",{view:e,node:t})},undo({view:e,node:t}){e.root.removeNode(t)},redo({view:e,node:t}){e.root.addNode(t)}},nodeDrag:{doit({view:e,node:t}){f.saveEdit("nodeDrag",{node:t,view:e,oldPos:{x:t.look.rect.x,y:t.look.rect.y},newPos:null})},undo({node:e,view:t,oldPos:i,newPos:s}){const n={x:i.x-s.x,y:i.y-s.y};e.move(n),t.selection.move(n)},redo({node:e,view:t,oldPos:i,newPos:s}){const n={x:s.x-i.x,y:s.y-i.y};e.move(n),t.selection.move(n)}},updateProfiles:{doit({node:e}){e.is.group||e.factory.arl&&e.factory.arl.jsImport().then(t=>{e.analyzeFactory(t)})},undo({}){},redo({}){}},changeNodeSettings:{doit({node:e,sx:t}){JSON.stringify(t)!==JSON.stringify(e.sx)&&(e.sx=t),f.signalEdit("changeNodeSettings")},undo({}){},redo({}){}},changeNodeDynamics:{doit({node:e,dx:t}){e.dx,JSON.stringify(t)!==JSON.stringify(e.dx)&&(e.dx=t),f.signalEdit("changeNodeDynamics")},undo({}){},redo({}){}},changeNodeComment:{doit({node:e,comment:t}){!t||t.length==0?e.prompt=null:t!==e.prompt&&(e.prompt=t),f.signalEdit("changeNodeComment")},undo({}){},redo({}){}}},Vu={cutLink:{doit({node:e}){e.link&&(f.saveEdit("cutLink",{node:e,lName:e.link.lName,userPath:e.link.model.arl.userPath}),e.clearLink(),e.adjustUserPaths(f.doc.model.arl))},undo({node:e,lName:t,userPath:i}){t.length?i.length?f.doc.importFromModel(e,t,i):f.doc.makeLocalLink(e,t):e.clearLink()},redo({node:e,lName:t,userPath:i}){e.clearLink()}},changeLink:{async doit({node:e,lName:t,userPath:i}){i=i.trim(),t=k.cleanLink(t);const s=e.copy();f.saveEdit("changeLink",{node:e,previous:s,lName:t,userPath:i}),t.length?i.length>0?(await f.doc.importFromModel(e,t,i),f.redraw()):f.doc.makeLocalLink(e,t):e.clearLink()},undo({node:e,previous:t,lName:i,userPath:s}){t.link||(t.is.source?e.look.addIcon("factory"):e.look.addIcon("group")),e.fuse(t)},redo({node:e,previous:t,lName:i,userPath:s}){i.length?s.length?f.doc.importFromModel(e,i,s):f.doc.makeLocalLink(e,i):e.clearLink()}},saveToLink:{doit({node:e,newName:t,userPath:i}){!i.length>0||f.doc.exportToModel(e,t,new Mt(f.doc.model.arl.resolve(i)))},undo({}){},redo({}){}},changeFactory:{doit({node:e,newName:t,userPath:i}){var n;const s=e.factory.clone();(n=e.factory)==null||n.resolve(t,i,f.doc.model.arl,e.name),f.saveEdit("changeFactory",{node:e,oldFactory:s,newFactory:e.factory})},undo({node:e,oldFactory:t,newFactory:i}){e.factory=t},redo({node:e,oldFactory:t,newFactory:i}){e.factory=i}}},Uu={newPin:{doit({view:e,node:t,pos:i,is:s}){const n=t.look.addPin("",i,s);n.is.proxy?t.addPad(n):t.rxtxAddPin(n),e.selection.switchWidget(n),e.beginTextEdit(n),f.saveEdit("newPin",{view:e,pin:n})},undo({view:e,pin:t}){if(!t||!t.node.look.widgets.includes(t))return;const i=t.node;e.selection.switchWidget(),i.look.removePin(t),t.is.proxy?i.pads.pop():i.rxtxPopPin(t)},redo({view:e,pin:t}){if(!t||!t.node.look.widgets.includes(t))return;const i=t.node;i.look.restorePin(t),t.is.proxy?i.addPad(t):i.rxtxAddPin(t),e.selection.switchWidget(t)}},disconnectPin:{doit({pin:e}){const t=e.routes.slice();e.disconnect(),f.saveEdit("disconnectPin",{pin:e,routes:t})},undo({pin:e,routes:t}){e.reconnect(t)},redo({pin:e,routes:t}){e.disconnect()}},deletePin:{doit({view:e,pin:t}){const i=t.routes.slice(),s=t.is.proxy?t.pad.routes.slice():null;f.saveEdit("deletePin",{view:e,pin:t,pinRoutes:i,padRoutes:s}),e.selection.switchWidget(),t.disconnect(),t.node.look.removePin(t),t.is.proxy?(t.pad.disconnect(),t.node.removePad(t.pad)):t.node.rxtxRemovePin(t)},undo({view:e,pin:t,pinRoutes:i,padRoutes:s}){const n=i.slice();t.node.look.restorePin(t),e.selection.switchWidget(t),t.reconnect(n),t.is.proxy&&t.pad.reconnect(s)},redo({view:e,pin:t,pinRoutes:i,padRoutes:s}){t.disconnect(),e.selection.switchWidget(),t.node.look.removePin(t)}},ioSwap:{doit({pin:e}){e.ioSwap()&&f.saveEdit("ioSwap",e)},undo({pin:e}){e.ioSwap()},redo({pin:e}){e.ioSwap()}},channelOnOff:{doit({pin:e}){e.channelOnOff()&&f.saveEdit("channelOnOff",e)},undo({pin:e}){e.channelOnOff()},redo({pin:e}){e.channelOnOff()}},pinDrag:{doit({pin:e}){f.saveEdit("pinDrag",{pin:e,oldPos:{left:e.is.left,y:e.rect.y},newPos:null})},undo({pin:e,oldPos:t,newPos:i}){e.moveTo(t.left,t.y)},redo({pin:e,oldPos:t,newPos:i}){e.moveTo(i.left,i.y)}},pinAreaDrag:{doit(e){const t=e.selection.widgets;f.saveEdit("pinAreaDrag",{widgets:t,oldY:t[0].rect.y,newY:t[0].rect.y})},undo({widgets:e,oldY:t,newY:i}){},redo({widgets:e,oldY:t,newY:i}){}},showProfile:{doit({pin:e,pos:t}){var s;if(!((s=f.doc)!=null&&s.model))return;const i=e.is.input?f.doc.model.getInputPinProfile(e):f.doc.model.getOutputPinProfile(e);if(!i){console.log(`NO PROFILE ${e.name}`);return}f.tx.send("pin profile",{pos:t,pin:e,profile:i,open(n){const o=f.doc.model.arl.resolve(n.file);f.tx.send("open source file",{arl:o,line:n.line})}})},undo(){},redo(){}},newInterfaceName:{doit({view:e,node:t,pos:i}){let s=t.look.addIfName("",i);e.beginTextEdit(s),e.selection.switchWidget(s),f.saveEdit("newInterfaceName",{ifName:s})},undo({ifName:e}){e.node.look.removeInterfaceName(e)},redo({ifName:e}){e.node.look.restoreInterfaceName(e)}},deleteInterfaceName:{doit({view:e,ifName:t}){e.selection.switchWidget();const i=t.node.look.showPrefixes(t);t.node.look.removeInterfaceName(t),f.saveEdit("deleteInterfaceName",{view:e,ifName:t,pxlenArray:i})},undo({view:e,ifName:t,pxlenArray:i}){t.node.look.restoreInterfaceName(t),t.node.look.hidePrefixes(t,i),e.selection.switchWidget(t)},redo({view:e,ifName:t,pxlenArray:i}){e.selection.switchWidget(),t.node.look.showPrefixes(t),t.node.look.removeInterfaceName(t)}},interfaceDrag:{doit({group:e,oldY:t,newY:i}){f.saveEdit("interfaceDrag",{group:e,oldY:t,newY:i})},undo({group:e,oldY:t,newY:i}){const s=t-i;e[0].node.look.groupMove(e,s)},redo({group:e,oldY:t,newY:i}){const s=i-t;e[0].node.look.groupMove(e,s)}},interfaceNameDrag:{doit({ifName:e}){f.saveEdit("interfaceNameDrag",{ifName:e,oldY:e.rect.y,newY:e.rect.y})},undo({ifName:e,oldY:t,newY:i}){e.moveTo(t)},redo({ifName:e,oldY:t,newY:i}){e.moveTo(i)}},addLabel:{doit({node:e}){var i,s;let t=e.look.widgets.find(n=>n.is.label)??e.look.addLabel("");(s=(i=f.doc)==null?void 0:i.focus)==null||s.beginTextEdit(t),f.saveEdit("addLabel",{node:e,label:t})},undo({node:e,label:t}){e.look.removeLabel()},redo({node:e,label:t}){e.look.restoreLabel(t)}},widgetTextEdit:{doit({view:e,widget:t,cursor:i,clear:s}){var o;const n=(o=t.startEdit)==null?void 0:o.call(t);n&&(f.saveEdit("widgetTextEdit",{widget:t,prop:n,oldText:t[n],newText:""}),e.beginTextEdit(t,i,s??!1))},undo({widget:e,prop:t,oldText:i,newText:s}){s=e[t],f.getParam().newText=s,e[t]=i,e.endEdit(s)},redo({widget:e,prop:t,oldText:i,newText:s}){e[t]=s,e.endEdit(i)}}},zu={routeDrag:{doit({route:e}){f.saveEdit("routeDrag",{route:e,oldWire:e.copyWire(),newWire:null})},undo({route:e,oldWire:t,newWire:i}){e.restoreWire(t)},redo({route:e,oldWire:t,newWire:i}){e.restoreWire(i)}},routeDraw:{doit({route:e}){f.saveEdit("routeDraw",{route:e,newRoute:e.clone()}),e.checkTwistedPair()},undo({route:e,newRoute:t}){e.disconnect()},redo({route:e,newRoute:t}){t&&e.connectFromClone(t)}},deleteRoute:{doit({route:e}){f.saveEdit("deleteRoute",{route:e,oldRoute:e.clone()}),e.disconnect(),e.remove()},undo({route:e,oldRoute:t}){t&&e.connectFromClone(t)},redo({route:e,oldRoute:t}){e.disconnect(),e.remove()}}},qu={busHighlight:{doit({bus:e}){e.is.highLighted?e.unHighLight():e.highLight(),f.saveEdit("busHighLight",{bus:e})},undo({bus:e}){e.is.highLighted?e.unHighLight():e.highLight()},redo({bus:e}){e.is.highLighted?e.unHighLight():e.highLight()}},busCreate:{doit({view:e,pos:t,cable:i}){e.state.bus=e.root.addBus("",t),f.saveEdit("busCreate",{node:e.root,bus:e.state.bus}),i&&(e.state.bus.is.cable=!0)},undo({node:e,bus:t}){e.removeBus(t)},redo({node:e,bus:t}){e.restoreBus(t)}},busChangeName:{doit({bus:e,label:t}){f.doc.focus.state.bus=e,e.selected=!0,t||(t=e.startLabel),f.doc.focus.beginTextEdit(t),f.saveEdit("busChangeName",{label:t,oldName:t.text,newName:null})},undo({label:e,oldName:t,newName:i}){f.getParam().newName=e.text,e.setText(t)},redo({label:e,oldName:t,newName:i}){e.setText(i)}},busChangeType:{doit({bus:e}){const t=e.tacks.slice();f.saveEdit("busChangeType",{bus:e,tacks:t}),e.disconnect(),e.is.cable=!e.is.cable,e.reconnect(t)},undo({bus:e,tacks:t}){const i=t.slice();e.disconnect(),e.is.cable=!e.is.cable,e.reconnect(i)},redo({bus:e,tacks:t}){const i=t.slice();e.disconnect(),e.is.cable=!e.is.cable,e.reconnect(i)}},busDeleteRouter:{doit({bus:e}){f.saveEdit("busDeleteRouter",{bus:e}),e.is.filter=!1},undo({bus:e}){e.is.filter=!0},redo({bus:e}){e.is.filter=!1}},busChangeRouter:{doit({bus:e,newName:t,userPath:i}){const s=e.filter?e.filter.clone():null;e.filter||(e.filter=new Ki),e.filter.resolve(t,i,f.doc.model.arl,e.name),e.is.filter=!0,f.saveEdit("busChangeRouter",{bus:e,oldRouter:s,newRouter:e.filter})},undo({bus:e,oldRouter:t,newRouter:i}){e.filter=t},redo({bus:e,oldRouter:t,newRouter:i}){e.filter=i}},busStraightConnections:{doit({bus:e}){const t=[];for(const i of e.tacks)t.push({tack:i,oldPos:{x:i.rect.x,y:i.rect.y},wire:i.route.copyWire()});f.saveEdit("busStraightConnections",{bus:e,wireArray:t}),e.straightConnections()},undo({bus:e,wireArray:t}){for(const i of t){const s=i.tack;s.pos.x=i.oldPos.x,s.pos.y=i.oldPos.y,s.route.restoreWire(i.wire)}},redo({bus:e,wireArray:t}){e.straightConnections()}},busDisconnect:{doit({bus:e}){f.saveEdit("busDisconnect",{bus:e,tacks:e.tacks.slice()}),e.disconnect()},undo({bus:e,tacks:t}){e.reconnect(t.slice())},redo({bus:e,tacks:t}){e.disconnect()}},busDelete:{doit({bus:e}){f.saveEdit("busDelete",{node:f.doc.focus.root,bus:e,tacks:e.tacks.slice()}),f.doc.focus.root.deleteBus(e)},undo({node:e,bus:t,tacks:i}){e.restoreBus(t),t.reconnect(i.slice())},redo({node:e,bus:t,tacks:i}){t.disconnect(),e.removeBus(t)}},busDraw:{doit({bus:e}){f.saveEdit("busDraw",{bus:e,oldWire:e.copyWire(),newWire:null})},undo({bus:e,oldWire:t,newWire:i}){e.restoreWire(t),e.startLabel.place(),e.endLabel.place()},redo({bus:e,oldWire:t,newWire:i}){e.restoreWire(i),e.startLabel.place(),e.endLabel.place()}},busSegmentDrag:{doit({bus:e}){f.saveEdit("busSegmentDrag",{bus:e,oldWire:e.copyWire(),newWire:null,oldTackWires:e.copyTackWires(),newTackWires:null})},undo({bus:e,oldWire:t,newWire:i,oldTackWires:s,newTackWires:n}){e.restoreWire(t),e.restoreTackWires(s),e.startLabel.place(),e.endLabel.place(),e.placeTacks()},redo({bus:e,oldWire:t,newWire:i,oldTackWires:s,newTackWires:n}){e.restoreWire(i),e.restoreTackWires(n),e.startLabel.place(),e.endLabel.place(),e.placeTacks()}},busDrag:{doit({bus:e}){f.saveEdit("busDrag",{bus:e,oldWire:e.copyWire(),newWire:null,oldTackWires:e.copyTackWires(),newTackWires:null})},undo({bus:e,oldWire:t,newWire:i,oldTackWires:s,newTackWires:n}){e.restoreWire(t),e.restoreTackWires(s),e.startLabel.place(),e.endLabel.place(),e.placeTacks()},redo({bus:e,oldWire:t,newWire:i,oldTackWires:s,newTackWires:n}){e.restoreWire(i),e.restoreTackWires(n),e.startLabel.place(),e.endLabel.place(),e.placeTacks()}},tackDrag:{doit({tack:e}){f.saveEdit("tackDrag",{tack:e,oldWire:e.route.copyWire(),newWire:null})},undo({tack:e,oldWire:t,newWire:i}){e.route.restoreWire(t),e.orient()},redo({tack:e,oldWire:t,newWire:i}){e.route.restoreWire(i),e.orient()}}},Ju={padCreate:{doit({view:e,pos:t,input:i}){if(!e.root)return;const s={input:i,left:t.x<e.middle().x};let n=e.root.look.addPin("",t,s);const o=n.makePadRect({x:t.x,y:t.y-style.pad.hPad/2}),r=new Pi(o,n);s.left&&(r.rect.x-=r.rect.w),e.root.pads.push(r),f.doc.UID.generate(r),e.beginTextEdit(r),f.saveEdit("padCreate",{view:e,pad:r})},undo({view:e,pad:t}){e.root.pads.includes(t)&&(t.disconnect(),e.root.removePad(t),t.proxy.disconnect(),e.root.look.removePin(t.proxy))},redo({view:e,pad:t}){e.root.pads.includes(t)&&(e.root.restorePad(t),e.root.look.restorePin(t.proxy))}},changeNamePad:{doit({view:e,pad:t}){t!=null&&t.proxy&&(f.saveEdit("changeNamePad",{pad:t,oldName:t.text,newName:null}),e.beginTextEdit(t))},undo({pad:e,oldName:t,newName:i}){f.getParam().newName=e.text;const s=e.proxy.node;e.text.length==0&&(s.restorePad(e),s.look.restorePin(e.proxy)),e.proxy.name=t,e.nameChange(t)},redo({pad:e,oldName:t,newName:i}){const s=e.proxy.node;if(!i||i.length==0){s.removePad(e),s.look.removePin(e.proxy);return}e.proxy.name=i,e.nameChange(i)}},disconnectPad:{doit({pad:e}){f.saveEdit("disconnectPad",{pad:e,routes:e.routes.slice()}),e.disconnect()},undo({pad:e,routes:t}){e.reconnect(t.slice())},redo({pad:e,routes:t}){e.disconnect()}},deletePad:{doit({pad:e}){f.saveEdit("deletePad",{pad:e,routes:e.routes.slice()});const t=f.doc.focus.root;e.disconnect(),t.removePad(e),e.proxy.disconnect(),t.look.removePin(e.proxy)},undo({pad:e,routes:t}){const i=e.proxy.node;i.restorePad(e),i.look.restorePin(e.proxy),e.reconnect(t.slice())},redo({pad:e,routes:t}){e.disconnect(),e.proxy.node.removePad(e),e.proxy.disconnect(),e.proxy.node.look.removePin(e.proxy)}},extrudePad:{doit({view:e,pos:t}){const i=e.hit.lookWidget;if(!i.is.pin)return;const s={...i.is};s.proxy=!0;const n=e.root.look.addPin(i.name,t,s),o=i.makePadRect(t),r=new Pi(o,n);f.doc.UID.generate(r),r.place(),r.shortConnection(i),f.saveEdit("extrudePad",{pad:r,routes:r.routes.slice()}),e.root.pads.push(r),e.state.pad=r},undo({pad:e,routes:t}){e.disconnect(),e.proxy.node.removePad(e)},redo({pad:e,routes:t}){const i=e.proxy.node;i.restorePad(e),i.look.restorePin(e.proxy),e.reconnect(t.slice())}},padDrag:{doit({pad:e}){f.saveEdit("padDrag",{pad:e,oldPos:{x:e.rect.x,y:e.rect.y},oldWires:e.copyWires(),newPos:null,newWires:null})},undo({pad:e,oldPos:t,oldWires:i,newPos:s,newWires:n}){const o={x:t.x-s.x,y:t.y-s.y};e.move(o),e.restoreWires(i)},redo({pad:e,oldPos:t,oldWires:i,newPos:s,newWires:n}){const o={x:s.x-t.x,y:s.y-t.y};e.move(o),e.restoreWires(n)}}},Gu={alignVertical:{doit({view:e,left:t}){const i=e.selection.nodes,s=e.selection.pads;let n=[],o=[];i.length>1&&(n=e.nodesAlignHD(i,t),e.moveNodesAndRoutes(i,n)),s.length>1&&(o=e.padsAlignHD(s,t),e.movePadsAndRoutes(s,o)),f.saveEdit("alignVertical",{view:e,nodes:i,deltaNodes:n,pads:s,deltaPads:o})},undo({view:e,nodes:t,deltaNodes:i,pads:s,deltaPads:n}){i.length>0&&e.moveNodesAndRoutes(t,i,!0),n.length>0&&e.movePadsAndRoutes(s,n,!0)},redo({view:e,nodes:t,deltaNodes:i,pads:s,deltaPads:n}){i.length>0&&e.moveNodesAndRoutes(t,i,!1),n.length>0&&e.movePadsAndRoutes(s,n,!1)}},spaceVertical:{doit({view:e}){const t=e.selection.nodes,i=e.selection.pads;let s=[],n=[];t.length>1&&(s=e.nodesSpaceVD(t),e.moveNodesAndRoutes(t,s)),i.length>1&&(n=e.padsSpaceVD(i),e.movePadsAndRoutes(i,n)),f.saveEdit("spaceVertical",{view:e,nodes:t,deltaNodes:s,pads:i,deltaPads:n})},undo({view:e,nodes:t,deltaNodes:i,pads:s,deltaPads:n}){i.length>0&&e.moveNodesAndRoutes(t,i,!0),n.length>0&&e.movePadsAndRoutes(s,n,!0)},redo({view:e,nodes:t,deltaNodes:i,pads:s,deltaPads:n}){i.length>0&&e.moveNodesAndRoutes(t,i,!1),n.length>0&&e.movePadsAndRoutes(s,n,!1)}},alignHorizontal:{doit({view:e,top:t}){const i=e.selection.nodes;if(i.length<2)return;const s=e.nodesAlignVD(i);e.moveNodesAndRoutes(i,s),f.saveEdit("alignHorizontal",{view:e,nodes:i,deltaNodes:s})},undo({view:e,nodes:t,deltaNodes:i}){i.length>0&&e.moveNodesAndRoutes(t,i,!0)},redo({view:e,nodes:t,deltaNodes:i}){i.length>0&&e.moveNodesAndRoutes(t,i,!1)}},spaceHorizontal:{doit({view:e}){const t=e.selection.nodes;if(t.length<2)return;const i=e.nodesSpaceHD(t,left);e.moveNodesAndRoutes(t,i),f.saveEdit("spaceHorizontal",{view:e,nodes:t,deltaNodes:i})},undo({view:e,nodes:t,deltaNodes:i}){i.length>0&&e.moveNodesAndRoutes(t,i,!0)},redo({view:e,nodes:t,deltaNodes:i}){i.length>0&&e.moveNodesAndRoutes(t,i,!1)}},selectionDrag:{doit({view:e}){const t=e.selection.shallowCopy(),i={x:t.rect.x,y:t.rect.y};f.saveEdit("selectionDrag",{view:e,selection:t,oldPos:i,newPos:null})},undo({view:e,selection:t,oldPos:i,newPos:s}){t.drag({x:i.x-s.x,y:i.y-s.y}),e.selection.setRect(i.x,i.y,t.rect.w,t.rect.h)},redo({view:e,selection:t,oldPos:i,newPos:s}){t.drag({x:s.x-i.x,y:s.y-i.y}),e.selection.setRect(s.x,s.y,t.rect.w,t.rect.h)}},disconnectSelection:{doit({selection:e}){const t=[];for(const i of e.nodes)t.push(i.getRoutes()),i.disconnect();f.saveEdit("disconnectSelection",{selection:e.shallowCopy(),allRoutes:t})},undo({selection:e,allRoutes:t}){for(const i of t)for(const s of i)s.reconnect()},redo({selection:e,allRoutes:t}){for(const i of e.nodes)i.disconnect()}},deleteSelection:{doit({view:e}){const t=[],i=e.selection;for(const s of i.nodes)t.push(s.getRoutes()),s.disconnect(),e.root.removeNode(s);for(const s of i.pads)s.disconnect(),e.root.removePad(s),s.proxy.disconnect(),e.root.look.removePin(s.proxy);for(const s of i.buses)s.tacks.length==0&&e.root.removeBus(s);f.saveEdit("deleteSelection",{view:e,selection:i.shallowCopy(),allRoutes:t}),i.reset(),e.stateSwitch(S.nothing)},undo({view:e,selection:t,allRoutes:i}){for(const s of t.nodes)e.root.addNode(s);for(const s of t.pads){const n=s.proxy.node;n.restorePad(s),n.look.restorePin(s.proxy)}for(const s of t.buses)s.tacks.length==0&&e.root.restoreBus(s);for(const s of i)for(const n of s)n.reconnect()},redo({view:e,selection:t,allRoutes:i}){for(const s of t.nodes)s.disconnect(),e.root.removeNode(s);for(const s of t.pads)s.disconnect(),e.root.removePad(s),s.proxy.disconnect(),e.root.look.removePin(s.proxy);for(const s of t.buses)s.tacks.length==0&&e.root.removeBus(s)}},selectionToClipboard:{doit({view:e}){e.selectionToClipboard()},undo(){},redo(){}},pasteFromClipboard:{doit({view:e,pos:t,clipboard:i}){e.clipboardToSelection(t,i),f.doc.model.arl.sameDir(i.origin.arl)||i.selection.adjustPaths(f.doc.model.arl),e.checkPastedNames(i.copyCount),f.saveEdit("pasteFromClipboard",{view:e,selection:e.selection.shallowCopy()})},undo({view:e,selection:t}){e.removeSelection(t)},redo({view:e,selection:t}){e.restoreSelection(t)}},linkFromClipboard:{doit({view:e,pos:t,clipboard:i}){i.origin.arl.makeRelative(f.doc.model.arl),e.clipboardToSelection(t,i),e.linkToClipboardNodes(i.origin,i.selection.viewPath),e.checkPastedNames(i.copyCount),f.saveEdit("linkFromClipboard",{view:e,selection:e.selection.shallowCopy()})},undo({view:e,selection:t}){e.removeSelection(t)},redo({view:e,selection:t}){e.restoreSelection(t)}},selectionToGroup:{doit({view:e}){const t=e.selection;if(t.nodes.length==0)return;const i=[];for(const o of t.nodes)i.push(o.getRoutes());const s=e.selectionToGroup(f.doc.UID),n={dx:s.savedView.rect.x,dy:s.savedView.rect.y};f.saveEdit("selectionToGroup",{view:e,selection:t.shallowCopy(),newGroup:s,shift:n,allRoutes:i}),t.reset(),e.stateSwitch(S.nothing)},undo({view:e,selection:t,newGroup:i,shift:s,allRoutes:n}){e.undoSelectionToGroup(t,i,s,n)},redo({view:e,selection:t,newGroup:i,allRoutes:s}){}},unGroup:{doit({view:e,node:t}){if(!t.is.group||t.isConnected())return;const i=[];for(const n of t.pads)for(const o of n.routes)i.push(o);const s={dx:e.rect.x,dy:e.rect.y};f.saveEdit("unGroup",{view:e,node:t,shift:s,padRoutes:i}),e.transferToSelection(t,s)},undo({view:e,node:t,shift:i,padRoutes:s}){e.undoTransferToSelection(t,i,s)},redo({view:e,node:t,shift:i,padRoutes:s}){}}},Yu={disconnectPinArea:{doit({view:e,node:t,widgets:i}){const s=t.getAllRoutes(i);t.disconnectPinArea(i),f.saveEdit("disconnectPinArea",{node:t,widgets:i.slice(),allRoutes:s})},undo({node:e,widgets:t,allRoutes:i}){for(const s of i)s.reconnect()},redo({node:e,widgets:t,allRoutes:i}){e.disconnectPinArea(t)}},deletePinArea:{doit({view:e,node:t,widgets:i}){const s=t.getAllRoutes(i);f.saveEdit("deletePinArea",{view:e,node:t,widgets:i.slice(),allRoutes:s}),t.disconnectPinArea(i),t.look.deletePinArea(i)},undo({view:e,node:t,widgets:i,allRoutes:s}){const n=i[0],o={x:n.rect.x,y:n.rect.y};t.look.copyPinArea(i,o),t.is.source?t.rxtxAddPinArea(i):t.addPads(i);for(const r of s)r.reconnect()},redo({view:e,node:t,widgets:i,allRoutes:s}){t.disconnectPinArea(i),t.look.deletePinArea(i)}},swapPinArea:{doit({view:e,left:t,right:i}){const s=[];for(let n of e.selection.widgets)n.is.pin&&t&&!n.is.left&&s.push(n),n.is.pin&&i&&n.is.left&&s.push(n);for(const n of s)n.leftRightSwap();f.saveEdit("swapPinArea",{swapped:s})},undo({swapped:e}){for(const t of e)t.leftRightSwap()},redo({swapped:e}){for(const t of e)t.leftRightSwap()}},pasteWidgetsFromClipboard:{doit({view:e,clipboard:t}){if(t.selection.what!=$.pinArea)return;const[i,s]=e.selectedNodeAndPosition();i.cannotBeModified()||(e.clipboardToSelection(s,t),f.saveEdit("pasteWidgetsFromClipboard",{view:e,node:i,widgets:e.selection.widgets.slice(),pos:s}))},undo({view:e,node:t,widgets:i,pos:s}){i&&t.look.deletePinArea(i),e.selection.reset()},redo({view:e,node:t,widgets:i,pos:s}){const n=t.look.copyPinArea(i,s);t.is.source?t.rxtxAddPinArea(i):t.addPads(i),e.selection.pinAreaSelect(n),i.splice(0,i.length,...n)}},pinAreaToMulti:{doit({view:e,widgets:t}){f.saveEdit("pinAreaToMulti",{view:e,widgets:t})},undo({view:e,widgets:t}){},redo(){}},multiToPinArea:{doit({view:e,pin:t}){f.saveEdit("multiToPinArea",{view:e,pin:t})},undo({view:e,pin:t}){},redo(){}}},Xu={panning:{doit({view:e}){},undo({}){},redo({}){}},xxpanning:{doit({view:e}){f.saveEdit("panning",{view:e,oldTf:{...e.tf},newTf:{...e.tf}})},undo({view:e,oldTf:t,newTf:i}){i.dx=e.tf.dx,i.dy=e.tf.dy,e.tf.dx=t.dx,e.tf.dy=t.dy},redo({view:e,oldTf:t,newTf:i}){e.tf.dx=i.dx,e.tf.dy=i.dy}},zooming:{doit({view:e}){},undo({}){},redo({}){}}},$s={};Object.assign($s,ju,Vu,Uu,zu,qu,Ju,Gu,Yu,Xu);const Ku={adjustRoutes(){for(const e of this.routes)e.adjust()},routeToPin(e){let t=new xt(e,this);t.fourPointRoute(),this.routes.push(t),e.routes.push(t)},shortConnection(e){let t=new xt(e,this);t.twoPointRoute(),this.routes.push(t),e.routes.push(t)},canConnect(e){return!(e.is.pin&&(this.proxy.is.input!=e.is.input||e.is.channel&&!this.proxy.is.channel||(e.is.multi||this.proxy.is.multi)&&!e.hasMultiOverlap(this.proxy))||this.routes.find(t=>t.from==e||t.to==e))},disconnect(){const e=this.routes.slice();for(const t of e)(t.from==this?t.to:t.from).is.pin?t.rxtxPinPadDisconnect():t.rxtxPadBusDisconnect(),t.remove()},reconnect(e){this.routes=e;for(const t of e){const i=t.from==this?t.to:t.from;i.is.pin?i.routes.push(t):i.bus.push(i)}},checkRoutesDirection(){this.routes.forEach(e=>{e.from==this&&e.reverse()})},drag(e,t){if(this.routes.length>0){const i=this.routes[0].wire,[s,n]=this.routes[0].from==this?[i[0],i[1]]:[i.at(-1),i.at(-2)],o=s.y==n.y?{x:s.x+t.x,y:e.y}:{x:e.x,y:s.y+t.y};for(const a of this.routes)a.drawXY(o);s.y==n.y&&(this.is.leftText=s.x<n.x);const r=this.rect;r.y=s.y-r.h/2,r.x=this.is.leftText?s.x-r.w:s.x}else this.rect.x+=t.x,this.rect.y+=t.y},xdrag(e,t){if(this.routes.length>0){const i=this.routes[0].wire;if(i.length>0){const s=i.at(-1);e=i.at(-2).y==s.y?{x:s.x+t.x,y:e.y}:{x:e.x,y:s.y+t.y}}for(const s of this.routes)s.drawXY(e);this.place()}else this.rect.x+=t.x,this.rect.y+=t.y},endDrag(){this.routes.forEach(e=>e.endpoint(this))},slide(e){this.routes.forEach(t=>{const i=t.wire;i.length==2&&t.fourPointRoute();const[s,n]=this==t.from?[i[0],i[1]]:[i.at(-1),i.at(-2)];s.y+=e.y,n.y+=e.y}),this.rect.y+=e.y},fuseEndSegment(){let e=null,t=0;for(const i of this.routes){if(i.wire.length<4)continue;const s=i.wire,[n,o,r,a]=this==i.from?[s[0],s[1],s[2],!0]:[s.at(-1),s.at(-2),s.at(-3),!1];if(Math.abs(r.y-o.y)<g.route.tooClose){t=r.y-n.y,n.y=r.y,a?i.removeTwoPoints(1,s):i.removeTwoPoints(s.length-3,s),e=i;break}}if(e){for(const i of this.routes){if(i==e)continue;const s=i.wire,[n,o]=this==i.from?[s[0],s[1]]:[s.at(-1),s.at(-2)];n.y+=t,o.y+=t}this.rect.y+=t}},copyPadPinRoutes(e,t){for(const i of e.routes){const s=i.from==e?i.to:i.from;if(!s.is.pin)continue;const n=i.clone();n.to==e?n.to=this:n.from=this,this.routes.push(n);const r=t.nodes.find(a=>a.uid==s.node.uid).look.findPin(s.name,s.is.input);n.from==this?n.to=r:n.from=r,r.routes.push(n)}},removeRoute(e){Ne(this.routes,e)},copyWires(){const e=[];for(const t of this.routes)e.push(t.copyWire());return e},restoreWires(e){const t=this.routes.length;for(let i=0;i<t;i++)this.routes[i].restoreWire(e[i])},highLightRoutes(){for(const e of this.routes){const t=e.from==this?e.to:e.from;if(t){if(t.is.pin){if(!this.areConnected(t))continue;e.highLight()}t.is.tack&&(e.highLight(),t.bus.highLightRoutes(this))}}},unHighLightRoutes(){for(const e of this.routes){e.unHighLight();const t=e.from==this?e.to:e.from;t&&t!=null&&t.is.tack&&t.bus.unHighLightRoutes(this)}},checkRouteUsage(){for(const t of this.routes)t.is.notUsed=!1;const e=this.proxy;for(const t of this.routes){const i=t.from==this?t.to:t.from;if(i.is.pin)(i.is.multi||e.is.multi)&&!e.hasMultiOverlap(i)&&(t.is.notUsed=!0);else if(i.is.tack){let s=!1;for(const n of i.bus.tacks){if(n==i)continue;const o=n.route.to==n?n.route.from:n.route.to;i.bus.areConnected(this,o)&&(n.route.is.notUsed=!1,s=!0)}s||(t.is.notUsed=!0)}}}};function Pi(e,t,i=null){this.uid=i,this.rect={...e},this.is={pad:!0,selected:!1,highLighted:!1,leftText:t.is.left,hoverOk:!1,hoverNok:!1,beingEdited:!1},this.text=t.name,this.proxy=t,this.routes=[]}Pi.prototype={copy(){return new Pi(this.rect,this.proxy,this.uid)},render(e,t){var c;let i=g.pad;const s=this.rect,n=this.proxy,o=this.is.hoverNok?i.cBad:i.cBackground;let r=this.is.highLighted?i.cHighLighted:this.is.selected||this.is.hoverOk?i.cSelected:((c=this.routes)==null?void 0:c.length)>0?i.cConnected:i.cText;const a=r;let l=s.y+(i.hPad-i.wArrow)/2;if(this.is.beingEdited&&(s.w=g.pad.wExtra+e.measureText(this.text).width,this.place()),this.is.leftText){const h=s.x+s.w-i.rBullet/2-i.hArrow;H.rectBullet(e,s.x,s.y,s.w,s.h,o,i.rBullet),n.is.channel?n.is.input?H.ballTriangle(e,h,l,i.hArrow,i.wArrow,a):H.triangleBall(e,h,l,i.hArrow,i.wArrow,a):n.is.input?H.rightTriangle(e,h,l,i.hArrow,i.wArrow,a):H.leftTriangle(e,h,l,i.hArrow,i.wArrow,a),n.is.multi?H.leftTextMulti(e,this.text,g.pin.fMulti,r,s.x+g.pad.wMargin,s.y,s.w,s.h):H.leftText(e,this.text,r,s.x+g.pad.wMargin,s.y,s.w,s.h)}else{const h=s.x+i.rBullet/2;H.bulletRect(e,s.x,s.y,s.w,s.h,o,i.rBullet),n.is.channel?n.is.input?H.triangleBall(e,h,l,i.hArrow,i.wArrow,a):H.ballTriangle(e,h,l,i.hArrow,i.wArrow,a):n.is.input?H.leftTriangle(e,h,l,i.hArrow,i.wArrow,a):H.rightTriangle(e,h,l,i.hArrow,i.wArrow,a),n.is.multi?H.rightTextMulti(e,this.text,g.pin.fMulti,r,s.x,s.y,s.w,s.h):H.rightText(e,this.text,r,s.x,s.y,s.w,s.h)}},drawCursor(e,t,i){const s=this.rect,n=e.measureText(this.text.slice(0,t)).width,o=this.is.leftText?s.x+n+g.pad.wMargin:s.x+s.w-e.measureText(this.text).width+n,r=i?g.std.cBlinkOn:g.std.cBlinkOff;H.cursor(e,o,s.y,g.std.wCursor,s.h,r)},center(){const e=this.rect;return this.is.leftText?{x:e.x+e.w,y:e.y+e.h/2}:{x:e.x,y:e.y+e.h/2}},place(){const e=this.routes[0];if(!(e!=null&&e.wire.length))return;const[t,i]=e.from==this?[e.wire[0],e.wire[1]]:[e.wire.at(-1),e.wire.at(-2)];this.is.leftText=t.x<i.x;const s=this.rect;s.y=t.y-s.h/2,s.x=this.is.leftText?t.x-s.w:t.x},startEdit(){return this.is.beingEdited=!0,"text"},getWidth(){const e=this.proxy;return g.pad.wExtra+e.node.look.getTextWidth(this.text,e.is.multi)},endEdit(e){const t=this.proxy;if(this.is.beingEdited=!1,this.text.length>0){if(t.name=this.text,!t.checkNewName()){t.name=this.text=e;return}this.text=t.name,this.checkRouteUsage(),this.rect.w=this.getWidth();return}if(t.routes.length==0){t.node.look.removePin(t),t.node.removePad(this);return}this.text=e},nameChange(e){this.text=e,this.rect.w=this.getWidth()},overlap(e){const t=this.rect;return!(t.x>e.x+e.w||t.x+t.w<e.x||t.y>e.y+e.h||t.y+t.h<e.y)},moveTo(e,t){this.rect.x=e,this.rect.y=t,this.adjustRoutes()},move(e){this.rect.x+=e.x,this.rect.y+=e.y},areConnected(e){return!(e.is.pin&&this.proxy.is.multi&&!e.hasMultiOverlap(this.proxy))},makeConxList(e){var t;for(const i of this.routes){const s=i.from==this?i.to:i.from;this.areConnected(s)&&(s.is.pin?s.is.proxy?(t=s.pad)==null||t.makeConxList(e):e.push(s):s.is.tack&&(s.bus.hasFilter()?e.push(s):s.bus.makeConxList(this,e)))}},highLight(){this.is.highLighted=!0},unHighLight(){this.is.highLighted=!1},hitTest(e){return rt(e,this.rect)?this.is.leftText?e.x>this.rect.x+this.rect.w-2*g.pad.rBullet?[F.padArrow,this]:[F.pad,this]:e.x<this.rect.x+2*g.pad.rBullet?[F.padArrow,this]:[F.pad,this]:[F.nothing,null]},hitRoute(e){let t=0;for(const i of this.routes)if(i.from==this&&(t=i.hitSegment(e)))return[F.route,i,t];return[F.nothing,null,0]}};Object.assign(Pi.prototype,Ku);const Qu={addHeader(){const e=2*(g.icon.xPadding+2*g.icon.wIcon+g.icon.xSpacing),t=this.getTextWidth(this.node.name)+e,i=this.rect;t>i.w&&this.wider(t-i.w);const s={x:i.x,y:i.y,w:i.w,h:g.header.hTitle},n=new Qs(s,this.node);return this.widgets.push(n),n},addLabel(e){const t=this.rect;this.getTextWidth(e);const i={x:t.x,y:t.y-g.label.hLabel,w:t.w,h:g.label.hLabel},s=new en(i,e,this.node);return this.widgets.push(s),t.y-=g.label.hLabel,t.h+=g.label.hLabel,s},removeLabel(){const e=this.findLabel();e&&(Ne(this.widgets,e),this.rect.y+=g.label.hLabel,this.rect.h-=g.label.hLabel)},restoreLabel(e){this.widgets.push(e),this.rect.y-=g.label.hLabel,this.rect.h+=g.label.hLabel},addPin(e,t,i){const s=i.left??t.x<this.rect.x+this.rect.w/2,n=this.displayName(e,t.y),o=this.pinRectangle(n,t.y,s,i.multi),r=i.proxy?new ks(o,this.node,e,i):new Ti(o,this.node,e,i);return r.is.left=s,this.addWidget(r),r},removePin(e){e.is.pin&&Ne(this.widgets,e)&&this.shiftUp(e.rect.y,e.rect.h)},restorePin(e){const t=e.rect;this.makePlace({x:t.x,y:t.y},t.h),this.addWidget(e)},addIfName(e,t){const i=this.makePlace(t,g.ifName.hSep),s={x:this.rect.x,y:i,w:this.rect.w,h:g.ifName.hSep},n=new Zs(s,e,this.node);return this.addWidget(n),n},removeInterfaceName(e){e.is.ifName&&Ne(this.widgets,e)&&this.shiftUp(e.rect.y,e.rect.h)},restoreInterfaceName(e){const t=e.rect;this.makePlace({x:t.x,y:t.y},t.h),this.addWidget(e)},copyPinArea(e,t){if(!e||e.length==0)return null;e.sort((n,o)=>n.rect.y-o.rect.y);const i={...t},s=[];for(const n of e)if(n.is.pin){if(this.findPin(n.name,n.is.input))continue;const o=this.addPin(n.name,i,n.is);n.pxlen&&(o.pxlen=n.pxlen,o.checkPrefix()),i.y=o.rect.y+o.rect.h,s.push(o)}else if(n.is.ifName){if(this.findInterfaceName(n.text))continue;const o=this.addIfName(n.text,i);i.y=o.rect.y+o.rect.h,s.push(o)}return s},deletePinArea(e){if(!(!e||e.length==0))for(const t of e)t.is.pin?(t.disconnect(),this.removePin(t),t.is.proxy?(t.pad.disconnect(),t.node.removePad(t.pad)):t.node.rxtxRemovePin(t)):t.is.ifName&&this.removeInterfaceName(t)}},Zu={getInterface(e){const t=[];t.push(e);let i=this.rect.y+this.rect.h;for(const s of this.widgets)s.is.ifName&&s.rect.y>e.rect.y&&s.rect.y<i&&(i=s.rect.y);for(const s of this.widgets)s.is.pin&&s.rect.y>=e.rect.y&&s.rect.y<i&&t.push(s);return t.sort((s,n)=>s.rect.y-n.rect.y),t},shiftWidgetsBelow(e,t){for(const i of this.widgets){if(i.is.box){i.rect.h+=t,this.rect.h+=t;continue}if(i.rect.y>e&&(i.rect.y+=t,i.routes))for(const s of i.routes)s.clampToWidget(i)}},swapInterface(e,t){const i=this.findNextWidget(t[0],e,u=>u.is.ifName);if(!i||e.y<i.rect.y||e.y>i.rect.y+i.rect.h)return;const s=e.y>t[0].rect.y,n=this.getInterface(i),o=t[0],r=t.at(-1);let a=r.rect.y-o.rect.y+r.rect.h;s&&(a=-a);const l=n[0],c=n.at(-1);let h=c.rect.y-l.rect.y+c.rect.h;s||(h=-h);for(const u of n)u.rect.y+=a,u.is.pin&&u.adjustRoutes();for(const u of t)u.rect.y+=h,u.is.pin&&u.adjustRoutes()},interfaceChangePrefix(e){const t=this.getInterface(e);for(const i of t)if(i.is.pin&&i.pxlen!=0){const s=i.name;i.changePrefix(e.text),i.nameChanged(s)}},showPrefixes(e){const t=e.node.look.getInterface(e),i=[];for(const s of t)s.is.pin&&s.pxlen!=0&&(i.push(s.pxlen),s.pxlen=0);return i},hidePrefixes(e,t){const i=e.node.look.getInterface(e);for(let s=1;s<t.length;s++)i[s].pxlen=t[s]},highLightInterface(e){const t=this.getInterface(e);for(const i of t)i.highLight(),i.is.pin&&i.highLightRoutes();return t},unhighLightInterface(e){if(e)for(const t of e)t.unHighLight(),t.is.pin&&t.unHighLightRoutes()},findIfNameAbove(e){let t=null;for(const i of this.widgets)i.is.ifName&&i.rect.y<e&&(t==null||t.rect.y<i.rect.y)&&(t=i);return t},getPrefixLength(e,t){const i=this.findIfNameAbove(t);if(!i)return 0;const s=e.indexOf(".");if(s>0&&e.slice(0,s)===i.text)return i.text.length;const n=e.lastIndexOf(".");return n>0&&e.slice(n+1)===i.text?-i.text.length:0},displayName(e,t){return this.getPrefixLength(e,t)>0?"+ "+e.slice(this.pxlen+1):e.slice(0,this.pxlen-1)+" +"},dragPinArea(e,t){const i=e[0];if(t.y<i.rect.y){const n=this.findNextWidget(i,{x:0,y:t.y},o=>o.is.pin||o.is.ifName);if(!n)return;t.y<n.rect.y+n.rect.h/2&&(this.groupMove(e,n.rect.y-i.rect.y),this.interfaceCheck());return}const s=e.at(-1);if(t.y+t.h>s.rect.y+s.rect.h){const n=this.findNextWidget(s,{x:0,y:t.y+t.h},o=>o.is.pin||o.is.ifName);if(!n)return;t.y+t.h>n.rect.y+n.rect.h+n.rect.h/2&&(this.groupMove(e,n.rect.y-s.rect.y),this.interfaceCheck());return}},interfaceCheck(){for(const e of this.widgets)e.is.pin&&(e.pxlen=0);for(const e of this.widgets){if(!e.is.ifName)continue;const t=this.getInterface(e);for(const i of t){if(!i.is.pin)continue;const s=e.text.toLowerCase(),n=i.lowerCase();n.startsWith(s)?i.pxlen=s.length:n.endsWith(s)&&(i.pxlen=-s.length)}}}},ef={headerChanged(e,t){if(e.title.length==0){e.title=e.node.name;return}const i=2*(g.icon.xPadding+2*(g.icon.wIcon+g.icon.xSpacing));let s=this.getTextWidth(e.title)+i;s>this.rect.w&&this.wider(s-this.rect.w),e.node.name=e.title,e.node.is.source&&e.node.factory.fName.length<1&&(e.node.factory.fName=k.nodeToFactory(e.node.name)),f.doc.focus.root.checkDuplicates(e.node)},iconRect(e,t){let i=e.x;const s=g.icon;switch(t){case"L1":i=e.x+s.xPadding;break;case"L2":i=e.x+s.xPadding+s.wIcon+s.xSpacing;break;case"R1":i=e.x+e.w-s.xPadding-s.wIcon;break;case"R2":i=e.x+e.w-s.xPadding-s.wIcon-s.xSpacing-s.wIcon;break}return{x:i,y:e.y+s.yPadding,w:s.wIcon,h:s.hIcon}},addIcon(e){const t=this.widgets.find(r=>r.is.header);if(!t)return;const i={group:"L1",factory:"L1",link:"L1",lock:"L1",cog:"L2",comment:"R1",pulse:"R2"},s=this.iconRect(t.rect,i[e]),n=this.widgets.find(r=>r.is.icon&&r.rect.x==s.x);n&&Ne(this.widgets,n);const o=new wn(s,e);o.setRender(),this.widgets.push(o)},badLinkIcon(){const e=this.widgets.find(t=>t.is.icon&&(t.type=="link"||t.type=="lock"));e&&(e.is.bad=!0)},goodLinkIcon(){const e=this.widgets.find(t=>t.is.icon&&(t.type=="link"||t.type=="lock"));e&&(e.is.bad=!1)},checkLinkIcon(e){const t=this.widgets.find(i=>i.is.icon&&(i.type=="link"||i.type=="lock"));(t==null?void 0:t.type)!=e&&this.addIcon(e)},removeLinkIcon(){const e=this.widgets.find(t=>t.is.icon&&t.type=="link");e&&Ne(this.widgets,e)},blinkToWarn(){const e=a=>{a-r>=n&&(t.is.highLighted=!t.is.highLighted,i.is.highLighted=!i.is.highLighted,f.redraw(),r=a,o++),o<s?requestAnimationFrame(e):(t.is.highLighted=!1,i.is.highLighted=!1,f.redraw())},t=this.widgets.find(a=>a.is.icon&&(a.type=="link"||a.type=="lock")),i=this.widgets.find(a=>a.is.header);if(!t||!i)return;const s=g.icon.nBlinks*2,n=g.icon.blinkRate;let o=0,r=0;requestAnimationFrame(e)}},tf={moveDelta(e,t){this.rect.x+=e,this.rect.y+=t,this.widgets.forEach(i=>{i.rect.x+=e,i.rect.y+=t})},moveTo(e,t){this.moveDelta(e-this.rect.x,t-this.rect.y)},adjustRoutes(){for(const e of this.widgets)e.routes&&e.adjustRoutes()},moveRoutes(e,t){for(const i of this.widgets)if(i.routes)for(const s of i.routes)s.from==i&&s.moveAllPoints(e,t)},groupMove(e,t){const i=(r,a)=>{r.rect.y+=a,r.is.pin&&r.adjustRoutes()},s=e[0].rect.y,n=e.at(-1).rect.y,o=n-s+e.at(-1).rect.h;for(const r of this.widgets){const a=r.rect.y;a<=n&&a>=s?i(r,t):t>0&&a>n&&a<=n+t?i(r,-o):t<0&&a<s&&a>=s+t&&i(r,o)}},findNextWidget(e,t,i){let s=e.rect.y;if(t.y>=s&&t.y<=s+e.rect.h)return null;let n=null;if(t.y<s)for(const o of this.widgets)!i(o)||o==e||o.rect.y<s&&(n==null||n.rect.y<o.rect.y)&&(n=o);else if(t.y>s+e.rect.h)for(const o of this.widgets)!i(o)||o==e||o.rect.y>s&&(n==null||n.rect.y>o.rect.y)&&(n=o);return n},snapRoutes(){for(const e of this.widgets)if(e.is.pin)for(const t of e.routes){const i=t.wire;if(i.length<3)continue;const[s,n]=e==t.from?[i[0],i[2]]:[i.at(-1),i.at(-3)],o=n.y-s.y;if(Math.abs(o)<g.route.tooClose){this.moveDelta(0,o),this.adjustRoutes();return}}}},sf={copy(e){e.look.widGenerator=this.widGenerator,this.widgets.forEach(t=>{let i=null;t.is.pin?(i=t.is.proxy?new ks(t.rect,e,t.name,t.is):new Ti(t.rect,e,t.name,t.is),i.profile=t.profile,i.pxlen=t.pxlen):t.is.ifName?i=new Zs(t.rect,t.text,e):t.is.header?i=new Qs(t.rect,e):t.is.icon?(i=new wn(t.rect,t.type),i.setRender()):t.is.box?i=new Ks(t.rect,e):t.is.label&&(i=new en(t.rect,t.text,e)),t.wid&&(i.wid=t.wid),i&&e.look.widgets.push(i)})},copyConvert(e){e.look.widGenerator=this.widGenerator,this.widgets.forEach(t=>{let i=null;if(t.is.pin)i=t.is.proxy?new Ti(t.rect,e,t.name,t.is):new ks(t.rect,e,t.name,t.is),i.profile=t.profile,i.pxlen=t.pxlen;else if(t.is.ifName)i=new Zs(t.rect,t.text,e);else if(t.is.header)i=new Qs(t.rect,e);else if(t.is.icon){const s=t.type=="group"?"factory":t.type=="factory"?"group":t.type;e.look.addIcon(s)}else t.is.box?i=new Ks(t.rect,e):t.is.label&&(i=new en(t.rect,t.text,e));t.wid&&(i.wid=t.wid),i&&e.look.widgets.push(i)})},copyPinPinRoutes(e){const t=e.widgets.length;let i=null,s=null;for(let n=0;n<t;n++)if(i=e.widgets[n],s=this.widgets[n],i.is.pin&&i.is.input)for(const o of i.routes){if(!o.to.is.pin||!o.from.is.pin)continue;const r=o.clone();r.from==i?r.from=s:r.to=s,s.routes.push(r)}},correctPinPinRoutes(e){for(const t of this.widgets)if(t.is.input)for(const i of t.routes){const s=i.from==t?i.to:i.from;if(!s.is.pin)continue;const o=e.nodes.find(r=>r.uid==s.node.uid).look.findPin(s.name,!1);i.from==t?i.to=o:i.from=o,o.routes.push(i)}},transferRoutes(e){var t;for(let i=0;i<e.widgets.length;i++){const s=this.widgets[i],n=e.widgets[i];if(((t=s.routes)==null?void 0:t.length)>0)for(const o of s.routes)o.from==s&&(o.from=n),o.to==s&&(o.to=n),n.routes.push(o)}}},nf={getItemsToSave(){const e=[],t={rect:{...this.rect},label:null,interfaces:[]};for(const n of this.widgets)if(!(n.is.icon||n.is.box||n.is.header)){if(n.is.label){t.rect.y+=n.rect.h,t.rect.h-=n.rect.h,t.label=n;continue}(n.is.ifName||n.is.pin)&&e.push(n)}if(e.length==0)return t;e.sort((n,o)=>n.rect.y-o.rect.y);let i=-1,s=null;e[0].is.pin&&(i++,t.interfaces[i]={name:"",pins:[],editor:{id:0}},s=t.interfaces[i].pins);for(const n of e)n.is.pin?s.push(n):n.is.ifName&&(i++,t.interfaces[i]={name:n.text,pins:[],editor:{id:n.wid}},s=t.interfaces[i].pins);return t},acceptChanges(){var t;const e=[];for(const i of this.widgets){if(i.is.pin){const s=(t=i.routes)==null?void 0:t.slice();if(i.is.zombie){for(const n of s)n.disconnect();e.push(i)}else for(const n of s)n.is.newConx?n.is.newConx=!1:n.is.noConx&&n.disconnect()}i.is.ifName&&i.is.zombie&&(i.node.look.showPrefixes(i),e.push(i)),i.is.added&&(i.is.added=!1)}for(const i of e)i.is.pin?i.node.look.removePin(i):i.is.ifName&&i.node.look.removeInterfaceName(i)},cook(e){var t;if(e.label&&this.addLabel(e.label),!!e.interfaces){for(const i of e.interfaces){this.cookInterface(i);for(const s of i.pins){const n=this.cookPin(s);this.node.is.group&&((t=s.editor)!=null&&t.pad?this.node.cookPad(n,s.editor.pad):this.node.addPad(n))}}for(const i of this.widgets)i.wid&&i.wid>this.widGenerator&&(this.widGenerator=i.wid);for(const i of this.widgets)i.wid==0&&(i.wid=this.generateWid())}},cookPin(e){e.editor||(e.editor={id:0,align:"left"});const t={input:!1,left:!1,channel:!1,multi:!1,zombie:!1};t.input=e.kind=="input"||e.kind=="reply",t.left=e.editor.align=="left",t.channel=e.kind=="request"||e.kind=="reply",t.multi=k.isMulti(e.name),t.proxy=this.node.is.group;const i=this.addPin(e.name,0,t);return i.wid=e.editor.id,i.ifNamePrefixCheck(),this.adjustPinWidth(i),i},cookInterface(e){var i;if(e.name.length==0)return null;const t=this.addIfName(e.name,null);return t.wid=((i=e.editor)==null?void 0:i.id)||0,t}};function yt(e){this.rect={...e},this.rect.w=e.w>0?e.w:g.look.wBox,this.rect.h=e.h>0?e.h:g.look.hTop+g.look.hBottom,this.node=null,this.widGenerator=0,this.widgets=[]}yt.prototype={render(e){var t;(t=this.widgets)==null||t.forEach(i=>i.render(e,this))},remove(){},getMinWidth(){let e=g.look.wBox;for(const t of this.widgets)t.is.pin&&t.rect.w>e&&(e=t.rect.w);return e},changeWidth(e){this.rect.w+=e,this.widgets.forEach(t=>{t.is.pin&&!t.is.left?(t.rect.x+=e,t.adjustRoutes()):t.is.header||t.is.ifName||t.is.box?t.rect.w+=e:t.is.icon&&t.rect.x>this.rect.x+(this.rect.w-e)/2&&(t.rect.x+=e)})},adjustPinWidth(e){const t=g.pin.wMargin+this.getTextWidth(e.withoutPrefix(),e.is.multi);e.is.left||(e.rect.x+=e.rect.w-t),e.rect.w=t,e.rect.w>this.rect.w&&this.wider(e.rect.w-this.rect.w)},getTextWidth(e,t=!1){const i=f.getCanvasContext();if(!t)return i.measureText(e).width;const[s,n,o]=k.getPreMiddlePost(e);let r=i.measureText(s+"[").width+i.measureText("]"+o).width;const a=i.font;return i.font=g.pin.fMulti,r+=i.measureText(n).width,i.font=a,r},wider(e=0){this.rect.w>=g.look.wMax||(e=e>0?Math.ceil(e/g.look.wExtra)*g.look.wExtra:g.look.wExtra,this.rect.w+e>g.look.wMax&&(e=g.look.wMax-this.rect.w),this.changeWidth(e))},smaller(e=0){const t=this.getMinWidth();this.rect.w<=t||(e=e>0?(1+Math.floor(e/g.look.wExtra))*g.look.wExtra:g.look.wExtra,this.rect.w-e<t&&(e=this.rect.w-t),this.changeWidth(-e))},decorate(e){this.node=e,this.addBox(),this.addHeader(),this.addIcon("cog"),e.is.source?this.addIcon("factory"):this.addIcon("group"),this.addIcon("pulse"),this.addIcon("comment")}};Object.assign(yt.prototype,Od,Qu,Zu,ef,tf,sf,nf);function ss(e=null,t=null,i=null){this.uid=i,this.name=t,this.is={group:!1,source:!1,highLighted:!1,placed:!0,duplicate:!1},this.link=null,this.look=e,this.sx=null,this.dx=null,this.prompt=null}ss.prototype={render(e){var i,s;const t=(i=this.link)!=null&&i.model?g.switch(this.link.model.header.style):null;(s=this.look)==null||s.render(e),t&&g.switch(t)},findByName(e){if(this.name==e)return this;if(this.nodes){let t=null;for(const i of this.nodes)if(t=i.findByName(e))return t}return null},findByName(e){if(this.name==e)return this;if(this.nodes){let t=null;for(const i of this.nodes)if(t=i.findByName(e))return t}return null},findParent(e){let t=this;if(this.nodes){for(const i of this.nodes)if(i==e)return t;for(const i of this.nodes)if(i.is.group&&(t=i.findParent(e)))return t}return null},updateName(e){if(!(!e||e===this.name)){this.name=e;for(const t of this.look.widgets)if(t.is.header){t.title=e;break}}},hitTest(e){const{x:t,y:i,w:s,h:n}=this.look.rect,o=g.pin.wOutside;if(e.x<t-o||e.x>t+s+o||e.y<i||e.y>i+n)return[F.nothing,null,null];for(const r of this.look.widgets){const a=r.rect;if(r.is.box||e.y<a.y||e.y>a.y+a.h||e.x<a.x||e.x>a.x+a.w||r.is.header&&!r.hitTitle(e))continue;return[r==null?F.node:r.is.pin?F.pin:r.is.ifName?F.ifName:r.is.icon?F.icon:r.is.header?F.header:r.is.label?F.label:F.node,this,r]}return[F.node,this,null]},hitRoute(e){let t=0;for(const i of this.look.widgets)if(i.is.pin&&i.routes.length>0){for(const s of i.routes)if(s.from==i&&(t=s.hitSegment(e)))return[F.route,s,t]}return[F.nothing,null,0]},overlap(e){const t=this.look.rect;return!(t.x>e.x+e.w||t.x+t.w<e.x||t.y>e.y+e.h||t.y+t.h<e.y)},isContainer(){return this.is.group&&this.pads.length==0},compatible(e){return e.is.group&&this.is.group||e.is.source&&this.is.source},cookCommon(e){e.editor||(e.editor={rect:null});const t=e.editor.rect?k.stringToRect(e.editor.rect):{x:0,y:0,w:0,h:0};this.is.placed=!!e.editor.rect,this.look=new yt(t),this.look.rect.h=g.look.hTop+g.look.hBottom,this.look.decorate(this),this.look.cook(e),t.w>0&&this.look.rect.w>t.w&&this.look.smaller(this.look.rect.w-t.w),e.prompt&&(this.prompt=e.prompt),e.sx&&(this.sx=e.sx),e.dx&&(this.dx=e.dx)},uidChangeAll(e){if(e.generate(this),!this.is.source){for(const t of this.pads)e.generate(t);for(const t of this.buses)e.generate(t);for(const t of this.nodes)t.uidChangeAll(e)}},uidChangeImported(e){for(const t of this.pads)e.generate(t);for(const t of this.buses)e.generate(t);for(const t of this.nodes)t.link||(e.generate(t),t.is.group&&t.uidChangeImported(e))},setUIDS(e){if(e.generate(this),!this.is.source){for(const t of this.pads)e.generate(t);for(const t of this.buses)e.generate(t)}},usesFactory(e,t){var i;this.is.group?this.nodes.forEach(s=>s.usesFactory(e,t)):((i=this.factory)==null?void 0:i.name)==e&&t.push(this)},move(e){this.look.moveDelta(e.x,e.y),this.look.adjustRoutes()},doSelect(){for(const e of this.look.widgets)if(e.is.box){e.is.selected=!0;return}},unSelect(){for(const e of this.look.widgets)if(e.is.box){e.is.selected=!1;return}},samePosition(e){return this.look.rect.x==e.look.rect.x&&this.look.rect.y==e.look.rect.y},cannotBeModified(){return this.link==null?!1:(this.look.blinkToWarn(),!0)},switchNodeType(){const e=this.is.group?this.copyAsSourceNode():this.copyAsGroupNode();return this.look.transferRoutes(e.look),e}};Object.assign(ss.prototype,Nd,Cd,Rd,Ed,Pd,Ld);const of={toJSON(){if(this.link)return this.dockToJSON();const{rect:e,label:t,interfaces:i}=this.look?this.look.getItemsToSave():{rect:null,label:null,interfaces:[]},s={kind:"group",name:this.name};t&&(s.label=t),i.length&&(s.interfaces=i),this.sx&&(s.sx=this.sx),this.dx&&(s.dx=this.dx),this.prompt&&(s.prompt=this.prompt),this.nodes.length&&(s.nodes=this.nodes);const[n,o]=this.getRoutesAndConnections();return o.length&&(s.connections=o),s.editor={rect:k.rectToString(e)},this.savedView&&(s.editor.view=k.viewToJSON(this.savedView)),this.buses.length&&(s.editor.buses=this.buses),n.length&&(s.editor.routes=n),s},dockToJSON(){const{rect:e,label:t,interfaces:i}=this.look?this.look.getItemsToSave():{rect:null,label:null,interfaces:[]},s={kind:"dock",name:this.name,link:this.link};return t&&(s.label=t),this.prompt&&(s.prompt=this.prompt),i.length&&(s.interfaces=i),this.sx&&(s.sx=this.sx),this.dx&&(s.dx=this.dx),s.editor={rect:k.rectToString(e)},s},cook(e,t){if(this.cookCommon(e),e.editor.view&&(this.savedView=k.stringToView(e.editor.view)),e.nodes)for(const n of e.nodes){const o=n.link?t.linkedNode(n):t.localNode(n);o&&this.nodes.push(o),o.is.placed||this.placeNode(o)}const i=e.connections?this.cookConx(e.connections):[];if(e.editor.buses)for(const n of e.editor.buses){const o=new Ps(n.name,{x:0,y:0});o.cook(n,t),this.buses.push(o)}const s=[];if(e.editor.routes)for(const n of e.editor.routes){const o=this.cookRoute(n);o&&s.push(o)}if(i){for(const n of s)this.findRouteInConx(n,i);this.createRoutes(i)}},placeRoot(){const e=g.placement;this.look.moveTo(e.marginLeft,e.marginTop),this.is.placed=!0},placeNode(e){const t=g.placement,i=this.nodes.length-1,s=i%t.nodesPerRow,n=Math.floor(i/t.nodesPerRow),o=this.pads.length?t.marginLeftPads:t.marginLeft;e.look.moveTo(o+s*t.colStep,t.marginTop+n*t.rowStep),e.is.placed=!0},cookPad(e,t){let i=t.rect?k.stringToRect(t.rect):{x:10,y:10,w:0,h:0};i.w==0&&(i=e.makePadRect({x:i.x,y:i.y}));const s=new Pi(i,e,null);s.is.leftText=t.align=="left",e.pad=s,this.pads.push(s)},cookRoute(e){const t=k.rawToEndPoint(e.from),i=k.rawToEndPoint(e.to);if(!t||!i)return null;let[s,n]=this.getEndPoints(t,i);if(!s||!n)return s||console.error(`invalid route *FROM* ${e.from} to ${e.to}`),n||console.error(`invalid route from ${e.from} *TO* ${e.to}`),null;s.is.bus&&(s=s.newTack()),n.is.bus&&(n=n.newTack());const o=new xt(s,n);return o.wire=k.stringToWire(s.center(),n.center(),e.wire),o.wire.length<2&&o.autoRoute(this.nodes),s.is.tack?s.setRoute(o):s.routes.push(o),n.is.tack?n.setRoute(o):n.routes.push(o),o.checkTwistedPair(),o.adjust(),o},getEndPoints(e,t){const i=(a,l)=>{for(const c of this.nodes){if(c.name!=a.node)continue;let h=c.look.widgets.find(u=>u.is.pin&&u.is.input==l&&u.name===a.pin);return h||c.look.widgets.find(u=>u.is.pin&&u.is.input==l&&u.wid===a.wid),h}},s=(a,l)=>{let c=this.pads.find(h=>h.proxy.is.input==l&&h.proxy.name===a.pad);return c||this.pads.find(h=>h.proxy.is.input==l&&h.proxy.wid===a.wid),c},n=a=>this.buses.find(l=>l.name===a.bus);let o=null,r=null;return e.pin?(o=i(e,!1),r=t.pin?i(t,!0):t.pad?s(t,!1):t.bus?n(t):null):e.pad?(o=t.pin?s(e,!0):t.bus?s(e,!1):null,r=t.pin?i(t,!0):t.bus?n(t):null):e.bus&&(o=n(e),r=t.pin?i(t,!0):t.pad?s(t,!0):null),[o,r]},fuse(e){this.widgetCompare(e),this.sxUpdate(e),this.nodes=e.nodes,this.buses=e.buses,this.pads=e.pads,this.reConnectPads()},reConnectPads(){this.pads.forEach(e=>{const t=this.look.findPin(e.proxy.name,e.proxy.is.input);if(!t)return console.log(`*** ERROR *** node ${this.name} has no proxy for pad  ${e.proxy.name}`);e.proxy=t,t.pad=e})}},rf={addProxies(e){var i;const t=[];(i=e.nodes)==null||i.forEach(s=>{var n;(n=s.look.widgets)==null||n.forEach(o=>{var l;if(!((l=o.routes)!=null&&l.length)>0)return;const r=[];o.routes.slice().forEach(c=>{const h=c.from==o?c.to:c.from;h.is.pin&&e.nodes.includes(h.node)||h.is.tack&&e.tacks.includes(h)||(r.push(h),c.from.removeRoute(c),c.to.removeRoute(c))}),r.length>0&&t.push({widget:o,destinations:r})})}),t.sort((s,n)=>s.widget.rect.y>n.widget.rect.y?1:s.widget.rect.y<n.widget.rect.y?-1:0),t.forEach(s=>{const n=s.widget,o=this.copyPinAsProxy(n);this.addPad(o),o.pad.moveTo(o.pad.rect.x,n.rect.y),o.pad.routeToPin(n);let r=null;s.destinations.forEach(a=>{r=new xt(o,a),r.builder(),o.routes.push(r),a.is.pin?a.routes.push(r):a.is.tack&&a.restore(r)})})},copyPinAsProxy(e){const t=this.look;let i=null;if(e.pxlen!=0){const o=e.getPrefix();let r=t.findInterfaceName(o);r||(r=this.look.addIfName(o,t.nextPinPosition(!1)));const a=t.getInterface(r).at(-1).rect;i={x:e.is.left?a.x:a.x+a.w,y:a.y+a.h}}else i=t.nextPinPosition(e.is.left);const s=t.pinRectangle(e.displayName(),i.y,e.is.left),n=new ks(s,this,e.name.slice(),e.is);return n.pxlen=e.pxlen,t.addWidget(n),n},addPad(e){var r;const t=g.placement.marginTop+this.pads.length*(g.pad.hPad+g.pad.hSpace),i=this.savedView?this.savedView.rect.w:g.view.wDefault,s=this.savedView?this.savedView.rect.x:0,n=e.is.left?e.makePadRect({x:g.pad.wViewLeft+s,y:t}):e.makePadRect({x:i-g.pad.wViewRight+s,y:t}),o=new Pi(n,e);(r=f.doc)==null||r.UID.generate(o),this.pads.push(o),e.pad=o},removePad(e){Ne(this.pads,e)},restorePad(e){this.pads.push(e)},addPads(e){for(const t of e)t.is.proxy&&this.addPad(t)},addBus(e,t,i=null){const s=new Ps(e??"",t,i);return this.buses.push(s),s},deleteBus(e){e.disconnect(),this.removeBus(e)},removeBus(e){Ne(this.buses,e)},restoreBus(e){this.buses.find(t=>t.uid==e.uid)||this.buses.push(e)}},af={addConnection(e,t,i){const s=r=>r.is.pin?{pin:r.name,node:r.node.name}:r.is.pad?{pin:r.proxy.name}:{pin:"?",node:"?"};if(!t.is.tack){i.push({src:s(e),dst:s(t)});return}const n=t.bus,o=[];for(const r of n.tacks){if(r==t)continue;const a=r.route.from==r?r.route.to:r.route.from;n.areConnected(e,a)&&o.push(a)}for(const r of o)i.push({src:s(e),dst:s(r)})},getRoutesAndConnections(){const e=[],t=[];for(const i of this.nodes)for(const s of i.look.widgets)if(!(!s.is.pin||s.is.input))for(const n of s.routes){e.push(k.routeToString(n));const o=n.from==s?n.to:n.from;this.addConnection(s,o,t)}for(const i of this.pads)if(i.proxy.is.input)for(const s of i.routes){e.push(k.routeToString(s));const n=s.from==i?s.to:s.from;this.addConnection(i,n,t)}for(const i of this.buses)for(const s of i.tacks){const n=s.getOther();n.is.pin&&n.is.input&&e.push(k.routeToString(s.route)),n.is.pad&&!n.proxy.is.input&&e.push(k.routeToString(s.route))}return[e,t]},cookConx(e){const t=(c,h)=>{for(const u of this.nodes)if(u.name==c.node)return u.look.widgets.find(m=>m.is.pin&&m.name===c.pin&&m.is.input===h)},i=(c,h)=>this.pads.find(u=>u.proxy.name===c.pin&&u.proxy.is.input===h),s=(c,h)=>{var v,w,y,b,N,L;const u=`${(v=h.from)==null?void 0:v.pin} ${(w=h.from)!=null&&w.node?" @ "+((y=h.from)==null?void 0:y.node):"(pad)"}`,m=`${(b=h.to)==null?void 0:b.pin} ${(N=h.to)!=null&&N.node?" @ "+((L=h.to)==null?void 0:L.node):"(pad)"}`;console.error(c+u+" -> "+m)},n=(c,h)=>c.is.pin&&h.is.pin?c.is.input==h.is.input:c.is.pin&&h.is.pad?c.is.input!=h.proxy.is.input:c.is.pad&&h.is.pin?c.proxy.is.input!=h.is.input:(c.is.pad&&h.is.pad,!0),o=(c,h)=>{const u=c.is.pin?c:c.proxy,m=h.is.pin?h:h.proxy;if(u.is.input&&u.is.channel||m.is.input&&m.is.channel)return u.is.channel!=m.is.channel},r=[];let a=null,l=null;for(const c of e){const h=c.from??c.src,u=c.to??c.dst;if(!(!h||!u)&&(a=h.node?t(h,!1):i(h,!0),a||s("Connection <src> not found: ",c),l=u.node?t(u,!0):i(u,!1),l||s("Connection <dst> not found: ",c),!(!a||!l))){if(n(a,l)){s("Input/output mismatch: ",c);continue}if(o(a,l)){s("request/reply mismatch: ",c);continue}r.push({src:a,dst:l,is:{new:!0}})}}return r},findRouteInConx(e,t){const i=(r,a)=>t.find(l=>r==l.src&&a==l.dst||r==l.dst&&a==l.src),s=(r,a,l)=>{for(const c of r.tacks){if(c==l)continue;const h=c.getOther();if(r.areConnected(a,h)){const u=i(a,h);u?u.is.new=!1:c.route.is.noConx=!0}}},[n,o]=e.messageFlow();if(t.length==0){e.is.noConx=!o.is.tack;return}if(n.is.tack)e.is.noConx=!1;else if(o.is.tack)s(o.bus,n,o);else{const r=i(n,o);r?r.is.new=!1:e.is.noConx=!0}},createRoutes(e){if(e!=null&&e.length)for(const t of e){if(!t.is.new)continue;const i=new xt(t.src,t.dst);i.autoRoute(this.nodes),i.is.newConx=!0,i.from.routes.push(i),i.to.routes.push(i)}}},lf="group";function Dt(e=null,t=lf,i=null){ss.call(this,e,t,i),this.is.group=!0,this.nodes=[],this.buses=[],this.pads=[],this.savedView=null,e&&e.decorate(this)}const cf={addNode(e){this.nodes.push(e)},removeNode(e){Ne(this.nodes,e)},restoreNode(e){this.nodes.push(e)},findNode(e){var s;const t=k.splitLink(e);if(t.length==1)return this.findRecursive(e);let i=this;for(const n of t)if(i=((s=i.nodes)==null?void 0:s.find(o=>n===o.name))||null,!i)return null;return i},findRecursive(e){for(const i of this.nodes)if(i.name==e)return i;let t=null;for(const i of this.nodes)if(i.is.group&&(t=i.findRecursive(e)))return t;return null},hasDuplicate(e){for(const t of this.nodes)if(t!=e&&t.name===e.name)return!0;return!1},checkDuplicates(e){e.is.duplicate=!1;for(const t of this.nodes)t!=e&&(t.is.duplicate&&(t.is.duplicate=this.hasDuplicate(t)),t.name===e.name&&(e.is.duplicate=t.is.duplicate=!0))},swap(e,t){for(let i=0;i<this.nodes.length;i++)if(this.nodes[i]==e)return this.nodes[i]=t,!0;for(const i of this.nodes)if(i.is.group&&i.swap(e,t))return!0;return!1},copy(){var t,i,s,n;const e=new Dt(null,this.name,this.uid);return e.link=this.link?this.link.copy():null,e.look=new yt(this.look.rect),this.look.copy(e),e.prompt=this.prompt?this.prompt.slice():null,e.sx=this.sx?ta(this.sx):null,(t=this.nodes)==null||t.forEach(o=>{const r=o.copy();r.look.copyPinPinRoutes(o.look),e.addNode(r)}),(i=e.nodes)==null||i.forEach(o=>{o.look.correctPinPinRoutes(e)}),(s=this.pads)==null||s.forEach(o=>{const r=o.copy();r.copyPadPinRoutes(o,e);const a=e.look.widgets.find(l=>l.is.proxy&&l.name==o.proxy.name&&l.is.input==o.proxy.is.input);r.proxy=a,a.pad=r,e.pads.push(r)}),(n=this.buses)==null||n.forEach(o=>{const r=o.copy();o.copyTacks(r,e),e.buses.push(r)}),e.rxtxBuildTxTable(),e},copyAsSourceNode(e=null){let t=new xi(null,e??this.name,this.uid);return t.look=new yt(this.look.rect),this.look.copyConvert(t),t.rxtxPrepareTables(),t}};Object.assign(Dt.prototype,ss.prototype,cf,rf,of,af);const hf={toJSON(){const{rect:e,label:t,interfaces:i}=this.look.getItemsToSave(),s=this.link?{kind:"dock",name:this.name,link:this.link}:{kind:"source",name:this.name,factory:this.factory};return t&&(s.label=t),this.prompt&&(s.prompt=this.prompt),i.length&&(s.interfaces=i),this.sx&&(s.sx=this.sx),this.dx&&(s.dx=this.dx),s.editor={rect:k.rectToString(e)},s},fuse(e){this.widgetCompare(e),this.factory.fName=e.factory.fName,this.factory.arl=e.factory.arl?e.factory.arl.copy():null,this.sxUpdate(e),this.rxtxResetTables(),this.rxtxPrepareTables()},cook(e,t){if(this.cookCommon(e),e.factory){const i=t.getMainModel(),s=t.getCurrentModel();e.factory.path&&(this.factory.arl=s.arl.resolve(e.factory.path),i!=s&&this.factory.arl.makeRelative(i.arl)),this.factory.fName=e.factory.function}this.rxtxPrepareTables()},analyzeFactory(e){var r;const i=Object.entries(e).find(a=>a[0]==this.factory.fName);if(!i)return;const s={out(){}},n=i[1];let o=((r=n.prototype)==null?void 0:r.constructor)===n?n(s,null):new n(s,null);for(const a in o)if(a.startsWith("-> ")&&typeof o[a]=="function"){const l=a.slice(3),c=o[a].toString(),h=c.indexOf("("),u=c.indexOf(")"),m=c.slice(h+1,u);for(const v of this.look.widgets)v.is.pin&&v.name==l&&(v.profile=m)}}};function xi(e=null,t=null,i=null){t=t??"new",ss.call(this,e,t,i),this.is.source=!0,this.factory=new Ki(t?k.nodeToFactory(t):""),this.rxTable=[],this.txTable=[],e&&e.decorate(this)}const df={copy(e){const t=new xi(null,this.name,this.uid);return t.factory.copy(this.factory),t.look=new yt(this.look.rect),this.look.copy(t),t.prompt=this.prompt?this.prompt.slice():null,t.sx=this.sx?ta(this.sx):null,t.link=this.link?this.link.copy():null,t.rxtxPrepareTables(),t},getSourceArl(e){var t,i,s;return(i=(t=this.link)==null?void 0:t.model)!=null&&i.is.lib?this.link.model.arl:e?e.arl:this.factory.arl?this.factory.arl:(s=this.link)!=null&&s.model?this.link.model.arl.resolve("index.js"):null},copyAsGroupNode(e=null){const t=new Dt(null,e??this.name,this.uid);t.look=new yt(this.look.rect),this.look.copyConvert(t);for(const i of t.look.widgets)i.is.proxy&&t.addPad(i);return t},makeSourceBody(){var l,c;function e(h){const u="___________________________________________________________________",m=h.length;return`
	//`+u.slice(0,-m)+h.toUpperCase()}const t=k.nodeToFactory(this.name);let s=`// ------------------------------------------------------------------
// Source node: ${t}
// Creation date ${new Date().toLocaleString()}
// ------------------------------------------------------------------`,n=((l=this.prompt)==null?void 0:l.length)>0?`

/*
`+this.prompt+`
*/`:"",o=`

//Constructor for ${this.name}
export function ${t}(tx, sx) {
}`;this.look.widgets.sort((h,u)=>h.rect.y-u.rect.y);let r="[";for(const h of this.look.widgets){if(h.is.ifName&&(r+=e(h.text)),!h.is.pin||h.is.input)continue;((c=h.profile)==null?void 0:c.length)>0&&(r+=`

	// `+h.profile);const u=h.is.channel?"=>":"->";if(h.is.multi){const m=k.expandMultis(h.name);for(const v of m)r+=`
	"${v} ${u}",`}else r+=`
	"${h.name} ${u}",`}r+=`
	],`;let a=`

${t}.prototype = {

	// Output pins of the node

	sends: ${r}

	// Input pins of the node
	// For each input pin "a_message" there is a handler "-> a_message" or "=> a_message" (with channel)`;return this.look.widgets.forEach(h=>{var m;if(h.is.ifName&&(a+=e(h.text)),!h.is.pin||!h.is.input)return;a+=((m=h.profile)==null?void 0:m.length)>0?`
	// `+h.profile:`
`;const u=h.is.channel?"=>":"->";if(h.is.multi){const v=k.expandMultis(h.name);for(const w of v)a+=`
	"${u} ${w}"({}) {
	},`}else a+=`
	"${u} ${h.name}"({}) {
	},`}),a+=`

} // ${this.name}.prototype`,s+n+o+a}};Object.assign(xi.prototype,ss.prototype,df,hf);function Ki(e=null){this.fName=e??"",this.arl=null,this.alias=null}Ki.prototype={toJSON(){var e;return{path:((e=this.arl)==null?void 0:e.userPath)??"./index.js",function:this.fName}},copy(e){this.fName=e.fName,this.alias=e.alias,this.arl=e.arl?e.arl.copy():null},clone(){const e=new Ki;return e.copy(this),e},resolve(e,t,i,s=null){var n;if(!e||e.length==0){if(!s||s.length==0)return;e=s}if(e!==this.fName&&(this.fName=e),!(this.arl==null&&(!t||t.length==0))&&((n=this.arl)==null?void 0:n.userPath)!==t){if(!t||t.length==0){this.arl=null;return}t.at(-1)==="/"?t=t+"index.js":t.lastIndexOf(".js")<0&&(t=t+".js"),this.arl=i.resolve(t)}},duplicate(e,t){const i=e.find(s=>s.arl.equals(t)?!1:s.items.find(n=>n==this.fName));return i?(console.warn(`Duplicate factory name: ${this.fName} is already defined in ${i.arl.userPath}`),this.alias="_"+this.fName,!0):(this.alias=null,!1)}};const uf={drawXY(e){const t=this.wire;let i=t.length;if(i==0){let o=this.from.center();t.push({x:o.x,y:o.y}),t.push({x:e.x,y:o.y});return}let s=t[i-2],n=t[i-1];n.y==s.y?Math.abs(e.y-n.y)>g.route.split?t.push({x:n.x,y:e.y}):(n.x=e.x,i>2&&Math.abs(n.x-s.x)<g.route.tooClose&&t.pop()):Math.abs(e.x-n.x)>g.route.split?t.push({x:e.x,y:n.y}):(n.y=e.y,i>2&&Math.abs(n.y-s.y)<g.route.tooClose&&t.pop())},builder(){switch(this.typeString()){case"PIN-PIN":this.fourPointRoute();break;case"PIN-PAD":this.fourPointRoute();break;case"PAD-PIN":this.fourPointRoute();break;case"PIN-BUS":this.to.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"BUS-PIN":this.from.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"PAD-BUS":this.to.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"BUS-PAD":this.from.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break}},sixPointRoute(){this.wire.length>0&&(this.wire.length=0);const e=this.wire,t=this.from,i=this.to,s=t.center(),n=i.center();let o=0,r=0,a=0;if(t.is.pin&&i.is.pin){const l=g.look.dxCopy*(2-Math.random());o=t.is.left?s.x-l:s.x+l,r=i.is.left?n.x-l:n.x+l;const c=t.node.look.rect,h=i.node.look.rect;a=s.y+(c.h/4+h.h/4)*(2-Math.random())}e.push(s),e.push({x:o,y:s.y}),e.push({x:o,y:a}),e.push({x:r,y:a}),e.push({x:r,y:n.y}),e.push(n)},fourPointRoute(){this.wire.length>0&&(this.wire.length=0);const e=this.wire,t=this.from,i=this.to,s=t.center(),n=i.center();let o=0;if(t.is.pin&&i.is.pin&&t.is.left==i.is.left){const r=g.look.dxCopy*(2-Math.random());t.is.left?o=t.rect.x<i.rect.x?t.rect.x-r:i.rect.x-r:o=t.rect.x+t.rect.w>i.rect.x+i.rect.w?t.rect.x+t.rect.w+r:i.rect.x+i.rect.w+r}else{const r=Math.abs(s.x-n.x)*.5*Math.random();o=s.x<n.x?s.x+(n.x-s.x)*.25+r:s.x-(s.x-n.x)*.25-r}e.push(s),e.push({x:o,y:s.y}),e.push({x:o,y:n.y}),e.push(n)},threePointRoute(e){this.wire.length>0&&(this.wire.length=0);const t=this.wire,i=this.from.center(),s=this.to.center();t.push(i),e?t.push({x:s.x,y:i.y}):t.push({x:i.x,y:s.y}),t.push(s)},twoPointRoute(){this.wire.length>0&&(this.wire.length=0);const e=this.wire,t=this.from.center(),i=this.to.center();e.push(t),e.push({x:i.x,y:t.y})},endpoint(e){let t=this.wire,i=t.length;if(i<2)return;let{x:s,y:n}=e.center();if(i==2){t[0].y!=n?(t[1].x=(t[0].x+s)/2,t[1].y=t[0].y,t.push({x:t[1].x,y:n}),t.push({x:s,y:n})):t[1].x=s;return}t[i-1].x==t[i-2].x?(t[i-1].y=n,t.push({x:s,y:n})):(t[i-1].x=s,t[i-1].y=n,t[i-2].x==t[i-3].x?t[i-2].y=t[i-1].y:t[i-2].x=t[i-1].x)},resumeDrawing(e,t){let i=this.from.center(),s=this.to.center();const n=Math.hypot(i.x-t.x,i.y-t.y),o=Math.hypot(s.x-t.x,s.y-t.y);n<o&&(this.reverse(),e=this.wire.length-e),this.wire.length=e>1?e:0,this.from.is.pin||this.from.is.pad?this.from.routes.push(this):this.from.is.tack&&(this.from.route=this,this.from.bus.tacks.push(this.from)),this.to=null,this.drawXY(t)},lineOfSight(e){const t=this.from.center(),i=this.to.center();for(const s of e)if(pd(t,i,s.look.rect))return!1;return!0},autoRoute(e){switch(this.typeString()){case"PIN-PIN":this.checkLeftRight(),this.lineOfSight(e)?this.fourPointRoute():this.sixPointRoute();break;case"PIN-PAD":this.fourPointRoute();break;case"PAD-PIN":this.fourPointRoute();break;case"PIN-BUS":this.to.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"BUS-PIN":this.from.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"PAD-BUS":this.to.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"BUS-PAD":this.from.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break}},checkLeftRight(){const e=this.from.center(),t=this.to.center();this.from.routes.length==0&&(this.from.is.left&&e.x<t.x||!this.from.is.left&&e.x>t.x)&&this.from.leftRightSwap(),this.to.routes.length==0&&(this.to.is.left&&t.x<e.x||!this.to.is.left&&t.x>e.x)&&this.to.leftRightSwap()},healWire(){this.wire.length==3&&(this.wire[3]=this.wire[2],this.wire[2]=this.wire[1],this.wire[2].y=this.wire[3].y,this.wire[1].y=this.wire[0].y)}},ff={moveSegment(e,t){const i=this.from,s=this.to;let n=this.wire[e-1],o=this.wire[e];if(this.wire.length==2&&(i.is.tack||s.is.tack||i.is.pad||s.is.pad)&&this.makeThreeSegments(n,o),e==1)return i.is.tack||i.is.pad?i.slide(t):null;if(e==this.wire.length-1)return s.is.tack||s.is.pad?s.slide(t):null;n.x==o.x?(n.x+=t.x,o.x+=t.x):(n.y+=t.y,o.y+=t.y)},moveAllPoints(e,t){this.wire.forEach(i=>{i.x+=e,i.y+=t})},removeOnePoint(e,t){let i=t.length-1;for(let s=e;s<i;s++)t[s]=t[s+1];t.length=i},removeTwoPoints(e,t){let i=t.length-2;for(let s=e;s<i;s++)t[s]=t[s+2];t.length=i},endDrag(e){const t=this.wire.length;e==1?(this.from.is.tack||this.from.is.pad)&&this.from.fuseEndSegment():e==2?this.from.is.pin?this.fuseSegmentAfter(e):this.fuseSegmentBefore(e)||this.fuseSegmentAfter(e):e==t-1?(this.to.is.tack||this.to.is.pad)&&this.to.fuseEndSegment():e==t-2?this.to.is.pin?this.fuseSegmentBefore(e):this.fuseSegmentBefore(e)||this.fuseSegmentAfter(e):this.fuseSegmentBefore(e)||this.fuseSegmentAfter(e)},fuseSegmentBefore(e){const t=this.wire;if(e-2<0)return!1;const[i,s,n]=[t[e-2],t[e-1],t[e]],o=g.route.tooClose;if(s.y==n.y){if(Math.abs(i.y-s.y)<o)return n.y=i.y,this.removeTwoPoints(e-2,t),!0}else if(s.x==n.x&&Math.abs(i.x-s.x)<o)return n.x=i.x,this.removeTwoPoints(e-2,t),!0;return!1},fuseSegmentAfter(e){const t=this.wire;if(e+1>t.length-1)return!1;const[i,s,n]=[t[e-1],t[e],t[e+1]],o=g.route.tooClose;if(i.y==s.y){if(Math.abs(n.y-s.y)<o)return i.y=n.y,this.removeTwoPoints(e,t),!0}else if(i.x==s.x&&Math.abs(n.x-s.x)<o)return i.x=n.x,this.removeTwoPoints(e,t),!0;return!1},clampToWidget(e){const t=this.wire,i=this.wire.length,s=e.center();if(i<3)return this.fourPointRoute();this.from==e?(t[0].x=s.x,t[0].y=s.y,t[1].y=s.y):this.to==e&&(t[i-1].x=s.x,t[i-1].y=s.y,t[i-2].y=s.y)},adjust(){const e=this.from,t=this.to;if(!(t!=null&&t.center)||!(e!=null&&e.center))return;const i=e.center(),s=t.center(),n=this.wire[0],o=this.wire.at(-1);if(!n||!o||!s||!i){console.error("*** MISSING ENDPOINTS FOR ROUTE ***",this);return}const r={x:i.x-n.x,y:i.y-n.y},a={x:s.x-o.x,y:s.y-o.y};if(r.x==a.x&&r.y==a.y)return this.moveAllPoints(r.x,r.y);t.is.tack?t.dir=="up"||t.dir=="down"?this.adjustHV(i,s):this.adjustHH(i,s):e.is.tack?e.dir=="up"||e.dir=="down"?this.adjustVH(i,s):this.adjustHH(i,s):this.adjustHH(i,s)},adjustHH(e,t){let i=this.wire;if(i.length<4)return this.makeThreeSegments(e,t);let s=i.length-1;const n=i.length-1,o=g.route.tooClose+5;if(i[0].x!=e.x||i[0].y!=e.y){i[0].x=e.x,i[0].y=e.y,i[1].y=e.y;for(let r=1;r<n;r+=2){const a=i[r].x-i[r-1].x;Math.abs(a)<o&&(i[r].x=a>0?i[r-1].x+o:i[r-1].x-o,i[r+1].x=i[r].x)}}if(i[s].x!=t.x||i[s].y!=t.y){i[s].x=t.x,i[s].y=t.y,i[s-1].y=t.y;for(let r=n;r>1;r-=2){const a=i[r].x-i[r-1].x;Math.abs(a)<o&&(i[r-1].x=a>0?i[r].x-o:i[r].x+o,i[r-2].x=i[r-1].x)}}},adjustHV(e,t){if(this.wire.length==2)return this.makeTwoSegments(e,t);const i=this.wire,s=i.length-1;i[0].x=e.x,i[0].y=e.y,i[1].y=e.y,i[s].x=t.x,i[s].y=t.y,i[s-1].x=t.x,i[s-1].y=i[s-2].y},adjustVH(e,t){if(this.wire.length==2)return this.makeTwoSegments(e,t);const i=this.wire,s=i.length-1;i[0].x=e.x,i[0].y=e.y,i[1].x=e.x,i[s].x=t.x,i[s].y=t.y,i[s-1].x=i[s-2].x,i[s-1].y=t.y},adjustFourPointRoute(e,t){const i=g.route.tooClose,[s,n,o,r]=this.wire;let a=n.x;if(n.x>s.x&&n.x>r.x)n.x-e.x<i?a=e.x+i:n.x-t.x<i&&(a=t.x+i);else if(n.x<s.x&&n.x<r.x)e.x-n.x<i?a=e.x-i:t.x-n.x<i&&(a=t.x-i);else{const l=r.x-s.x,c=t.x-e.x;a=c==0?e.x:l==0?(e.x+t.x)/2:e.x+(n.x-s.x)*c/l}s.x=e.x,s.y=e.y,n.y=e.y,n.x=a,o.x=a,o.y=t.y,r.x=t.x,r.y=t.y},makeTwoSegments(e,t){const i=this.wire;i.length=0,i.push({x:e.x,y:e.y}),i.push({x:t.x,y:e.y}),i.push({x:t.x,y:t.y})},makeThreeSegments(e,t){const i=this.wire;i.length=0,i.push({x:e.x,y:e.y}),i.push({x:(e.x+t.x)/2,y:e.y}),i.push({x:(e.x+t.x)/2,y:t.y}),i.push({x:t.x,y:t.y})}},pf={conxString(e,t){let i=e.is.pin?"PIN":e.is.tack||e.is.bus?"BUS":e.is.pad?"PAD":"";return t&&(i+=t.is.pin?"-PIN":t.is.tack||t.is.bus?"-BUS":t.is.pad?"-PAD":""),i},checkConxType(e,t){switch(this.conxString(e,t)){case"PIN-PIN":return e===t?this.wire.length<3:e.canConnect(t);case"PIN-BUS":return!t.findTack(e);case"BUS-PIN":return!e.bus.findTack(t);case"PIN-PAD":return t.canConnect(e);case"PAD-PIN":return e.canConnect(t);case"BUS-PAD":return!1;case"PAD-BUS":return!t.findTack(e);case"BUS-BUS":return!1;case"PAD-PAD":return!1;default:return!1}},connect(e){if(!this.checkConxType(this.from,e))return!1;switch(this.conxString(this.from,e)){case"PIN-PIN":return this.to=e,e.routes.push(this),this.rxtxPinPin(),!0;case"PIN-PAD":return this.to=e,e.routes.push(this),this.rxtxPinPad(),!0;case"PAD-PIN":return this.to=e,e.routes.push(this),this.rxtxPinPad(),!0;case"PIN-BUS":return e.addTack(this),this.rxtxPinBus(),!0;case"BUS-PIN":return this.to=e,e.routes.push(this),this.rxtxPinBus(),!0;case"BUS-PAD":return this.to=e,e.routes.push(this),this.rxtxPadBus(),!0;case"PAD-BUS":return e.addTack(this),this.rxtxPadBus(),!0;case"PAD-PAD":return!1;case"BUS-BUS":return!1;default:return!1}},disconnect(){let e=this.conxString(this.from,this.to);switch(e){case"PIN-PIN":this.rxtxPinPinDisconnect();break;case"PIN-PAD":case"PAD-PIN":this.rxtxPinPadDisconnect();break;case"PIN-BUS":case"BUS-PIN":this.rxtxPinBusDisconnect();break;case"PAD-BUS":case"BUS-PAD":this.rxtxPadBusDisconnect();break;default:console.error("Impossible combination in route.disconnect:",e);break}this.remove()},reconnect(){if(this.from.is.pin){if(this.from.routes.includes(this))return;this.from.routes.push(this)}else if(this.from.is.pad){if(this.from.routes.includes(this))return;this.from.routes.push(this)}else if(this.from.is.tack){if(this.from.bus.tacks.includes(this.from))return;this.from.bus.tacks.push(this.from)}const e=this.to.is.tack?this.to.bus:this.to;this.to=null,this.connect(e)},connectFromClone(e){this.wire=e.wire,this.from=e.from,this.from.routes.push(this);const t=e.to.is.tack?e.to.bus:e.to;this.connect(t)}},gf={arrow(e,t){if(t.is.pin)return{right:t.is.input,left:!t.is.input};if(t.is.pad)return{right:!t.proxy.is.input,left:t.proxy.is.input};if(t.is.bus)return e.is.pin?{right:!e.is.input,left:e.is.input}:{right:e.proxy.is.input,left:!e.proxy.is.input}},rxtxPinPin(){var o,r;const e=[],t=[],i=this.arrow(this.from,this.to),s=i.right?this.from:this.to,n=i.right?this.to:this.from;n.is.proxy||s.is.proxy?(s.is.proxy?(o=s.pad)==null||o.makeConxList(e):e.push(s),n.is.proxy?(r=n.pad)==null||r.makeConxList(t):t.push(n),this.fullConnect(e,t)):this.singleConnect(s,n)},rxtxPinPad(){var o,r;const e=[],t=[],[i,s]=this.from.is.pin?[this.from,this.to]:[this.to,this.from];i.is.channel&&(s.proxy.is.channel=!0);const n=this.arrow(i,s);n.right&&(i.is.proxy?(o=i.pad)==null||o.makeConxList(e):e.push(i),s.proxy.makeConxList(t),this.fullConnect(e,t)),n.left&&(s.proxy.makeConxList(e),i.is.proxy?(r=i.pad)==null||r.makeConxList(t):t.push(i),this.fullConnect(e,t))},rxtxPinBus(){var o,r;const e=[],t=[],[i,s]=this.from.is.pin?[this.from,this.to]:[this.to,this.from],n=this.arrow(i,s.bus);n.right&&(i.is.proxy?(o=i.pad)==null||o.makeConxList(t):t.push(i),s.bus.hasFilter()?(s.bus.rxtxAddRxTack(s),this.fullConnect(t,[s])):(s.bus.makeConxList(i,e),this.fullConnect(t,e))),n.left&&(i.is.proxy?(r=i.pad)==null||r.makeConxList(e):e.push(i),s.bus.hasFilter()?s.bus.rxtxAddTxTack(s,e):(s.bus.makeConxList(i,t),this.fullConnect(t,e)))},rxtxPadBus(){const e=[],t=[],[i,s]=this.from.is.pad?[this.from,this.to]:[this.to,this.from],n=this.arrow(i,s.bus);n.right&&(i.proxy.makeConxList(t),s.bus.hasFilter()?(s.bus.rxtxAddRxTack(s),this.fullConnect(t,[s])):(s.bus.makeConxList(i,e),this.fullConnect(t,e))),n.left&&(i.proxy.makeConxList(e),s.bus.hasFilter()?s.bus.rxtxAddTxTack(s,e):(s.bus.makeConxList(i,t),this.fullConnect(t,e)))},rxtxPinPinDisconnect(){var o,r;const e=[],t=[],i=this.arrow(this.from,this.to),s=i.right?this.from:this.to,n=i.right?this.to:this.from;s.is.proxy||n.is.proxy?(s.is.proxy?(o=s.pad)==null||o.makeConxList(e):e.push(s),n.is.proxy?(r=n.pad)==null||r.makeConxList(t):t.push(n),this.fullDisconnect(e,t)):s.node.rxtxRemoveFromTxTable(s,n)},rxtxPinPadDisconnect(){var o,r;const e=[],t=[],[i,s]=this.from.is.pin?[this.from,this.to]:[this.to,this.from];if(s.proxy.is.channel){const a=s.routes.find(l=>{if(l!=this){const c=l.from==s?l.to:l.from;if(c.is.pin&&c.is.channel||c.is.pad&&c.proxy.is.channel)return!0}});s.proxy.is.channel=!!a}const n=this.arrow(i,s);n.right&&(i.is.proxy?(o=i.pad)==null||o.makeConxList(e):e.push(i),s.proxy.makeConxList(t),this.fullDisconnect(e,t)),n.left&&(s.proxy.makeConxList(e),i.is.proxy?(r=i.pad)==null||r.makeConxList(t):t.push(i),this.fullDisconnect(e,t))},rxtxPinBusDisconnect(){var o,r;const e=[],t=[],[i,s]=this.from.is.pin?[this.from,this.to]:[this.to,this.from],n=this.arrow(i,s.bus);n.right&&(i.is.proxy?(o=i.pad)==null||o.makeConxList(t):t.push(i),s.bus.hasFilter()?(s.bus.rxtxRemoveRxTack(s),this.fullDisconnect(t,[s])):(s.bus.makeConxList(i,e),this.fullDisconnect(t,e))),n.left&&(s.bus.hasFilter()?s.bus.rxtxRemoveTxTack(s):(s.bus.makeConxList(i,t),i.is.proxy?(r=i.pad)==null||r.makeConxList(e):e.push(i),this.fullDisconnect(t,e)))},rxtxPadBusDisconnect(){const e=[],t=[],[i,s]=this.from.is.pad?[this.from,this.to]:[this.to,this.from],n=this.arrow(i,s.bus);n.right&&(i.proxy.makeConxList(t),s.bus.hasFilter()?(s.bus.rxtxRemoveRxTack(s),this.fullDisconnect(t,[s])):(bus.makeConxList(i,e),this.fullDisconnect(t,e))),n.left&&(s.bus.hasFilter()?s.bus.rxtxRemoveTxTack(s):(s.bus.makeConxList(i,t),i.proxy.makeConxList(e),this.fullDisconnect(t,e)))},singleConnect(e,t){let i=e.node.txTable.find(s=>s.pin.name==e.name);i&&((e.is.multi||t.is.multi)&&!t.hasMultiOverlap(e)||i.targets.push(t))},fullConnect(e,t){for(const i of e)if(i.is.pin){const s=i.node.txTable.find(n=>n.pin.name==i.name);if(!s){console.warn("*** SHOULD NOT HAPPEN *** Could not find txRecord in fullConnect",i.name,i.node.name);continue}for(const n of t)(!(i.is.multi||n.is.multi)||n.hasMultiOverlap(i))&&s.targets.push(n)}else if(i.is.tack){const s=i.bus.txTable.find(n=>n.tack==i);if(!s){console.warn("*** SHOULD NOT HAPPEN *** Could not find txTack in fullConnect",i.bus.name);continue}for(const n of t)s.fanout.push(n)}},fullDisconnect(e,t){for(const i of e)if(i.is.pin){const s=i.node.txTable.find(n=>n.pin.name==i.name);if(!s){console.warning("*** SHOULD NOT HAPPEN *** Could not find txRecord in fullDisconnect",i.name,i.node.name);continue}for(const n of t)s.dropTarget(n)}else if(i.is.tack){const s=i.bus.txTable.find(n=>n.tack==i);if(!s){console.warning("*** SHOULD NOT HAPPEN *** Could not find txTack in fullDisconnect",i.bus.name);continue}for(const n of t)s.dropTarget(n)}}};function xt(e,t){this.from=e,this.to=t,this.is={selected:!1,highLighted:!1,twistedPair:!1,notUsed:!1,newConx:!1,noConx:!1},this.wire=[]}xt.prototype={render(e){if(this.wire.length<2)return;const t=this.is.selected?g.route.cSelected:this.is.highLighted?g.route.cHighLighted:this.is.newConx?g.route.cAdded:this.is.noConx?g.route.cDeleted:this.is.notUsed?g.route.cNotUsed:g.route.cNormal,i=this.is.selected?g.route.wSelected:g.route.wNormal;this.is.twistedPair?H.twistedPair(e,t,i,this.wire):H.drawWire(e,t,i,this.wire)},reverse(){[this.from,this.to]=[this.to,this.from];let e=this.wire,t=e.length;for(let i=0;i<t/2;i++)[e[i],e[t-i-1]]=[e[t-i-1],e[i]]},select(){this.is.selected=!0,this.from&&(this.from.is.selected=!0),this.to&&(this.to.is.selected=!0)},unSelect(){this.is.selected=!1,this.from&&(this.from.is.selected=!1),this.to&&(this.to.is.selected=!1)},highLight(){this.is.highLighted=!0,this.from&&(this.from.is.highLighted=!0),this.to&&(this.to.is.highLighted=!0)},unHighLight(){var e,t,i,s;((t=(e=this.from)==null?void 0:e.node)!=null&&t.is.highLighted||(s=(i=this.to)==null?void 0:i.node)!=null&&s.is.highLighted)&&this.from.node!=this.to.node||(this.is.highLighted=!1,this.from&&(this.from.is.highLighted=!1),this.to&&(this.to.is.highLighted=!1))},setTwistedPair(){this.is.twistedPair=!0},checkTwistedPair(){var t;const e=this.from.is.input?this.to:this.from;e&&(e.is.pin&&e.is.multi?this.is.twistedPair=!0:e.is.pad&&((t=e.proxy)!=null&&t.is.multi)&&(this.is.twistedPair=!0))},typeString(){const e=this.from.is,t=this.to.is;let i=e.pin?"PIN":e.tack?"BUS":e.pad?"PAD":"";return i+=t.pin?"-PIN":t.tack?"-BUS":t.pad?"-PAD":"",i},hitSegment(e){const t=this.wire.length-1,i=e.x,s=e.y,n=5;for(let o=0;o<t;o++){const r=this.wire[o],a=this.wire[o+1];if(r.y==a.y){if(s<r.y+n&&s>r.y-n&&(r.x-i)*(a.x-i)<=0)return o+1}else if(i<r.x+n&&i>r.x-n&&(r.y-s)*(a.y-s)<=0)return o+1}return 0},remove(){this.from.removeRoute(this),this.to.removeRoute(this)},popFromRoute(){this.from.is.tack?this.from.bus.tacks.pop():this.from.routes.pop()},clone(){let e=new xt(this.from,this.to);for(const t of this.wire)e.wire.push({...t});return e},restore(){},copyWire(){const e=[];for(const t of this.wire)e.push({...t});return e},restoreWire(e){this.wire=[];for(const t of e)this.wire.push({...t})},messageFlow(){const e=this.from,t=this.to;return e.is.pin?e.is.input?[t,e]:[e,t]:t.is.pin?t.is.input?[e,t]:[t,e]:e.is.pad?e.proxy.is.input?[e,t]:[t,e]:t.is.pad?t.proxy.is.input?[t,e]:[e,t]:[t,e]}};Object.assign(xt.prototype,uf,ff,pf,gf);const mf={pinNameCheck(e,t){if(this.is.cable){if(e.is.multi||t.is.multi){if(!e.hasFullNameMatch(t))return!1}else if(e.name!=t.name)return!1}else if((e.is.multi||t.is.multi)&&!e.hasMultiOverlap(t))return!1;return!0},areConnected(e,t){if(e.is.pin){if(t.is.pin)return e.is.input==t.is.input||e.node==t.node?!1:this.pinNameCheck(e,t);if(t.is.pad)return e.is.input!=t.proxy.is.input?!1:this.pinNameCheck(e,t.proxy)}else if(e.is.pad){if(t.is.pin)return e.proxy.is.input!=t.is.input?!1:this.pinNameCheck(e.proxy,t);if(t.is.pad)return e.proxy.is.input==t.proxy.is.input?!1:this.pinNameCheck(e.proxy,t.proxy)}return console.log(e,t),!1},disconnect(){const e=this.tacks.slice();for(const t of e)(t.route.from==t?t.route.to:t.route.from).is.pin?t.route.rxtxPinBusDisconnect():t.route.rxtxPadBusDisconnect(),t.route.remove()},reconnect(e){for(const t of e){this.tacks.push(t),t.orient();const i=t.route.to==t?t.route.from:t.route.to;i.routes.push(t.route),i.is.pin?t.route.rxtxPinBus():t.route.rxtxPadBus()}},makeConxList(e,t){var i,s;for(const n of this.tacks){if(!((i=n.route)!=null&&i.from)||!((s=n.route)!=null&&s.to))continue;const o=n.route.from==n?n.route.to:n.route.from;this.areConnected(e,o)&&(o.is.pin?o.is.proxy?o.pad.makeConxList(t):t.push(o):o.is.pad&&o.proxy.makeConxList(t))}},splitTacks(e,t){this.tacks.forEach((i,s)=>{i.route.from.is.pin&&t.nodes.includes(i.route.from.node)&&(e.tacks.push(i),this.tacks[s]=null,i.bus=e)}),this.tacks=this.tacks.filter(i=>i!=null)},transferTacks(e){for(const t of this.tacks)for(const i of e)if(this.uid==i.uid){t.bus=i;break}},makeRoute(e){const t=md(this.wire,e.center()),i=t.endPoint?vd(t.point,t.segment,this.wire):t.point,s=new ms(this);s.placeOnSegment(i,t.segment);const n=new xt(e,s);n.builder(),e.routes.push(n),s.restore(n)},rxtxPrepareTables(){},rxtxResetTables(){this.txTable=[],this.rxTable=[]},rxtxBuildRxTxTable(){for(const e of this.tacks)if(e.incoming())this.rxtxAddRxTack(e);else{const t=[],i=e.getOther();i.is.proxy?i.pad.makeConxList(t):i.is.pad?i.proxy.makeConxList(t):t.push(i),this.rxtxAddTxTack(e,t)}},rxtxAddTxTack(e,t){const i=new oa(e);i.fanout=t.slice(),this.txTable.push(i)},rxtxRemoveTxTack(e){const t=this.txTable.findIndex(i=>i.tack==e);t>-1&&this.txTable.splice(t,1)},rxtxAddRxTack(e){this.rxTable.push(new Td(e))},rxtxRemoveRxTack(e){const t=this.rxTable.findIndex(i=>i.tack==e);t>-1&&this.rxTable.splice(t,1)}},vf={toJSON(){const e=this.is.cable?{kind:"cable",name:this.name}:{kind:"busbar",name:this.name};return this.is.filter&&this.filter&&(e.filter=this.filter),e.start=k.pointToString(this.wire[0]),e.wire=k.wireToString(this.wire),e},cook(e,t){if(this.is.cable=e.kind=="cable",this.name=e.name,e.filter){const i=t.getMainModel(),s=t.getCurrentModel();this.filter=new Ki(e.filter.function),this.is.filter=!0,e.filter.path&&(this.filter.arl=s.arl.resolve(e.filter.path),i!=s&&this.filter.arl.makeRelative(i.arl))}this.wire=k.stringToWire(k.stringToPoint(e.start),null,e.wire),this.wire.length==1&&this.wire.push(this.wire[0]),this.startLabel.place(),this.endLabel.place()}},wf={drawXY(e){const t=this.wire.length,i=this.wire[t-2],s=this.wire[t-1],n=this.is.cable?g.bus.wCable:g.bus.wBusbar,o=this.endLabel.rect.h;let r=null;const a=s.x==i.x,l=s.y==i.y;a&&l?Math.abs(e.x-i.x)<Math.abs(e.y-i.y)?s.y=e.y:s.x=e.x:l?Math.abs(e.y-s.y)>g.bus.split?this.wire.push({x:s.x,y:e.y}):(this.tacks.length&&(r=this.getLimit(t-1))&&(i.x<s.x&&e.x<r.r+n/2&&(e.x=r.r+n/2),i.x>s.x&&e.x>r.l-n/2&&(e.x=r.l-n/2)),s.x=e.x,t>2&&Math.abs(s.x-i.x)<g.bus.tooClose&&this.wire.pop()):a&&(Math.abs(e.x-s.x)>g.bus.split?this.wire.push({x:e.x,y:s.y}):(this.tacks.length&&(r=this.getLimit(t-1))&&(i.y<s.y&&e.y<r.b&&(e.y=r.b),i.y>s.y&&e.y>r.t-o/2&&(e.y=r.t-o/2)),s.y=e.y,t>2&&Math.abs(s.y-i.y)<g.bus.tooClose&&this.wire.pop())),this.startLabel.place(),this.endLabel.place()},resumeDrawXY(e,t,i){e==this.startLabel&&this.reverse();const s=this.wire,n=s[s.length-2],o=s[s.length-1];let r=n.x==o.x&&Math.abs(t.x-n.x)>g.bus.split?t.x:o.x+i.x,a=n.y==o.y&&Math.abs(t.y-n.y)>g.bus.split?t.y:o.y+i.y;this.drawXY({x:r,y:a})},reverse(){[this.startLabel,this.endLabel]=[this.endLabel,this.startLabel];const e=this.wire,t=e.length;for(let i=0;i<t/2;i++)[e[i],e[t-i-1]]=[e[t-i-1],e[i]];this.tacks.forEach(i=>i.segment=t-i.segment)},getLimit(e){let t=null;return this.tacks.forEach(i=>{if(i.segment==e){const s=i.rect;t?(s.x<t.l&&(t.l=s.x),s.x+s.w>t.r&&(t.r=s.x+s.w),s.y<t.t&&(t.t=s.y),s.y+s.h>t.b&&(t.b=s.y+s.h)):t={l:s.x,r:s.x+s.w,t:s.y,b:s.y+s.h}}}),t},move(e,t){for(const i of this.wire)i.x+=e,i.y+=t;this.startLabel.move(e,t),this.endLabel.move(e,t);for(const i of this.tacks)i.rect.x+=e,i.rect.y+=t},drag(e){for(const t of this.wire)t.x+=e.x,t.y+=e.y;this.startLabel.move(e.x,e.y),this.endLabel.move(e.x,e.y);for(const t of this.tacks)t.moveXY(e.x,e.y)},moveRoutes(e,t){this.tacks.forEach(i=>{i.is.tack&&i.route.from==i&&i.route.moveAllPoints(e,t)})},getCombinedLimit(e,t){let i=this.getLimit(e),s=this.getLimit(t);return i&&s&&(s.l<i.l&&(i.l=s.l),s.r>i.r&&(i.r=s.r),s.t<i.t&&(i.t=s.t),s.b>i.b&&(i.b=s.b)),i||s},moveSegment(e,t){let i=this.wire;const s=t.x,n=t.y;let o=this.getCombinedLimit(e-1,e+1),r=i[e-1],a=i[e];if(r.y==a.y){if(o==null||r.y>o.b&&r.y+n>o.b||r.y<o.t&&r.y+n<o.t){r.y+=n,a.y+=n;for(const l of this.tacks)l.segment==e&&l.moveY(n)}}else if(r.x==a.x&&(o==null||r.x>o.r&&r.x+s>o.r||r.x<o.l&&r.x+s<o.l)){r.x+=s,a.x+=s;for(const l of this.tacks)l.segment==e&&l.moveX(s)}e==1&&this.startLabel.place(),e==i.length-1&&this.endLabel.place()},placeTacks(e,t,i){for(const s of this.tacks)s.orient()},removeTwoPoints(e){const t=this.wire,i=t.length;for(let s=e;s<i-2;s++)t[s]=t[s+2];t.pop(),t.pop(),this.tacks.forEach(s=>{s.segment>e&&(s.segment-=2)})},fuseSegment(e){let t=this.wire;if(t.length<3)return;const i=g.bus.tooClose;t[e-1].y==t[e].y?e<t.length-2&&Math.abs(t[e+1].y-t[e].y)<i?(t[e-1].y=t[e+1].y,this.removeTwoPoints(e)):e>1&&Math.abs(t[e-2].y-t[e-1].y)<i&&(t[e].y=t[e-2].y,this.removeTwoPoints(e-2)):t[e-1].x==t[e].x&&(e<t.length-2&&Math.abs(t[e+1].x-t[e].x)<i?(t[e-1].x=t[e+1].x,this.removeTwoPoints(e)):e>1&&Math.abs(t[e-2].x-t[e-1].x)<i&&(t[e].x=t[e-2].x,this.removeTwoPoints(e-2))),this.startLabel.place(),this.endLabel.place()},adjustRoutes(){for(const e of this.tacks)e.route.adjust()},closestTack(e){},straightConnections(){for(const e of this.tacks){const t=e.route,i=t.to==e?t.from:t.to;let s=this.wire[e.segment-1],n=this.wire[e.segment];if(s.x==n.x&&([s,n]=s.y>n.y?[n,s]:[s,n],i.rect.y>s.y&&i.rect.y<n.y)){e.rect.y=i.rect.y+i.rect.h/2-e.rect.h/2;for(const o of t.wire)o.y=i.rect.y+i.rect.h/2}}}};function Ps(e,t,i=null){this.uid=i,this.name=e??"",this.widGenerator=0,this.is={bus:!0,selected:!1,hoverOk:!1,hoverNok:!1,highLighted:!1,cable:!1,filter:!1},this.filter=null,this.rxTable=[],this.txTable=[],this.wire=[],this.wire.push({x:t.x,y:t.y}),this.wire.push({x:t.x,y:t.y});const s=g.bus.hLabel,n=0;this.startLabel=new Un({x:0,y:0,w:n,h:s},this),this.endLabel=new Un({x:0,y:0,w:n,h:s},this),this.startLabel.place(),this.endLabel.place(),this.tacks=[]}Ps.prototype={render(e){if(this.wire.length<2)return;const t=g.bus,i=this.is.hoverNok?t.cBad:this.is.selected||this.is.hoverOk?t.cSelected:this.is.highLighted?t.cHighLighted:t.cNormal;this.is.cable?H.drawCable(e,this.wire,i,t.wCable):H.drawBusbar(e,this.wire,i,t.wBusbar),this.startLabel.render(e),this.endLabel.render(e),this.tacks.forEach(s=>s.render(e))},generateWid(){return++this.widGenerator},highLight(){this.is.highLighted=!0,this.startLabel.highLight(),this.endLabel.highLight();for(const e of this.tacks)e.route.highLight()},unHighLight(){this.is.highLighted=!1,this.startLabel.unHighLight(),this.endLabel.unHighLight();for(const e of this.tacks)e.route.unHighLight()},highLightRoutes(e){this.is.highLighted=!0;for(const t of this.tacks){const i=t.route.from==t?t.route.to:t.route.from;i!==e&&this.areConnected(e,i)&&t.route.highLight()}},unHighLightRoutes(e){this.is.highLighted=!1;for(const t of this.tacks){const i=t.route.from==t?t.route.to:t.route.from;i!==e&&this.areConnected(e,i)&&t.route.unHighLight()}},hitTest(e){let t=rt(e,this.startLabel.rect)?this.startLabel:rt(e,this.endLabel.rect)?this.endLabel:null;if(t)return[F.busLabel,this,t,null,0];let i=this.hitSegment(e);if(i)return[F.busSegment,this,null,null,i];for(const s of this.tacks)if(rt(e,s.rect))return[F.tack,this,null,s,0];return[F.nothing,null,null,null,0]},hitSegment(e){const t=this.wire.length,i=e.x,s=e.y;for(let n=0;n<t-1;n++){const o=this.wire[n],r=this.wire[n+1],a=5;if(o.y==r.y){if(s>o.y-a&&s<o.y+a&&(i>=o.x&&i<=r.x||i>=r.x&&i<=o.x))return n+1}else if(i>o.x-a&&i<o.x+a&&(s>=o.y&&s<=r.y||s>=r.y&&s<=o.y))return n+1}return 0},singleSegment(){return this.wire.length===2},hitRoute(e){let t=0;for(const i of this.tacks)if(i.route.from==i&&(t=i.route.hitSegment(e)))return[F.route,i.route,t];return[F.nothing,null,0]},overlap(e){var t;return((t=fd(this.wire,e))==null?void 0:t.length)>0},findTack(e){return this.tacks.find(t=>t.route.from==e||t.route.to==e)},removeTack(e){Ne(this.tacks,e)},addTack(e){const t=e.to==null?e.from:e.to;if(this.findTack(t))return null;const i=new ms(this);return i.setRoute(e),this.tacks.push(i),i},newTack(){const e=new ms(this);return this.tacks.push(e),e},copy(){const e=new Ps(this.name,this.wire[0],this.uid);return e.is.cable=this.is.cable,e.wire=this.copyWire(),e.startLabel.place(),e.endLabel.place(),e},copyTacks(e,t){for(const i of this.tacks){const s=i.route.clone(),n=new ms(e);s.to.is.tack?s.to=n:s.from=n,n.setRoute(s);const o=s.to.is.tack?s.from:s.to;if(o.is.pin){const a=t.nodes.find(l=>l.uid==o.node.uid).look.findPin(o.name,o.is.input);s.to.is.tack?s.from=a:s.to=a,a.routes.push(s)}else if(o.is.pad){const r=t.pads.find(a=>a.proxy.name==o.proxy.name);s.to.is.tack?s.from=r:s.to=r,r.routes.push(s)}e.tacks.push(n)}},copyWire(){const e=[];for(const t of this.wire)e.push({...t});return e},restoreWire(e){this.wire=[];for(const t of e)this.wire.push({...t})},copyTackWires(){const e=[];for(const t of this.tacks){const i=t.route.copyWire();e.push({segment:t.segment,track:i})}return e},restoreTackWires(e){const t=this.tacks,i=t.length;for(let s=0;s<i;s++)t[s].segment=e[s].segment,t[s].route.restoreWire(e[s].track)},hasFilter(){return this.is.filter},getFilterArl(e,t,i){var s;return(s=t==null?void 0:t.model)!=null&&s.is.lib?t.model.arl:e?e.arl:this.filter.arl?this.filter.arl:t!=null&&t.model?t.model.arl.resolve("index.js"):i},getFilter(e,t,i){const s=this.getFilterArl(t,i,e[0].arl),n=this.filter.duplicate(e,s)?`${this.filter.fName} as ${this.filter.alias}`:this.filter.fName,o=e.find(r=>r.arl.equals(s));o?o.items.find(a=>a==n)||o.items.push(n):e.push({arl:s,items:[n]})}};Object.assign(Ps.prototype,mf,vf,wf);function pa(){this.map=new Map}pa.prototype={reset(){this.map.clear()},size(){return this.map.size},addRawFactories(e){for(const t of e.raw.factories){const i=e.arl.resolve(t),s=i.getFullPath();if(this.map.has(s))continue;const n=new Ki;n.arl=i,this.map.set(s,n)}},add(e){const t=e.arl.getFullPath();if(!this.map.get(t))return this.map.set(t,e),this},toJSON(){const e=[];for(const t of this.map.values())e.push(t.arl.userPath);return e}};const yf={async getRoot(e){return await this.getFactoriesAndModels(e),this.compileNode(e,null)},encode(e,t){var n,o,r;if(!e)return null;e.collectFactories(this.factories),e.collectModels(this.models);const i={header:t.header};return((n=this.models)==null?void 0:n.size())>0&&(i.imports=this.models),((o=this.factories)==null?void 0:o.size())>0&&(i.factories=this.factories),((r=t.libraries)==null?void 0:r.size())>0&&(i.libraries=t.libraries),i.root=e,JSON.stringify(i,null,4)},compileNode(e,t){var n;if(!e)return console.log(`No model for node '${t}' `),null;const i=t?e.findRawNode(t):(n=e.raw)==null?void 0:n.root;if(!i)return console.log(`Node '${t}' not found in model ${e.arl.userPath}`),null;if(!this.pushCurrentNode(e,i))return console.log(`infinite loop for  '${t}' in model ${e.arl.userPath} `),null;const s=i.kind=="dock"?this.linkedNode(i):this.localNode(i);return this.popCurrentNode(),s},localNode(e){const t=e.kind=="source"?new xi(null,e.name):new Dt(null,e.name);return t.cook(e,this),t.setUIDS(this.UID),t},linkedNode(e){const[t,i]=[e.link.path,e.link.node],s=this.getCurrentModel(),n=t==null||t==="./"?s:this.models.get(s.arl.resolve(t).getFullPath()),o=this.compileNode(n,i),r=o?this.goodLink(e,i,n,o):this.badLink(e,i,n);return r.setUIDS(this.UID),r},goodLink(e,t,i,s){const n=s.is.source?new xi(null,e.name):new Dt(null,e.name);return n.cook(e,this),n.setLink(i,t),n.fuse(s),n},badLink(e,t,i){const s=new xi(null,e.name);return s.cook(e,this),s.setLink(i,t),s.linkIsBad(),s},updateNode(e){if(!(e.link&&e.link.is.bad)){if(e.link&&e.link.model.is.fresh){const t=this.compileNode(e.link.model,e.link.lName);if(!t){e.linkIsBad();return}if(!e.compatible(t)){const i=e.switchNodeType();this.view.root.swap(e,i),e=i}e.fuse(t),e.rxtxBuildTxTable();return}if(e.nodes)for(const t of e.nodes)this.updateNode(t)}}};function Si(e){this.models=new no,this.factories=new pa,this.stack=[],this.UID=e}Si.prototype={reset(){this.factories.reset(),this.models.reset(),this.stack.length=0},resetFresh(){for(const e of this.models.map.values())e.is.fresh=!1},pushCurrentNode(e,t){const i=t.source??t.group??t.dock,s=this.stack.length;if(s>1){for(let n=0;n<s-1;n++)if(this.stack[n].nodeName===i&&this.stack[n].model===e)return console.log(i,e.arl.userPath),!1}return this.stack.push({model:e,nodeName:i}),!0},popCurrentNode(){this.stack.pop()},getCurrentModel(){return this.stack.at(-1).model},getMainModel(){return this.stack[0].model},async getFactoriesAndModels(e){var t,i;if(!this.models.contains(e.arl)&&(this.models.add(e),!(!e.raw&&!await e.getRaw())&&e.is.blu)){if(((t=e.raw.factories)==null?void 0:t.length)>0&&this.factories.addRawFactories(e),e.is.main&&e.raw.libraries&&e.addRawLibraries(e.arl,e.raw.libraries),!(((i=e.raw.imports)==null?void 0:i.length)>0))return;const s=this.models.newModels(e.arl,e.raw.imports);if(s.length>0){const n=[];for(const o of s)n.push(this.getFactoriesAndModels(o));await Promise.all(n)}}},async findOrAddModel(e){let t=this.models.findArl(e);return t||(t=new Mt(e),t.makeKey(),await this.getFactoriesAndModels(t),t)},async updateFactoriesAndModels(){const e=this.models.valuesArray();this.models.reset();const t=[];for(const i of e){if(i.is.main||this.models.contains(i.arl))continue;const s=i.header.utc;await i.getRaw(),i.raw&&(s!==i.header.utc?(console.log(`-SYNC- newer version of '${i.arl.userPath}'`),t.push(this.getFactoriesAndModels(i))):(this.models.add(i),i.is.fresh=!1))}await Promise.all(t)}};Object.assign(Si.prototype,yf);function ga(e,t){this.tx=e,this.ref=null,this.libraries=null}ga.prototype={onSwitchLibrary({ref:e,libraries:t}){!t||!e||(this.ref=e,this.libraries=t,this.tx.send("build table",this.libraries.map))},async onAddFile(e){if(!this.ref)return;const t=this.ref.resolve(e);if(!t)return console.log(`Could not resolve "${e}" to arl`);let i=this.libraries.findArl(t);i||(i=new Mt(t),await i.getRaw(),this.libraries.add(i)),i.setSelectable(),this.tx.send("build table",this.libraries.map)},onRemoveFile({model:e}){e&&(e.is.selectable=!1,this.tx.send("build table",this.libraries.map))}};function ma(e,t){this.tx=e,this.local=!1,this.origin=null,this.selection=null,this.copyCount=0}ma.prototype={resetContent(){this.local=!1,this.origin=null,this.selection=null,this.copyCount=0},sends:["switch","remote","local"],onSet({model:e,selection:t}){!e||!t||(this.resetContent(),this.local=!0,this.origin=e.copy(),this.selection=t.shallowCopy(),this.tx.send("switch"))},onGet(e){if(this.local){this.tx.reply(this);return}this.tx.request("remote").then(async({json:t})=>{const i=JSON.parse(t);i&&(await this.cook(i,e.savecom),this.tx.reply(this))})},onSwitched(){this.local=!1},onLocal(e){if(!this.local){console.log("Warning: clipboard is not local !");return}const t={origin:this.origin.arl.getFullPath(),header:this.origin.header,what:this.selection.what,rect:this.selection.rect?k.rectToString(this.selection.rect):null,viewPath:this.selection.viewPath,imports:null,factories:null,root:null,widgets:null};switch(this.selection.what){case $.pinArea:t.widgets=this.selection.widgets;break;case $.freeRect:case $.multiNode:case $.singleNode:{const s=e.savecom;s.reset(),t.root=new Dt(null,"clipboard",null),t.root.nodes=this.selection.nodes.slice(),t.root.buses=this.selection.buses.slice(),t.root.pads=this.selection.pads.slice(),t.root.collectFactories(s.factories),t.factories=s.factories,t.root.collectModels(s.models),t.imports=s.models}break;default:console.log(`unrecognized ${this.what} in clipboard.js`);break}const i=JSON.stringify(t,null,4);this.tx.reply({json:i})},async cook(e,t){var s,n,o;if(!e.origin)return!1;this.resetContent();const i=new Qt().absolute(e.origin);switch(this.origin=new Mt(i),this.origin.raw=e,e.header&&this.origin.header.cook(i,e.header),this.selection=new _s,this.selection.viewPath=e.viewPath,e.rect&&(this.selection.rect=k.stringToRect(e.rect)),this.selection.what=+e.what,this.selection.what){case $.freeRect:case $.multiNode:case $.singleNode:{t.reset();const r=await t.getRoot(this.origin);if(!r)return!1;this.selection.nodes=(s=r.nodes)==null?void 0:s.slice(),this.selection.pads=(n=r.pads)==null?void 0:n.slice(),this.selection.buses=(o=r.buses)==null?void 0:o.slice()}return!0;case $.pinArea:{const r=new yt({x:0,y:0,w:0,h:0}),a=new Dt(r);for(const l of e.widgets){const c=r.cookWidget(a,l);c&&this.selection.widgets.push(c)}}return!0;default:return!1}}};const xf={onSetDocument(e){if(!e){this.doc=null,this.redraw();return}e.view.noRect()&&e.view.setRect(0,0,this.canvas.width,this.canvas.height),this.doc=e,this.tx.send("change library",{ref:e.model.arl,libraries:e.model.libraries}),this.setStyle(),this.redraw()},onGetDocument(){this.tx.send("reply document",this.doc)},onShowSettings(){var s,n;if(!((s=this.doc)!=null&&s.model))return;const e=this.doc.model.header,t=()=>this.redraw(),i=e.style.rgb;this.tx.send("document settings",{title:"Document Settings",path:((n=this.doc.model.arl)==null?void 0:n.getFullPath())??"- unspecified -",settings:e,pos:{x:25,y:25},onColor(o){e.style.adapt(o),t()},ok(o){e.runtime=o},cancel(){e.style.adapt(i),t()}})},onSyncModel(){var e;(e=this.doc)==null||e.update().then(()=>{this.redraw()})},onRecalibrate(){var e;(e=this.doc)==null||e.view.toggleTransform(),this.redraw()},onGridOnOff(){var t,i;const e=(i=(t=this.doc)==null?void 0:t.view)==null?void 0:i.state;e&&(e.grid=!e.grid),this.redraw()},onAcceptChanges(){this.doc&&(this.doc.view.root.acceptChanges(),this.redraw())},onSizeChange(e){var t,i;e&&(this.canvas.width=e.w,this.canvas.height=e.h,this.canvas.style.width=e.w+"px",this.canvas.style.height=e.h+"px",this.ctx=this.canvas.getContext("2d"),this.setStyle(),this.doc&&((t=this.doc.view)==null||t.setRect(0,0,e.w,e.h),(i=this.doc.view)==null||i.redoBigRecursive()),this.redraw())},onMakeLib(e){var n,o;const t=this.doc;if(!((n=t==null?void 0:t.view)!=null&&n.root))return;const i={x:e.screenX,y:e.screenY},s=((o=t.target.library)==null?void 0:o.userPath)??Vs(t.model.arl.userPath)+"-lib.js";this.tx.send("show lib path",{title:"Make library build file...",entry:s,pos:i,ok:r=>t.toJavascriptLib(r),cancel:()=>{}})},onMakeApp(e){var n,o;const t=this.doc;if(!((n=t==null?void 0:t.view)!=null&&n.root))return;const i={x:e.screenX,y:e.screenY},s=((o=t.target.library)==null?void 0:o.userPath)??Vs(t.model.arl.userPath)+".app.js";this.tx.send("show app path",{title:"Make application...",path:s,pos:i,ok:r=>t.toJavascriptApp(r),cancel:()=>{}})},onRunApp(){const e=this.doc.toJavascriptApp(null);this.tx.send("run",{mode:"page",js:e.srcArl,html:e.htmlArl})},onRunAppInIframe(){const e=this.doc.toJavascriptApp(null);this.tx.send("run",{mode:"iframe",js:e.srcArl,html:e.htmlArl}),this.iframe||(this.iframe=document.createElement("iframe"),this.tx.send("iframe",this.iframe)),this.iframe.src=e.htmlArl.url},onPinProfile({}){},async onSelectedNode({model:e,nodePath:t,xyLocal:i}){const s=await this.doc.nodeFromLibrary(e,t);s&&(s.look.moveTo(i.x,i.y),this.doEdit("nodeFromNodeLib",{view:this.doc.focus,node:s}))},onSavePointSet({}){var t;if(!((t=this.doc)!=null&&t.model))return;const e=this.doc;this.tx.send("save point.confirm",{title:"Confirm to set a new save point",message:"",pos:{x:500,y:100},ok:()=>{const i=e.getNodeToSave();if(!i)return;const s=new Si(e.UID);e.model.raw=JSON.parse(s.encode(i,e.model))},cancel:()=>{}})},onSavePointBack({}){var i;if(!((i=this.doc)!=null&&i.model))return;const e=this,t=this.doc;this.tx.send("save point confirm",{title:"Confirm to go back to the previous save point",message:"",pos:{x:500,y:100},ok:async()=>{t.reCompile(),t.undoStack.reset(),e.redraw();try{const s=JSON.stringify(t.model.raw,null,4);s&&t.model.arl.save(s)}catch(s){console.log(`JSON stringify error: ${s}
in 'on save point.back'`)}},cancel:()=>{}})}},bf={doEdit(e,t){$s[e].doit(t),this.redraw()},saveEdit(e,t){this.doc.undoStack.push({verb:e,param:t}),this.tx.send("new edit",{verb:e}),this.doc.model.is.dirty=!0},signalEdit(e){this.tx.send("new edit",{verb:e})},send(e,t){this.tx.send(e,t)},getParam(){var e;return((e=this.doc.undoStack.last())==null?void 0:e.param)??{}},getVerb(){var e;return(e=this.doc.undoStack.last())==null?void 0:e.verb},undoLastEdit(){const e=this.doc.undoStack.back();console.log("undo ",e?e.verb:"-nothing-"),e&&$s[e.verb].undo(e.param)},redoLastEdit(){const e=this.doc.undoStack.forward();console.log("redo ",e?e.verb:"-nothing-"),e&&$s[e.verb].redo(e.param)},dropLastEdit(){this.doc.undoStack.back()}};let f;function kf(e,t){return f=new oo,f.tx=e,f.sx=t,f.setup(),e.send("canvas",f.canvas),f}const ct={nothing:0,viewResize:1,viewDrag:2,hoverBorder:3};function oo(){this.canvas=null,this.ctx=null,this.doc=null,this.state={view:null,widget:null,action:ct.nothing},this.tx=null,this.sx=null,this.waitingForFrame=!1}oo.prototype={setup(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("tabindex","0"),this.canvas.style.outline="none",this.ctx=this.canvas.getContext("2d"),this.setStyle(),this.addEventHandlers(),this.clear()},getCanvasContext(){return this.ctx},addEventHandlers(){document.addEventListener("keydown",e=>this.onKeydown(e)),document.addEventListener("keyup",e=>this.onKeyup(e)),this.canvas.addEventListener("mousedown",e=>this.onMouseDown(e)),this.canvas.addEventListener("mouseup",e=>this.onMouseUp(e)),this.canvas.addEventListener("mousemove",e=>this.onMouseMove(e)),this.canvas.addEventListener("mousewheel",e=>this.onWheel(e)),this.canvas.addEventListener("contextmenu",e=>this.onContextMenu(e)),this.canvas.addEventListener("click",e=>this.onClick(e)),this.canvas.addEventListener("dblclick",e=>this.onDblClick(e)),this.canvas.addEventListener("dragover",e=>this.onDragOver(e)),this.canvas.addEventListener("drop",e=>this.onDrop(e))},clear(){this.ctx.fillStyle=g.std.cBackground,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},switchView(e){var i;if(!e)return;const t=this.doc;e!=t.focus&&(t.focus.unHighLight(),t.focus=e,t.focus.highLight(),(i=t.focus.parent)==null||i.viewToFront(t.focus))},setStyle(){var i;this.doc&&g.switch((i=this.doc.model.header)==null?void 0:i.style);const e=this.ctx,t=g.std;e.font=t.font,e.strokeStyle=t.cLine,e.fillStyle=t.cFill,e.lineCap=t.lineCap,e.lineJoin=t.lineJoin,e.lineWidth=t.lineWidth},redraw(){this.waitingForFrame||(this.waitingForFrame=!0,window.requestAnimationFrame(()=>{var e;this.clear(),(e=this.doc)==null||e.view.render(this.ctx),this.waitingForFrame=!1}))},changeCursor(e){f.canvas.style.cursor=e},xxdeltaForPaste(e,t){var n,o;const i=t.selection,s=i.rect?i.rect:((n=i.nodes)==null?void 0:n.length)>0?i.nodes[0].look.rect:((o=i.pads)==null?void 0:o.length)>0?i.pads[0].rect:{x:0,y:0};return t.copyCount++,s.x==e.x&&s.y==e.y?{x:t.copyCount*g.look.dxCopy,y:t.copyCount*g.look.dyCopy}:{x:e.x-s.x+(t.copyCount-1)*g.look.dxCopy,y:e.y-s.y+(t.copyCount-1)*g.look.dyCopy}},xxxdeltaForPaste(e,t){const i=t.rect?t.rect:t.root.nodes.length>0?t.root.nodes[0].look.rect:t.root.pads.length>0?t.root.pads[0].rect:{x:0,y:0};return t.copyCount++,i.x==e.x&&i.y==e.y?{x:t.copyCount*g.look.dxCopy,y:t.copyCount*g.look.dyCopy}:{x:e.x-i.x+(t.copyCount-1)*g.look.dxCopy,y:e.y-i.y+(t.copyCount-1)*g.look.dyCopy}},textToExternalClipboard(e){const t=new Blob([e],{type:"text/plain"}),i=[new ClipboardItem({"text/plain":t})];navigator.clipboard.write(i)}};Object.assign(oo.prototype,wd,yd,xf,bf);function qn(e,t){this.variant=e,this.pin=t,this.actualTargets=[]}qn.prototype={};function li(e,t){this.variant=e,this.target=t}li.prototype={toString(){return this.target.is.pin?`${this.variant} @ ${this.target.node.name} (${this.target.node.uid})`:this.target.is.pad?`${this.variant} @ ${this.target.proxy.node.name} (${this.target.proxy.node.uid})`:this.target.is.tack?`${this.variant} @ ${this.target.bus.name} (${this.target.bus.uid})`:"- unknown -"}};const _f={toJavascriptApp(e){var a;if(!e)return;((a=this.target.application)==null?void 0:a.userPath)!==e&&(this.target.application=this.resolve(e));const t=this.target.application,i=this.resolve("index.js"),s=this.model.header.runtime??"@vizualmodel/vmblu-runtime",n=this.makeJSApp(this.view.root,t,i,s);t.save(n);const o=this.model.makeMcpToolString(this.view.root);o&&t.resolve(Vs(this.model.arl.userPath)+"-mcp.js").save(o);const r=this.resolve(co(e,"html"));return{srcArl:t,htmlArl:r}},makeJSApp(e,t,i,s){var v;const n=[];n.push({arl:i,items:[]}),e.collectImports(n);const o=new Date;let r=`// ------------------------------------------------------------------
// Model: ${e.name}
// Path: ${((v=t.url)==null?void 0:v.pathname)||t.userPath}
// Creation date ${o.toLocaleString()}
// ------------------------------------------------------------------
`,a=`
//Imports`+this.JSImportExportString(n,`
import `,t);const l=[],c=[];e.makeSourceLists(l,c);let h=`//The runtime nodes
const nodeList = [`;for(const w of l)h+=this.JSSourceNode(w);h+=`
]`;let u=`//The filters
const filterList = [`;for(const w of c)u+=this.JSFilter(w);u+=`
]`;const m=`
// import the runtime code
import * as VMBLU from "${s}"

${a}

${h}

${u}

// prepare the runtime
const runtime = VMBLU.scaffold(nodeList, filterList)

// and start the app
runtime.start()
`;return r+m},JSImportExportString(e,t,i){let s="";const n=`,
		 `;return e.forEach(o=>{o.items.length<1||(s+=t+"{ ",o.items.length>0&&(o.items.forEach(r=>{s+=r+n}),s=s.slice(0,-n.length)),s+=` } from '${an(o.arl.getFullPath(),i.getFullPath())}'`)}),s},JSSourceNode(e){const t=l=>{const h=l.is.input?l.is.channel?"=>":"->":l.is.channel?"<=":"<-";if(l.is.multi){let u="";for(const m of l.expandMultis())u+=`
		"${h} ${m}",`;return u}else return`
		"${h} ${l.name}",`},i=(l,c)=>{const h=JSON.stringify(l,null,4);return(h==null?void 0:h.length)>0?`,
	`+c+":	"+h.replaceAll(`
`,`
		`):""};let o=`${`
	//____________________________________________________________`.slice(0,-e.name.length)+e.name.toUpperCase()}
	{
	name: "${e.name}", 
	uid: "${e.uid}", 
	factory: ${e.factory.alias??e.factory.fName},`;o+=`
	inputs: [`;let r="";for(const l of e.rxTable)r+=t(l.pin);r.length>0&&(r=r.slice(0,-1)),o+=r.length>0?r+`
		],`:"],",o+=`
	outputs: [`;let a="";for(const l of e.txTable){const c=this.makeOutputTable(l);a+=this.stringifyOutputTable(c)}return a.length>0&&(a=a.slice(0,-1)),o+=a.length>0?a+`
		]`:"]",e.sx&&(o+=i(e.sx,"sx")),e.dx&&(o+=i(e.dx,"dx")),o+`
	},`},makeOutputTable(e){const t=[],i=e.pin.is.multi?k.expandMultis(e.pin.name):[e.pin.name];for(const s of i){const n=new qn(s,e.pin);for(const o of e.targets){const r=this.getActualTarget(e.pin,s,o);r&&n.actualTargets.push(r)}t.push(n)}return t},stringifyOutputTable(e){let t="";for(const i of e){const n=i.pin.is.channel?"=>":"->";if(i.actualTargets.length==0)t+=`
		"${i.variant} ${n} ()",`;else if(i.actualTargets.length==1)t+=`
		"${i.variant} ${n} ${i.actualTargets[0].toString()}",`;else{let o=`
		\`${i.variant} ${n} [ `;for(const r of i.actualTargets)o+=`
			"${r.toString()}",`;o=o.slice(0,-1)+" ]`,",t+=o}}return t},JSFilter(e){let s=`${`
	//_____________________________________________________`.slice(0,-e.name.length)+e.name.toUpperCase()+" FILTER"}
	{
	name: "${e.name}", 
	uid: "${e.uid}", 
	filter: ${e.filter.alias??e.filter.fName},`;s+=`
	table: [`;const n=this.makeFilterTable(e),o=`
		`;for(const r of n){s+="\n		`"+r.variant+" : [";let a="";for(const l of r.actualTargets)a+=o+'	"'+l.toString()+'",';s+=a.slice(0,-1)+" ]`,"}return s+`]
	},`},makeFilterTable(e){const t=[];for(const i of e.rxTable){const s=i.tack.getOtherPin(),n=s.is.multi?k.expandMultis(s.name):[s.name];for(const o of n){if(t.find(a=>a.variant==o))continue;const r=new qn(o,null);for(const a of e.txTable)if(a.connectsTo(o))for(const l of a.fanout){const c=this.getActualTarget(s,o,l);c&&r.actualTargets.push(c)}r.actualTargets.length>0&&t.push(r)}}return t},getActualTarget(e,t,i){if(i.is.pin)if(i.is.multi){const s=i.getMatch(t);return s?new li(s,i):null}else return e.is.multi?e.getMatch(i.name)==t?new li(i.name,i):null:new li(i.name,i);else if(i.is.tack){const s=i.getOtherPin();if(s.is.multi){const n=s.getMatch(t);return n?new li(n,i):null}else return e.is.multi?e.getMatch(s.name)==t?new li(s.name,i):null:new li(s.name,i)}},saveHtmlPage(e,t,i){const s=t.url.pathname,n=co(s,"css"),o=`<!doctype html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width'>
    <title>${e.name}</title>
    <link rel='icon' type='image/png' href='/page/shared/favicon.ico'>
    <link rel='stylesheet' href='${n}'> 
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script type='module' src='${s}'><\/script>
</head>
<body style="overflow:hidden;"></body>
</html>`;i.save(o)},NOT_OK_makeAppScript(e,t){let i=[];return i.push({arl:t,items:[]}),e.collectImports(i),this.makeAppPage(e,i)}},Tf={toJavascriptLib(e){var n;if(!e)return;((n=this.target.library)==null?void 0:n.userPath)!==e&&(this.target.library=this.resolve(e));const t=this.target.library,i=this.resolve("index.js"),s=this.makeJSLib(this.view.root,this.model.arl,t,i);t.save(s)},makeJSLib(e,t,i,s){let n=[];n.push({arl:s,items:[]}),e.collectImports(n);const o=k.nodeToFactory(Us(i.userPath)),r=new Date,a=`// ------------------------------------------------------------------
// Lib: ${o}
// Model File: ${t.userPath}
// Lib   File: ${i.userPath}
// Creation date ${r.toLocaleString()}
// ------------------------------------------------------------------`,l=`

//Export`+this.JSImportExportString(n,`
export `,i),c="./"+za(t.userPath),h=`

// The model
import ${o} from '${c}'
export {${o}}`;return a+l+h}},Pf={async importFromModel(e,t,i){if(t.length==0||i.length==0)return;const s=this.model.arl.resolve(i),n=await this.modcom.findOrAddModel(s);if(e.setLink(n,t),!n){console.log(`importFromModel failed. Model not found - check the file (${i}) of the node to link to`);return}const o=this.modcom.compileNode(n,t);if(o)e.linkIsGood();else{console.log(`importFromModel failed. Could not compile '${t}' from file '${i}' (check if there is such a node in the model)`),e.linkIsBad();return}if(!e.compatible(o)){const r=e.switchNodeType();this.view.root.swap(e,r),e=r}e.fuse(o)},encode(e,t){var n,o,r;if(!e)return null;e.collectFactories(this.factories),e.collectModels(this.models);const i={header:t.header};return((n=this.models)==null?void 0:n.size())>0&&(i.imports=this.models),((o=this.factories)==null?void 0:o.size())>0&&(i.factories=this.factories),((r=t.libraries)==null?void 0:r.size())>0&&(i.libraries=t.libraries),i.root=e,JSON.stringify(i,null,4)},async exportToModel(e,t,i){var a,l;if(e.link)return;const s=new Si(this.UID),n=e.copy();if(n.name=t,n.nodes)for(const c of n.nodes)c.adjustUserPaths(i.arl);n.collectFactories(s.factories),n.collectModels(s.models);const o={header:i.header};((a=s.models)==null?void 0:a.size())>0&&(o.imports=s.models),((l=s.factories)==null?void 0:l.size())>0&&(o.factories=s.factories),o.root=n;const r=JSON.stringify(o,null,4);await this.model.arl.save(r),e.setLink(i,t),e.is.group&&e.savedView&&e.savedView.closeView()},async nodeFromLibrary(e,t){if(t.length==0||!e)return null;const i=await this.modcom.findOrAddModel(e.arl);if(!i)return null;const s=this.modcom.compileNode(i,t);return s?(s.setLink(i,t),s):null},makeLocalLink(e,t){if(t.length==0)return;const i=this.view.root.findNode(t);if(!i){e.setLink(null,t),console.log(`Local link failed. Check the name (${t}) of the node to link to`),e.linkIsBad();return}const s=i.copy();if(s.uidChangeAll(this.UID),e.setLink(this.model,t),e.linkIsGood(),!e.compatible(s)){const n=e.switchNodeType();this.view.root.swap(e,n),e=n}e.fuse(s)}};function va(){this.uidmap=new Map,this.uidLength=4}va.prototype={reset(){this.uidmap.clear()},_freshUID(){let e=0;for(;e<10;){let t=ud(this.uidLength);if(!this.uidmap.has(t))return t;e++,console.log("*** THERE WAS A DUPLICATE *** (can happen, nothing to worry about)"),e>4&&this.uidLength++}return console.eror("*** FAILED TO MAKE A UNIQUE UID ***"),"????"},generate(e){e.uid=this._freshUID(),this.uidmap.set(e.uid,e)}};function vs(e=null){this.view=new Ts({x:0,y:0,h:0,w:0}),this.focus=this.view,this.model=e?new Mt(e):null,this.model.is.main=!0,this.UID=new va,this.modcom=new Si(this.UID),this.savecom=new Si(this.UID),this.target={application:null,library:null},this.undoStack=new ea(31)}vs.prototype={resolve(e){var t,i;return(i=(t=this.model)==null?void 0:t.arl)==null?void 0:i.resolve(e)},async load(){var t;if(!this.model)return;this.modcom.reset(),this.UID.reset();const e=await this.modcom.getRoot(this.model);e?this.view.syncRoot(e):(this.view.initRoot(Us(this.model.arl.userPath)),console.warn(`Empty root for ${this.model.arl.userPath} -  ok for empty file`)),(t=this.model.libraries)==null||t.load()},reCompile(){this.UID.reset();const e=this.modcom.compileNode(this.model,null);e?this.view.syncRoot(e):(this.view.initRoot(Us(this.model.arl.userPath)),console.warn(`Empty root for ${this.model.arl.userPath} -  ok for empty file`))},async save(){if(!this.model)return null;this.savecom.reset();const e=this.getNodeToSave();if(!e)return;const t=this.savecom.encode(e,this.model);return this.model.raw=JSON.parse(t),this.model.is.dirty=!1,this.model.arl.save(t)},async saveAs(e){if(Va(e)||(e+=".vmblu"),qa(e)){const t=an(e,this.model.arl.url);console.log(`${t} ${e} ${this.model.arl.url}`),this.model.arl.url=e,this.model.arl.userPath=t}else{const t=this.model.arl.resolve(e);if(!t)return console.log(`Invalid path: "${e}" in Document.saveAs`),null;this.model.arl=t}return this.save()},async update(){var e;!this.model||!((e=this.view)!=null&&e.root)||(this.model.is.dirty&&(this.model.raw=JSON.parse(this.modcom.encode(this.view.root,this.model)),this.model.is.fresh=!0),await this.modcom.updateFactoriesAndModels(),this.modcom.updateNode(this.view.root),this.modcom.resetFresh())},getNodeToSave(){const e=this.view.root;if(!e||e.is.source)return null;const t=e.isContainer()&&e.nodes.length==1?e.nodes[0]:e;return t==e&&(t.savedView=this.view),t}};Object.assign(vs.prototype,_f,Tf,Pf);function wa(e,t){this.tx=e,this.active=null,this.documents=[],this.checkForQueryParameters()}wa.prototype={haveDocument(e){return this.documents.find(t=>{var i;return(i=t.model.arl)==null?void 0:i.equals(e)})},openDocument(e){const t=new vs(e);this.documents.push(t),t.load().then(()=>{t.model.handleSourceMap()}).then(()=>{this.tx.send("tab new",e.getName()),this.tx.send("doc set active",t),this.active=t})},toForeground(e){e&&(this.tx.send("tab select",e.model.arl.getName()),this.tx.send("doc set active",e),this.active=e)},xxxtoForeground(e){let t=this.documents.find(i=>{var s;return(s=i.model.arl)==null?void 0:s.equals(e)});t?(this.tx.send("tab select",e.getName()),this.tx.send("doc set active",t),this.active=t):(t=new vs(e),this.documents.push(t),t.load().then(()=>{t.model.handleSourceMap()}).then(()=>{this.tx.send("tab new",e.getName()),this.tx.send("doc set active",t),this.active=t}))},onDocSelected(e){const t=this.haveDocument(e);t?this.toForeground(t):this.openDocument(e)},onDocOpen(e){const t=this.haveDocument(e);t?this.toForeground(t):this.openDocument(e)},onDocGet(){},onDocNew(e){const t=new vs(e);this.documents.push(t),t.view.initRoot(Us(e.userPath)),this.tx.send("tab new",e.getName()),this.tx.send("doc set active",t),this.active=t},onDocRenamed({oldName:e,newName:t}){console.log("old-new",e,t)},onDocDeleted(e){},onSaveAs(e){const t=e?{x:e.screenX,y:e.screenY}:{x:25,y:25},i=this.active,s=i.model.arl.getName();this.tx.send("save as filename",{title:"Save as...",entry:i.model.arl.userPath,pos:t,ok:n=>{i.saveAs(n)&&this.tx.send("tab rename",{oldName:s,newName:i.model.arl.getName()})},cancel:()=>{}})},onSave(){this.active.save()},onSaveAll(){this.documents.forEach(e=>e.model.arl&&e.save())},onGetOpenModels(){const e=[];this.documents.forEach(t=>{t.model.arl&&e.push(t.model.arl)}),this.tx.send("open models",e)},onTabRequestToClose(e){const t=this.documents.length;for(let i=0;i<t;i++)if(e==this.documents[i].model.arl.getName()){for(let s=i;s<t-1;s++)this.documents[s]=this.documents[s+1];this.documents.pop(),this.tx.send("tab remove",e),e==this.active.model.arl.getName()&&(i+1<t-1?(this.active=this.documents[i+1],this.tx.send("tab select",this.active.model.arl.getName())):i>0?(this.active=this.documents[i-1],this.tx.send("tab select",this.active.model.arl.getName())):this.active=null,this.tx.send("doc set active",this.active));return}},onTabRequestToSelect(e){const t=this.documents.find(i=>i.model.arl.getName()==e);t&&(this.active.model.is.dirty&&this.active.save(),this.tx.send("doc set active",t),this.tx.send("tab select",e),this.active=t)},checkForQueryParameters(){const{searchParams:e,origin:t}=new URL(window.location.href);if(!e)return;const i=e.get("model");if(!i)return;const s=new Qt(i);s.url=new URL(i,t),this.openDocument(s)}};function ya(e,t){this.windowProxy=null,this.iframe=null,this.tx=e}ya.prototype={sends:["iframe"],"-> run application"({mode:e,js:t,html:i}){i.url&&(e=="page"?this.windowProxy=window.open(i.url,"cell-runtime"):e=="iframe"&&(this.iframe||(this.iframe=document.createElement("iframe")),this.iframe.src=i.url,this.tx.send("iframe",this.iframe)))},"-> size change"({id:e,rect:t}){!this.iframe||!t||t.h<0||t.w<0||(this.iframe.height=t.h,this.iframe.width=t.w)},"-> show"(){}};const Sf=[{name:"workspace",uid:"tbvB",factory:Wc,inputs:["-> dom add modal div","-> file savedAs","-> file active","-> file closed"],outputs:["dom workspace div -> left column @ column-main layout (lHKr)","file selected -> doc selected @ document manager (aXkx)","file new -> doc new @ document manager (aXkx)","file get name -> ()","file context menu -> ()","file renamed -> doc renamed @ document manager (aXkx)","file deleted -> doc deleted @ document manager (aXkx)","files get list => ()","files selected -> ()","files deleted -> ()","folder context menu -> context menu @ context menu (QNIy)","folder renamed -> ()","folder deleted -> ()","drawer get location -> ()"],sx:{name:"examples",files:[],folders:[{name:"tutorial",files:[{name:"chat-client.vmblu"},{name:"chat-server.vmblu"}]}]}},{name:"single text field",uid:"GPqX",factory:ad,inputs:["-> show"],outputs:["modal div -> dom add modal div @ workspace (tbvB)"]},{name:"context menu",uid:"QNIy",factory:Ro,inputs:["-> context menu"],outputs:["modal div -> dom add modal div @ workspace (tbvB)"]},{name:"message box",uid:"jsOb",factory:od,inputs:["-> show"],outputs:["modal div -> dom add modal div @ workspace (tbvB)"]},{name:"tab ribbon",uid:"TWJF",factory:Qh,inputs:["-> tab new","-> tab rename","-> tab select","-> tab remove"],outputs:["div -> tabs div @ vertical menu tabs content (mOrg)","tab request to close -> tab request to close @ document manager (aXkx)","tab request to select -> tab request to select @ document manager (aXkx)"],sx:{a:7,b:8,c:"dit is een filename",d:{e:"nee",dxdy:254}}},{name:"editor",uid:"NREV",factory:kf,inputs:["-> sync model","-> grid on-off","-> accept changes","-> recalibrate","-> show settings","-> make lib","-> make app","-> run app","-> run app in iframe","-> set document","-> save point set","-> save point back","-> selected node","-> size change"],outputs:["show lib path -> path @ path request (kWLQ)","show app path -> path @ path request (kWLQ)","run -> ()","runtime settings -> show @ runtime settings (uQfg)","open document -> doc open @ document manager (aXkx)","document settings -> show @ doc settings (yugd)","save point confirm -> show @ confirm box (IwRp)","show context menu -> context menu @ context menu (fnKV)","settings -> json @ node settings (gBrM)","show link -> name and path @ name and path (qluS)","show filter -> name and path @ name and path (qluS)","show factory -> name and path @ name and path (qluS)","open source file -> ()","pin profile -> show @ pin profile (ZGxL)","node comment -> text @ text block (gLsX)","select node -> show @ node selector (WRDh)","change library -> switch library @ node library (LBtK)","add lib file -> ()","canvas -> content div @ vertical menu tabs content (mOrg)","new edit -> ()","clipboard get => get @ clipboard (umgQ)","clipboard set -> set @ clipboard (umgQ)"],sx:{a:7,b:8,c:9}},{name:"context menu",uid:"fnKV",factory:Ro,inputs:["-> context menu"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"path request",uid:"kWLQ",factory:Eo,inputs:["-> path"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"node settings",uid:"gBrM",factory:id,inputs:["-> json"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"name and path",uid:"qluS",factory:rd,inputs:["-> name and path"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"pin profile",uid:"ZGxL",factory:nd,inputs:["-> show"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"text block",uid:"gLsX",factory:sd,inputs:["-> text"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"vertical menu tabs content",uid:"mOrg",factory:Xh,inputs:["-> menu div","-> tabs div","-> content div","-> modal div","-> show","-> size change"],outputs:["content size change -> size change @ editor (NREV)","div -> main area @ column-main layout (lHKr)"]},{name:"document manager",uid:"aXkx",factory:wa,inputs:["-> doc selected","-> doc new","-> doc renamed","-> doc deleted","-> doc get","-> doc open","-> save","-> save as","-> save all","-> get open models","-> tab request to close","-> tab request to select"],outputs:["doc set active -> set document @ editor (NREV)","save as filename -> path @ path request (kWLQ)","open models -> ()","tab new -> tab new @ tab ribbon (TWJF)","tab rename -> tab rename @ tab ribbon (TWJF)","tab select -> tab select @ tab ribbon (TWJF)","tab remove -> tab remove @ tab ribbon (TWJF)"],dx:{logMessages:!1,worker:{on:!1,path:""}}},{name:"node selector",uid:"WRDh",factory:cd,inputs:["-> show","-> build table"],outputs:["selected node -> selected node @ editor (NREV)","remove file -> remove file @ node library (LBtK)","add file -> add file @ node library (LBtK)","get path -> path @ path request (oVjH)","modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"node library",uid:"LBtK",factory:ga,inputs:["-> switch library","-> remove file","-> add file"],outputs:["build table -> build table @ node selector (WRDh)"]},{name:"path request",uid:"oVjH",factory:Eo,inputs:["-> path"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"doc settings",uid:"yugd",factory:ld,inputs:["-> show"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"clipboard",uid:"umgQ",factory:ma,inputs:["-> switched","=> local","=> get","-> set"],outputs:["switch -> ()","remote => ()"]},{name:"confirm box",uid:"IwRp",factory:td,inputs:["-> show"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"runtime settings",uid:"uQfg",factory:ed,inputs:["-> show"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"side menu",uid:"osSD",factory:Zh,inputs:[],outputs:["div -> menu div @ vertical menu tabs content (mOrg)","sync -> sync model @ editor (NREV)","grid on-off -> grid on-off @ editor (NREV)","accept changes -> accept changes @ editor (NREV)","recalibrate -> recalibrate @ editor (NREV)","show settings -> show settings @ editor (NREV)","make lib -> make lib @ editor (NREV)","make app -> make app @ editor (NREV)","set save point -> save point set @ editor (NREV)","back to save point -> save point back @ editor (NREV)"],sx:[{icon:"flare",color:"#0fb2e4",message:"recalibrate",help:"Recalibrate"},{icon:"grid_view",color:"#0fb2e4",message:"grid on-off",help:"Grid on/off"},{icon:"check_box",color:"#0fb2e4",message:"accept changes",help:"Accept changes"},{icon:"bolt",color:"#0fb2e4",message:"sync",help:"sync model"},{icon:"push_pin",color:"#0fb2e4",message:"set save point",help:"set save point"},{icon:"reply",color:"#0fb2e4",message:"back to save point",help:"back to save point"},{icon:"build",color:"#0fb2e4",message:"make lib",help:"Make lib"},{icon:"handyman",color:"#0fb2e4",message:"make app",help:"Make app"},{icon:"settings",color:"#0fb2e4",message:"show settings",help:"Settings"}]},{name:"application launcher",uid:"XUOo",factory:ya,inputs:["-> run application","-> size change","-> show"],outputs:["iframe -> ()"]},{name:"column-main layout",uid:"lHKr",factory:Kh,inputs:["-> left column","-> main area"],outputs:["size change -> size change @ vertical menu tabs content (mOrg)"]}],Lf=[],Nf=Wa(Sf,Lf);Nf.start();
//# sourceMappingURL=playground-bundle.js.map
