var Na=Object.defineProperty;var oo=e=>{throw TypeError(e)};var Ca=(e,t,i)=>t in e?Na(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var yt=(e,t,i)=>Ca(e,typeof t!="symbol"?t+"":t,i),kn=(e,t,i)=>t.has(e)||oo("Cannot "+i);var x=(e,t,i)=>(kn(e,t,"read from private field"),i?i.call(e):t.get(e)),te=(e,t,i)=>t.has(e)?oo("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i),X=(e,t,i,s)=>(kn(e,t,"write to private field"),s?s.call(e,i):t.set(e,i),i),we=(e,t,i)=>(kn(e,t,"access private method"),i);function hs(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}hs.prototype={resolve(e){this._resolve(e)},reject(e){this._reject(e)}};function As(e){this.defs=e}As.prototype={then(e,t){const i=this.defs.map(s=>{const n=new hs;return s.promise.then(e,t).then(n.resolve.bind(n),n.reject.bind(n)),n});return new As(i)},catch(e){const t=this.defs.map(i=>{const s=new hs;return i.promise.catch(e).then(s.resolve.bind(s),s.reject.bind(s)),s});return new As(t)},replace(e){if(e>this.defs.length)for(let t=this.defs.length;t<e;t++)this.defs.push(new hs);else e<this.defs.length&&this.defs.splice(e).forEach(t=>{})}};function Vo(){this.minTimeout=1e3,this.queue=new Map}Vo.prototype={addPromiseHandler(e,t,i=1){const s=Math.max(t,this.minTimeout),n=Array.from({length:i},()=>new hs),o=new As(n);return this.queue.set(e,{handler:o,time:{start:Date.now(),duration:s}}),o},changePromiseHandler(e,t){const i=this.queue.get(e);i&&i.handler.replace(t)},trigger(e,t){const i=this.queue.get(e);if(!i)return console.log(e,"NOT FOUND");i.handler.defs.shift().resolve(t),i.handler.defs.length===0&&this.queue.delete(e)},checkTimeouts(e=Date.now()){for(const[t,i]of this.queue.entries()){const{start:s,duration:n}=i.time;if(s+n<=e){const o=new Error("Reply timeout",{sender:t,msec:n});i.handler.defs.forEach(r=>r.reject(o)),this.queue.delete(t)}}}};const gs=0,Tn=268435456,Hs=536870912,_n=4026531840,Ra=268435455;function Uo(e,t,i=!1){this.uid=e,this.actor=null,this.pin=t,this.channel=i,this.hix=gs}const ro="->",Ea="=>",hi={stringToInput(e){const t=e.trim(),i=t.slice(0,2);return{pin:t.slice(2).trim(),channel:i!==ro}},stringToOutput(e){function t(r){return!(r[0]=="["&&r.at(-1)=="]")}let i=!1,s=e.indexOf(ro);if(s<0&&(s=e.indexOf(Ea),i=!0),s<0)return null;const n=e.slice(0,s).trim(),o=e.slice(s+2).trim();if(n.length==0||o.length==0)return null;if(t(o)){const r=hi.stringToTarget(o);return r?{output:n,channel:i,targets:[r]}:{output:n,channel:i,targets:[]}}else{const r=/"(?:\\.|[^"\\])*"/g;let a=o.match(r);const l=a?a.map(h=>h.slice(1,-1).replace(/\\"/g,'"')):[],c=[];for(const h of l){const f=hi.stringToTarget(h);f&&c.push(f)}return{output:n,channel:i,targets:c}}},stringToScope(e){let t=e.indexOf(":");if(t<0)return null;const i=e.slice(0,t).trim(),s=e.slice(t+1).trim();if(i.length==0||s.length==0)return null;const n=/"(?:\\.|[^"\\])*"/g;let o=s.match(n);const r=o?o.map(l=>l.slice(1,-1).replace(/\\"/g,'"')):[],a=[];for(const l of r){const c=hi.stringToTarget(l);c&&a.push(c)}return{selector:i,scope:a}},stringToTarget(e){const t=e.lastIndexOf("(");if(t<0)return null;const i=e.lastIndexOf(")");if(i<0||i-t<2)return null;const s=e.slice(t+1,i),n=e.indexOf("@");if(n<0)return null;const o=e.slice(0,n).trim(),r=e.slice(n+1,t).trim();return o.length==0||r.length==0?null:{pinName:o,nodeName:r,uid:s}},pinToHandler(e){return"on"+e.split(/[ .-]+/).map(s=>s.replace(/[^a-zA-Z0-9_]/g,"")).filter(Boolean).map(s=>s[0].toUpperCase()+s.slice(1)).join("")}},zo={LOGMSG:1},Li=zo.LOGMSG;function qo(){this.actors=[],this.timer=0,this.minDelay=0,this.maxDelay=100,this.scheduleDelay=this.minDelay,this.idleCount=0,this.idleTreshold=100,this.slow=!1,this.msgCount=0,this.startTime=null,this.qOut=[],this.qIn=[],this.qResolve=new Vo}qo.prototype={start(){clearTimeout(this.timer),this.qOut=[],this.qIn=[],this.msgCount=0;for(const e of this.actors)e.makeCell();this.startTime=Date.now(),this.timer=setTimeout(this.receive.bind(this),this.scheduleDelay)},stop(){clearTimeout(this.timer),this.msgCount=0,this.actors.forEach(e=>e.cell=null),this.qOut=[],this.qIn=[]},halt(){clearTimeout(this.timer)},continue(){this.timer=setTimeout(this.receive.bind(this),this.scheduleDelay)},switch(){const e=this.qIn;this.qIn=this.qOut,this.qOut=e,this.qOut.length=0,this.slow&&this.goFast()},idle(){this.idleCount++;const e=Date.now();if(this.qResolve.checkTimeouts(e),this.idleCount%600==0){const t=(e-this.startTime)/6e4;console.log(`<idle> ${this.idleCount} cycles - nr of messages: ${this.msgCount} - running time:${t.toFixed(0)} min`)}!this.slow&&this.idleCount>this.idleTreshold&&this.goSlow()},goFast(){this.scheduleDelay=this.minDelay,this.idleCount=0,this.slow=!1},goSlow(){this.scheduleDelay=this.maxDelay,this.slow=!0},reject(e){return new Promise((t,i)=>{i(new Error(e))})},sendTo(e,t,i,s){if(e.length<1)return 0;t.flags&Li&&console.log(`${t.name} -> ${i}`),++this.msgCount;for(const n of e)this.qOut.push({from:t.uid,txRef:0,dest:n.actor,rxRef:0,hix:n.hix,pin:i,param:s});return e.length},requestFrom(e,t,i,s,n){t.flags&Li&&console.log(`${t.name} => ${i}`);const o=++this.msgCount;let r=0;for(const a of e)this.qOut.push({from:t.uid,txRef:o,dest:a.actor,rxRef:0,hix:a.hix,pin:i,param:s}),a.channel&&r++;return r==0?this.reject("No channel"):this.qResolve.addPromiseHandler(o,n,r)},reply(e,t){var i;return(i=e.msg)!=null&&i.txRef?(e.flags&Li&&console.log(`reply to ${e.msg.pin} @ ${e.name}`),++this.msgCount,this.qOut.push({from:e.uid,txRef:0,dest:e.msg.from,rxRef:e.msg.txRef,hix:Tn,pin:e.msg.pin,param:t}),1):0},next(e,t,i){var n;if(!((n=e.msg)!=null&&n.txRef))return this.reject("No target");const s=++this.msgCount;return this.qOut.push({from:e.uid,txRef:s,dest:target.actor,rxRef:e.msg.txRef,hix:Tn,pin:e.msg.pin,param:t}),this.qResolve.addPromiseHandler(s,i)},receive(){this.qOut.length?(this.switch(),this.handleReceiveQueue()):this.idle(),this.timer=setTimeout(this.receive.bind(this),this.scheduleDelay)},handleReceiveQueue(){var e,t;for(const i of this.qIn){const s=i.dest;switch(i.hix&_n){case gs:s.msg=i,s.flags&Li&&console.log(`${s.name} <- ${i.pin} (run ${s.rxTable[i.hix].handler.name})`),s.rxTable[i.hix].handler.call(s.cell,i.param);break;case Tn:s.flags&Li&&console.log(`${s.name} <= ${i.pin} (reply)`),this.qResolve.trigger(i.rxRef,i.param);break;case Hs:{s.flags&Li&&console.log(`${s.name} <- ${i.pin} (filter via router)`);const n=i.dest.scopeTable[i.hix&Ra],o=((t=(e=s.cell).filter)==null?void 0:t.call(e,n.targets.keys(),i.pin,i.param))??[...n.targets.keys()];if(Array.isArray(o)&&o.length>0)this.forwardToAll(i,o,n.targets);else{const r=n.targets.get(o);r&&this.forward(i,r)}}break}}},forwardToAll(e,t,i){let s=0;for(const n of t){const o=i.get(n);o&&(this.forward(e,o),e.txRef>0&&o.channel&&s++)}s>1&&this.qResolve.changePromiseHandler(e.txRef,s)},forward(e,t){(t.hix&_n)==gs?(t.actor.msg=e,t.actor.rxTable[t.hix].handler.call(t.actor.cell,e.param)):(t.hix&_n)==Hs&&this.qOut.push({from:e.from,txRef:e.txRef,dest:t.actor,rxRef:0,hix:t.hix,pin:t.pin,param:e.param})},reschedule(e){this.qOut.push(e)}};function Ma(e,t=!1){this.pin=e,this.channel=t,this.handler=null}function Aa(e,t=!1){this.pin=e,this.channel=t,this.targets=[]}function Da(e){const t=Object.getOwnPropertyNames(this);console.warn(`Missing handler for cell: ${t} - parameters: ${e}`)}function Oa(e){if(typeof e!="function"||!e.prototype)return!1;const t=Object.getOwnPropertyNames(e.prototype);return t.length!==1||t[0]!=="constructor"||e.prototype.constructor!==e}function Jo({name:e,uid:t,factory:i,inputs:s,outputs:n,sx:o,dx:r}){this.name=e,this.uid=t,this.factory=i,this.useNew=Oa(i),this.rxTable=[],this.txTable=[],this.sx=o??null,this.dx=r??null,this.flags=0,this.cell=null,this.msg=null,this.setFlags(),this.initRxTxTables({inputs:s,outputs:n})}Jo.prototype={setFlags(){var e;(e=this.dx)!=null&&e.flags&&this.dx.flags.includes("LOGMSG")&&(this.flags|=zo.LOGMSG)},initRxTxTables({inputs:e,outputs:t}){for(const i of e){const s=hi.stringToInput(i);s&&this.rxTable.push(new Ma(s.pin,s.channel))}for(const i of t){const s=hi.stringToOutput(i);if(!s)continue;const n=new Aa(s.output,s.channel);this.txTable.push(n);for(const o of s.targets)n.targets.push(new Uo(o.uid,o.pinName,s.channel))}},makeCell(){try{this.useNew?this.cell=new this.factory(this.getTx(),this.sx):this.cell=this.factory(this.getTx(),this.sx)}catch(e){if(e instanceof TypeError&&typeof this.factory=="function"&&/class constructor/i.test(e.message))this.useNew=!0,this.cell=new this.factory(this.getTx(),this.sx);else throw e}this.addHandlersForCell()},addHandlersForCell(){var s;if(!this.cell){((s=this.rxTable)==null?void 0:s.length)>0&&console.warn(`** NO HANDLERS ** Node ${this.name} has input pins but no implementation.`);return}const e=Object.entries(this.cell),t=Object.getPrototypeOf(this.cell),i=Object.getOwnPropertyNames(t)??[];for(const n of i)typeof t[n]=="function"&&e.push([n,t[n]]);e.forEach(([n,o])=>{if(typeof o=="function"){const r=this.getRx(n);r&&(r.handler=o)}}),this.rxTable.forEach(n=>{n.handler||(console.warn(`** NO HANDLER ** Node "${this.name}" has input pin "${n.pin}" but no handler for it.`),n.handler=Da)})},getRx(e){if(e.startsWith("-> ")||e.startsWith("=> ")){const t=e.slice(3);return this.rxTable.find(i=>i.pin==t)}return this.rxTable.find(t=>hi.pinToHandler(t.pin)==e)},resolveUIDs(e){this.txTable.forEach(t=>{t.targets.forEach(i=>{if(i.actor=e.find(s=>s.uid==i.uid),!i.actor)return console.error(`** ERROR ** target node ${i.uid} in ${this.name} not found`);i.hix=i.actor.factory?gs|i.actor.rxTable.findIndex(s=>s.pin==i.pin):Hs|i.actor.scopeTable.findIndex(s=>s.selector==i.pin)})})},findTargets(e){if(!e)return[];const t=this.txTable.find(i=>i.pin==e);return t?t.targets:(console.warn(`** NO OUTPUT PIN ** Node "${this.name}" pin: "${e}"`,this.txTable),[])},getTx(){const e=this;return{get pin(){var t;return(t=e.msg)==null?void 0:t.pin},send(t,i){if(!t)return 0;const s=e.findTargets(t);return We.sendTo(s,e,t,i)},request(t,i,s=0){if(!t)return null;const n=e.txTable.find(o=>o.pin==t);return n!=null&&n.targets.length?We.requestFrom(n.targets,e,t,i,s):(console.warn(`** NO OUTPUT PIN ** Node "${this.name}" pin: "${t}"`,this.txTable),We.reject("Not connected"))},reply(t){return We.reply(e,t)},next(t,i=0){return We.next(e,t,i)},reschedule(){e.msg&&We.reschedule(e.msg)},wireless(t){const i=We.actors.find(n=>n.name.toLowerCase()==t.toLowerCase());if(!i)return console.warn(`** WIRELESS SEND TO UNKNOWN NODE ** ${t}`),{send(n,o){return 0},request(n,o,r=1e3){return new Promise((a,l)=>{l(new Error("no node"))})}};function s(n){const o=i.rxTable.length;for(let r=0;r<o;r++)if(i.rxTable[r].pin==n)return{uid:i.uid,actor:i,pin:n,channel:i.rxTable[r].channel,hix:r};return null}return{send(n,o){const r=s(n);return r?We.sendTo([r],e,n,o):(console.warn(`** WIRELESS SEND TO UNKNOWN PIN ** ${t} pin: ${n}`),0)},request(n,o,r=0){const a=s(n);return a?We.requestFrom([a],e,n,o,r):(console.warn(`** WIRELESS REQUEST TO UNKNOWN PIN ** ${t} pin: ${n}`),new Promise((l,c)=>{c(new Error("no pin"))}))}}}}}};function Ia(e){this.selector=e,this.targets=new Map}function Go({name:e,uid:t,filter:i,table:s}){var n;this.name=e,this.uid=t,this.filter=i,this.useNew=((n=i.prototype)==null?void 0:n.constructor)!==i,this.scopeTable=[],this.cell=null,this.msg=null,this.buildScopeTable(s)}Go.prototype={buildScopeTable(e){for(const t of e){const i=hi.stringToScope(t),s=new Ia(i.selector);for(const n of i.scope){const o=new Uo(n.uid,n.pinName);s.targets.set(n.nodeName,o)}this.scopeTable.push(s)}},resolveUIDs(e){for(const t of this.scopeTable)for(const i of t.targets.values()){if(i.actor=e.find(s=>s.uid==i.uid),!i.actor)return console.error(`** ERROR ** target node ${i.uid} in ${this.name} not found`);i.actor.factory?i.actor.rxTable.find((s,n)=>s.pin!=i.pin?!1:(i.hix=gs|n,i.channel=s.channel,!0)):i.actor.filter&&i.actor.scopeTable.find((s,n)=>s.selector!=i.pin?!1:(i.hix=Hs|n,!0))}},makeCell(){this.cell=this.useNew?new this.filter:this.filter()}};let We=null;function Fa(e,t=[]){We=new qo;for(const i of e){const s=new Jo(i);We.actors.push(s)}for(const i of t){const s=new Go(i);We.actors.push(s)}return We.actors.forEach(i=>i.resolveUIDs(We.actors)),We}function Yo(e,t,i){this.message="HTTP code: "+t+": "+e,this.cause=i}const Xo=8e3;async function Wa(e,t={}){const i=new AbortController;t.signal=i.signal;const s=setTimeout(()=>i.abort(),Xo);return fetch(e,t).then(n=>{if(clearTimeout(s),n.ok)return n;throw new Yo("GET failed",n.status,"")}).catch(n=>{throw clearTimeout(s),n})}async function Ha(e,t,i="text/plain"){const s=new AbortController,n=setTimeout(()=>s.abort(),Xo);let o={method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":i},redirect:"follow",referrerPolicy:"no-referrer",body:t,signal:s.signal};const r=await fetch(e,o).catch(l=>{throw console.log("Network failure",l),l});if(clearTimeout(n),r.ok)return r;let a=await r.json();throw new Yo("POST failed",r.status,a)}const Ba={vizPath:/^((?:\.\/)?|(?:\.\.\/)*|\/|(?:[\w\s-]+\:\/?))((?:[\w\s-]+\/)*)([\w\s-\.]+)$/},$a=6;function ja(e){let t=e.lastIndexOf(".");return t>0&&e.length-t<=$a}function Ko(e){let t=e.lastIndexOf(".");return t<0?"":e.slice(t+1)}function ao(e,t){let i=e.lastIndexOf(".");return i>0?e.slice(0,i+1)+t:e+"."+t}function Bs(e){let t=e.lastIndexOf(".");return t>0?e.slice(0,t):e}function Va(e){return Ba.vizPath.test(e)?e:null}function Ua(e){const t=e.lastIndexOf("/");return t<0?e:e.slice(t+1)}function $s(e){let t=e.lastIndexOf("/"),i=e.lastIndexOf(".");return i>t?e.slice(t+1,i):e.slice(t+1)}function za(e){return/^(\/|https?:\/\/|file:\/\/\/|[a-zA-Z]:\\)/.test(e)}function qa(e,t){const i=e.length<t.length?e.length:t.length;for(let s=0;s<i;s++)if(e[s]!=t[s])return s}function zn(e,t){const i=qa(e,t);let s=e.lastIndexOf("/",i);if(s<1)return e;let n=e.slice(s+1),o=t.slice(s+1),r="./";if(s=o.indexOf("/"),s>0)for(r="../";(s=o.indexOf("/",s+1))>-1&&(r+="../",!(r.length>100)););return r+n}function Gt(e){this.userPath=e,this.url=null}Gt.prototype={absolute(e){const t=e.lastIndexOf("/");return this.userPath=t>=0?"."+e.slice(t):e,this.url=new URL(e),this},toJSON(){return this.userPath},equals(e){return this.url&&e.url&&this.url.href==e.url.href},sameDir(e){if(!this.url||!e.url)return!1;const t=this.url.href.lastIndexOf("/"),i=e.url.href.lastIndexOf("/");return this.url.href.slice(0,t)===e.url.href.slice(0,i)},getPath(){return this.userPath},getExt(){let e=this.userPath.lastIndexOf(".");return e<0?"":this.userPath.slice(e+1)},getName(){const e=this.userPath.lastIndexOf("/");if(e>0)return this.userPath.slice(e+1);const t=this.userPath.indexOf(":");return t>0?this.userPath.slice(0,t):this.userPath},getFullPath(){return this.url?this.url.pathname:this.userPath},setWSReference(e){},resolve(e){if(!this.url)return console.error(`cannot resolve ${e} - missing reference`),null;const t=new Gt(e);return t.url=new URL(e,this.url),t},resolve_dbg(e){const t=this.resolve(e);return console.log(`%cresolved: ${e} using ${this.userPath} to ${t.userPath}`,"background: #ff0; color: #00f"),t},makeRelative(e){let t=this.getFullPath(),i=e.getFullPath();this.userPath=zn(t,i)},copy(){const e=new Gt(this.userPath);return e.url=this.url?new URL(this.url):null,e},validURL(){return this.url?!0:(console.error(`missing url ${this.path}`),!1)},async get(e="text"){return this.validURL()?Wa(this.url).then(async t=>t.headers.get("Content-Length")=="0"?null:e=="json"?await t.json():await t.text()):null},async save(e){return this.validURL()?Ha(this.url+"?action=save",e):null},async jsImport(){return this.validURL()?import(this.url):null}};function Qo(e){this.kind=e,this.root=null}Qo.prototype={collapse(){for(const e of this.root.folders)e.is.expanded=!1;this.root.is.expanded=!1},expand(){for(const e of this.root.folders)e.is.expanded=!0;this.root.is.expanded=!0}};function js(e,t){this.name=e==null?void 0:e.getName(),this.parent=t,this.arl=e,this.files=[],this.folders=[],this.is={expanded:!1,stale:!0}}js.prototype={toJSON(){return this.parent.parent.parent?" "+this.arl.userPath:this.is.expanded?"+"+this.arl.userPath:"-"+this.arl.userPath},async findFile(e){let t=e.lastIndexOf("/"),i=e.slice(t+1),s=t>0?e.slice(0,t):e,n=this;for(const r of s.split("/").filter(Boolean)){if(n=n.folders.find(a=>r===a.name),!n)return null;n.is.stale&&await n.update()}return n?(n.is.stale&&await n.update(),n.files.find(r=>i==r.name)):null},getRoot(){return this.parent?this.parent.getRoot():this.arl},getIcon(){return this.is.expanded?"folder_open":"folder"},getName(){return this.name},getFileSystem(){let e=this.parent;for(;e!=null&&e.parent;)e=e.parent;return e},checkName(e){return e.length<1?!1:Va(e)?this.folders.find(t=>t.name===e)?!1:!this.files.find(t=>t.name===e):!1},getFileTreeAndPath(){let e=this;const t=[];for(;e.parent;)t.push(e.getName()),e=e.parent;const i="/"+t.reverse().join("/")+"/";return[e,i]},async update(){const e=this.getFileSystem();switch(e==null?void 0:e.kind){case"local":this.folders=[],this.files=[],console.log(this.arl);for await(const t of this.arl.handle.values()){const i=this.arl.resolve(t.name);if(i.handle=t,t.kind=="directory"){const s=new js(i,this);s.fsType=this.fsType,this.folders.push(s)}else if(t.kind=="file"){const s=new qn(i,this);this.files.push(s)}}return;case"api":return;case"fixed":return;case"none":return}},ejectFolder(e){this.folders=this.folders.filter(t=>t!=e)},ejectFile(e){this.files=this.files.filter(t=>t!=e)}};function qn(e,t){this.name=e==null?void 0:e.getName(),this.folder=t,this.arl=e,this.is={highLighted:!1}}qn.prototype={getPath(){let e=this.folder.getPath();return e.at(-1)=="/"?e+this.name:e+"/"+this.name},getExt(){let e=this.name.lastIndexOf(".");return e<0?"any":this.name.slice(e+1)},getIcon(){const e=this.getExt();return e=="vmblu"||e=="nmsh"?"account_tree":e=="js"||e=="msj"?"electric_bolt":e=="json"?"data_object":e=="html"?"code":e=="css"?"tag":"description"},getFileClass(){const e=this.getExt();return e=="vmblu"?"vmblu-file":e=="nmsh"?"nmsh-file":e=="js"?"js-file":"other-file"},rename(e){e!==this.name&&this.folder.checkName(e)&&this.arl.rename(e).then(t=>{if(!t)return;const i=this.name;this.name=e,this.folder.getDrawer().update(),tx.send("file renamed",{oldName:i,newName:e})}).catch(t=>console.log(t))},confirmDelete(e){showMessage("Confirm delete file",`Delete file  ${this.name}  ?`,t=>this.remove())},remove(){var e;(e=this.arl)==null||e.remove().then(()=>{this.folder.ejectFile(this),this.folder.getDrawer().update(),tx.send("file deleted",this.arl)}).catch(t=>console.error(t))}};const Ja="5";var jo;typeof window<"u"&&((jo=window.__svelte??(window.__svelte={})).v??(jo.v=new Set)).add(Ja);let Ji=!1,Ga=!1;function Ya(){Ji=!0}Ya();const nn=1,on=2,Zo=4,Xa=8,Ka=16,Qa=1,Za=2,el=4,tl=8,il=16,sl=1,nl=2,Me=Symbol(),ol="http://www.w3.org/1999/xhtml",er=!1;var tr=Array.isArray,rl=Array.prototype.indexOf,Jn=Array.from,ir=Object.defineProperty,di=Object.getOwnPropertyDescriptor,sr=Object.getOwnPropertyDescriptors,al=Object.prototype,ll=Array.prototype,Gn=Object.getPrototypeOf,lo=Object.isExtensible;const Di=()=>{};function cl(e){return e()}function Cn(e){for(var t=0;t<e.length;t++)e[t]()}function nr(){var e,t,i=new Promise((s,n)=>{e=s,t=n});return{promise:i,resolve:e,reject:t}}const De=2,rn=4,an=8,Ot=16,It=32,ki=64,ln=128,ft=512,Le=1024,ze=2048,Et=4096,Ye=8192,Yt=16384,Yn=32768,Bi=65536,co=1<<17,or=1<<18,Gi=1<<19,rr=1<<20,ms=32768,Rn=1<<21,Xn=1<<22,Xt=1<<23,ui=Symbol("$state"),hl=Symbol("legacy props"),dl=Symbol(""),Mi=new class extends Error{constructor(){super(...arguments);yt(this,"name","StaleReactionError");yt(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function ul(e){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function fl(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function pl(e){throw new Error("https://svelte.dev/e/effect_in_teardown")}function gl(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function ml(e){throw new Error("https://svelte.dev/e/effect_orphan")}function vl(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function wl(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function yl(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function xl(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function bl(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}function kl(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}let Tl=!1;function ar(e){return e===this.v}function lr(e,t){return e!=e?t==t:e!==t||e!==null&&typeof e=="object"||typeof e=="function"}function cr(e){return!lr(e,this.v)}let me=null;function $i(e){me=e}function le(e,t=!1,i){me={p:me,i:!1,c:null,e:null,s:e,x:null,l:Ji&&!t?{s:null,u:null,$:[]}:null}}function ce(e){var t=me,i=t.e;if(i!==null){t.e=null;for(var s of i)Lr(s)}return e!==void 0&&(t.x=e),t.i=!0,me=t.p,e??{}}function Ss(){return!Ji||me!==null&&me.l===null}let ni=[];function hr(){var e=ni;ni=[],Cn(e)}function Yi(e){if(ni.length===0&&!ds){var t=ni;queueMicrotask(()=>{t===ni&&hr()})}ni.push(e)}function _l(){for(;ni.length>0;)hr()}function dr(e){var t=ie;if(t===null)return Z.f|=Xt,e;if((t.f&Yn)===0){if((t.f&ln)===0)throw e;t.b.error(e)}else ji(e,t)}function ji(e,t){for(;t!==null;){if((t.f&ln)!==0)try{t.b.error(e);return}catch(i){e=i}t=t.parent}throw e}const Rs=new Set;let he=null,Ds=null,ye=null,Pt=[],cn=null,En=!1,ds=!1;var Ii,Fi,oi,ri,Ts,Wi,Hi,Ae,Mn,ii,ur,fr;const en=class en{constructor(){te(this,Ae);yt(this,"committed",!1);yt(this,"current",new Map);yt(this,"previous",new Map);te(this,Ii,new Set);te(this,Fi,new Set);te(this,oi,0);te(this,ri,0);te(this,Ts,null);te(this,Wi,[]);te(this,Hi,[]);yt(this,"skipped_effects",new Set);yt(this,"is_fork",!1)}process(t){var s;Pt=[],Ds=null,this.apply();var i={parent:null,effect:null,effects:[],render_effects:[],block_effects:[]};for(const n of t)we(this,Ae,Mn).call(this,n,i);this.is_fork||we(this,Ae,ur).call(this),x(this,ri)>0||this.is_fork?(we(this,Ae,ii).call(this,i.effects),we(this,Ae,ii).call(this,i.render_effects),we(this,Ae,ii).call(this,i.block_effects)):(Ds=this,he=null,ho(i.render_effects),ho(i.effects),Ds=null,(s=x(this,Ts))==null||s.resolve()),ye=null}capture(t,i){this.previous.has(t)||this.previous.set(t,i),(t.f&Xt)===0&&(this.current.set(t,t.v),ye==null||ye.set(t,t.v))}activate(){he=this,this.apply()}deactivate(){he=null,ye=null}flush(){if(this.activate(),Pt.length>0){if(pr(),he!==null&&he!==this)return}else x(this,oi)===0&&this.process([]);this.deactivate()}discard(){for(const t of x(this,Fi))t(this);x(this,Fi).clear()}increment(t){X(this,oi,x(this,oi)+1),t&&X(this,ri,x(this,ri)+1)}decrement(t){X(this,oi,x(this,oi)-1),t&&X(this,ri,x(this,ri)-1),this.revive()}revive(){for(const t of x(this,Wi))Ce(t,ze),mi(t);for(const t of x(this,Hi))Ce(t,Et),mi(t);X(this,Wi,[]),X(this,Hi,[]),this.flush()}oncommit(t){x(this,Ii).add(t)}ondiscard(t){x(this,Fi).add(t)}settled(){return(x(this,Ts)??X(this,Ts,nr())).promise}static ensure(){if(he===null){const t=he=new en;Rs.add(he),ds||en.enqueue(()=>{he===t&&t.flush()})}return he}static enqueue(t){Yi(t)}apply(){}};Ii=new WeakMap,Fi=new WeakMap,oi=new WeakMap,ri=new WeakMap,Ts=new WeakMap,Wi=new WeakMap,Hi=new WeakMap,Ae=new WeakSet,Mn=function(t,i){var h;t.f^=Le;for(var s=t.first;s!==null;){var n=s.f,o=(n&(It|ki))!==0,r=o&&(n&Le)!==0,a=r||(n&Ye)!==0||this.skipped_effects.has(s);if((s.f&ln)!==0&&((h=s.b)!=null&&h.is_pending())&&(i={parent:i,effect:s,effects:[],render_effects:[],block_effects:[]}),!a&&s.fn!==null){o?s.f^=Le:(n&rn)!==0?i.effects.push(s):Ki(s)&&((s.f&Ot)!==0&&i.block_effects.push(s),Ui(s));var l=s.first;if(l!==null){s=l;continue}}var c=s.parent;for(s=s.next;s===null&&c!==null;)c===i.effect&&(we(this,Ae,ii).call(this,i.effects),we(this,Ae,ii).call(this,i.render_effects),we(this,Ae,ii).call(this,i.block_effects),i=i.parent),s=c.next,c=c.parent}},ii=function(t){for(const i of t)((i.f&ze)!==0?x(this,Wi):x(this,Hi)).push(i),Ce(i,Le)},ur=function(){if(x(this,ri)===0){for(const t of x(this,Ii))t();x(this,Ii).clear()}x(this,oi)===0&&we(this,Ae,fr).call(this)},fr=function(){var n;if(Rs.size>1){this.previous.clear();var t=ye,i=!0,s={parent:null,effect:null,effects:[],render_effects:[],block_effects:[]};for(const o of Rs){if(o===this){i=!1;continue}const r=[];for(const[l,c]of this.current){if(o.current.has(l))if(i&&c!==o.current.get(l))o.current.set(l,c);else continue;r.push(l)}if(r.length===0)continue;const a=[...o.current.keys()].filter(l=>!this.current.has(l));if(a.length>0){const l=new Set,c=new Map;for(const h of r)gr(h,a,l,c);if(Pt.length>0){he=o,o.apply();for(const h of Pt)we(n=o,Ae,Mn).call(n,h,s);Pt=[],o.deactivate()}}}he=null,ye=t}this.committed=!0,Rs.delete(this)};let Dt=en;function Pl(e){var t=ds;ds=!0;try{for(var i;;){if(_l(),Pt.length===0&&(he==null||he.flush(),Pt.length===0))return cn=null,i;pr()}}finally{ds=t}}function pr(){var e=fi;En=!0;try{var t=0;for(po(!0);Pt.length>0;){var i=Dt.ensure();if(t++>1e3){var s,n;Sl()}i.process(Pt),Kt.clear()}}finally{En=!1,po(e),cn=null}}function Sl(){try{vl()}catch(e){ji(e,cn)}}let at=null;function ho(e){var t=e.length;if(t!==0){for(var i=0;i<t;){var s=e[i++];if((s.f&(Yt|Ye))===0&&Ki(s)&&(at=new Set,Ui(s),s.deps===null&&s.first===null&&s.nodes_start===null&&(s.teardown===null&&s.ac===null?Er(s):s.fn=null),(at==null?void 0:at.size)>0)){Kt.clear();for(const n of at){if((n.f&(Yt|Ye))!==0)continue;const o=[n];let r=n.parent;for(;r!==null;)at.has(r)&&(at.delete(r),o.push(r)),r=r.parent;for(let a=o.length-1;a>=0;a--){const l=o[a];(l.f&(Yt|Ye))===0&&Ui(l)}}at.clear()}}at=null}}function gr(e,t,i,s){if(!i.has(e)&&(i.add(e),e.reactions!==null))for(const n of e.reactions){const o=n.f;(o&De)!==0?gr(n,t,i,s):(o&(Xn|Ot))!==0&&(o&ze)===0&&mr(n,t,s)&&(Ce(n,ze),mi(n))}}function mr(e,t,i){const s=i.get(e);if(s!==void 0)return s;if(e.deps!==null)for(const n of e.deps){if(t.includes(n))return!0;if((n.f&De)!==0&&mr(n,t,i))return i.set(n,!0),!0}return i.set(e,!1),!1}function mi(e){for(var t=cn=e;t.parent!==null;){t=t.parent;var i=t.f;if(En&&t===ie&&(i&Ot)!==0&&(i&or)===0)return;if((i&(ki|It))!==0){if((i&Le)===0)return;t.f^=Le}}Pt.push(t)}function Ll(e){let t=0,i=vi(0),s;return()=>{un()&&(d(i),Xi(()=>(t===0&&(s=N(()=>e(()=>us(i)))),t+=1,()=>{Yi(()=>{t-=1,t===0&&(s==null||s(),s=void 0,us(i))})})))}}var Nl=Bi|Gi|ln;function Cl(e,t,i){new Rl(e,t,i)}var et,tt,Un,bt,ai,kt,it,Ve,Tt,At,Ut,li,zt,ci,qt,tn,Pe,El,Ml,An,Os,Is,Dn;class Rl{constructor(t,i,s){te(this,Pe);yt(this,"parent");te(this,et,!1);te(this,tt);te(this,Un,null);te(this,bt);te(this,ai);te(this,kt);te(this,it,null);te(this,Ve,null);te(this,Tt,null);te(this,At,null);te(this,Ut,null);te(this,li,0);te(this,zt,0);te(this,ci,!1);te(this,qt,null);te(this,tn,Ll(()=>(X(this,qt,vi(x(this,li))),()=>{X(this,qt,null)})));X(this,tt,t),X(this,bt,i),X(this,ai,s),this.parent=ie.b,X(this,et,!!x(this,bt).pending),X(this,kt,Zn(()=>{ie.b=this;{var n=we(this,Pe,An).call(this);try{X(this,it,ct(()=>s(n)))}catch(o){this.error(o)}x(this,zt)>0?we(this,Pe,Is).call(this):X(this,et,!1)}return()=>{var o;(o=x(this,Ut))==null||o.remove()}},Nl))}is_pending(){return x(this,et)||!!this.parent&&this.parent.is_pending()}has_pending_snippet(){return!!x(this,bt).pending}update_pending_count(t){we(this,Pe,Dn).call(this,t),X(this,li,x(this,li)+t),x(this,qt)&&Vi(x(this,qt),x(this,li))}get_effect_pending(){return x(this,tn).call(this),d(x(this,qt))}error(t){var i=x(this,bt).onerror;let s=x(this,bt).failed;if(x(this,ci)||!i&&!s)throw t;x(this,it)&&(Be(x(this,it)),X(this,it,null)),x(this,Ve)&&(Be(x(this,Ve)),X(this,Ve,null)),x(this,Tt)&&(Be(x(this,Tt)),X(this,Tt,null));var n=!1,o=!1;const r=()=>{if(n){kl();return}n=!0,o&&bl(),Dt.ensure(),X(this,li,0),x(this,Tt)!==null&&Oi(x(this,Tt),()=>{X(this,Tt,null)}),X(this,et,this.has_pending_snippet()),X(this,it,we(this,Pe,Os).call(this,()=>(X(this,ci,!1),ct(()=>x(this,ai).call(this,x(this,tt)))))),x(this,zt)>0?we(this,Pe,Is).call(this):X(this,et,!1)};var a=Z;try{Ue(null),o=!0,i==null||i(t,r),o=!1}catch(l){ji(l,x(this,kt)&&x(this,kt).parent)}finally{Ue(a)}s&&Yi(()=>{X(this,Tt,we(this,Pe,Os).call(this,()=>{Dt.ensure(),X(this,ci,!0);try{return ct(()=>{s(x(this,tt),()=>t,()=>r)})}catch(l){return ji(l,x(this,kt).parent),null}finally{X(this,ci,!1)}}))})}}et=new WeakMap,tt=new WeakMap,Un=new WeakMap,bt=new WeakMap,ai=new WeakMap,kt=new WeakMap,it=new WeakMap,Ve=new WeakMap,Tt=new WeakMap,At=new WeakMap,Ut=new WeakMap,li=new WeakMap,zt=new WeakMap,ci=new WeakMap,qt=new WeakMap,tn=new WeakMap,Pe=new WeakSet,El=function(){try{X(this,it,ct(()=>x(this,ai).call(this,x(this,tt))))}catch(t){this.error(t)}X(this,et,!1)},Ml=function(){const t=x(this,bt).pending;t&&(X(this,Ve,ct(()=>t(x(this,tt)))),Dt.enqueue(()=>{var i=we(this,Pe,An).call(this);X(this,it,we(this,Pe,Os).call(this,()=>(Dt.ensure(),ct(()=>x(this,ai).call(this,i))))),x(this,zt)>0?we(this,Pe,Is).call(this):(Oi(x(this,Ve),()=>{X(this,Ve,null)}),X(this,et,!1))}))},An=function(){var t=x(this,tt);return x(this,et)&&(X(this,Ut,wi()),x(this,tt).before(x(this,Ut)),t=x(this,Ut)),t},Os=function(t){var i=ie,s=Z,n=me;Lt(x(this,kt)),Ue(x(this,kt)),$i(x(this,kt).ctx);try{return t()}catch(o){return dr(o),null}finally{Lt(i),Ue(s),$i(n)}},Is=function(){const t=x(this,bt).pending;x(this,it)!==null&&(X(this,At,document.createDocumentFragment()),x(this,At).append(x(this,Ut)),Dr(x(this,it),x(this,At))),x(this,Ve)===null&&X(this,Ve,ct(()=>t(x(this,tt))))},Dn=function(t){var i;if(!this.has_pending_snippet()){this.parent&&we(i=this.parent,Pe,Dn).call(i,t);return}X(this,zt,x(this,zt)+t),x(this,zt)===0&&(X(this,et,!1),x(this,Ve)&&Oi(x(this,Ve),()=>{X(this,Ve,null)}),x(this,At)&&(x(this,tt).before(x(this,At)),X(this,At,null)))};function Al(e,t,i,s){const n=Ss()?hn:Kn;if(i.length===0&&e.length===0){s(t.map(n));return}var o=he,r=ie,a=Dl();function l(){Promise.all(i.map(c=>Ol(c))).then(c=>{a();try{s([...t.map(n),...c])}catch(h){(r.f&Yt)===0&&ji(h,r)}o==null||o.deactivate(),Vs()}).catch(c=>{ji(c,r)})}e.length>0?Promise.all(e).then(()=>{a();try{return l()}finally{o==null||o.deactivate(),Vs()}}):l()}function Dl(){var e=ie,t=Z,i=me,s=he;return function(o=!0){Lt(e),Ue(t),$i(i),o&&(s==null||s.activate())}}function Vs(){Lt(null),Ue(null),$i(null)}function hn(e){var t=De|ze,i=Z!==null&&(Z.f&De)!==0?Z:null;return ie!==null&&(ie.f|=Gi),{ctx:me,deps:null,effects:null,equals:ar,f:t,fn:e,reactions:null,rv:0,v:Me,wv:0,parent:i??ie,ac:null}}function Ol(e,t){let i=ie;i===null&&fl();var s=i.b,n=void 0,o=vi(Me),r=!Z,a=new Map;return Jl(()=>{var m;var l=nr();n=l.promise;try{Promise.resolve(e()).then(l.resolve,l.reject).then(()=>{c===he&&c.committed&&c.deactivate(),Vs()})}catch(v){l.reject(v),Vs()}var c=he;if(r){var h=!s.is_pending();s.update_pending_count(1),c.increment(h),(m=a.get(c))==null||m.reject(Mi),a.delete(c),a.set(c,l)}const f=(v,w=void 0)=>{if(c.activate(),w)w!==Mi&&(o.f|=Xt,Vi(o,w));else{(o.f&Xt)!==0&&(o.f^=Xt),Vi(o,v);for(const[y,b]of a){if(a.delete(y),y===c)break;b.reject(Mi)}}r&&(s.update_pending_count(-1),c.decrement(h))};l.promise.then(f,v=>f(null,v||"unknown"))}),fn(()=>{for(const l of a.values())l.reject(Mi)}),new Promise(l=>{function c(h){function f(){h===n?l(o):c(n)}h.then(f,f)}c(n)})}function Kn(e){const t=hn(e);return t.equals=cr,t}function vr(e){var t=e.effects;if(t!==null){e.effects=null;for(var i=0;i<t.length;i+=1)Be(t[i])}}function Il(e){for(var t=e.parent;t!==null;){if((t.f&De)===0)return t;t=t.parent}return null}function Qn(e){var t,i=ie;Lt(Il(e));try{e.f&=~ms,vr(e),t=Wr(e)}finally{Lt(i)}return t}function wr(e){var t=Qn(e);if(e.equals(t)||(e.v=t,e.wv=Ir()),!Ti)if(ye!==null)un()&&ye.set(e,e.v);else{var i=(e.f&ft)===0?Et:Le;Ce(e,i)}}let On=new Set;const Kt=new Map;let yr=!1;function vi(e,t){var i={f:0,v:e,reactions:null,equals:ar,rv:0,wv:0};return i}function Vt(e,t){const i=vi(e);return Yl(i),i}function U(e,t=!1,i=!0){var n;const s=vi(e);return t||(s.equals=cr),Ji&&i&&me!==null&&me.l!==null&&((n=me.l).s??(n.s=[])).push(s),s}function B(e,t){return I(e,N(()=>d(e))),t}function I(e,t,i=!1){Z!==null&&(!St||(Z.f&co)!==0)&&Ss()&&(Z.f&(De|Ot|Xn|co))!==0&&!($e!=null&&$e.includes(e))&&xl();let s=i?Ai(t):t;return Vi(e,s)}function Vi(e,t){if(!e.equals(t)){var i=e.v;Ti?Kt.set(e,t):Kt.set(e,i),e.v=t;var s=Dt.ensure();s.capture(e,i),(e.f&De)!==0&&((e.f&ze)!==0&&Qn(e),Ce(e,(e.f&ft)!==0?Le:Et)),e.wv=Ir(),xr(e,ze),Ss()&&ie!==null&&(ie.f&Le)!==0&&(ie.f&(It|ki))===0&&(Ze===null?Xl([e]):Ze.push(e)),!s.is_fork&&On.size>0&&!yr&&Fl()}return t}function Fl(){yr=!1;const e=Array.from(On);for(const t of e)(t.f&Le)!==0&&Ce(t,Et),Ki(t)&&Ui(t);On.clear()}function us(e){I(e,e.v+1)}function xr(e,t){var i=e.reactions;if(i!==null)for(var s=Ss(),n=i.length,o=0;o<n;o++){var r=i[o],a=r.f;if(!(!s&&r===ie)){var l=(a&ze)===0;if(l&&Ce(r,t),(a&De)!==0){var c=r;ye==null||ye.delete(c),(a&ms)===0&&(a&ft&&(r.f|=ms),xr(c,Et))}else l&&((a&Ot)!==0&&at!==null&&at.add(r),mi(r))}}}function Ai(e){if(typeof e!="object"||e===null||ui in e)return e;const t=Gn(e);if(t!==al&&t!==ll)return e;var i=new Map,s=tr(e),n=Vt(0),o=pi,r=a=>{if(pi===o)return a();var l=Z,c=pi;Ue(null),mo(o);var h=a();return Ue(l),mo(c),h};return s&&i.set("length",Vt(e.length)),new Proxy(e,{defineProperty(a,l,c){(!("value"in c)||c.configurable===!1||c.enumerable===!1||c.writable===!1)&&wl();var h=i.get(l);return h===void 0?h=r(()=>{var f=Vt(c.value);return i.set(l,f),f}):I(h,c.value,!0),!0},deleteProperty(a,l){var c=i.get(l);if(c===void 0){if(l in a){const h=r(()=>Vt(Me));i.set(l,h),us(n)}}else I(c,Me),us(n);return!0},get(a,l,c){var v;if(l===ui)return e;var h=i.get(l),f=l in a;if(h===void 0&&(!f||(v=di(a,l))!=null&&v.writable)&&(h=r(()=>{var w=Ai(f?a[l]:Me),y=Vt(w);return y}),i.set(l,h)),h!==void 0){var m=d(h);return m===Me?void 0:m}return Reflect.get(a,l,c)},getOwnPropertyDescriptor(a,l){var c=Reflect.getOwnPropertyDescriptor(a,l);if(c&&"value"in c){var h=i.get(l);h&&(c.value=d(h))}else if(c===void 0){var f=i.get(l),m=f==null?void 0:f.v;if(f!==void 0&&m!==Me)return{enumerable:!0,configurable:!0,value:m,writable:!0}}return c},has(a,l){var m;if(l===ui)return!0;var c=i.get(l),h=c!==void 0&&c.v!==Me||Reflect.has(a,l);if(c!==void 0||ie!==null&&(!h||(m=di(a,l))!=null&&m.writable)){c===void 0&&(c=r(()=>{var v=h?Ai(a[l]):Me,w=Vt(v);return w}),i.set(l,c));var f=d(c);if(f===Me)return!1}return h},set(a,l,c,h){var O;var f=i.get(l),m=l in a;if(s&&l==="length")for(var v=c;v<f.v;v+=1){var w=i.get(v+"");w!==void 0?I(w,Me):v in a&&(w=r(()=>Vt(Me)),i.set(v+"",w))}if(f===void 0)(!m||(O=di(a,l))!=null&&O.writable)&&(f=r(()=>Vt(void 0)),I(f,Ai(c)),i.set(l,f));else{m=f.v!==Me;var y=r(()=>Ai(c));I(f,y)}var b=Reflect.getOwnPropertyDescriptor(a,l);if(b!=null&&b.set&&b.set.call(h,c),!m){if(s&&typeof l=="string"){var P=i.get("length"),L=Number(l);Number.isInteger(L)&&L>=P.v&&I(P,L+1)}us(n)}return!0},ownKeys(a){d(n);var l=Reflect.ownKeys(a).filter(f=>{var m=i.get(f);return m===void 0||m.v!==Me});for(var[c,h]of i)h.v!==Me&&!(c in a)&&l.push(c);return l},setPrototypeOf(){yl()}})}var uo,br,kr,Tr;function Wl(){if(uo===void 0){uo=window,br=/Firefox/.test(navigator.userAgent);var e=Element.prototype,t=Node.prototype,i=Text.prototype;kr=di(t,"firstChild").get,Tr=di(t,"nextSibling").get,lo(e)&&(e.__click=void 0,e.__className=void 0,e.__attributes=null,e.__style=void 0,e.__e=void 0),lo(i)&&(i.__t=void 0)}}function wi(e=""){return document.createTextNode(e)}function Jt(e){return kr.call(e)}function Ls(e){return Tr.call(e)}function M(e,t){return Jt(e)}function ue(e,t=!1){{var i=Jt(e);return i instanceof Comment&&i.data===""?Ls(i):i}}function $(e,t=1,i=!1){let s=e;for(;t--;)s=Ls(s);return s}function Hl(e){e.textContent=""}function _r(){return!1}let fo=!1;function Bl(){fo||(fo=!0,document.addEventListener("reset",e=>{Promise.resolve().then(()=>{var t;if(!e.defaultPrevented)for(const i of e.target.elements)(t=i.__on_r)==null||t.call(i)})},{capture:!0}))}function dn(e){var t=Z,i=ie;Ue(null),Lt(null);try{return e()}finally{Ue(t),Lt(i)}}function Pr(e,t,i,s=i){e.addEventListener(t,()=>dn(i));const n=e.__on_r;n?e.__on_r=()=>{n(),s(!0)}:e.__on_r=()=>s(!0),Bl()}function Sr(e){ie===null&&(Z===null&&ml(),gl()),Ti&&pl()}function $l(e,t){var i=t.last;i===null?t.last=t.first=e:(i.next=e,e.prev=i,t.last=e)}function Mt(e,t,i,s=!0){var n=ie;n!==null&&(n.f&Ye)!==0&&(e|=Ye);var o={ctx:me,deps:null,nodes_start:null,nodes_end:null,f:e|ze|ft,first:null,fn:t,last:null,next:null,parent:n,b:n&&n.b,prev:null,teardown:null,transitions:null,wv:0,ac:null};if(i)try{Ui(o),o.f|=Yn}catch(l){throw Be(o),l}else t!==null&&mi(o);if(s){var r=o;if(i&&r.deps===null&&r.teardown===null&&r.nodes_start===null&&r.first===r.last&&(r.f&Gi)===0&&(r=r.first,(e&Ot)!==0&&(e&Bi)!==0&&r!==null&&(r.f|=Bi)),r!==null&&(r.parent=n,n!==null&&$l(r,n),Z!==null&&(Z.f&De)!==0&&(e&ki)===0)){var a=Z;(a.effects??(a.effects=[])).push(r)}}return o}function un(){return Z!==null&&!St}function fn(e){const t=Mt(an,null,!1);return Ce(t,Le),t.teardown=e,t}function In(e){Sr();var t=ie.f,i=!Z&&(t&It)!==0&&(t&Yn)===0;if(i){var s=me;(s.e??(s.e=[])).push(e)}else return Lr(e)}function Lr(e){return Mt(rn|rr,e,!1)}function jl(e){return Sr(),Mt(an|rr,e,!0)}function Vl(e){Dt.ensure();const t=Mt(ki|Gi,e,!0);return(i={})=>new Promise(s=>{i.outro?Oi(t,()=>{Be(t),s(void 0)}):(Be(t),s(void 0))})}function Ul(e){return Mt(rn,e,!1)}function zl(e,t){var i=me,s={effect:null,ran:!1,deps:e};i.l.$.push(s),s.effect=Xi(()=>{e(),!s.ran&&(s.ran=!0,N(t))})}function ql(){var e=me;Xi(()=>{for(var t of e.l.$){t.deps();var i=t.effect;(i.f&Le)!==0&&Ce(i,Et),Ki(i)&&Ui(i),t.ran=!1}})}function Jl(e){return Mt(Xn|Gi,e,!0)}function Xi(e,t=0){return Mt(an|t,e,!0)}function oe(e,t=[],i=[],s=[],n=!1){Al(s,t,i,o=>{Mt(n?rn:an,()=>e(...o.map(d)),!0)})}function Zn(e,t=0){var i=Mt(Ot|t,e,!0);return i}function ct(e,t=!0){return Mt(It|Gi,e,!0,t)}function Nr(e){var t=e.teardown;if(t!==null){const i=Ti,s=Z;go(!0),Ue(null);try{t.call(null)}finally{go(i),Ue(s)}}}function Cr(e,t=!1){var i=e.first;for(e.first=e.last=null;i!==null;){const n=i.ac;n!==null&&dn(()=>{n.abort(Mi)});var s=i.next;(i.f&ki)!==0?i.parent=null:Be(i,t),i=s}}function Gl(e){for(var t=e.first;t!==null;){var i=t.next;(t.f&It)===0&&Be(t),t=i}}function Be(e,t=!0){var i=!1;(t||(e.f&or)!==0)&&e.nodes_start!==null&&e.nodes_end!==null&&(Rr(e.nodes_start,e.nodes_end),i=!0),Cr(e,t&&!i),Us(e,0),Ce(e,Yt);var s=e.transitions;if(s!==null)for(const o of s)o.stop();Nr(e);var n=e.parent;n!==null&&n.first!==null&&Er(e),e.next=e.prev=e.teardown=e.ctx=e.deps=e.fn=e.nodes_start=e.nodes_end=e.ac=null}function Rr(e,t){for(;e!==null;){var i=e===t?null:Ls(e);e.remove(),e=i}}function Er(e){var t=e.parent,i=e.prev,s=e.next;i!==null&&(i.next=s),s!==null&&(s.prev=i),t!==null&&(t.first===e&&(t.first=s),t.last===e&&(t.last=i))}function Oi(e,t,i=!0){var s=[];eo(e,s,!0),Mr(s,()=>{i&&Be(e),t&&t()})}function Mr(e,t){var i=e.length;if(i>0){var s=()=>--i||t();for(var n of e)n.out(s)}else t()}function eo(e,t,i){if((e.f&Ye)===0){if(e.f^=Ye,e.transitions!==null)for(const r of e.transitions)(r.is_global||i)&&t.push(r);for(var s=e.first;s!==null;){var n=s.next,o=(s.f&Bi)!==0||(s.f&It)!==0&&(e.f&Ot)!==0;eo(s,t,o?i:!1),s=n}}}function to(e){Ar(e,!0)}function Ar(e,t){if((e.f&Ye)!==0){e.f^=Ye,(e.f&Le)===0&&(Ce(e,ze),mi(e));for(var i=e.first;i!==null;){var s=i.next,n=(i.f&Bi)!==0||(i.f&It)!==0;Ar(i,n?t:!1),i=s}if(e.transitions!==null)for(const o of e.transitions)(o.is_global||t)&&o.in()}}function Dr(e,t){for(var i=e.nodes_start,s=e.nodes_end;i!==null;){var n=i===s?null:Ls(i);t.append(i),i=n}}let fi=!1;function po(e){fi=e}let Ti=!1;function go(e){Ti=e}let Z=null,St=!1;function Ue(e){Z=e}let ie=null;function Lt(e){ie=e}let $e=null;function Yl(e){Z!==null&&($e===null?$e=[e]:$e.push(e))}let He=null,qe=0,Ze=null;function Xl(e){Ze=e}let Or=1,vs=0,pi=vs;function mo(e){pi=e}function Ir(){return++Or}function Ki(e){var t=e.f;if((t&ze)!==0)return!0;if(t&De&&(e.f&=~ms),(t&Et)!==0){var i=e.deps;if(i!==null)for(var s=i.length,n=0;n<s;n++){var o=i[n];if(Ki(o)&&wr(o),o.wv>e.wv)return!0}(t&ft)!==0&&ye===null&&Ce(e,Le)}return!1}function Fr(e,t,i=!0){var s=e.reactions;if(s!==null&&!($e!=null&&$e.includes(e)))for(var n=0;n<s.length;n++){var o=s[n];(o.f&De)!==0?Fr(o,t,!1):t===o&&(i?Ce(o,ze):(o.f&Le)!==0&&Ce(o,Et),mi(o))}}function Wr(e){var w;var t=He,i=qe,s=Ze,n=Z,o=$e,r=me,a=St,l=pi,c=e.f;He=null,qe=0,Ze=null,Z=(c&(It|ki))===0?e:null,$e=null,$i(e.ctx),St=!1,pi=++vs,e.ac!==null&&(dn(()=>{e.ac.abort(Mi)}),e.ac=null);try{e.f|=Rn;var h=e.fn,f=h(),m=e.deps;if(He!==null){var v;if(Us(e,qe),m!==null&&qe>0)for(m.length=qe+He.length,v=0;v<He.length;v++)m[qe+v]=He[v];else e.deps=m=He;if(fi&&un()&&(e.f&ft)!==0)for(v=qe;v<m.length;v++)((w=m[v]).reactions??(w.reactions=[])).push(e)}else m!==null&&qe<m.length&&(Us(e,qe),m.length=qe);if(Ss()&&Ze!==null&&!St&&m!==null&&(e.f&(De|Et|ze))===0)for(v=0;v<Ze.length;v++)Fr(Ze[v],e);return n!==null&&n!==e&&(vs++,Ze!==null&&(s===null?s=Ze:s.push(...Ze))),(e.f&Xt)!==0&&(e.f^=Xt),f}catch(y){return dr(y)}finally{e.f^=Rn,He=t,qe=i,Ze=s,Z=n,$e=o,$i(r),St=a,pi=l}}function Kl(e,t){let i=t.reactions;if(i!==null){var s=rl.call(i,e);if(s!==-1){var n=i.length-1;n===0?i=t.reactions=null:(i[s]=i[n],i.pop())}}i===null&&(t.f&De)!==0&&(He===null||!He.includes(t))&&(Ce(t,Et),(t.f&ft)!==0&&(t.f^=ft,t.f&=~ms),vr(t),Us(t,0))}function Us(e,t){var i=e.deps;if(i!==null)for(var s=t;s<i.length;s++)Kl(e,i[s])}function Ui(e){var t=e.f;if((t&Yt)===0){Ce(e,Le);var i=ie,s=fi;ie=e,fi=!0;try{(t&Ot)!==0?Gl(e):Cr(e),Nr(e);var n=Wr(e);e.teardown=typeof n=="function"?n:null,e.wv=Or;var o;er&&Ga&&(e.f&ze)!==0&&e.deps}finally{fi=s,ie=i}}}async function Ql(){await Promise.resolve(),Pl()}function d(e){var t=e.f,i=(t&De)!==0;if(Z!==null&&!St){var s=ie!==null&&(ie.f&Yt)!==0;if(!s&&!($e!=null&&$e.includes(e))){var n=Z.deps;if((Z.f&Rn)!==0)e.rv<vs&&(e.rv=vs,He===null&&n!==null&&n[qe]===e?qe++:He===null?He=[e]:He.includes(e)||He.push(e));else{(Z.deps??(Z.deps=[])).push(e);var o=e.reactions;o===null?e.reactions=[Z]:o.includes(Z)||o.push(Z)}}}if(Ti){if(Kt.has(e))return Kt.get(e);if(i){var r=e,a=r.v;return((r.f&Le)===0&&r.reactions!==null||Br(r))&&(a=Qn(r)),Kt.set(r,a),a}}else if(i){if(r=e,ye!=null&&ye.has(r))return ye.get(r);Ki(r)&&wr(r),fi&&un()&&(r.f&ft)===0&&Hr(r)}else if(ye!=null&&ye.has(e))return ye.get(e);if((e.f&Xt)!==0)throw e.v;return e.v}function Hr(e){if(e.deps!==null){e.f^=ft;for(const t of e.deps)(t.reactions??(t.reactions=[])).push(e),(t.f&De)!==0&&(t.f&ft)===0&&Hr(t)}}function Br(e){if(e.v===Me)return!0;if(e.deps===null)return!1;for(const t of e.deps)if(Kt.has(t)||(t.f&De)!==0&&Br(t))return!0;return!1}function N(e){var t=St;try{return St=!0,e()}finally{St=t}}const Zl=-7169;function Ce(e,t){e.f=e.f&Zl|t}function ve(e){if(!(typeof e!="object"||!e||e instanceof EventTarget)){if(ui in e)Fn(e);else if(!Array.isArray(e))for(let t in e){const i=e[t];typeof i=="object"&&i&&ui in i&&Fn(i)}}}function Fn(e,t=new Set){if(typeof e=="object"&&e!==null&&!(e instanceof EventTarget)&&!t.has(e)){t.add(e),e instanceof Date&&e.getTime();for(let s in e)try{Fn(e[s],t)}catch{}const i=Gn(e);if(i!==Object.prototype&&i!==Array.prototype&&i!==Map.prototype&&i!==Set.prototype&&i!==Date.prototype){const s=sr(i);for(let n in s){const o=s[n].get;if(o)try{o.call(e)}catch{}}}}}const ec=new Set,vo=new Set;function tc(e,t,i,s={}){function n(o){if(s.capture||cs.call(t,o),!o.cancelBubble)return dn(()=>i==null?void 0:i.call(this,o))}return e.startsWith("pointer")||e.startsWith("touch")||e==="wheel"?Yi(()=>{t.addEventListener(e,n,s)}):t.addEventListener(e,n,s),n}function S(e,t,i,s,n){var o={capture:s,passive:n},r=tc(e,t,i,o);(t===document.body||t===window||t===document||t instanceof HTMLMediaElement)&&fn(()=>{t.removeEventListener(e,r,o)})}let wo=null;function cs(e){var b;var t=this,i=t.ownerDocument,s=e.type,n=((b=e.composedPath)==null?void 0:b.call(e))||[],o=n[0]||e.target;wo=e;var r=0,a=wo===e&&e.__root;if(a){var l=n.indexOf(a);if(l!==-1&&(t===document||t===window)){e.__root=t;return}var c=n.indexOf(t);if(c===-1)return;l<=c&&(r=l)}if(o=n[r]||e.target,o!==t){ir(e,"currentTarget",{configurable:!0,get(){return o||i}});var h=Z,f=ie;Ue(null),Lt(null);try{for(var m,v=[];o!==null;){var w=o.assignedSlot||o.parentNode||o.host||null;try{var y=o["__"+s];y!=null&&(!o.disabled||e.target===o)&&y.call(o,e)}catch(P){m?v.push(P):m=P}if(e.cancelBubble||w===t||w===null)break;o=w}if(m){for(let P of v)queueMicrotask(()=>{throw P});throw m}}finally{e.__root=t,delete e.currentTarget,Ue(h),Lt(f)}}}function $r(e){var t=document.createElement("template");return t.innerHTML=e.replaceAll("<!>","<!---->"),t.content}function zs(e,t){var i=ie;i.nodes_start===null&&(i.nodes_start=e,i.nodes_end=t)}function j(e,t){var i=(t&sl)!==0,s=(t&nl)!==0,n,o=!e.startsWith("<!>");return()=>{n===void 0&&(n=$r(o?e:"<!>"+e),i||(n=Jt(n)));var r=s||br?document.importNode(n,!0):n.cloneNode(!0);if(i){var a=Jt(r),l=r.lastChild;zs(a,l)}else zs(r,r);return r}}function Ge(){var e=document.createDocumentFragment(),t=document.createComment(""),i=wi();return e.append(t,i),zs(t,i),e}function D(e,t){e!==null&&e.before(t)}const ic=["touchstart","touchmove"];function sc(e){return ic.includes(e)}function K(e,t){var i=t==null?"":typeof t=="object"?t+"":t;i!==(e.__t??(e.__t=e.nodeValue))&&(e.__t=i,e.nodeValue=i+"")}function jr(e,t){return nc(e,t)}const Ni=new Map;function nc(e,{target:t,anchor:i,props:s={},events:n,context:o,intro:r=!0}){Wl();var a=new Set,l=f=>{for(var m=0;m<f.length;m++){var v=f[m];if(!a.has(v)){a.add(v);var w=sc(v);t.addEventListener(v,cs,{passive:w});var y=Ni.get(v);y===void 0?(document.addEventListener(v,cs,{passive:w}),Ni.set(v,1)):Ni.set(v,y+1)}}};l(Jn(ec)),vo.add(l);var c=void 0,h=Vl(()=>{var f=i??t.appendChild(wi());return Cl(f,{pending:()=>{}},m=>{if(o){le({});var v=me;v.c=o}n&&(s.$$events=n),c=e(m,s)||{},o&&ce()}),()=>{var w;for(var m of a){t.removeEventListener(m,cs);var v=Ni.get(m);--v===0?(document.removeEventListener(m,cs),Ni.delete(m)):Ni.set(m,v)}vo.delete(l),f!==i&&((w=f.parentNode)==null||w.removeChild(f))}});return oc.set(c,h),c}let oc=new WeakMap;var lt,_t,Je,_s,Ps,sn;class rc{constructor(t,i=!0){yt(this,"anchor");te(this,lt,new Map);te(this,_t,new Map);te(this,Je,new Map);te(this,_s,!0);te(this,Ps,()=>{var t=he;if(x(this,lt).has(t)){var i=x(this,lt).get(t),s=x(this,_t).get(i);if(s)to(s);else{var n=x(this,Je).get(i);n&&(x(this,_t).set(i,n.effect),x(this,Je).delete(i),n.fragment.lastChild.remove(),this.anchor.before(n.fragment),s=n.effect)}for(const[o,r]of x(this,lt)){if(x(this,lt).delete(o),o===t)break;const a=x(this,Je).get(r);a&&(Be(a.effect),x(this,Je).delete(r))}for(const[o,r]of x(this,_t)){if(o===i)continue;const a=()=>{if(Array.from(x(this,lt).values()).includes(o)){var c=document.createDocumentFragment();Dr(r,c),c.append(wi()),x(this,Je).set(o,{effect:r,fragment:c})}else Be(r);x(this,_t).delete(o)};x(this,_s)||!s?Oi(r,a,!1):a()}}});te(this,sn,t=>{x(this,lt).delete(t);const i=Array.from(x(this,lt).values());for(const[s,n]of x(this,Je))i.includes(s)||(Be(n.effect),x(this,Je).delete(s))});this.anchor=t,X(this,_s,i)}ensure(t,i){var s=he,n=_r();if(i&&!x(this,_t).has(t)&&!x(this,Je).has(t))if(n){var o=document.createDocumentFragment(),r=wi();o.append(r),x(this,Je).set(t,{effect:ct(()=>i(r)),fragment:o})}else x(this,_t).set(t,ct(()=>i(this.anchor)));if(x(this,lt).set(s,t),n){for(const[a,l]of x(this,_t))a===t?s.skipped_effects.delete(l):s.skipped_effects.add(l);for(const[a,l]of x(this,Je))a===t?s.skipped_effects.delete(l.effect):s.skipped_effects.add(l.effect);s.oncommit(x(this,Ps)),s.ondiscard(x(this,sn))}else x(this,Ps).call(this)}}lt=new WeakMap,_t=new WeakMap,Je=new WeakMap,_s=new WeakMap,Ps=new WeakMap,sn=new WeakMap;function fe(e){me===null&&ul(),Ji&&me.l!==null?ac(me).m.push(e):In(()=>{const t=N(e);if(typeof t=="function")return t})}function ac(e){var t=e.l;return t.u??(t.u={a:[],b:[],m:[]})}function ge(e,t,i=!1){var s=new rc(e),n=i?Bi:0;function o(r,a){s.ensure(r,a)}Zn(()=>{var r=!1;t((a,l=!0)=>{r=!0,o(l,a)}),r||o(!1,null)},n)}function dt(e,t){return t}function lc(e,t,i){for(var s=e.items,n=[],o=t.length,r=0;r<o;r++)eo(t[r].e,n,!0);var a=o>0&&n.length===0&&i!==null;if(a){var l=i.parentNode;Hl(l),l.append(i),s.clear(),xt(e,t[0].prev,t[o-1].next)}Mr(n,()=>{for(var c=0;c<o;c++){var h=t[c];a||(s.delete(h.k),xt(e,h.prev,h.next)),Be(h.e,!a)}})}function ut(e,t,i,s,n,o=null){var r=e,a={flags:t,items:new Map,first:null},l=(t&Zo)!==0;if(l){var c=e;r=c.appendChild(wi())}var h=null,f=!1,m=new Map,v=Kn(()=>{var P=i();return tr(P)?P:P==null?[]:Jn(P)}),w,y;function b(){cc(y,w,a,m,r,n,t,s,i),o!==null&&(w.length===0?h?to(h):h=ct(()=>o(r)):h!==null&&Oi(h,()=>{h=null}))}Zn(()=>{y??(y=ie),w=d(v);var P=w.length;if(!(f&&P===0)){f=P===0;var L,O,R,T;if(_r()){var E=new Set,z=he;for(O=0;O<P;O+=1){R=w[O],T=s(R,O);var re=a.items.get(T)??m.get(T);re?(t&(nn|on))!==0&&Vr(re,R,O,t):(L=Ur(null,a,null,null,R,T,O,n,t,i,!0),m.set(T,L)),E.add(T)}for(const[xe,q]of a.items)E.has(xe)||z.skipped_effects.add(q.e);z.oncommit(b)}else b();d(v)}})}function cc(e,t,i,s,n,o,r,a,l){var Xe,F,Y,se;var c=(r&Xa)!==0,h=(r&(nn|on))!==0,f=t.length,m=i.items,v=i.first,w=v,y,b=null,P,L=[],O=[],R,T,E,z;if(c)for(z=0;z<f;z+=1)R=t[z],T=a(R,z),E=m.get(T),E!==void 0&&((Xe=E.a)==null||Xe.measure(),(P??(P=new Set)).add(E));for(z=0;z<f;z+=1){if(R=t[z],T=a(R,z),E=m.get(T),E===void 0){var re=s.get(T);if(re!==void 0){s.delete(T),m.set(T,re);var xe=b?b.next:w;xt(i,b,re),xt(i,re,xe),Pn(re,xe,n),b=re}else{var q=w?w.e.nodes_start:n;b=Ur(q,i,b,b===null?i.first:b.next,R,T,z,o,r,l)}m.set(T,b),L=[],O=[],w=b.next;continue}if(h&&Vr(E,R,z,r),(E.e.f&Ye)!==0&&(to(E.e),c&&((F=E.a)==null||F.unfix(),(P??(P=new Set)).delete(E))),E!==w){if(y!==void 0&&y.has(E)){if(L.length<O.length){var G=O[0],ne;b=G.prev;var _e=L[0],Se=L[L.length-1];for(ne=0;ne<L.length;ne+=1)Pn(L[ne],G,n);for(ne=0;ne<O.length;ne+=1)y.delete(O[ne]);xt(i,_e.prev,Se.next),xt(i,b,_e),xt(i,Se,G),w=G,b=Se,z-=1,L=[],O=[]}else y.delete(E),Pn(E,w,n),xt(i,E.prev,E.next),xt(i,E,b===null?i.first:b.next),xt(i,b,E),b=E;continue}for(L=[],O=[];w!==null&&w.k!==T;)(w.e.f&Ye)===0&&(y??(y=new Set)).add(w),O.push(w),w=w.next;if(w===null)continue;E=w}L.push(E),b=E,w=E.next}if(w!==null||y!==void 0){for(var ke=y===void 0?[]:Jn(y);w!==null;)(w.e.f&Ye)===0&&ke.push(w),w=w.next;var V=ke.length;if(V>0){var ae=(r&Zo)!==0&&f===0?n:null;if(c){for(z=0;z<V;z+=1)(Y=ke[z].a)==null||Y.measure();for(z=0;z<V;z+=1)(se=ke[z].a)==null||se.fix()}lc(i,ke,ae)}}c&&Yi(()=>{var ot;if(P!==void 0)for(E of P)(ot=E.a)==null||ot.apply()}),e.first=i.first&&i.first.e,e.last=b&&b.e;for(var pe of s.values())Be(pe.e);s.clear()}function Vr(e,t,i,s){(s&nn)!==0&&Vi(e.v,t),(s&on)!==0?Vi(e.i,i):e.i=i}function Ur(e,t,i,s,n,o,r,a,l,c,h){var f=(l&nn)!==0,m=(l&Ka)===0,v=f?m?U(n,!1,!1):vi(n):n,w=(l&on)===0?r:vi(r),y={i:w,v,k:o,a:null,e:null,prev:i,next:s};try{if(e===null){var b=document.createDocumentFragment();b.append(e=wi())}return y.e=ct(()=>a(e,v,w,c),Tl),y.e.prev=i&&i.e,y.e.next=s&&s.e,i===null?h||(t.first=y):(i.next=y,i.e.next=y.e),s!==null&&(s.prev=y,s.e.prev=y.e),y}finally{}}function Pn(e,t,i){for(var s=e.next?e.next.e.nodes_start:i,n=t?t.e.nodes_start:i,o=e.e.nodes_start;o!==null&&o!==s;){var r=Ls(o);n.before(o),o=r}}function xt(e,t,i){t===null?e.first=i:(t.next=i,t.e.next=i&&i.e),i!==null&&(i.prev=t,i.e.prev=t&&t.e)}function yo(e,t,i=!1,s=!1,n=!1){var o=e,r="";oe(()=>{var a=ie;if(r!==(r=t()??"")&&(a.nodes_start!==null&&(Rr(a.nodes_start,a.nodes_end),a.nodes_start=a.nodes_end=null),r!=="")){var l=r+"";i?l=`<svg>${l}</svg>`:s&&(l=`<math>${l}</math>`);var c=$r(l);if((i||s)&&(c=Jt(c)),zs(Jt(c),c.lastChild),i||s)for(;Jt(c);)o.before(Jt(c));else o.before(c)}})}function zr(e,t,i,s,n){var a;var o=(a=t.$$slots)==null?void 0:a[i],r=!1;o===!0&&(o=t.children,r=!0),o===void 0||o(e,r?()=>s:s)}function qr(e){var t,i,s="";if(typeof e=="string"||typeof e=="number")s+=e;else if(typeof e=="object")if(Array.isArray(e)){var n=e.length;for(t=0;t<n;t++)e[t]&&(i=qr(e[t]))&&(s&&(s+=" "),s+=i)}else for(i in e)e[i]&&(s&&(s+=" "),s+=i);return s}function hc(){for(var e,t,i=0,s="",n=arguments.length;i<n;i++)(e=arguments[i])&&(t=qr(e))&&(s&&(s+=" "),s+=t);return s}function dc(e){return typeof e=="object"?hc(e):e??""}function uc(e,t,i){var s=e==null?"":""+e;return t&&(s=s?s+" "+t:t),s===""?null:s}function fc(e,t){return e==null?null:String(e)}function ws(e,t,i,s,n,o){var r=e.__className;if(r!==i||r===void 0){var a=uc(i,s);a==null?e.removeAttribute("class"):e.className=a,e.__className=i}return o}function pt(e,t,i,s){var n=e.__style;if(n!==t){var o=fc(t);o==null?e.removeAttribute("style"):e.style.cssText=o,e.__style=t}return s}const pc=Symbol("is custom element"),gc=Symbol("is html");function ee(e,t,i,s){var n=mc(e);n[t]!==(n[t]=i)&&(t==="loading"&&(e[dl]=i),i==null?e.removeAttribute(t):typeof i!="string"&&vc(e).includes(t)?e[t]=i:e.setAttribute(t,i))}function mc(e){return e.__attributes??(e.__attributes={[pc]:e.nodeName.includes("-"),[gc]:e.namespaceURI===ol})}var xo=new Map;function vc(e){var t=e.getAttribute("is")||e.nodeName,i=xo.get(t);if(i)return i;xo.set(t,i=[]);for(var s,n=e,o=Element.prototype;o!==n;){s=sr(n);for(var r in s)s[r].set&&i.push(r);n=Gn(n)}return i}function Ns(e,t,i=t){var s=new WeakSet;Pr(e,"input",async n=>{var o=n?e.defaultValue:e.value;if(o=Sn(e)?Ln(o):o,i(o),he!==null&&s.add(he),await Ql(),o!==(o=t())){var r=e.selectionStart,a=e.selectionEnd,l=e.value.length;if(e.value=o??"",a!==null){var c=e.value.length;r===a&&a===l&&c>l?(e.selectionStart=c,e.selectionEnd=c):(e.selectionStart=r,e.selectionEnd=Math.min(a,c))}}}),N(t)==null&&e.value&&(i(Sn(e)?Ln(e.value):e.value),he!==null&&s.add(he)),Xi(()=>{var n=t();if(e===document.activeElement){var o=Ds??he;if(s.has(o))return}Sn(e)&&n===Ln(e.value)||e.type==="date"&&!n&&!e.value||n!==e.value&&(e.value=n??"")})}function wc(e,t,i=t){Pr(e,"change",s=>{var n=s?e.defaultChecked:e.checked;i(n)}),N(t)==null&&i(e.checked),Xi(()=>{var s=t();e.checked=!!s})}function Sn(e){var t=e.type;return t==="number"||t==="range"}function Ln(e){return e===""?null:+e}function Ee(e,t,i){var s=di(e,t);s&&s.set&&(e[t]=i,fn(()=>{e[t]=null}))}function bo(e,t){return e===t||(e==null?void 0:e[ui])===t}function Ne(e={},t,i,s){return Ul(()=>{var n,o;return Xi(()=>{n=o,o=[],N(()=>{e!==i(...o)&&(t(e,...o),n&&bo(i(...n),e)&&t(null,...n))})}),()=>{Yi(()=>{o&&bo(i(...o),e)&&t(null,...o)})}}),e}function de(e=!1){const t=me,i=t.l.u;if(!i)return;let s=()=>ve(t.s);if(e){let n=0,o={};const r=hn(()=>{let a=!1;const l=t.s;for(const c in l)l[c]!==o[c]&&(o[c]=l[c],a=!0);return a&&n++,n});s=()=>d(r)}i.b.length&&jl(()=>{ko(t,s),Cn(i.b)}),In(()=>{const n=N(()=>i.m.map(cl));return()=>{for(const o of n)typeof o=="function"&&o()}}),i.a.length&&In(()=>{ko(t,s),Cn(i.a)})}function ko(e,t){if(e.l.s)for(const i of e.l.s)d(i);t()}function Jr(e,t,i){if(e==null)return t(void 0),Di;const s=N(()=>e.subscribe(t,i));return s.unsubscribe?()=>s.unsubscribe():s}const Ci=[];function yc(e,t=Di){let i=null;const s=new Set;function n(a){if(lr(e,a)&&(e=a,i)){const l=!Ci.length;for(const c of s)c[1](),Ci.push(c,e);if(l){for(let c=0;c<Ci.length;c+=2)Ci[c][0](Ci[c+1]);Ci.length=0}}}function o(a){n(a(e))}function r(a,l=Di){const c=[a,l];return s.add(c),s.size===1&&(i=t(n,o)||Di),a(e),()=>{s.delete(c),s.size===0&&i&&(i(),i=null)}}return{set:n,update:o,subscribe:r}}function xc(e){let t;return Jr(e,i=>t=i)(),t}let Es=!1,Wn=Symbol();function bc(e,t,i){const s=i[t]??(i[t]={store:null,source:U(void 0),unsubscribe:Di});if(s.store!==e&&!(Wn in i))if(s.unsubscribe(),s.store=e??null,e==null)s.source.v=void 0,s.unsubscribe=Di;else{var n=!0;s.unsubscribe=Jr(e,o=>{n?s.source.v=o:I(s.source,o)}),n=!1}return e&&Wn in i?xc(e):d(s.source)}function kc(){const e={};function t(){fn(()=>{for(var i in e)e[i].unsubscribe();ir(e,Wn,{enumerable:!1,value:!0})})}return[e,t]}function Tc(e){var t=Es;try{return Es=!1,[e(),Es]}finally{Es=t}}function J(e,t,i,s){var O;var n=!Ji||(i&Za)!==0,o=(i&tl)!==0,r=(i&il)!==0,a=s,l=!0,c=()=>(l&&(l=!1,a=r?N(s):s),a),h;if(o){var f=ui in e||hl in e;h=((O=di(e,t))==null?void 0:O.set)??(f&&t in e?R=>e[t]=R:void 0)}var m,v=!1;o?[m,v]=Tc(()=>e[t]):m=e[t];var w;if(n?w=()=>{var R=e[t];return R===void 0?c():(l=!0,R)}:w=()=>{var R=e[t];return R!==void 0&&(a=void 0),R===void 0?a:R},n&&(i&el)===0)return w;if(h){var y=e.$$legacy;return(function(R,T){return arguments.length>0?((!n||!T||y||v)&&h(T?w():R),R):w()})}var b=!1,P=((i&Qa)!==0?hn:Kn)(()=>(b=!1,w()));o&&d(P);var L=ie;return(function(R,T){if(arguments.length>0){const E=T?d(P):n&&o?Ai(R):R;return I(P,E),b=!0,a!==void 0&&(a=E),R}return Ti&&b||(L.f&Yt)!==0?P.v:d(P)})}const ht=[];function _c(e){return ht.length=0,ht.push({icon:"sell",text:"change name",state:"enabled",action:e.nameDialog}),ht.push({icon:"note_add",text:"new file",state:"enabled",action:t=>tx.send("name request",{label:"new file",value:"",regex:Path.regex.file,pos:{x:t.clientX,y:t.clientY},ok:i=>e.newFile(i),cancel:()=>{}})}),ht.push({icon:"create_new_folder",text:"new folder",state:"enabled",action:t=>tx.send("name request",{label:"new folder",value:"",regex:Path.regex.vizPath,pos:{x:t.clientX,y:t.clientY},ok:i=>e.newFolder(i),cancel:()=>{}})}),ht.push({icon:"folder_off",text:"remove folder",state:"enabled",action:t=>tx.send("message",{title:"Confirm removal",message:`Remove ${e.getPath()} from drawer ?`,pos:{x:t.clientX,y:t.clientY},ok:()=>e.remove(),cancel:()=>{}})}),ht.push({icon:"delete",text:"delete folder",state:"enabled",action:t=>tx.send("message",{title:"Confirm delete",message:`Delete ${e.getPath()} ?`,pos:{x:t.clientX,y:t.clientY},ok:()=>e.remove(),cancel:()=>{}})}),ht}function Pc(e){return ht.length=0,ht.push({icon:"sell",text:"change name",state:"enabled",action:t=>tx.send("name request",{label:"Name ",value:this.name,regex:/^[\w,-]+$/,pos:{x:t.clientX,y:t.clientY},ok:i=>this.rename(i),cancel:()=>{}})}),ht.push({icon:"delete",text:"delete file",state:"enabled",action:t=>tx.send("message",{title:"Confirm delete",message:`Delete ${this.getPath()} ?`,pos:{x:t.clientX,y:t.clientY},ok:()=>this.remove(),cancel:()=>{}})}),ht}var Sc=j('<i class="material-icons-outlined folder-icon svelte-cdx8zl"> </i> <span class="fldr-name svelte-cdx8zl" draggable="true"> </span> <!>',1),Lc=j('<li class="dir svelte-cdx8zl"><!></li>'),Nc=j('<li class="file svelte-cdx8zl"><i> </i> <span draggable="true"> </span></li>'),Cc=j('<div class="file-dir-list svelte-cdx8zl"><!> <!></div>');function Hn(e,t){le(t,!1);let i=J(t,"folder",12),s=J(t,"tx",8),n=U();fe(()=>{i().name!==""&&B(n,d(n).style.margin="0rem 0rem 0rem 1.2rem")});async function o(m){var y,b;let v=m.target.dataset.fldrindex??((b=(y=m.target.parentNode)==null?void 0:y.dataset)==null?void 0:b.fldrindex);if(!v)return;let w=i().folders[+v];w.is.expanded=!w.is.expanded,w.is.expanded&&w.is.stale&&(await w.update(),w.is.stale=!1),i(i())}function r(m){var y;const v=(y=m.target.parentNode.dataset)==null?void 0:y.fileindex;if(!v)return;const w=i().files[+v].arl;s().send("file selected",w)}function a(m){var b;m.preventDefault(),m.stopPropagation();const v=(b=m.target.parentNode.dataset)==null?void 0:b.fldrindex,w=i().folders[+v];if(!w)return;const y=_c(w);s().send("folder context menu",{menu:y,event:m})}function l(m){var b;m.preventDefault(),m.stopPropagation();const v=(b=m.target.parentNode.dataset)==null?void 0:b.fileindex;if(!i().files[+v])return;const y=Pc();s().send("file context menu",{menu:y,event:m})}de();var c=Cc(),h=M(c);ut(h,1,()=>(ve(i()),N(()=>i().folders)),dt,(m,v,w)=>{var y=Lc();ee(y,"data-fldrindex",w);var b=M(y);{var P=O=>{Hn(O,{get folder(){return d(v)},get tx(){return s()}})},L=O=>{var R=Sc(),T=ue(R),E=M(T),z=$(T,2),re=M(z),xe=$(z,2);{var q=G=>{Hn(G,{get folder(){return d(v)},get tx(){return s()}})};ge(xe,G=>{d(v),N(()=>d(v).is.expanded)&&G(q)})}oe(()=>{K(E,(d(v),N(()=>d(v).is.expanded?"folder_open":"folder"))),K(re,(d(v),N(()=>d(v).name)))}),S("click",T,o),S("click",z,o),D(O,R)};ge(b,O=>{d(v),N(()=>d(v).parent===null)?O(P):O(L,!1)})}S("contextmenu",y,a),D(m,y)});var f=$(h,2);ut(f,1,()=>(ve(i()),N(()=>i().files)),dt,(m,v,w)=>{var y=Nc();ee(y,"data-fileindex",w);var b=M(y),P=M(b),L=$(b,2),O=M(L);oe((R,T,E)=>{ws(b,1,R,"svelte-cdx8zl"),K(P,T),ws(L,1,E,"svelte-cdx8zl"),K(O,(d(v),N(()=>d(v).name)))},[()=>(d(v),N(()=>"material-icons-outlined file-icon "+d(v).getFileClass())),()=>(d(v),N(()=>d(v).getIcon())),()=>(d(v),N(()=>"file-name "+d(v).getFileClass()))]),S("click",b,r),S("click",L,r),S("contextmenu",y,l),D(m,y)}),Ne(c,m=>I(n,m),()=>d(n)),D(e,c),ce()}var Rc=j('<p class="no-selection svelte-qhgjoh">Examples could not be mounted.</p>'),Ec=j('<div class="workspace svelte-qhgjoh"><div class="heading svelte-qhgjoh"><h1 class="svelte-qhgjoh">Examples</h1> <div class="menu-item svelte-qhgjoh"><i class="material-icons-outlined svelte-qhgjoh"> </i> <div class="tooltip svelte-qhgjoh"> </div></div></div> <div class="file-system svelte-qhgjoh"><!></div> <!></div>');function Mc(e,t){le(t,!1);let i=J(t,"tx",8),s=U(),n=U();const o=window.location.origin,r="/examples/file-system.json";let a=U(null);fe(async()=>{i().send("dom workspace div",d(s)),l(),h()});function l(){document.addEventListener("visibilitychange",q=>{q.preventDefault()})}const c={onDomAddModalDiv(q){d(s).append(q)},onFileSavedAs(q){},onFileActive(q){},onFileClosed(q){}};async function h(){I(a,new Qo("fixed"));const q=new Gt(r);q.url=new URL(r,o);const G=await q.get("json");if(!G)return;const ne=new Gt("");ne.url=new URL(o);const _e=ne.resolve("/"+G.name);B(a,d(a).root=new js(_e,d(a))),B(a,d(a).root.is.expanded=!0),f(G,d(a).root)}function f(q,G){if(q.folders)for(const ne of q.folders){const _e=G.arl.getPath()+"/"+ne.name,Se=G.arl.resolve(_e),ke=new js(Se,G);G.folders.push(ke),f(ne,ke)}if(q.files)for(const ne of q.files){const _e=G.arl.resolve(G.arl.getPath()+"/"+ne),Se=new qn(_e,G);G.files.push(Se)}}function m(){d(a)&&(d(a).root.is.expanded?d(a).collapse():d(a).expand(),I(a,d(a)))}var v={handlers:c};de();var w=Ec(),y=M(w),b=$(M(y),2),P=M(b),L=M(P),O=$(P,2),R=M(O),T=$(y,2),E=M(T);{var z=q=>{Hn(q,{get folder(){return d(a),N(()=>d(a).root)},get tx(){return i()}})},re=q=>{var G=Rc();D(q,G)};ge(E,q=>{d(a),N(()=>{var G;return(G=d(a))==null?void 0:G.root})?q(z):q(re,!1)})}Ne(T,q=>I(n,q),()=>d(n));var xe=$(T,2);return ge(xe,q=>{}),Ne(w,q=>I(s,q),()=>d(s)),oe(()=>{K(L,(d(a),N(()=>{var q,G;return(G=(q=d(a))==null?void 0:q.root)!=null&&G.is.expanded?"unfold_less":"unfold_more"}))),K(R,(d(a),N(()=>{var q,G;return(G=(q=d(a))==null?void 0:q.root)!=null&&G.is.expanded?"collapse all":"expand all"})))}),S("click",P,m),D(e,w),Ee(t,"handlers",c),ce(v)}function Ac(e,t){const i=document.createElement("div");return jr(Mc,{target:i,props:{tx:e,sx:t}}).handlers}var Dc=j('<div class="main svelte-ai1hu1"><div class="tabs svelte-ai1hu1"></div> <div class="content svelte-ai1hu1"></div></div>');function Oc(e,t){le(t,!1);let i=J(t,"tx",8),s=U(),n=U(),o=U(),r=null;fe(async()=>{});const a={onContentDiv(m){d(n).replaceChildren(m),r&&d(n).append(r),i().send("div",d(s))},onMenuDiv(m){r=m,d(n).append(r)},onTabsDiv(m){d(o).replaceChildren(m)},onModalDiv(m){d(s).append(m)},onSizeChange({id:m,rect:v}){const w=Math.floor(d(n).clientWidth),y=Math.floor(d(n).clientHeight);i().send("content size change",{x:0,y:0,w,h:y})},onShow(){i().send("div",d(s))}};var l={handlers:a};de();var c=Dc(),h=M(c);Ne(h,m=>I(o,m),()=>d(o));var f=$(h,2);return Ne(f,m=>I(n,m),()=>d(n)),Ne(c,m=>I(s,m),()=>d(s)),D(e,c),Ee(t,"handlers",a),ce(l)}var Ic=j('<div class="column-main-layout svelte-1496us"><div class="left-column svelte-1496us"></div> <div class="separator svelte-1496us"></div> <div class="main-area svelte-1496us"></div></div>');function Fc(e,t){le(t,!1);let i=J(t,"tx",8),s=U(),n=U(),o=U(),r=U(),a=U(0),l=!1,c=null,h;const f=.12,m=160,v=320,w=1024,y=typeof window<"u",b=V=>y&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(V):setTimeout(()=>V(Date.now()),16),P=V=>{if(V!==null){if(y&&typeof window.cancelAnimationFrame=="function"){window.cancelAnimationFrame(V);return}clearTimeout(V)}},L=()=>{c===null&&(c=b(()=>{c=null,xe()}))},O=V=>{var ot;const ae=y?window.innerWidth:w,pe=((ot=d(s))==null?void 0:ot.clientWidth)??ae??V;if(!pe)return V;const Xe=Math.max(pe-v,80),F=Math.min(m,Xe),Y=Math.max(pe-v,F),se=Math.min(Math.max(V,F),Y);return Number.isFinite(se)?se:F},R=()=>{var V;l&&(l=!1,y&&(window.removeEventListener("pointermove",T),window.removeEventListener("pointerup",E)),(V=d(r))==null||V.classList.remove("dragging"),xe())},T=V=>{if(!l||!d(s))return;const{left:ae}=d(s).getBoundingClientRect(),pe=O(V.clientX-ae);pe!==d(a)&&(I(a,pe),L())},E=()=>R(),z=V=>{var ae;V.preventDefault(),l=!0,(ae=d(r))==null||ae.classList.add("dragging"),y&&(window.addEventListener("pointermove",T),window.addEventListener("pointerup",E))},re=()=>{I(a,O(d(a))),L()},xe=()=>{if(!d(o)||!i())return;const V=d(o).getBoundingClientRect(),ae={rect:{x:0,y:0,w:Math.floor(V.width),h:Math.floor(V.height)}};i().send("size change",ae)};fe(()=>{var pe;const V=y?window.innerWidth:w,ae=((pe=d(s))==null?void 0:pe.clientWidth)??V??0;return I(a,O(ae*f||m)),y&&window.addEventListener("resize",re),typeof ResizeObserver<"u"&&(h=new ResizeObserver(()=>L()),d(o)&&h.observe(d(o))),L(),()=>{y&&window.removeEventListener("resize",re),R(),h==null||h.disconnect(),c!==null&&(P(c),c=null)}});const q={onLeftColumn(V){var ae;(ae=d(n))==null||ae.replaceChildren(V)},onMainArea(V){d(o)&&(d(o).replaceChildren(V),V.width=Math.floor(d(o).clientWidth),V.height=Math.floor(d(o).clientHeight),xe())}};var G={handlers:q};de();var ne=Ic(),_e=M(ne);Ne(_e,V=>I(n,V),()=>d(n));var Se=$(_e,2);Ne(Se,V=>I(r,V),()=>d(r));var ke=$(Se,2);return Ne(ke,V=>I(o,V),()=>d(o)),Ne(ne,V=>I(s,V),()=>d(s)),oe(()=>pt(_e,`width:${d(a)}px;flex-basis:${d(a)}px;`)),S("pointerdown",Se,z),D(e,ne),Ee(t,"handlers",q),ce(G)}var Wc=j('<div class="tab selected svelte-18p7ldm"> <input class="button svelte-18p7ldm" type="button"/> <div class="full-name svelte-18p7ldm"> </div></div>'),Hc=j('<div class="tab svelte-18p7ldm"> <input class="button svelte-18p7ldm" type="button"/> <div class="full-name svelte-18p7ldm"> </div></div>'),Bc=j('<div class="tab-ribbon svelte-18p7ldm"></div>');function $c(e,t){le(t,!1);let i=J(t,"tx",8);fe(()=>{i().send("div",d(s).div)});let s=U({div:null,selected:-1,tabs:[]});const n={onTabNew(h){B(s,d(s).selected=d(s).tabs.push(h)-1),I(s,d(s))},onTabRemove(h){const f=d(s).tabs,m=f.length;for(let v=0;v<m;v++)if(f[v]==h){if(m>1)for(let w=v;w<m-1;w++)f[w]=f[w+1];f.pop();break}I(s,d(s))},onTabRename({oldName:h,newName:f}){const m=d(s).tabs,v=m.findIndex(w=>w==h);v>=0&&(m[v]=f),I(s,d(s))},onTabSelect(h){const m=d(s).tabs.findIndex(v=>v==h);m>=0&&B(s,d(s).selected=m),I(s,d(s))}};function o(h){const f=h.target.getAttribute("data-index");f<0||f>=d(s).tabs.length||i().send("tab request to select",d(s).tabs[f])}function r(h){h.stopPropagation();const f=h.target.parentNode.getAttribute("data-index");f<0||f>=d(s).tabs.length||i().send("tab request to close",d(s).tabs[f])}function a(h){}var l={handlers:n};de();var c=Bc();return ut(c,5,()=>(d(s),N(()=>d(s).tabs)),dt,(h,f,m)=>{var v=Ge(),w=ue(v);{var y=P=>{var L=Wc();ee(L,"data-index",m);var O=M(L),R=$(O),T=$(R,2),E=M(T);oe(()=>{K(O,`${d(f)??""} `),pt(T,`width: ${d(f),N(()=>d(f).length*.5)??""}rem;`),K(E,d(f))}),S("click",R,r),S("keydown",R,a),S("click",L,o),S("keydown",L,a),D(P,L)},b=P=>{var L=Hc();ee(L,"data-index",m);var O=M(L),R=$(O),T=$(R,2),E=M(T);oe(()=>{K(O,`${d(f)??""} `),pt(T,`width: ${d(f),N(()=>d(f).length*.5)??""}rem;`),K(E,d(f))}),S("click",R,r),S("keydown",R,a),S("click",L,o),S("keydown",L,a),D(P,L)};ge(w,P=>{d(s),N(()=>m==d(s).selected)?P(y):P(b,!1)})}D(h,v)}),Ne(c,h=>B(s,d(s).div=h),()=>{var h;return(h=d(s))==null?void 0:h.div}),D(e,c),Ee(t,"handlers",n),ce(l)}var jc=j('<div class="menu-item svelte-sk4hi"><i class="material-icons-outlined icon svelte-sk4hi"> </i> <div class="tooltip svelte-sk4hi"> </div></div>'),Vc=j('<div class="menu svelte-sk4hi"></div>');function Uc(e,t){le(t,!1);let i=J(t,"tx",8),s=J(t,"sx",8),n=U(),o=U(s());fe(()=>{i().send("div",d(n))});const r={"-> set menu"(f){I(o,f)}};function a(f){var v;const m=f.target.getAttribute("data-index");((v=d(o)[m].message)==null?void 0:v.length)>0&&i().send(d(o)[m].message,f)}function l(f){}var c={handlers:r};de();var h=Vc();return ut(h,5,()=>d(o),dt,(f,m,v)=>{var w=jc(),y=M(w);ee(y,"data-index",v);var b=M(y),P=$(y,2),L=M(P);oe(()=>{pt(y,`color: ${d(m),N(()=>d(m).color)??""};`),K(b,(d(m),N(()=>d(m).icon))),pt(P,`width: ${d(m),N(()=>d(m).help.length*.5)??""}rem;`),K(L,(d(m),N(()=>d(m).help)))}),S("click",y,a),S("keydown",y,l),D(f,w)}),Ne(h,f=>I(n,f),()=>d(n)),D(e,h),Ee(t,"handlers",r),ce(c)}function zc(){return localStorage.getItem("vmblu-theme")||"dark"}const Gr=yc(zc());Gr.subscribe(e=>{localStorage.setItem("vmblu-theme",e)});var qc=j('<i class="material-icons-outlined open svelte-6k9ztc">description</i>'),Jc=j('<i class="material-icons-outlined open svelte-6k9ztc">add_circle</i>'),Gc=j('<div class="right-icons svelte-6k9ztc"><i class="material-icons-outlined trash svelte-6k9ztc">delete</i></div>'),Yc=j('<div><div class="hdr svelte-6k9ztc"><div class="left-icons svelte-6k9ztc"><i class="material-icons-outlined cancel svelte-6k9ztc">cancel</i> <i class="material-icons-outlined check svelte-6k9ztc">check_circle</i> <!> <!></div> <h1 class="svelte-6k9ztc"> </h1> <!></div> <!></div>');function wt(e,t){le(t,!1);const i=()=>bc(Gr,"$theme",s),[s,n]=kc();let o=J(t,"box",12),r,a,l,c,h=!1;fe(()=>{o(o().show=w,!0),o(o().hide=y,!0),o(o().update=()=>o(o()),!0)});function f(F){r=F.clientX,a=F.clientY,l=o().div.offsetLeft,c=o().div.offsetTop,h=!0,document.addEventListener("mousemove",m),document.addEventListener("mouseup",v)}function m(F){if(h){const Y=F.clientX-r,se=F.clientY-a;o(o().div.style.left=`${l+Y}px`,!0),o(o().div.style.top=`${c+se}px`,!0)}}function v(F){h=!1,document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",v)}function w(F){F||(F=o().pos),F&&(o(o().div.style.left=`${F.x}px`,!0),o(o().div.style.top=`${F.y}px`,!0)),o(o().div.style.display="block",!0),o(o())}function y(){o(o().div.style.display="none",!0)}function b(F){var Y,se;y(),(se=(Y=o()).cancel)==null||se.call(Y,F)}function P(F){var Y,se;y(),(se=(Y=o()).ok)==null||se.call(Y,F)}function L(F){var Y,se;(se=(Y=o()).open)==null||se.call(Y,F)}function O(F){var Y,se;(se=(Y=o()).add)==null||se.call(Y,F)}function R(F){var Y,se;y(),(se=(Y=o()).trash)==null||se.call(Y,F)}function T(F){return F.stopPropagation(),F.key=="Enter"?P(F):F.key=="Escape"||F.key=="Esc"?b(F):null}de();var E=Yc(),z=M(E),re=M(z),xe=M(re),q=$(xe,2),G=$(q,2);{var ne=F=>{var Y=qc();S("click",Y,L),S("keydown",Y,T),D(F,Y)};ge(G,F=>{ve(o()),N(()=>o().open)&&F(ne)})}var _e=$(G,2);{var Se=F=>{var Y=Jc();S("click",Y,O),S("keydown",Y,T),D(F,Y)};ge(_e,F=>{ve(o()),N(()=>o().add)&&F(Se)})}var ke=$(re,2),V=M(ke),ae=$(ke,2);{var pe=F=>{var Y=Gc(),se=M(Y);S("click",se,R),S("keydown",se,T),D(F,Y)};ge(ae,F=>{ve(o()),N(()=>o().trash)&&F(pe)})}var Xe=$(z,2);zr(Xe,t,"default",{}),Ne(E,F=>o(o().div=F,!0),()=>{var F;return(F=o())==null?void 0:F.div}),oe(()=>{ws(E,1,`main ${i()??""}`,"svelte-6k9ztc"),K(V,(ve(o()),N(()=>o().title)))}),S("click",xe,b),S("keydown",xe,T),S("click",q,P),S("keydown",q,T),S("mousedown",z,f),S("keydown",E,T),D(e,E),ce(),n()}var Xc=j('<div class="same-line svelte-1s2wqkj"><!></div>');function To(e,t){var i=Xc(),s=M(i);zr(s,t,"default",{}),D(e,i)}var Kc=j('<label class="label svelte-1hdmeto"> </label>');function _o(e,t){let i=J(t,"text",8),s=J(t,"style",8);var n=Kc(),o=M(n);oe(()=>{pt(n,s()?s():""),K(o,i())}),D(e,n)}var Qc=j('<input class="grow svelte-1p6z9d0" type="text" spellcheck="false"/>');function Yr(e,t){le(t,!1);let i=J(t,"text",12),s=J(t,"check",8),n=J(t,"style",8),o=U(),r=null;const a="#ff0000";fe(()=>{r=d(o).style.color});function l(h){B(o,d(o).style.width="0px"),B(o,d(o).style.width=d(o).scrollWidth>100?d(o).scrollWidth+2+"px":"100px"),s()&&B(o,d(o).style.color=s()(d(o).value)?r:a)}de();var c=Qc();Ne(c,h=>I(o,h),()=>d(o)),oe(()=>pt(c,n()?n():"")),Ns(c,i),S("input",c,l),D(e,c),ce()}var Zc=j('<input type="checkbox" class="svelte-ywsl3b"/>');function Po(e,t){le(t,!1);let i=J(t,"style",8),s=J(t,"on",12),n=J(t,"onToggle",8);fe(()=>{});function o(a){var l;(l=n())==null||l(s())}de();var r=Zc();oe(()=>pt(r,i()?i():"")),wc(r,s),S("input",r,o),D(e,r),ce()}var eh=j("<!> <!>",1),th=j("<!> <!> <!>",1),ih=j("<!> <!>",1);function sh(e,t){le(t,!1);let i=J(t,"tx",8);fe(()=>{i().send("modal div",d(s).div)});const s=U({div:null,pos:null,title:"",ok:null,cancel:null}),n=U({logMessages:!1,worker:{on:!1,path:""}}),o={"-> show"({title:l,pos:c,rx:h,ok:f,cancel:m}){B(s,d(s).title=l),B(s,d(s).pos={...c}),B(s,d(s).ok=v=>{f&&f(d(n))}),B(s,d(s).cancel=()=>{m==null||m()}),h&&(B(n,d(n).logMessages=h.logMessages),B(n,d(n).worker.on=h.worker.on),B(n,d(n).worker.path=h.worker.path)),d(s).show(d(s).pos)}};function r(l){}var a={handlers:o};return de(),wt(e,{get box(){return d(s)},children:(l,c)=>{var h=ih(),f=ue(h);To(f,{children:(v,w)=>{var y=eh(),b=ue(y);Po(b,{get on(){return d(n),N(()=>d(n).logMessages)},onToggle:r});var P=$(b,2);_o(P,{text:"log messages"}),D(v,y)},$$slots:{default:!0}});var m=$(f,2);To(m,{children:(v,w)=>{var y=th(),b=ue(y);Po(b,{get field(){return d(n),N(()=>d(n).worker.on)}});var P=$(b,2);_o(P,{text:"use worker script:",style:"margin-right: 0.5rem;"});var L=$(P,2);Yr(L,{get field(){return d(n),N(()=>d(n).worker.path)}}),D(v,y)},$$slots:{default:!0}}),D(l,h)},$$slots:{default:!0}}),Ee(t,"handlers",o),ce(a)}function nh(e,t){le(t,!1);let i=J(t,"tx",8);fe(async()=>{i().send("modal div",d(s).div)});const s=U({div:null,pos:null,title:"",ok:null,cancel:null}),n={"-> show"({title:r,message:a,pos:l,ok:c,cancel:h}){B(s,d(s).title=r),B(s,d(s).ok=c),B(s,d(s).cancel=h),d(s).show(l)}};var o={handlers:n};return de(),wt(e,{get box(){return d(s)}}),Ee(t,"handlers",n),ce(o)}var oh=j('<li><i> </i> <span class="choice-text svelte-cldbb7"> </span> <span class="choice-char svelte-cldbb7"> </span></li>'),rh=j('<div class="svelte-cldbb7"><ul class="svelte-cldbb7"></ul></div>');function ah(e,t){le(t,!1);let i=J(t,"tx",8),s=U({div:null,menu:[],show:()=>{}});fe(()=>{B(s,d(s).show=o),i().send("modal div",d(s).div)});const n={"-> context menu"({menu:w,event:y}){B(s,d(s).menu=w),d(s).show(y)}};function o(w){d(s).menu.length<=0||(r(),B(s,d(s).div.style.display="block"),B(s,d(s).div.style.left=`${w.clientX-10}px`),B(s,d(s).div.style.top=`${w.clientY-20}px`),I(s,d(s)))}function r(){let w=0;d(s).menu.forEach(y=>{const b=y.text.length+(y.char?y.char.length+5:0);b>w&&(w=b)}),d(s).div.querySelector("ul").style.width=(.5*w+1.5).toString()+"rem"}function a(w){B(s,d(s).div.style.display="none")}function l(w){w.preventDefault(),B(s,d(s).div.style.display="none")}function c(w){B(s,d(s).div.style.display="none");let y=w.target.dataset.index??w.target.parentNode.dataset.index;d(s).menu[y]&&d(s).menu[y].state=="enabled"&&d(s).menu[y].action(w)}function h(w){}var f={handlers:n};de();var m=rh(),v=M(m);return ut(v,5,()=>(d(s),N(()=>d(s).menu)),dt,(w,y,b)=>{var P=oh();ee(P,"data-index",b);var L=M(P),O=M(L),R=$(L,2),T=M(R),E=$(R,2),z=M(E);oe(()=>{ws(P,1,dc((d(y),N(()=>d(y).state))),"svelte-cldbb7"),ws(L,1,`material-icons-outlined choice-icon ${d(y),N(()=>d(y).state)??""}`,"svelte-cldbb7"),K(O,(d(y),N(()=>d(y).icon))),K(T,(d(y),N(()=>d(y).text))),K(z,(d(y),N(()=>d(y).char??" ")))}),S("click",P,c),S("keydown",P,h),D(w,P)}),Ne(m,w=>B(s,d(s).div=w),()=>{var w;return(w=d(s))==null?void 0:w.div}),S("mouseleave",v,a),S("click",m,a),S("contextmenu",m,l),S("keydown",m,h),D(e,m),Ee(t,"handlers",n),ce(f)}var lh=j('<textarea name="txt-name" spellcheck="false" class="svelte-4j1bxw"></textarea>');function Xr(e,t){le(t,!1);let i=J(t,"text",12),s=J(t,"cols",8),n=J(t,"rows",8);fe(()=>{});function o(a){a.key!="Escape"&&a.key!="Esc"&&a.stopPropagation()}de();var r=lh();oe(()=>{ee(r,"rows",n()),ee(r,"cols",s())}),Ns(r,i),S("keydown",r,o),D(e,r),ce()}function ch(e,t){le(t,!1);let i=J(t,"tx",8);fe(async()=>{i().send("modal div",d(s).div)});let s=U({div:null,pos:null,title:"",ok:null,cancel:null}),n=U("");const o={"-> json"({title:l,pos:c,json:h,ok:f}){B(s,d(s).title=l),B(s,d(s).pos={...c}),B(s,d(s).ok=()=>{const m=r();if((m==null?void 0:m.length)==0)return f?f(""):null;m?f==null||f(m):d(s).show(c)}),I(n,h?JSON.stringify(h,null,"  "):""),d(s).show(c)}};function r(){let l=d(n).indexOf("SyntaxError");if(l!=-1&&I(n,l>1?d(n).slice(0,l-2):""),d(n).length==0)return"";try{return JSON.parse(d(n))}catch(c){return I(n,d(n)+`

`+c),null}}var a={handlers:o};return de(),wt(e,{get box(){return d(s)},children:(l,c)=>{Xr(l,{cols:"50",rows:"25",get text(){return d(n)},set text(h){I(n,h)},$$legacy:!0})},$$slots:{default:!0}}),Ee(t,"handlers",o),ce(a)}function hh(e,t){le(t,!1);let i=J(t,"tx",8),s=U({div:null,pos:null,title:"",ok:null,cancel:null});fe(()=>{i().send("modal div",d(s).div)});let n=U("");const o={"-> text"({header:a,pos:l,text:c,ok:h=null,cancel:f=null}){B(s,d(s).title=a),B(s,d(s).ok=()=>{h==null||h(d(n))}),I(n,c),d(s).show(l)}};var r={handlers:o};return de(),wt(e,{get box(){return d(s)},children:(a,l)=>{Xr(a,{cols:"50",rows:"25",get text(){return d(n)},set text(c){I(n,c)},$$legacy:!0})},$$slots:{default:!0}}),Ee(t,"handlers",o),ce(r)}var dh=j('<p class="svelte-90r4b4"> </p>'),uh=j('<div class="handler svelte-90r4b4"><p class="svelte-90r4b4"><span class="clickable svelte-90r4b4"> </span> </p></div> <div class="params svelte-90r4b4"></div> <div class="prompt svelte-90r4b4"><pre class="svelte-90r4b4"> </pre></div>',1),fh=j('<div class="profile svelte-90r4b4"><!></div>');function So(e,t){le(t,!1);let i=J(t,"profile",8),s=J(t,"open",8);function n(l){l.key!="Escape"&&l.key!="Esc"&&l.stopPropagation()}de();var o=fh(),r=M(o);{var a=l=>{var c=uh(),h=ue(c),f=M(h),m=M(f),v=M(m),w=$(m),y=$(h,2);ut(y,5,()=>(ve(i()),N(()=>i().params)),dt,(O,R)=>{let T=()=>d(R).type,E=()=>d(R).name,z=()=>d(R).description;var re=dh(),xe=M(re);oe(()=>K(xe,`${E()??""} (${T()??""}) ${z()??""}`)),D(O,re)});var b=$(y,2),P=M(b),L=M(P);oe(()=>{K(v,(ve(i()),N(()=>i().handler))),K(w,`  in ${ve(i()),N(()=>i().file)??""} (${ve(i()),N(()=>i().line)??""})`),K(L,(ve(i()),N(()=>i().summary)))}),S("click",m,()=>{var O;return(O=s())==null?void 0:O({file:i().file,line:i().line})}),S("keydown",m,n),D(l,c)};ge(r,l=>{i()!=null&&l(a)})}D(e,o),ce()}var ph=j('<div class="transmit svelte-19tsd"><p class="svelte-19tsd"><span class="clickable svelte-19tsd"> </span> </p></div>'),gh=j('<div class="profile svelte-19tsd"><!></div>');function Lo(e,t){le(t,!1);let i=J(t,"profile",8),s=J(t,"open",8);function n(l){l.key!="Escape"&&l.key!="Esc"&&l.stopPropagation()}de();var o=gh(),r=M(o);{var a=l=>{var c=ph(),h=M(c),f=M(h),m=M(f),v=$(f);oe(()=>{K(m,(ve(i()),N(()=>i().pin))),K(v,` ${ve(i()),N(()=>i().file)??""} (${ve(i()),N(()=>i().line)??""})`)}),S("click",f,()=>{var w;return(w=s())==null?void 0:w({file:i().file,line:i().line})}),S("keydown",f,n),D(l,c)};ge(r,l=>{i()!=null&&l(a)})}D(e,o),ce()}var mh=j('<div class="pin svelte-1q31bqr"><p class="svelte-1q31bqr">Handlers and parameters</p></div> <!>',1),vh=j('<div class="pin svelte-1q31bqr"><p class="svelte-1q31bqr">Handler and parameters:</p></div> <!>',1),wh=j('<div class="pin svelte-1q31bqr"><p class="svelte-1q31bqr">Send locactions</p></div> <!>',1);function yh(e,t){le(t,!1);let i=J(t,"tx",8),s=U({div:null,pos:null,title:"",ok:null,cancel:null});fe(()=>{i().send("modal div",d(s).div)});let n=U(null),o=U(null),r=U(null);const a={"-> show"({pos:c,pin:h,profile:f,open:m=null}){B(s,d(s).title=h.is.left?(h.is.input?"  ":"  ")+h.name:h.name+(h.is.input?"  ":"  ")),I(o,h),I(n,f),I(r,m),d(s).show(c)}};var l={handlers:a};return de(),wt(e,{get box(){return d(s)},children:(c,h)=>{var f=Ge(),m=ue(f);{var v=y=>{var b=Ge(),P=ue(b);{var L=R=>{var T=mh(),E=$(ue(T),2);ut(E,1,()=>d(n),dt,(z,re)=>{So(z,{get profile(){return d(re)},get open(){return d(r)}})}),D(R,T)},O=R=>{var T=vh(),E=$(ue(T),2);So(E,{get profile(){return d(n)},get open(){return d(r)}}),D(R,T)};ge(P,R=>{d(n),N(()=>Array.isArray(d(n)))?R(L):R(O,!1)})}D(y,b)},w=y=>{var b=wh(),P=$(ue(b),2);{var L=R=>{var T=Ge(),E=ue(T);ut(E,1,()=>d(n),dt,(z,re)=>{Lo(z,{get profile(){return d(re)},get open(){return d(r)}})}),D(R,T)},O=R=>{Lo(R,{get profile(){return d(n)},get open(){return d(r)}})};ge(P,R=>{d(n),N(()=>Array.isArray(d(n)))?R(L):R(O,!1)})}D(y,b)};ge(m,y=>{d(o),N(()=>{var b;return(b=d(o))==null?void 0:b.is.input})?y(v):y(w,!1)})}D(c,f)},$$slots:{default:!0}}),Ee(t,"handlers",a),ce(l)}var xh=j('<p class="svelte-sxqikf"> </p>');function bh(e,t){le(t,!1);let i=J(t,"tx",8),s={div:null,pos:null,title:"",ok:null,cancel:null},n=U("");fe(async()=>{i().send("modal div",s.div)});const o={"-> show"({title:a,message:l,pos:c,ok:h,cancel:f}){const m=this.popup.box;m.title=a,I(n,l),m.show(c)}};var r={handlers:o};return de(),wt(e,{get box(){return s},children:(a,l)=>{var c=xh(),h=M(c);oe(()=>K(h,d(n))),D(a,c)},$$slots:{default:!0}}),Ee(t,"handlers",o),ce(r)}var kh=j('<div class="input-field svelte-1c2zphc"><label class="svelte-1c2zphc"> </label> <input type="text" spellcheck="false" class="svelte-1c2zphc"/></div>');function qs(e,t){le(t,!1);let i=J(t,"label",8),s=J(t,"input",12),n=J(t,"style",8),o=J(t,"check",8),r=U(),a="f"+Math.floor((1+Math.random())*65536).toString(16).substring(1);const l=()=>{B(r,d(r).style.width="0px"),B(r,d(r).style.width=d(r).scrollWidth+2+"px")};let c=null;const h="#ff0000";fe(()=>{c=d(r).style.color,l()});function f(b){l(),o()&&B(r,d(r).style.color=o()(b.target.value)?c:h)}zl(()=>d(r),()=>{d(r)&&l()}),ql(),de();var m=kh(),v=M(m),w=M(v),y=$(v,2);Ne(y,b=>I(r,b),()=>d(r)),oe(()=>{ee(v,"for",a),pt(v,n()),K(w,i()),ee(y,"id",a)}),Ns(y,s),S("input",y,f),S("click",y,f),D(e,m),ce()}var Th=j("<!> <!>",1);function _h(e,t){le(t,!1);let i=J(t,"tx",8),s=U({div:null,pos:null,title:"",ok:null,cancel:null}),n=U(""),o=U(""),r="";function a(h){var f;return r?(f=r.test)==null?void 0:f.call(r,h):!0}fe(()=>{i().send("modal div",d(s).div)});const l={onNameAndPath({title:h,pos:f,name:m,path:v,regex:w,ok:y,cancel:b,open:P,trash:L}){B(s,d(s).title=h),B(s,d(s).pos={...f}),B(s,d(s).ok=()=>{y==null||y(d(n),d(o))}),B(s,d(s).cancel=b?()=>b():null),B(s,d(s).open=O=>{P==null||P(d(n),d(o)),d(s).hide()}),B(s,d(s).trash=L?()=>L():null),I(n,m),I(o,v),r=w,d(s).show(f)}};var c={handlers:l};return de(),wt(e,{get box(){return d(s)},children:(h,f)=>{var m=Th(),v=ue(m);qs(v,{label:"Name",style:"width: 3rem;",check:null,get input(){return d(n)},set input(y){I(n,y)},$$legacy:!0});var w=$(v,2);qs(w,{label:"Path",style:"width: 3rem;",check:a,get input(){return d(o)},set input(y){I(o,y)},$$legacy:!0}),D(h,m)},$$slots:{default:!0}}),Ee(t,"handlers",l),ce(c)}function Ph(e,t){le(t,!1);let i=J(t,"tx",8),s=U({div:null,pos:null,title:"",ok:null,cancel:null}),n=U();function o(l){return!0}fe(()=>{i().send("modal div",d(s).div)});const r={"-> path"({title:l,path:c,pos:h,ok:f,cancel:m}){B(s,d(s).title=l),B(s,d(s).pos={...h}),B(s,d(s).ok=f?()=>f(d(n)):null),B(s,d(s).cancel=m?()=>m():null),I(n,c),d(s).show()}};var a={handlers:r};return de(),wt(e,{get box(){return d(s)},children:(l,c)=>{qs(l,{label:"Path :",style:"width: 2rem;",check:o,get input(){return d(n)},set input(h){I(n,h)},$$legacy:!0})},$$slots:{default:!0}}),Ee(t,"handlers",r),ce(a)}function Sh(e,t){le(t,!1);let i=J(t,"tx",8),s=U({div:null,pos:null,title:"",ok:null,cancel:null}),n=U("");fe(()=>{i().send("modal div",d(s).div)});const o={"-> show"({label:a,value:l,pos:c,ok:h,cancel:f}){B(s,d(s).title=a),B(s,d(s).pos={...c}),B(s,d(s).ok=h?()=>h(d(n)):null),B(s,d(s).cancel=f?()=>f():null),I(n,l),d(s).show(d(s).pos)}};var r={handlers:o};return de(),wt(e,{get box(){return d(s)},children:(a,l)=>{Yr(a,{style:null,check:null,get text(){return d(n)},set text(c){I(n,c)},$$legacy:!0})},$$slots:{default:!0}}),Ee(t,"handlers",o),ce(r)}var Lh=j('<div class="input-field svelte-91i3te"><label class="svelte-91i3te"> </label> <input type="text" spellcheck="false" readonly="" class="svelte-91i3te"/></div>');function Ms(e,t){le(t,!1);let i=J(t,"label",8),s=J(t,"info",12),n=J(t,"style",8),o="f"+Math.floor((1+Math.random())*65536).toString(16).substring(1);fe(()=>{}),de();var r=Lh(),a=M(r),l=M(a),c=$(a,2);oe(()=>{ee(a,"for",o),pt(a,n()),K(l,i()),ee(c,"id",o)}),Ns(c,s),D(e,r),ce()}var Nh=j('<div class="color-field svelte-1uxeram"><label class="svelte-1uxeram"> </label> <input type="color" class="svelte-1uxeram"/></div>');function Ch(e,t){le(t,!1);let i=J(t,"label",8),s=J(t,"style",8),n=J(t,"color",12),o=J(t,"onColor",8),r=U(),a="f"+Math.floor((1+Math.random())*65536).toString(16).substring(1);fe(()=>{});function l(v){var w;(w=o())==null||w(n())}de();var c=Nh(),h=M(c),f=M(h),m=$(h,2);Ne(m,v=>I(r,v),()=>d(r)),oe(()=>{ee(h,"for",a),pt(h,s()),K(f,i()),ee(m,"id",a)}),Ns(m,n),S("input",m,l),D(e,c),ce()}var Rh=j("<!> <!> <!> <!> <!> <!>",1);function Eh(e,t){le(t,!1);let i=J(t,"tx",8),s=U({div:null,pos:null,title:"",ok:null,cancel:null}),n=U(),o=U(),r=U(),a=U(),l=U(),c=U(),h=U();fe(()=>{i().send("modal div",d(s).div)});const f={"-> show"({title:v,path:w,settings:y,pos:b,ok:P,cancel:L,onColor:O}){B(s,d(s).title=v),B(s,d(s).pos={...b}),B(s,d(s).ok=P?()=>P(d(c)):null),B(s,d(s).cancel=L?()=>L():null),I(n,w),I(r,y.version),I(o,y.created),I(a,y.saved),I(c,y.runtime),I(l,y.style.rgb),I(h,O),d(s).show(b)}};var m={handlers:f};return de(),wt(e,{get box(){return d(s)},children:(v,w)=>{var y=Rh(),b=ue(y);Ms(b,{label:"File:",style:"width: 6rem;",get info(){return d(n)}});var P=$(b,2);Ms(P,{label:"Vmblu Version:",style:"width: 6rem;",get info(){return d(r)}});var L=$(P,2);Ms(L,{label:"Creation Date:",style:"width: 6rem;",get info(){return d(o)}});var O=$(L,2);Ms(O,{label:"Last Saved:",style:"width: 6rem;",get info(){return d(a)}});var R=$(O,2);qs(R,{label:"Runtime",style:"width: 6rem;",check:null,get input(){return d(c)},set input(E){I(c,E)},$$legacy:!0});var T=$(R,2);Ch(T,{label:"Node Color:",style:"width: 6rem;",get color(){return d(l)},get onColor(){return d(h)}}),D(v,y)},$$slots:{default:!0}}),Ee(t,"handlers",f),ce(m)}const Ri=20;function ti(e){return e}function Kr(e){this.tx=e,this.cols=[],this.xyLocal={x:0,y:0}}Kr.prototype={init(e){this.cols=[];let t=0,i=Ri;for(const s of e.values()){if(!s.is.selectable||!s.raw)return;const n=s.raw.root.nodes?s.raw.root.nodes.length:1;n>i&&i<Ri&&(t++,i=Ri),i-=n}for(t++;t-- >0;)this.cols.push([])},fill(e){const t=this.cols;let i=0,s=Ri;for(const n of e.values()){if(!n.is.selectable||!n.raw)return;const o=n.raw.root.nodes?n.raw.root.nodes.length:1;if(o>s&&s<Ri&&(i++,s=Ri),s-=o,t[i].push({nextModel:!0,model:n,expanded:!0}),n.raw.root.nodes)for(const r of n.raw.root.nodes)t[i].push({model:n,node:r,expanded:!1});else t[i].push({model:n,node:n.raw.root,expanded:!1})}},onRemoveLib(e){var n,o,r;const t=(n=e.target.parentNode.dataset)==null?void 0:n.col,i=(o=e.target.parentNode.dataset)==null?void 0:o.node,s=(r=this.cols[t])==null?void 0:r[i];s!=null&&s.nextModel&&this.tx.send("remove file",{model:s.model})},addLib(e){const t={x:e.screenX,y:e.screenY};this.tx.send("get path",{title:"add file to node library",path:null,pos:t,ok:i=>{this.tx.send("add file",i)},cancel:null})},onSelect(e,t){var h,f,m;t.hide();const i=(h=e.target.parentNode.dataset)==null?void 0:h.col,s=(f=e.target.parentNode.dataset)==null?void 0:f.node,n=(m=e.target.parentNode.dataset)==null?void 0:m.sub,o=this.cols[i][s].model;let r="",a=this.cols[i][s].node;if(n&&(r=a.group,a=a.nodes.find((v,w)=>w==n)),!a)return;const l=a.source??a.group??a.dock,c=r.length==0?l:r+"|"+l;this.tx.send("selected node",{model:o,nodePath:c,xyLocal:this.xyLocal})},onArrowClick(e){var s,n;const t=(s=e.target.parentNode.dataset)==null?void 0:s.col,i=(n=e.target.parentNode.dataset)==null?void 0:n.node;this.cols[t][i].expanded=!this.cols[t][i].expanded}};var Mh=j('<i class="material-icons-outlined lib lib-js svelte-19avbiy">cancel</i> <p class="lib lib-js svelte-19avbiy"> </p>',1),Ah=j('<i class="material-icons-outlined lib lib-json svelte-19avbiy">cancel</i> <p class="lib lib-json svelte-19avbiy"> </p>',1),Dh=j('<div class="arl svelte-19avbiy"><!></div>'),Oh=j('<p class="node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">factory</i> <span class="node-name svelte-19avbiy"> </span></p>'),Ih=j('<p class="node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">factory</i> <span class="node-name svelte-19avbiy"> </span></p>'),Fh=j('<p class="sub-node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">factory</i> <span class="node-name svelte-19avbiy"> </span></p>'),Wh=j('<p class="sub-node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">account_tree</i> <span class="node-name svelte-19avbiy"> </span></p>'),Hh=j('<p class="sub-node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">account_tree</i> <span class="node-name svelte-19avbiy"> </span></p>'),Bh=j('<p class="node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">account_tree</i> <span class="node-name svelte-19avbiy"> </span> <span class="arrow svelte-19avbiy"><!></span></p> <!>',1),$h=j('<p class="node svelte-19avbiy"><i class="material-icons-outlined icon svelte-19avbiy">account_tree</i> <span class="node-name svelte-19avbiy"> </span> <span class="arrow svelte-19avbiy"><!></span></p>'),jh=j('<div class="column svelte-19avbiy"></div>'),Vh=j('<div class="content svelte-19avbiy"></div>');function Uh(e,t){le(t,!1);let i=J(t,"tx",8),s=U(new Kr(i()));const n="&#9656;",o="&#9662;";let r={div:null,title:"Select Node",pos:null,ok:null,cancel:null,add:v=>d(s).addLib(v)};fe(async()=>{i().send("modal div",r.div)});const a={onBuildTable(v){var w;d(s).init(v),d(s).fill(v),((w=r.div)==null?void 0:w.style.display)=="block"&&I(s,d(s))},onShow({xyScreen:v,xyLocal:w}){B(s,d(s).xyLocal.x=w.x),B(s,d(s).xyLocal.y=w.y),r.show({x:v.x+10,y:v.y+10})}};function l(v){}function c(v){d(s).onRemoveLib(v),I(s,d(s))}function h(v){d(s).onSelect(v,r),I(s,d(s))}function f(v){d(s).onArrowClick(v),I(s,d(s))}var m={handlers:a};return de(),wt(e,{get box(){return r},children:(v,w)=>{var y=Vh();ut(y,5,()=>(d(s),N(()=>d(s).cols)),dt,(b,P,L)=>{var O=jh();ut(O,5,()=>d(P),dt,(R,T,E)=>{var z=Ge(),re=ue(z);{var xe=G=>{var ne=Dh();ee(ne,"data-col",L),ee(ne,"data-node",E);var _e=M(ne);{var Se=V=>{var ae=Mh(),pe=ue(ae),Xe=$(pe,2),F=M(Xe);oe(Y=>K(F,Y),[()=>(d(T),N(()=>d(T).model.arl.getName()))]),S("click",pe,c),S("keydown",pe,l),D(V,ae)},ke=V=>{var ae=Ah(),pe=ue(ae),Xe=$(pe,2),F=M(Xe);oe(Y=>K(F,Y),[()=>(d(T),N(()=>d(T).model.arl.getName()))]),S("click",pe,c),S("keydown",pe,l),D(V,ae)};ge(_e,V=>{d(T),N(()=>{var ae;return((ae=d(T).model.arl)==null?void 0:ae.getExt())==="js"})?V(Se):V(ke,!1)})}D(G,ne)},q=G=>{var ne=Ge(),_e=ue(ne);{var Se=ke=>{var V=Ge(),ae=ue(V);{var pe=F=>{var Y=Oh();ee(Y,"data-col",L),ee(Y,"data-node",E);var se=M(Y),ot=$(se,2),gn=M(ot);oe(Ft=>K(gn,Ft),[()=>(ve(ti),d(T),N(()=>d(T).node.source))]),S("click",se,h),S("keydown",se,l),S("click",ot,h),S("keydown",ot,l),D(F,Y)},Xe=F=>{var Y=Ge(),se=ue(Y);{var ot=Ft=>{var Qt=Ih();ee(Qt,"data-col",L),ee(Qt,"data-node",E);var Zi=M(Qt),es=$(Zi,2),ts=M(es);oe(Cs=>K(ts,Cs),[()=>(ve(ti),d(T),N(()=>d(T).node.dock))]),S("click",Zi,h),S("keydown",Zi,l),S("click",es,h),S("keydown",es,l),D(Ft,Qt)},gn=Ft=>{var Qt=Ge(),Zi=ue(Qt);{var es=ts=>{var Cs=Ge(),ya=ue(Cs);{var xa=_i=>{var Zt=Bh(),Wt=ue(Zt);ee(Wt,"data-col",L),ee(Wt,"data-node",E);var Ht=M(Wt),Pi=$(Ht,2),is=M(Pi),ss=$(Pi,2),mn=M(ss);yo(mn,()=>o);var ka=$(Wt,2);ut(ka,1,()=>(d(T),N(()=>d(T).node.nodes)),dt,(vn,Ke,wn)=>{var no=Ge(),Ta=ue(no);{var _a=Si=>{var Bt=Fh();ee(Bt,"data-col",L),ee(Bt,"data-node",E),ee(Bt,"data-sub",wn);var ns=M(Bt),os=$(ns,2),yn=M(os);oe($t=>K(yn,$t),[()=>(ve(ti),d(Ke),N(()=>d(Ke).source))]),S("click",ns,h),S("keydown",ns,l),S("click",os,h),S("keydown",os,l),D(Si,Bt)},Pa=Si=>{var Bt=Ge(),ns=ue(Bt);{var os=$t=>{var jt=Wh();ee(jt,"data-col",L),ee(jt,"data-node",E),ee(jt,"data-sub",wn);var rs=M(jt),as=$(rs,2),ls=M(as);oe(ei=>K(ls,ei),[()=>(ve(ti),d(Ke),N(()=>d(Ke).group))]),S("click",rs,h),S("keydown",rs,l),S("click",as,h),S("keydown",as,l),D($t,jt)},yn=$t=>{var jt=Ge(),rs=ue(jt);{var as=ls=>{var ei=Hh();ee(ei,"data-col",L),ee(ei,"data-node",E),ee(ei,"data-sub",wn);var xn=M(ei),bn=$(xn,2),Sa=M(bn);oe(La=>K(Sa,La),[()=>(ve(ti),d(Ke),N(()=>d(Ke).dock))]),S("click",xn,h),S("keydown",xn,l),S("click",bn,h),S("keydown",bn,l),D(ls,ei)};ge(rs,ls=>{d(Ke),N(()=>d(Ke).dock)&&ls(as)},!0)}D($t,jt)};ge(ns,$t=>{d(Ke),N(()=>d(Ke).group)?$t(os):$t(yn,!1)},!0)}D(Si,Bt)};ge(Ta,Si=>{d(Ke),N(()=>d(Ke).source)?Si(_a):Si(Pa,!1)})}D(vn,no)}),oe(vn=>K(is,vn),[()=>(ve(ti),d(T),N(()=>d(T).node.group))]),S("click",Ht,h),S("keydown",Ht,l),S("click",Pi,f),S("keydown",Pi,l),S("click",ss,f),S("keydown",ss,l),D(_i,Zt)},ba=_i=>{var Zt=$h();ee(Zt,"data-col",L),ee(Zt,"data-node",E);var Wt=M(Zt),Ht=$(Wt,2),Pi=M(Ht),is=$(Ht,2),ss=M(is);yo(ss,()=>n),oe(mn=>K(Pi,mn),[()=>(ve(ti),d(T),N(()=>d(T).node.group))]),S("click",Wt,h),S("keydown",Wt,l),S("click",Ht,f),S("keydown",Ht,l),S("click",is,f),S("keydown",is,l),D(_i,Zt)};ge(ya,_i=>{d(T),N(()=>d(T).expanded)?_i(xa):_i(ba,!1)})}D(ts,Cs)};ge(Zi,ts=>{d(T),N(()=>d(T).node.group)&&ts(es)},!0)}D(Ft,Qt)};ge(se,Ft=>{d(T),N(()=>d(T).node.dock)?Ft(ot):Ft(gn,!1)},!0)}D(F,Y)};ge(ae,F=>{d(T),N(()=>d(T).node.source)?F(pe):F(Xe,!1)})}D(ke,V)};ge(_e,ke=>{d(T),N(()=>d(T).node)&&ke(Se)},!0)}D(G,ne)};ge(re,G=>{d(T),N(()=>d(T).nextModel)?G(xe):G(q,!1)})}D(R,z)}),D(b,O)}),D(v,y)},$$slots:{default:!0}}),Ee(t,"handlers",a),ce(m)}function Oe(e,t=null){return function(i,s){return jr(e,{target:t??document.createElement("div"),props:{tx:i,sx:s}}).handlers}}const zh=Oe(Oc),qh=Oe(Fc,document.body),Jh=Oe($c),Gh=Oe(Uc),Yh=Oe(sh),Xh=Oe(nh),No=Oe(ah),Kh=Oe(ch),Qh=Oe(hh),Zh=Oe(yh),ed=Oe(bh),td=Oe(_h),Co=Oe(Ph),id=Oe(Sh),sd=Oe(Eh),nd=Oe(Uh),W={_roundedRect(e,t,i,s,n,o){e.moveTo(t,i+o),e.arcTo(t,i+n,t+o,i+n,o),e.arcTo(t+s,i+n,t+s,i+n-o,o),e.arcTo(t+s,i,t+s-o,i,o),e.arcTo(t,i,t,i+o,o)},rectRect(e,t,i,s,n,o,r){r&&(e.fillStyle=r,e.fillRect(t,i,s,n)),o&&(e.strokeStyle=o,e.strokeRect(t,i,s,n))},diamond(e,t,i,s,n,o){e.beginPath(),e.fillStyle=o,e.moveTo(t+s/2,i),e.lineTo(t+s,i+n/2),e.lineTo(t+s/2,i+n),e.lineTo(t,i+n/2),e.lineTo(t+s/2,i),e.fill()},viewTitle(e,t,i,s,n,o){e.fillStyle=n,e.fillText(o,t+s*.5,i+s*.75)},viewRect(e,t,i,s,n,o,r,a,l){const c=Math.PI;e.beginPath(),e.lineWidth=r,e.moveTo(t,i+o),e.arc(t+o,i+o,o,c,-c/2),e.lineTo(t+s-o,i),e.arc(t+s-o,i+o,o,-c/2,0),e.lineTo(t+s,i+n-o),e.arc(t+s-o,i+n-o,o,0,c/2),e.lineTo(t+o,i+n),e.arc(t+o,i+n-o,o,c/2,c),e.lineTo(t,i+o),e.moveTo(t+s,i+n-o),e.lineTo(t+s-o,i+n),l&&(e.fillStyle=l,e.fill()),a&&(e.strokeStyle=a,e.stroke())},roundedRect(e,t,i,s,n,o,r,a,l){const c=Math.PI;e.beginPath(),e.lineWidth=r,e.moveTo(t,i+o),e.arc(t+o,i+o,o,c,-c/2),e.lineTo(t+s-o,i),e.arc(t+s-o,i+o,o,-c/2,0),e.lineTo(t+s,i+n-o),e.arc(t+s-o,i+n-o,o,0,c/2),e.lineTo(t+o,i+n),e.arc(t+o,i+n-o,o,c/2,c),e.lineTo(t,i+o),l&&(e.fillStyle=l,e.fill()),a&&(e.strokeStyle=a,e.stroke())},roundedHeader(e,t,i,s,n,o,r,a,l){const c=Math.PI;e.beginPath(),e.lineWidth=r,e.moveTo(t,i+o),e.arc(t+o,i+o,o,c,-c/2),e.lineTo(t+s-o,i),e.arc(t+s-o,i+o,o,-c/2,0),e.lineTo(t+s,i+n),e.lineTo(t,i+n),e.lineTo(t,i+o),l&&(e.fillStyle=l,e.fill()),a&&(e.strokeStyle=a,e.stroke())},grid(e,t,i,s,n,o,r,a,l){e.beginPath(),e.lineWidth=1,e.strokeStyle=a;const c=i+n;for(let f=i-i%r;f<c;f+=r)e.moveTo(t,f),e.lineTo(t+s,f);const h=t+s;for(let f=t-t%o;f<h;f+=o)e.moveTo(f,i),e.lineTo(f,i+n);e.stroke(),e.beginPath(),e.strokeStyle=l,e.moveTo(t,0),e.lineTo(t+s,0),e.moveTo(0,i),e.lineTo(0,i+n),e.stroke()},bullet(e,t,i,s,n,o){e.beginPath(),e.arc(t,i,s,0,2*Math.PI),o&&(e.fillStyle=o,e.fill()),n&&(e.lineWidth=1,e.strokeStyle=n,e.stroke())},textWidth(e,t){return e.measureText(t).width},fitText(e,t,i){if(e.measureText(t).width<=i)return t;const n="",o=e.measureText(n).width;let r=0,a=t.length,l=0;for(;r<a;){const h=Math.floor((r+a+1)/2),f=t.slice(0,h);e.measureText(f).width+o<=i?(l=h,r=h):a=h-1}return t.slice(0,l)+n},labelText(e,t,i,s,n,o,r,a){const l=e.font;e.font=i,e.fillStyle=s,e.fillText(t,n,o+.5*a),e.font=l},labelCursor(e,t,i,s,n,o,r){let a=e.measureText(t.slice(0,r)).width;return{x:i+a+1,y:s-.25*o}},leftText(e,t,i,s,n,o,r){e.fillStyle=i,e.fillText(t,s,n+.75*r)},rightText(e,t,i,s,n,o,r){e.fillStyle=i;let a=e.measureText(t).width;e.fillText(t,s+o-a,n+.75*r)},rightTextMulti(e,t,i,s,n,o,r,a){e.fillStyle=s,o+=.75*a;const l=t.indexOf("["),c=t.indexOf("]"),h=t.slice(0,l+1),f=t.slice(l+1,c),m=t.slice(c),v=e.font,w=e.measureText(h).width,y=e.measureText(m).width;e.font=i;const b=e.measureText(f).width;e.font=v,n=n+r-w-b-y,e.fillText(h,n,o),e.font=i,n+=w,e.fillText(f,n,o),e.font=v,n+=b,e.fillText(m,n,o)},leftTextMulti(e,t,i,s,n,o,r,a){e.fillStyle=s,e.fillStyle=s,o+=.75*a;const l=t.indexOf("["),c=t.indexOf("]"),h=t.slice(0,l+1),f=t.slice(l+1,c),m=t.slice(c),v=e.font,w=e.measureText(h).width;e.font=i;const y=e.measureText(f).width;e.font=v,e.fillText(h,n,o),e.font=i,n+=w,e.fillText(f,n,o),e.font=v,n+=y,e.fillText(m,n,o)},centerText(e,t,i,s,n,o,r,a){const l=e.font;e.font=i,e.fillStyle=s;let c=e.measureText(t);e.fillText(t,n+(r-c.width)/2,o+.75*a),e.font=l},centerLineText(e,t,i,s,n,o,r,a){e.beginPath(),e.fillStyle=i,e.strokeStyle=s;const l=e.measureText(t),c=5;e.moveTo(n,o+a/2),e.lineTo(n+(r-l.width)/2-c,o+a/2),e.moveTo(n+(r+l.width)/2+c,o+a/2),e.lineTo(n+r,o+a/2),e.stroke(),e.fillText(t,n+(r-l.width)/2,o+.75*a)},interfaceText(e,t,i,s,n,o,r,a,l){e.beginPath();const c=e.font;e.font=i,e.strokeStyle=n;const h=e.measureText(t),f=5;e.moveTo(o,r+l/2),e.lineTo(o+(a-h.width)/2-f,r+l/2),e.moveTo(o+(a+h.width)/2+f,r+l/2),e.lineTo(o+a,r+l/2),e.stroke(),e.fillStyle=s,e.fillText(t,o+(a-h.width)/2,r+.75*l),e.font=c},centerTextCursor(e,t,i,s){let n=t.x+t.w/2-e.measureText(i).width/2,o=e.measureText(i.slice(0,s)).width;return{x:n+o+1,y:t.y}},leftTextCursor(e,t,i,s,n,o,r){let a=e.measureText(t.slice(0,r)).width;return{x:i+a+1,y:s}},rightTextCursor(e,t,i,s,n,o,r){let a=e.measureText(t.slice(0,r)).width;return{x:i+n-e.measureText(t).width+a,y:s}},cursor(e,t,i,s,n,o){e.fillStyle=o,e.fillRect(t,i,s,n)},bulletRect(e,t,i,s,n,o,r){e.beginPath(),e.fillStyle=o,e.fillRect(t+r,i,s,n),e.arc(t+r,i+n/2,r,Math.PI/2,-Math.PI/2),e.fill()},rectBullet(e,t,i,s,n,o,r){e.beginPath(),e.fillStyle=o,e.fillRect(t,i,s-r,n),e.arc(t+s-r,i+n/2,r,-Math.PI/2,Math.PI/2),e.fill()},corner(e,t,i,s,n,o,r,a){e.beginPath(),e.fillStyle=a,i?(e.moveTo(s,n),e.lineTo(s+o,n+r),e.arc(s+o/2,n+r/2,o/2,Math.PI/2,Math.PI),e.lineTo(s,n)):(e.moveTo(s,n+r),e.lineTo(s+o,n),e.arc(s+o/2,n+r/2,o/2,0,Math.PI/2),e.lineTo(s,n+r)),e.fill()},leftTriangle(e,t,i,s,n,o){e.beginPath(),e.fillStyle=o,e.moveTo(t,i+n/2),e.lineTo(t+s,i+n),e.lineTo(t+s,i),e.lineTo(t,i+n/2),e.fill()},rightTriangle(e,t,i,s,n,o){e.beginPath(),e.fillStyle=o,e.moveTo(t,i),e.lineTo(t,i+n),e.lineTo(t+s,i+n/2),e.lineTo(t,i),e.fill()},triangleBall(e,t,i,s,n,o){const a=n/2;e.beginPath(),e.fillStyle=o,e.moveTo(t,i+a),e.lineTo(t+s,i+n),e.lineTo(t+s,i),e.lineTo(t,i+a),e.arc(t+s+3,i+a,3,0,2*Math.PI),e.fill()},ballTriangle(e,t,i,s,n,o){const a=n/2;e.beginPath(),e.fillStyle=o,e.moveTo(t,i),e.lineTo(t,i+n),e.lineTo(t+s,i+a),e.lineTo(t,i),e.arc(t-3,i+a,3,0,2*Math.PI),e.fill()},triangle(e,t,i,s,n,o,r){switch(e.beginPath(),e.fillStyle=r,o){case"up":e.moveTo(t,i+n),e.lineTo(t+s,i+n),e.lineTo(t+s/2,i),e.lineTo(t,i+n);break;case"down":e.moveTo(t,i),e.lineTo(t+s/2,i+n),e.lineTo(t+s,i),e.lineTo(t,i);break;case"left":e.moveTo(t,i+n/2),e.lineTo(t+s,i+n),e.lineTo(t+s,i),e.lineTo(t,i+n/2);break;case"right":e.moveTo(t,i),e.lineTo(t,i+n),e.lineTo(t+s,i+n/2),e.lineTo(t,i);break}e.fill()},tack(e,t,i,s,n,o,r){e.beginPath(),e.fillStyle=r;let{x:a,y:l,w:c,h}=n;const f=3;let m=a+c/2,v=l+h/2;switch(t){case"up":e.moveTo(a,l+h),e.lineTo(a+c,l+h),e.lineTo(a+(c+o)/2,l),e.lineTo(a+(c-o)/2,l),e.lineTo(a,l+h),i&&(v=s?l-f:l+h+f);break;case"down":e.moveTo(a,l),e.lineTo(a+(c-o)/2,l+h),e.lineTo(a+(c+o)/2,l+h),e.lineTo(a+c,l),e.lineTo(a,l),i&&(v=s?l+h+f:l-f);break;case"left":e.moveTo(a,l+(h-o)/2),e.lineTo(a,l+(h+o)/2),e.lineTo(a+c,l+h),e.lineTo(a+c,l),e.lineTo(a,l+(h-o)/2),i&&(m=s?a-f:a+c+f);break;case"right":e.moveTo(a,l),e.lineTo(a,l+h),e.lineTo(a+c,l+(h+o)/2),e.lineTo(a+c,l+(h-o)/2),e.lineTo(a,l),i&&(m=s?a+c+f:a-f);break}i&&e.arc(m,v,f,0,2*Math.PI),e.fill()},filterSign(e,t,i,s){let n=t.x-i/2,o=t.y-i/2;e.fillStyle=s,e.fillRect(n,o,i,i),e.fillStyle="#000000",e.fillRect(n+2,o+2,i-4,i-4)},hBusbarLabel(e,t,i,s,n,o,r,a,l){e.beginPath(),e.fillStyle=a,W._roundedRect(e,i,s,n,o,r),e.fill(),e.fillStyle=l,e.fillText(t,i+n/2-e.measureText(t).width/2,s+.75*o)},vBusbarLabel(e,t,i,s,n,o,r,a,l){e.beginPath(),e.fillStyle=a,W._roundedRect(e,i,s,n,o,r),e.fill(),e.save(),e.translate(i,s),e.rotate(-Math.PI/2),e.fillStyle=l,e.fillText(t,-o/2-e.measureText(t).width/2,.75*n),e.restore()},wirelessSymbol(e,t,i,s,n){e.beginPath(),e.strokeStyle=n;let o=t-2,r=i-2;e.moveTo(o-s-4,r),e.arc(o,r,s+4,Math.PI,-Math.PI/2),e.moveTo(o-s,r),e.arc(o,r,s,Math.PI,-Math.PI/2),e.moveTo(o-s+4,r),e.arc(o,r,s-4,Math.PI,-Math.PI/2),e.stroke()},filterSymbol(e,t,i,s,n){e.beginPath(),e.strokeStyle=n;const o=s/3,r=s/2;e.moveTo(t,i),e.lineTo(t+s,i),e.lineTo(t+s-o,i+r),e.lineTo(t+s-o,i+s),e.lineTo(t+o,i+s),e.lineTo(t+o,i+r),e.lineTo(t,i),e.stroke()},hCableLabel(e,t,i,s,n,o,r,a,l){e.beginPath(),e.fillStyle=a,W._roundedRect(e,i-2,s-2,n+4,o+4,r+2),e.fill(),e.beginPath(),e.strokeStyle=l,W._roundedRect(e,i,s,n,o,r),e.stroke(),e.fillStyle=l,e.fillText(t,i+n/2-e.measureText(t).width/2,s+.75*o)},vCableLabel(e,t,i,s,n,o,r,a,l){e.beginPath(),e.fillStyle=a,W._roundedRect(e,i-2,s-2,n+4,o+4,r+2),e.fill(),e.beginPath(),e.strokeStyle=l,W._roundedRect(e,i,s,n,o,r),e.stroke(),e.save(),e.translate(i,s),e.rotate(-Math.PI/2),e.fillStyle=l,e.fillText(t,-o/2-e.measureText(t).width/2,.75*n),e.restore()},drawBusbar(e,t,i,s){const n=e.lineWidth;if(!(t.len<2)){e.beginPath(),e.lineWidth=s,e.strokeStyle=i,e.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)e.lineTo(t[o].x,t[o].y);e.stroke(),e.lineWidth=n}},drawCable(e,t,i,s){if(t.len<2)return;const n=e.lineWidth;e.beginPath(),e.lineWidth=s,e.strokeStyle=i,e.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)e.lineTo(t[o].x,t[o].y);e.stroke(),e.lineWidth=s-4,e.strokeStyle="#000000",e.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)e.lineTo(t[o].x,t[o].y);e.stroke(),e.lineWidth=s-6,e.strokeStyle=i,e.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)e.lineTo(t[o].x,t[o].y);e.stroke(),e.lineWidth=n},drawPoints(e,t){let i=t.length;if(i<2)return;const s=7.5,n=15;e.moveTo(t[0].x,t[0].y);for(let o=0;o<i-1;o++){const r=t[o],a=t[o+1];Math.abs(r.y-a.y)>=n||Math.abs(r.x-a.x)>=n?e.arcTo(r.x,r.y,a.x,a.y,s):(e.lineTo(r.x,r.y),e.lineTo(a.x,a.y))}e.lineTo(t[i-1].x,t[i-1].y),e.stroke()},drawWire(e,t,i,s){e.beginPath(),e.lineWidth=i,e.strokeStyle=t,this.drawPoints(e,s)},twistedPair(e,t,i,s){e.beginPath(),e.strokeStyle=t,e.lineWidth=2*i,this.drawPoints(e,s)}},Qe={close(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=s/2;e.arc(t+r,i+r,r,0,2*Math.PI);const a=2;e.moveTo(t+a,i+a),e.lineTo(t+s-a,i+s-a),e.moveTo(t+s-a,i+a),e.lineTo(t+a,i+s-a),e.stroke()},bigView(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2,e.rect(t,i,s,n),e.stroke()},smallView(e,t,i,s,n,o){e.beginPath(),e.fillStyle=o,e.rect(t+2,i+2,s-4,n-4),e.fill()},xbigView(e,t,i,s,n,o){e.beginPath();const r=n/2,a=s/2;e.strokeStyle=o,e.lineWidth=2,e.rect(t,i,a-1,r),e.rect(t+a+1,i+r,a-1,r),e.stroke()},calibrate(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=s/2,a=1;e.arc(t+r,i+r,r-1,0,2*Math.PI),e.moveTo(t-a,i+r),e.lineTo(t+s+a,i+r),e.moveTo(t+r,i-a),e.lineTo(t+r,i+s+a),e.stroke()},grid(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=s/3;e.moveTo(t+r,i),e.lineTo(t+r,i+s),e.moveTo(t+r+r,i),e.lineTo(t+r+r,i+s),e.moveTo(t,i+r),e.lineTo(t+s,i+r),e.moveTo(t,i+r+r),e.lineTo(t+s,i+r+r),e.stroke()},link(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=Math.PI,a=s/3,l=s/2;e.moveTo(t+l+a,i+a),e.arc(t+l,i+a,a,0,r,!0),e.moveTo(t+l-a,i+n-a),e.arc(t+l,i+n-a,a,r,2*r,!0),e.moveTo(t+l,i+n-a),e.lineTo(t+l,i+a),e.stroke()},lock(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=Math.PI,a=s/3,l=s/2;e.moveTo(t+l+a,i+a),e.arc(t+l,i+a,a,0,r,!0),e.rect(t+1,i+a+1,s-2,n-a-1),e.stroke()},cog(e,t,i,s,n,o,r){e.beginPath();const a=s/2,l=n/2,c=s/3,h=Math.PI,f=1,m=2;e.strokeStyle=o,e.lineWidth=2,e.moveTo(t+a,i+f),e.lineTo(t+a,i+n-f),e.moveTo(t,i+l),e.lineTo(t+s,i+l),e.moveTo(t+f,i+m),e.lineTo(t+s-f,i+n-m),e.moveTo(t+s-f,i+m),e.lineTo(t+f,i+n-m),e.stroke(),e.beginPath(),e.fillStyle=r,e.arc(t+a,i+l,c,0,2*h),e.stroke(),e.fill()},factory(e,t,i,s,n,o){e.beginPath();const r=n/4,a=n/2,l=s/2;e.strokeStyle=o,e.lineWidth=2,e.moveTo(t+s,i),e.lineTo(t+s,i+n),e.lineTo(t,i+n),e.lineTo(t,i+r),e.lineTo(t+l,i+a),e.lineTo(t+l,i+r),e.lineTo(t+s,i+a),e.stroke()},group(e,t,i,s,n,o){e.beginPath();const r=n/2,a=s/2;e.strokeStyle=o,e.lineWidth=2,e.rect(t,i+2,a-1,r),e.rect(t+a+1,i+r,a-1,r),e.stroke()},pulse(e,t,i,s,n,o){e.beginPath(),e.strokeStyle=o,e.lineWidth=2;const r=i+n/2+1;e.moveTo(t,r),e.lineTo(t+2,r),e.lineTo(t+4,i),e.lineTo(t+5,i+n),e.lineTo(t+6,r),e.lineTo(t+s,r),e.stroke()},comment(e,t,i,s,n,o){e.beginPath();const r=n/6,a=n/2,l=5*r,c=s/4;e.strokeStyle=o,e.lineWidth=2,e.moveTo(t+c,i+r),e.lineTo(t+3*c,i+r),e.moveTo(t+c,i+a),e.lineTo(t+2*c,i+a),e.moveTo(t+c,i+l),e.lineTo(t+4*c,i+l),e.stroke()}},od="|",k={rectToString:e=>e?`x ${Math.round(e.x)} y ${Math.round(e.y)} w ${Math.round(e.w)} h ${Math.round(e.h)}`:"x 0 y 0 w 0 h 0",stringToRect:e=>{let t=e.indexOf("x"),i=e.indexOf("y"),s=e.indexOf("w"),n=e.indexOf("h");return{x:parseFloat(e.slice(t+1,i)),y:parseFloat(e.slice(i+1,s)),w:parseFloat(e.slice(s+1,n)),h:parseFloat(e.slice(n+1))}},relativeRect:(e,t)=>`x ${Math.round(e.x-t.x)} y ${Math.round(e.y-t.y)} w ${Math.round(e.w)} h ${Math.round(e.h)}`,transformToString:e=>`sx ${e.sx.toFixed(3)} sy ${e.sy.toFixed(3)} dx ${e.dx.toFixed(3)} dy ${e.dy.toFixed(3)}`,stringToTransform:e=>{let t=e.indexOf("sx"),i=e.indexOf("sy"),s=e.indexOf("dx"),n=e.indexOf("dy");return t<0||i<0||s<0||n<0?{sx:1,sy:1,dx:0,dy:0}:{sx:parseFloat(e.slice(t+2,i)),sy:parseFloat(e.slice(i+2,s)),dx:parseFloat(e.slice(s+2,n)),dy:parseFloat(e.slice(n+2))}},stringToPosition:e=>{const t=e.indexOf(",");if(t<0)return{rect:{x:0,y:0,w:0,h:0},left:!1};const i=k.stringToRect(e.slice(0,t)),s=e.slice(t+1).trim()==="left";return{rect:i,left:s}},stringToUidWid(e){const t=e.indexOf(".");return t<0?[e,0]:[e.slice(0,t),+e.slice(t+1)]},stringToWid(e){const t=e.indexOf(".");return t<0?0:+e.slice(t+1)},stringToId(e){const t=e.indexOf(od);return{uid:e.slice(0,t),name:e.slice(t+1)}},pointToString(e){return`x ${e.x} y ${e.y}`},stringToPoint(e){const t=e.match(/x\s*(-?\d+\.?\d*)\s*y\s*(-?\d+\.?\d*)/);return t?{x:parseFloat(t[1]),y:parseFloat(t[2])}:null},wireToString:e=>{if(e.length<2)return"";const t=[];for(let i=1;i<e.length;i++){const s=e[i].x-e[i-1].x,n=e[i].y-e[i-1].y;Math.abs(s)>Math.abs(n)?t.push("x "+s.toFixed(1)):t.push("y "+n.toFixed(1))}return t.join(" ")},stringToWire(e,t,i){if(!i||i.length<1)return[];if(e){let{x:s,y:n}={...e},o=[{x:s,y:n}];const r=i.split(" ");for(let a=0;a<r.length;a+=2){const l=r[a],c=parseFloat(r[a+1]);l==="x"?s+=c:n+=c,o.push({x:s,y:n})}return o}if(t){let{x:s,y:n}={...t},o=[{x:s,y:n}];const r=i.split(" ").reverse();for(let a=0;a<r.length;a+=2){const l=r[a+1],c=parseFloat(r[a]);l==="x"?s-=c:n-=c,o.push({x:s,y:n})}return o.reverse()}else return[]},routeToString(e){let t=e.from,i=e.to;const s=l=>`(pin ${l.wid}) ${l.name} @ ${l.node.name}`,n=l=>"(bus) "+l.bus.name,o=l=>`(pad ${l.proxy.wid}) ${l.proxy.name}`,r=()=>{if(i.is.pin)return i.is.input;if(t.is.pin)return!t.is.input;if(i.is.pad)return i.proxy.is.input;if(t.is.pad)return!t.proxy.is.input},a={};return r()?(t.is.pin?a.from=s(t):t.is.pad?a.from=o(t):t.is.tack&&(a.from=n(t)),i.is.pin?a.to=s(i):i.is.pad?a.to=o(i):i.is.tack&&(a.to=n(i)),a.wire=k.wireToString(e.wire)):(i.is.pin?a.from=s(i):i.is.pad?a.from=o(i):i.is.tack&&(a.from=n(i)),t.is.pin?a.to=s(t):t.is.pad?a.to=o(t):t.is.tack&&(a.to=n(t)),a.wire=k.wireToString(e.wire.slice().reverse())),a},rawToEndPoint(e){const t=e.trim().slice(1,4);let i=0,s=0,n=0;switch(t){case"pin":return i=e.indexOf(")"),s=e.slice(4,i).trim(),n=e.indexOf("@"),{pin:e.slice(i+1,n).trim(),wid:s.length>0?+s:0,node:e.slice(n+1).trim()};case"pad":return i=e.indexOf(")"),s=e.slice(4,i).trim(),{pad:e.slice(i+1).trim(),wid:s.length>0?+s:0};case"bus":return{bus:e.slice(5).trim()};case"itf":return{itf:e.slice(5).trim()}}},cleanInput(e){return e.trim().replace(/\s+/g," ").replace(/@|->|=>/g,"")},cleanLink(e){return e.split("@").map(t=>k.cleanInput(t).trim()).filter(t=>t.length>0).join(" @ ")},splitLink(e){return e.split("@").map(t=>t.trim()).filter(t=>t.length>0).reverse()},isMulti:e=>{const t=e.indexOf("["),i=e.lastIndexOf("]");return t>-1&&i>-1&&i>t},extractMultis:e=>{const[t,i]=k.getPreMiddlePost(e);return i.split(",")},expandMultis:e=>{const[t,i,s]=k.getPreMiddlePost(e);return i.split(",").map(o=>t+o+s)},cleanMulti(e){const[t,i,s]=k.getPreMiddlePost(e);return t+"["+i+"]"+s},getPreMiddlePost(e){const t=e.indexOf("["),i=e.lastIndexOf("]");let s=e.slice(0,t).trim(),n=e.slice(t+1,i).split(",").map(l=>l.trim()).filter(Boolean).join(","),o=e.slice(i+1).trim();const r=s.at(-1);s.length>0&&r!="."&&r!="-"&&r!="_"&&(s=s+" ");const a=o[0];return o.length>0&&a!="."&&a!="-"&&a!="_"&&(o=" "+o),[s,n,o]},needsPrefix:e=>{const t=e[0];return t=="+"||t=="."||t=="-"||t=="_"},needsPostfix:e=>{const t=e.at(-1);return t=="+"||t=="."||t=="-"||t=="_"},combineWithPrefix(e,t){let i=t;const s=t[0];if(s=="."||s=="-"||s=="_"){const n=t.slice(1).trim();i=e+s+n}else if(s=="+"){const n=t.slice(1).trim();i=e+" "+n}return i},combineWithPostfix(e,t){let i=t;const s=t.at(-1);return s=="."||s=="-"||s=="_"?i=t.slice(0,-1).trim()+s+e:s=="+"&&(i=t.slice(0,-1).trim()+" "+e),i},prefixMatch(e,t){if(t.startsWith(e)){const i=t[e.length];return i=="."||i=="-"||i==" "||i=="_"}},postfixMatch(e,t){if(t.endsWith(e)){const i=t.at(-e.length-1);return i=="."||i=="-"||i==" "||i=="_"}},xxcombineWithPrefix(e,t){let i=t;if(t[0]=="+"){const s=t.slice(1).trim();s[0]=="."||s[0]=="-"||e.at(-1)=="."||e.at(-1)=="-"?i=e+s:i=e+" "+s}else if(t.at(-1)=="+"){const s=t.slice(0,-1).trim();s.at(-1)=="."||s.at(-1)=="-"||e[0]=="."||e[0]=="-"?i=s+e:i=s+" "+e}return i},addNumber:(e,t)=>{const i=e.lastIndexOf("("),s=e.lastIndexOf(")");if(i!==-1&&s===e.length-1){const n=e.slice(i+1,s);if(!isNaN(n)&&n!=="")return e.slice(0,i+1)+t.toString()+")"}return e+"("+t.toString()+")"},viewToJSON:e=>{let t,i,s;return e.viewState?(t=e.viewState.visible?e.viewState.big?"big":"open":"closed",i=e.viewState.big?k.rectToString(e.viewState.rect):k.rectToString(e.rect),s=k.transformToString(e.tf)):(t=e.status,i=k.rectToString(e.rect),s=k.transformToString(e.tf)),{state:t,rect:i,transform:s}},stringToView:e=>({raw:!0,state:e.state,rect:k.stringToRect(e.rect),tf:k.stringToTransform(e.transform)}),pinToHandler(e){return"on"+e.split(/[ .-]+/).map(s=>s.replace(/[^a-zA-Z0-9_]/g,"")).filter(Boolean).map(s=>s[0].toUpperCase()+s.slice(1)).join("")},nodeToFactory:e=>{let s=e.toLowerCase().split(/[ .-]+/).map(n=>n.replace(/[^a-z0-9_]/g,"")).filter(Boolean).map(n=>n[0].toUpperCase()+n.slice(1)).join("");return/^[0-9]/.test(s)&&(s="_"+s),s},skipPrefix:e=>{let t=e.indexOf("/",1);return t<0?e:e.slice(t)},spaceToDash:e=>{if(!e.includes(" "))return e;let t="";for(let i=0;i<e.length;i++)t+=e[i]==" "?"-":e[i];return t},toBaseName:e=>{const t=e.indexOf("-model");return t>0?e.slice(0,t):e},nameToSource:e=>k.spaceToDash(e)+".js",nameToModel:e=>k.spaceToDash(e)+".json",nameToBuild:e=>k.spaceToDash(e)+".js",nameToApp:e=>k.spaceToDash(e)+".js",nameToPage:e=>k.spaceToDash(e)+".html",objectToJsLiteral(e,t=4){return JSON.stringify(e,(i,s)=>s===void 0?"__undefined__":s,t).replace(/"__undefined__"/g,"undefined").replace(/"([^"]+)":/g,"$1:").replace(/"([^"]*)"/g,(i,s)=>`'${s.replace(/'/g,"\\'")}'`)},djb2:e=>{for(var t=5381,i=0;i<e.length;i++)t=(t<<5)+t+e.charCodeAt(i);return Math.abs(t&2**32-1).toString(16).padStart(8,"0")},hexToHsl(e){let t=parseInt(e.slice(1,3),16)/255,i=parseInt(e.slice(3,5),16)/255,s=parseInt(e.slice(5,7),16)/255,n=1;e.length>7&&(n=parseInt(e.slice(7,9),16)/255);let o=Math.max(t,i,s),r=Math.min(t,i,s),a,l,c=(o+r)/2;if(o===r)a=l=0;else{let h=o-r;switch(l=c>.5?h/(2-o-r):h/(o+r),o){case t:a=(i-s)/h+(i<s?6:0);break;case i:a=(s-t)/h+2;break;case s:a=(t-i)/h+4;break}a/=6}return l*=100,c*=100,a*=360,n==1?`hsl(${a.toFixed(0)}, ${l.toFixed(0)}%, ${c.toFixed(0)}%)`:`hsl(${a.toFixed(0)}, ${l.toFixed(0)}%, ${c.toFixed(0)}%, ${n})`},hslToHex(e){let t=e.indexOf(",")>-1?",":" ",i=e.substring(4,e.lastIndexOf(")")).split(t),s=parseFloat(i[0]),n=parseFloat(i[1])/100,o=parseFloat(i[2])/100,r=parseFloat(i[3]),a=(1-Math.abs(2*o-1))*n,l=a*(1-Math.abs(s/60%2-1)),c=o-a/2,h=0,f=0,m=0,v="ff";return 0<=s&&s<60?(h=a,f=l,m=0):60<=s&&s<120?(h=l,f=a,m=0):120<=s&&s<180?(h=0,f=a,m=l):180<=s&&s<240?(h=0,f=l,m=a):240<=s&&s<300?(h=l,f=0,m=a):300<=s&&s<360&&(h=a,f=0,m=l),h=Math.round((h+c)*255).toString(16),f=Math.round((f+c)*255).toString(16),m=Math.round((m+c)*255).toString(16),v=r==1?"ff":Math.round(r*255).toString(16),h.length<2&&(h="0"+h),f.length<2&&(f="0"+f),m.length<2&&(m="0"+m),v.length<2&&(m="0"+v),v=="ff"?"#"+h+f+m:"#"+h+f+m+v}};function rd(e){return/^#[0-9A-Fa-f]{6}([0-9A-Fa-f]{2})?$/.test(e)}const C={shade1:"#fff",shade2:"#fff",shade3:"#fff",shade4:"#fff",shade5:"#fff",view1:"#222",view2:"#444",vIcon1:"#fd4d0c",vIcon2:"#3399ff",vIcon3:"#33cc33",vIcon4:"#e9bb16",grey3:"#333",grey6:"#666",greyC:"#ccc",black:"#000",white:"#fff",orange:"#ff8000",orangeT:"#ff800022",green:"#7fff00",red:"#FE2712",yellow:"#fefe33",pink:"#f9d5e5",purple:"#ff80ff",blue:"#0000ff",setShades(e){const t=k.hexToHsl(e),i=t.indexOf(",",4),s=t.indexOf(",",i+1),n=t.substring(4,i),o=t.substring(i+1,s);this.shade1=k.hslToHex(`hsl(${n},${o},40%,1)`),this.shade2=k.hslToHex(`hsl(${n},${o},30%,0.50)`),this.shade3=k.hslToHex(`hsl(${n}, 100%, 75%, 1)`),this.shade4=k.hslToHex(`hsl(${n},${o},60%,1)`),this.shade5=k.hslToHex(`hsl(${n}, 50%, 75%, 1)`)}};function Fs(){this.rgb="#fff",this.std={font:"normal 12px tahoma",lineCap:"round",lineJoin:"round",lineWidth:1,cBackground:C.black,cLine:C.white,cFill:C.blue,wCursor:2,blinkRate:500,cBlinkOn:C.white,cBlinkOff:C.black},this.look={wBox:150,hTop:20,hBottom:6,wExtra:50,wMax:300,dxCopy:20,dyCopy:20,smallMove:5},this.box={rCorner:7.5,wLine:2,cLine:C.shade1,cBackground:C.shade2,cContainer:C.yellow,cSelected:C.orangeT,dxSel:10,dySel:10,wLineSel:1},this.header={font:"normal 13px tahoma",hHeader:15,hTitle:15,wLine:1,wChar:6,rCorner:7.5,cTitle:C.shade3,cBackground:C.shade1,cBad:C.red,cHighLighted:C.purple},this.icon={wIcon:8,hIcon:10,blinkRate:200,nBlinks:4,cSrc:C.shade3,cLink:C.shade3,cBadLink:C.red,cHighLighted:C.purple,cGroup:C.shade3,cCog:C.shade3,cPulse:C.shade3,cComment:C.shade3,xPadding:6,yPadding:2,xSpacing:3},this.label={font:"italic 12px tahoma",hLabel:15,cNormal:C.greyC},this.ifName={font:"normal 12px tahoma",hSep:15,cNormal:C.shade5,cBackground:C.shade1,cAdded:C.green,cBad:C.red,cSelected:C.orange,cHighLighted:C.purple},this.pin={hPin:15,wOutside:10,wMargin:21,hArrow:10,wArrow:10,wChar:6,cNormal:C.shade1,cSelected:C.orange,cHighLighted:C.purple,cConnected:C.shade4,cAdded:C.green,cBad:C.red,cText:C.shade1,cCursor:C.black,fMulti:"italic 11px tahoma"},this.pad={hPad:15,hSpace:15,rBullet:7.5,wArrow:10,hArrow:10,wExtra:30,wMargin:4,wViewLeft:10,wViewRight:100,cBackground:C.shade2,cSelected:C.orange,cHighLighted:C.purple,cConnected:C.shade4,cBad:C.red,cText:C.shade1,cArrow:C.shade1},this.route={wSelected:2,wNormal:2,split:30,tooClose:15,cNormal:C.shade4,cSelected:C.purple,cHighLighted:C.purple,cNotUsed:C.grey3,cAdded:C.green,cDeleted:C.red},this.bus={wNormal:6,wBusbar:6,wCable:8,wSelected:6,split:50,tooClose:25,wArrow:10,hArrow:10,sChar:5,hLabel:15,radius:7.5,wFilter:15,cNormal:C.shade4,cSelected:C.purple,cHighLighted:C.purple,cBad:C.red,cText:C.black},this.selection={xPadding:20,yPadding:20,cRect:C.orangeT,cPinGroup:C.orangeT,wLine:0,rCorner:7.5},this.view={wDefault:800,hDefault:500,wLine:4,rCorner:15,wExtra:200,hExtra:20,cBackground:C.black,cLine:C.view1,cHighLight:C.view2,fHeader:"normal 15px arial",hHeader:20,cTitle:C.grey6,cTitleHighLight:C.shade3,grid:{dx:30,dy:30,cLine:C.grey3,cAxis:C.grey6},wIcon:10,hIcon:10,xPadding:10,xSpacing:8,cDim:C.grey6,cClose:C.vIcon1,cFullscreen:C.vIcon2,cCalibrate:C.vIcon3,cGrid:C.vIcon4},this.placement={marginTop:30,marginLeft:30,marginLeftPads:210,nodesPerRow:5,rowStep:360,colStep:270}}Fs.prototype={switch(e){if(!e)return g;const t=g;return g=e,t},create:e=>rd(e)?new Fs().adapt(e):new Fs().adapt("#00aaff"),adapt(e){return this.rgb=e,C.setShades(e),this.box.cLine=this.header.cBackground=this.ifName.cBackground=this.pin.cNormal=this.pin.cText=C.shade1,this.box.cBackground=this.pad.cBackground=C.shade2,this.header.cTitle=this.icon.cSrc=this.icon.cGroup=this.icon.cCog=this.icon.cLink=this.icon.cPulse=this.icon.cComment=this.view.cTitleHighLight=C.shade3,this.pin.cConnected=this.pad.cConnected=this.route.cNormal=this.bus.cNormal=C.shade4,this.ifName.cNormal=C.shade5,this}};let g=new Fs().adapt("#00aaff");function Qr(){this.cursor=0,this.saved=null,this.obj=null,this.prop=null,this.keyPressed=null}Qr.prototype={newEdit(e,t,i=-1){this.cursor=i<0?e[t].length:0,this.saved=e[t],this.obj=e,this.prop=t,this.keyPressed=null},clear(){this.obj[this.prop]="",this.cursor=0},handleKey(e){this.keyPressed=e.key;let t=this.cursor;const i=this.obj,s=this.prop;let n=t>0?i[s].slice(0,t):"",o=t<i[s].length-1?i[s].slice(t):"";return i[s]=n+e.key+o,this.cursor++,!1},handleSpecialKey(e){switch(this.keyPressed=e.key,e.key){case"Shift":return!1;case"Backspace":let t=this.cursor,i=this.obj[this.prop],s=t>0?i.slice(0,t-1):"",n=t<i.length?i.slice(t):"";return this.obj[this.prop]=s+n,t>0&&this.cursor--,!1;case"Enter":return!0;case"ArrowLeft":return this.cursor>0&&this.cursor--,!1;case"ArrowRight":return this.cursor<this.obj[this.prop].length&&this.cursor++,!1;case"Home":return this.cursor=0,!1;case"End":return this.cursor=this.obj[this.prop].length,!1;case"Delete":return this.obj[this.prop]="",this.cursor=0,!1;case"Escape":return this.obj[this.prop]=this.saved,!0;case"Alt":return!1;case"AltGraph":return!1;case"Control":return!1;default:return!0}}};function Zr(e){this.bottom=0,this.top=0,this.next=0,this.max=e>0?e-1:1,this.ring=new Array(this.max+1),this.ring.fill(null)}Zr.prototype={reset(){this.bottom=0,this.top=0,this.next=0,this.ring.fill(null)},push(e){this.top=this.next,this.ring[this.top]=e,this.next=this.next==this.max?0:this.next+1,this.next==this.bottom&&(this.bottom=this.bottom==this.max?0:this.bottom+1)},last(){return this.ring[this.top]},back(){return this.next==this.bottom?null:(this.next=this.next==0?this.max:this.next-1,this.ring[this.next])},forward(){if(this.next==this.top+1)return null;const e=this.ring[this.next];return this.next=this.next==this.max?0:this.next+1,e}};const st=(e,t)=>e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h,Bn="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",Nn=Bn.length;function ad(e){let t="";for(let i=0;i<e;i++){let s=Math.floor(Math.random()*Nn);t+=s<Nn?Bn[s]:Bn[Nn-1]}return t}function Re(e,t){const i=e.indexOf(t);return i>=0&&e.splice(i,1),i>=0}function ld(e,t){if(e.length<2)return null;const i=[];let s=0,n=0;for(let o=0;o<e.length-1;o++)s=e[o],n=e[o+1],s.y>t.y&&s.y<t.y+t.h&&n.y>t.y&&n.y<t.y+t.h?(s.x<t.x+t.w&&n.x>t.x||n.x<t.x+t.w&&s.x>t.x)&&i.push(o+1):s.x>t.x&&s.x<t.x+t.w&&n.x>t.x&&n.x<t.x+t.w&&(s.y<t.y+t.h&&n.y>t.y||n.y<t.y+t.h&&s.y>t.y)&&i.push(o+1);return i}function cd(e,t,i){const s=i.x,n=i.x+i.w,o=i.y,r=i.y+i.h;if(e.x<=s&&t.x<=s||e.x>=n&&t.x>=n||e.y<=o&&t.y<=o||e.y>=r&&t.y>=r)return!1;if(e.x>s&&e.x<n&&e.y>o&&e.y<r||t.x>s&&t.x<n&&t.y>o&&t.y<r)return!0;const a=c=>{if(t.x===e.x)return!1;const h=(c-e.x)/(t.x-e.x);if(h>0&&h<1){const f=e.y+h*(t.y-e.y);return f>o&&f<r}return!1},l=c=>{if(t.y===e.y)return!1;const h=(c-e.y)/(t.y-e.y);if(h>0&&h<1){const f=e.x+h*(t.x-e.x);return f>s&&f<n}return!1};return!!(a(s)||a(n)||l(o)||l(r))}function hd(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}function dd(e,t){let i=1/0,s=null,n=0,o=!1;for(let r=0;r<e.length-1;r++){let{x:a,y:l}=e[r],{x:c,y:h}=e[r+1];if(a===c)if(Math.min(l,h)<=t.y&&t.y<=Math.max(l,h)){let f=Math.abs(t.x-a);f<i&&(i=f,s={x:a,y:t.y},n=r+1,o=!1)}else{let f=(t.x-a)**2+(t.y-l)**2,m=(t.x-c)**2+(t.y-h)**2,[v,w,y]=f<m?[f,{x:a,y:l},r+1]:[m,{x:a,y:h},r+1];v<i&&(i=v,s=w,n=y,o=!0)}else if(l===h)if(Math.min(a,c)<=t.x&&t.x<=Math.max(a,c)){let f=Math.abs(t.y-l);f<i&&(i=f,s={x:t.x,y:l},n=r+1,o=!1)}else{let f=(t.x-a)**2+(t.y-l)**2,m=(t.x-c)**2+(t.y-h)**2,[v,w,y]=f<m?[f,{x:a,y:l},r+1]:[m,{x:c,y:h},r+1];v<i&&(i=v,s=w,n=y,o=!0)}}return{point:s,segment:n,endPoint:o}}function ud(e,t,i){let s=e.x,n=e.y,o=.1*(1+Math.random()),r=i[t-1],a=i[t];return(a.x<r.x||a.y<r.y)&&([r,a]=[a,r]),r.x==a.x?n=Math.abs(r.y-p.y)<Math(a.y-p.y)?r.y+o*(a.y-r.y):a.y-o*(a.y-r.y):s=Math.abs(r.x-p.x)<Math(a.x-p.x)?r.x+o*(a.x-r.x):a.x-o*(a.x-r.x),{x:s,y:n}}function ea(e){return e?JSON.parse(JSON.stringify(e)):null}function ta(e,t){if(e===null)return t;if(t===null)return JSON.parse(JSON.stringify(e));for(let i in e)e.hasOwnProperty(i)&&(typeof e[i]=="object"&&!Array.isArray(e[i])&&e[i]!==null?t[i]=ta(e[i],t[i]||{}):t.hasOwnProperty(i)||(t[i]=e[i]));for(let i in t)t.hasOwnProperty(i)&&(e.hasOwnProperty(i)||delete t[i]);return t}const fd={prepare(e){this.canvas.focus(),e.preventDefault();const t=this.doc;if(!t)return[null,null,null];const i=t.view.localCoord({x:e.offsetX,y:e.offsetY});return t.view.whichView(i)},onContextMenu(e){const[t,i,s]=this.prepare(e);t&&(i||(t.onContextMenu(s,e),this.redraw()))},onMouseDown(e){var n;if(e.button!=0)return;const[t,i,s]=this.prepare(e);t&&(t!=((n=this.doc)==null?void 0:n.focus)&&this.switchView(t),i?this.viewMouseDown(t,i):t.onMouseDown(s,e),this.redraw())},onMouseMove(e){const[t,i,s]=this.prepare(e);t&&(this.viewMouseMove(t,i,{x:e.movementX,y:e.movementY})||t.onMouseMove(s,e)&&this.redraw())},onMouseUp(e){if(this.state.action)return this.viewMouseUp();const[t,i,s]=this.prepare(e);t&&(t.onMouseUp(s,e),this.redraw())},onWheel(e){const[t,i,s]=this.prepare(e);t&&(t.onWheel(s,e),this.redraw())},onDblClick(e){const[t,i,s]=this.prepare(e);t&&t.onDblClick(s,e)},onClick(e){},onDragOver(e){e.preventDefault()},onDrop(e){const[t,i,s]=this.prepare(e);t&&t.onDrop(s,e)},viewMouseDown(e,t){t.is.icon?e.iconClick(t,this):t.is.border?(this.state.view=e,this.state.widget=t,this.state.action=rt.viewResize):t.is.viewTitle&&(this.state.view=e,this.state.widget=t,this.state.action=rt.viewDrag)},viewWidgetHover(e,t){t.is.border&&(this.state.action=rt.hoverBorder,e.highLight())},viewMouseMove(e,t,i){switch(this.state.action){case rt.nothing:if(!(t!=null&&t.is.border))return!1;if(t.name=="top"||t.name=="bottom")this.canvas.style.cursor="ns-resize";else if(t.name=="left"||t.name=="right")this.canvas.style.cursor="ew-resize";else if(t.name=="corner")this.canvas.style.cursor="nw-resize";else return!0;this.state.action=rt.hoverBorder,this.state.view=e;break;case rt.viewDrag:this.state.view.move(i);break;case rt.viewResize:this.state.view.resize(this.state.widget,i);break;case rt.hoverBorder:(e!=this.state.view||!(t!=null&&t.is.border))&&(this.canvas.style.cursor="default",this.state.action=rt.nothing);break;default:return!1}return this.redraw(),!0},viewMouseUp(){this.state.view=this.state.widget=null,this.state.action=rt.nothing}},pd={onKeydown(e){var t,i;(i=(t=this.doc)==null?void 0:t.focus)!=null&&i.onKeydown(e)&&(e.stopPropagation(),e.preventDefault(),this.redraw())},onKeyup(e){var t,i;(i=(t=this.doc)==null?void 0:t.focus)!=null&&i.onKeyup(e)&&(e.stopPropagation(),e.preventDefault(),this.redraw())}},gd="0.8.3",md={schemaVersion:gd};function ia(){const e=new Date;this.version=md.schemaVersion,this.created=e.toLocaleString(),this.saved=e.toLocaleString(),this.utc=e.toJSON(),this.style=g,this.runtime="@vizualmodel/vmblu-runtime"}ia.prototype={toJSON(){const e=new Date;return{version:this.version,created:this.created,saved:e.toLocaleString(),utc:e.toJSON(),style:this.style.rgb,runtime:this.runtime}},cook(e,t){var s,n,o,r,a;const i=new Date;this.created=((s=t.created)==null?void 0:s.slice())??i.toLocaleString(),this.saved=((n=t.saved)==null?void 0:n.slice())??i.toLocaleString(),this.utc=((o=t.utc)==null?void 0:o.slice())??i.toJSON(),this.version=((r=t.version)==null?void 0:r.slice())??"no version",this.style=g.create(t.style),this.runtime=((a=t.runtime)==null?void 0:a.slice())??"@vizualmodel/vmblu-runtime"}};const vd={async handleSourceMap(){const e=await this.readSourceMap();e&&(this.sourceMap=this.parseSourceMap(e))},async readSourceMap(){var i;const e=(i=this.arl)==null?void 0:i.getFullPath();return e?await this.arl.resolve(Bs(e)+".prf.json").get("json"):null},parseSourceMap(e){if(!e.entries)return null;const t=new Map;for(const i of e.entries){const{node:s,handles:n,transmits:o}=i;t.has(s)||t.set(s,{handles:new Map,transmits:new Map});const r=t.get(s);for(const a of n){const{handler:l,...c}=a;r.handles.set(l,{handler:l,...c})}for(const a of o){const{pin:l,...c}=a,h=r.transmits.get(l);h?Array.isArray(h)?h.push({pin:l,...c}):r.transmits.set(l,[h,{pin:l,...c}]):r.transmits.set(l,{pin:l,...c})}}return t},flattenSourceMap(e){const t=[];for(const[i,s]of e.entries())for(const[n,o]of s.entries())t.push({node:i,pin:n,...o});return t},getInputPinProfile(e){var o,r;const t=(r=(o=this.sourceMap)==null?void 0:o.get(e.node.name))==null?void 0:r.handles;if(!t)return null;const i=k.pinToHandler(e.name);if(!e.is.multi)return t.get(i)??null;const s=e.expandMultis(),n=[];for(const a of s){const l=k.pinToHandler(a),c=t.get(l)??null;c&&n.push(c)}return n},getOutputPinProfile(e){var n,o;const t=(o=(n=this.sourceMap)==null?void 0:n.get(e.node.name))==null?void 0:o.transmits;if(!t)return null;if(!e.is.multi)return t.get(e.name)??null;const i=e.expandMultis(),s=[];for(const r of i){const a=t.get(r)??null;Array.isArray(a)?s.push(...a):s.push(a)}return s},makeMcpToolString(e){const t=this.generateToolSpecs();if(t.length==0)return null;const i=new Date,s=`// ------------------------------------------------------------------
// MCP tool file for model: ${e.name}
// Creation date ${i.toLocaleString()}
// ------------------------------------------------------------------

export const mcpTools = `,n=k.objectToJsLiteral(t);return s+n},generateToolSpecs(){const e=[];if(!this.sourceMap)return[];for(const[t,i]of this.sourceMap.entries())for(const[s,n]of i.entries()){if(!n.mcp)continue;const o=new Map;for(const a of n.params||[]){if(!a.name||typeof a.name!="string")continue;if(a.name.startsWith("{")&&a.name.endsWith("}")){const c=a.name.slice(1,-1).split(",").map(h=>h.trim());for(const h of c)o.set(h,{name:h,type:"string",description:""});continue}const l=a.name.split(".");if(l.length===1)o.has(a.name)||o.set(a.name,{...a});else{const[c,h]=l;let f=o.get(c);f||(f={name:c,type:"object",description:"",properties:[],required:[]},o.set(c,f)),f.properties.push({name:h,type:a.type,description:a.description||""}),f.required.includes(h)||f.required.push(h)}}const r={name:n.mcpName||`${t}_${s}`,description:n.mcpDescription||n.summary||`Trigger ${s} on ${t}`,parameters:Array.from(o.values()),returns:n.returns||"",node:t,pin:s,handler:n.handler,file:n.file,line:n.line};e.push(r)}return e},convertToOpenAITools(e){return e.map(t=>{const i={type:"object",properties:{},required:[]};for(const s of t.parameters){const{name:n,type:o,description:r,properties:a,required:l}=s;if(!n||!o)continue;const c={type:o,description:r||""};if(o==="object"&&a){c.properties={},c.required=l||[];for(const h of a)c.properties[h.name]={type:h.type,description:h.description||""}}i.properties[n]=c,i.required.push(n)}return{type:"function",function:{name:t.name,description:t.description,parameters:i}}})}};function Nt(e){const t=Ko(e.userPath);this.is={blu:t=="vmblu"||t=="json",lib:t=="js"||t=="mjs",selectable:!1,dirty:!1,main:!1,fresh:!1},this.arl=e,this.key=null,this.header=new ia,this.libraries=new io,this.raw=null,this.sourceMap=null}Nt.prototype={toJSON(){return this.arl.userPath},makeKey(){this.key=k.djb2(this.arl.getFullPath())},checkType(){const e=Ko(this.arl.userPath);this.is={blu:e=="vmblu"||e=="json",lib:e=="js"||e=="mjs"}},copy(){const e=new Nt(this.arl);return e.key=this.key?this.key.slice():null,e.header={...this.header},e.raw=this.raw,e},findRawNode(e){var n,o;const t=(n=this.raw)==null?void 0:n.root;if(!t)return null;const i=k.splitLink(e);if(i.length==1)return e==t.name?t:t.nodes?this.findRawRecursive(t.nodes,e):null;let s=t;for(const r of i)if(s=(o=s.nodes)==null?void 0:o.find(a=>r===a.name),!s)return null;return s},findRawRecursive(e,t){for(const i of e)if(t==i.name)return i;for(const i of e)if(i.kind=="group"&&i.nodes.length>0){const s=this.findRawRecursive(i.nodes,t);if(s)return s}return null},setSelectable(){this.is.selectable=!0},async fetch(){let e=null;if(this.is.lib){const t=await this.arl.get("text").catch(i=>{console.error(`${this.arl.userPath} is not a valid library file`,i)});return t?(e=this.analyzeJSLib(t),e||console.error(`Model not found in library file: ${this.arl.userPath}`),e):null}return this.is.blu?(e=await this.arl.get("json").catch(t=>{console.error(`${this.arl.getFullPath()} is not a valid model file}`,t)}),e):(console.error(`${this.arl.userPath} is not a model nor a library file`),null)},async getRaw(){var e;return this.raw=await this.fetch(),(e=this.raw)!=null&&e.header&&this.header.cook(this.arl,this.raw.header),this.is.fresh=!0,this.raw},addRawLibraries(e,t){const i=this.libraries.newModels(e,t);for(const s of i)this.libraries.add(s)},analyzeJSLib(e){let t=e.indexOf('"{\\n'),i=e.indexOf('\\n}";',t);if(t<0||i<0)return null;let s=e.slice(t+1,i+3);const n=new Array(s.length);let o=0,r=0;for(;r<s.length;){const l=s.charAt(r++);if(l!="\\")n[o++]=l;else{const c=s.charAt(r++);c=="n"?n[o++]=`
`:c=='"'&&(n[o++]='"')}}const a=n.join("");return JSON.parse(a)}};Object.assign(Nt.prototype,vd);function io(){this.map=new Map}io.prototype={reset(){this.map.clear()},size(){return this.map.size},newModels(e,t){const i=[];if(t.length<1)return i;for(const s of t){const n=e.resolve(s);if(this.contains(n))continue;const o=new Nt(n);i.push(o)}return i},add(e){const t=e.arl.getFullPath();return this.map.get(t)?this:(this.map.set(t,e),this)},contains(e){return this.map.has(e.getFullPath())},get(e){return this.map.get(e)},valuesArray(){return Array.from(this.map.values())},findArl(e){var t;if(!e)return null;for(const i of this.map.values())if((t=i.arl)!=null&&t.equals(e))return i;return null},toJSON(){return[...this.map.values()]},async load(){const e=[];for(const t of this.map.values())t.is.selectable=!0,e.push(t.getRaw());await Promise.all(e)}};function wd(e){this.pin=e}function sa(e){this.pin=e,this.targets=[]}sa.prototype={dropTarget(e){const t=this.targets;for(let i=0;i<t.length;i++)if(e.node==t[i].node&&e.name==t[i].name){for(let s=i;s<t.length-1;s++)t[s]=t[s+1];t.pop();return}}};function yd(e){this.tack=e}function na(e){this.tack=e,this.fanout=[]}na.prototype={connectsTo(e){const t=this.tack.getOtherPin();return t.is.multi?t.getMatch(e)==e:t.name==e},dropTarget(e){const t=this.fanout;for(let i=0;i<t.length;i++)if(e.node==t[i].node&&e.name==t[i].name){for(let s=i;s<t.length-1;s++)t[s]=t[s+1];t.pop();return}}};const xd={rxtxPrepareTables(){if(!this.is.group)for(const e of this.look.widgets)e.is.pin&&this.rxtxAddPin(e)},rxtxResetTables(){this.is.group||(this.txTable=[],this.rxTable=[])},rxtxAddPin(e){this.is.group||(e.is.input?this.rxTable.push(new wd(e)):this.txTable.push(new sa(e)))},rxtxPopPin(e){this.is.group||(e.is.input?this.rxTable.pop():this.txTable.pop())},rxtxRemovePin(e){if(!this.is.group)if(e.is.input){const t=this.rxTable.find(i=>i.pin==e);Re(this.rxTable,t)}else{const t=this.txTable.find(i=>i.pin==e);Re(this.txTable,t)}},rxtxAddPinArea(e){if(!this.is.group)for(const t of e)t.is.pin&&this.rxtxAddPin(t)},rxtxBuildTxTable(){var e;if(this.is.group){for(const t of this.buses)t.hasFilter()&&t.rxtxBuildRxTxTable();for(const t of this.nodes)t.rxtxBuildTxTable();return}for(const t of this.look.widgets){if(!t.is.pin||t.is.input||t.routes.length==0)continue;const i=this.txTable.find(n=>n.pin.name==t.name);if(!i){console.error(`${this.name} NO TX TABLE RECORD FOR ${t.name}`);continue}i.targets=[];const s=[];for(const n of t.routes){if(!n.from||!n.to)continue;const o=n.from==t?n.to:n.from;o.is.pin?o.is.proxy?(e=o.pad)==null||e.makeConxList(s):s.push(o):o.is.tack?o.bus.hasFilter()?s.push(o):o.bus.makeConxList(t,s):o.is.pad&&o.proxy.makeConxList(s)}for(const n of s)i.targets.push(n)}},rxtxRemoveFromTxTable(e,t){var n;const i=(n=this.txTable.find(o=>o.pin.name==e.name))==null?void 0:n.targets,s=(i==null?void 0:i.length)??0;for(let o=0;o<s;o++)if(t.node==i[o].node&&t.name==i[o].name){for(let r=o;r<s-1;r++)i[r]=i[r+1];i.pop();return}}};function bd(e){return{x:e.x-15,y:e.y+10}}const kd={showExportForm(e){const t=this;u.tx.send("show link",{title:"Export to link",name:t.name,path:"",pos:e,ok:(i,s)=>u.doEdit("saveToLink",{node:t,newName:i,userPath:s}),cancel:()=>{}})},showLinkForm(e){var n,o;const t=this,i=t.link&&t.link.model!=((n=u.doc)==null?void 0:n.model)?(o=t.link.model)==null?void 0:o.arl.userPath:"",s=t.link?t.link.lName:t.name;u.tx.send("show link",{title:"Set link",name:s,path:i,pos:e,ok:(r,a)=>{(r!=s||a!=i)&&u.doEdit("changeLink",{node:t,lName:r,userPath:a})},open:(r,a)=>{var l,c;(r!=s||a!=i)&&u.doEdit("changeLink",{node:t,lName:r,userPath:a}),(l=t.link.model)!=null&&l.arl&&t.link.model!=((c=u.doc)==null?void 0:c.model)&&u.tx.send("open document",t.link.model.arl)},cancel:()=>{}})},iconClick(e,t,i){var o;const s=this,n=bd(i);switch(t.type){case"link":case"lock":this.showLinkForm(n);break;case"factory":const r=s.factory.fName.length<1?k.nodeToFactory(s.name):s.factory.fName,a=s.factory.arl?s.factory.arl.userPath:"";u.tx.send("show factory",{title:"Factory for "+s.name,name:r,path:a,pos:n,ok:(c,h)=>{u.doEdit("changeFactory",{node:s,newName:c.trim(),userPath:h.trim()})},open:async(c,h)=>{(c!=r||h!=a)&&u.doEdit("changeFactory",{node:s,newName:c.trim(),userPath:h.trim()});const f=s.factory.arl??u.doc.resolve("./index.js");u.tx.send("open source file",{arl:f})},cancel:()=>{}});break;case"group":let l=null;s.savedView?(o=s.savedView.viewState)!=null&&o.visible?(l=s.savedView.parent,l&&s.savedView.closeView()):(e.restoreView(s),l=s.savedView):l=e.newSubView(s),l&&u.switchView(l);break;case"cog":u.tx.send("settings",{title:"Settings for "+s.name,pos:n,json:s.sx,ok:c=>u.doEdit("changeNodeSettings",{node:s,sx:c})});break;case"pulse":u.tx.send("runtime settings",{title:"Runtime settings for "+s.name,pos:n,dx:s.dx,ok:c=>u.doEdit("changeNodeDynamics",{node:s,dx:c})});break;case"comment":u.tx.send("node comment",{header:"Comment for "+s.name,pos:n,uid:s.uid,text:s.prompt??"",ok:c=>u.doEdit("changeNodeComment",{node:s,comment:c})});break}},iconCtrlClick(e,t,i){var n,o,r,a;const s=this;switch(t.type){case"link":case"lock":(o=(n=s.link)==null?void 0:n.model)!=null&&o.arl&&s.link.model!=((r=u.doc)==null?void 0:r.model)&&u.tx.send("open document",s.link.model.arl);break;case"factory":{if(!s.is.source)return;const l=s.factory.arl??u.doc.resolve("./index.js");l&&u.tx.send("open source file",{arl:l})}break;case"group":s.savedView?e.restoreView(s):e.newSubView(s),(a=s.savedView)==null||a.big();break}}},Td={collectFactories(e){if(!this.link&&(this.is.source&&this.factory.arl!=null&&e.add(this.factory),this.is.group))for(const t of this.nodes)t.collectFactories(e)},collectModels(e){var t;this.link?this.link.model&&!this.link.model.is.main&&e.add(this.link.model):(t=this.nodes)==null||t.forEach(i=>i.collectModels(e))},collectModelsForLib(e,t){var i;if(this.link){const s=this.link.model;s&&!s.arl.equals(t.arl)&&e.add(s)}else(i=this.nodes)==null||i.forEach(s=>s.collectModelsForLib(e,t))},collectImports(e,t=null){var o,r;if(this.is.group){(r=(o=this.link)==null?void 0:o.model)!=null&&r.is.lib&&(t=this.link.model);for(const a of this.nodes)a.collectImports(e,t);for(const a of this.buses)a.hasFilter()&&a.getFilter(e,t,this.link);return}const i=this.getSourceArl(t)??e[0].arl,s=this.factory.duplicate(e,i)?`${this.factory.fName} as ${this.factory.alias}`:this.factory.fName,n=e.find(a=>a.arl.equals(i));n?n.items.find(l=>l==s)||n.items.push(s):e.push({arl:i,items:[s]})},makeSourceLists(e,t){var i;if(this.is.source)e.push(this);else if((i=this.link)!=null&&i.is.bad)console.warn(`Group node "${this.name}" is missing. ModelBlueprint "${this.link.model.arl.userPath}" not found`);else if(!this.nodes)console.warn(`Group node "${this.name}" is empty`);else{for(const s of this.buses)s.is.cable&&s.is.filter&&t.push(s);for(const s of this.nodes)s.makeSourceLists(e,t)}},xxxduplicateFactory(e,t){const i=e.find(s=>s.arl.equals(t)?!1:s.items.find(n=>n==this.factory.fName));return i?(console.warn(`Duplicate factory name: ${this.factory.fName} is already defined in ${i.arl.userPath}`),this.factory.alias="_"+this.factory.fName,!0):(this.factory.alias=null,!1)}};function Js(e,t){this.model=e,this.lName=t,this.is={bad:!1}}Js.prototype={copy(){return new Js(this.model,this.lName)},toJSON(){return{path:this.model&&!this.model.is.main?this.model.arl.userPath:"./",node:this.lName}}};const _d={setLink(e,t){var i;this.link?(this.link.model=e,this.link.lName=t,(i=this.link.model)!=null&&i.is.lib?this.look.checkLinkIcon("lock"):this.look.checkLinkIcon("link")):(this.link=new Js(e,t),e!=null&&e.is.lib?this.look.addIcon("lock"):this.look.addIcon("link"))},clearLink(){this.look.removeLinkIcon(),this.is.source?this.look.addIcon("factory"):this.look.addIcon("group"),this.link=null},linkIsBad(){this.link.is.bad=!0,this.look.badLinkIcon()},linkIsGood(){this.link.is.bad=!1,this.look.goodLinkIcon()},adjustPaths(e){var t;if(this.link)this.link.model.arl.makeRelative(e);else if((t=this.factory)!=null&&t.arl)this.factory.arl.makeRelative(e);else if(this.nodes)for(const i of this.nodes)i.adjustPaths(e)}},Pd={getRoutes(){const e=[];for(const t of this.look.widgets)if(t.is.pin)for(const i of t.routes)e.push(i);return e},getAllRoutes(e){const t=[];for(const i of e)if(i.is.pin)for(const s of i.routes)t.push(s);return t},connect(){},disconnect(){for(const e of this.look.widgets)e.is.pin&&e.disconnect()},disconnectPinArea(e){for(const t of e)t.is.pin&&t.disconnect()},isConnected(){for(const e of this.look.widgets)if(e.is.pin&&e.routes.length>0)return!0;return!1},highLight(){this.is.highLighted=!0;for(const e of this.look.widgets)if(!(!e.is.pin||e.routes.length==0))for(const t of e.routes){const i=t.from===e?t.to:t.from;t.highLight(),i.is.tack&&i.bus.highLightRoutes(e)}},unHighLight(){this.is.highLighted=!1;for(const e of this.look.widgets)if(!(!e.is.pin||e.routes.length==0))for(const t of e.routes){const i=t.from===e?t.to:t.from;t.unHighLight(),i.is.tack&&i.bus.unHighLightRoutes(e)}}},Sd={acceptChanges(){var e;this.look&&this.look.acceptChanges(),(e=this.nodes)==null||e.forEach(t=>t.acceptChanges())},sxUpdate(e){e.sx&&(this.sx=ta(e.sx,this.sx))},sameRelativePosition(e,t,i){return{x:i.is.left?e.rect.x:e.rect.x+e.rect.w,y:e.rect.y+(i.rect.y-t.rect.y)}},prefixPinPosition(e,t){const i=t.getPrefix(),s=e.findInterfaceName(i),n=s?e.getInterface(s):null;if(!n)return console.log("*** InterfaceName not found ***"+i+"  "+t.name),{x:t.is.left?e.rect.x:e.rect.x+e.rect.w,y:e.rect.y+e.rect.h};const o=n.at(-1);return{x:t.is.left?e.rect.x:e.rect.x+e.rect.w,y:o.rect.y+o.rect.h}},newInterfaceNamePosition(e,t){const i={x:e.rect.x,y:e.rect.y+e.rect.h};for(const s of e.widgets)s.is.ifName&&(s.is.added||s.rect.y>t.rect.y&&s.rect.y<i.y&&(i.y=s.rect.y));return i},widgetCompare(e){const t=this.look,i=e.look;for(const n of t.widgets)n.wid&&(n.is.added=!1,n.is.zombie=!0);const s=i.widgets.slice().sort((n,o)=>n.rect.y-o.rect.y);for(const n of s){if(!n.is.ifName)continue;let o=t.widgets.find(r=>r.is.zombie&&r.is.ifName&&n.is.ifName&&r.text==n.text);if(o){o.is.zombie=!1,o.wid=n.wid;continue}if(o=t.widgets.find(r=>r.is.zombie&&r.is.ifName&&n.is.ifName&&r.wid==n.wid),o){this.dockInterfaceNameChange(o,n),o.is.zombie=!1;continue}this.dockNewInterfaceName(n)}for(const n of s){if(!n.is.pin)continue;let o=t.widgets.find(r=>r.is.zombie&&r.is.pin&&r.name==n.name&&r.is.input==n.is.input&&r.is.channel==n.is.channel);if(o){o.is.zombie=!1,o.wid=n.wid;continue}if(o=t.widgets.find(r=>r.is.zombie&&r.is.pin&&r.wid==n.wid&&r.is.input==n.is.input),o){this.dockPinChange(o,n),o.is.zombie=!1;continue}this.dockNewPin(n,e)}},dockNewPin(e,t){const i=e.pxlen!=0?this.prefixPinPosition(this.look,e):this.sameRelativePosition(this.look,t.look,e),s=this.look.addPin(e.name,i,e.is);s.profile=e.profile,s.pxlen=e.pxlen,s.is.added=!0},dockNewInterfaceName(e){const t=this.newInterfaceNamePosition(this.look,e),i=this.look.addIfName(e.text,t);i.is.added=!0},dockPinChange(e,t){if(t.is.channel!=e.is.channel&&(e.is.channel=t.is.channel),t.name!=e.name||t.pxlen!=e.pxlen){if(t.pxlen!=0&&t.getPrefix()!=e.getPrefix()){const i=this.prefixPinPosition(this.look,t);this.look.movePin(e,i)}e.name=t.name,e.pxlen=t.pxlen,e.is.multi=t.is.multi}t.is.input&&t.profile!=e.profile&&(e.profile=t.profile),e.is.added=!0},dockInterfaceNameChange(e,t,i){t.text!=e.text&&(e.text=t.text,e.is.added=!0,this.look.interfaceChangePrefix(e))}};function Gs(e,t){this.rect={...e},this.node=t,this.is={box:!0,selected:!1}}Gs.prototype={render(e){const{x:t,y:i,w:s,h:n}=this.rect,o=g.box;if(this.is.selected){const r=this.node.look.findLabel(),a=r&&r.text.length>0?r.rect.h:0,l=o.dxSel,c=o.dySel;W.roundedRect(e,t-l,i-c-a,s+2*l,n+2*c+a,o.rCorner,o.wLineSel,o.cSelected.slice(0,7),o.cSelected)}W.roundedRect(e,t,i,s,n,o.rCorner,o.wLine,o.cLine,o.cBackground)},increaseHeight(e){this.rect.h+=e},increaseWidth(e){this.rect.w+=e},toJSON(){return{box:k.relativeRect(this.rect,this.node.look.rect)}}};function Ys(e,t){this.rect={...e},this.is={header:!0,highLighted:!1},this.title=t.name,this.node=t}Ys.prototype={startEdit(){return"title"},endEdit(e){this.title=k.cleanInput(this.title),this.node.look.headerChanged(this,e)},drawCursor(e,t,i){const s=W.centerTextCursor(e,this.rect,this.title,t),n=i?g.std.cBlinkOn:g.std.cBlinkOff;W.cursor(e,s.x,s.y,g.std.wCursor,this.rect.h,n)},render(e){let t=g.header,{x:i,y:s,w:n,h:o}=this.rect;W.roundedHeader(e,i,s,n,o,t.rCorner,t.wLine,t.cBackground,t.cBackground);const r=this.node.is.duplicate?t.cBad:this.is.highLighted?t.cHighLighted:t.cTitle;W.centerText(e,this.title,t.font,r,i,s,n,o)},hitTitle(e){const t=g.icon,i=this.rect,s=i.x+t.xPadding+2*(t.wIcon+t.xSpacing),n=i.x+i.w-t.xPadding-2*(t.wIcon+t.xSpacing);return e.x>s&&e.x<n},toJSON(){return{header:this.title}}};const Ld={startEdit(){return this.pxlen&&(this.name=this.withoutPrefix(),this.pxlen=0),this.is.multi=!1,"name"},endEdit(e){this.checkNewName()?this.nameChanged(e):this.restoreSavedName(e)},displayName(){return this.pxlen==0?this.name:this.withoutPrefix()},nameClash(e){return this.is.input!=e.is.input?!1:this.lowerCase()==e.lowerCase()?!0:this.is.input?k.pinToHandler(this.name)==k.pinToHandler(e.name):!1},lowerCase(){return this.name.toLowerCase()},checkNewName(){var e,t;if(this.name=k.cleanInput(this.name),this.name.length==0)return((e=this.routes)==null?void 0:e.length)==0;if(k.needsPrefix(this.name)||k.needsPostfix(this.name)){if(this.name.length==1)return!1;this.addIfName()}else this.pxlen=0;return this.is.multi=k.isMulti(this.name),this.is.multi&&(this.name=k.cleanMulti(this.name)),this.checkRouteUsage(),(t=this.node.look)==null||t.adjustPinWidth(this),this.node.look.setDuplicatePin(this),!0},nameChanged(e){const t=this.is.input?this.node.rxTable.find(i=>i.pin==this):this.node.txTable.find(i=>i.pin==this);if(this.name.length==0){this.is.input?Re(this.node.rxTable,t):Re(this.node.txTable,t),this.node.look.removePin(this);return}},restoreSavedName(e){this.name=e,(k.needsPrefix(e)||k.needsPostfix(e))&&this.addIfName()},withoutPrefix(){if(this.pxlen==0)return this.name;if(this.pxlen>0){let t=this.name.slice(this.pxlen);return t[0]!=" "?t:"+ "+t.trim()}else if(this.pxlen<0){let t=this.name.slice(0,this.pxlen-1);return t.at(-1)!=" "?t:"+ "+t.trim()}},getPrefix(){return this.pxlen>0?this.name.slice(0,this.pxlen):this.pxlen<0?this.name.slice(this.pxlen):null},ifNamePrefixCheck(){var i;this.pxlen=0;const e=(i=this.node.look.findIfNameAbove(this.rect.y))==null?void 0:i.text.toLowerCase();if(!e)return;const t=this.lowerCase();k.prefixMatch(e,t)?this.pxlen=e.length:k.postfixMatch(e,t)&&(this.pxlen=-e.length)},addIfName(){const e=this.node.look.findIfNameAbove(this.rect.y);k.needsPrefix(this.name)?e?(this.name=k.combineWithPrefix(e.text,this.name),this.pxlen=e.text.length):(this.name=this.name.slice(1).trimStart(),this.pxlen=0):k.needsPostfix(this.name)&&(e?(this.name=k.combineWithPostfix(e.text,this.name),this.pxlen=-e.text.length):(this.name=this.name.slice(0,-1).trimEnd(),this.pxlen=0))},checkPrefix(){if(this.pxlen==0)return;const e=this.getPrefix(),t=this.node.look.findIfNameAbove(this.rect.y);t&&e==t.text||(this.pxlen=0)},changePrefix(e){if(this.pxlen==0)return;if(e.length==0){this.pxlen=0;return}const t=this.pxlen>0?"+"+this.name.slice(this.pxlen+1):this.name.slice(0,this.pxlen-1)+"+";this.name=k.combineWithPrefix(e,t),this.pxlen=this.pxlen>0?e.length:-e.length},checkRouteUsage(){for(const e of this.routes)e.is.notUsed=!1;for(const e of this.routes){const t=e.from==this?e.to:e.from;if(e.is.twistedPair=t.is.multi||this.is.multi,t.is.pin)(t.is.multi||this.is.multi)&&!this.hasMultiOverlap(t)&&(e.is.notUsed=!0);else if(t.is.pad)(this.is.multi||t.proxy.is.multi)&&!this.hasMultiOverlap(t.proxy)&&(e.is.notUsed=!0);else if(t.is.tack){let i=!1;for(const s of t.bus.tacks){if(s==t)continue;const n=s.route.to==s?s.route.from:s.route.to;t.bus.areConnected(this,n)&&(s.route.is.notUsed=!1,i=!0)}i||(e.is.notUsed=!0)}}},extractMultis(){return k.extractMultis(this.name)},expandMultis(){return k.expandMultis(this.name)},hasFullNameMatch(e){const t=e.is.multi?k.expandMultis(e.lowerCase()):[e.lowerCase()],i=this.is.multi?k.expandMultis(this.lowerCase()):[this.lowerCase()];for(const s of t)if(i.includes(s))return!0;return!1},hasMultiOverlap(e){return e.is.multi?this.is.multi?this.checkMultiPartOnly(e):e.checkPartial(this.lowerCase()):this.is.multi?this.checkPartial(e.lowerCase()):!1},checkMultiPartOnly(e){const t=k.extractMultis(e.lowerCase()),i=k.extractMultis(this.lowerCase());for(const s of t)if(i.includes(s))return!0;return!1},checkPartial(e){const t=k.extractMultis(this.lowerCase());for(const i of t)if(e.indexOf(i)>=0)return!0;return!1},getMatch(e){if(this.is.multi){const t=k.extractMultis(this.lowerCase()),i=k.expandMultis(this.lowerCase());for(let s=0;s<t.length;s++)if(e.includes(t[s]))return i[s]}return null}};function yi(e,t,i,s){this.rect={...e},this.node=t,this.name=i,this.pxlen=0,this.wid=0,this.is={pin:!0,proxy:!1,channel:s.channel??!1,input:s.input??!1,left:s.left??!1,multi:s.multi??!1,selected:!1,highLighted:!1,hoverOk:!1,hoverNok:!1,zombie:s.zombie??!1,added:!1,duplicate:!1},this.profile="",this.prompt="",this.routes=[]}yi.prototype={drawCursor(e,t,i){const s=this.rect,n=g.pin.wMargin,o=e.measureText(this.name.slice(0,t)).width,r=this.is.left?s.x+n+o:s.x+s.w-n-e.measureText(this.name).width+o,a=i?g.std.cBlinkOn:g.std.cBlinkOff;W.cursor(e,r,s.y,g.std.wCursor,s.h,a)},render(e){const t=g.pin,i=this.rect,s=this.pxlen==0?this.name:this.withoutPrefix(),{cArrow:n,cText:o}=this.setColor(),r=i.y+(t.hPin-t.wArrow)/2,a=g.box.wLine/2,l=this.is.channel?W.triangleBall:W.leftTriangle,c=this.is.channel?W.ballTriangle:W.rightTriangle;if(this.is.left){const h=i.x+t.wOutside;this.is.multi?W.leftTextMulti(e,s,t.fMulti,o,i.x+g.pin.wMargin,i.y,i.w,i.h):W.leftText(e,s,o,i.x+g.pin.wMargin,i.y,i.w,i.h),this.is.input?c(e,h-a,r,t.hArrow,t.wArrow,n):l(e,h-t.hArrow+a,r,t.hArrow,t.wArrow,n)}else{const h=i.x+i.w-t.wOutside;this.is.multi?W.rightTextMulti(e,s,t.fMulti,o,i.x,i.y,i.w-g.pin.wMargin,i.h):W.rightText(e,s,o,i.x,i.y,i.w-g.pin.wMargin,i.h),this.is.input?l(e,h-t.hArrow+a,r,t.hArrow,t.wArrow,n):c(e,h-a,r,t.hArrow,t.wArrow,n)}this.is.duplicate&&W.rectRect(e,i.x,i.y,i.w,i.h,t.cBad,null)},setColor(){const e=this.is.hoverNok?g.pin.cBad:this.is.hoverOk?g.pin.cSelected:this.is.highLighted?g.pin.cHighLighted:this.is.selected?g.pin.cSelected:this.routes.length>0?g.pin.cConnected:g.pin.cNormal,t=this.is.hoverNok?g.pin.cBad:this.is.hoverOk?g.pin.cSelected:this.is.added?g.pin.cAdded:this.is.zombie?g.pin.cBad:this.is.highLighted?g.pin.cHighLighted:this.is.selected?g.pin.cSelected:this.routes.length>0?g.pin.cConnected:g.pin.cText;return{cArrow:e,cText:t}},center(){const e=g.pin.wOutside,t=this.rect;return this.is.left?{x:t.x+e,y:t.y+t.h/2}:{x:t.x+t.w-e,y:t.y+t.h/2}},canConnect(e){return!(this==e||this.is.input===e.is.input||(this.is.multi||e.is.multi)&&!this.hasMultiOverlap(e)||this.haveRoute(e))},areConnected(e){if(e.is.pin){if(e.is.input==this.is.input||(e.is.multi||this.is.multi)&&!this.hasMultiOverlap(e))return!1}else if(e.is.pad&&(e.proxy.is.input!=this.is.input||e.proxy.is.multi&&!this.hasMultiOverlap(e.proxy)))return!1;return!0},toJSON(){this.is.input?this.is.channel:this.is.channel;const e={name:this.name,kind:this.is.input?this.is.channel?"reply":"input":this.is.channel?"request":"output",editor:{id:this.wid,align:this.is.left?"left":"right"}};return this.is.proxy&&(e.editor.pad={rect:k.rectToString(this.pad.rect),align:this.pad.is.leftText?"left":"right"}),e},removeRoute(e){Re(this.routes,e)},adjustRoutes(){for(const e of this.routes)e.adjust()},leftRightSwap(){const e=this.node.look.rect;this.rect.x=this.is.left?e.x+e.w-this.rect.w+g.pin.wOutside:e.x-g.pin.wOutside,this.is.left=!this.is.left,this.adjustRoutes()},drag(e){const t=this.node.look.rect,i=t.x+t.w/2;(this.is.left&&e.x>i||!this.is.left&&e.x<i)&&this.leftRightSwap();const s=this.node.look.findNextWidget(this,e,n=>n.is.pin||n.is.ifName);s&&([this.rect.y,s.rect.y]=[s.rect.y,this.rect.y],s.is.ifName&&this.ifNamePrefixCheck(),this.adjustRoutes(),s.is.pin&&s.adjustRoutes())},moveTo(e,t){e!=this.is.left&&this.leftRightSwap();const i=this.rect;for(const s of this.node.look.widgets){const n=s.rect;i.y>t&&n.y>=t&&n.y<i.y&&(n.y+=i.h,s.is.pin&&s.adjustRoutes()),i.y<t&&n.y<=t&&n.y>i.y&&(n.y-=i.h,s.is.pin&&s.adjustRoutes())}i.y=t,this.adjustRoutes()},disconnect(){const e=this.routes.slice();for(const t of e){const i=t.from==this?t.to:t.from;i.is.pin?t.rxtxPinPinDisconnect():i.is.pad?t.rxtxPinPadDisconnect():i.is.tack&&t.rxtxPinBusDisconnect(),t.remove()}},reconnect(e){this.routes=e;for(const t of e){const i=t.from==this?t.to:t.from;i.is.pin?(i.routes.push(t),t.rxtxPinPin()):i.is.pad?(i.routes.push(t),t.rxtxPinPad()):i.is.tack&&(i.bus.tacks.push(i),t.rxtxPinBus())}},haveRoute(e){for(const t of this.routes)if(t.from==e||t.to==e)return!0;return!1},ioSwap(){return this.routes.length>0||this.is.proxy&&this.pad.routes.length>0?!1:(this.is.input=!this.is.input,!0)},channelOnOff(){this.is.channel=!this.is.channel;for(const e of this.routes){const t=e.from==this?e.to:e.from;t.is.tack&&(t.is.channel=this.is.channel)}return!0},doSelect(){this.is.selected=!0},unSelect(){this.is.selected=!1},highLight(){this.is.highLighted=!0},unHighLight(){this.is.highLighted=!1},highLightRoutes(){for(const e of this.routes){const t=e.from==this?e.to:e.from;if(t){if(t.is.pin){if(!this.areConnected(t))continue;e.highLight();continue}if(t.is.pad){if(!this.areConnected(t))continue;e.highLight();continue}t.is.tack&&(e.highLight(),t.bus.highLightRoutes(this))}}},unHighLightRoutes(){for(const e of this.routes){e.unHighLight();const t=e.from==this?e.to:e.from;if(t){if(t.is.pin){if(!this.areConnected(t))continue;t.is.proxy&&t.pad.unHighLightRoutes();continue}if(t.is.pad){if(!this.areConnected(t))continue;t.proxy.unHighLightRoutes();continue}t.is.tack&&t.bus.unHighLightRoutes(this)}}},makePadRect(e){const t=g.pad.wExtra+this.node.look.getTextWidth(this.name,this.is.multi);return this.is.left?{x:e.x,y:e.y-g.pad.hPad/2,w:t,h:g.pad.hPad}:{x:e.x,y:e.y-g.pad.hPad/2,w:t,h:g.pad.hPad}}};Object.assign(yi.prototype,Ld);function ys(e,t,i,s){yi.call(this,e,t,i,s),this.is.proxy=!0,this.pad=null}const Nd={makeConxList(e){var t;for(const i of this.routes){const s=i.from==this?i.to:i.from;this.areConnected(s)&&(s.is.pin?s.is.proxy?(t=s.pad)==null||t.makeConxList(e):e.push(s):s.is.pad?s.proxy.makeConxList(e):s.is.tack&&(s.bus.hasFilter()?e.push(s):s.bus.makeConxList(this,e)))}},nameChanged(e){var i;const t=this.node.pads.find(s=>s.proxy==this);if(!t){console.log(`** No pad was found for this pin "${this.name}" - pin was removed`),this.node.look.removePin(this);return}if(this.name.length>0){t.nameChange(this.name);return}((i=t.routes)==null?void 0:i.length)>0?this.restoreSavedName(e):(this.node.look.removePin(this),this.node.removePad(t))}};Object.assign(ys.prototype,yi.prototype,Nd);function fs(e,t=null){this.rect={x:0,y:0,w:0,h:0},this.is={tack:!0,selected:!1,highLighted:!1,channel:!1,top:!1},this.bus=e,this.wid=t??e.generateWid(),this.segment=0,this.dir="",this.route=null}fs.prototype={render(e){const t=this.is.selected?g.bus.cSelected:this.is.highLighted?g.bus.cHighLighted:g.bus.cNormal;this.bus.is.filter&&W.filterSign(e,this.getContactPoint(),g.bus.wCable,t),W.tack(e,this.dir,this.is.channel,this.is.top,this.rect,g.route.wNormal,t)},setRoute(e){this.route=e,e.to?e.from||(e.from=this):e.to=this;const t=e.from==this?e.to:e.from;this.is.channel=t.is.pad?t.proxy.is.channel:t.is.channel,this.is.top=t.is.pad?!t.proxy.is.input:t.is.input,this.orient()},orient(){const e=h=>h.is.pin?h.is.input:!h.proxy.is.input,t=this.route.wire,i=this.bus.wire,s=this.route.to==this?this.route.from:this.route.to,n=this.route.to==this?t.at(-1):t[0],o=this.route.to==this?t.at(-2):t[1];this.segment=this.bus.hitSegment(n),this.segment==0&&(console.error("*** SEGMENT ON BUS NOT FOUND ***",s,this.bus),this.segment=1);const r=Math.floor(i[this.segment-1].y)===Math.floor(i[this.segment].y),a=this.rect,l=i[this.segment],c=g.bus.wNormal/2-1;r?(a.w=g.bus.wArrow,a.h=g.bus.hArrow,a.x=n.x-a.w/2,o.y>n.y?(a.y=l.y+c,this.dir=e(s)?"down":"up"):(a.y=l.y-a.h-c,this.dir=e(s)?"up":"down"),n.y=l.y):(a.w=g.bus.hArrow,a.h=g.bus.wArrow,a.y=n.y-a.h/2,o.x>n.x?(a.x=l.x+c,this.dir=e(s)?"right":"left"):(a.x=l.x-a.w-c,this.dir=e(s)?"left":"right"),n.x=l.x)},placeOnSegment(e,t){this.segment=t;const i=this.bus.wire[t-1],s=this.bus.wire[t];i.x==s.x?(this.dir="left",this.rect.x=i.x,this.rect.y=e.y):(this.dir="up",this.rect.x=e.x,this.rect.y=i.y)},horizontal(){return this.dir=="left"||this.dir=="right"},center(){const e=this.rect;if(this.segment==0)return null;const t=this.bus.wire[this.segment];return this.dir=="left"||this.dir=="right"?{x:t.x,y:e.y+e.h/2}:{x:e.x+e.w/2,y:t.y}},toJSON(){return k.routeToString(this.route)},overlap(e){const t=this.rect;return!(t.x>e.x+e.w||t.x+t.w<e.x||t.y>e.y+e.h||t.y+t.h<e.y)},remove(){this.route.remove()},removeRoute(e){this.bus.removeTack(this)},moveX(e){this.rect.x+=e;const t=this.route.from==this?this.route.wire[0]:this.route.wire.at(-1);t.x+=e,this.orient()},moveY(e){this.rect.y+=e;const t=this.route.from==this?this.route.wire[0]:this.route.wire.at(-1);t.y+=e,this.orient()},moveXY(e,t){this.rect.x+=e,this.rect.y+=t,this.route.wire.length==2&&this.route.addTwoSegments(this.route.wire[0],this.route.wire[1]);const i=this.route.from==this?this.route.wire[0]:this.route.wire.at(-1),s=this.route.from==this?this.route.wire[1]:this.route.wire.at(-2);Math.abs(i.x-s.x)<Math.abs(i.y-s.y)?(i.x+=e,s.x+=e,i.y+=t):(i.y+=t,s.y+=t,i.x+=e),this.orient()},slide(e){let t=this.bus.wire[this.segment-1],i=this.bus.wire[this.segment];const s=this.rect,n=g.bus.wNormal;if(t.y==i.y){let o=Math.max(t.x,i.x)-s.w-n/2,r=Math.min(t.x,i.x)+n/2;s.x+=e.x,s.x=s.x>o?o:s.x<r?r:s.x}else{let o=Math.max(t.y,i.y)-s.h-n/2,r=Math.min(t.y,i.y)+n/2;s.y+=e.y,s.y=s.y>o?o:s.y<r?r:s.y}this.route.adjust()},fuseEndSegment(){if(this.route.wire.length<4)return;const e=this.route,t=e.wire,[i,s,n,o]=this==e.from?[t[0],t[1],t[2],!0]:[t.at(-1),t.at(-2),t.at(-3),!1];i.y==s.y&&Math.abs(n.y-s.y)<g.route.tooClose?(i.y=n.y,o?e.removeTwoPoints(1,t):e.removeTwoPoints(t.length-3,t),this.orient()):i.x==s.x&&Math.abs(s.x-n.x)<g.route.tooClose&&(i.x=n.x,o?e.removeTwoPoints(1,t):e.removeTwoPoints(t.length-3,t),this.orient())},restore(e){this.route=e,this.bus.tacks.push(this),this.orient()},getOther(){return this.route.from==this?this.route.to:this.route.from},getOtherPin(){const e=this.route.from==this?this.route.to:this.route.from;return e.is.pin?e:e.is.pad?e.proxy:null},getContactPoint(){return this.route.from==this?this.route.wire[0]:this.route.wire.at(-1)},incoming(){const e=this.route.from==this?this.route.to:this.route.from;return e.is.pin?!e.is.input:e.is.pad?e.proxy.is.input:!1},highLightRoutes(){},unHighLightRoutes(){}};function $n(e,t){this.rect={...e},this.is={busLabel:!0,beingEdited:!1,highLighted:!1,horizontal:!0},this.text=t.name,this.bus=t}const Cd={makeRect(e,t,i,s){const n=this.rect;this.is.horizontal=Math.abs(e.x-t.x)>0,this.is.horizontal?(n.x=e.x<t.x?e.x-i:e.x,n.y=e.y-s/2,n.h=s,n.w=i):(n.x=e.x-s/2,n.y=e.y<t.y?e.y-i:e.y,n.h=i,n.w=s,e.y==t.y&&this==this.bus.startLabel&&(n.y=e.y-i))},place(){const e=g.bus,t=this.bus.wire,i=this.text.length*e.sChar+2*e.hLabel;this==this.bus.startLabel?this.makeRect(t[0],t[1],i,e.hLabel):this.makeRect(t.at(-1),t.at(-2),i,e.hLabel)},startEdit(){return this.is.beingEdited=!0,"text"},endEdit(e){this.setText(this.text),this.is.beingEdited=!1},setText(e){const t=this==this.bus.startLabel?this.bus.endLabel:this.bus.startLabel;this.bus.name=e,this.text=e,t.text=e,this.place(),t.place()},drawCursor(e,t,i){const s=W.centerTextCursor(e,this.rect,this.text,t),n=i?g.std.cBlinkOn:g.std.cBlinkOff;this.is.horizontal?W.cursor(e,s.x,s.y,g.std.wCursor,this.rect.h,n):W.cursor(e,this.rect.x,s.y+.75*this.rect.w,this.rect.w,g.std.wCursor,n)},render(e,t){if(this.is.beingEdited){const r=this==this.bus.startLabel?this.bus.endLabel:this.bus.startLabel;r.text=this.text,this.place(),r.place()}const i=g.bus,s=this.rect,n=this.bus.is,o=n.hoverNok?i.cBad:n.selected||n.hoverOk?i.cSelected:n.highLighted?i.cHighLighted:i.cNormal;this.bus.is.filter&&W.filterSymbol(e,s.x-i.wFilter,s.y-i.wFilter,i.wFilter,o),this.bus.is.cable?this.is.horizontal?W.hCableLabel(e,this.text,s.x,s.y,s.w,s.h,i.radius,o,i.cText):W.vCableLabel(e,this.text,s.x,s.y,s.w,s.h,i.radius,o,i.cText):this.is.horizontal?W.hBusbarLabel(e,this.text,s.x,s.y,s.w,s.h,i.radius,o,i.cText):W.vBusbarLabel(e,this.text,s.x,s.y,s.w,s.h,i.radius,o,i.cText)},setSize(e){return this.rect.w=e.measureText(this.text).width+2*g.bus.hLabel,this.rect.h=g.bus.hLabel,this},move(e,t){this.rect.x+=e,this.rect.y+=t},highLight(){this.is.highLighted=!0},unHighLight(){this.is.highLighted=!1},inside(e){return st({x:this.rect.x,y:this.rect.y},e)}};Object.assign($n.prototype,Cd);function Xs(e,t,i){this.rect={...e},this.node=i,this.is={ifName:!0,added:!1,zombie:!1,selected:!1,highLighted:!1},this.text=t??"",this.wid=0}Xs.prototype={startEdit(){return"text"},endEdit(e){this.text=k.cleanInput(this.text),this.node.look.ifNameChanged(this,e)},drawCursor(e,t,i){const s=W.centerTextCursor(e,this.rect,this.text,t),n=i?g.std.cBlinkOn:g.std.cBlinkOff;W.cursor(e,s.x,s.y,g.std.wCursor,this.rect.h,n)},render(e,t){const{x:i,y:s,w:n,h:o}=this.rect,r=g.ifName,a=this.is.added?r.cAdded:this.is.zombie?r.cBad:this.is.highLighted?r.cHighLighted:this.is.selected?r.cSelected:r.cNormal;W.interfaceText(e,this.text,r.font,a,r.cBackground,i,s,n,o)},toJSON(){return{ifPins:this.text,id:this.wid}},drag(e){this.node.look.rect;const t=this.node.look.findNextWidget(this,e,i=>i.is.pin||i.is.ifName);t&&([this.rect.y,t.rect.y]=[t.rect.y,this.rect.y],t.is.pin&&t.ifNamePrefixCheck(),t.is.pin&&t.adjustRoutes())},moveTo(e){const t=this.rect;for(const i of this.node.look.widgets){const s=i.rect;t.y>e&&s.y>=e&&s.y<t.y&&(s.y+=t.h,i.is.pin&&i.adjustRoutes()),t.y<e&&s.y<=e&&s.y>t.y&&(s.y-=t.h,i.is.pin&&i.adjustRoutes())}t.y=e},highLight(){this.is.highLighted=!0},unHighLight(){this.is.highLighted=!1},doSelect(){this.is.selected=!0},unSelect(){this.is.selected=!1}};function Ks(e,t,i){this.rect={...e},this.node=i,this.is={label:!0},this.text=t}Ks.prototype={startEdit(){return"text"},endEdit(e){},drawCursor(e,t,i){const s=this.rect,n=W.labelCursor(e,this.text,s.x,s.y,s.w,s.h,t),o=i?g.std.cBlinkOn:g.std.cBlinkOff;W.cursor(e,n.x,n.y,g.std.wCursor,s.h,o)},render(e,t){const{x:i,y:s,w:n,h:o}=this.rect;W.labelText(e,this.text,g.label.font,g.label.cNormal,i,s,n,o)},toJSON(){return this.text}};function pn(e,t){this.rect={...e},this.is={icon:!0,bad:!1,highLighted:!1},this.type=t,this.render=()=>{console.warn("Missing render function for icon ",this.type)}}pn.prototype={setRender(){this.render=this.renderFunctions[this.type]||this.renderFunctions.dummy},switchType(e){this.type=e,this.setRender()},renderFunctions:{link(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?g.icon.cHighLighted:this.is.bad?g.icon.cBadLink:g.icon.cLink;Qe.link(e,t,i,s,n,o)},lock(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?g.icon.cHighLighted:this.is.bad?g.icon.cBadLink:g.icon.cLink;Qe.lock(e,t,i,s,n,o)},factory(e){const{x:t,y:i,w:s,h:n}={...this.rect};Qe.factory(e,t,i,s,n,g.icon.cSrc)},group(e){const{x:t,y:i,w:s,h:n}={...this.rect};Qe.group(e,t,i,s,n,g.icon.cGroup)},cog(e){const{x:t,y:i,w:s,h:n}={...this.rect};Qe.cog(e,t,i,s,n,g.icon.cCog,g.header.cBackground)},pulse(e){const{x:t,y:i,w:s,h:n}={...this.rect};Qe.pulse(e,t,i,s,n,g.icon.cPulse,g.header.cBackground)},comment(e){const{x:t,y:i,w:s,h:n}={...this.rect};Qe.comment(e,t,i,s,n,g.icon.cComment)},close(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?g.view.cClose:g.view.cDim;Qe.close(e,t,i,s,n,o)},big(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?g.view.cFullscreen:g.view.cDim;Qe.bigView(e,t,i,s,n,o)},small(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?g.view.cFullscreen:g.view.cDim;Qe.smallView(e,t,i,s,n,o)},calibrate(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?g.view.cCalibrate:g.view.cDim;Qe.calibrate(e,t,i,s,n,o)},grid(e){const{x:t,y:i,w:s,h:n}={...this.rect},o=this.is.highLighted?g.view.cGrid:g.view.cDim;Qe.grid(e,t,i,s,n,o)},dummy(e){console.warn("Cannot render unknown icon type:",this)}},toJSON(){}};function oa(e,t){this.rect={...e},this.is={viewTitle:!0,highLighted:!1},this.node=t,this.text=t.name}oa.prototype={startEdit(){return"text"},endEdit(e){node.name=this.text},render(e){const t=this.rect,i=g.view,s=this.is.highLighted?i.cHighLight:i.cLine,n=this.is.highLighted?i.cTitleHighLight:i.cTitle;if(W.roundedHeader(e,t.x,t.y,t.w,i.hHeader,i.rCorner,i.wLine,null,s),W.centerText(e,this.node.name,g.view.fHeader,n,t.x,t.y,t.w,t.h),this.textEdit){let o=W.centerTextCursor(e,t,this.node.name,this.textEdit.cursor);W.cursor(e,o.x,o.y,2,t.h,n)}}};function ra(e){this.rect={...e},this.is={viewBox:!0,highLighted:!1}}ra.prototype={render(e){const t=this.rect,i=g.view,s=this.is.highLighted?i.cHighLight:i.cLine;W.viewRect(e,t.x,t.y,t.w,t.h,i.rCorner,i.wLine,s,i.cBackground)}};const Rd={addWidget(e){this.widgets.push(e),this.rect.h+=e.rect.h;const t=this.widgets.find(i=>i.is.box);t&&t.increaseHeight(e.rect.h),e.wid!=null&&(e.wid=this.generateWid())},generateWid(){return++this.widGenerator},addBox(){const e=new Gs(this.rect,this.node);this.widgets.push(e)},findLabel(){for(const e of this.widgets)if(e.is.label)return e;return null},setDuplicatePin(e){e.is.duplicate=!1;const t=[];for(const i of this.widgets)!i.is.pin||i==e||(i.is.duplicate&&t.push(i),(e.nameClash(i)||e.hasFullNameMatch(i))&&(e.is.duplicate=i.is.duplicate=!0));if(t.length!=0){for(const i of t)i.is.duplicate=!1;for(let i=0;i<t.length;i++)if(!t[i].is.duplicate)for(let s=i+1;s<t.length;s++)(t[i].nameClash(t[s])||t[i].hasFullNameMatch(t[s]))&&(t[i].is.duplicate=t[s].is.duplicate=!0)}},makePlace(e,t){let i=this.rect.y+this.rect.h-g.look.hBottom;if(!e)return i;for(const s of this.widgets)(s.is.pin||s.is.ifName)&&s.rect.y+s.rect.h/2>e.y&&(s.rect.y<i&&(i=s.rect.y),s.rect.y+=t,s.routes&&s.adjustRoutes());return i},pinRectangle(e,t,i,s=!1){const n=g.pin;let o=this.rect;const r=n.wMargin+this.getTextWidth(e,s);r>o.w&&this.wider(r-o.w);const a=this.makePlace({x:0,y:t},g.pin.hPin);return i?{x:o.x-n.wOutside,y:a,w:r,h:n.hPin}:{x:o.x+o.w-r+n.wOutside,y:a,w:r,h:n.hPin}},nextPinPosition(e){const t=this.rect;return{x:e?t.x:t.x+t.w,y:t.y+t.h-g.look.hBottom}},shiftUp(e,t){for(const i of this.widgets)if(i.is.box)i.rect.h-=t;else if(i.rect.y>e&&(i.rect.y-=t,i.routes))for(const s of i.routes)s.clampToWidget(i);this.rect.h-=t},movePin(e,t){const i=e.rect.y,s=e.rect.h;e.rect.y=this.makePlace(t,e.rect.h);for(const n of e.routes)n.clampToWidget(e);for(const n of this.widgets)if(n.rect.y>i&&(n.rect.y-=s,n.routes))for(const o of n.routes)o.clampToWidget(n)},ifNameChanged(e,t){if(this.interfaceChangePrefix(e),e.text.length>0){let i=this.getTextWidth(e.text);i>this.rect.w&&this.wider(i-this.rect.w)}else e.node.look.removeInterfaceName(e)},NEW_findPin(e,t=!0){for(const i of this.widgets)if(i.is.pin&&i.name==e)return i;return null},findPin(e,t=!0){for(const i of this.widgets)if(i.is.pin&&i.name==e&&i.is.input==t)return i;return null},findInterfaceName(e){for(const t of this.widgets)if(t.is.ifName&&t.text==e)return t;return null}},A={nothing:0,node:1,pin:2,ifName:3,icon:4,header:5,label:6,pad:7,padArrow:8,route:9,busSegment:10,busLabel:11,tack:12,selection:13},Ie=0,Fe=1,je=2,jn=4,Ed={keyMask(e){let t=Ie;return t|=e.shiftKey?Fe:0,t|=e.ctrlKey?je:0,t|=e.altKey?jn:0,t},mouseHit(e){const t=this.hit;if(this.selection.what!=H.nothing&&this.selection.what!=H.singleNode&&([t.what,t.selection,t.node]=this.selection.hitTest(e),t.what!=A.nothing)||!this.root)return;const i=this.root.nodes;for(let s=i.length-1;s>=0;s--)if([t.what,t.node,t.lookWidget]=i[s].hitTest(e),t.what!=A.nothing)return;for(const s of this.root.pads)if([t.what,t.pad]=s.hitTest(e),t.what!=A.nothing)return;for(const s of this.root.buses)if([t.what,t.bus,t.busLabel,t.tack,t.busSegment]=s.hitTest(e),t.what!=A.nothing)return;this.mouseHitRoutes(e)},mouseHitRoutes(e){const t=this.hit;for(const i of this.root.nodes)if([t.what,t.route,t.routeSegment]=i.hitRoute(e),t.what!=A.nothing)return;for(const i of this.root.pads)if([t.what,t.route,t.routeSegment]=i.hitRoute(e),t.what!=A.nothing)return;for(const i of this.root.buses)if([t.what,t.route,t.routeSegment]=i.hitRoute(e),t.what!=A.nothing)return},onDblClick(e,t){const i=this.hit;switch(i.what){case A.pin:case A.ifName:if(!i.node||i.node.cannotBeModified())return;u.doEdit("widgetTextEdit",{view:this,widget:i.lookWidget});break;case A.header:u.doEdit("widgetTextEdit",{view:this,widget:i.lookWidget});break;case A.label:u.doEdit("widgetTextEdit",{view:this,widget:i.lookWidget});break;case A.busLabel:u.doEdit("widgetTextEdit",{view:this,widget:i.busLabel});break;case A.pad:u.doEdit("widgetTextEdit",{view:this,widget:i.pad});break}},onWheel(e,t){const i=this.tf;let s=t.deltaY>0?.9:1.1;i.dx=i.dx+e.x*i.sx*(1-s),i.dy=i.dy+e.y*i.sy*(1-s),i.sx*=s,i.sy*=s}},Md={pinAreaStart(e,t){this.reset();const i=e.look.rect;this.yWidget=t.y,this.what=H.pinArea,this.activate(i.x-g.pin.wOutside,t.y,i.w+2*g.pin.wOutside,0,g.selection.cRect)},pinAreaResize(e,t){const i=e.look.rect;if(t.y>i.y&&t.y<i.y+i.h){const s=this.yWidget;t.y>s?(this.rect.y=s,this.rect.h=t.y-s):(this.rect.y=t.y,this.rect.h=s-t.y),this.widgets=[];const n=g.pin.hPin/2;for(const o of e.look.widgets)(o.is.pin||o.is.ifName)&&(o.rect.y+n>this.rect.y&&o.rect.y+n<this.rect.y+this.rect.h?(this.widgets.push(o),o.is.selected=!0):o.is.selected=!1)}},pinAreaSelect(e){if(e.length!=0){this.widgets.length=0;for(const t of e)(t.is.pin||t.is.ifName)&&(this.widgets.push(t),t.is.selected=!0);this.pinAreaRectangle()}},pinAreaRectangle(){if(this.widgets.length==0)return;this.widgets.sort((s,n)=>s.rect.y-n.rect.y);const e=this.widgets[0].node.look,t=this.widgets[0].rect,i=this.widgets.at(-1).rect;this.activate(e.rect.x-g.pin.wOutside,t.y,e.rect.w+2*g.pin.wOutside,i.y+i.h-t.y,g.selection.cRect),this.what=H.pinArea},pinAreaDrag(e){if(this.widgets.length==0)return;const t=this.widgets[0].node;this.rect.y+e.y<t.look.rect.y+g.header.hHeader||this.rect.y+e.y>t.look.rect.y+t.look.rect.h||(this.rect.y+=e.y)}},H={nothing:0,freeRect:1,pinArea:2,singleNode:4,multiNode:5};function xs(e=null){this.rect={x:0,y:0,w:0,h:0},this.yWidget=0,this.color=g.selection.cRect,this.what=H.nothing,this.viewPath=e?e.getNamePath():"",this.nodes=[],this.pads=[],this.buses=[],this.tacks=[],this.widgets=[]}xs.prototype={render(e){if(this.what===H.freeRect||this.what===H.pinArea){const t=this.rect;W.roundedRect(e,t.x,t.y,t.w,t.h,g.selection.rCorner,1,this.color.slice(0,7),this.color)}},reset(){this.what=H.nothing,this.yWidget=0;for(const e of this.widgets)e.unSelect();for(const e of this.nodes)e.unSelect();this.nodes.length=0,this.pads.length=0,this.buses.length=0,this.widgets.length=0,this.tacks.length=0},shallowCopy(){var t,i,s,n,o;const e=new xs;return e.rect={...this.rect},e.yWidget=this.yWidget,e.color=this.color,e.what=this.what,e.viewPath=this.viewPath,e.nodes=(t=this.nodes)==null?void 0:t.slice(),e.pads=(i=this.pads)==null?void 0:i.slice(),e.buses=(s=this.buses)==null?void 0:s.slice(),e.tacks=(n=this.tacks)==null?void 0:n.slice(),e.widgets=(o=this.widgets)==null?void 0:o.slice(),e},canCancel(e){return e.what==A.selection?!1:this.what===H.freeRect||this.what===H.pinArea},setRect(e,t,i,s){const n=this.rect;n.x=e,n.y=t,n.w=i,n.h=s},activate(e,t,i,s,n){this.setRect(e,t,i,s),n&&(this.color=n)},freeStart(e){this.reset(),this.what=H.freeRect,this.setRect(e.x,e.y,0,0)},singleNode(e){this.reset(),this.nodes=[e],this.what=H.singleNode,e.doSelect()},singleNodeAndWidget(e,t){this.reset(),this.singleNode(e),this.widgets=[t],t.doSelect()},extend(e){if(this.nodes.length<1){this.singleNode(e);return}if(this.nodes.includes(e)){Re(this.nodes,e),e.unSelect();return}this.nodes.push(e),e.doSelect(),this.what=H.multiNode},getSingleNode(){return this.what==H.singleNode?this.nodes[0]:null},getSelectedWidget(){return this.what==H.singleNode?this.widgets[0]:null},getPinAreaNode(){return this.what==H.pinArea&&this.widgets[0]?this.widgets[0].node:null},switchWidget(e){var s;if(e){(s=this.widgets[0])==null||s.unSelect(),e.doSelect(),this.widgets[0]=e;return}const t=this.widgetBelow();if(t)return this.switchWidget(t);const i=this.widgetAbove();if(i)return this.switchWidget(i)},widgetBelow(){const[e,t]=this.what!=H.singleNode?[null,null]:[this.nodes[0],this.widgets[0]];if(!t||!e)return null;let i=null;for(const s of e.look.widgets)(s.is.pin||s.is.ifName)&&s.rect.y>t.rect.y&&(!i||s.rect.y<i.rect.y)&&(i=s);return i},widgetAbove(){const[e,t]=this.what!=H.singleNode?[null,null]:[this.nodes[0],this.widgets[0]];if(!t||!e)return null;let i=null;for(const s of e.look.widgets)(s.is.pin||s.is.ifName)&&s.rect.y<t.rect.y&&(!i||s.rect.y>i.rect.y)&&(i=s);return i},hitTest(e){if((this.what==H.freeRect||this.what==H.pinArea)&&st(e,this.rect))return[A.selection,this,null];for(let t=this.nodes.length-1;t>=0;t--)if(st(e,this.nodes[t].look.rect))return[A.selection,this,this.nodes[t]];return[A.nothing,null,null]},setColor(e){this.color=e},resize(e,t){this.rect.w+=e,this.rect.h+=t},move(e){this.rect.x+=e.x,this.rect.y+=e.y},drag(e){for(const t of this.nodes)t.look.moveDelta(e.x,e.y);for(const t of this.pads)t.move(e);if(this.nodes.length>0)for(const t of this.buses)t.move(e.x,e.y);else for(const t of this.tacks)t.slide(e);for(const t of this.nodes)t.look.adjustRoutes();for(const t of this.pads)t.adjustRoutes();for(const t of this.buses)t.adjustRoutes();this.rect.x+=e.x,this.rect.y+=e.y},topLeftNode(){if(this.nodes.length==0)return null;let e=this.nodes[0];for(const t of this.nodes)t.look.rect.y<e.look.rect.y&&t.look.rect.x<e.look.rect.x&&(e=t);return e},makeViewRect(){const e=this.rect;return{x:e.x-g.view.wExtra,y:e.y-g.view.hExtra,w:e.w+2*g.view.wExtra,h:e.h+2*g.view.hExtra}},makeLookRect(){const e=this.topLeftNode(),t=this.rect,i=e?e.look.rect.x:t.x,s=e?e.look.rect.y:t.y;return{x:i,y:s,w:0,h:0}},adjustPaths(e){if(this.nodes)for(const t of this.nodes)t.adjustPaths(e)}};Object.assign(xs.prototype,Md);const Ad={onMouseMove(e,t){let i={x:t.movementX/this.tf.sx,y:t.movementY/this.tf.sy};const s=this.state;switch(s.action){case _.nothing:return this.idleMove(e),!1;case _.panning:return this.tf.dx+=t.movementX,this.tf.dy+=t.movementY,!0;case _.nodeDrag:return s.node.move(i),!0;case _.routeDraw:return this.drawRoute(s.route,e),!0;case _.routeDrag:return s.route.moveSegment(s.routeSegment,i),!0;case _.selection:return this.selection.resize(i.x,i.y),!0;case _.selectionDrag:return this.selection.drag(i),!0;case _.pinAreaSelect:return this.selection.pinAreaResize(s.node,e),!0;case _.padDrag:return s.pad.drag(e,i),!0;case _.busDraw:return s.bus.drawXY(e),!0;case _.busRedraw:return s.bus.resumeDrawXY(s.busLabel,e,i),!0;case _.busSegmentDrag:return s.bus.moveSegment(s.busSegment,i),!0;case _.busDrag:return s.bus.drag(i),!0;case _.tackDrag:return s.tack.slide(i),!0;case _.pinDrag:return s.lookWidget.drag(e),!0;case _.pinAreaDrag:return this.selection.pinAreaDrag(i),this.selection.getPinAreaNode().look.dragPinArea(this.selection.widgets,this.selection.rect),!0;case _.interfaceNameDrag:return s.lookWidget.drag(e),!0;case _.interfaceDrag:return this.selection.pinAreaDrag(i),this.selection.widgets[0].node.look.swapInterface(e,this.selection.widgets),!0;case _.pinClicked:switch(this.keyMask(t)){case Ie:return st(e,s.lookWidget.node.look.rect)?!1:(this.stateSwitch(_.routeDraw),s.route=new vt(s.lookWidget,null),s.route.select(),s.lookWidget.is.multi&&s.route.setTwistedPair(),s.lookWidget.routes.push(s.route),!0);case Fe:return s.lookWidget.unHighLightRoutes(),this.stateSwitch(_.pinAreaSelect),this.selection.pinAreaStart(s.node,e),!0;case je:{const n=s.lookWidget;return n.is.selected=!0,this.stateSwitch(_.pinDrag),u.doEdit("pinDrag",{pin:n}),!0}case je|Fe:{if(st(e,s.lookWidget.node.look.rect))return!1;if(s.lookWidget.unHighLightRoutes(),u.doEdit("extrudePad",{view:this,pos:e}),this.state.pad){this.stateSwitch(_.padDrag);for(const n of this.state.pad.routes)n.highLight()}return!0}}return!1;case _.interfaceNameClicked:return st(e,this.selection.widgets[0].rect)?!1:(this.selection.nodes[0].unSelect(),!0);case _.padArrowClicked:return st(e,s.pad.rect)||(this.stateSwitch(_.routeDraw),s.route=new vt(s.pad,null),s.pad.proxy.is.multi&&s.route.setTwistedPair(),s.route.select(),s.pad.routes.push(s.route)),!0;default:return!1}},idleMove(e){return this.hitTimer,!1},drawRoute(e,t){this.mouseHit(t);const i=this.hit,s=i.what==A.pin?i.lookWidget:i.what==A.pad?i.pad:i.what==A.busSegment?i.bus:null;this.hover(s,s?e.checkConxType(e.from,s):!1),s&&(s.is.pin||s.is.pad)?e.endpoint(s):e.drawXY(t)},hover(e,t){this.hit;const i=this.state;i.hoverOver!=e&&(e?(e.is.hoverOk=t,e.is.hoverNok=!t,i.hoverOver&&(this.state.hoverOver.is.hoverOk=this.state.hoverOver.is.hoverNok=!1),i.hoverOver=e):i.hoverOver&&(this.state.hoverOver.is.hoverOk=this.state.hoverOver.is.hoverNok=!1,this.state.hoverOver=null))},stopHover(){this.state.hoverOver&&(this.state.hoverOver.is.hoverOk=this.state.hoverOver.is.hoverNok=!1,this.state.hoverOver=null)}},Dd={saveHitSpot(e,t){const i=this.hit;i.xyLocal.x=e.x,i.xyLocal.y=e.y,i.xyScreen.x=t.x,i.xyScreen.y=t.y},onMouseDown(e,t){const i=this.state,s=this.hit;this.saveHitSpot(e,t);const n=this.keyMask(t);switch(n===(je|jn)?this.mouseHitRoutes(e):this.mouseHit(e),this.selection.canCancel(s)&&this.selection.reset(),s.what){case A.pin:switch(n){case Ie:case je|Fe:i.lookWidget=s.lookWidget,i.node=s.node,s.lookWidget.highLightRoutes(),this.stateSwitch(_.pinClicked),this.selection.singleNodeAndWidget(s.node,s.lookWidget);break;case Fe:i.node=s.node,this.stateSwitch(_.pinAreaSelect),this.selection.pinAreaStart(s.node,e);break;case je:{const o=s.lookWidget;i.lookWidget=o,this.selection.singleNodeAndWidget(s.node,s.lookWidget),this.stateSwitch(_.pinDrag),u.doEdit("pinDrag",{pin:o})}break}break;case A.ifName:switch(n){case Ie:this.selection.singleNodeAndWidget(s.node,s.lookWidget),this.selection.widgets=s.node.look.highLightInterface(s.lookWidget),this.stateSwitch(_.interfaceNameClicked);break;case Fe:i.node=s.node,this.stateSwitch(_.pinAreaSelect),this.selection.pinAreaStart(s.node,e);break;case je:{this.selection.singleNodeAndWidget(s.node,s.lookWidget),this.selection.widgets=s.node.look.highLightInterface(s.lookWidget),this.selection.pinAreaRectangle();const o=this.selection.widgets;u.doEdit("interfaceDrag",{group:o.slice(),oldY:o[0].rect.y,newY:o[0].rect.y}),this.stateSwitch(_.interfaceDrag)}break;case je|Fe:u.doEdit("interfaceNameDrag",{ifName:s.lookWidget}),this.state.lookWidget=s.lookWidget,this.selection.singleNodeAndWidget(s.node,s.lookWidget),this.stateSwitch(_.interfaceNameDrag);break}break;case A.icon:switch(n){case Ie:case Fe:this.selection.singleNode(s.node),s.node.iconClick(this,s.lookWidget,{x:t.clientX,y:t.clientY});break;case je:this.selection.singleNode(s.node),s.node.iconCtrlClick(this,s.lookWidget,{x:t.clientX,y:t.clientY},u);break}break;case A.header:switch(n){case Ie:case Fe:this.selection.singleNode(s.node),this.stateSwitch(_.nodeDrag),i.node=s.node,u.doEdit("nodeDrag",{view:this,node:s.node});break;case je:this.selection.extend(s.node),this.stateSwitch(_.selectionDrag),u.doEdit("selectionDrag",{view:this});break}break;case A.node:switch(n){case Ie:this.selection.singleNode(s.node),this.stateSwitch(_.nodeDrag),i.node=s.node,u.doEdit("nodeDrag",{view:this,node:s.node});break;case Fe:i.node=s.node,this.stateSwitch(_.pinAreaSelect),this.selection.pinAreaStart(s.node,e);break;case je:this.selection.extend(s.node),this.stateSwitch(_.selectionDrag),u.doEdit("selectionDrag",{view:this});break}break;case A.route:switch(n){case Ie:case je|jn:u.doEdit("routeDrag",{route:s.route}),s.route.select(),this.stateSwitch(_.routeDrag),i.route=s.route,i.routeSegment=s.routeSegment;break;case Fe:u.doEdit("deleteRoute",{route:s.route}),s.route.resumeDrawing(s.routeSegment,e),s.route.select(),this.stateSwitch(_.routeDraw),i.route=s.route;break}break;case A.pad:switch(n){case Ie:i.pad=s.pad,s.pad.checkRoutesDirection(),s.pad.highLightRoutes(),this.stateSwitch(_.padDrag),u.doEdit("padDrag",{pad:s.pad});break}break;case A.padArrow:switch(n){case Ie:{i.pad=s.pad;for(const o of s.pad.routes)o.highLight();this.stateSwitch(_.padArrowClicked)}break}break;case A.selection:switch(n){case Ie:this.selection.what==H.freeRect&&(u.doEdit("selectionDrag",{view:this}),this.stateSwitch(_.selectionDrag));break;case Fe:s.node?(i.node=s.node,this.selection.pinAreaStart(s.node,e),this.stateSwitch(_.pinAreaSelect)):this.selection.what==H.pinArea?(this.selection.pinAreaStart(this.selection.getPinAreaNode(),e),this.stateSwitch(_.pinAreaSelect)):(this.selection.freeStart(e),this.stateSwitch(_.selection));break;case je:switch(this.selection.what){case H.singleNode:case H.multiNode:s.node&&this.selection.extend(s.node);break;case H.pinArea:this.stateSwitch(_.pinAreaDrag),u.doEdit("pinAreaDrag",this);break}break}break;case A.busLabel:switch(n){case Ie:this.stateSwitch(_.busRedraw),i.bus=s.bus,i.busLabel=s.busLabel,i.bus.is.selected=!0,i.bus.highLight(),u.doEdit("busDraw",{bus:s.bus});break}break;case A.busSegment:switch(n){case Ie:i.bus=s.bus,i.busSegment=s.busSegment,i.bus.is.selected=!0,s.bus.highLight(),s.bus.singleSegment()?(this.stateSwitch(_.busDrag),u.doEdit("busDrag",{bus:s.bus})):(this.stateSwitch(_.busSegmentDrag),u.doEdit("busSegmentDrag",{bus:s.bus}));break;case Fe:break;case je:i.bus=s.bus,i.bus.is.selected=!0,this.stateSwitch(_.busDrag),u.doEdit("busDrag",{bus:s.bus});break}break;case A.tack:switch(n){case Ie:this.stateSwitch(_.tackDrag),i.tack=s.tack,i.tack.route.select(),u.doEdit("tackDrag",{tack:s.tack});break;case Fe:{const o=s.tack.route;this.stateSwitch(_.routeDraw),i.route=o,u.doEdit("deleteRoute",{route:o}),o.resumeDrawing(o.wire.length-1,e),o.select()}break}break;case A.nothing:switch(n){case Ie:this.stateSwitch(_.panning),u.doEdit("panning",{view:this});break;case Fe:this.stateSwitch(_.selection),this.selection.freeStart(e);break}break}}},Od={onMouseUp(e,t){this.mouseHit(e);let i=null;switch(this.state.action){case _.routeDraw:const s=this.state.route;s.unSelect(),s.from.unHighLightRoutes(),this.stopHover();const n=this.hit.lookWidget??this.hit.bus??this.hit.pad??null;s.connect(n)?u.doEdit("routeDraw",{route:s}):s.popFromRoute();break;case _.routeDrag:this.state.route.endDrag(this.state.routeSegment),this.state.route.unSelect(),u.getParam().newWire=this.state.route.copyWire();break;case _.selection:this.selection.rect&&this.getSelected(this.selection.rect);break;case _.selectionDrag:u.getParam().newPos={x:this.selection.rect.x,y:this.selection.rect.y};break;case _.pinAreaSelect:break;case _.nodeDrag:const o=this.state.node;o.look.snapRoutes();const r=u.getParam();r.newPos={x:o.look.rect.x,y:o.look.rect.y},hd(r.oldPos,r.newPos)<g.look.smallMove&&(o.move({x:r.oldPos.x-r.newPos.x,y:0}),u.dropLastEdit());break;case _.busDraw:case _.busRedraw:this.state.bus.is.selected=!1,this.state.bus.unHighLight(),u.getParam().newWire=this.state.bus.copyWire();break;case _.busSegmentDrag:this.state.bus.fuseSegment(this.state.busSegment),this.state.bus.is.selected=!1,this.state.bus.unHighLight(),i=u.getParam(),i.newWire=this.state.bus.copyWire(),i.newTackWires=this.state.bus.copyTackWires();break;case _.busDrag:this.state.bus.is.selected=!1,i=u.getParam(),i.newWire=this.state.bus.copyWire(),i.newTackWires=this.state.bus.copyTackWires();break;case _.padDrag:const a=this.state.pad;if(a.endDrag(),a.unHighLightRoutes(),u.getVerb()=="extrudePad")break;i=u.getParam(),i.newPos={x:a.rect.x,y:a.rect.y},i.newWires=a.copyWires();break;case _.tackDrag:const l=this.state.tack;l.fuseEndSegment(),l.route.unSelect(),u.getParam().newWire=l.route.copyWire();break;case _.pinDrag:const c=this.state.lookWidget;this.state.lookWidget.unHighLightRoutes(),u.getParam().newPos={left:c.is.left,y:c.rect.y};break;case _.pinAreaDrag:u.getParam().newY=this.selection.widgets[0].rect.y;break;case _.interfaceNameDrag:{const h=this.state.lookWidget;u.getParam().newY=h.rect.y}break;case _.interfaceDrag:{const h=this.selection.widgets[0];h==null||h.node.look.unhighLightInterface(this.selection.widgets),u.getParam().newY=h.rect.y,this.selection.singleNodeAndWidget(h.node,h)}break;case _.interfaceNameClicked:{const h=this.selection.widgets[0];h==null||h.node.look.unhighLightInterface(this.selection.widgets)}break;case _.pinClicked:this.state.lookWidget.unHighLight(),this.state.lookWidget.unHighLightRoutes();break;case _.padArrowClicked:this.state.pad.unHighLight();for(const h of this.state.pad.routes)h.unHighLight();break}this.stateSwitch(_.nothing)}},be={choices:[{text:"new group node",icon:"account_tree",char:"ctrl g",state:"enabled",action:Id},{text:"new source node",icon:"factory",char:"ctrl s",state:"enabled",action:Fd},{text:"new busbar",icon:"swap_horiz",char:"ctrl b",state:"enabled",action:Wd},{text:"new cable",icon:"cable",char:"ctrl k",state:"enabled",action:Hd},{text:"new input pad",icon:"new_label",char:"ctrl i",state:"enabled",action:Bd},{text:"new output pad",icon:"new_label",char:"ctrl o",state:"enabled",action:$d},{text:"select node",icon:"play_arrow",char:"ctrl n",state:"enabled",action:jd},{text:"paste as link",icon:"link",char:"ctrl l",state:"enabled",action:Vd},{text:"paste",icon:"content_copy",char:"ctrl v",state:"enabled",action:Ud}],view:null,xyLocal:null,xyScreen:null,prepare(e){this.view=e,this.xyLocal=e.hit.xyLocal,this.xyScreen=e.hit.xyScreen}};function Id(){u.doEdit("newGroupNode",{view:be.view,pos:be.xyLocal})}function Fd(){u.doEdit("newSourceNode",{view:be.view,pos:be.xyLocal})}function Wd(){u.doEdit("busCreate",{view:be.view,pos:be.xyLocal,cable:!1})}function Hd(){u.doEdit("busCreate",{view:be.view,pos:be.xyLocal,cable:!0})}function Bd(){u.doEdit("padCreate",{view:be.view,pos:be.xyLocal,input:!0})}function $d(){u.doEdit("padCreate",{view:be.view,pos:be.xyLocal,input:!1})}function jd(){u.tx.send("select node",{xyScreen:be.xyScreen,xyLocal:be.xyLocal})}function Vd(){u.tx.request("clipboard get",u.doc).then(e=>{e.selection.what==H.nothing||e.selection.what==H.pinArea||u.doEdit("linkFromClipboard",{view:be.view,pos:be.xyLocal,clipboard:e})})}function Ud(){u.tx.request("clipboard get",u.doc).then(e=>{e.selection.what==H.nothing||e.selection.what==H.pinArea||u.doEdit("pasteFromClipboard",{view:be.view,pos:be.xyLocal,clipboard:e})})}const Te={choices:[{text:"",char:"h",state:"enabled",action:Ro,icon:"highlight"},{text:"add label",char:"a",state:"enabled",action:zd,icon:"sell"},{text:"wider",char:"ctrl +",state:"enabled",action:qd,icon:"open_in_full"},{text:"smaller",char:"ctrl -",state:"enabled",action:Jd,icon:"close_fullscreen"},{text:"copy",char:"ctrl c",state:"enabled",action:Gd,icon:"content_copy"},{text:"source to clipboard",state:"enabled",action:Mo,icon:"content_paste"},{text:"make a test node",state:"enabled",action:Yd,icon:"done_all"},{text:"",state:"enabled",action:Eo,icon:"sync"},{text:"cut link",state:"enabled",action:Ao,icon:"link_off"},{text:"get from link",state:"enabled",action:Do,icon:"link"},{text:"save to link",state:"enabled",action:Oo,icon:"add_link"},{text:"ungroup",state:"enabled",action:Io,icon:"schema"},{text:"disconnect",char:"clear",state:"enabled",action:Xd,icon:"power_off"},{text:"delete",char:"del",state:"enabled",action:Kd,icon:"delete"}],view:null,node:null,xyLocal:null,prepare(e){this.view=e,this.xyLocal=e.hit.xyLocal,this.node=e.hit.node;let t=this.choices.find(i=>i.action==Mo);t.state=this.node.is.source?"enabled":"disabled",t=this.choices.find(i=>i.action==Eo),t.state=this.node.link?"disabled":"enabled",t.text=this.node.is.group?"convert to source node":"convert to group node",t=this.choices.find(i=>i.action==Ro),t.text=this.node.is.highLighted?"remove highlight":"highlight routes",t=this.choices.find(i=>i.action==Ao),t.state=this.node.link?"enabled":"disabled",t=this.choices.find(i=>i.action==Oo),t.state=this.node.link?"disabled":"enabled",t=this.choices.find(i=>i.action==Do),t.state=this.node.link?"disabled":"enabled",t=this.choices.find(i=>i.action==Io),t.state=this.node.is.group?"enabled":"disabled"}};function zd(){u.doEdit("addLabel",{node:Te.node})}function qd(){u.doEdit("wider",{node:Te.node})}function Jd(){u.doEdit("smaller",{node:Te.node})}function Ro(){u.doEdit("nodeHighLight",{node:Te.node})}function Gd(){u.doEdit("nodeToClipboard",{view:Te.view,node:Te.node})}function Eo(){u.doEdit("convertNode",{node:Te.node})}function Yd(){}function Mo(){u.doEdit("sourceToClipboard",{node:Te.node})}function Xd(){u.doEdit("disconnectNode",{node:Te.node})}function Kd(){u.doEdit("deleteNode",{node:Te.node})}function Ao(){u.doEdit("cutLink",{node:Te.node})}function Do(){Te.node.showLinkForm(Te.xyLocal)}function Oo(){Te.node.showExportForm(Te.xyLocal)}function Io(){u.doEdit("unGroup",{view:Te.view,node:Te.node})}const Qd=[{text:"new output",char:"o",icon:"logout",state:"enabled",action:tu},{text:"new input",char:"i",icon:"login",state:"enabled",action:eu},{text:"new ifName",char:"p",icon:"drag_handle",state:"enabled",action:nu},{text:"new request",char:"q",icon:"switch_left",state:"enabled",action:iu},{text:"new reply",char:"r",icon:"switch_right",state:"enabled",action:su},{text:"change to output",icon:"cached",state:"disabled",action:aa},{text:"add channel",icon:"adjust",state:"disabled",action:la},{text:"paste pins",char:"ctrl v",icon:"content_copy",state:"enabled",action:ru},{text:"profile",icon:"info",state:"disabled",action:Zs},{text:"all pins swap left right",icon:"swap_horiz",state:"enabled",action:ha},{text:"all pins left",icon:"arrow_back",state:"enabled",action:da},{text:"all pins right",icon:"arrow_forward",state:"enabled",action:ua},{text:"disconnect",icon:"power_off",state:"disabled",action:Qs},{text:"delete",icon:"delete",state:"enabled",action:ca}],Zd=[{text:"profile",icon:"info",state:"disabled",action:Zs},{text:"all pins swap left right",icon:"swap_horiz",state:"enabled",action:ha},{text:"all pins left",icon:"arrow_back",state:"enabled",action:da},{text:"all pins right",icon:"arrow_forward",state:"enabled",action:ua},{text:"disconnect",icon:"power_off",state:"disabled",action:Qs}],Q={choices:null,view:null,node:null,widget:null,xyLocal:null,xyScreen:null,prepare(e){var s,n,o,r,a,l,c,h;if(this.view=e,this.node=e.hit.node,this.widget=e.hit.lookWidget,this.xyLocal=e.hit.xyLocal,this.xyScreen=e.hit.xyScreen,this.node.link){this.choices=Zd;let f=this.choices.find(m=>m.action==Qs);f.state=(s=this.widget)!=null&&s.is.pin?"enabled":"disabled",f=this.choices.find(m=>m.action==Zs),f.state=(n=this.widget)!=null&&n.is.pin?"enabled":"disabled";return}this.choices=Qd;let t=this.choices.find(f=>f.action==Qs);t.state=(o=this.widget)!=null&&o.is.pin?"enabled":"disabled",t=this.choices.find(f=>f.action==aa);let i=((r=this.widget)==null?void 0:r.is.pin)&&this.widget.routes.length==0;t.state=i?"enabled":"disabled",t.text=i&&this.widget.is.input?"change to output":"change to input",t=this.choices.find(f=>f.action==la),i=(a=this.widget)==null?void 0:a.is.pin,t.state=i?"enabled":"disabled",t.text=i&&this.widget.is.channel?"remove channel":"add channel",t=this.choices.find(f=>f.action==Zs),t.state=(l=this.widget)!=null&&l.is.pin?"enabled":"disabled",t=this.choices.find(f=>f.text=="delete"),t.action=(c=this.widget)!=null&&c.is.pin?ca:(h=this.widget)!=null&&h.is.ifName?ou:()=>{},t=this.choices.find(f=>f.text=="paste pins")}};function eu(){var t;(t=Q.node)==null||t.cannotBeModified();const e={channel:!1,input:!0,proxy:Q.node.is.group};u.doEdit("newPin",{view:Q.view,node:Q.node,pos:Q.xyLocal,is:e})}function tu(){const e={channel:!1,input:!1,proxy:Q.node.is.group};u.doEdit("newPin",{view:Q.view,node:Q.node,pos:Q.xyLocal,is:e})}function iu(){const e={channel:!0,input:!1,proxy:Q.node.is.group};u.doEdit("newPin",{view:Q.view,node:Q.node,pos:Q.xyLocal,is:e})}function su(){const e={channel:!0,input:!0,proxy:Q.node.is.group};u.doEdit("newPin",{view:Q.view,node:Q.node,pos:Q.xyLocal,is:e})}function aa(){u.doEdit("ioSwap",{pin:Q.widget})}function la(){u.doEdit("channelOnOff",{pin:Q.widget})}function Qs(){u.doEdit("disconnectPin",{pin:Q.widget})}function ca(){u.doEdit("deletePin",{view:Q.view,pin:Q.widget})}function nu(){u.doEdit("newInterfaceName",{view:Q.view,node:Q.node,pos:Q.xyLocal})}function ou(){u.doEdit("deleteInterfaceName",{view:Q.view,ifName:Q.widget})}function Zs(e){u.doEdit("showProfile",{pin:Q.widget,pos:{x:Q.xyScreen.x,y:Q.xyScreen.y+10}})}function ha(){u.doEdit("swapPins",{node:Q.node,left:!0,right:!0})}function da(){u.doEdit("swapPins",{node:Q.node,left:!0,right:!1})}function ua(){u.doEdit("swapPins",{node:Q.node,left:!1,right:!0})}function ru(){u.tx.request("clipboard get",u.doc).then(e=>{u.doEdit("pasteWidgetsFromClipboard",{view:Q.view,clipboard:e})})}const Ct={choices:[{text:"align left",icon:"align_horizontal_left",state:"enabled",action:()=>Fo(!0)},{text:"align right",icon:"align_horizontal_right",state:"enabled",action:()=>Fo(!1)},{text:"align top",icon:"align_vertical_top",state:"enabled",action:()=>au(!0)},{text:"distribute vertically",icon:"vertical_distribute",state:"enabled",action:lu},{text:"distribute horizontally",icon:"horizontal_distribute",state:"enabled",action:cu},{text:"copy",icon:"content_copy",state:"enabled",action:uu},{text:"group",icon:"developer_board",state:"enabled",action:fu},{text:"disconnect",icon:"power_off",state:"enabled",action:hu},{text:"delete",icon:"delete",state:"enabled",action:du}],view:null,xyLocal:null,prepare(e){this.view=e,this.xyLocal=e.hit.local}};function Fo(e){u.doEdit("alignVertical",{view:Ct.view,left:e})}function au(e){u.doEdit("alignHorizontal",{view:Ct.view,top:e})}function lu(){u.doEdit("spaceVertical",{view:Ct.view})}function cu(){u.doEdit("spaceHorizontal",{view:Ct.view})}function hu(){u.doEdit("disconnectSelection",{selection:Ct.view.selection})}function du(){u.doEdit("deleteSelection",{view:Ct.view})}function uu(){u.doEdit("selectionToClipboard",{view:Ct.view})}function fu(){u.doEdit("selectionToGroup",{view:Ct.view})}const nt={choices:[{text:"copy",icon:"content_copy",state:"enabled",action:pu},{text:"disconnect",icon:"power_off",state:"enabled",action:gu},{text:"delete",icon:"delete",state:"enabled",action:mu},{text:"all pins swap left right",icon:"swap_horiz",state:"enabled",action:vu},{text:"all pins left",icon:"arrow_back",state:"enabled",action:wu},{text:"all pins right",icon:"arrow_forward",state:"enabled",action:yu}],view:null,node:null,widgets:null,xyLocal:null,xyScreen:null,prepare(e){this.view=e,this.node=e.state.node,this.widgets=e.selection.widgets,this.xyLocal=e.hit.xyLocal,this.xyScreen=e.hit.xyScreen}};function pu(){u.doEdit("selectionToClipboard",{view:nt.view})}function gu(){u.doEdit("disconnectPinArea",{view:nt.view,node:nt.node,widgets:nt.widgets})}function mu(){u.doEdit("deletePinArea",{view:nt.view,node:nt.node,widgets:nt.widgets})}function vu(){u.doEdit("swapPinArea",{view:nt.view,left:!0,right:!0})}function wu(){u.doEdit("swapPinArea",{view:nt.view,left:!0,right:!1})}function yu(){u.doEdit("swapPinArea",{view:nt.view,left:!1,right:!0})}const gt={choices:[{icon:"highlight",text:"",state:"enabled",action:Wo},{icon:"sell",text:"change name",state:"enabled",action:xu},{icon:"sell",text:"",state:"enabled",action:Ho},{icon:"rss_feed",text:"",state:"enabled",action:Bo},{icon:"timeline",text:"straight connections",state:"enabled",action:bu},{icon:"power_off",text:"disconnect",state:"enabled",action:ku},{icon:"delete",text:"delete",state:"enabled",action:Tu}],view:null,bus:null,label:null,xyLocal:null,prepare(e){this.view=e,this.bus=e.hit.bus,this.label=e.hit.busLabel,this.xyLocal=e.hit.xyScreen;let t=this.choices.find(i=>i.action==Wo);t.text=this.bus.is.highLighted?"remove highlight":"highlight routes",t=this.choices.find(i=>i.action==Ho),t.text=this.bus.is.cable?"change to busbar":"change to cable",t=this.choices.find(i=>i.action==Bo),t.state=this.bus.is.cable?"enabled":"disabled",t.text=this.bus.is.cable&&this.bus.is.filter?"change filter":"add filter"}};function Wo(){u.doEdit("busHighlight",{bus:gt.bus})}function xu(){u.doEdit("busChangeName",{bus:gt.bus,label:gt.busLabel})}function Ho(){u.doEdit("busChangeType",{bus:gt.bus})}function Bo(){var s;const e=gt.bus,t=!e.filter||e.filter.fName.length<1?k.nodeToFactory(e.name):e.filter.fName,i=(s=e.filter)!=null&&s.arl?e.filter.arl.userPath:"";u.tx.send("show filter",{title:"Filter for "+e.name,name:t,path:i,pos:gt.xyLocal,ok:(n,o)=>{u.doEdit("busChangeFilter",{bus:e,newName:n.trim(),userPath:o.trim()})},open:async(n,o)=>{if((n!=t||o!=i)&&u.doEdit("busChangeFilter",{bus:e,newName:n.trim(),userPath:o.trim()}),n.length<1)return;const r=e.filter.arl??u.doc.resolve("./index.js");tx.send("open source file",{arl:r})},trash:()=>{u.doEdit("busDeleteFilter",{bus:e})},cancel:()=>{}})}function bu(){u.doEdit("busStraightConnections",{bus:gt.bus})}function ku(){u.doEdit("busDisconnect",{bus:gt.bus})}function Tu(){u.doEdit("busDelete",{bus:gt.bus})}const zi={choices:[{icon:"sell",text:"change name",state:"enabled",action:_u},{icon:"power_off",text:"disconnect",state:"enabled",action:Pu},{icon:"delete",text:"delete",state:"enabled",action:Su}],view:null,pad:null,prepare(e){this.view=e,this.pad=e.hit.pad}};function _u(){u.doEdit("changeNamePad",{view:zi.view,pad:zi.pad})}function Pu(){u.doEdit("disconnectPad",{pad:zi.pad})}function Su(){u.doEdit("deletePad",{pad:zi.pad})}const Lu={onContextMenu(e,t){switch(this.saveHitSpot(e,t),this.mouseHit(e),this.hit.what){case A.header:case A.icon:Te.prepare(this),u.tx.send("show context menu",{menu:Te.choices,event:t});break;case A.node:case A.pin:case A.ifName:Q.prepare(this),u.tx.send("show context menu",{menu:Q.choices,event:t});break;case A.busSegment:case A.busLabel:gt.prepare(this),u.tx.send("show context menu",{menu:gt.choices,event:t});break;case A.pad:case A.padArrow:zi.prepare(this),u.tx.send("show context menu",{menu:zi.choices,event:t});break;case A.selection:switch(this.selection.what){case H.freeRect:case H.multiNode:Ct.prepare(this),u.tx.send("show context menu",{menu:Ct.choices,event:t});break;case H.pinArea:nt.prepare(this),u.tx.send("show context menu",{menu:nt.choices,event:t});break}break;case A.nothing:be.prepare(this),u.tx.send("show context menu",{menu:be.choices,event:t});break}}},Nu={syncRoot(e){var t;e.rxtxBuildTxTable(),e.is.placed||e.placeRoot(),this.root=this.getContainer(e),(t=this.root.savedView)!=null&&t.tf&&this.setTransform(this.root.savedView.tf),this.restoreSubViews()},getContainer(e){if(e.isContainer())return e;const t=this.initRoot("");return t.nodes.push(e),t},newEmptyNode(e,t){const i=new mt({x:e.x,y:e.y,w:0,h:0}),s=t?new gi(i,""):new Rt(i,"");u.doc.UID.generate(s),this.root.addNode(s),this.selection.singleNode(s);const n=s.look.widgets.find(o=>o.is.header);return this.beginTextEdit(n),this.hit.xyLocal.y=e.y+n.rect.h,s}},Cu={getSelected(e){const t=this.selection;for(const i of this.root.nodes)i.overlap(e)&&t.nodes.push(i);for(const i of this.root.pads)i.overlap(e)&&t.pads.push(i);for(const i of this.root.buses)if(i.overlap(e)){t.buses.push(i);for(const s of i.tacks)s.overlap(e)&&t.tacks.push(s)}},externalWidgets(e){let t=[];return e.forEach(i=>{i.look.widgets.forEach(s=>{var n;(n=s.routes)==null||n.forEach(o=>{(!e.includes(o.to.node)||!e.includes(o.from.node))&&t.push(s)})})}),t},deltaForPaste(e,t){t.copyCount++;const i=t.selection,s=i.what==H.freeRect?i.rect:i.what==H.multiNode?i.nodes[0].look.rect:{x:0,y:0};return s.x==e.x&&s.y==e.y?{x:t.copyCount*g.look.dxCopy,y:t.copyCount*g.look.dyCopy}:{x:e.x-s.x+(t.copyCount-1)*g.look.dxCopy,y:e.y-s.y+(t.copyCount-1)*g.look.dyCopy}},selectionToClipboard(){u.tx.send("clipboard set",{model:u.doc.model,selection:this.selection})},clipboardToSelection(e,t){var r;const i=this.deltaForPaste(e,t),[s,n]=this.selectedNodeAndPosition();this.selection.reset();const o=t.selection;switch(this.selection.what=o.what,o.what){case H.freeRect:case H.multiNode:for(const a of o.nodes){let l=a.copy();l.look.moveDelta(i.x,i.y),this.root.addNode(l),this.selection.nodes.push(l)}if(this.root.uidChangeAll(u.doc.UID),o.what==H.multiNode)return;for(const a of o.buses){let l=a.copy();l==null||l.move(i.x,i.y),this.selection.buses.push(l)}for(const a of o.pads);if(o.rect){const a=o.rect;this.selection.activate(a.x+i.x,a.y+i.y,a.w,a.h,g.selection.cRect)}break;case H.singleNode:{let a=(r=o.nodes[0])==null?void 0:r.copy();a.uidChangeAll(u.doc.UID),a.look.moveTo(i.x,i.y),this.root.addNode(a),this.selection.nodes.push(a),a.doSelect()}break;case H.pinArea:{if(!s||!n)return;const a=s.look.copyPinArea(o.widgets,n);s.is.source?s.rxtxAddPinArea(a):s.addPads(a),this.selection.pinAreaSelect(a)}break}},linkToClipboardNodes(e,t){for(const i of this.selection.nodes)i.setLink(e,i.name+t)},checkPastedNames(e){for(const t of this.selection.nodes){let i=e;for(;this.root.hasDuplicate(t)&&i<999;){const s=k.addNumber(t.name,i++);t.updateName(s)}}},xxlinkToClipboardNodes(e,t){const i=e.selection.nodes.length;if(i==this.selection.nodes.length)for(let s=0;s<i;s++)this.selection.nodes[s].setLink(t,e.selection.nodes[s].name)},removeSelection(e){this.selection.reset();for(const t of e.nodes)this.root.removeNode(t);for(const t of e.buses)this.root.removeBus(t);for(const t of e.pads)this.root.removePad(t)},restoreSelection(e){for(const s of e.nodes)this.root.restoreNode(s);for(const s of e.buses)this.root.restoreBus(s);for(const s of e.pads)this.root.restorePad(s);const t=this.selection;t.reset();for(const s of e.nodes)t.nodes.push(s);for(const s of e.buses)t.buses.push(s);for(const s of e.pads)t.pads.push(s);const i=e.rect;t.activate(i.x,i.y,i.w,i.h,e.color)},selectedNodeAndPosition(){const e=this.selection.getSingleNode();if(!e)return[null,null];const t=this.selection.getSelectedWidget(),i=t?{x:t.is.left?t.rect.x:t.rect.x+t.rect.w,y:t.rect.y+t.rect.h}:this.hit.xyLocal;return[e,i]}},Ru={singleSourceToGroup(){},selectionToGroup(e){const t=new mt(this.selection.makeLookRect()),i=new Rt(t,"new group",null);e.generate(i),this.root.addNode(i);const s=i.savedView=this.newSubView(i,this.selection.makeViewRect());s.translate(-s.rect.x,-s.rect.y);for(const o of this.selection.nodes)i.addNode(o),this.root.removeNode(o);const n=this.busTransfer(i);i.addProxies(this.selection);for(const o of n)this.busInterconnect(o.outside,i,o.inside);return i},busTransfer(e){const t=[];for(const i of this.selection.buses){const s=this.selection.nodes,n=[];for(const o of i.tacks){const r=o.route.from==o?o.route.to:o.route.from;r.is.pin&&!s.includes(r.node)&&n.push(o)}if(n.length==0)e.buses.push(i),this.root.removeBus(i);else{const o=i.copy();e.buses.push(o),i.splitTacks(o,e),t.push({outside:i,inside:o})}}return t},busInterconnect(e,t,i){function s(r){const a=r.route.to==r?r.route.from:r.route.to;return a.is.pad?a.proxy:a}function n(r,a){const l=s(r),c=s(a);return l.name!=c.name?!1:l.is.proxy==c.is.proxy?l.is.input!=c.is.input:l.is.input==c.is.input}const o=i.tacks.reduce((r,a)=>{const l=e.tacks.find(c=>n(a,c));if(l){const c=s(l),h=c.name+(c.is.input?">":"<");r[h]||(r[h]=a)}return r},{});for(const r of Object.values(o)){const a=s(r),l=t.copyPinAsProxy(a);t.addPad(l),e.makeRoute(l),i.makeRoute(l.pad)}},undoSelectionToGroup(e,t,i,s){t.disconnect(),t.savedView.closeView(),this.root.removeNode(t),this.restoreSelection(e);for(const n of t.buses)n.transferTacks(e.buses);for(const n of e.nodes)n.disconnect();for(const n of s)for(const o of n)o.reconnect()},transferToSelection(e,t){this.selection.reset();const i=this.calcRect(e),s=t.dx,n=t.dy;this.selection.activate(i.x+s,i.y+n,i.w,i.h);for(const o of e.pads)o.disconnect();for(const o of e.nodes)o.look.moveDelta(s,n),o.look.moveRoutes(s,n),this.root.nodes.push(o),this.selection.nodes.push(o);for(const o of e.buses)o.move(s,n),o.moveRoutes(s,n),this.root.buses.push(o),this.selection.buses.push(o);this.root.removeNode(e)},undoTransferToSelection(e,t,i){const s=-t.dx,n=-t.dy;for(const o of e.nodes)o.look.moveDelta(s,n),o.look.moveRoutes(s,n),view.root.removeNode(o);for(const o of e.buses)o.move(s,n),o.moveRoutes(s,n),e.removeBus(o);for(const o of i)o.reconnect();view.root.restoreNode(e)}},Eu={calcRow(e){e.sort((c,h)=>c.look.rect.x-h.look.rect.x);const t=g.selection.xPadding;let{x:i,y:s}={...e[0].look.rect},n=e.length-1,o=e[n].look.rect.x+e[n].look.rect.w-e[0].look.rect.x,r=0,a=0;e.forEach(c=>{r=Math.max(r,c.look.rect.h),a+=c.look.rect.w});let l=(o-a)/n;return l<t&&(l=t,o=a+n*t),{x:i,y:s,w:o,h:r,space:l}},calcColumn(e){e.sort((c,h)=>c.look.rect.y-h.look.rect.y);const t=g.selection.yPadding;let{x:i,y:s}={...e[0].look.rect},n=e.length-1,o=0,r=e[n].look.rect.y+e[n].look.rect.h-e[0].look.rect.y,a=0;e.forEach(c=>{o=Math.max(o,c.look.rect.w),a+=c.look.rect.h});let l=(r-a)/n;return l<t&&(l=t,r=a+n*t),{x:i,y:s,w:o,h:r,space:l}},calcRect(e){const t=e.nodes.length>0?e.nodes[0].look.rect:e.pads[0].rect,i={x:t.x,y:t.y},s={x:t.x+t.w,y:t.y+t.h};let n=null;return e.nodes.forEach(o=>{n=o.look.rect,i.x=Math.min(i.x,n.x),i.y=Math.min(i.y,n.y),s.x=Math.max(s.x,n.x+n.w),s.y=Math.max(s.y,n.y+n.h)}),e.pads.forEach(o=>{n=o.rect,i.x=Math.min(i.x,n.x),i.y=Math.min(i.y,n.y),s.x=Math.max(s.x,n.x+n.w),s.y=Math.max(s.y,n.y+n.h)}),{x:i.x,y:i.y,w:s.x-i.x,h:s.y-i.y}},nodesAlignHD(e,t=!0){const i=[],s=this.calcColumn(e);for(const n of e){const o=n.look.rect,r=t?s.x-o.x:s.x+s.w-o.x-o.w;i.push({x:r,y:0})}return i},nodesAlignVD(e){const t=[],i=this.calcRow(e);for(const s of e)t.push({x:0,y:i.y-s.look.rect.y});return t},nodesSpaceVD(e){const t=[],i=this.calcColumn(e);let s=i.y;for(const n of e){const o=n.look.rect;t.push({x:0,y:s-o.y}),s=s+o.h+i.space}return t},nodesSpaceHD(e){const t=[],i=this.calcRow(e);let s=i.x;for(const n of e){const o=n.look.rect;t.push({x:s-o.x,y:0}),s=s+o.w+i.space}return t},padsAlignHD(e,t=!0){const i=[];e.sort((n,o)=>n.rect.y-o.rect.y);const s=e[0].rect;for(const n of e){const o=n.rect,r=t?s.x-o.x:s.x+s.w-o.x-o.w;i.push({x:r,y:0})}return i},padsSpaceVD(e){const t=[];e.sort((o,r)=>o.rect.y-r.rect.y);const i=e[0].rect.y;let s=(e.at(-1).rect.y-e[0].rect.y)/(e.length-1),n=0;for(const o of e)t.push({x:0,y:i+n++*s-o.rect.y});return t},moveNodesAndRoutes(e,t,i=!1){const s=e.length;let n=0,o=0;for(let r=0;r<s;r++)n=i?-t[r].x:t[r].x,o=i?-t[r].y:t[r].y,e[r].look.moveDelta(n,o),e[r].look.moveRoutes(n,o);for(let r=0;r<s;r++)e[r].look.adjustRoutes()},movePadsAndRoutes(e,t,i=!1){const s=e.length;let n=0,o=0;for(let r=0;r<s;r++)n=i?-t[r].x:t[r].x,o=i?-t[r].y:t[r].y,e[r].rect.x+=n,e[r].rect.y+=o,e[r].adjustRoutes()}};function Ei(e){const[t,i]=e.selectedNodeAndPosition();return!t||!i?[!1,null,null]:t.cannotBeModified()?[!1,null,null]:[!0,t,i]}const Mu={i:e=>{const[t,i,s]=Ei(e);if(!t)return;const n={channel:!1,input:!0,proxy:i.is.group};u.doEdit("newPin",{view:e,node:i,pos:s,is:n})},o:e=>{const[t,i,s]=Ei(e);if(!t)return;const n={channel:!1,input:!1,proxy:i.is.group};u.doEdit("newPin",{view:e,node:i,pos:s,is:n})},q:e=>{const[t,i,s]=Ei(e);if(!t)return;const n={channel:!0,input:!1,proxy:i.is.group};u.doEdit("newPin",{view:e,node:i,pos:s,is:n})},r:e=>{const[t,i,s]=Ei(e);if(!t)return;const n={channel:!0,input:!0,proxy:i.is.group};u.doEdit("newPin",{view:e,node:i,pos:s,is:n})},p:e=>{const[t,i,s]=Ei(e);t&&u.doEdit("newInterfaceName",{view:e,node:i,pos:s})},a:e=>{const t=e.selection.getSingleNode();if(!t)return;const i=t.look.findLabel();i?u.doEdit("widgetTextEdit",{view:e,widget:i}):u.doEdit("addLabel",{node:t})},h:e=>{const t=e.selection.getSingleNode();t&&u.doEdit("nodeHighLight",{node:t})},"+":e=>{const t=e.selection.getSelectedWidget();!t||!t.node||t.node.cannotBeModified()||u.doEdit("widgetTextEdit",{view:e,widget:t,cursor:-1})},"-":e=>{const t=e.selection.getSelectedWidget();!t||!t.node||t.node.cannotBeModified()||u.doEdit("widgetTextEdit",{view:e,widget:t,cursor:0,clear:!0})},Clear:e=>{const t=e.selection.what==H.singleNode?e.selection.getSingleNode():null;t?u.doEdit("disconnectNode",{node:t}):u.doEdit("disconnectSelection",{view:e})},Delete:e=>{switch(e.selection.what){case H.nothing:break;case H.freeRect:u.doEdit("deleteSelection",{view:e});break;case H.pinArea:const[t,i,s]=Ei(e);if(!t)return;u.doEdit("deletePinArea",{view:e,node:e.selection.getSingleNode(),widgets:e.selection.widgets});break;case H.singleNode:const n=e.selection.getSelectedWidget();if(!n){const o=e.selection.getSingleNode();o&&u.doEdit("deleteNode",{node:o});return}if(n.node.cannotBeModified())return;n.is.pin?u.doEdit("deletePin",{view:e,pin:n}):n.is.ifName&&u.doEdit("deleteInterfaceName",{view:e,ifName:n});break;case H.multiNode:u.doEdit("deleteSelection",{view:e});break}},Enter:e=>{const t=e.selection.getSelectedWidget();if(t){if(t.node.cannotBeModified())return;u.doEdit("widgetTextEdit",{view:e,widget:t})}},ArrowDown:e=>{const t=e.selection.widgetBelow();t&&e.selection.switchWidget(t)},ArrowUp:e=>{const t=e.selection.widgetAbove();t&&e.selection.switchWidget(t)},Undo:e=>u.undoLastEdit(),Redo:e=>u.redoLastEdit(),Escape:e=>{e.selection.reset()}},Au={s:e=>{u.doEdit("newSourceNode",{view:e,pos:e.hit.xyLocal})},g:e=>{u.doEdit("newGroupNode",{view:e,pos:e.hit.xyLocal})},b:e=>{u.doEdit("busCreate",{view:e,pos:e.hit.xyLocal,cable:!1})},k:e=>{u.doEdit("busCreate",{view:e,pos:e.hit.xyLocal,cable:!0})},c:e=>{u.doEdit("selectionToClipboard",{view:e})},i:e=>{u.doEdit("padCreate",{view:e,pos:e.hit.xyLocal,input:!0})},o:e=>{u.doEdit("padCreate",{view:e,pos:e.hit.xyLocal,input:!1})},l:e=>{u.tx.request("clipboard get",u.doc).then(t=>{const i=t.selection.what;i!=H.nothing&&i!=H.pinArea&&u.doEdit("linkFromClipboard",{view:e,pos:e.hit.xyLocal,clipboard:t})}).catch(t=>console.log("ctrl-l : clipboard get error -> "+t))},v:e=>{u.tx.request("clipboard get",u.doc).then(t=>{const i=t.selection.what;if(i!=H.nothing){if(i==H.pinArea){u.doEdit("pasteWidgetsFromClipboard",{view:e,clipboard:t});return}u.doEdit("pasteFromClipboard",{view:e,pos:e.hit.xyLocal,clipboard:t})}}).catch(t=>console.log("ctrl-v : clipboard get error -> "+t))},z:e=>u.undoLastEdit(),Z:e=>u.redoLastEdit(),"+":e=>{const t=e.selection.getSingleNode();t&&u.doEdit("wider",{node:t})},"-":e=>{const t=e.selection.getSingleNode();t&&u.doEdit("smaller",{node:t})}},Du={_logKey(e){let t="Key = ";e.ctrlKey&&(t+="ctrl "),e.shiftKey&&(t+="shift "),t+="<"+e.key+">",console.log(t)},onKeydown(e){var t,i,s,n;if(this.state.action==_.nothing){const o=e.ctrlKey?Au[e.key]:Mu[e.key];return o?(o(this),!0):!1}else return this.state.action==_.editTextField?((e.key.length>1||e.ctrlKey?(i=(t=this.textField).handleSpecialKey)==null?void 0:i.call(t,e):(n=(s=this.textField).handleKey)==null?void 0:n.call(s,e))&&this.stateSwitch(_.nothing),!0):!1},onKeyup(e){return!1},beginTextEdit(e,t=-1,i=!1){var n;const s=(n=e.startEdit)==null?void 0:n.call(e);s&&(this.textField.newEdit(e,s,t),i&&this.textField.clear(),this.stateSwitch(_.editTextField),u.switchView(this),this.startBlinking())},endTextEdit(){var i,s;const e=this.state,t=this.textField;clearInterval(e.cursorInterval),t&&((s=(i=t.obj).endEdit)==null||s.call(i,t.saved))},startBlinking(){let e=0,t=!0,i=!0;const s=n=>{n-e>=g.std.blinkRate&&(i=u.doc.view.recursiveBlink(u.ctx,t),t=!t,e=n),i&&requestAnimationFrame(s)};requestAnimationFrame(s)},recursiveBlink(e,t){e.save();const i=this.tf;e.transform(i.sx,0,0,i.sy,i.dx,i.dy);let s=!1;if(this.state.action==_.editTextField){s=!0;const n=this.textField;n.obj.drawCursor(e,n.cursor,t)}for(const n of this.views)s=n.recursiveBlink(e,t)||s;return e.restore(),s}},Ou={localCoord(e){const t=this.tf;return{x:(e.x-t.dx)/t.sx,y:(e.y-t.dy)/t.sy}},inverse(e){const t=this.tf;return{x:e.x*t.sx+t.dx,y:e.y*t.sy+t.dy}},newSubView(e,t=null,i=null){t=t??this.makeViewRect(e);let s=new bs(t,e,this);return i&&s.setTransform(i),s.addViewWidgets(),s.placeWidgets(),this.views.push(s),e.savedView=s,s},restoreView(e){if(e.savedView.raw&&(e.savedView=this.newSubView(e,e.savedView.rect,e.savedView.tf)),this.views.find(t=>t==e.savedView)){console.error("View already in views in restore view !");return}if(this==e.savedView){console.error("Circular reference in views");return}e.savedView.viewState.visible=!0,this.views.push(e.savedView),e.savedView.parent=this},closeView(){this.parent&&(this.viewState.visible=!1,this.parent.views&&Re(this.parent.views,this))},restoreSubViews(){var e;if(this.views.length=0,!!((e=this.root)!=null&&e.nodes))for(let t of this.root.nodes)!t.savedView||t.savedView.state=="closed"||(t.savedView=this.newSubView(t,t.savedView.rect,t.savedView.tf),t.savedView.restoreSubViews())},move(e){var t;this.tf.dx+=e.x,this.tf.dy+=e.y,this.rect.x+=e.x,this.rect.y+=e.y,(t=this.widgets)==null||t.forEach(i=>{i.rect.x+=e.x,i.rect.y+=e.y})},resize(e,t){const i=this.rect;switch(e.name){case"corner":i.h+t.y>g.view.hHeader&&(i.h+=t.y),i.w+t.x>g.look.wBox&&(i.w+=t.x);break;case"top":if(i.h-t.y<g.view.hHeader)return;i.y+=t.y,i.h-=t.y;break;case"bottom":if(i.h+t.y<g.view.hHeader)return;i.h+=t.y;break;case"right":if(i.w+t.x<g.look.wBox)return;i.w+=t.x;break;case"left":if(i.w-t.x<g.look.wBox)return;i.x+=t.x,i.w-=t.x;break}this.placeWidgets()},whichView(e){const t=g.view.hHeader,i=g.view.wLine;for(let s=this.views.length-1;s>=0;s--){const n=this.views[s],o=n.rect;if(e.x>=o.x+i&&e.x<=o.x+o.w-i&&e.y>=o.y+t&&e.y<=o.y+o.h-i)return e=n.localCoord(e),n.whichView(e);const r=4;if(e.x<o.x-r||e.x>o.x+o.w+r||e.y<o.y-r||e.y>o.y+o.h+r)continue;let a=null;for(const l of n.widgets)st(e,l.rect)&&!l.is.viewBox&&(a=l);if(a)return[n,a,e];if(e.x<o.x+i)return[n,{is:{border:!0},name:"left"},e];if(e.x>o.x+o.w-i)return e.y>o.y+o.h-20?[n,{is:{border:!0},name:"corner"},e]:[n,{is:{border:!0},name:"right"},e];if(e.y<o.y+i)return[n,{is:{border:!0},name:"top"},e];if(e.y>o.y+o.h-i)return e.x>o.x+o.w-20?[n,{is:{border:!0},name:"corner"},e]:[n,{is:{border:!0},name:"bottom"},e]}return[this,null,e]},iconClick(e,t){switch(e.type){case"close":this.viewState.visible=!1,this.viewState.big&&this.small(),t.switchView(this.parent),this.closeView();break;case"big":{const i=this.parentViewsReverse();for(const s of i)s.big();this.big()}break;case"small":{this.small();for(const i of this.views)i.viewState.big&&i.small()}break;case"calibrate":this.toggleTransform();break;case"grid":this.state.grid=!this.state.grid;break}},viewToFront(e){const t=this.views,i=t.length;let s=t.indexOf(e),n=t[s];for(let o=s;o<i-1;o++)t[o]=t[o+1];t[i-1]=n},cloneForTab(){let e=new bs({x:0,y:0,w:0,h:0},this.root,this.parent);return e.tf.dx=this.tf.dx,e.tf.dy=this.tf.dy,e.tf.sx=this.tf.sx,e.tf.sy=this.tf.sy,e.views=this.views,e},addViewWidgets(){const e=this.rect,t=g.view;this.widgets.push(new ra(this.rect)),this.root&&this.widgets.push(new oa({x:0,y:0,w:e.w,h:g.view.hHeader},this.root));for(const i of["close","big","calibrate","grid"]){const s=new pn({x:0,y:0,w:t.wIcon,h:t.hIcon},i);s.setRender(),s.is.highLighted=!1,this.widgets.push(s)}},placeWidgets(){const e=this.rect,t=g.view;let i=e.x+t.xPadding;for(const s of this.widgets)s.is.icon?(s.rect.y=e.y+(g.view.hHeader-t.hIcon)/2,s.rect.x=i,i+=t.wIcon+t.xSpacing):s.is.viewBox?(s.rect.x=e.x,s.rect.y=e.y,s.rect.w=e.w,s.rect.h=e.h):s.is.viewTitle&&(s.rect.x=e.x,s.rect.y=e.y,s.rect.w=e.w)},toggleTransform(){const e=this.tf,t=this.viewState.tf;e.sx!=1?(this.saveTransform(this.tf),this.setTransform({sx:1,sy:1,dx:e.dx,dy:e.dy}),this.redoBigRecursive()):t.sx!=1&&(this.setTransform(t),this.redoBigRecursive())},parentViewsReverse(){const e=[];let t=this;for(;t.parent;)e.push(t.parent),t=t.parent;return e.reverse()},toggleBig(){if(this.viewState.big){this.small();for(const e of this.views)e.viewState.big&&e.toggleBig()}else{const e=this.parentViewsReverse();for(const t of e)t.big();this.big()}},small(){var e;Object.assign(this.rect,this.viewState.rect),(e=this.widgets.find(t=>t.type=="small"))==null||e.switchType("big"),this.placeWidgets(),this.viewState.big=!1},big(e=!0){var o;if(!this.parent)return;const t=this.parent.rect,i=this.parent.tf,s=g.view;e&&Object.assign(this.viewState.rect,this.rect);const n=this.parent.parent?s.hHeader:0;this.rect.x=(t.x-i.dx)/i.sx,this.rect.y=(t.y+n-i.dy)/i.sy,this.rect.w=t.w/i.sx,this.rect.h=(t.h-n)/i.sy,(o=this.widgets.find(r=>r.type=="big"))==null||o.switchType("small"),this.placeWidgets(),this.viewState.big=!0},redoBigRecursive(){this.viewState.big&&this.big(!1);for(const e of this.views)e.redoBigRecursive()}},$o="drawer/file",Iu={async onDrop(e,t){t.preventDefault();let i=this.localCoord(e);if(this.mouseHit(i),this.hit.view)return this.hit.view.onDrop(i,t);const s=this.analyseDrop(t);if(!s)return;const n=new Gt(s.path),o=new Nt(n),a=await new bi(u.doc.UID).getRoot(o);if(!a)return null;if(a.is.group&&a.isContainer()){const l=this.makeViewRect(a);l.x=i.x,l.y=i.y,this.newSubView(a,l)}return a.look.moveTo(i.x,i.y),a.uidChangeAll(u.doc.UID),a.link=new Js(o,this.name),this.root.nodes.push(a),u.redraw(),a},analyseDrop(e){e.dataTransfer.items&&[...e.dataTransfer.items];const t=e.dataTransfer.files?[...e.dataTransfer.files]:null,i=e.dataTransfer.types?[...e.dataTransfer.types]:null;return(t==null?void 0:t.length)>0&&t.forEach((s,n)=>{}),(i==null?void 0:i.length)>0&&i.includes($o)?JSON.parse(e.dataTransfer.getData($o)):null}},_={nothing:0,nodeDrag:1,routeDrag:2,panning:3,routeDraw:4,editTextField:5,selection:6,selectionDrag:7,pinAreaSelect:8,pinAreaDrag:9,padDrag:10,padArrowClicked:11,busDraw:12,busRedraw:13,busSegmentDrag:14,busDrag:15,tackDrag:16,pinClicked:17,pinDrag:18,interfaceDrag:19,interfaceNameDrag:20,interfaceNameClicked:21};function bs(e,t=null,i=null){this.tf={sx:1,sy:1,dx:e.x,dy:e.y+g.view.hHeader},this.rect=e,this.widgets=[],this.root=t,this.parent=i,this.views=[],this.hitTimer=0,this.state={action:0,pad:null,node:null,route:null,routeSegment:0,cursorInterval:null,bus:null,busSegment:0,busLabel:null,tack:null,lookWidget:null,hoverOver:null,highLighted:!1,grid:!1},this.textField=new Qr,this.hit={what:0,selection:null,xyLocal:{x:0,y:0},xyScreen:{x:0,y:0},pad:null,padArrow:!1,node:null,lookWidget:null,route:null,routeSegment:0,bus:null,busSegment:0,busLabel:null,tack:null},this.selection=new xs(this),this.viewState={visible:!0,big:!1,tf:{sx:1,sy:1,dx:e.x,dy:e.y},rect:{...e}}}bs.prototype={toJSON(){},stateSwitch(e){this.state.action==_.editTextField&&this.endTextEdit(),this.state.action=e},reset(){const e=this.state;e.action=_.nothing,e.node=null,e.view=null,e.route=null,this.selection.reset(),this.views.forEach(t=>t.reset())},makeViewRect(e){let t={x:0,y:0,w:0,h:0};const i=.1;return(e.nodes.length>0||e.pads.length>0)&&(t=this.calcRect(e),t.w=t.w+Math.floor(i*t.w),t.h=t.h+Math.floor(i*t.h)),t.w<g.view.wDefault&&(t.w=g.view.wDefault),t.h<g.view.hDefault&&(t.h=g.view.hDefault),t.x=e.look.rect.x,t.y=e.look.rect.y+g.view.hHeader+g.header.hHeader,t},noRect(){return this.rect.w==0||this.rect.h==0},setRect(e,t,i,s){this.rect.x=e,this.rect.y=t,this.rect.w=i,this.rect.h=s},shiftContent(e,t){this.root.nodes.forEach(i=>{i.look.moveDelta(e,t),i.look.moveRoutes(e,t)}),this.root.buses.forEach(i=>i.move(e,t))},translate(e,t){this.tf.dx+=e,this.tf.dy+=t},resetTransform(){this.tf.dx=this.rect.x,this.tf.dy=this.rect.y,this.tf.sx=1,this.tf.sy=1},setTransform(e){this.tf.dx=e.dx,this.tf.dy=e.dy,this.tf.sx=e.sx,this.tf.sy=e.sy},saveTransform(e){Object.assign(this.viewState.tf,e)},middle(){const e=this.tf,t=this.rect;return{x:(t.x+t.w/2-e.dx)/e.sx,y:(t.y+t.h/2-e.dy)/e.sy}},initRoot(e){const t=new mt({x:this.rect.x+this.rect.w/2,y:this.rect.y,w:0,h:0});return this.root=new Rt(t,e),this.root},render(e){var o,r,a,l;const t=g.switch((l=(a=(r=(o=this.root)==null?void 0:o.link)==null?void 0:r.model)==null?void 0:a.header)==null?void 0:l.style);e.save();const i=this.rect,s=g.view;if(this.parent){for(const c of this.widgets)c.render(e);e.rect(i.x+s.wLine/2,i.y+s.hHeader,i.w-s.wLine,i.h-s.hHeader),e.clip()}const n=this.tf;e.transform(n.sx,0,0,n.sy,n.dx,n.dy),this.state.grid&&this.drawGrid(e),this.root&&this.renderContent(e);for(const c of this.views)c.render(e);e.restore(),g.switch(t)},renderContent(e){var i;const t=this.root;this.selection.render(e);for(const s of t.nodes)for(const n of s.look.widgets)if(n.routes)for(const o of n.routes)o.from==n&&o.render(e);for(const s of t.pads)for(const n of s.routes)n.from==s&&n.render(e);for(const s of t.buses)for(const n of s.tacks)((i=n.route)==null?void 0:i.from)==n&&n.route.render(e);for(const s of t.nodes)s.render(e);for(const s of t.pads)s.render(e);for(const s of t.buses)s.render(e)},highLight(){this.state.highLighted=!0;for(const e of this.widgets)(e.is.viewTitle||e.is.viewBox||e.is.icon)&&(e.is.highLighted=!0)},unHighLight(){this.state.highLighted=!1;for(const e of this.widgets)(e.is.viewTitle||e.is.viewBox||e.is.icon)&&(e.is.highLighted=!1)},topView(){let e=this;for(;e.parent;)e=parent;return e},drawGrid(e){const t=this.rect,i=this.tf,s=g.view.grid,n={x:(t.x-i.dx)/i.sx,y:(t.y-i.dy)/i.sy,w:t.w/i.sx,h:t.h/i.sy};W.grid(e,n.x,n.y,n.w,n.h,s.dx,s.dy,s.cLine,s.cAxis)},getNamePath(){if(!this.parent)return"";let e=this,t="";for(;e.parent;)t+=" @ "+e.root.name,e=e.parent;return t}};Object.assign(bs.prototype,Ed,Dd,Ad,Od,Nu,Lu,Cu,Ru,Eu,Du,Ou,Iu);const Fu={newGroupNode:{doit({view:e,pos:t}){const i=e.newEmptyNode(t,!1);u.saveEdit("newGroupNode",{view:e,node:i})},undo({view:e,node:t}){e.root.removeNode(t)},redo({view:e,node:t}){e.root.addNode(t)}},newSourceNode:{doit({view:e,pos:t}){const i=e.newEmptyNode(t,!0);u.saveEdit("newSourceNode",{view:e,node:i})},undo({view:e,node:t}){e.root.removeNode(t)},redo({view:e,node:t}){e.root.addNode(t)}},wider:{doit({node:e}){e.look.wider(),u.saveEdit("wider",{node:e})},undo({node:e}){e.look.smaller()},redo({node:e}){e.look.wider()}},smaller:{doit({node:e}){e.look.smaller(),u.saveEdit("smaller",{node:e})},undo({node:e}){e.look.wider()},redo({node:e}){e.look.smaller()}},nodeHighLight:{doit({node:e}){e.is.highLighted?e.unHighLight():e.highLight()},undo({node:e}){},redo({node:e}){}},convertNode:{doit({node:e}){var s;const t=u.doc.focus;if(e.link)return;const i=e.switchNodeType();t.root.swap(e,i),(s=t.root)==null||s.rxtxBuildTxTable(),u.saveEdit("convertNode",{view:t,node:e,convertedNode:i})},undo({view:e,node:t,convertedNode:i}){var s;e.root.swap(i,t)&&i.look.transferRoutes(t.look),(s=e.root)==null||s.rxtxBuildTxTable()},redo({view:e,node:t,convertedNode:i}){var s;e.root.swap(t,i)&&t.look.transferRoutes(i.look),(s=e.root)==null||s.rxtxBuildTxTable()}},nodeToClipboard:{doit({view:e,node:t}){e.selection.singleNode(t),u.tx.send("clipboard set",{model:u.doc.model,selection:e.selection})},undo(){},redo(){}},sourceToClipboard:{doit({node:e}){if(!e.is.source)return;const t=e.makeSourceBody();u.textToExternalClipboard(t)},undo(){},redo(){}},swapPins:{doit({node:e,left:t,right:i}){const s=[];for(let n of e.look.widgets)n.is.pin&&t&&!n.is.left&&s.push(n),n.is.pin&&i&&n.is.left&&s.push(n);for(const n of s)n.leftRightSwap();u.saveEdit("swapPins",{swapped:s})},undo({swapped:e}){for(const t of e)t.leftRightSwap()},redo({swapped:e}){for(const t of e)t.leftRightSwap()}},disconnectNode:{doit({node:e}){const t=e.getRoutes();e.disconnect(),u.saveEdit("disconnectNode",{node:e,allRoutes:t})},undo({node:e,allRoutes:t}){for(const i of t)i.reconnect()},redo({node:e,allRoutes:t}){e.disconnect()}},deleteNode:{doit({node:e}){const t=e.getRoutes();e.disconnect(),u.doc.focus.root.removeNode(e),e.saveView&&e.savedView.closeView(),u.saveEdit("deleteNode",{view:u.doc.focus,node:e,allRoutes:t})},undo({view:e,node:t,allRoutes:i}){e.root.addNode(t);for(const s of i)s.reconnect()},redo({view:e,node:t,allRoutes:i}){t.disconnect(),e.root.removeNode(t)}},nodeFromNodeLib:{doit({view:e,node:t}){e.root.addNode(t),e.state.node=t,e.selection.singleNode(t),u.saveEdit("nodeFromNodeLib",{view:e,node:t})},undo({view:e,node:t}){e.root.removeNode(t)},redo({view:e,node:t}){e.root.addNode(t)}},nodeDrag:{doit({view:e,node:t}){u.saveEdit("nodeDrag",{node:t,view:e,oldPos:{x:t.look.rect.x,y:t.look.rect.y},newPos:null})},undo({node:e,view:t,oldPos:i,newPos:s}){const n={x:i.x-s.x,y:i.y-s.y};e.move(n),t.selection.move(n)},redo({node:e,view:t,oldPos:i,newPos:s}){const n={x:s.x-i.x,y:s.y-i.y};e.move(n),t.selection.move(n)}},updateProfiles:{doit({node:e}){e.is.group||e.factory.arl&&e.factory.arl.jsImport().then(t=>{e.analyzeFactory(t)})},undo({}){},redo({}){}},changeNodeSettings:{doit({node:e,sx:t}){JSON.stringify(t)!==JSON.stringify(e.sx)&&(e.sx=t),u.signalEdit("changeNodeSettings")},undo({}){},redo({}){}},changeNodeDynamics:{doit({node:e,dx:t}){e.dx,JSON.stringify(t)!==JSON.stringify(e.dx)&&(e.dx=t),u.signalEdit("changeNodeDynamics")},undo({}){},redo({}){}},changeNodeComment:{doit({node:e,comment:t}){!t||t.length==0?e.prompt=null:t!==e.prompt&&(e.prompt=t),u.signalEdit("changeNodeComment")},undo({}){},redo({}){}}},Wu={cutLink:{doit({node:e}){e.link&&(u.saveEdit("cutLink",{node:e,lName:e.link.lName,userPath:e.link.model.arl.userPath}),e.clearLink(),e.adjustUserPaths(u.doc.model.arl))},undo({node:e,lName:t,userPath:i}){t.length?i.length?u.doc.importFromModel(e,t,i):u.doc.makeLocalLink(e,t):e.clearLink()},redo({node:e,lName:t,userPath:i}){e.clearLink()}},changeLink:{async doit({node:e,lName:t,userPath:i}){i=i.trim(),t=k.cleanLink(t);const s=e.copy();u.saveEdit("changeLink",{node:e,previous:s,lName:t,userPath:i}),t.length?i.length>0?(await u.doc.importFromModel(e,t,i),u.redraw()):u.doc.makeLocalLink(e,t):e.clearLink()},undo({node:e,previous:t,lName:i,userPath:s}){t.link||(t.is.source?e.look.addIcon("factory"):e.look.addIcon("group")),e.fuse(t)},redo({node:e,previous:t,lName:i,userPath:s}){i.length?s.length?u.doc.importFromModel(e,i,s):u.doc.makeLocalLink(e,i):e.clearLink()}},saveToLink:{doit({node:e,newName:t,userPath:i}){!i.length>0||u.doc.exportToModel(e,t,new Nt(u.doc.model.arl.resolve(i)))},undo({}){},redo({}){}},changeFactory:{doit({node:e,newName:t,userPath:i}){var n;const s=e.factory.clone();(n=e.factory)==null||n.resolve(t,i,u.doc.model.arl,e.name),u.saveEdit("changeFactory",{node:e,oldFactory:s,newFactory:e.factory})},undo({node:e,oldFactory:t,newFactory:i}){e.factory=t},redo({node:e,oldFactory:t,newFactory:i}){e.factory=i}}},Hu={newPin:{doit({view:e,node:t,pos:i,is:s}){const n=t.look.addPin("",i,s);n.is.proxy?t.addPad(n):t.rxtxAddPin(n),e.selection.switchWidget(n),e.beginTextEdit(n),u.saveEdit("newPin",{view:e,pin:n})},undo({view:e,pin:t}){if(!t||!t.node.look.widgets.includes(t))return;const i=t.node;e.selection.switchWidget(),i.look.removePin(t),t.is.proxy?i.pads.pop():i.rxtxPopPin(t)},redo({view:e,pin:t}){if(!t||!t.node.look.widgets.includes(t))return;const i=t.node;i.look.restorePin(t),t.is.proxy?i.addPad(t):i.rxtxAddPin(t),e.selection.switchWidget(t)}},disconnectPin:{doit({pin:e}){const t=e.routes.slice();e.disconnect(),u.saveEdit("disconnectPin",{pin:e,routes:t})},undo({pin:e,routes:t}){e.reconnect(t)},redo({pin:e,routes:t}){e.disconnect()}},deletePin:{doit({view:e,pin:t}){const i=t.routes.slice(),s=t.is.proxy?t.pad.routes.slice():null;u.saveEdit("deletePin",{view:e,pin:t,pinRoutes:i,padRoutes:s}),e.selection.switchWidget(),t.disconnect(),t.node.look.removePin(t),t.is.proxy?(t.pad.disconnect(),t.node.removePad(t.pad)):t.node.rxtxRemovePin(t)},undo({view:e,pin:t,pinRoutes:i,padRoutes:s}){const n=i.slice();t.node.look.restorePin(t),e.selection.switchWidget(t),t.reconnect(n),t.is.proxy&&t.pad.reconnect(s)},redo({view:e,pin:t,pinRoutes:i,padRoutes:s}){t.disconnect(),e.selection.switchWidget(),t.node.look.removePin(t)}},ioSwap:{doit({pin:e}){e.ioSwap()&&u.saveEdit("ioSwap",e)},undo({pin:e}){e.ioSwap()},redo({pin:e}){e.ioSwap()}},channelOnOff:{doit({pin:e}){e.channelOnOff()&&u.saveEdit("channelOnOff",e)},undo({pin:e}){e.channelOnOff()},redo({pin:e}){e.channelOnOff()}},pinDrag:{doit({pin:e}){u.saveEdit("pinDrag",{pin:e,oldPos:{left:e.is.left,y:e.rect.y},newPos:null})},undo({pin:e,oldPos:t,newPos:i}){e.moveTo(t.left,t.y)},redo({pin:e,oldPos:t,newPos:i}){e.moveTo(i.left,i.y)}},pinAreaDrag:{doit(e){const t=e.selection.widgets;u.saveEdit("pinAreaDrag",{widgets:t,oldY:t[0].rect.y,newY:t[0].rect.y})},undo({widgets:e,oldY:t,newY:i}){},redo({widgets:e,oldY:t,newY:i}){}},showProfile:{doit({pin:e,pos:t}){var s;if(!((s=u.doc)!=null&&s.model))return;const i=e.is.input?u.doc.model.getInputPinProfile(e):u.doc.model.getOutputPinProfile(e);if(!i){console.log(`NO PROFILE ${e.name}`);return}u.tx.send("pin profile",{pos:t,pin:e,profile:i,open(n){const o=u.doc.model.arl.resolve(n.file);u.tx.send("open source file",{arl:o,line:n.line})}})},undo(){},redo(){}},newInterfaceName:{doit({view:e,node:t,pos:i}){let s=t.look.addIfName("",i);e.beginTextEdit(s),e.selection.switchWidget(s),u.saveEdit("newInterfaceName",{ifName:s})},undo({ifName:e}){e.node.look.removeInterfaceName(e)},redo({ifName:e}){e.node.look.restoreInterfaceName(e)}},deleteInterfaceName:{doit({view:e,ifName:t}){e.selection.switchWidget();const i=t.node.look.showPrefixes(t);t.node.look.removeInterfaceName(t),u.saveEdit("deleteInterfaceName",{view:e,ifName:t,pxlenArray:i})},undo({view:e,ifName:t,pxlenArray:i}){t.node.look.restoreInterfaceName(t),t.node.look.hidePrefixes(t,i),e.selection.switchWidget(t)},redo({view:e,ifName:t,pxlenArray:i}){e.selection.switchWidget(),t.node.look.showPrefixes(t),t.node.look.removeInterfaceName(t)}},interfaceDrag:{doit({group:e,oldY:t,newY:i}){u.saveEdit("interfaceDrag",{group:e,oldY:t,newY:i})},undo({group:e,oldY:t,newY:i}){const s=t-i;e[0].node.look.groupMove(e,s)},redo({group:e,oldY:t,newY:i}){const s=i-t;e[0].node.look.groupMove(e,s)}},interfaceNameDrag:{doit({ifName:e}){u.saveEdit("interfaceNameDrag",{ifName:e,oldY:e.rect.y,newY:e.rect.y})},undo({ifName:e,oldY:t,newY:i}){e.moveTo(t)},redo({ifName:e,oldY:t,newY:i}){e.moveTo(i)}},addLabel:{doit({node:e}){var i,s;let t=e.look.widgets.find(n=>n.is.label)??e.look.addLabel("");(s=(i=u.doc)==null?void 0:i.focus)==null||s.beginTextEdit(t),u.saveEdit("addLabel",{node:e,label:t})},undo({node:e,label:t}){e.look.removeLabel()},redo({node:e,label:t}){e.look.restoreLabel(t)}},widgetTextEdit:{doit({view:e,widget:t,cursor:i,clear:s}){var o;const n=(o=t.startEdit)==null?void 0:o.call(t);n&&(u.saveEdit("widgetTextEdit",{widget:t,prop:n,oldText:t[n],newText:""}),e.beginTextEdit(t,i,s??!1))},undo({widget:e,prop:t,oldText:i,newText:s}){s=e[t],u.getParam().newText=s,e[t]=i,e.endEdit(s)},redo({widget:e,prop:t,oldText:i,newText:s}){e[t]=s,e.endEdit(i)}}},Bu={routeDrag:{doit({route:e}){u.saveEdit("routeDrag",{route:e,oldWire:e.copyWire(),newWire:null})},undo({route:e,oldWire:t,newWire:i}){e.restoreWire(t)},redo({route:e,oldWire:t,newWire:i}){e.restoreWire(i)}},routeDraw:{doit({route:e}){u.saveEdit("routeDraw",{route:e,newRoute:e.clone()}),e.checkTwistedPair()},undo({route:e,newRoute:t}){e.disconnect()},redo({route:e,newRoute:t}){t&&e.connectFromClone(t)}},deleteRoute:{doit({route:e}){u.saveEdit("deleteRoute",{route:e,oldRoute:e.clone()}),e.disconnect(),e.remove()},undo({route:e,oldRoute:t}){t&&e.connectFromClone(t)},redo({route:e,oldRoute:t}){e.disconnect(),e.remove()}}},$u={busHighlight:{doit({bus:e}){e.is.highLighted?e.unHighLight():e.highLight(),u.saveEdit("busHighLight",{bus:e})},undo({bus:e}){e.is.highLighted?e.unHighLight():e.highLight()},redo({bus:e}){e.is.highLighted?e.unHighLight():e.highLight()}},busCreate:{doit({view:e,pos:t,cable:i}){e.state.bus=e.root.addBus("",t),u.saveEdit("busCreate",{node:e.root,bus:e.state.bus}),i&&(e.state.bus.is.cable=!0)},undo({node:e,bus:t}){e.removeBus(t)},redo({node:e,bus:t}){e.restoreBus(t)}},busChangeName:{doit({bus:e,label:t}){u.doc.focus.state.bus=e,e.selected=!0,t||(t=e.startLabel),u.doc.focus.beginTextEdit(t),u.saveEdit("busChangeName",{label:t,oldName:t.text,newName:null})},undo({label:e,oldName:t,newName:i}){u.getParam().newName=e.text,e.setText(t)},redo({label:e,oldName:t,newName:i}){e.setText(i)}},busChangeType:{doit({bus:e}){const t=e.tacks.slice();u.saveEdit("busChangeType",{bus:e,tacks:t}),e.disconnect(),e.is.cable=!e.is.cable,e.reconnect(t)},undo({bus:e,tacks:t}){const i=t.slice();e.disconnect(),e.is.cable=!e.is.cable,e.reconnect(i)},redo({bus:e,tacks:t}){const i=t.slice();e.disconnect(),e.is.cable=!e.is.cable,e.reconnect(i)}},busDeleteRouter:{doit({bus:e}){u.saveEdit("busDeleteRouter",{bus:e}),e.is.filter=!1},undo({bus:e}){e.is.filter=!0},redo({bus:e}){e.is.filter=!1}},busChangeRouter:{doit({bus:e,newName:t,userPath:i}){const s=e.filter?e.filter.clone():null;e.filter||(e.filter=new qi),e.filter.resolve(t,i,u.doc.model.arl,e.name),e.is.filter=!0,u.saveEdit("busChangeRouter",{bus:e,oldRouter:s,newRouter:e.filter})},undo({bus:e,oldRouter:t,newRouter:i}){e.filter=t},redo({bus:e,oldRouter:t,newRouter:i}){e.filter=i}},busStraightConnections:{doit({bus:e}){const t=[];for(const i of e.tacks)t.push({tack:i,oldPos:{x:i.rect.x,y:i.rect.y},wire:i.route.copyWire()});u.saveEdit("busStraightConnections",{bus:e,wireArray:t}),e.straightConnections()},undo({bus:e,wireArray:t}){for(const i of t){const s=i.tack;s.pos.x=i.oldPos.x,s.pos.y=i.oldPos.y,s.route.restoreWire(i.wire)}},redo({bus:e,wireArray:t}){e.straightConnections()}},busDisconnect:{doit({bus:e}){u.saveEdit("busDisconnect",{bus:e,tacks:e.tacks.slice()}),e.disconnect()},undo({bus:e,tacks:t}){e.reconnect(t.slice())},redo({bus:e,tacks:t}){e.disconnect()}},busDelete:{doit({bus:e}){u.saveEdit("busDelete",{node:u.doc.focus.root,bus:e,tacks:e.tacks.slice()}),u.doc.focus.root.deleteBus(e)},undo({node:e,bus:t,tacks:i}){e.restoreBus(t),t.reconnect(i.slice())},redo({node:e,bus:t,tacks:i}){t.disconnect(),e.removeBus(t)}},busDraw:{doit({bus:e}){u.saveEdit("busDraw",{bus:e,oldWire:e.copyWire(),newWire:null})},undo({bus:e,oldWire:t,newWire:i}){e.restoreWire(t),e.startLabel.place(),e.endLabel.place()},redo({bus:e,oldWire:t,newWire:i}){e.restoreWire(i),e.startLabel.place(),e.endLabel.place()}},busSegmentDrag:{doit({bus:e}){u.saveEdit("busSegmentDrag",{bus:e,oldWire:e.copyWire(),newWire:null,oldTackWires:e.copyTackWires(),newTackWires:null})},undo({bus:e,oldWire:t,newWire:i,oldTackWires:s,newTackWires:n}){e.restoreWire(t),e.restoreTackWires(s),e.startLabel.place(),e.endLabel.place(),e.placeTacks()},redo({bus:e,oldWire:t,newWire:i,oldTackWires:s,newTackWires:n}){e.restoreWire(i),e.restoreTackWires(n),e.startLabel.place(),e.endLabel.place(),e.placeTacks()}},busDrag:{doit({bus:e}){u.saveEdit("busDrag",{bus:e,oldWire:e.copyWire(),newWire:null,oldTackWires:e.copyTackWires(),newTackWires:null})},undo({bus:e,oldWire:t,newWire:i,oldTackWires:s,newTackWires:n}){e.restoreWire(t),e.restoreTackWires(s),e.startLabel.place(),e.endLabel.place(),e.placeTacks()},redo({bus:e,oldWire:t,newWire:i,oldTackWires:s,newTackWires:n}){e.restoreWire(i),e.restoreTackWires(n),e.startLabel.place(),e.endLabel.place(),e.placeTacks()}},tackDrag:{doit({tack:e}){u.saveEdit("tackDrag",{tack:e,oldWire:e.route.copyWire(),newWire:null})},undo({tack:e,oldWire:t,newWire:i}){e.route.restoreWire(t),e.orient()},redo({tack:e,oldWire:t,newWire:i}){e.route.restoreWire(i),e.orient()}}},ju={padCreate:{doit({view:e,pos:t,input:i}){if(!e.root)return;const s={input:i,left:t.x<e.middle().x};let n=e.root.look.addPin("",t,s);const o=n.makePadRect({x:t.x,y:t.y-style.pad.hPad/2}),r=new xi(o,n);s.left&&(r.rect.x-=r.rect.w),e.root.pads.push(r),u.doc.UID.generate(r),e.beginTextEdit(r),u.saveEdit("padCreate",{view:e,pad:r})},undo({view:e,pad:t}){e.root.pads.includes(t)&&(t.disconnect(),e.root.removePad(t),t.proxy.disconnect(),e.root.look.removePin(t.proxy))},redo({view:e,pad:t}){e.root.pads.includes(t)&&(e.root.restorePad(t),e.root.look.restorePin(t.proxy))}},changeNamePad:{doit({view:e,pad:t}){t!=null&&t.proxy&&(u.saveEdit("changeNamePad",{pad:t,oldName:t.text,newName:null}),e.beginTextEdit(t))},undo({pad:e,oldName:t,newName:i}){u.getParam().newName=e.text;const s=e.proxy.node;e.text.length==0&&(s.restorePad(e),s.look.restorePin(e.proxy)),e.proxy.name=t,e.nameChange(t)},redo({pad:e,oldName:t,newName:i}){const s=e.proxy.node;if(!i||i.length==0){s.removePad(e),s.look.removePin(e.proxy);return}e.proxy.name=i,e.nameChange(i)}},disconnectPad:{doit({pad:e}){u.saveEdit("disconnectPad",{pad:e,routes:e.routes.slice()}),e.disconnect()},undo({pad:e,routes:t}){e.reconnect(t.slice())},redo({pad:e,routes:t}){e.disconnect()}},deletePad:{doit({pad:e}){u.saveEdit("deletePad",{pad:e,routes:e.routes.slice()});const t=u.doc.focus.root;e.disconnect(),t.removePad(e),e.proxy.disconnect(),t.look.removePin(e.proxy)},undo({pad:e,routes:t}){const i=e.proxy.node;i.restorePad(e),i.look.restorePin(e.proxy),e.reconnect(t.slice())},redo({pad:e,routes:t}){e.disconnect(),e.proxy.node.removePad(e),e.proxy.disconnect(),e.proxy.node.look.removePin(e.proxy)}},extrudePad:{doit({view:e,pos:t}){const i=e.hit.lookWidget;if(!i.is.pin)return;const s={...i.is};s.proxy=!0;const n=e.root.look.addPin(i.name,t,s),o=i.makePadRect(t),r=new xi(o,n);u.doc.UID.generate(r),r.place(),r.shortConnection(i),u.saveEdit("extrudePad",{pad:r,routes:r.routes.slice()}),e.root.pads.push(r),e.state.pad=r},undo({pad:e,routes:t}){e.disconnect(),e.proxy.node.removePad(e)},redo({pad:e,routes:t}){const i=e.proxy.node;i.restorePad(e),i.look.restorePin(e.proxy),e.reconnect(t.slice())}},padDrag:{doit({pad:e}){u.saveEdit("padDrag",{pad:e,oldPos:{x:e.rect.x,y:e.rect.y},oldWires:e.copyWires(),newPos:null,newWires:null})},undo({pad:e,oldPos:t,oldWires:i,newPos:s,newWires:n}){const o={x:t.x-s.x,y:t.y-s.y};e.move(o),e.restoreWires(i)},redo({pad:e,oldPos:t,oldWires:i,newPos:s,newWires:n}){const o={x:s.x-t.x,y:s.y-t.y};e.move(o),e.restoreWires(n)}}},Vu={alignVertical:{doit({view:e,left:t}){const i=e.selection.nodes,s=e.selection.pads;let n=[],o=[];i.length>1&&(n=e.nodesAlignHD(i,t),e.moveNodesAndRoutes(i,n)),s.length>1&&(o=e.padsAlignHD(s,t),e.movePadsAndRoutes(s,o)),u.saveEdit("alignVertical",{view:e,nodes:i,deltaNodes:n,pads:s,deltaPads:o})},undo({view:e,nodes:t,deltaNodes:i,pads:s,deltaPads:n}){i.length>0&&e.moveNodesAndRoutes(t,i,!0),n.length>0&&e.movePadsAndRoutes(s,n,!0)},redo({view:e,nodes:t,deltaNodes:i,pads:s,deltaPads:n}){i.length>0&&e.moveNodesAndRoutes(t,i,!1),n.length>0&&e.movePadsAndRoutes(s,n,!1)}},spaceVertical:{doit({view:e}){const t=e.selection.nodes,i=e.selection.pads;let s=[],n=[];t.length>1&&(s=e.nodesSpaceVD(t),e.moveNodesAndRoutes(t,s)),i.length>1&&(n=e.padsSpaceVD(i),e.movePadsAndRoutes(i,n)),u.saveEdit("spaceVertical",{view:e,nodes:t,deltaNodes:s,pads:i,deltaPads:n})},undo({view:e,nodes:t,deltaNodes:i,pads:s,deltaPads:n}){i.length>0&&e.moveNodesAndRoutes(t,i,!0),n.length>0&&e.movePadsAndRoutes(s,n,!0)},redo({view:e,nodes:t,deltaNodes:i,pads:s,deltaPads:n}){i.length>0&&e.moveNodesAndRoutes(t,i,!1),n.length>0&&e.movePadsAndRoutes(s,n,!1)}},alignHorizontal:{doit({view:e,top:t}){const i=e.selection.nodes;if(i.length<2)return;const s=e.nodesAlignVD(i);e.moveNodesAndRoutes(i,s),u.saveEdit("alignHorizontal",{view:e,nodes:i,deltaNodes:s})},undo({view:e,nodes:t,deltaNodes:i}){i.length>0&&e.moveNodesAndRoutes(t,i,!0)},redo({view:e,nodes:t,deltaNodes:i}){i.length>0&&e.moveNodesAndRoutes(t,i,!1)}},spaceHorizontal:{doit({view:e}){const t=e.selection.nodes;if(t.length<2)return;const i=e.nodesSpaceHD(t,left);e.moveNodesAndRoutes(t,i),u.saveEdit("spaceHorizontal",{view:e,nodes:t,deltaNodes:i})},undo({view:e,nodes:t,deltaNodes:i}){i.length>0&&e.moveNodesAndRoutes(t,i,!0)},redo({view:e,nodes:t,deltaNodes:i}){i.length>0&&e.moveNodesAndRoutes(t,i,!1)}},selectionDrag:{doit({view:e}){const t=e.selection.shallowCopy(),i={x:t.rect.x,y:t.rect.y};u.saveEdit("selectionDrag",{view:e,selection:t,oldPos:i,newPos:null})},undo({view:e,selection:t,oldPos:i,newPos:s}){t.drag({x:i.x-s.x,y:i.y-s.y}),e.selection.setRect(i.x,i.y,t.rect.w,t.rect.h)},redo({view:e,selection:t,oldPos:i,newPos:s}){t.drag({x:s.x-i.x,y:s.y-i.y}),e.selection.setRect(s.x,s.y,t.rect.w,t.rect.h)}},disconnectSelection:{doit({selection:e}){const t=[];for(const i of e.nodes)t.push(i.getRoutes()),i.disconnect();u.saveEdit("disconnectSelection",{selection:e.shallowCopy(),allRoutes:t})},undo({selection:e,allRoutes:t}){for(const i of t)for(const s of i)s.reconnect()},redo({selection:e,allRoutes:t}){for(const i of e.nodes)i.disconnect()}},deleteSelection:{doit({view:e}){const t=[],i=e.selection;for(const s of i.nodes)t.push(s.getRoutes()),s.disconnect(),e.root.removeNode(s);for(const s of i.pads)s.disconnect(),e.root.removePad(s),s.proxy.disconnect(),e.root.look.removePin(s.proxy);for(const s of i.buses)s.tacks.length==0&&e.root.removeBus(s);u.saveEdit("deleteSelection",{view:e,selection:i.shallowCopy(),allRoutes:t}),i.reset(),e.stateSwitch(_.nothing)},undo({view:e,selection:t,allRoutes:i}){for(const s of t.nodes)e.root.addNode(s);for(const s of t.pads){const n=s.proxy.node;n.restorePad(s),n.look.restorePin(s.proxy)}for(const s of t.buses)s.tacks.length==0&&e.root.restoreBus(s);for(const s of i)for(const n of s)n.reconnect()},redo({view:e,selection:t,allRoutes:i}){for(const s of t.nodes)s.disconnect(),e.root.removeNode(s);for(const s of t.pads)s.disconnect(),e.root.removePad(s),s.proxy.disconnect(),e.root.look.removePin(s.proxy);for(const s of t.buses)s.tacks.length==0&&e.root.removeBus(s)}},selectionToClipboard:{doit({view:e}){e.selectionToClipboard()},undo(){},redo(){}},pasteFromClipboard:{doit({view:e,pos:t,clipboard:i}){e.clipboardToSelection(t,i),u.doc.model.arl.sameDir(i.origin.arl)||i.selection.adjustPaths(u.doc.model.arl),e.checkPastedNames(i.copyCount),u.saveEdit("pasteFromClipboard",{view:e,selection:e.selection.shallowCopy()})},undo({view:e,selection:t}){e.removeSelection(t)},redo({view:e,selection:t}){e.restoreSelection(t)}},linkFromClipboard:{doit({view:e,pos:t,clipboard:i}){i.origin.arl.makeRelative(u.doc.model.arl),e.clipboardToSelection(t,i),e.linkToClipboardNodes(i.origin,i.selection.viewPath),e.checkPastedNames(i.copyCount),u.saveEdit("linkFromClipboard",{view:e,selection:e.selection.shallowCopy()})},undo({view:e,selection:t}){e.removeSelection(t)},redo({view:e,selection:t}){e.restoreSelection(t)}},selectionToGroup:{doit({view:e}){const t=e.selection;if(t.nodes.length==0)return;const i=[];for(const o of t.nodes)i.push(o.getRoutes());const s=e.selectionToGroup(u.doc.UID),n={dx:s.savedView.rect.x,dy:s.savedView.rect.y};u.saveEdit("selectionToGroup",{view:e,selection:t.shallowCopy(),newGroup:s,shift:n,allRoutes:i}),t.reset(),e.stateSwitch(_.nothing)},undo({view:e,selection:t,newGroup:i,shift:s,allRoutes:n}){e.undoSelectionToGroup(t,i,s,n)},redo({view:e,selection:t,newGroup:i,allRoutes:s}){}},unGroup:{doit({view:e,node:t}){if(!t.is.group||t.isConnected())return;const i=[];for(const n of t.pads)for(const o of n.routes)i.push(o);const s={dx:e.rect.x,dy:e.rect.y};u.saveEdit("unGroup",{view:e,node:t,shift:s,padRoutes:i}),e.transferToSelection(t,s)},undo({view:e,node:t,shift:i,padRoutes:s}){e.undoTransferToSelection(t,i,s)},redo({view:e,node:t,shift:i,padRoutes:s}){}}},Uu={disconnectPinArea:{doit({view:e,node:t,widgets:i}){const s=t.getAllRoutes(i);t.disconnectPinArea(i),u.saveEdit("disconnectPinArea",{node:t,widgets:i.slice(),allRoutes:s})},undo({node:e,widgets:t,allRoutes:i}){for(const s of i)s.reconnect()},redo({node:e,widgets:t,allRoutes:i}){e.disconnectPinArea(t)}},deletePinArea:{doit({view:e,node:t,widgets:i}){const s=t.getAllRoutes(i);u.saveEdit("deletePinArea",{view:e,node:t,widgets:i.slice(),allRoutes:s}),t.disconnectPinArea(i),t.look.deletePinArea(i)},undo({view:e,node:t,widgets:i,allRoutes:s}){const n=i[0],o={x:n.rect.x,y:n.rect.y};t.look.copyPinArea(i,o),t.is.source?t.rxtxAddPinArea(i):t.addPads(i);for(const r of s)r.reconnect()},redo({view:e,node:t,widgets:i,allRoutes:s}){t.disconnectPinArea(i),t.look.deletePinArea(i)}},swapPinArea:{doit({view:e,left:t,right:i}){const s=[];for(let n of e.selection.widgets)n.is.pin&&t&&!n.is.left&&s.push(n),n.is.pin&&i&&n.is.left&&s.push(n);for(const n of s)n.leftRightSwap();u.saveEdit("swapPinArea",{swapped:s})},undo({swapped:e}){for(const t of e)t.leftRightSwap()},redo({swapped:e}){for(const t of e)t.leftRightSwap()}},pasteWidgetsFromClipboard:{doit({view:e,clipboard:t}){if(t.selection.what!=H.pinArea)return;const[i,s]=e.selectedNodeAndPosition();i.cannotBeModified()||(e.clipboardToSelection(s,t),u.saveEdit("pasteWidgetsFromClipboard",{view:e,node:i,widgets:e.selection.widgets.slice(),pos:s}))},undo({view:e,node:t,widgets:i,pos:s}){i&&t.look.deletePinArea(i),e.selection.reset()},redo({view:e,node:t,widgets:i,pos:s}){const n=t.look.copyPinArea(i,s);t.is.source?t.rxtxAddPinArea(i):t.addPads(i),e.selection.pinAreaSelect(n),i.splice(0,i.length,...n)}},pinAreaToMulti:{doit({view:e,widgets:t}){u.saveEdit("pinAreaToMulti",{view:e,widgets:t})},undo({view:e,widgets:t}){},redo(){}},multiToPinArea:{doit({view:e,pin:t}){u.saveEdit("multiToPinArea",{view:e,pin:t})},undo({view:e,pin:t}){},redo(){}}},zu={panning:{doit({view:e}){},undo({}){},redo({}){}},xxpanning:{doit({view:e}){u.saveEdit("panning",{view:e,oldTf:{...e.tf},newTf:{...e.tf}})},undo({view:e,oldTf:t,newTf:i}){i.dx=e.tf.dx,i.dy=e.tf.dy,e.tf.dx=t.dx,e.tf.dy=t.dy},redo({view:e,oldTf:t,newTf:i}){e.tf.dx=i.dx,e.tf.dy=i.dy}},zooming:{doit({view:e}){},undo({}){},redo({}){}}},Ws={};Object.assign(Ws,Fu,Wu,Hu,Bu,$u,ju,Vu,Uu,zu);const qu={adjustRoutes(){for(const e of this.routes)e.adjust()},routeToPin(e){let t=new vt(e,this);t.fourPointRoute(),this.routes.push(t),e.routes.push(t)},shortConnection(e){let t=new vt(e,this);t.twoPointRoute(),this.routes.push(t),e.routes.push(t)},canConnect(e){return!(e.is.pin&&(this.proxy.is.input!=e.is.input||e.is.channel&&!this.proxy.is.channel||(e.is.multi||this.proxy.is.multi)&&!e.hasMultiOverlap(this.proxy))||this.routes.find(t=>t.from==e||t.to==e))},disconnect(){const e=this.routes.slice();for(const t of e)(t.from==this?t.to:t.from).is.pin?t.rxtxPinPadDisconnect():t.rxtxPadBusDisconnect(),t.remove()},reconnect(e){this.routes=e;for(const t of e){const i=t.from==this?t.to:t.from;i.is.pin?i.routes.push(t):i.bus.push(i)}},checkRoutesDirection(){this.routes.forEach(e=>{e.from==this&&e.reverse()})},drag(e,t){if(this.routes.length>0){const i=this.routes[0].wire,[s,n]=this.routes[0].from==this?[i[0],i[1]]:[i.at(-1),i.at(-2)],o=s.y==n.y?{x:s.x+t.x,y:e.y}:{x:e.x,y:s.y+t.y};for(const a of this.routes)a.drawXY(o);s.y==n.y&&(this.is.leftText=s.x<n.x);const r=this.rect;r.y=s.y-r.h/2,r.x=this.is.leftText?s.x-r.w:s.x}else this.rect.x+=t.x,this.rect.y+=t.y},xdrag(e,t){if(this.routes.length>0){const i=this.routes[0].wire;if(i.length>0){const s=i.at(-1);e=i.at(-2).y==s.y?{x:s.x+t.x,y:e.y}:{x:e.x,y:s.y+t.y}}for(const s of this.routes)s.drawXY(e);this.place()}else this.rect.x+=t.x,this.rect.y+=t.y},endDrag(){this.routes.forEach(e=>e.endpoint(this))},slide(e){this.routes.forEach(t=>{const i=t.wire;i.length==2&&t.addTwoSegments({...i[0]},{...i[1]});const[s,n]=this==t.from?[i[0],i[1]]:[i.at(-1),i.at(-2)];s.y+=e.y,n.y+=e.y}),this.rect.y+=e.y},fuseEndSegment(){let e=null,t=0;for(const i of this.routes){if(i.wire.length<4)continue;const s=i.wire,[n,o,r,a]=this==i.from?[s[0],s[1],s[2],!0]:[s.at(-1),s.at(-2),s.at(-3),!1];if(Math.abs(r.y-o.y)<g.route.tooClose){t=r.y-n.y,n.y=r.y,a?i.removeTwoPoints(1,s):i.removeTwoPoints(s.length-3,s),e=i;break}}if(e){for(const i of this.routes){if(i==e)continue;const s=i.wire,[n,o]=this==i.from?[s[0],s[1]]:[s.at(-1),s.at(-2)];n.y+=t,o.y+=t}this.rect.y+=t}},copyPadPinRoutes(e,t){for(const i of e.routes){const s=i.from==e?i.to:i.from;if(!s.is.pin)continue;const n=i.clone();n.to==e?n.to=this:n.from=this,this.routes.push(n);const r=t.nodes.find(a=>a.uid==s.node.uid).look.findPin(s.name,s.is.input);n.from==this?n.to=r:n.from=r,r.routes.push(n)}},removeRoute(e){Re(this.routes,e)},copyWires(){const e=[];for(const t of this.routes)e.push(t.copyWire());return e},restoreWires(e){const t=this.routes.length;for(let i=0;i<t;i++)this.routes[i].restoreWire(e[i])},highLightRoutes(){for(const e of this.routes){const t=e.from==this?e.to:e.from;if(t){if(t.is.pin){if(!this.areConnected(t))continue;e.highLight()}t.is.tack&&(e.highLight(),t.bus.highLightRoutes(this))}}},unHighLightRoutes(){for(const e of this.routes){e.unHighLight();const t=e.from==this?e.to:e.from;t&&t!=null&&t.is.tack&&t.bus.unHighLightRoutes(this)}},checkRouteUsage(){for(const t of this.routes)t.is.notUsed=!1;const e=this.proxy;for(const t of this.routes){const i=t.from==this?t.to:t.from;if(i.is.pin)(i.is.multi||e.is.multi)&&!e.hasMultiOverlap(i)&&(t.is.notUsed=!0);else if(i.is.tack){let s=!1;for(const n of i.bus.tacks){if(n==i)continue;const o=n.route.to==n?n.route.from:n.route.to;i.bus.areConnected(this,o)&&(n.route.is.notUsed=!1,s=!0)}s||(t.is.notUsed=!0)}}}};function xi(e,t,i=null){this.uid=i,this.rect={...e},this.is={pad:!0,selected:!1,highLighted:!1,leftText:t.is.left,hoverOk:!1,hoverNok:!1,beingEdited:!1},this.text=t.name,this.proxy=t,this.routes=[]}xi.prototype={copy(){return new xi(this.rect,this.proxy,this.uid)},render(e,t){var c;let i=g.pad;const s=this.rect,n=this.proxy,o=this.is.hoverNok?i.cBad:i.cBackground;let r=this.is.highLighted?i.cHighLighted:this.is.selected||this.is.hoverOk?i.cSelected:((c=this.routes)==null?void 0:c.length)>0?i.cConnected:i.cText;const a=r;let l=s.y+(i.hPad-i.wArrow)/2;if(this.is.beingEdited&&(s.w=g.pad.wExtra+e.measureText(this.text).width,this.place()),this.is.leftText){const h=s.x+s.w-i.rBullet/2-i.hArrow;W.rectBullet(e,s.x,s.y,s.w,s.h,o,i.rBullet),n.is.channel?n.is.input?W.ballTriangle(e,h,l,i.hArrow,i.wArrow,a):W.triangleBall(e,h,l,i.hArrow,i.wArrow,a):n.is.input?W.rightTriangle(e,h,l,i.hArrow,i.wArrow,a):W.leftTriangle(e,h,l,i.hArrow,i.wArrow,a),n.is.multi?W.leftTextMulti(e,this.text,g.pin.fMulti,r,s.x+g.pad.wMargin,s.y,s.w,s.h):W.leftText(e,this.text,r,s.x+g.pad.wMargin,s.y,s.w,s.h)}else{const h=s.x+i.rBullet/2;W.bulletRect(e,s.x,s.y,s.w,s.h,o,i.rBullet),n.is.channel?n.is.input?W.triangleBall(e,h,l,i.hArrow,i.wArrow,a):W.ballTriangle(e,h,l,i.hArrow,i.wArrow,a):n.is.input?W.leftTriangle(e,h,l,i.hArrow,i.wArrow,a):W.rightTriangle(e,h,l,i.hArrow,i.wArrow,a),n.is.multi?W.rightTextMulti(e,this.text,g.pin.fMulti,r,s.x,s.y,s.w,s.h):W.rightText(e,this.text,r,s.x,s.y,s.w,s.h)}},drawCursor(e,t,i){const s=this.rect,n=e.measureText(this.text.slice(0,t)).width,o=this.is.leftText?s.x+n+g.pad.wMargin:s.x+s.w-e.measureText(this.text).width+n,r=i?g.std.cBlinkOn:g.std.cBlinkOff;W.cursor(e,o,s.y,g.std.wCursor,s.h,r)},center(){const e=this.rect;return this.is.leftText?{x:e.x+e.w,y:e.y+e.h/2}:{x:e.x,y:e.y+e.h/2}},place(){const e=this.routes[0];if(!(e!=null&&e.wire.length))return;const[t,i]=e.from==this?[e.wire[0],e.wire[1]]:[e.wire.at(-1),e.wire.at(-2)];this.is.leftText=t.x<i.x;const s=this.rect;s.y=t.y-s.h/2,s.x=this.is.leftText?t.x-s.w:t.x},startEdit(){return this.is.beingEdited=!0,"text"},getWidth(){const e=this.proxy;return g.pad.wExtra+e.node.look.getTextWidth(this.text,e.is.multi)},endEdit(e){const t=this.proxy;if(this.is.beingEdited=!1,this.text.length>0){if(t.name=this.text,!t.checkNewName()){t.name=this.text=e;return}this.text=t.name,this.checkRouteUsage(),this.rect.w=this.getWidth();return}if(t.routes.length==0){t.node.look.removePin(t),t.node.removePad(this);return}this.text=e},nameChange(e){this.text=e,this.rect.w=this.getWidth()},overlap(e){const t=this.rect;return!(t.x>e.x+e.w||t.x+t.w<e.x||t.y>e.y+e.h||t.y+t.h<e.y)},moveTo(e,t){this.rect.x=e,this.rect.y=t,this.adjustRoutes()},move(e){this.rect.x+=e.x,this.rect.y+=e.y},areConnected(e){return!(e.is.pin&&this.proxy.is.multi&&!e.hasMultiOverlap(this.proxy))},makeConxList(e){var t;for(const i of this.routes){const s=i.from==this?i.to:i.from;this.areConnected(s)&&(s.is.pin?s.is.proxy?(t=s.pad)==null||t.makeConxList(e):e.push(s):s.is.tack&&(s.bus.hasFilter()?e.push(s):s.bus.makeConxList(this,e)))}},highLight(){this.is.highLighted=!0},unHighLight(){this.is.highLighted=!1},hitTest(e){return st(e,this.rect)?this.is.leftText?e.x>this.rect.x+this.rect.w-2*g.pad.rBullet?[A.padArrow,this]:[A.pad,this]:e.x<this.rect.x+2*g.pad.rBullet?[A.padArrow,this]:[A.pad,this]:[A.nothing,null]},hitRoute(e){let t=0;for(const i of this.routes)if(i.from==this&&(t=i.hitSegment(e)))return[A.route,i,t];return[A.nothing,null,0]}};Object.assign(xi.prototype,qu);const Ju={addHeader(){const e=2*(g.icon.xPadding+2*g.icon.wIcon+g.icon.xSpacing),t=this.getTextWidth(this.node.name)+e,i=this.rect;t>i.w&&this.wider(t-i.w);const s={x:i.x,y:i.y,w:i.w,h:g.header.hTitle},n=new Ys(s,this.node);return this.widgets.push(n),n},addLabel(e){const t=this.rect;this.getTextWidth(e);const i={x:t.x,y:t.y-g.label.hLabel,w:t.w,h:g.label.hLabel},s=new Ks(i,e,this.node);return this.widgets.push(s),t.y-=g.label.hLabel,t.h+=g.label.hLabel,s},removeLabel(){const e=this.findLabel();e&&(Re(this.widgets,e),this.rect.y+=g.label.hLabel,this.rect.h-=g.label.hLabel)},restoreLabel(e){this.widgets.push(e),this.rect.y-=g.label.hLabel,this.rect.h+=g.label.hLabel},addPin(e,t,i){const s=i.left??t.x<this.rect.x+this.rect.w/2,n=this.displayName(e,t.y),o=this.pinRectangle(n,t.y,s,i.multi),r=i.proxy?new ys(o,this.node,e,i):new yi(o,this.node,e,i);return r.is.left=s,this.addWidget(r),r},removePin(e){e.is.pin&&Re(this.widgets,e)&&this.shiftUp(e.rect.y,e.rect.h)},restorePin(e){const t=e.rect;this.makePlace({x:t.x,y:t.y},t.h),this.addWidget(e)},addIfName(e,t){const i=this.makePlace(t,g.ifName.hSep),s={x:this.rect.x,y:i,w:this.rect.w,h:g.ifName.hSep},n=new Xs(s,e,this.node);return this.addWidget(n),n},removeInterfaceName(e){e.is.ifName&&Re(this.widgets,e)&&this.shiftUp(e.rect.y,e.rect.h)},restoreInterfaceName(e){const t=e.rect;this.makePlace({x:t.x,y:t.y},t.h),this.addWidget(e)},copyPinArea(e,t){if(!e||e.length==0)return null;e.sort((n,o)=>n.rect.y-o.rect.y);const i={...t},s=[];for(const n of e)if(n.is.pin){if(this.findPin(n.name,n.is.input))continue;const o=this.addPin(n.name,i,n.is);n.pxlen&&(o.pxlen=n.pxlen,o.checkPrefix()),i.y=o.rect.y+o.rect.h,s.push(o)}else if(n.is.ifName){if(this.findInterfaceName(n.text))continue;const o=this.addIfName(n.text,i);i.y=o.rect.y+o.rect.h,s.push(o)}return s},deletePinArea(e){if(!(!e||e.length==0))for(const t of e)t.is.pin?(t.disconnect(),this.removePin(t),t.is.proxy?(t.pad.disconnect(),t.node.removePad(t.pad)):t.node.rxtxRemovePin(t)):t.is.ifName&&this.removeInterfaceName(t)}},Gu={getInterface(e){const t=[];t.push(e);let i=this.rect.y+this.rect.h;for(const s of this.widgets)s.is.ifName&&s.rect.y>e.rect.y&&s.rect.y<i&&(i=s.rect.y);for(const s of this.widgets)s.is.pin&&s.rect.y>=e.rect.y&&s.rect.y<i&&t.push(s);return t.sort((s,n)=>s.rect.y-n.rect.y),t},shiftWidgetsBelow(e,t){for(const i of this.widgets){if(i.is.box){i.rect.h+=t,this.rect.h+=t;continue}if(i.rect.y>e&&(i.rect.y+=t,i.routes))for(const s of i.routes)s.clampToWidget(i)}},swapInterface(e,t){const i=this.findNextWidget(t[0],e,f=>f.is.ifName);if(!i||e.y<i.rect.y||e.y>i.rect.y+i.rect.h)return;const s=e.y>t[0].rect.y,n=this.getInterface(i),o=t[0],r=t.at(-1);let a=r.rect.y-o.rect.y+r.rect.h;s&&(a=-a);const l=n[0],c=n.at(-1);let h=c.rect.y-l.rect.y+c.rect.h;s||(h=-h);for(const f of n)f.rect.y+=a,f.is.pin&&f.adjustRoutes();for(const f of t)f.rect.y+=h,f.is.pin&&f.adjustRoutes()},interfaceChangePrefix(e){const t=this.getInterface(e);for(const i of t)if(i.is.pin&&i.pxlen!=0){const s=i.name;i.changePrefix(e.text),i.nameChanged(s)}},showPrefixes(e){const t=e.node.look.getInterface(e),i=[];for(const s of t)s.is.pin&&s.pxlen!=0&&(i.push(s.pxlen),s.pxlen=0);return i},hidePrefixes(e,t){const i=e.node.look.getInterface(e);for(let s=1;s<t.length;s++)i[s].pxlen=t[s]},highLightInterface(e){const t=this.getInterface(e);for(const i of t)i.highLight(),i.is.pin&&i.highLightRoutes();return t},unhighLightInterface(e){if(e)for(const t of e)t.unHighLight(),t.is.pin&&t.unHighLightRoutes()},findIfNameAbove(e){let t=null;for(const i of this.widgets)i.is.ifName&&i.rect.y<e&&(t==null||t.rect.y<i.rect.y)&&(t=i);return t},getPrefixLength(e,t){const i=this.findIfNameAbove(t);if(!i)return 0;const s=e.indexOf(".");if(s>0&&e.slice(0,s)===i.text)return i.text.length;const n=e.lastIndexOf(".");return n>0&&e.slice(n+1)===i.text?-i.text.length:0},displayName(e,t){return this.getPrefixLength(e,t)>0?"+ "+e.slice(this.pxlen+1):e.slice(0,this.pxlen-1)+" +"},dragPinArea(e,t){const i=e[0];if(t.y<i.rect.y){const n=this.findNextWidget(i,{x:0,y:t.y},o=>o.is.pin||o.is.ifName);if(!n)return;t.y<n.rect.y+n.rect.h/2&&(this.groupMove(e,n.rect.y-i.rect.y),this.interfaceCheck());return}const s=e.at(-1);if(t.y+t.h>s.rect.y+s.rect.h){const n=this.findNextWidget(s,{x:0,y:t.y+t.h},o=>o.is.pin||o.is.ifName);if(!n)return;t.y+t.h>n.rect.y+n.rect.h+n.rect.h/2&&(this.groupMove(e,n.rect.y-s.rect.y),this.interfaceCheck());return}},interfaceCheck(){for(const e of this.widgets)e.is.pin&&(e.pxlen=0);for(const e of this.widgets){if(!e.is.ifName)continue;const t=this.getInterface(e);for(const i of t){if(!i.is.pin)continue;const s=e.text.toLowerCase(),n=i.lowerCase();n.startsWith(s)?i.pxlen=s.length:n.endsWith(s)&&(i.pxlen=-s.length)}}}},Yu={headerChanged(e,t){if(e.title.length==0){e.title=e.node.name;return}const i=2*(g.icon.xPadding+2*(g.icon.wIcon+g.icon.xSpacing));let s=this.getTextWidth(e.title)+i;s>this.rect.w&&this.wider(s-this.rect.w),e.node.name=e.title,e.node.is.source&&e.node.factory.fName.length<1&&(e.node.factory.fName=k.nodeToFactory(e.node.name)),u.doc.focus.root.checkDuplicates(e.node)},iconRect(e,t){let i=e.x;const s=g.icon;switch(t){case"L1":i=e.x+s.xPadding;break;case"L2":i=e.x+s.xPadding+s.wIcon+s.xSpacing;break;case"R1":i=e.x+e.w-s.xPadding-s.wIcon;break;case"R2":i=e.x+e.w-s.xPadding-s.wIcon-s.xSpacing-s.wIcon;break}return{x:i,y:e.y+s.yPadding,w:s.wIcon,h:s.hIcon}},addIcon(e){const t=this.widgets.find(r=>r.is.header);if(!t)return;const i={group:"L1",factory:"L1",link:"L1",lock:"L1",cog:"L2",comment:"R1",pulse:"R2"},s=this.iconRect(t.rect,i[e]),n=this.widgets.find(r=>r.is.icon&&r.rect.x==s.x);n&&Re(this.widgets,n);const o=new pn(s,e);o.setRender(),this.widgets.push(o)},badLinkIcon(){const e=this.widgets.find(t=>t.is.icon&&(t.type=="link"||t.type=="lock"));e&&(e.is.bad=!0)},goodLinkIcon(){const e=this.widgets.find(t=>t.is.icon&&(t.type=="link"||t.type=="lock"));e&&(e.is.bad=!1)},checkLinkIcon(e){const t=this.widgets.find(i=>i.is.icon&&(i.type=="link"||i.type=="lock"));(t==null?void 0:t.type)!=e&&this.addIcon(e)},removeLinkIcon(){const e=this.widgets.find(t=>t.is.icon&&t.type=="link");e&&Re(this.widgets,e)},blinkToWarn(){const e=a=>{a-r>=n&&(t.is.highLighted=!t.is.highLighted,i.is.highLighted=!i.is.highLighted,u.redraw(),r=a,o++),o<s?requestAnimationFrame(e):(t.is.highLighted=!1,i.is.highLighted=!1,u.redraw())},t=this.widgets.find(a=>a.is.icon&&(a.type=="link"||a.type=="lock")),i=this.widgets.find(a=>a.is.header);if(!t||!i)return;const s=g.icon.nBlinks*2,n=g.icon.blinkRate;let o=0,r=0;requestAnimationFrame(e)}},Xu={moveDelta(e,t){this.rect.x+=e,this.rect.y+=t,this.widgets.forEach(i=>{i.rect.x+=e,i.rect.y+=t})},moveTo(e,t){this.moveDelta(e-this.rect.x,t-this.rect.y)},adjustRoutes(){for(const e of this.widgets)e.routes&&e.adjustRoutes()},moveRoutes(e,t){for(const i of this.widgets)if(i.routes)for(const s of i.routes)s.from==i&&s.moveAllPoints(e,t)},groupMove(e,t){const i=(r,a)=>{r.rect.y+=a,r.is.pin&&r.adjustRoutes()},s=e[0].rect.y,n=e.at(-1).rect.y,o=n-s+e.at(-1).rect.h;for(const r of this.widgets){const a=r.rect.y;a<=n&&a>=s?i(r,t):t>0&&a>n&&a<=n+t?i(r,-o):t<0&&a<s&&a>=s+t&&i(r,o)}},findNextWidget(e,t,i){let s=e.rect.y;if(t.y>=s&&t.y<=s+e.rect.h)return null;let n=null;if(t.y<s)for(const o of this.widgets)!i(o)||o==e||o.rect.y<s&&(n==null||n.rect.y<o.rect.y)&&(n=o);else if(t.y>s+e.rect.h)for(const o of this.widgets)!i(o)||o==e||o.rect.y>s&&(n==null||n.rect.y>o.rect.y)&&(n=o);return n},snapRoutes(){for(const e of this.widgets)if(e.is.pin)for(const t of e.routes){const i=t.wire;if(i.length<3)continue;const[s,n]=e==t.from?[i[0],i[2]]:[i.at(-1),i.at(-3)],o=n.y-s.y;if(Math.abs(o)<g.route.tooClose){this.moveDelta(0,o),this.adjustRoutes();return}}}},Ku={copy(e){e.look.widGenerator=this.widGenerator,this.widgets.forEach(t=>{let i=null;t.is.pin?(i=t.is.proxy?new ys(t.rect,e,t.name,t.is):new yi(t.rect,e,t.name,t.is),i.profile=t.profile,i.pxlen=t.pxlen):t.is.ifName?i=new Xs(t.rect,t.text,e):t.is.header?i=new Ys(t.rect,e):t.is.icon?(i=new pn(t.rect,t.type),i.setRender()):t.is.box?i=new Gs(t.rect,e):t.is.label&&(i=new Ks(t.rect,t.text,e)),t.wid&&(i.wid=t.wid),i&&e.look.widgets.push(i)})},copyConvert(e){e.look.widGenerator=this.widGenerator,this.widgets.forEach(t=>{let i=null;if(t.is.pin)i=t.is.proxy?new yi(t.rect,e,t.name,t.is):new ys(t.rect,e,t.name,t.is),i.profile=t.profile,i.pxlen=t.pxlen;else if(t.is.ifName)i=new Xs(t.rect,t.text,e);else if(t.is.header)i=new Ys(t.rect,e);else if(t.is.icon){const s=t.type=="group"?"factory":t.type=="factory"?"group":t.type;e.look.addIcon(s)}else t.is.box?i=new Gs(t.rect,e):t.is.label&&(i=new Ks(t.rect,t.text,e));t.wid&&(i.wid=t.wid),i&&e.look.widgets.push(i)})},copyPinPinRoutes(e){const t=e.widgets.length;let i=null,s=null;for(let n=0;n<t;n++)if(i=e.widgets[n],s=this.widgets[n],i.is.pin&&i.is.input)for(const o of i.routes){if(!o.to.is.pin||!o.from.is.pin)continue;const r=o.clone();r.from==i?r.from=s:r.to=s,s.routes.push(r)}},correctPinPinRoutes(e){for(const t of this.widgets)if(t.is.input)for(const i of t.routes){const s=i.from==t?i.to:i.from;if(!s.is.pin)continue;const o=e.nodes.find(r=>r.uid==s.node.uid).look.findPin(s.name,!1);i.from==t?i.to=o:i.from=o,o.routes.push(i)}},transferRoutes(e){var t;for(let i=0;i<e.widgets.length;i++){const s=this.widgets[i],n=e.widgets[i];if(((t=s.routes)==null?void 0:t.length)>0)for(const o of s.routes)o.from==s&&(o.from=n),o.to==s&&(o.to=n),n.routes.push(o)}}},Qu={getItemsToSave(){const e=[],t={rect:{...this.rect},label:null,interfaces:[]};for(const n of this.widgets)if(!(n.is.icon||n.is.box||n.is.header)){if(n.is.label){t.rect.y+=n.rect.h,t.rect.h-=n.rect.h,t.label=n;continue}(n.is.ifName||n.is.pin)&&e.push(n)}if(e.length==0)return t;e.sort((n,o)=>n.rect.y-o.rect.y);let i=-1,s=null;e[0].is.pin&&(i++,t.interfaces[i]={name:"",pins:[],editor:{id:0}},s=t.interfaces[i].pins);for(const n of e)n.is.pin?s.push(n):n.is.ifName&&(i++,t.interfaces[i]={name:n.text,pins:[],editor:{id:n.wid}},s=t.interfaces[i].pins);return t},acceptChanges(){var t;const e=[];for(const i of this.widgets){if(i.is.pin){const s=(t=i.routes)==null?void 0:t.slice();if(i.is.zombie){for(const n of s)n.disconnect();e.push(i)}else for(const n of s)n.is.newConx?n.is.newConx=!1:n.is.noConx&&n.disconnect()}i.is.ifName&&i.is.zombie&&(i.node.look.showPrefixes(i),e.push(i)),i.is.added&&(i.is.added=!1)}for(const i of e)i.is.pin?i.node.look.removePin(i):i.is.ifName&&i.node.look.removeInterfaceName(i)},cook(e){var t;if(e.label&&this.addLabel(e.label),!!e.interfaces){for(const i of e.interfaces){this.cookInterface(i);for(const s of i.pins){const n=this.cookPin(s);this.node.is.group&&((t=s.editor)!=null&&t.pad?this.node.cookPad(n,s.editor.pad):this.node.addPad(n))}}for(const i of this.widgets)i.wid&&i.wid>this.widGenerator&&(this.widGenerator=i.wid);for(const i of this.widgets)i.wid==0&&(i.wid=this.generateWid())}},cookPin(e){e.editor||(e.editor={id:0,align:"left"});const t={input:!1,left:!1,channel:!1,multi:!1,zombie:!1};t.input=e.kind=="input"||e.kind=="reply",t.left=e.editor.align=="left",t.channel=e.kind=="request"||e.kind=="reply",t.multi=k.isMulti(e.name),t.proxy=this.node.is.group;const i=this.addPin(e.name,0,t);return i.wid=e.editor.id,i.ifNamePrefixCheck(),this.adjustPinWidth(i),i},cookInterface(e){var i;if(e.name.length==0)return null;const t=this.addIfName(e.name,null);return t.wid=((i=e.editor)==null?void 0:i.id)||0,t}};function mt(e){this.rect={...e},this.rect.w=e.w>0?e.w:g.look.wBox,this.rect.h=e.h>0?e.h:g.look.hTop+g.look.hBottom,this.node=null,this.widGenerator=0,this.widgets=[]}mt.prototype={render(e){var t;(t=this.widgets)==null||t.forEach(i=>i.render(e,this))},remove(){},getMinWidth(){let e=g.look.wBox;for(const t of this.widgets)t.is.pin&&t.rect.w>e&&(e=t.rect.w);return e},changeWidth(e){this.rect.w+=e,this.widgets.forEach(t=>{t.is.pin&&!t.is.left?(t.rect.x+=e,t.adjustRoutes()):t.is.header||t.is.ifName||t.is.box?t.rect.w+=e:t.is.icon&&t.rect.x>this.rect.x+(this.rect.w-e)/2&&(t.rect.x+=e)})},adjustPinWidth(e){const t=g.pin.wMargin+this.getTextWidth(e.withoutPrefix(),e.is.multi);e.is.left||(e.rect.x+=e.rect.w-t),e.rect.w=t,e.rect.w>this.rect.w&&this.wider(e.rect.w-this.rect.w)},getTextWidth(e,t=!1){const i=u.getCanvasContext();if(!t)return i.measureText(e).width;const[s,n,o]=k.getPreMiddlePost(e);let r=i.measureText(s+"[").width+i.measureText("]"+o).width;const a=i.font;return i.font=g.pin.fMulti,r+=i.measureText(n).width,i.font=a,r},wider(e=0){this.rect.w>=g.look.wMax||(e=e>0?Math.ceil(e/g.look.wExtra)*g.look.wExtra:g.look.wExtra,this.rect.w+e>g.look.wMax&&(e=g.look.wMax-this.rect.w),this.changeWidth(e))},smaller(e=0){const t=this.getMinWidth();this.rect.w<=t||(e=e>0?(1+Math.floor(e/g.look.wExtra))*g.look.wExtra:g.look.wExtra,this.rect.w-e<t&&(e=this.rect.w-t),this.changeWidth(-e))},decorate(e){this.node=e,this.addBox(),this.addHeader(),this.addIcon("cog"),e.is.source?this.addIcon("factory"):this.addIcon("group"),this.addIcon("pulse"),this.addIcon("comment")}};Object.assign(mt.prototype,Rd,Ju,Gu,Yu,Xu,Ku,Qu);function Qi(e=null,t=null,i=null){this.uid=i,this.name=t,this.is={group:!1,source:!1,highLighted:!1,placed:!0,duplicate:!1},this.link=null,this.look=e,this.sx=null,this.dx=null,this.prompt=null}Qi.prototype={render(e){var i,s;const t=(i=this.link)!=null&&i.model?g.switch(this.link.model.header.style):null;(s=this.look)==null||s.render(e),t&&g.switch(t)},findByName(e){if(this.name==e)return this;if(this.nodes){let t=null;for(const i of this.nodes)if(t=i.findByName(e))return t}return null},findByName(e){if(this.name==e)return this;if(this.nodes){let t=null;for(const i of this.nodes)if(t=i.findByName(e))return t}return null},findParent(e){let t=this;if(this.nodes){for(const i of this.nodes)if(i==e)return t;for(const i of this.nodes)if(i.is.group&&(t=i.findParent(e)))return t}return null},updateName(e){if(!(!e||e===this.name)){this.name=e;for(const t of this.look.widgets)if(t.is.header){t.title=e;break}}},hitTest(e){const{x:t,y:i,w:s,h:n}=this.look.rect,o=g.pin.wOutside;if(e.x<t-o||e.x>t+s+o||e.y<i||e.y>i+n)return[A.nothing,null,null];for(const r of this.look.widgets){const a=r.rect;if(r.is.box||e.y<a.y||e.y>a.y+a.h||e.x<a.x||e.x>a.x+a.w||r.is.header&&!r.hitTitle(e))continue;return[r==null?A.node:r.is.pin?A.pin:r.is.ifName?A.ifName:r.is.icon?A.icon:r.is.header?A.header:r.is.label?A.label:A.node,this,r]}return[A.node,this,null]},hitRoute(e){let t=0;for(const i of this.look.widgets)if(i.is.pin&&i.routes.length>0){for(const s of i.routes)if(s.from==i&&(t=s.hitSegment(e)))return[A.route,s,t]}return[A.nothing,null,0]},overlap(e){const t=this.look.rect;return!(t.x>e.x+e.w||t.x+t.w<e.x||t.y>e.y+e.h||t.y+t.h<e.y)},isContainer(){return this.is.group&&this.pads.length==0},compatible(e){return e.is.group&&this.is.group||e.is.source&&this.is.source},cookCommon(e){e.editor||(e.editor={rect:null});const t=e.editor.rect?k.stringToRect(e.editor.rect):{x:0,y:0,w:0,h:0};this.is.placed=!!e.editor.rect,this.look=new mt(t),this.look.rect.h=g.look.hTop+g.look.hBottom,this.look.decorate(this),this.look.cook(e),t.w>0&&this.look.rect.w>t.w&&this.look.smaller(this.look.rect.w-t.w),e.prompt&&(this.prompt=e.prompt),e.sx&&(this.sx=e.sx),e.dx&&(this.dx=e.dx)},uidChangeAll(e){if(e.generate(this),!this.is.source){for(const t of this.pads)e.generate(t);for(const t of this.buses)e.generate(t);for(const t of this.nodes)t.uidChangeAll(e)}},uidChangeImported(e){for(const t of this.pads)e.generate(t);for(const t of this.buses)e.generate(t);for(const t of this.nodes)t.link||(e.generate(t),t.is.group&&t.uidChangeImported(e))},setUIDS(e){if(e.generate(this),!this.is.source){for(const t of this.pads)e.generate(t);for(const t of this.buses)e.generate(t)}},usesFactory(e,t){var i;this.is.group?this.nodes.forEach(s=>s.usesFactory(e,t)):((i=this.factory)==null?void 0:i.name)==e&&t.push(this)},move(e){this.look.moveDelta(e.x,e.y),this.look.adjustRoutes()},doSelect(){for(const e of this.look.widgets)if(e.is.box){e.is.selected=!0;return}},unSelect(){for(const e of this.look.widgets)if(e.is.box){e.is.selected=!1;return}},samePosition(e){return this.look.rect.x==e.look.rect.x&&this.look.rect.y==e.look.rect.y},cannotBeModified(){return this.link==null?!1:(this.look.blinkToWarn(),!0)},switchNodeType(){const e=this.is.group?this.copyAsSourceNode():this.copyAsGroupNode();return this.look.transferRoutes(e.look),e}};Object.assign(Qi.prototype,Td,_d,Pd,Sd,xd,kd);const Zu={toJSON(){if(this.link)return this.dockToJSON();const{rect:e,label:t,interfaces:i}=this.look?this.look.getItemsToSave():{rect:null,label:null,interfaces:[]},s={kind:"group",name:this.name};t&&(s.label=t),i.length&&(s.interfaces=i),this.sx&&(s.sx=this.sx),this.dx&&(s.dx=this.dx),this.prompt&&(s.prompt=this.prompt),this.nodes.length&&(s.nodes=this.nodes);const[n,o]=this.getRoutesAndConnections();return o.length&&(s.connections=o),s.editor={rect:k.rectToString(e)},this.savedView&&(s.editor.view=k.viewToJSON(this.savedView)),this.buses.length&&(s.editor.buses=this.buses),n.length&&(s.editor.routes=n),s},dockToJSON(){const{rect:e,label:t,interfaces:i}=this.look?this.look.getItemsToSave():{rect:null,label:null,interfaces:[]},s={kind:"dock",name:this.name,link:this.link};return t&&(s.label=t),this.prompt&&(s.prompt=this.prompt),i.length&&(s.interfaces=i),this.sx&&(s.sx=this.sx),this.dx&&(s.dx=this.dx),s.editor={rect:k.rectToString(e)},s},cook(e,t){if(this.cookCommon(e),e.editor.view&&(this.savedView=k.stringToView(e.editor.view)),e.nodes)for(const n of e.nodes){const o=n.link?t.linkedNode(n):t.localNode(n);o&&this.nodes.push(o),o.is.placed||this.placeNode(o)}const i=e.connections?this.cookConx(e.connections):[];if(e.editor.buses)for(const n of e.editor.buses){const o=new ks(n.name,{x:0,y:0});o.cook(n,t),this.buses.push(o)}const s=[];if(e.editor.routes)for(const n of e.editor.routes){const o=this.cookRoute(n);o&&s.push(o)}if(i){for(const n of s)this.findRouteInConx(n,i);this.createRoutes(i)}},placeRoot(){const e=g.placement;this.look.moveTo(e.marginLeft,e.marginTop),this.is.placed=!0},placeNode(e){const t=g.placement,i=this.nodes.length-1,s=i%t.nodesPerRow,n=Math.floor(i/t.nodesPerRow),o=this.pads.length?t.marginLeftPads:t.marginLeft;e.look.moveTo(o+s*t.colStep,t.marginTop+n*t.rowStep),e.is.placed=!0},cookPad(e,t){let i=t.rect?k.stringToRect(t.rect):{x:10,y:10,w:0,h:0};i.w==0&&(i=e.makePadRect({x:i.x,y:i.y}));const s=new xi(i,e,null);s.is.leftText=t.align=="left",e.pad=s,this.pads.push(s)},cookRoute(e){const t=k.rawToEndPoint(e.from),i=k.rawToEndPoint(e.to);if(!t||!i)return null;let[s,n]=this.getEndPoints(t,i);if(!s||!n)return s||console.error(`invalid route *FROM* ${e.from} to ${e.to}`),n||console.error(`invalid route from ${e.from} *TO* ${e.to}`),null;s.is.bus&&(s=s.newTack()),n.is.bus&&(n=n.newTack());const o=new vt(s,n);return o.wire=k.stringToWire(s.center(),n.center(),e.wire),o.wire.length<2&&o.autoRoute(this.nodes),s.is.tack?s.setRoute(o):s.routes.push(o),n.is.tack?n.setRoute(o):n.routes.push(o),o.checkTwistedPair(),o.adjust(),o},getEndPoints(e,t){const i=(a,l)=>{for(const c of this.nodes){if(c.name!=a.node)continue;let h=c.look.widgets.find(f=>f.is.pin&&f.is.input==l&&f.name===a.pin);return h||c.look.widgets.find(f=>f.is.pin&&f.is.input==l&&f.wid===a.wid),h}},s=(a,l)=>{let c=this.pads.find(h=>h.proxy.is.input==l&&h.proxy.name===a.pad);return c||this.pads.find(h=>h.proxy.is.input==l&&h.proxy.wid===a.wid),c},n=a=>this.buses.find(l=>l.name===a.bus);let o=null,r=null;return e.pin?(o=i(e,!1),r=t.pin?i(t,!0):t.pad?s(t,!1):t.bus?n(t):null):e.pad?(o=t.pin?s(e,!0):t.bus?s(e,!1):null,r=t.pin?i(t,!0):t.bus?n(t):null):e.bus&&(o=n(e),r=t.pin?i(t,!0):t.pad?s(t,!0):null),[o,r]},fuse(e){this.widgetCompare(e),this.sxUpdate(e),this.nodes=e.nodes,this.buses=e.buses,this.pads=e.pads,this.reConnectPads()},reConnectPads(){this.pads.forEach(e=>{const t=this.look.findPin(e.proxy.name,e.proxy.is.input);if(!t)return console.log(`*** ERROR *** node ${this.name} has no proxy for pad  ${e.proxy.name}`);e.proxy=t,t.pad=e})}},ef={addProxies(e){var i;const t=[];(i=e.nodes)==null||i.forEach(s=>{var n;(n=s.look.widgets)==null||n.forEach(o=>{var l;if(!((l=o.routes)!=null&&l.length)>0)return;const r=[];o.routes.slice().forEach(c=>{const h=c.from==o?c.to:c.from;h.is.pin&&e.nodes.includes(h.node)||h.is.tack&&e.tacks.includes(h)||(r.push(h),c.from.removeRoute(c),c.to.removeRoute(c))}),r.length>0&&t.push({widget:o,destinations:r})})}),t.sort((s,n)=>s.widget.rect.y>n.widget.rect.y?1:s.widget.rect.y<n.widget.rect.y?-1:0),t.forEach(s=>{const n=s.widget,o=this.copyPinAsProxy(n);this.addPad(o),o.pad.moveTo(o.pad.rect.x,n.rect.y),o.pad.routeToPin(n);let r=null;s.destinations.forEach(a=>{r=new vt(o,a),r.builder(),o.routes.push(r),a.is.pin?a.routes.push(r):a.is.tack&&a.restore(r)})})},copyPinAsProxy(e){const t=this.look;let i=null;if(e.pxlen!=0){const o=e.getPrefix();let r=t.findInterfaceName(o);r||(r=this.look.addIfName(o,t.nextPinPosition(!1)));const a=t.getInterface(r).at(-1).rect;i={x:e.is.left?a.x:a.x+a.w,y:a.y+a.h}}else i=t.nextPinPosition(e.is.left);const s=t.pinRectangle(e.displayName(),i.y,e.is.left),n=new ys(s,this,e.name.slice(),e.is);return n.pxlen=e.pxlen,t.addWidget(n),n},addPad(e){var r;const t=g.placement.marginTop+this.pads.length*(g.pad.hPad+g.pad.hSpace),i=this.savedView?this.savedView.rect.w:g.view.wDefault,s=this.savedView?this.savedView.rect.x:0,n=e.is.left?e.makePadRect({x:g.pad.wViewLeft+s,y:t}):e.makePadRect({x:i-g.pad.wViewRight+s,y:t}),o=new xi(n,e);(r=u.doc)==null||r.UID.generate(o),this.pads.push(o),e.pad=o},removePad(e){Re(this.pads,e)},restorePad(e){this.pads.push(e)},addPads(e){for(const t of e)t.is.proxy&&this.addPad(t)},addBus(e,t,i=null){const s=new ks(e??"",t,i);return this.buses.push(s),s},deleteBus(e){e.disconnect(),this.removeBus(e)},removeBus(e){Re(this.buses,e)},restoreBus(e){this.buses.find(t=>t.uid==e.uid)||this.buses.push(e)}},tf={addConnection(e,t,i){const s=r=>r.is.pin?{pin:r.name,node:r.node.name}:r.is.pad?{pin:r.proxy.name}:{pin:"?",node:"?"};if(!t.is.tack){i.push({src:s(e),dst:s(t)});return}const n=t.bus,o=[];for(const r of n.tacks){if(r==t)continue;const a=r.route.from==r?r.route.to:r.route.from;n.areConnected(e,a)&&o.push(a)}for(const r of o)i.push({src:s(e),dst:s(r)})},getRoutesAndConnections(){const e=[],t=[];for(const i of this.nodes)for(const s of i.look.widgets)if(!(!s.is.pin||s.is.input))for(const n of s.routes){e.push(k.routeToString(n));const o=n.from==s?n.to:n.from;this.addConnection(s,o,t)}for(const i of this.pads)if(i.proxy.is.input)for(const s of i.routes){e.push(k.routeToString(s));const n=s.from==i?s.to:s.from;this.addConnection(i,n,t)}for(const i of this.buses)for(const s of i.tacks){const n=s.getOther();n.is.pin&&n.is.input&&e.push(k.routeToString(s.route)),n.is.pad&&!n.proxy.is.input&&e.push(k.routeToString(s.route))}return[e,t]},cookConx(e){const t=(c,h)=>{for(const f of this.nodes)if(f.name==c.node)return f.look.widgets.find(m=>m.is.pin&&m.name===c.pin&&m.is.input===h)},i=(c,h)=>this.pads.find(f=>f.proxy.name===c.pin&&f.proxy.is.input===h),s=(c,h)=>{var v,w,y,b,P,L;const f=`${(v=h.from)==null?void 0:v.pin} ${(w=h.from)!=null&&w.node?" @ "+((y=h.from)==null?void 0:y.node):"(pad)"}`,m=`${(b=h.to)==null?void 0:b.pin} ${(P=h.to)!=null&&P.node?" @ "+((L=h.to)==null?void 0:L.node):"(pad)"}`;console.error(c+f+" -> "+m)},n=(c,h)=>c.is.pin&&h.is.pin?c.is.input==h.is.input:c.is.pin&&h.is.pad?c.is.input!=h.proxy.is.input:c.is.pad&&h.is.pin?c.proxy.is.input!=h.is.input:(c.is.pad&&h.is.pad,!0),o=(c,h)=>{const f=c.is.pin?c:c.proxy,m=h.is.pin?h:h.proxy;if(f.is.input&&f.is.channel||m.is.input&&m.is.channel)return f.is.channel!=m.is.channel},r=[];let a=null,l=null;for(const c of e){const h=c.from??c.src,f=c.to??c.dst;if(!(!h||!f)&&(a=h.node?t(h,!1):i(h,!0),a||s("Connection <src> not found: ",c),l=f.node?t(f,!0):i(f,!1),l||s("Connection <dst> not found: ",c),!(!a||!l))){if(n(a,l)){s("Input/output mismatch: ",c);continue}if(o(a,l)){s("request/reply mismatch: ",c);continue}r.push({src:a,dst:l,is:{new:!0}})}}return r},findRouteInConx(e,t){const i=(r,a)=>t.find(l=>r==l.src&&a==l.dst||r==l.dst&&a==l.src),s=(r,a,l)=>{for(const c of r.tacks){if(c==l)continue;const h=c.getOther();if(r.areConnected(a,h)){const f=i(a,h);f?f.is.new=!1:c.route.is.noConx=!0}}},[n,o]=e.messageFlow();if(t.length==0){e.is.noConx=!o.is.tack;return}if(n.is.tack)e.is.noConx=!1;else if(o.is.tack)s(o.bus,n,o);else{const r=i(n,o);r?r.is.new=!1:e.is.noConx=!0}},createRoutes(e){if(e!=null&&e.length)for(const t of e){if(!t.is.new)continue;const i=new vt(t.src,t.dst);i.autoRoute(this.nodes),i.is.newConx=!0,i.from.routes.push(i),i.to.routes.push(i)}}},sf="group";function Rt(e=null,t=sf,i=null){Qi.call(this,e,t,i),this.is.group=!0,this.nodes=[],this.buses=[],this.pads=[],this.savedView=null,e&&e.decorate(this)}const nf={addNode(e){this.nodes.push(e)},removeNode(e){Re(this.nodes,e)},restoreNode(e){this.nodes.push(e)},findNode(e){var s;const t=k.splitLink(e);if(t.length==1)return this.findRecursive(e);let i=this;for(const n of t)if(i=((s=i.nodes)==null?void 0:s.find(o=>n===o.name))||null,!i)return null;return i},findRecursive(e){for(const i of this.nodes)if(i.name==e)return i;let t=null;for(const i of this.nodes)if(i.is.group&&(t=i.findRecursive(e)))return t;return null},hasDuplicate(e){for(const t of this.nodes)if(t!=e&&t.name===e.name)return!0;return!1},checkDuplicates(e){e.is.duplicate=!1;for(const t of this.nodes)t!=e&&(t.is.duplicate&&(t.is.duplicate=this.hasDuplicate(t)),t.name===e.name&&(e.is.duplicate=t.is.duplicate=!0))},swap(e,t){for(let i=0;i<this.nodes.length;i++)if(this.nodes[i]==e)return this.nodes[i]=t,!0;for(const i of this.nodes)if(i.is.group&&i.swap(e,t))return!0;return!1},copy(){var t,i,s,n;const e=new Rt(null,this.name,this.uid);return e.link=this.link?this.link.copy():null,e.look=new mt(this.look.rect),this.look.copy(e),e.prompt=this.prompt?this.prompt.slice():null,e.sx=this.sx?ea(this.sx):null,(t=this.nodes)==null||t.forEach(o=>{const r=o.copy();r.look.copyPinPinRoutes(o.look),e.addNode(r)}),(i=e.nodes)==null||i.forEach(o=>{o.look.correctPinPinRoutes(e)}),(s=this.pads)==null||s.forEach(o=>{const r=o.copy();r.copyPadPinRoutes(o,e);const a=e.look.widgets.find(l=>l.is.proxy&&l.name==o.proxy.name&&l.is.input==o.proxy.is.input);r.proxy=a,a.pad=r,e.pads.push(r)}),(n=this.buses)==null||n.forEach(o=>{const r=o.copy();o.copyTacks(r,e),e.buses.push(r)}),e.rxtxBuildTxTable(),e},copyAsSourceNode(e=null){let t=new gi(null,e??this.name,this.uid);return t.look=new mt(this.look.rect),this.look.copyConvert(t),t.rxtxPrepareTables(),t}};Object.assign(Rt.prototype,Qi.prototype,nf,ef,Zu,tf);const of={toJSON(){const{rect:e,label:t,interfaces:i}=this.look.getItemsToSave(),s=this.link?{kind:"dock",name:this.name,link:this.link}:{kind:"source",name:this.name,factory:this.factory};return t&&(s.label=t),this.prompt&&(s.prompt=this.prompt),i.length&&(s.interfaces=i),this.sx&&(s.sx=this.sx),this.dx&&(s.dx=this.dx),s.editor={rect:k.rectToString(e)},s},fuse(e){this.widgetCompare(e),this.factory.fName=e.factory.fName,this.factory.arl=e.factory.arl?e.factory.arl.copy():null,this.sxUpdate(e),this.rxtxResetTables(),this.rxtxPrepareTables()},cook(e,t){if(this.cookCommon(e),e.factory){const i=t.getMainModel(),s=t.getCurrentModel();e.factory.path&&(this.factory.arl=s.arl.resolve(e.factory.path),i!=s&&this.factory.arl.makeRelative(i.arl)),this.factory.fName=e.factory.function}this.rxtxPrepareTables()},analyzeFactory(e){var r;const i=Object.entries(e).find(a=>a[0]==this.factory.fName);if(!i)return;const s={out(){}},n=i[1];let o=((r=n.prototype)==null?void 0:r.constructor)===n?n(s,null):new n(s,null);for(const a in o)if(a.startsWith("-> ")&&typeof o[a]=="function"){const l=a.slice(3),c=o[a].toString(),h=c.indexOf("("),f=c.indexOf(")"),m=c.slice(h+1,f);for(const v of this.look.widgets)v.is.pin&&v.name==l&&(v.profile=m)}}};function gi(e=null,t=null,i=null){t=t??"new",Qi.call(this,e,t,i),this.is.source=!0,this.factory=new qi(t?k.nodeToFactory(t):""),this.rxTable=[],this.txTable=[],e&&e.decorate(this)}const rf={copy(e){const t=new gi(null,this.name,this.uid);return t.factory.copy(this.factory),t.look=new mt(this.look.rect),this.look.copy(t),t.prompt=this.prompt?this.prompt.slice():null,t.sx=this.sx?ea(this.sx):null,t.link=this.link?this.link.copy():null,t.rxtxPrepareTables(),t},getSourceArl(e){var t,i,s;return(i=(t=this.link)==null?void 0:t.model)!=null&&i.is.lib?this.link.model.arl:e?e.arl:this.factory.arl?this.factory.arl:(s=this.link)!=null&&s.model?this.link.model.arl.resolve("index.js"):null},copyAsGroupNode(e=null){const t=new Rt(null,e??this.name,this.uid);t.look=new mt(this.look.rect),this.look.copyConvert(t);for(const i of t.look.widgets)i.is.proxy&&t.addPad(i);return t},makeSourceBody(){var l,c;function e(h){const f="___________________________________________________________________",m=h.length;return`
	//`+f.slice(0,-m)+h.toUpperCase()}const t=k.nodeToFactory(this.name);let s=`// ------------------------------------------------------------------
// Source node: ${t}
// Creation date ${new Date().toLocaleString()}
// ------------------------------------------------------------------`,n=((l=this.prompt)==null?void 0:l.length)>0?`

/*
`+this.prompt+`
*/`:"",o=`

//Constructor for ${this.name}
export function ${t}(tx, sx) {
}`;this.look.widgets.sort((h,f)=>h.rect.y-f.rect.y);let r="[";for(const h of this.look.widgets){if(h.is.ifName&&(r+=e(h.text)),!h.is.pin||h.is.input)continue;((c=h.profile)==null?void 0:c.length)>0&&(r+=`

	// `+h.profile);const f=h.is.channel?"=>":"->";if(h.is.multi){const m=k.expandMultis(h.name);for(const v of m)r+=`
	"${v} ${f}",`}else r+=`
	"${h.name} ${f}",`}r+=`
	],`;let a=`

${t}.prototype = {

	// Output pins of the node

	sends: ${r}

	// Input pins of the node
	// For each input pin "a_message" there is a handler "-> a_message" or "=> a_message" (with channel)`;return this.look.widgets.forEach(h=>{var m;if(h.is.ifName&&(a+=e(h.text)),!h.is.pin||!h.is.input)return;a+=((m=h.profile)==null?void 0:m.length)>0?`
	// `+h.profile:`
`;const f=h.is.channel?"=>":"->";if(h.is.multi){const v=k.expandMultis(h.name);for(const w of v)a+=`
	"${f} ${w}"({}) {
	},`}else a+=`
	"${f} ${h.name}"({}) {
	},`}),a+=`

} // ${this.name}.prototype`,s+n+o+a}};Object.assign(gi.prototype,Qi.prototype,rf,of);function qi(e=null){this.fName=e??"",this.arl=null,this.alias=null}qi.prototype={toJSON(){var e;return{path:((e=this.arl)==null?void 0:e.userPath)??"./index.js",function:this.fName}},copy(e){this.fName=e.fName,this.alias=e.alias,this.arl=e.arl?e.arl.copy():null},clone(){const e=new qi;return e.copy(this),e},resolve(e,t,i,s=null){var n;if(!e||e.length==0){if(!s||s.length==0)return;e=s}if(e!==this.fName&&(this.fName=e),!(this.arl==null&&(!t||t.length==0))&&((n=this.arl)==null?void 0:n.userPath)!==t){if(!t||t.length==0){this.arl=null;return}t.at(-1)==="/"?t=t+"index.js":t.lastIndexOf(".js")<0&&(t=t+".js"),this.arl=i.resolve(t)}},duplicate(e,t){const i=e.find(s=>s.arl.equals(t)?!1:s.items.find(n=>n==this.fName));return i?(console.warn(`Duplicate factory name: ${this.fName} is already defined in ${i.arl.userPath}`),this.alias="_"+this.fName,!0):(this.alias=null,!1)}};const af={drawXY(e){const t=this.wire;let i=t.length;if(i==0){let o=this.from.center();t.push({x:o.x,y:o.y}),t.push({x:e.x,y:o.y});return}let s=t[i-2],n=t[i-1];n.y==s.y?Math.abs(e.y-n.y)>g.route.split?t.push({x:n.x,y:e.y}):(n.x=e.x,i>2&&Math.abs(n.x-s.x)<g.route.tooClose&&t.pop()):Math.abs(e.x-n.x)>g.route.split?t.push({x:e.x,y:n.y}):(n.y=e.y,i>2&&Math.abs(n.y-s.y)<g.route.tooClose&&t.pop())},builder(){switch(this.typeString()){case"PIN-PIN":this.fourPointRoute();break;case"PIN-PAD":this.fourPointRoute();break;case"PAD-PIN":this.fourPointRoute();break;case"PIN-BUS":this.to.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"BUS-PIN":this.from.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"PAD-BUS":this.to.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"BUS-PAD":this.from.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break}},sixPointRoute(){this.wire.length>0&&(this.wire.length=0);const e=this.wire,t=this.from,i=this.to,s=t.center(),n=i.center();let o=0,r=0,a=0;if(t.is.pin&&i.is.pin){const l=g.look.dxCopy*(2-Math.random());o=t.is.left?s.x-l:s.x+l,r=i.is.left?n.x-l:n.x+l;const c=t.node.look.rect,h=i.node.look.rect;a=s.y+(c.h/4+h.h/4)*(2-Math.random())}e.push(s),e.push({x:o,y:s.y}),e.push({x:o,y:a}),e.push({x:r,y:a}),e.push({x:r,y:n.y}),e.push(n)},fourPointRoute(){this.wire.length>0&&(this.wire.length=0);const e=this.wire,t=this.from,i=this.to,s=t.center(),n=i.center();let o=0;if(t.is.pin&&i.is.pin&&t.is.left==i.is.left){const r=g.look.dxCopy*(2-Math.random());t.is.left?o=t.rect.x<i.rect.x?t.rect.x-r:i.rect.x-r:o=t.rect.x+t.rect.w>i.rect.x+i.rect.w?t.rect.x+t.rect.w+r:i.rect.x+i.rect.w+r}else{const r=Math.abs(s.x-n.x)*.5*Math.random();o=s.x<n.x?s.x+(n.x-s.x)*.25+r:s.x-(s.x-n.x)*.25-r}e.push(s),e.push({x:o,y:s.y}),e.push({x:o,y:n.y}),e.push(n)},threePointRoute(e){this.wire.length>0&&(this.wire.length=0);const t=this.wire,i=this.from.center(),s=this.to.center();t.push(i),e?t.push({x:s.x,y:i.y}):t.push({x:i.x,y:s.y}),t.push(s)},twoPointRoute(){this.wire.length>0&&(this.wire.length=0);const e=this.wire,t=this.from.center(),i=this.to.center();e.push(t),e.push({x:i.x,y:t.y})},endpoint(e){let t=this.wire,i=t.length;if(i<2)return;let{x:s,y:n}=e.center();if(i==2){t[0].y!=n?(t[1].x=(t[0].x+s)/2,t[1].y=t[0].y,t.push({x:t[1].x,y:n}),t.push({x:s,y:n})):t[1].x=s;return}t[i-1].x==t[i-2].x?(t[i-1].y=n,t.push({x:s,y:n})):(t[i-1].x=s,t[i-1].y=n,t[i-2].x==t[i-3].x?t[i-2].y=t[i-1].y:t[i-2].x=t[i-1].x)},resumeDrawing(e,t){let i=this.from.center(),s=this.to.center();const n=Math.hypot(i.x-t.x,i.y-t.y),o=Math.hypot(s.x-t.x,s.y-t.y);n<o&&(this.reverse(),e=this.wire.length-e),this.wire.length=e>1?e:0,this.from.is.pin||this.from.is.pad?this.from.routes.push(this):this.from.is.tack&&(this.from.route=this,this.from.bus.tacks.push(this.from)),this.to=null,this.drawXY(t)},lineOfSight(e){const t=this.from.center(),i=this.to.center();for(const s of e)if(cd(t,i,s.look.rect))return!1;return!0},autoRoute(e){switch(this.typeString()){case"PIN-PIN":this.checkLeftRight(),this.lineOfSight(e)?this.fourPointRoute():this.sixPointRoute();break;case"PIN-PAD":this.fourPointRoute();break;case"PAD-PIN":this.fourPointRoute();break;case"PIN-BUS":this.to.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"BUS-PIN":this.from.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"PAD-BUS":this.to.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break;case"BUS-PAD":this.from.horizontal()?this.fourPointRoute():this.threePointRoute(!0);break}},checkLeftRight(){const e=this.from.center(),t=this.to.center();this.from.routes.length==0&&(this.from.is.left&&e.x<t.x||!this.from.is.left&&e.x>t.x)&&this.from.leftRightSwap(),this.to.routes.length==0&&(this.to.is.left&&t.x<e.x||!this.to.is.left&&t.x>e.x)&&this.to.leftRightSwap()},healWire(){this.wire.length==3&&(this.wire[3]=this.wire[2],this.wire[2]=this.wire[1],this.wire[2].y=this.wire[3].y,this.wire[1].y=this.wire[0].y)}},lf={moveSegment(e,t){const i=this.from,s=this.to;let n=this.wire[e-1],o=this.wire[e];if(this.wire.length==2&&(i.is.tack||s.is.tack||i.is.pad||s.is.pad)&&this.makeThreeSegments(n,o),e==1)return i.is.tack||i.is.pad?i.slide(t):null;if(e==this.wire.length-1)return s.is.tack||s.is.pad?s.slide(t):null;n.x==o.x?(n.x+=t.x,o.x+=t.x):(n.y+=t.y,o.y+=t.y)},moveAllPoints(e,t){this.wire.forEach(i=>{i.x+=e,i.y+=t})},removeOnePoint(e,t){let i=t.length-1;for(let s=e;s<i;s++)t[s]=t[s+1];t.length=i},removeTwoPoints(e,t){let i=t.length-2;for(let s=e;s<i;s++)t[s]=t[s+2];t.length=i},endDrag(e){const t=this.wire.length;e==1?(this.from.is.tack||this.from.is.pad)&&this.from.fuseEndSegment():e==2?this.from.is.pin?this.fuseSegmentAfter(e):this.fuseSegmentBefore(e)||this.fuseSegmentAfter(e):e==t-1?(this.to.is.tack||this.to.is.pad)&&this.to.fuseEndSegment():e==t-2?this.to.is.pin?this.fuseSegmentBefore(e):this.fuseSegmentBefore(e)||this.fuseSegmentAfter(e):this.fuseSegmentBefore(e)||this.fuseSegmentAfter(e)},fuseSegmentBefore(e){const t=this.wire;if(e-2<0)return!1;const[i,s,n]=[t[e-2],t[e-1],t[e]],o=g.route.tooClose;if(s.y==n.y){if(Math.abs(i.y-s.y)<o)return n.y=i.y,this.removeTwoPoints(e-2,t),!0}else if(s.x==n.x&&Math.abs(i.x-s.x)<o)return n.x=i.x,this.removeTwoPoints(e-2,t),!0;return!1},fuseSegmentAfter(e){const t=this.wire;if(e+1>t.length-1)return!1;const[i,s,n]=[t[e-1],t[e],t[e+1]],o=g.route.tooClose;if(i.y==s.y){if(Math.abs(n.y-s.y)<o)return i.y=n.y,this.removeTwoPoints(e,t),!0}else if(i.x==s.x&&Math.abs(n.x-s.x)<o)return i.x=n.x,this.removeTwoPoints(e,t),!0;return!1},clampToWidget(e){const t=this.wire,i=this.wire.length,s=e.center();if(i<3)return this.fourPointRoute();this.from==e?(t[0].x=s.x,t[0].y=s.y,t[1].y=s.y):this.to==e&&(t[i-1].x=s.x,t[i-1].y=s.y,t[i-2].y=s.y)},adjust(){const e=this.from,t=this.to;if(!(t!=null&&t.center)||!(e!=null&&e.center))return;const i=e.center(),s=t.center(),n=this.wire[0],o=this.wire.at(-1);if(!n||!o||!s||!i){console.error("*** MISSING ENDPOINTS FOR ROUTE ***",this);return}const r={x:i.x-n.x,y:i.y-n.y},a={x:s.x-o.x,y:s.y-o.y};if(r.x==a.x&&r.y==a.y)return this.moveAllPoints(r.x,r.y);t.is.tack?t.dir=="up"||t.dir=="down"?this.adjustHV(i,s):this.adjustHH(i,s):e.is.tack?e.dir=="up"||e.dir=="down"?this.adjustVH(i,s):this.adjustHH(i,s):this.adjustHH(i,s)},adjustHH(e,t){let i=this.wire;if(i.length<4)return this.makeThreeSegments(e,t);let s=i.length-1;const n=i.length-1,o=g.route.tooClose+5;if(i[0].x!=e.x||i[0].y!=e.y){i[0].x=e.x,i[0].y=e.y,i[1].y=e.y;for(let r=1;r<n;r+=2){const a=i[r].x-i[r-1].x;Math.abs(a)<o&&(i[r].x=a>0?i[r-1].x+o:i[r-1].x-o,i[r+1].x=i[r].x)}}if(i[s].x!=t.x||i[s].y!=t.y){i[s].x=t.x,i[s].y=t.y,i[s-1].y=t.y;for(let r=n;r>1;r-=2){const a=i[r].x-i[r-1].x;Math.abs(a)<o&&(i[r-1].x=a>0?i[r].x-o:i[r].x+o,i[r-2].x=i[r-1].x)}}},adjustHV(e,t){if(this.wire.length==2)return this.makeTwoSegments(e,t);const i=this.wire,s=i.length-1;i[0].x=e.x,i[0].y=e.y,i[1].y=e.y,i[s].x=t.x,i[s].y=t.y,i[s-1].x=t.x,i[s-1].y=i[s-2].y},adjustVH(e,t){if(this.wire.length==2)return this.makeTwoSegments(e,t);const i=this.wire,s=i.length-1;i[0].x=e.x,i[0].y=e.y,i[1].x=e.x,i[s].x=t.x,i[s].y=t.y,i[s-1].x=i[s-2].x,i[s-1].y=t.y},adjustFourPointRoute(e,t){const i=g.route.tooClose,[s,n,o,r]=this.wire;let a=n.x;if(n.x>s.x&&n.x>r.x)n.x-e.x<i?a=e.x+i:n.x-t.x<i&&(a=t.x+i);else if(n.x<s.x&&n.x<r.x)e.x-n.x<i?a=e.x-i:t.x-n.x<i&&(a=t.x-i);else{const l=r.x-s.x,c=t.x-e.x;a=c==0?e.x:l==0?(e.x+t.x)/2:e.x+(n.x-s.x)*c/l}s.x=e.x,s.y=e.y,n.y=e.y,n.x=a,o.x=a,o.y=t.y,r.x=t.x,r.y=t.y},makeTwoSegments(e,t){const i=this.wire;i.length=0,i.push({x:e.x,y:e.y}),i.push({x:t.x,y:e.y}),i.push({x:t.x,y:t.y})},makeThreeSegments(e,t){const i=this.wire;i.length=0,i.push({x:e.x,y:e.y}),i.push({x:(e.x+t.x)/2,y:e.y}),i.push({x:(e.x+t.x)/2,y:t.y}),i.push({x:t.x,y:t.y})}},cf={conxString(e,t){let i=e.is.pin?"PIN":e.is.tack||e.is.bus?"BUS":e.is.pad?"PAD":"";return t&&(i+=t.is.pin?"-PIN":t.is.tack||t.is.bus?"-BUS":t.is.pad?"-PAD":""),i},checkConxType(e,t){switch(this.conxString(e,t)){case"PIN-PIN":return e===t?this.wire.length<3:e.canConnect(t);case"PIN-BUS":return!t.findTack(e);case"BUS-PIN":return!e.bus.findTack(t);case"PIN-PAD":return t.canConnect(e);case"PAD-PIN":return e.canConnect(t);case"BUS-PAD":return!1;case"PAD-BUS":return!t.findTack(e);case"BUS-BUS":return!1;case"PAD-PAD":return!1;default:return!1}},connect(e){if(!this.checkConxType(this.from,e))return!1;switch(this.conxString(this.from,e)){case"PIN-PIN":return this.to=e,e.routes.push(this),this.rxtxPinPin(),!0;case"PIN-PAD":return this.to=e,e.routes.push(this),this.rxtxPinPad(),!0;case"PAD-PIN":return this.to=e,e.routes.push(this),this.rxtxPinPad(),!0;case"PIN-BUS":return e.addTack(this),this.rxtxPinBus(),!0;case"BUS-PIN":return this.to=e,e.routes.push(this),this.rxtxPinBus(),!0;case"BUS-PAD":return this.to=e,e.routes.push(this),this.rxtxPadBus(),!0;case"PAD-BUS":return e.addTack(this),this.rxtxPadBus(),!0;case"PAD-PAD":return!1;case"BUS-BUS":return!1;default:return!1}},disconnect(){let e=this.conxString(this.from,this.to);switch(e){case"PIN-PIN":this.rxtxPinPinDisconnect();break;case"PIN-PAD":case"PAD-PIN":this.rxtxPinPadDisconnect();break;case"PIN-BUS":case"BUS-PIN":this.rxtxPinBusDisconnect();break;case"PAD-BUS":case"BUS-PAD":this.rxtxPadBusDisconnect();break;default:console.error("Impossible combination in route.disconnect:",e);break}this.remove()},reconnect(){if(this.from.is.pin){if(this.from.routes.includes(this))return;this.from.routes.push(this)}else if(this.from.is.pad){if(this.from.routes.includes(this))return;this.from.routes.push(this)}else if(this.from.is.tack){if(this.from.bus.tacks.includes(this.from))return;this.from.bus.tacks.push(this.from)}const e=this.to.is.tack?this.to.bus:this.to;this.to=null,this.connect(e)},connectFromClone(e){this.wire=e.wire,this.from=e.from,this.from.routes.push(this);const t=e.to.is.tack?e.to.bus:e.to;this.connect(t)}},hf={arrow(e,t){if(t.is.pin)return{right:t.is.input,left:!t.is.input};if(t.is.pad)return{right:!t.proxy.is.input,left:t.proxy.is.input};if(t.is.bus)return e.is.pin?{right:!e.is.input,left:e.is.input}:{right:e.proxy.is.input,left:!e.proxy.is.input}},rxtxPinPin(){var o,r;const e=[],t=[],i=this.arrow(this.from,this.to),s=i.right?this.from:this.to,n=i.right?this.to:this.from;n.is.proxy||s.is.proxy?(s.is.proxy?(o=s.pad)==null||o.makeConxList(e):e.push(s),n.is.proxy?(r=n.pad)==null||r.makeConxList(t):t.push(n),this.fullConnect(e,t)):this.singleConnect(s,n)},rxtxPinPad(){var o,r;const e=[],t=[],[i,s]=this.from.is.pin?[this.from,this.to]:[this.to,this.from];i.is.channel&&(s.proxy.is.channel=!0);const n=this.arrow(i,s);n.right&&(i.is.proxy?(o=i.pad)==null||o.makeConxList(e):e.push(i),s.proxy.makeConxList(t),this.fullConnect(e,t)),n.left&&(s.proxy.makeConxList(e),i.is.proxy?(r=i.pad)==null||r.makeConxList(t):t.push(i),this.fullConnect(e,t))},rxtxPinBus(){var o,r;const e=[],t=[],[i,s]=this.from.is.pin?[this.from,this.to]:[this.to,this.from],n=this.arrow(i,s.bus);n.right&&(i.is.proxy?(o=i.pad)==null||o.makeConxList(t):t.push(i),s.bus.hasFilter()?(s.bus.rxtxAddRxTack(s),this.fullConnect(t,[s])):(s.bus.makeConxList(i,e),this.fullConnect(t,e))),n.left&&(i.is.proxy?(r=i.pad)==null||r.makeConxList(e):e.push(i),s.bus.hasFilter()?s.bus.rxtxAddTxTack(s,e):(s.bus.makeConxList(i,t),this.fullConnect(t,e)))},rxtxPadBus(){const e=[],t=[],[i,s]=this.from.is.pad?[this.from,this.to]:[this.to,this.from],n=this.arrow(i,s.bus);n.right&&(i.proxy.makeConxList(t),s.bus.hasFilter()?(s.bus.rxtxAddRxTack(s),this.fullConnect(t,[s])):(s.bus.makeConxList(i,e),this.fullConnect(t,e))),n.left&&(i.proxy.makeConxList(e),s.bus.hasFilter()?s.bus.rxtxAddTxTack(s,e):(s.bus.makeConxList(i,t),this.fullConnect(t,e)))},rxtxPinPinDisconnect(){var o,r;const e=[],t=[],i=this.arrow(this.from,this.to),s=i.right?this.from:this.to,n=i.right?this.to:this.from;s.is.proxy||n.is.proxy?(s.is.proxy?(o=s.pad)==null||o.makeConxList(e):e.push(s),n.is.proxy?(r=n.pad)==null||r.makeConxList(t):t.push(n),this.fullDisconnect(e,t)):s.node.rxtxRemoveFromTxTable(s,n)},rxtxPinPadDisconnect(){var o,r;const e=[],t=[],[i,s]=this.from.is.pin?[this.from,this.to]:[this.to,this.from];if(s.proxy.is.channel){const a=s.routes.find(l=>{if(l!=this){const c=l.from==s?l.to:l.from;if(c.is.pin&&c.is.channel||c.is.pad&&c.proxy.is.channel)return!0}});s.proxy.is.channel=!!a}const n=this.arrow(i,s);n.right&&(i.is.proxy?(o=i.pad)==null||o.makeConxList(e):e.push(i),s.proxy.makeConxList(t),this.fullDisconnect(e,t)),n.left&&(s.proxy.makeConxList(e),i.is.proxy?(r=i.pad)==null||r.makeConxList(t):t.push(i),this.fullDisconnect(e,t))},rxtxPinBusDisconnect(){var o,r;const e=[],t=[],[i,s]=this.from.is.pin?[this.from,this.to]:[this.to,this.from],n=this.arrow(i,s.bus);n.right&&(i.is.proxy?(o=i.pad)==null||o.makeConxList(t):t.push(i),s.bus.hasFilter()?(s.bus.rxtxRemoveRxTack(s),this.fullDisconnect(t,[s])):(s.bus.makeConxList(i,e),this.fullDisconnect(t,e))),n.left&&(s.bus.hasFilter()?s.bus.rxtxRemoveTxTack(s):(s.bus.makeConxList(i,t),i.is.proxy?(r=i.pad)==null||r.makeConxList(e):e.push(i),this.fullDisconnect(t,e)))},rxtxPadBusDisconnect(){const e=[],t=[],[i,s]=this.from.is.pad?[this.from,this.to]:[this.to,this.from],n=this.arrow(i,s.bus);n.right&&(i.proxy.makeConxList(t),s.bus.hasFilter()?(s.bus.rxtxRemoveRxTack(s),this.fullDisconnect(t,[s])):(bus.makeConxList(i,e),this.fullDisconnect(t,e))),n.left&&(s.bus.hasFilter()?s.bus.rxtxRemoveTxTack(s):(s.bus.makeConxList(i,t),i.proxy.makeConxList(e),this.fullDisconnect(t,e)))},singleConnect(e,t){let i=e.node.txTable.find(s=>s.pin.name==e.name);i&&((e.is.multi||t.is.multi)&&!t.hasMultiOverlap(e)||i.targets.push(t))},fullConnect(e,t){for(const i of e)if(i.is.pin){const s=i.node.txTable.find(n=>n.pin.name==i.name);if(!s){console.warn("*** SHOULD NOT HAPPEN *** Could not find txRecord in fullConnect",i.name,i.node.name);continue}for(const n of t)(!(i.is.multi||n.is.multi)||n.hasMultiOverlap(i))&&s.targets.push(n)}else if(i.is.tack){const s=i.bus.txTable.find(n=>n.tack==i);if(!s){console.warn("*** SHOULD NOT HAPPEN *** Could not find txTack in fullConnect",i.bus.name);continue}for(const n of t)s.fanout.push(n)}},fullDisconnect(e,t){for(const i of e)if(i.is.pin){const s=i.node.txTable.find(n=>n.pin.name==i.name);if(!s){console.warning("*** SHOULD NOT HAPPEN *** Could not find txRecord in fullDisconnect",i.name,i.node.name);continue}for(const n of t)s.dropTarget(n)}else if(i.is.tack){const s=i.bus.txTable.find(n=>n.tack==i);if(!s){console.warning("*** SHOULD NOT HAPPEN *** Could not find txTack in fullDisconnect",i.bus.name);continue}for(const n of t)s.dropTarget(n)}}};function vt(e,t){this.from=e,this.to=t,this.is={selected:!1,highLighted:!1,twistedPair:!1,notUsed:!1,newConx:!1,noConx:!1},this.wire=[]}vt.prototype={render(e){if(this.wire.length<2)return;const t=this.is.selected?g.route.cSelected:this.is.highLighted?g.route.cHighLighted:this.is.newConx?g.route.cAdded:this.is.noConx?g.route.cDeleted:this.is.notUsed?g.route.cNotUsed:g.route.cNormal,i=this.is.selected?g.route.wSelected:g.route.wNormal;this.is.twistedPair?W.twistedPair(e,t,i,this.wire):W.drawWire(e,t,i,this.wire)},reverse(){[this.from,this.to]=[this.to,this.from];let e=this.wire,t=e.length;for(let i=0;i<t/2;i++)[e[i],e[t-i-1]]=[e[t-i-1],e[i]]},select(){this.is.selected=!0,this.from&&(this.from.is.selected=!0),this.to&&(this.to.is.selected=!0)},unSelect(){this.is.selected=!1,this.from&&(this.from.is.selected=!1),this.to&&(this.to.is.selected=!1)},highLight(){this.is.highLighted=!0,this.from&&(this.from.is.highLighted=!0),this.to&&(this.to.is.highLighted=!0)},unHighLight(){var e,t,i,s;((t=(e=this.from)==null?void 0:e.node)!=null&&t.is.highLighted||(s=(i=this.to)==null?void 0:i.node)!=null&&s.is.highLighted)&&this.from.node!=this.to.node||(this.is.highLighted=!1,this.from&&(this.from.is.highLighted=!1),this.to&&(this.to.is.highLighted=!1))},setTwistedPair(){this.is.twistedPair=!0},checkTwistedPair(){var t;const e=this.from.is.input?this.to:this.from;e&&(e.is.pin&&e.is.multi?this.is.twistedPair=!0:e.is.pad&&((t=e.proxy)!=null&&t.is.multi)&&(this.is.twistedPair=!0))},typeString(){const e=this.from.is,t=this.to.is;let i=e.pin?"PIN":e.tack?"BUS":e.pad?"PAD":"";return i+=t.pin?"-PIN":t.tack?"-BUS":t.pad?"-PAD":"",i},hitSegment(e){const t=this.wire.length-1,i=e.x,s=e.y,n=5;for(let o=0;o<t;o++){const r=this.wire[o],a=this.wire[o+1];if(r.y==a.y){if(s<r.y+n&&s>r.y-n&&(r.x-i)*(a.x-i)<=0)return o+1}else if(i<r.x+n&&i>r.x-n&&(r.y-s)*(a.y-s)<=0)return o+1}return 0},remove(){this.from.removeRoute(this),this.to.removeRoute(this)},popFromRoute(){this.from.is.tack?this.from.bus.tacks.pop():this.from.routes.pop()},clone(){let e=new vt(this.from,this.to);for(const t of this.wire)e.wire.push({...t});return e},restore(){},copyWire(){const e=[];for(const t of this.wire)e.push({...t});return e},restoreWire(e){this.wire=[];for(const t of e)this.wire.push({...t})},messageFlow(){const e=this.from,t=this.to;return e.is.pin?e.is.input?[t,e]:[e,t]:t.is.pin?t.is.input?[e,t]:[t,e]:e.is.pad?e.proxy.is.input?[e,t]:[t,e]:t.is.pad?t.proxy.is.input?[t,e]:[e,t]:[t,e]}};Object.assign(vt.prototype,af,lf,cf,hf);const df={pinNameCheck(e,t){if(this.is.cable){if(e.is.multi||t.is.multi){if(!e.hasFullNameMatch(t))return!1}else if(e.name!=t.name)return!1}else if((e.is.multi||t.is.multi)&&!e.hasMultiOverlap(t))return!1;return!0},areConnected(e,t){if(e.is.pin){if(t.is.pin)return e.is.input==t.is.input||e.node==t.node?!1:this.pinNameCheck(e,t);if(t.is.pad)return e.is.input!=t.proxy.is.input?!1:this.pinNameCheck(e,t.proxy)}else if(e.is.pad){if(t.is.pin)return e.proxy.is.input!=t.is.input?!1:this.pinNameCheck(e.proxy,t);if(t.is.pad)return e.proxy.is.input==t.proxy.is.input?!1:this.pinNameCheck(e.proxy,t.proxy)}return console.log(e,t),!1},disconnect(){const e=this.tacks.slice();for(const t of e)(t.route.from==t?t.route.to:t.route.from).is.pin?t.route.rxtxPinBusDisconnect():t.route.rxtxPadBusDisconnect(),t.route.remove()},reconnect(e){for(const t of e){this.tacks.push(t),t.orient();const i=t.route.to==t?t.route.from:t.route.to;i.routes.push(t.route),i.is.pin?t.route.rxtxPinBus():t.route.rxtxPadBus()}},makeConxList(e,t){var i,s;for(const n of this.tacks){if(!((i=n.route)!=null&&i.from)||!((s=n.route)!=null&&s.to))continue;const o=n.route.from==n?n.route.to:n.route.from;this.areConnected(e,o)&&(o.is.pin?o.is.proxy?o.pad.makeConxList(t):t.push(o):o.is.pad&&o.proxy.makeConxList(t))}},splitTacks(e,t){this.tacks.forEach((i,s)=>{i.route.from.is.pin&&t.nodes.includes(i.route.from.node)&&(e.tacks.push(i),this.tacks[s]=null,i.bus=e)}),this.tacks=this.tacks.filter(i=>i!=null)},transferTacks(e){for(const t of this.tacks)for(const i of e)if(this.uid==i.uid){t.bus=i;break}},makeRoute(e){const t=dd(this.wire,e.center()),i=t.endPoint?ud(t.point,t.segment,this.wire):t.point,s=new fs(this);s.placeOnSegment(i,t.segment);const n=new vt(e,s);n.builder(),e.routes.push(n),s.restore(n)},rxtxPrepareTables(){},rxtxResetTables(){this.txTable=[],this.rxTable=[]},rxtxBuildRxTxTable(){for(const e of this.tacks)if(e.incoming())this.rxtxAddRxTack(e);else{const t=[],i=e.getOther();i.is.proxy?i.pad.makeConxList(t):i.is.pad?i.proxy.makeConxList(t):t.push(i),this.rxtxAddTxTack(e,t)}},rxtxAddTxTack(e,t){const i=new na(e);i.fanout=t.slice(),this.txTable.push(i)},rxtxRemoveTxTack(e){const t=this.txTable.findIndex(i=>i.tack==e);t>-1&&this.txTable.splice(t,1)},rxtxAddRxTack(e){this.rxTable.push(new yd(e))},rxtxRemoveRxTack(e){const t=this.rxTable.findIndex(i=>i.tack==e);t>-1&&this.rxTable.splice(t,1)}},uf={toJSON(){const e=this.is.cable?{kind:"cable",name:this.name}:{kind:"busbar",name:this.name};return this.is.filter&&this.filter&&(e.filter=this.filter),e.start=k.pointToString(this.wire[0]),e.wire=k.wireToString(this.wire),e},cook(e,t){if(this.is.cable=e.kind=="cable",this.name=e.name,e.filter){const i=t.getMainModel(),s=t.getCurrentModel();this.filter=new qi(e.filter.function),this.is.filter=!0,e.filter.path&&(this.filter.arl=s.arl.resolve(e.filter.path),i!=s&&this.filter.arl.makeRelative(i.arl))}this.wire=k.stringToWire(k.stringToPoint(e.start),null,e.wire),this.wire.length==1&&this.wire.push(this.wire[0]),this.startLabel.place(),this.endLabel.place()}},ff={drawXY(e){const t=this.wire.length,i=this.wire[t-2],s=this.wire[t-1],n=this.is.cable?g.bus.wCable:g.bus.wBusbar,o=this.endLabel.rect.h;let r=null;const a=s.x==i.x,l=s.y==i.y;a&&l?Math.abs(e.x-i.x)<Math.abs(e.y-i.y)?s.y=e.y:s.x=e.x:l?Math.abs(e.y-s.y)>g.bus.split?this.wire.push({x:s.x,y:e.y}):(this.tacks.length&&(r=this.getLimit(t-1))&&(i.x<s.x&&e.x<r.r+n/2&&(e.x=r.r+n/2),i.x>s.x&&e.x>r.l-n/2&&(e.x=r.l-n/2)),s.x=e.x,t>2&&Math.abs(s.x-i.x)<g.bus.tooClose&&this.wire.pop()):a&&(Math.abs(e.x-s.x)>g.bus.split?this.wire.push({x:e.x,y:s.y}):(this.tacks.length&&(r=this.getLimit(t-1))&&(i.y<s.y&&e.y<r.b&&(e.y=r.b),i.y>s.y&&e.y>r.t-o/2&&(e.y=r.t-o/2)),s.y=e.y,t>2&&Math.abs(s.y-i.y)<g.bus.tooClose&&this.wire.pop())),this.startLabel.place(),this.endLabel.place()},resumeDrawXY(e,t,i){e==this.startLabel&&this.reverse();const s=this.wire,n=s[s.length-2],o=s[s.length-1];let r=n.x==o.x&&Math.abs(t.x-n.x)>g.bus.split?t.x:o.x+i.x,a=n.y==o.y&&Math.abs(t.y-n.y)>g.bus.split?t.y:o.y+i.y;this.drawXY({x:r,y:a})},reverse(){[this.startLabel,this.endLabel]=[this.endLabel,this.startLabel];const e=this.wire,t=e.length;for(let i=0;i<t/2;i++)[e[i],e[t-i-1]]=[e[t-i-1],e[i]];this.tacks.forEach(i=>i.segment=t-i.segment)},getLimit(e){let t=null;return this.tacks.forEach(i=>{if(i.segment==e){const s=i.rect;t?(s.x<t.l&&(t.l=s.x),s.x+s.w>t.r&&(t.r=s.x+s.w),s.y<t.t&&(t.t=s.y),s.y+s.h>t.b&&(t.b=s.y+s.h)):t={l:s.x,r:s.x+s.w,t:s.y,b:s.y+s.h}}}),t},move(e,t){for(const i of this.wire)i.x+=e,i.y+=t;this.startLabel.move(e,t),this.endLabel.move(e,t);for(const i of this.tacks)i.rect.x+=e,i.rect.y+=t},drag(e){for(const t of this.wire)t.x+=e.x,t.y+=e.y;this.startLabel.move(e.x,e.y),this.endLabel.move(e.x,e.y);for(const t of this.tacks)t.moveXY(e.x,e.y)},moveRoutes(e,t){this.tacks.forEach(i=>{i.is.tack&&i.route.from==i&&i.route.moveAllPoints(e,t)})},getCombinedLimit(e,t){let i=this.getLimit(e),s=this.getLimit(t);return i&&s&&(s.l<i.l&&(i.l=s.l),s.r>i.r&&(i.r=s.r),s.t<i.t&&(i.t=s.t),s.b>i.b&&(i.b=s.b)),i||s},moveSegment(e,t){let i=this.wire;const s=t.x,n=t.y;let o=this.getCombinedLimit(e-1,e+1),r=i[e-1],a=i[e];if(r.y==a.y){if(o==null||r.y>o.b&&r.y+n>o.b||r.y<o.t&&r.y+n<o.t){r.y+=n,a.y+=n;for(const l of this.tacks)l.segment==e&&l.moveY(n)}}else if(r.x==a.x&&(o==null||r.x>o.r&&r.x+s>o.r||r.x<o.l&&r.x+s<o.l)){r.x+=s,a.x+=s;for(const l of this.tacks)l.segment==e&&l.moveX(s)}e==1&&this.startLabel.place(),e==i.length-1&&this.endLabel.place()},placeTacks(e,t,i){for(const s of this.tacks)s.orient()},removeTwoPoints(e){const t=this.wire,i=t.length;for(let s=e;s<i-2;s++)t[s]=t[s+2];t.pop(),t.pop(),this.tacks.forEach(s=>{s.segment>e&&(s.segment-=2)})},fuseSegment(e){let t=this.wire;if(t.length<3)return;const i=g.bus.tooClose;t[e-1].y==t[e].y?e<t.length-2&&Math.abs(t[e+1].y-t[e].y)<i?(t[e-1].y=t[e+1].y,this.removeTwoPoints(e)):e>1&&Math.abs(t[e-2].y-t[e-1].y)<i&&(t[e].y=t[e-2].y,this.removeTwoPoints(e-2)):t[e-1].x==t[e].x&&(e<t.length-2&&Math.abs(t[e+1].x-t[e].x)<i?(t[e-1].x=t[e+1].x,this.removeTwoPoints(e)):e>1&&Math.abs(t[e-2].x-t[e-1].x)<i&&(t[e].x=t[e-2].x,this.removeTwoPoints(e-2))),this.startLabel.place(),this.endLabel.place()},adjustRoutes(){for(const e of this.tacks)e.route.adjust()},closestTack(e){},straightConnections(){for(const e of this.tacks){const t=e.route,i=t.to==e?t.from:t.to;let s=this.wire[e.segment-1],n=this.wire[e.segment];if(s.x==n.x&&([s,n]=s.y>n.y?[n,s]:[s,n],i.rect.y>s.y&&i.rect.y<n.y)){e.rect.y=i.rect.y+i.rect.h/2-e.rect.h/2;for(const o of t.wire)o.y=i.rect.y+i.rect.h/2}}}};function ks(e,t,i=null){this.uid=i,this.name=e??"",this.widGenerator=0,this.is={bus:!0,selected:!1,hoverOk:!1,hoverNok:!1,highLighted:!1,cable:!1,filter:!1},this.filter=null,this.rxTable=[],this.txTable=[],this.wire=[],this.wire.push({x:t.x,y:t.y}),this.wire.push({x:t.x,y:t.y});const s=g.bus.hLabel,n=0;this.startLabel=new $n({x:0,y:0,w:n,h:s},this),this.endLabel=new $n({x:0,y:0,w:n,h:s},this),this.startLabel.place(),this.endLabel.place(),this.tacks=[]}ks.prototype={render(e){if(this.wire.length<2)return;const t=g.bus,i=this.is.hoverNok?t.cBad:this.is.selected||this.is.hoverOk?t.cSelected:this.is.highLighted?t.cHighLighted:t.cNormal;this.is.cable?W.drawCable(e,this.wire,i,t.wCable):W.drawBusbar(e,this.wire,i,t.wBusbar),this.startLabel.render(e),this.endLabel.render(e),this.tacks.forEach(s=>s.render(e))},generateWid(){return++this.widGenerator},highLight(){this.is.highLighted=!0,this.startLabel.highLight(),this.endLabel.highLight();for(const e of this.tacks)e.route.highLight()},unHighLight(){this.is.highLighted=!1,this.startLabel.unHighLight(),this.endLabel.unHighLight();for(const e of this.tacks)e.route.unHighLight()},highLightRoutes(e){this.is.highLighted=!0;for(const t of this.tacks){const i=t.route.from==t?t.route.to:t.route.from;i!==e&&this.areConnected(e,i)&&t.route.highLight()}},unHighLightRoutes(e){this.is.highLighted=!1;for(const t of this.tacks){const i=t.route.from==t?t.route.to:t.route.from;i!==e&&this.areConnected(e,i)&&t.route.unHighLight()}},hitTest(e){let t=st(e,this.startLabel.rect)?this.startLabel:st(e,this.endLabel.rect)?this.endLabel:null;if(t)return[A.busLabel,this,t,null,0];let i=this.hitSegment(e);if(i)return[A.busSegment,this,null,null,i];for(const s of this.tacks)if(st(e,s.rect))return[A.tack,this,null,s,0];return[A.nothing,null,null,null,0]},hitSegment(e){const t=this.wire.length,i=e.x,s=e.y;for(let n=0;n<t-1;n++){const o=this.wire[n],r=this.wire[n+1],a=5;if(o.y==r.y){if(s>o.y-a&&s<o.y+a&&(i>=o.x&&i<=r.x||i>=r.x&&i<=o.x))return n+1}else if(i>o.x-a&&i<o.x+a&&(s>=o.y&&s<=r.y||s>=r.y&&s<=o.y))return n+1}return 0},singleSegment(){return this.wire.length===2},hitRoute(e){let t=0;for(const i of this.tacks)if(i.route.from==i&&(t=i.route.hitSegment(e)))return[A.route,i.route,t];return[A.nothing,null,0]},overlap(e){var t;return((t=ld(this.wire,e))==null?void 0:t.length)>0},findTack(e){return this.tacks.find(t=>t.route.from==e||t.route.to==e)},removeTack(e){Re(this.tacks,e)},addTack(e){const t=e.to==null?e.from:e.to;if(this.findTack(t))return null;const i=new fs(this);return i.setRoute(e),this.tacks.push(i),i},newTack(){const e=new fs(this);return this.tacks.push(e),e},copy(){const e=new ks(this.name,this.wire[0],this.uid);return e.is.cable=this.is.cable,e.wire=this.copyWire(),e.startLabel.place(),e.endLabel.place(),e},copyTacks(e,t){for(const i of this.tacks){const s=i.route.clone(),n=new fs(e);s.to.is.tack?s.to=n:s.from=n,n.setRoute(s);const o=s.to.is.tack?s.from:s.to;if(o.is.pin){const a=t.nodes.find(l=>l.uid==o.node.uid).look.findPin(o.name,o.is.input);s.to.is.tack?s.from=a:s.to=a,a.routes.push(s)}else if(o.is.pad){const r=t.pads.find(a=>a.proxy.name==o.proxy.name);s.to.is.tack?s.from=r:s.to=r,r.routes.push(s)}e.tacks.push(n)}},copyWire(){const e=[];for(const t of this.wire)e.push({...t});return e},restoreWire(e){this.wire=[];for(const t of e)this.wire.push({...t})},copyTackWires(){const e=[];for(const t of this.tacks){const i=t.route.copyWire();e.push({segment:t.segment,track:i})}return e},restoreTackWires(e){const t=this.tacks,i=t.length;for(let s=0;s<i;s++)t[s].segment=e[s].segment,t[s].route.restoreWire(e[s].track)},hasFilter(){return this.is.filter},getFilterArl(e,t,i){var s;return(s=t==null?void 0:t.model)!=null&&s.is.lib?t.model.arl:e?e.arl:this.filter.arl?this.filter.arl:t!=null&&t.model?t.model.arl.resolve("index.js"):i},getFilter(e,t,i){const s=this.getFilterArl(t,i,e[0].arl),n=this.filter.duplicate(e,s)?`${this.filter.fName} as ${this.filter.alias}`:this.filter.fName,o=e.find(r=>r.arl.equals(s));o?o.items.find(a=>a==n)||o.items.push(n):e.push({arl:s,items:[n]})}};Object.assign(ks.prototype,df,uf,ff);function fa(){this.map=new Map}fa.prototype={reset(){this.map.clear()},size(){return this.map.size},addRawFactories(e){for(const t of e.raw.factories){const i=e.arl.resolve(t),s=i.getFullPath();if(this.map.has(s))continue;const n=new qi;n.arl=i,this.map.set(s,n)}},add(e){const t=e.arl.getFullPath();if(!this.map.get(t))return this.map.set(t,e),this},toJSON(){const e=[];for(const t of this.map.values())e.push(t.arl.userPath);return e}};const pf={async getRoot(e){return await this.getFactoriesAndModels(e),this.compileNode(e,null)},encode(e,t){var n,o,r;if(!e)return null;e.collectFactories(this.factories),e.collectModels(this.models);const i={header:t.header};return((n=this.models)==null?void 0:n.size())>0&&(i.imports=this.models),((o=this.factories)==null?void 0:o.size())>0&&(i.factories=this.factories),((r=t.libraries)==null?void 0:r.size())>0&&(i.libraries=t.libraries),i.root=e,JSON.stringify(i,null,4)},compileNode(e,t){var n;if(!e)return console.log(`No model for node '${t}' `),null;const i=t?e.findRawNode(t):(n=e.raw)==null?void 0:n.root;if(!i)return console.log(`Node '${t}' not found in model ${e.arl.userPath}`),null;if(!this.pushCurrentNode(e,i))return console.log(`infinite loop for  '${t}' in model ${e.arl.userPath} `),null;const s=i.kind=="dock"?this.linkedNode(i):this.localNode(i);return this.popCurrentNode(),s},localNode(e){const t=e.kind=="source"?new gi(null,e.name):new Rt(null,e.name);return t.cook(e,this),t.setUIDS(this.UID),t},linkedNode(e){const[t,i]=[e.link.path,e.link.node],s=this.getCurrentModel(),n=t==null||t==="./"?s:this.models.get(s.arl.resolve(t).getFullPath()),o=this.compileNode(n,i),r=o?this.goodLink(e,i,n,o):this.badLink(e,i,n);return r.setUIDS(this.UID),r},goodLink(e,t,i,s){const n=s.is.source?new gi(null,e.name):new Rt(null,e.name);return n.cook(e,this),n.setLink(i,t),n.fuse(s),n},badLink(e,t,i){const s=new gi(null,e.name);return s.cook(e,this),s.setLink(i,t),s.linkIsBad(),s},updateNode(e){if(!(e.link&&e.link.is.bad)){if(e.link&&e.link.model.is.fresh){const t=this.compileNode(e.link.model,e.link.lName);if(!t){e.linkIsBad();return}if(!e.compatible(t)){const i=e.switchNodeType();this.view.root.swap(e,i),e=i}e.fuse(t),e.rxtxBuildTxTable();return}if(e.nodes)for(const t of e.nodes)this.updateNode(t)}}};function bi(e){this.models=new io,this.factories=new fa,this.stack=[],this.UID=e}bi.prototype={reset(){this.factories.reset(),this.models.reset(),this.stack.length=0},resetFresh(){for(const e of this.models.map.values())e.is.fresh=!1},pushCurrentNode(e,t){const i=t.source??t.group??t.dock,s=this.stack.length;if(s>1){for(let n=0;n<s-1;n++)if(this.stack[n].nodeName===i&&this.stack[n].model===e)return console.log(i,e.arl.userPath),!1}return this.stack.push({model:e,nodeName:i}),!0},popCurrentNode(){this.stack.pop()},getCurrentModel(){return this.stack.at(-1).model},getMainModel(){return this.stack[0].model},async getFactoriesAndModels(e){var t,i;if(!this.models.contains(e.arl)&&(this.models.add(e),!(!e.raw&&!await e.getRaw())&&e.is.blu)){if(((t=e.raw.factories)==null?void 0:t.length)>0&&this.factories.addRawFactories(e),e.is.main&&e.raw.libraries&&e.addRawLibraries(e.arl,e.raw.libraries),!(((i=e.raw.imports)==null?void 0:i.length)>0))return;const s=this.models.newModels(e.arl,e.raw.imports);if(s.length>0){const n=[];for(const o of s)n.push(this.getFactoriesAndModels(o));await Promise.all(n)}}},async findOrAddModel(e){let t=this.models.findArl(e);return t||(t=new Nt(e),t.makeKey(),await this.getFactoriesAndModels(t),t)},async updateFactoriesAndModels(){const e=this.models.valuesArray();this.models.reset();const t=[];for(const i of e){if(i.is.main||this.models.contains(i.arl))continue;const s=i.header.utc;await i.getRaw(),i.raw&&(s!==i.header.utc?(console.log(`-SYNC- newer version of '${i.arl.userPath}'`),t.push(this.getFactoriesAndModels(i))):(this.models.add(i),i.is.fresh=!1))}await Promise.all(t)}};Object.assign(bi.prototype,pf);function pa(e,t){this.tx=e,this.ref=null,this.libraries=null}pa.prototype={onSwitchLibrary({ref:e,libraries:t}){!t||!e||(this.ref=e,this.libraries=t,this.tx.send("build table",this.libraries.map))},async onAddFile(e){if(!this.ref)return;const t=this.ref.resolve(e);if(!t)return console.log(`Could not resolve "${e}" to arl`);let i=this.libraries.findArl(t);i||(i=new Nt(t),await i.getRaw(),this.libraries.add(i)),i.setSelectable(),this.tx.send("build table",this.libraries.map)},onRemoveFile({model:e}){e&&(e.is.selectable=!1,this.tx.send("build table",this.libraries.map))}};function ga(e,t){this.tx=e,this.local=!1,this.origin=null,this.selection=null,this.copyCount=0}ga.prototype={resetContent(){this.local=!1,this.origin=null,this.selection=null,this.copyCount=0},sends:["switch","remote","local"],onSet({model:e,selection:t}){!e||!t||(this.resetContent(),this.local=!0,this.origin=e.copy(),this.selection=t.shallowCopy(),this.tx.send("switch"))},onGet(e){if(this.local){this.tx.reply(this);return}this.tx.request("remote").then(async({json:t})=>{const i=JSON.parse(t);i&&(await this.cook(i,e.savecom),this.tx.reply(this))})},onSwitched(){this.local=!1},onLocal(e){if(!this.local){console.log("Warning: clipboard is not local !");return}const t={origin:this.origin.arl.getFullPath(),header:this.origin.header,what:this.selection.what,rect:this.selection.rect?k.rectToString(this.selection.rect):null,viewPath:this.selection.viewPath,imports:null,factories:null,root:null,widgets:null};switch(this.selection.what){case H.pinArea:t.widgets=this.selection.widgets;break;case H.freeRect:case H.multiNode:case H.singleNode:{const s=e.savecom;s.reset(),t.root=new Rt(null,"clipboard",null),t.root.nodes=this.selection.nodes.slice(),t.root.buses=this.selection.buses.slice(),t.root.pads=this.selection.pads.slice(),t.root.collectFactories(s.factories),t.factories=s.factories,t.root.collectModels(s.models),t.imports=s.models}break;default:console.log(`unrecognized ${this.what} in clipboard.js`);break}const i=JSON.stringify(t,null,4);this.tx.reply({json:i})},async cook(e,t){var s,n,o;if(!e.origin)return!1;this.resetContent();const i=new Gt().absolute(e.origin);switch(this.origin=new Nt(i),this.origin.raw=e,e.header&&this.origin.header.cook(i,e.header),this.selection=new xs,this.selection.viewPath=e.viewPath,e.rect&&(this.selection.rect=k.stringToRect(e.rect)),this.selection.what=+e.what,this.selection.what){case H.freeRect:case H.multiNode:case H.singleNode:{t.reset();const r=await t.getRoot(this.origin);if(!r)return!1;this.selection.nodes=(s=r.nodes)==null?void 0:s.slice(),this.selection.pads=(n=r.pads)==null?void 0:n.slice(),this.selection.buses=(o=r.buses)==null?void 0:o.slice()}return!0;case H.pinArea:{const r=new mt({x:0,y:0,w:0,h:0}),a=new Rt(r);for(const l of e.widgets){const c=r.cookWidget(a,l);c&&this.selection.widgets.push(c)}}return!0;default:return!1}}};const gf={onSetDocument(e){if(!e){this.doc=null,this.redraw();return}e.view.noRect()&&e.view.setRect(0,0,this.canvas.width,this.canvas.height),this.doc=e,this.tx.send("change library",{ref:e.model.arl,libraries:e.model.libraries}),this.setStyle(),this.redraw()},onGetDocument(){this.tx.send("reply document",this.doc)},onShowSettings(){var s,n;if(!((s=this.doc)!=null&&s.model))return;const e=this.doc.model.header,t=()=>this.redraw(),i=e.style.rgb;this.tx.send("document settings",{title:"Document Settings",path:((n=this.doc.model.arl)==null?void 0:n.getFullPath())??"- unspecified -",settings:e,pos:{x:25,y:25},onColor(o){e.style.adapt(o),t()},ok(o){e.runtime=o},cancel(){e.style.adapt(i),t()}})},onSyncModel(){var e;(e=this.doc)==null||e.update().then(()=>{this.redraw()})},onRecalibrate(){var e;(e=this.doc)==null||e.view.toggleTransform(),this.redraw()},onGridOnOff(){var t,i;const e=(i=(t=this.doc)==null?void 0:t.view)==null?void 0:i.state;e&&(e.grid=!e.grid),this.redraw()},onAcceptChanges(){this.doc&&(this.doc.view.root.acceptChanges(),this.redraw())},onSizeChange(e){var t,i;e&&(this.canvas.width=e.w,this.canvas.height=e.h,this.canvas.style.width=e.w+"px",this.canvas.style.height=e.h+"px",this.ctx=this.canvas.getContext("2d"),this.setStyle(),this.doc&&((t=this.doc.view)==null||t.setRect(0,0,e.w,e.h),(i=this.doc.view)==null||i.redoBigRecursive()),this.redraw())},onMakeLib(e){var n,o;const t=this.doc;if(!((n=t==null?void 0:t.view)!=null&&n.root))return;const i={x:e.screenX,y:e.screenY},s=((o=t.target.library)==null?void 0:o.userPath)??Bs(t.model.arl.userPath)+"-lib.js";this.tx.send("show lib path",{title:"Make library build file...",entry:s,pos:i,ok:r=>t.toJavascriptLib(r),cancel:()=>{}})},onMakeApp(e){var n,o;const t=this.doc;if(!((n=t==null?void 0:t.view)!=null&&n.root))return;const i={x:e.screenX,y:e.screenY},s=((o=t.target.library)==null?void 0:o.userPath)??Bs(t.model.arl.userPath)+".app.js";this.tx.send("show app path",{title:"Make application...",path:s,pos:i,ok:r=>t.toJavascriptApp(r),cancel:()=>{}})},onRunApp(){const e=this.doc.toJavascriptApp(null);this.tx.send("run",{mode:"page",js:e.srcArl,html:e.htmlArl})},onRunAppInIframe(){const e=this.doc.toJavascriptApp(null);this.tx.send("run",{mode:"iframe",js:e.srcArl,html:e.htmlArl}),this.iframe||(this.iframe=document.createElement("iframe"),this.tx.send("iframe",this.iframe)),this.iframe.src=e.htmlArl.url},onPinProfile({}){},async onSelectedNode({model:e,nodePath:t,xyLocal:i}){const s=await this.doc.nodeFromLibrary(e,t);s&&(s.look.moveTo(i.x,i.y),this.doEdit("nodeFromNodeLib",{view:this.doc.focus,node:s}))},onSavePointSet({}){var t;if(!((t=this.doc)!=null&&t.model))return;const e=this.doc;this.tx.send("save point.confirm",{title:"Confirm to set a new save point",message:"",pos:{x:500,y:100},ok:()=>{const i=e.getNodeToSave();if(!i)return;const s=new bi(e.UID);e.model.raw=JSON.parse(s.encode(i,e.model))},cancel:()=>{}})},onSavePointBack({}){var i;if(!((i=this.doc)!=null&&i.model))return;const e=this,t=this.doc;this.tx.send("save point confirm",{title:"Confirm to go back to the previous save point",message:"",pos:{x:500,y:100},ok:async()=>{t.reCompile(),t.undoStack.reset(),e.redraw();try{const s=JSON.stringify(t.model.raw,null,4);s&&t.model.arl.save(s)}catch(s){console.log(`JSON stringify error: ${s}
in 'on save point.back'`)}},cancel:()=>{}})}},mf={doEdit(e,t){Ws[e].doit(t),this.redraw()},saveEdit(e,t){this.doc.undoStack.push({verb:e,param:t}),this.tx.send("new edit",{verb:e}),this.doc.model.is.dirty=!0},signalEdit(e){this.tx.send("new edit",{verb:e})},send(e,t){this.tx.send(e,t)},getParam(){var e;return((e=this.doc.undoStack.last())==null?void 0:e.param)??{}},getVerb(){var e;return(e=this.doc.undoStack.last())==null?void 0:e.verb},undoLastEdit(){const e=this.doc.undoStack.back();console.log("undo ",e?e.verb:"-nothing-"),e&&Ws[e.verb].undo(e.param)},redoLastEdit(){const e=this.doc.undoStack.forward();console.log("redo ",e?e.verb:"-nothing-"),e&&Ws[e.verb].redo(e.param)},dropLastEdit(){this.doc.undoStack.back()}};let u;function vf(e,t){return u=new so,u.tx=e,u.sx=t,u.setup(),e.send("canvas",u.canvas),u}const rt={nothing:0,viewResize:1,viewDrag:2,hoverBorder:3};function so(){this.canvas=null,this.ctx=null,this.doc=null,this.state={view:null,widget:null,action:rt.nothing},this.tx=null,this.sx=null,this.waitingForFrame=!1}so.prototype={setup(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("tabindex","0"),this.canvas.style.outline="none",this.ctx=this.canvas.getContext("2d"),this.setStyle(),this.addEventHandlers(),this.clear()},getCanvasContext(){return this.ctx},addEventHandlers(){document.addEventListener("keydown",e=>this.onKeydown(e)),document.addEventListener("keyup",e=>this.onKeyup(e)),this.canvas.addEventListener("mousedown",e=>this.onMouseDown(e)),this.canvas.addEventListener("mouseup",e=>this.onMouseUp(e)),this.canvas.addEventListener("mousemove",e=>this.onMouseMove(e)),this.canvas.addEventListener("mousewheel",e=>this.onWheel(e)),this.canvas.addEventListener("contextmenu",e=>this.onContextMenu(e)),this.canvas.addEventListener("click",e=>this.onClick(e)),this.canvas.addEventListener("dblclick",e=>this.onDblClick(e)),this.canvas.addEventListener("dragover",e=>this.onDragOver(e)),this.canvas.addEventListener("drop",e=>this.onDrop(e))},clear(){this.ctx.fillStyle=g.std.cBackground,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},switchView(e){var i;if(!e)return;const t=this.doc;e!=t.focus&&(t.focus.unHighLight(),t.focus=e,t.focus.highLight(),(i=t.focus.parent)==null||i.viewToFront(t.focus))},setStyle(){var i;this.doc&&g.switch((i=this.doc.model.header)==null?void 0:i.style);const e=this.ctx,t=g.std;e.font=t.font,e.strokeStyle=t.cLine,e.fillStyle=t.cFill,e.lineCap=t.lineCap,e.lineJoin=t.lineJoin,e.lineWidth=t.lineWidth},redraw(){this.waitingForFrame||(this.waitingForFrame=!0,window.requestAnimationFrame(()=>{var e;this.clear(),(e=this.doc)==null||e.view.render(this.ctx),this.waitingForFrame=!1}))},changeCursor(e){u.canvas.style.cursor=e},xxdeltaForPaste(e,t){var n,o;const i=t.selection,s=i.rect?i.rect:((n=i.nodes)==null?void 0:n.length)>0?i.nodes[0].look.rect:((o=i.pads)==null?void 0:o.length)>0?i.pads[0].rect:{x:0,y:0};return t.copyCount++,s.x==e.x&&s.y==e.y?{x:t.copyCount*g.look.dxCopy,y:t.copyCount*g.look.dyCopy}:{x:e.x-s.x+(t.copyCount-1)*g.look.dxCopy,y:e.y-s.y+(t.copyCount-1)*g.look.dyCopy}},xxxdeltaForPaste(e,t){const i=t.rect?t.rect:t.root.nodes.length>0?t.root.nodes[0].look.rect:t.root.pads.length>0?t.root.pads[0].rect:{x:0,y:0};return t.copyCount++,i.x==e.x&&i.y==e.y?{x:t.copyCount*g.look.dxCopy,y:t.copyCount*g.look.dyCopy}:{x:e.x-i.x+(t.copyCount-1)*g.look.dxCopy,y:e.y-i.y+(t.copyCount-1)*g.look.dyCopy}},textToExternalClipboard(e){const t=new Blob([e],{type:"text/plain"}),i=[new ClipboardItem({"text/plain":t})];navigator.clipboard.write(i)}};Object.assign(so.prototype,fd,pd,gf,mf);function Vn(e,t){this.variant=e,this.pin=t,this.actualTargets=[]}Vn.prototype={};function si(e,t){this.variant=e,this.target=t}si.prototype={toString(){return this.target.is.pin?`${this.variant} @ ${this.target.node.name} (${this.target.node.uid})`:this.target.is.pad?`${this.variant} @ ${this.target.proxy.node.name} (${this.target.proxy.node.uid})`:this.target.is.tack?`${this.variant} @ ${this.target.bus.name} (${this.target.bus.uid})`:"- unknown -"}};const wf={toJavascriptApp(e){var a;if(!e)return;((a=this.target.application)==null?void 0:a.userPath)!==e&&(this.target.application=this.resolve(e));const t=this.target.application,i=this.resolve("index.js"),s=this.model.header.runtime??"@vizualmodel/vmblu-runtime",n=this.makeJSApp(this.view.root,t,i,s);t.save(n);const o=this.model.makeMcpToolString(this.view.root);o&&t.resolve(Bs(this.model.arl.userPath)+"-mcp.js").save(o);const r=this.resolve(ao(e,"html"));return{srcArl:t,htmlArl:r}},makeJSApp(e,t,i,s){var v;const n=[];n.push({arl:i,items:[]}),e.collectImports(n);const o=new Date;let r=`// ------------------------------------------------------------------
// Model: ${e.name}
// Path: ${((v=t.url)==null?void 0:v.pathname)||t.userPath}
// Creation date ${o.toLocaleString()}
// ------------------------------------------------------------------
`,a=`
//Imports`+this.JSImportExportString(n,`
import `,t);const l=[],c=[];e.makeSourceLists(l,c);let h=`//The runtime nodes
const nodeList = [`;for(const w of l)h+=this.JSSourceNode(w);h+=`
]`;let f=`//The filters
const filterList = [`;for(const w of c)f+=this.JSFilter(w);f+=`
]`;const m=`
// import the runtime code
import * as VMBLU from "${s}"

${a}

${h}

${f}

// prepare the runtime
const runtime = VMBLU.scaffold(nodeList, filterList)

// and start the app
runtime.start()
`;return r+m},JSImportExportString(e,t,i){let s="";const n=`,
		 `;return e.forEach(o=>{o.items.length<1||(s+=t+"{ ",o.items.length>0&&(o.items.forEach(r=>{s+=r+n}),s=s.slice(0,-n.length)),s+=` } from '${zn(o.arl.getFullPath(),i.getFullPath())}'`)}),s},JSSourceNode(e){const t=l=>{const h=l.is.input?l.is.channel?"=>":"->":l.is.channel?"<=":"<-";if(l.is.multi){let f="";for(const m of l.expandMultis())f+=`
		"${h} ${m}",`;return f}else return`
		"${h} ${l.name}",`},i=(l,c)=>{const h=JSON.stringify(l,null,4);return(h==null?void 0:h.length)>0?`,
	`+c+":	"+h.replaceAll(`
`,`
		`):""};let o=`${`
	//____________________________________________________________`.slice(0,-e.name.length)+e.name.toUpperCase()}
	{
	name: "${e.name}", 
	uid: "${e.uid}", 
	factory: ${e.factory.alias??e.factory.fName},`;o+=`
	inputs: [`;let r="";for(const l of e.rxTable)r+=t(l.pin);r.length>0&&(r=r.slice(0,-1)),o+=r.length>0?r+`
		],`:"],",o+=`
	outputs: [`;let a="";for(const l of e.txTable){const c=this.makeOutputTable(l);a+=this.stringifyOutputTable(c)}return a.length>0&&(a=a.slice(0,-1)),o+=a.length>0?a+`
		]`:"]",e.sx&&(o+=i(e.sx,"sx")),e.dx&&(o+=i(e.dx,"dx")),o+`
	},`},makeOutputTable(e){const t=[],i=e.pin.is.multi?k.expandMultis(e.pin.name):[e.pin.name];for(const s of i){const n=new Vn(s,e.pin);for(const o of e.targets){const r=this.getActualTarget(e.pin,s,o);r&&n.actualTargets.push(r)}t.push(n)}return t},stringifyOutputTable(e){let t="";for(const i of e){const n=i.pin.is.channel?"=>":"->";if(i.actualTargets.length==0)t+=`
		"${i.variant} ${n} ()",`;else if(i.actualTargets.length==1)t+=`
		"${i.variant} ${n} ${i.actualTargets[0].toString()}",`;else{let o=`
		\`${i.variant} ${n} [ `;for(const r of i.actualTargets)o+=`
			"${r.toString()}",`;o=o.slice(0,-1)+" ]`,",t+=o}}return t},JSFilter(e){let s=`${`
	//_____________________________________________________`.slice(0,-e.name.length)+e.name.toUpperCase()+" FILTER"}
	{
	name: "${e.name}", 
	uid: "${e.uid}", 
	filter: ${e.filter.alias??e.filter.fName},`;s+=`
	table: [`;const n=this.makeFilterTable(e),o=`
		`;for(const r of n){s+="\n		`"+r.variant+" : [";let a="";for(const l of r.actualTargets)a+=o+'	"'+l.toString()+'",';s+=a.slice(0,-1)+" ]`,"}return s+`]
	},`},makeFilterTable(e){const t=[];for(const i of e.rxTable){const s=i.tack.getOtherPin(),n=s.is.multi?k.expandMultis(s.name):[s.name];for(const o of n){if(t.find(a=>a.variant==o))continue;const r=new Vn(o,null);for(const a of e.txTable)if(a.connectsTo(o))for(const l of a.fanout){const c=this.getActualTarget(s,o,l);c&&r.actualTargets.push(c)}r.actualTargets.length>0&&t.push(r)}}return t},getActualTarget(e,t,i){if(i.is.pin)if(i.is.multi){const s=i.getMatch(t);return s?new si(s,i):null}else return e.is.multi?e.getMatch(i.name)==t?new si(i.name,i):null:new si(i.name,i);else if(i.is.tack){const s=i.getOtherPin();if(s.is.multi){const n=s.getMatch(t);return n?new si(n,i):null}else return e.is.multi?e.getMatch(s.name)==t?new si(s.name,i):null:new si(s.name,i)}},saveHtmlPage(e,t,i){const s=t.url.pathname,n=ao(s,"css"),o=`<!doctype html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width'>
    <title>${e.name}</title>
    <link rel='icon' type='image/png' href='/page/shared/favicon.ico'>
    <link rel='stylesheet' href='${n}'> 
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script type='module' src='${s}'><\/script>
</head>
<body style="overflow:hidden;"></body>
</html>`;i.save(o)},NOT_OK_makeAppScript(e,t){let i=[];return i.push({arl:t,items:[]}),e.collectImports(i),this.makeAppPage(e,i)}},yf={toJavascriptLib(e){var n;if(!e)return;((n=this.target.library)==null?void 0:n.userPath)!==e&&(this.target.library=this.resolve(e));const t=this.target.library,i=this.resolve("index.js"),s=this.makeJSLib(this.view.root,this.model.arl,t,i);t.save(s)},makeJSLib(e,t,i,s){let n=[];n.push({arl:s,items:[]}),e.collectImports(n);const o=k.nodeToFactory($s(i.userPath)),r=new Date,a=`// ------------------------------------------------------------------
// Lib: ${o}
// Model File: ${t.userPath}
// Lib   File: ${i.userPath}
// Creation date ${r.toLocaleString()}
// ------------------------------------------------------------------`,l=`

//Export`+this.JSImportExportString(n,`
export `,i),c="./"+Ua(t.userPath),h=`

// The model
import ${o} from '${c}'
export {${o}}`;return a+l+h}},xf={async importFromModel(e,t,i){if(t.length==0||i.length==0)return;const s=this.model.arl.resolve(i),n=await this.modcom.findOrAddModel(s);if(e.setLink(n,t),!n){console.log(`importFromModel failed. Model not found - check the file (${i}) of the node to link to`);return}const o=this.modcom.compileNode(n,t);if(o)e.linkIsGood();else{console.log(`importFromModel failed. Could not compile '${t}' from file '${i}' (check if there is such a node in the model)`),e.linkIsBad();return}if(!e.compatible(o)){const r=e.switchNodeType();this.view.root.swap(e,r),e=r}e.fuse(o)},encode(e,t){var n,o,r;if(!e)return null;e.collectFactories(this.factories),e.collectModels(this.models);const i={header:t.header};return((n=this.models)==null?void 0:n.size())>0&&(i.imports=this.models),((o=this.factories)==null?void 0:o.size())>0&&(i.factories=this.factories),((r=t.libraries)==null?void 0:r.size())>0&&(i.libraries=t.libraries),i.root=e,JSON.stringify(i,null,4)},async exportToModel(e,t,i){var a,l;if(e.link)return;const s=new bi(this.UID),n=e.copy();if(n.name=t,n.nodes)for(const c of n.nodes)c.adjustUserPaths(i.arl);n.collectFactories(s.factories),n.collectModels(s.models);const o={header:i.header};((a=s.models)==null?void 0:a.size())>0&&(o.imports=s.models),((l=s.factories)==null?void 0:l.size())>0&&(o.factories=s.factories),o.root=n;const r=JSON.stringify(o,null,4);await this.model.arl.save(r),e.setLink(i,t),e.is.group&&e.savedView&&e.savedView.closeView()},async nodeFromLibrary(e,t){if(t.length==0||!e)return null;const i=await this.modcom.findOrAddModel(e.arl);if(!i)return null;const s=this.modcom.compileNode(i,t);return s?(s.setLink(i,t),s):null},makeLocalLink(e,t){if(t.length==0)return;const i=this.view.root.findNode(t);if(!i){e.setLink(null,t),console.log(`Local link failed. Check the name (${t}) of the node to link to`),e.linkIsBad();return}const s=i.copy();if(s.uidChangeAll(this.UID),e.setLink(this.model,t),e.linkIsGood(),!e.compatible(s)){const n=e.switchNodeType();this.view.root.swap(e,n),e=n}e.fuse(s)}};function ma(){this.uidmap=new Map,this.uidLength=4}ma.prototype={reset(){this.uidmap.clear()},_freshUID(){let e=0;for(;e<10;){let t=ad(this.uidLength);if(!this.uidmap.has(t))return t;e++,console.log("*** THERE WAS A DUPLICATE *** (can happen, nothing to worry about)"),e>4&&this.uidLength++}return console.eror("*** FAILED TO MAKE A UNIQUE UID ***"),"????"},generate(e){e.uid=this._freshUID(),this.uidmap.set(e.uid,e)}};function ps(e=null){this.view=new bs({x:0,y:0,h:0,w:0}),this.focus=this.view,this.model=e?new Nt(e):null,this.model.is.main=!0,this.UID=new ma,this.modcom=new bi(this.UID),this.savecom=new bi(this.UID),this.target={application:null,library:null},this.undoStack=new Zr(31)}ps.prototype={resolve(e){var t,i;return(i=(t=this.model)==null?void 0:t.arl)==null?void 0:i.resolve(e)},async load(){var t;if(!this.model)return;this.modcom.reset(),this.UID.reset();const e=await this.modcom.getRoot(this.model);e?this.view.syncRoot(e):(this.view.initRoot($s(this.model.arl.userPath)),console.warn(`Empty root for ${this.model.arl.userPath} -  ok for empty file`)),(t=this.model.libraries)==null||t.load()},reCompile(){this.UID.reset();const e=this.modcom.compileNode(this.model,null);e?this.view.syncRoot(e):(this.view.initRoot($s(this.model.arl.userPath)),console.warn(`Empty root for ${this.model.arl.userPath} -  ok for empty file`))},async save(){if(!this.model)return null;this.savecom.reset();const e=this.getNodeToSave();if(!e)return;const t=this.savecom.encode(e,this.model);return this.model.raw=JSON.parse(t),this.model.is.dirty=!1,this.model.arl.save(t)},async saveAs(e){if(ja(e)||(e+=".vmblu"),za(e)){const t=zn(e,this.model.arl.url);console.log(`${t} ${e} ${this.model.arl.url}`),this.model.arl.url=e,this.model.arl.userPath=t}else{const t=this.model.arl.resolve(e);if(!t)return console.log(`Invalid path: "${e}" in Document.saveAs`),null;this.model.arl=t}return this.save()},async update(){var e;!this.model||!((e=this.view)!=null&&e.root)||(this.model.is.dirty&&(this.model.raw=JSON.parse(this.modcom.encode(this.view.root,this.model)),this.model.is.fresh=!0),await this.modcom.updateFactoriesAndModels(),this.modcom.updateNode(this.view.root),this.modcom.resetFresh())},getNodeToSave(){const e=this.view.root;if(!e||e.is.source)return null;const t=e.isContainer()&&e.nodes.length==1?e.nodes[0]:e;return t==e&&(t.savedView=this.view),t}};Object.assign(ps.prototype,wf,yf,xf);function va(e,t){this.tx=e,this.active=null,this.documents=[],this.checkForQueryParameters()}va.prototype={haveDocument(e){return this.documents.find(t=>{var i;return(i=t.model.arl)==null?void 0:i.equals(e)})},openDocument(e){const t=new ps(e);this.documents.push(t),t.load().then(()=>{t.model.handleSourceMap()}).then(()=>{this.tx.send("tab new",e.getName()),this.tx.send("doc set active",t),this.active=t})},toForeground(e){e&&(this.tx.send("tab select",e.model.arl.getName()),this.tx.send("doc set active",e),this.active=e)},xxxtoForeground(e){let t=this.documents.find(i=>{var s;return(s=i.model.arl)==null?void 0:s.equals(e)});t?(this.tx.send("tab select",e.getName()),this.tx.send("doc set active",t),this.active=t):(t=new ps(e),this.documents.push(t),t.load().then(()=>{t.model.handleSourceMap()}).then(()=>{this.tx.send("tab new",e.getName()),this.tx.send("doc set active",t),this.active=t}))},onDocSelected(e){const t=this.haveDocument(e);t?this.toForeground(t):this.openDocument(e)},onDocOpen(e){const t=this.haveDocument(e);t?this.toForeground(t):this.openDocument(e)},onDocGet(){},onDocNew(e){const t=new ps(e);this.documents.push(t),t.view.initRoot($s(e.userPath)),this.tx.send("tab new",e.getName()),this.tx.send("doc set active",t),this.active=t},onDocRenamed({oldName:e,newName:t}){console.log("old-new",e,t)},onDocDeleted(e){},onSaveAs(e){const t=e?{x:e.screenX,y:e.screenY}:{x:25,y:25},i=this.active,s=i.model.arl.getName();this.tx.send("save as filename",{title:"Save as...",entry:i.model.arl.userPath,pos:t,ok:n=>{i.saveAs(n)&&this.tx.send("tab rename",{oldName:s,newName:i.model.arl.getName()})},cancel:()=>{}})},onSave(){this.active.save()},onSaveAll(){this.documents.forEach(e=>e.model.arl&&e.save())},onGetOpenModels(){const e=[];this.documents.forEach(t=>{t.model.arl&&e.push(t.model.arl)}),this.tx.send("open models",e)},onTabRequestToClose(e){const t=this.documents.length;for(let i=0;i<t;i++)if(e==this.documents[i].model.arl.getName()){for(let s=i;s<t-1;s++)this.documents[s]=this.documents[s+1];this.documents.pop(),this.tx.send("tab remove",e),e==this.active.model.arl.getName()&&(i+1<t-1?(this.active=this.documents[i+1],this.tx.send("tab select",this.active.model.arl.getName())):i>0?(this.active=this.documents[i-1],this.tx.send("tab select",this.active.model.arl.getName())):this.active=null,this.tx.send("doc set active",this.active));return}},onTabRequestToSelect(e){const t=this.documents.find(i=>i.model.arl.getName()==e);t&&(this.active.model.is.dirty&&this.active.save(),this.tx.send("doc set active",t),this.tx.send("tab select",e),this.active=t)},checkForQueryParameters(){const{searchParams:e,origin:t}=new URL(window.location.href);if(!e)return;const i=e.get("model");if(!i)return;const s=new Gt(i);s.url=new URL(i,t),this.openDocument(s)}};function wa(e,t){this.windowProxy=null,this.iframe=null,this.tx=e}wa.prototype={sends:["iframe"],"-> run application"({mode:e,js:t,html:i}){i.url&&(e=="page"?this.windowProxy=window.open(i.url,"cell-runtime"):e=="iframe"&&(this.iframe||(this.iframe=document.createElement("iframe")),this.iframe.src=i.url,this.tx.send("iframe",this.iframe)))},"-> size change"({id:e,rect:t}){!this.iframe||!t||t.h<0||t.w<0||(this.iframe.height=t.h,this.iframe.width=t.w)},"-> show"(){}};const bf=[{name:"workspace",uid:"tbvB",factory:Ac,inputs:["-> dom add modal div","-> file savedAs","-> file active","-> file closed"],outputs:["dom workspace div -> left column @ column-main layout (lHKr)","file selected -> doc selected @ document manager (aXkx)","file new -> doc new @ document manager (aXkx)","file get name -> ()","file context menu -> ()","file renamed -> doc renamed @ document manager (aXkx)","file deleted -> doc deleted @ document manager (aXkx)","files get list => ()","files selected -> ()","files deleted -> ()","folder context menu -> context menu @ context menu (QNIy)","folder renamed -> ()","folder deleted -> ()","drawer get location -> ()"],sx:{name:"examples",files:[],folders:[{name:"tutorial",files:[{name:"chat-client.vmblu"},{name:"chat-server.vmblu"}]}]}},{name:"single text field",uid:"GPqX",factory:id,inputs:["-> show"],outputs:["modal div -> dom add modal div @ workspace (tbvB)"]},{name:"context menu",uid:"QNIy",factory:No,inputs:["-> context menu"],outputs:["modal div -> dom add modal div @ workspace (tbvB)"]},{name:"message box",uid:"jsOb",factory:ed,inputs:["-> show"],outputs:["modal div -> dom add modal div @ workspace (tbvB)"]},{name:"tab ribbon",uid:"TWJF",factory:Jh,inputs:["-> tab new","-> tab rename","-> tab select","-> tab remove"],outputs:["div -> tabs div @ vertical menu tabs content (mOrg)","tab request to close -> tab request to close @ document manager (aXkx)","tab request to select -> tab request to select @ document manager (aXkx)"],sx:{a:7,b:8,c:"dit is een filename",d:{e:"nee",dxdy:254}}},{name:"editor",uid:"NREV",factory:vf,inputs:["-> sync model","-> grid on-off","-> accept changes","-> recalibrate","-> show settings","-> make lib","-> make app","-> run app","-> run app in iframe","-> set document","-> save point set","-> save point back","-> selected node","-> size change"],outputs:["show lib path -> path @ path request (kWLQ)","show app path -> path @ path request (kWLQ)","run -> ()","runtime settings -> show @ runtime settings (uQfg)","open document -> doc open @ document manager (aXkx)","document settings -> show @ doc settings (yugd)","save point confirm -> show @ confirm box (IwRp)","show context menu -> context menu @ context menu (fnKV)","settings -> json @ node settings (gBrM)","show link -> name and path @ name and path (qluS)","show filter -> name and path @ name and path (qluS)","show factory -> name and path @ name and path (qluS)","open source file -> ()","pin profile -> show @ pin profile (ZGxL)","node comment -> text @ text block (gLsX)","select node -> show @ node selector (WRDh)","change library -> switch library @ node library (LBtK)","add lib file -> ()","canvas -> content div @ vertical menu tabs content (mOrg)","new edit -> ()","clipboard get => get @ clipboard (umgQ)","clipboard set -> set @ clipboard (umgQ)"],sx:{a:7,b:8,c:9}},{name:"context menu",uid:"fnKV",factory:No,inputs:["-> context menu"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"path request",uid:"kWLQ",factory:Co,inputs:["-> path"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"node settings",uid:"gBrM",factory:Kh,inputs:["-> json"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"name and path",uid:"qluS",factory:td,inputs:["-> name and path"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"pin profile",uid:"ZGxL",factory:Zh,inputs:["-> show"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"text block",uid:"gLsX",factory:Qh,inputs:["-> text"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"vertical menu tabs content",uid:"mOrg",factory:zh,inputs:["-> menu div","-> tabs div","-> content div","-> modal div","-> show","-> size change"],outputs:["content size change -> size change @ editor (NREV)","div -> main area @ column-main layout (lHKr)"]},{name:"document manager",uid:"aXkx",factory:va,inputs:["-> doc selected","-> doc new","-> doc renamed","-> doc deleted","-> doc get","-> doc open","-> save","-> save as","-> save all","-> get open models","-> tab request to close","-> tab request to select"],outputs:["doc set active -> set document @ editor (NREV)","save as filename -> path @ path request (kWLQ)","open models -> ()","tab new -> tab new @ tab ribbon (TWJF)","tab rename -> tab rename @ tab ribbon (TWJF)","tab select -> tab select @ tab ribbon (TWJF)","tab remove -> tab remove @ tab ribbon (TWJF)"],dx:{logMessages:!1,worker:{on:!1,path:""}}},{name:"node selector",uid:"WRDh",factory:nd,inputs:["-> show","-> build table"],outputs:["selected node -> selected node @ editor (NREV)","remove file -> remove file @ node library (LBtK)","add file -> add file @ node library (LBtK)","get path -> path @ path request (oVjH)","modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"node library",uid:"LBtK",factory:pa,inputs:["-> switch library","-> remove file","-> add file"],outputs:["build table -> build table @ node selector (WRDh)"]},{name:"path request",uid:"oVjH",factory:Co,inputs:["-> path"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"doc settings",uid:"yugd",factory:sd,inputs:["-> show"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"clipboard",uid:"umgQ",factory:ga,inputs:["-> switched","=> local","=> get","-> set"],outputs:["switch -> ()","remote => ()"]},{name:"confirm box",uid:"IwRp",factory:Xh,inputs:["-> show"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"runtime settings",uid:"uQfg",factory:Yh,inputs:["-> show"],outputs:["modal div -> modal div @ vertical menu tabs content (mOrg)"]},{name:"side menu",uid:"osSD",factory:Gh,inputs:[],outputs:["div -> menu div @ vertical menu tabs content (mOrg)","sync -> sync model @ editor (NREV)","grid on-off -> grid on-off @ editor (NREV)","accept changes -> accept changes @ editor (NREV)","recalibrate -> recalibrate @ editor (NREV)","show settings -> show settings @ editor (NREV)","make lib -> make lib @ editor (NREV)","make app -> make app @ editor (NREV)","set save point -> save point set @ editor (NREV)","back to save point -> save point back @ editor (NREV)"],sx:[{icon:"flare",color:"#0fb2e4",message:"recalibrate",help:"Recalibrate"},{icon:"grid_view",color:"#0fb2e4",message:"grid on-off",help:"Grid on/off"},{icon:"check_box",color:"#0fb2e4",message:"accept changes",help:"Accept changes"},{icon:"bolt",color:"#0fb2e4",message:"sync",help:"sync model"},{icon:"push_pin",color:"#0fb2e4",message:"set save point",help:"set save point"},{icon:"reply",color:"#0fb2e4",message:"back to save point",help:"back to save point"},{icon:"build",color:"#0fb2e4",message:"make lib",help:"Make lib"},{icon:"handyman",color:"#0fb2e4",message:"make app",help:"Make app"},{icon:"settings",color:"#0fb2e4",message:"show settings",help:"Settings"}]},{name:"application launcher",uid:"XUOo",factory:wa,inputs:["-> run application","-> size change","-> show"],outputs:["iframe -> ()"]},{name:"column-main layout",uid:"lHKr",factory:qh,inputs:["-> left column","-> main area"],outputs:["size change -> size change @ vertical menu tabs content (mOrg)"]}],kf=[],Tf=Fa(bf,kf);Tf.start();
//# sourceMappingURL=playground-bundle.js.map
